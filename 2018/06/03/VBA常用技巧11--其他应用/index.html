<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport">
    <meta name="keywords" content="jiangmoting, autumn">
    <title>
        TT ❤ LL 印迹
    </title>
    <!-- favicon -->
    
    <link rel="icon" href="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/favicon.ico">
    
    <link rel="stylesheet" href="/css/style.css">

    <!-- highlight -->
    <link rel="stylesheet" href="https://cdn.bootcss.com/highlight.js/9.12.0/styles/github-gist.min.css">
    <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
    <script>
        hljs.initHighlightingOnLoad()
    </script>
    <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@1.0.0/dist/hexo-infinite-scroll.min.css">
    <script src="https://cdn.jsdelivr.net/gh/frontendsophie/hexo-infinite-scroll@1.0.0/dist/hexo-infinite-scroll.min.js"></script>
    <script>
        infiniteScroll()

        // for mobile menu
        $(function () {
            $('.social-button').click(function () {
                if ($('.social-links').hasClass('hide-links')) {
                    $('.social-links').removeClass('hide-links')
                } else {
                    $('.social-links').addClass('hide-links')
                }
            })
        })
    </script>
</head>

    <body style="background: url(https://cdn.jsdelivr.net/gh/frontendsophie/hexo-theme-autumn@1.0.0/source/img/button-bg.png) #f3f3f3">
        <div class="container">
            <header class="header">
    <h1 class="title">
        <a href="/" class="logo">
            TT ❤ LL 印迹
        </a>
    </h1>
    <h2 class="desc">
        
    </h2>

    <nav class="links">
        <button class="social-button">
            menu
        </button>
        <ul class="social-links hide-links">
            
                <li>
                    <a href="https://github.com">
                        Github
                    </a>
                </li>
                
                <li>
                    <a href="https://www.linkedin.com">
                        LinkedIn
                    </a>
                </li>
                
        </ul>
    </nav>
</header>
                <main class="main">
                    <article class="post">
    
    
    <h4 class="post-cat">
        <a href="/categories/生の术/">
            生の术
        </a>
    </h4>
    
    
    <h2 class="post-title">
        VBA常用技巧11--其他应用
    </h2>
    <ul class="post-date">
        <li>
            2018-06-03
        </li>
        <li>
            绛墨铤
        </li>
    </ul>
    <div class="post-content">
        <h2 id="第11章-其他应用"><a href="#第11章-其他应用" class="headerlink" title="第11章     其他应用"></a>第11章     其他应用</h2><h3 id="技巧181-取得电脑名称"><a href="#技巧181-取得电脑名称" class="headerlink" title="技巧181     取得电脑名称"></a>技巧181     取得电脑名称</h3><p>如果希望使用VBA开发的程序只能在某一特定的电脑中使用，那么可以在程序开始时检查当前电脑的名称是否是指定的名称，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Dim myName As String
    myName = Environ(&quot;Computername&quot;)
    If myName &lt;&gt; &quot;ERPSERVER&quot; Then
        MsgBox &quot;对不起您不是合法用户，文件将关闭!&quot;
        ThisWorkbook.Close
    End If
End Sub
代码解析：
工作簿的Open事件过程，在工作簿打开时判断电脑的名称，如果不是“ERPSERVER”则退出关闭工作簿。
第3行代码取得电脑的名称。Environ函数返回String，关连一个操作系统环境变量，语法如下：
Environ({envstring | number})
参数envstring是可选的，包含一个环境变量名的字符串表达式。如果在环境字符串表格中找到参数envstring，则Environ函数返回在环境字符串表格中对应那个环境变量的等号后面的那段文本。
Environ(&quot;Computername&quot;)返回电脑名称，如果需要取得当前登录用户的用户名则使用Environ(&quot;UserName&quot;)。
参数number是可选的，用来表示环境字符串在环境字符串表格中的数值顺序。number 参数可以是任意的数值表达式，不过在计算前，它会先转换为一个整数。
第4行到第7行代码，如果当前电脑不是指定的电脑，关闭工作簿。在实际应用中需要配合其他方法使用户在打开时强制启用宏才能达到这一效果。</code></pre>
<h3 id="技巧182-取得逻辑盘序列号"><a href="#技巧182-取得逻辑盘序列号" class="headerlink" title="技巧182     取得逻辑盘序列号"></a>技巧182     取得逻辑盘序列号</h3><p>在技巧181 中使用Environ函数返回电脑的名称，使程序只能在某一特定的电脑中使用。但是电脑名称并不是唯一的，有可能多台电脑使用同一名称，所以更好的方法是程序开始时检查电脑的逻辑盘序列号是否是指定的序列号。取得逻辑盘序列号可以使用下面的代码。</p>
<pre><code class="vb">Sub DriveID()
    Dim DriveID
    Set DriveID = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MsgBox &quot;C盘的序列号是：&quot; &amp; DriveID.GetDrive(&quot;C&quot;).SerialNumber, 64
End Sub
代码解析：
DriveID过程使用GetDrive方法取得电脑C盘的序列号。
应用于FileSystemObject对象的GetDrive方法返回一个与指定路径中的驱动器相对应的Drive对象，语法如下：
object.GetDrive drivespec
object参数是必需的， FileSystemObject对象的名字。关于FileSystemObject对象的引用请参阅技巧180 。
Drivespec参数是必需的，可以是一个驱动器字符（c）、一个驱动器字符加一个冒号（c:）、一个驱动器字符加冒号和路径分隔符（c:\）或任何网络共享的说明（\\computer2\share1）。
在使用GetDrive方法返回一个Drive对象后，就可以使用其SerialNumber属性返回C盘的序列号。Drive对象对特定磁盘驱动器或网络共享的属性提供访问，而应用于Drive对象的SerialNumber属性用于唯一标识磁盘卷标的十进制序列号，语法如下：
object.SerialNumber
运行DriveID过程将使用消息框显示电脑C盘的序列号，如图 182 1所示。

图 182 1    C盘的序列号</code></pre>
<h3 id="技巧183-使用API取得硬盘信息"><a href="#技巧183-使用API取得硬盘信息" class="headerlink" title="技巧183     使用API取得硬盘信息"></a>技巧183     使用API取得硬盘信息</h3><p>在VBA中可以使用API函数取得逻辑盘序列号和唯一的物理系列号，如下面的代码所示。</p>
<pre><code class="vb">Private Const MAX_IDE_DRIVES As Long = 4
Private Const READ_ATTRIBUTE_BUFFER_SIZE As Long = 512
Private Const IDENTIFY_BUFFER_SIZE As Long = 512
Private Const READ_THRESHOLD_BUFFER_SIZE As Long = 512
Private Const DFP_GET_VERSION As Long = &amp;H74080
Private Const DFP_SEND_DRIVE_COMMAND As Long = &amp;H7C084
Private Const DFP_RECEIVE_DRIVE_DATA As Long = &amp;H7C088
……代码略，详见附件
&#39;取得硬盘信息：型号/物理系列号（唯一）
Function GetHardDiskInfo(Optional ByVal numDisk As eumDiskNo = hdPrimaryMaster, Optional ByVal numType As eumInfoType = hdOnlySN) As String
    If GetDiskInfo(numDisk) = 1 Then
        Dim pSerialNumber As String, pModelNumber As String
        pSerialNumber = StrConv(m_DiskInfo.sSerialNumber, vbUnicode)
        pModelNumber = StrConv(m_DiskInfo.sModelNumber, vbUnicode)
        Select Case numType
            Case hdOnlyModel  &#39;仅型号
                GetHardDiskInfo = Trim(pModelNumber)
            Case hdOnlySN  &#39;仅系列号
                GetHardDiskInfo = Trim(pSerialNumber)
            Case Else   &#39;型号,系列号
                GetHardDiskInfo = Trim(pModelNumber) &amp; &quot;,&quot; &amp; Trim(pSerialNumber)
        End Select
     End If
End Function
代码解析;
使用API函数取得逻辑盘序列号和唯一的硬盘物理系列号，其中GetDiskVolume函数过程取得逻辑盘序列号，GetHardDiskInfo函数过程取得唯一的硬盘物理系列号。</code></pre>
<p>调用此函数的代码如下。</p>
<pre><code class="vb">Sub DiskId()
    MsgBox &quot;硬盘的物理系列号：&quot; &amp; GetHardDiskInfo(hdPrimaryMaster, hdOnlySN) _
        &amp; Chr(13) &amp; &quot;C盘的序列号：&quot; &amp; GetDiskVolume(&quot;C&quot;)
End Sub
运行DiskId过程，使用消息框显示硬盘信息，如图 183 1所示。

图 183 1    硬盘系列号</code></pre>
<h3 id="技巧184-使用数字签名"><a href="#技巧184-使用数字签名" class="headerlink" title="技巧184     使用数字签名"></a>技巧184     使用数字签名</h3><p>对于Excel中包含VBA的文档，用户最恐惧的一件事情便是是否有病毒，因此往往把Excel安全级别设置为“中”，即对不可靠的来源提醒用户是否启用宏。而对于VBA开发人员来说，最想做的就是使Excel程序启动时不出现警告对话框，直接进入（在安全级别为中的情况下），这时就可以使用数字签名。<br>数字签名仅在安装了Microsoft Internet Explorer 4.0 或其后续版本的计算机上有效，并且在安装Excel时，需要选择数字签名一项。<br>从“开始”→“程序”→“Microsoft Office” →“Microsoft Office工具” →“VBA项目的数字证书”，在打开的窗口中输入的名称，这时已经完成数字证书的制作，如图 184 1所示。</p>
<p>图 184 1    制作数字证书<br>在Office的安装目录下双击文件“Selfcert.exe”，也可以制作数字证书。<br>当程序开发完成后，在VBE窗口中选择“工具”→“数字签名”，在如图 184 2所示的对话框中选择“选择”按钮，在显示的如图 184 3所示的对话框中选择新建的数字证书后按“确定”按钮后保存文件。</p>
<p>图 184 2    选择数字证书</p>
<p>图 184 3    选择证书<br>第一次打开含有数字签名的文件时，会显示如图 184 4所示的“安全警告”对话框。此时只需要选择“总是相信来自此发布者的宏”选项，这样只要是用此证书签名的文档都会被认为是可靠来源，以后不会再出现“安全警告”对话框。</p>
<p>图 184 4    安全警告对话框<br>如果在打开别人签名的文件时“总是相信来自此发布者的宏”选项为灰，只需选择“详细信息”，在显示的“数字签名详细信息”对话框的“常规”选项中选择“查看证书”，如图 184 5所示，然后在显示的“证书”对话框中选择“安装证书”即可，如图 184 6所示。</p>
<p>图 184 5    数字签名详细信息</p>
<p>图 184 6    安装证书<br>如果需要删除数字证书，可以打开IE属性对话框，在“内容”选项中选择“证书”，在显示的“证书”对话框中选择证书后删除，如图 184 7所示。</p>
<p>图 184 7    从证书管理器中删除数字证书<br>如果有些数字证书在IE属性对话框看不到，可以点击Windows的开始菜单，点击“运行”，键入“Regedit”，回车便打开了注册表编辑器。在“HKEY_CURRENT_USER\Software\Microsoft\SystemCertificates\”位置选择相应的选项删除即可，如图 184 8所示。</p>
<p>图 184 8    从注册表中删除数字证书</p>
<h3 id="技巧185-暂停代码的运行"><a href="#技巧185-暂停代码的运行" class="headerlink" title="技巧185     暂停代码的运行"></a>技巧185     暂停代码的运行</h3><p>在程序运行过程中，如果需要暂时停止宏代码的执行，可以使用Wait方法，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Activate()
    Dim i As Integer
    For i = 1 To 10
        Label1.Caption = &quot;这是个演示窗体,将在&quot; &amp; 11 - i &amp; &quot;秒后自动关闭!&quot;
        Application.Wait Now() + VBA.TimeValue(&quot;00:00:01&quot;)
        DoEvents
    Next
    Unload Me
End Sub
代码解析：
窗体的激活事件，使用Wait方法使窗体显示10秒后关闭。
第4行代码在窗体的标签中显示倒计时关闭的秒数。
第5行代码使用Wait方法使代码暂停运行1秒钟。应用于Application对象的Wait方法暂停运行宏，直到一特定时间才继续运行宏，语法如下：
Wait(Time)
参数Time是必需的，指定想要重新继续执行宏的时间点，以Microsoft Excel日期格式表示。
使用该方法将暂停Microsoft Excel的所有操作，但不影响后台操作，例如打印和重新计算。
第6行代码使用DoEvents函数转让控制权，更新标签中倒计时秒数。
运行窗体，标签中显示倒计时关闭的秒数并在10秒后关闭，如图 185 1所示。

图 185 1    暂停代码的运行</code></pre>
<p>使用Wait方法只能提供精度为1秒的延时，如果需要更低精度的延时，需要使用Sleep API函数，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Sub Sleep Lib &quot;kernel32&quot; (ByVal dwMilliseconds As Long)
Sub TypeDemo()
    Dim sTest As String
    Dim i As Integer
    sTest = &quot;这是Sleep API函数的一个简单演示。&quot;
    For i = 1 To Len(sTest)
        Range(&quot;A1&quot;).Value = Left(sTest, i)
        Sleep 200
    Next
End Sub
代码解析：
TypeDemo过程模拟打字效果在单元格A1中输入一行文字。
第1行代码Sleep API函数声明，参数dwMilliseconds为以毫秒为单位的时间长度。
在第6行到第9行代码在每次循环时增加显示的数据，并且在每次增加时使用Sleep语句延时200毫秒，好像字符逐个输入，从而达到模拟打字的效果。</code></pre>
<h3 id="技巧186-定时关机"><a href="#技巧186-定时关机" class="headerlink" title="技巧186     定时关机"></a>技巧186     定时关机</h3><p>在VBA中可以使用Shell函数执行Shutdown.exe程序实现定时关闭电脑，如下面的代码所示。</p>
<pre><code class="vb">Sub Shutdown()
    Shell (&quot;at 08:31 Shutdown.exe -s&quot;)
End Sub
代码解析：
Shutdown过程使用Shell函数在08:31时自动关闭电脑。Shell函数执行一个可执行文件，语法如下：
Shell(pathname[,windowstyle])
参数pathname是必需的，要执行的程序名，以及任何必需的参数或命令行变量，可能还包括目录或文件夹，以及驱动器。在Macintosh中，可以使用MacID函数来指定一个应用程序的署名而不是名称。表格 186 1列出了执行windows中常用程序的代码。
常用程序    代码
打开系统时间    &quot;Rundll32.exe Shell32.dll,Control_RunDLL Timedate.cpl&quot;
打开系统属性    &quot;control.exe sysdm.cpl&quot;
打开控制面板    &quot;control.exe&quot;
Internet 属性    &quot;control.exe inetcpl.cpl&quot;
显示属性    &quot;control.exe desk.cpl&quot;
调用计算器    &quot;calc.exe&quot;
调用画图    &quot;mspaint&quot;
表格 186 1    执行windows中常用程序的代码
参数windowstyle是可选的，表示在程序运行时窗口的样式。如果省略，则程序是以具有焦点的最小化窗口来执行的。windowstyle参数的值如表格 186 2所示。
常量    值    描述
vbHide    0    窗口被隐藏，且焦点会移到隐式窗口。
VbNormalFocus    1    窗口具有焦点，且会还原到它原来的大小和位置。
VbMinimizedFocus    2    窗口会以一个具有焦点的图标来显示。
VbMaximizedFocus    3    窗口是一个具有焦点的最大化窗口。
VbNormalNoFocus    4    窗口会被还原到最近使用的大小和位置，而当前活动的窗口仍然保持活动。
VbMinimizedNoFocus    6    窗口会以一个图标来显示。而当前活动的的窗口仍然保持活动。
表格 186 2    windowstyle参数值</code></pre>
<h3 id="技巧187-打开指定的网页"><a href="#技巧187-打开指定的网页" class="headerlink" title="技巧187     打开指定的网页"></a>技巧187     打开指定的网页</h3><p>使用VBA可以打开指定的网页，如下面的代码所示。</p>
<pre><code class="vb">Sub Hyperlink()
    ActiveWorkbook.FollowHyperlink _
        Address:=&quot;http://club.excelhome.net/dispbbs.asp&quot;, _
        NewWindow:=True
End Sub
代码解析：
Hyperlink过程使用FollowHyperlink方法打开Excel Home论坛的主页。
FollowHyperlink方法对指定超链接进行处理以下载目标文档，然后将该文档在适当的应用程序中显示出来，语法如下：
expression.FollowHyperlink(Address, SubAddress, NewWindow, AddHistory, ExtraInfo, Method, HeaderInfo)
其中参数expression是必需的，返回一个Workbook对象。
参数Address是必需的，String类型，目标文档的地址。
参数SubAddress是可选的，目标文档中的位置，默认值为空字符串。
参数NewWindow是可选的，Variant类型，如果该值为True，则将目标应用程序显示到一个新窗口中。默认值为False。
运行Hyperlink过程将打开Excel Home论坛的主页。</code></pre>
<h3 id="技巧188-VBE的操作"><a href="#技巧188-VBE的操作" class="headerlink" title="技巧188     VBE的操作"></a>技巧188     VBE的操作</h3><h4 id="188-1-添加模块和过程"><a href="#188-1-添加模块和过程" class="headerlink" title="188-1    添加模块和过程"></a>188-1    添加模块和过程</h4><p>在工作簿中添加新的模块和过程，除了使用手工添加的方法外，还可以采用程序的方式自动添加，如下面的代码所示。</p>
<pre><code class="vb">Sub NowModule()
    Dim VBC As VBComponent
    Set VBC = ThisWorkbook.VBProject.VBComponents _
        .Add(vbext_ct_StdModule)
    VBC.Name = &quot;NowModule&quot;
    With VBC.CodeModule
        If .Lines(1, 1) &lt;&gt; &quot;Option Explicit&quot; Then
            .InsertLines 1, &quot;Option Explicit&quot;
        End If
        .InsertLines 2, &quot;Sub Process1()&quot;
        .InsertLines 3, vbTab &amp; &quot;MsgBox &quot;&quot;这是第一个过程!&quot;&quot;&quot;
        .InsertLines 4, &quot;End Sub&quot;
        .AddFromString &quot;Sub Process2()&quot; &amp; Chr(13) &amp; vbTab _
            &amp; &quot;MsgBox &quot;&quot;这是第二个过程!&quot;&quot;&quot; &amp; Chr(13) &amp; &quot;End Sub&quot;
    End With
    Set VBC = Nothing
End Sub
代码解析：
NowModule过程在VBE中添加一个“NowModule”模块和两个过程。
第2行代码声明变量VBC为VBComponent对象。VBComponent对象代表一个包含在工程中的部件，例如类模块或标准模块。
第3、4行代码使用Add方法添加一个模块。应用于VBComponents集合的Add方法将一个对象添加到集合，语法如下：
object.Add(component)
参数object是必需的，一个有效的对象表达式。
参数component是必需的，对于VBComponents集合，则为表示类模块、窗体、标准模块的列举常数，如表格 188 1所示。
常数    值    描述
vbext_ct_StdModule    1    将标准模块添加到集合
vbext_ct_ClassModule    2    将一个类模块添加到集合
Vbext_ct_MSForm    3    将窗体添加到集合
表格 188 1    component参数值
第5行代码将新添加的模块重命名为“NowModule”。
第7行到第12行代码使用InsertLines方法在新添加的模块中插入过程“Process1”。应用于CodeModule对象的InsertLines方法在一个代码块的某个指定位置，插入一行或多行的代码，语法如下：
object.InsertLines(line, code)
参数object是必需的，一个有效的对象表达式。
参数line是必需的，Long型数据，用来指定要插入代码的位置。
参数code是必需的，String型数据，插入的代码。
其中第7行到第9行代码判断模块中首行代码是否为要求变量声明，如不是则添加要求变量声明语句。
第13、14行代码使用AddFromString方法在新添加的模块中插入过程“Process2”。应用于CodeModule对象的AddFromString方法将文本添加到模块，与InsertLines方法不同的是，所插入文本的位置始终在模块中的第一个过程之前，如果模块中没有包含过程则将插入的文本放置在模块的最后。
运行NowModule过程，在VBE中添加一个“NowModule”模块以及在模块中添加两个过程，如图 188 1所示。

图 188 1    添加模块和过程</code></pre>
<h4 id="188-2-建立事件过程"><a href="#188-2-建立事件过程" class="headerlink" title="188-2    建立事件过程"></a>188-2    建立事件过程</h4><p>在使用VBA代码添加工作表后，如果需要在新工作表中添加事件过程，可以使用技巧188-1中的添加代码的方法，但是事件过程一般包含参数，因此此方法容易出错，所以更好的方法是使用CreateEventProc方法，如下面的代码所示。</p>
<pre><code class="vb">Sub AddMatter()
    Dim Sh As Worksheet
    Dim i As Integer
    For Each Sh In Worksheets
        If Sh.Name = &quot;abc&quot; Then
            MsgBox &quot;工作簿中已有&quot;&quot;abc&quot;&quot;工作表,不能重复添加!&quot;
            Exit Sub
        End If
    Next
    Set Sh = Sheets.Add(After:=Sheets(Sheets.Count))
    Sh.Name = &quot;abc&quot;
    Application.VBE.MainWindow.Visible = True
    With ThisWorkbook.VBProject.VBComponents(Sh.CodeName).CodeModule
        i = .CreateEventProc(&quot;SelectionChange&quot;, &quot;Worksheet&quot;)
        .ReplaceLine i + 1, vbTab _
            &amp; &quot;MsgBox &quot;&quot;你选择了&quot;&quot; &amp; Target.Address(0, 0) &amp; &quot;&quot;单元格!&quot;&quot;&quot;
    End With
    Application.VBE.MainWindow.Visible = False
    Set Sh = Nothing
End Sub
代码解析：
AddMatter过程在工作簿中新建一张“abc”工作表，并在工作表的SelectionChange事件中写入事件代码。
第4行到第11行代码使用Add方法在工作簿中新建一张工作表，请参阅技巧25 。
第12行代码打开VBE窗口。
第14行代码使用CreateEventProc方法在新添加的工作表中创建“SelectionChange”过程并将起始行号赋给变量i。
应用于CodeModule对象的CreateEventProc方法创建一个事件过程，语法如下：
object.CreateEventProc(eventname, objectname) As Long
参数object是必需的，一个有效的对象表达式。
参数eventname是必需的，用来指定欲添加到模块的事件名称。
参数objectname是必需的，用来指定事件源的对象名称。
CreateEventProc方法创建成功则返回事件过程开始行的行号，其创建的过程只包含一个空行。
第15、16行代码使用ReplaceLine方法将空行替换为指定的代码。应用于CodeModule对象的ReplaceLine方法用特定的代码代替原代码，语法如下：
object.ReplaceLine(line, code)
参数object是必需的，一个有效的对象表达式。
参数line是必需的，用来指定所要代替的行号。
参数code是必需的，用来指定要插入的代码。
第18行代码关闭VBE窗口。
运行AddMatter过程在工作簿中新建一张“abc”工作表，并在工作表中写入事件代码，如图 188 2所示。

图 188 2     添加事件过程</code></pre>
<h4 id="188-3-模块的导入与导出"><a href="#188-3-模块的导入与导出" class="headerlink" title="188-3    模块的导入与导出"></a>188-3    模块的导入与导出</h4><p>在使用InsertLines方法和CreateEventProc方法在模块中插入代码，如果插入的代码量较大时，编写的代码会比较长，此时更好的方法是将代码直接导入到模块中，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyModule()
    Dim Nowbook As Workbook
    ThisWorkbook.VBProject.VBComponents(&quot;AddMatter&quot;).Export ThisWorkbook.Path &amp; &quot;\Tese.txt&quot;
    Set Nowbook = Workbooks.Add
    With Nowbook
        .SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;CopyModule.xls&quot;
        .VBProject.VBComponents.Import ThisWorkbook.Path &amp; &quot;\CopyModule.txt&quot;
        .Close Savechanges:=True
    End With
    Kill ThisWorkbook.Path &amp; &quot;\Tese.txt&quot;
End Sub
代码解析：
CopyModule过程将示例工作簿中的“AddMatter”模块导入到新建的工作簿“CopyModule.xls”中。
第3行代码使用Export方法将“AddMatter”模块导出为文本文件。应用于VBComponent 对象的Export方法将部件按文件进行保存，语法如下：
object.Export(filename)
参数object是必需的，一个有效的对象表达式。
参数filename是必需的，用来指定部件输出为文件的文件名称。
第4行代码使用Add方法创建一个工作簿。关于Add方法请参阅技巧41 。
第7行代码使用Import方法给新工作簿的VBA工程添加部件。Import方法从文件给工程添加部件，返回该被添加的新部件，语法如下：
object.Import(filename) As VBComponent
参数object是必需的，一个有效的对象表达式。
参数filename是必需的，用来指定欲添加部件的路径及文件名称。
第8行代码使用Close方法保存新建工作簿后关闭该工作簿。关于Close方法请参阅技巧48 。
第10行代码使用Kill方法删除导出的文本文件。关于Kill方法请参阅技巧178 。
运行CopyModule过程将创建新工作簿并把示例工作簿中的“AddMatter”模块导入到新工作簿中。</code></pre>
<h4 id="188-4-删除宏代码"><a href="#188-4-删除宏代码" class="headerlink" title="188-4    删除宏代码"></a>188-4    删除宏代码</h4><p>在将一个含有宏代码的工作簿拷贝给用户使用时，如果用户并不需要其中的宏代码，可以使用代码删除其中部分或全部的宏代码后再拷贝给用户使用，如下面的代码所示。</p>
<pre><code class="vb">Sub DelMacro()
    Dim Wb As Workbook
    Dim FileName As String
    Dim Vbc As VBComponent
    FileName = ThisWorkbook.Path &amp; &quot;\DelMacro.xls&quot;
    Application.EnableEvents = False
    Set Wb = Workbooks.Open(FileName)
    For Each Vbc In Wb.VBProject.VBComponents
        If Vbc.Type &lt;&gt; vbext_ct_Document Then
            If Vbc.Name = &quot;NowModule&quot; Then
                Vbc.CodeModule.DeleteLines 3, Vbc.CodeModule.CountOfLines - 4
            Else
                Wb.VBProject.VBComponents.Remove Vbc
            End If
        End If
    Next
    &#39;Wb.Close True
    Application.EnableEvents = True
End Sub
代码解析：
DelMacro过程删除“DelMacro.xls”工作簿中的部分宏代码。
第5行代码指定需要删除宏代码的工作簿。
第6行代码打开工作簿时禁止触发事件。
第7行代码使用Open方法打开指定工作簿。关于Open方法请参阅技巧42 。
第8行代码遍历指定工作簿中所有的VBA部件。
第9行代码保留Excel对象事件的代码。应用于VBComponent对象的Type属性返回对象的类型，常用的Type属性值如表格 188 2所示。
常数    值    描述
Vbext_ct_StdModule    1    标准模块
Vbext_ct_ClassModule    2    类模块
Vbext_ct_MSForm    3    用户窗体
Vbext_ct_Document    100    Excel对象
表格 188 2    VBComponent对象的Type属性值
第10、11行代码，如果模块名称是“NowModule”则删除其中指定行数代码。应用于CodeModule对象的DeleteLines方法删除一个单行或指定行范围的代码，语法如下：
object.DeleteLines (startline) [count]
参数object是必需的，一个有效的对象表达式。
参数startline是必需的，用来指定删除的开始行。
参数count是可选的，用来指定删除的行数。如果没有指定count参数，则只删除一行代码。
而应用于CodeModule对象的CountOfLines属性返回代码模块中的总行数。
第13行代码，如果不是需保留的项目全部则删除。应用于VBComponents集合的Remove方法从集合中删除项目，语法如下：
object.Remove(component)
参数object是必需的，一个有效的对象表达式。
参数component是必需的，对于VBComponents集合，代表一个类模块、一个窗体，或者是一个标准模块。
在示例所在文件夹中的“DelMacro.xls”工作簿的VBA项目中有两个模块、一个用户窗体及一个BeforeClose事件过程，运行DelMacro过程，只保留其中的BeforeClose事件过程和“NowModule”模块中的部分代码，其他的全部删除。
为了演示方便在“DelMacro.xls”工作簿的BeforeClose事件过程中将Saved属性设置为True使其关闭时不保存修改。在实际应用中应该在DelMacro过程的最后添加一行保存后关闭“DelMacro.xls”工作簿的代码：
Wb.Close True。
使用Close方法关闭“DelMacro.xls”工作簿，请参阅技巧45 。</code></pre>
<h3 id="技巧189-保护VBA代码"><a href="#技巧189-保护VBA代码" class="headerlink" title="技巧189     保护VBA代码"></a>技巧189     保护VBA代码</h3><p>VBA项目的源代码是完全开放的，如果不希望其他人看到源代码，可以使用以下两种方法将代码保护起来。</p>
<h4 id="189-1-设置工程密码"><a href="#189-1-设置工程密码" class="headerlink" title="189-1    设置工程密码"></a>189-1    设置工程密码</h4><p>设置VBA工程的密码，只有在输入正确密码后才能看到源代码。<br>在VBE窗口中单击菜单“工具”→“VBAProject属性”，在显示的如图 189 1所示的“VBAProject—工程属性”对话框的“保护”选项卡中选中“查看时锁定工程”复选框，并在“密码”文本框和“确认密码”文本框中输入密码后单击“确定”按钮关闭该对话框，保存并关闭文件。</p>
<p>图 189 1    “VBAProject—工程属性”对话框<br>密码保护完成后，当试图打开该工程时会显示“VBAProject密码”的对话框，如图 189 2所示。只有在输入正确的密码后才能看到该工程的源代码。</p>
<p>图 189 2    密码输入对话框</p>
<h4 id="189-2-设置“工程不可查看”"><a href="#189-2-设置“工程不可查看”" class="headerlink" title="189-2    设置“工程不可查看”"></a>189-2    设置“工程不可查看”</h4><p>使用“保护并共享工作簿”功能将工程设置为不可查看。<br>在Excel中选择菜单“工具”→“保护”→“保护并共享工作簿”，在显示的如图 189 3所示的“保护并共享工作簿”对话框中选中“以追踪修订方式共享”复选框，激活对话框中灰色的输入密码区域，在“密码”文本框中输入密码后单击“确定”按钮。</p>
<p>图 189 3    “保护并共享工作簿”对话框<br>在显示的“确认密码”对话框中再次输入密码后单击“确定”按钮，如图 189 4所示。</p>
<p>图 189 4    “确认密码”对话框<br>此时系统会显示如图 189 5所示的“此操作将导致保存文档。是否继续？”的对话框。</p>
<p>图 189 5    询问对话框<br>单击“确定”按钮后在显示的如图 189 6所示的对话框中单击“确定”按钮即可。</p>
<p>图 189 6    警告对话框<br>完成设置后当在VBE中查看工程时则会出现一个“工程锁定”的对话框，提示“工程不可查看”，如图 189 7所示。</p>
<p>图 189 7    “工程锁定”对话框<br>如果需要取消“工程不可查看”只需在Excel中选择菜单“工具”→“保护”→“撤消对共享工作簿的保护”，在显示的“取消共享保护”对话框中需要输入正确的密码中单击“确定”按钮即可，如图 189 8所示。</p>
<p>图 189 8    “取消共享保护”对话框</p>
<h3 id="技巧190-优化代码"><a href="#技巧190-优化代码" class="headerlink" title="技巧190     优化代码"></a>技巧190     优化代码</h3><h4 id="190-1-关闭屏幕刷新"><a href="#190-1-关闭屏幕刷新" class="headerlink" title="190-1    关闭屏幕刷新"></a>190-1    关闭屏幕刷新</h4><p>在使用代码改变工作表的显示内容或格式时关闭屏幕刷新可以加快运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Screen()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    Application.ScreenUpdating = False
    t = Timer
    For i = 1 To 30000
        Cells(1, 1) = i
    Next
    t1 = Timer - t
    Application.ScreenUpdating = True
    t = Timer
    For i = 1 To 30000
        Cells(1, 1) = i
    Next
    t2 = Timer - t
    MsgBox &quot;关闭屏幕刷新运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;开启屏幕刷新运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
Screen过程使用两次For...Next语句给A1单元格填充数据，最后使用消息框显示两次运行的时间。在第一次循环时关闭屏幕刷新，应用于Application对象的ScreenUpdating属性设置屏幕刷新功能是否打开，设置为False关闭屏幕刷新，将看不到代码的执行过程，但可以加快代码的运行速度。
运行Screen过程，消息框显示两次代码的运行时间，可以看出关闭屏幕刷新后运行时间远远小于开启屏幕刷新时运行的时间，如图 190 1所示。

图 190 1    运行时间比较</code></pre>
<h4 id="190-2-使用工作表函数"><a href="#190-2-使用工作表函数" class="headerlink" title="190-2    使用工作表函数"></a>190-2    使用工作表函数</h4><p>在VBA中使用工作表函数比仅仅使用VBA代码的运行时间要快得多，如下面的代码所示。</p>
<pre><code class="vb">Sub ShFunction()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    Range(&quot;B1:B2&quot;).ClearContents
    Application.ScreenUpdating = False
    t = Timer
    For i = 1 To 30000
        Cells(1, 2) = Cells(1, 2) + Cells(i, 1)
    Next
    t1 = Timer - t
    t = Timer
    Cells(2, 2) = Application.WorksheetFunction.Sum(Range(&quot;A1:A30000&quot;))
    t2 = Timer - t
    Application.ScreenUpdating = True
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
ShFunction过程分别使用VBA代码和调用工作表Sum函数对单元格区域进行求和计算，最后使用消息显示运行时间。
第9行到第11行代码使用VBA的累加方法计算单元格A1：A30000的和。
第14行代码调用工作表Sum函数计算单元格A1：A30000的和。VBA中调用工作表函数请参阅技巧153 。
运行ShFunction过程，消息框显示两种方法的运行时间，可以看出调用工作表函数进行计算的运行时间要远远小于使用累加方法运行的时间，如图 190 2所示。

图 190 2    运行时间比较</code></pre>
<h4 id="190-3-使用更快的单元格操作方法"><a href="#190-3-使用更快的单元格操作方法" class="headerlink" title="190-3    使用更快的单元格操作方法"></a>190-3    使用更快的单元格操作方法</h4><p>在对单元格区域进行操作时，使用Find、Replace、SpecialCells等方法可以比使用VBA代码获得更快的速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Methods()
    Dim arr As Variant
    Dim i As Long
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    With Range(&quot;A1:A20000&quot;)
        arr = .Value
        t = Timer
        For i = 20000 To 1 Step -1
            If Cells(i, 1) = &quot;Excel&quot; Then
                Cells(i, 1).EntireRow.Delete
            End If
        Next
        t1 = Timer - t
        .Value = arr
        t = Timer
        .Replace &quot;Excel&quot;, &quot;&quot;
        .SpecialCells(4).EntireRow.Delete
    End With
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
Methods过程分别使用VBA代码和使用Replace、SpecialCells方法删除工作表A列内容为“Excel”的单元格所在的行，最后使用消息显示运行时间。
第8行代码将单元格数据保存在数组arr中，因为在运行第2种方法前需要恢复单元格数据。
第10行到第14行代码，采用遍历单元格的方法删除内容为“Excel”的单元格所在的行。
第16行代码恢复单元格原有的数据。
第18行代码使用Replace方法将内容为“Excel”的单元格替换成空白单元格。
第19行代码使用SpecialCells方法定位到空白单元格后一次性删除其所在的行。
关于Replace方法和SpecialCells方法请参阅技巧33 。
运行Methods过程，消息框显示两种方法的运行时间，可以看出使用Replace方法和SpecialCells方法的运行时间要远远小于使用VBA代码运行的时间，如图 190 3所示。

图 190 3    运行时间比较</code></pre>
<h4 id="190-4-使用With语句引用对象"><a href="#190-4-使用With语句引用对象" class="headerlink" title="190-4    使用With语句引用对象"></a>190-4    使用With语句引用对象</h4><p>在需要重复引用同一个对象时可以使用With语句来获得较快的运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub WithSta()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet1&quot;).Cells(1, 1) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 2) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 3) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 4) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 5) = 10
    Next
    t1 = Timer - t
    t = Timer
    With Sheets(&quot;Sheet1&quot;)
        For i = 1 To 5000
            .Cells(1, 1) = 10
            .Cells(1, 2) = 10
            .Cells(1, 3) = 10
            .Cells(1, 4) = 10
            .Cells(1, 5) = 10
        Next
    End With
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
WithSta过程在单元格填充时使用With语句来引用工作表对象从而获得较快的运行速度。
With语句在一个单一对象或一个用户定义类型上执行一系列的语句，语法如下：
With Object
    [statements]
End With
参数object是必需的，一个对象或用户自定义类型的名称。
参数statements是可选的，要执行的一条或多条语句。
With语句可以对某个对象执行一系列的语句，而不用重复指出对象的名称。在运行时只需引用对象一次而不是在每个属性赋值时都要引用，从而获得较快的运行速度。
运行WithSta过程，消息框显示两种方法的运行时间，可以看出使用With语句来引用工作表对象的运行速度较快，如图 190 4所示。

图 190 4    运行时间比较</code></pre>
<h4 id="190-5-少用激活或选择语句"><a href="#190-5-少用激活或选择语句" class="headerlink" title="190-5    少用激活或选择语句"></a>190-5    少用激活或选择语句</h4><p>在学习VBA的过程中我们经常通过录制新宏的方法来获得所需的代码，但是在录制宏的过程中会记录所有的动作，代码中有大量的Select和Activate语句，而这些代码往往是不必要而且会影响代码的运行速度。所以通过录制新宏的方法获得的代码在使用时需要进行修改以加快运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Sta()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet2&quot;).Select
        Range(&quot;A1&quot;).Select
        ActiveCell.FormulaR1C1 = &quot;1&quot;
    Next
    t1 = Timer - t
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet2&quot;).Range(&quot;A1&quot;) = 1
    Next
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
Sta过程分别使用录制宏所得的代码和修改后的代码给单元格填充，最后使用消息显示运行时间。
第8行代码到第10行代码是录制宏所得的代码，其中有两次使用Select方法，第15行代码是修改后的代码，在代码量不大的情况下运行速度区别不大，但是在循环5000次后运行速度就会差别很大。
运行Sta过程，消息框显示两种方法的运行时间，可以看出后一种方法的运行时间要远远小于录制宏所得的代码的运行时间，如图 190 5所示。

图 190 5    运行时间比较</code></pre>
<h3 id="技巧191-取得文件的基本名称"><a href="#技巧191-取得文件的基本名称" class="headerlink" title="技巧191     取得文件的基本名称"></a>技巧191     取得文件的基本名称</h3><p>技巧77-2中介绍了如何使用Excel内置的“打开”对话框来获得选定文件的文件名称，此名称包含文件路径及文件扩展名，有时在操作时只需要文件的基本名称，此时可以使用GetBaseName方法，如下面的代码所示。</p>
<pre><code class="vb">Sub GetName()
    Dim MyFile As Object
    Dim Filename As Variant
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    Filename = Application.GetOpenFilename
    If Filename &lt;&gt; False Then
        MsgBox MyFile.GetBaseName(Filename)
    End If
End Sub
代码解析：
GetName过程取得用户选定文件的基本文件名称。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile，请参阅技巧180 。
第5行代码使用GetOpenFilename方法显示标准的内置“打开”对话框，请参阅技巧77-2。
第6行到第8行代码，如果用户选定了文件，使用消息框显示选定文件的基本名称。应用于FileSystemObject对象的GetBaseName方法返回一个包含路径中最后部件的基本名字（去掉任何文件扩展名）的字符串，语法如下：
object.GetBaseName(path)
参数object是必需的，FileSystemObject对象的名称。
参数path是必需的，要返回其基本名字的部件的路径说明。
注意   GetBaseName方法只对参数path提供的字符串起作用，既不试图去辨认路径，也不检查指定路径是否存在。
运行GetName过程，在打开对话框中选定示例文件后结果如图 191 1所示。

图 191 1    取得文件的基本名称</code></pre>
<h3 id="技巧192-防止用户中断代码运行"><a href="#技巧192-防止用户中断代码运行" class="headerlink" title="技巧192     防止用户中断代码运行"></a>技巧192     防止用户中断代码运行</h3><p>在使用VBA开发的程序交予用户使用后，如果在运行需要长时间执行的宏代码时，用户在代码运行期间按下了<esc>键或者&lt;Ctrl+Break&gt;组合键，会显示如图 192 1所示的消息框。</esc></p>
<p>图 192 1    代码中断消息框<br>此时单击“继续”按钮将继续执行代码，单击“结束”按钮结束过程，单击“调试”按钮进入中断模式，这显然不是用户所希望出现的，此时需要使用Application对象的EnableCancelKey属性来进行控制，如下面的代码所示。</p>
<pre><code class="vb">Sub EnablEsc()
    Dim i As Integer
    Application.EnableCancelKey = xlDisabled
    For i = 1 To 2000
        Cells(1, 1) = i
    Next
End Sub
代码解析：
EnablEsc过程在代码运行期间禁用“取消”键的捕获功能。
应用于Application对象的EnableCancelKey属性控制将用户中断用于运行程序的处理，语法如下：
expression.EnableCancelKey
参数是expression必需的，Application对象。
EnableCancelKey属性值为表格 192 1所示的XlEnableCancelKey常量之一。
常量    值    描述
xlDisabled    0    完全禁用“取消”键捕获功能
xlErrorHandler    2    将中断作为错误信号传递给运行程序，由 On Error GoTo 语句设置的错误处理程序捕获。可捕获的错误代码为 18
xlInterrupt    1    中断当前运行程序，用户可进行调试或结束程序的运行
表格 192 1    XlEnableCancelKey常量
只要Microsoft Excel返回空闲状态并且没有程序处于运行状态，EnableCancelKey属性都会重置为xlInterrupt。若要在程序运行中捕获或者禁用取消过程，则每次在程序被调用时必须明确更改EnableCancelKey属性。
### 技巧193     加班费计算表
财务人员在工作中经常需要计算职工的加班费，在计算过程中需要根据职工的技能工资、岗位工资之和除以21天得到日工资标准，再根据当月的加班天数乘以相应的系数才能计算出加班费总额，计算时非常的烦琐，很不方便。使用Excel制作的加班费计算表可以很方便的计算职工的加班费。
步骤1，新建工作簿，将Sheet2工作表重命名为“人员信息”，在第一行中写入所需信息的字段名称，如图 193 1所示。

图 193 1    人员信息表</code></pre>
<p>步骤2，所需的人员信息无需在工作表中一一输入，前四个可以从工资软件中导出的文本文件中获取，后两个可以使用代码自动生成。在VBE窗口中插入模块，写入下面的代码。</p>
<pre><code class="vb">Sub ImportWages()
    Dim GetName As Variant
    Dim TxtPath As String
    Dim TxtName As String
    Dim Tbtext As String
    Dim sField As String
    Dim Cnn As ADODB.Connection
    Dim rs As New ADODB.Recordset
    Dim r As Integer
    Dim i As Integer
    Dim b As Integer
    Dim StrName As String
    If MsgBox(&quot;是否重新导入工资表数据?&quot;, vbQuestion + vbYesNo, &quot;系统提示&quot;) = vbNo Then: Exit Sub
    On Error GoTo line
    GetName = Application.GetOpenFilename(Title:=&quot;导入工资&quot;, fileFilter:=&quot;All files (*.*),*.*&quot;)
    With Sheet2
        .Select
        .Unprotect
        If GetName &lt;&gt; False Then
            TxtPath = CreateObject(&quot;Scripting.FileSystemObject&quot;).GetParentFolderName(GetName)
            TxtName = CreateObject(&quot;Scripting.FileSystemObject&quot;).GetFileName(GetName)
            Tbtext = &quot; [Text;DATABASE=&quot; &amp; TxtPath &amp; &quot;].&quot; &amp; TxtName
            Set Cnn = New ADODB.Connection
            Cnn.Open &quot;provider=microsoft.jet.oledb.4.0;extended properties=&#39;excel 8.0;hdr=yes&#39;;data source=&quot; &amp; ThisWorkbook.FullName
            rs.Open &quot;select 人员编号,姓名,技能工资,岗位工资 from &quot; &amp; Tbtext, Cnn
            r = .Range(&quot;A65536&quot;).End(xlUp).Row
            If r &gt;= 3 Then .Range(&quot;A3:F&quot; &amp; r).ClearContents
            .Range(&quot;A3&quot;).CopyFromRecordset rs
            r = .Range(&quot;A65536&quot;).End(xlUp).Row
            .Range(&quot;A&quot; &amp; r &amp; &quot;:F&quot; &amp; r).ClearContents
            For i = 3 To r
                StrName = &quot;&quot;
                For b = 1 To Len(.Cells(i, 2))
                    If Asc(Mid$(.Cells(i, 2), b, 1)) &gt; 255 Or Asc(Mid$(.Cells(i, 2), b, 1)) &lt; 0 Then
                        StrName = StrName &amp; LChin(Mid$(.Cells(i, 2), b, 1))
                    Else
                        StrName = StrName &amp; LCase(Mid$(.Cells(i, 2), b, 1))
                    End If
                Next b
                .Cells(i, 5) = Round((Val(.Cells(i, 3)) + Val(.Cells(i, 4))) / 21, 2)
                .Cells(i, 6) = StrName
            Next i
        End If
        .Protect
    End With
    Exit Sub
line:
    MsgBox &quot;请选择正确的文本文件!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
ImportWages过程从工资软件导出的文本文件中导入人员的工资信息并计算日工资、生成助记码。
第13行代码，确认是否需要重新导入工资信息。
第14行代码，错误处理语句。在第25行代码中，如果打开的文件不是从工资软件中导出的文本文件，会因找不到所查询的字段名称而发生错误。
第15行代码，使用GetOpenFilename方法显示“打开”对话框，用来获得从工资软件中导出的文本文件的文件路径。关于GetOpenFilename方法请参阅77-2。
第18行代码，取消Sheet2表的工作表保护。
第19行到第21行代码，如果在“打开”对话框中选择了文件并按下了“打开”按钮使用GetParentFolderName方法将返回的路径中的文件路径赋给字符串变量TxtPath，使用GetFileName方法将返回的路径中的包含扩展名的文件名称赋给字符串变量TxtName。关于FileSystemObject对象的一些方法请参阅技巧180 。
第22行到第25行代码，使用ADO语句从选择文本文件中查询需要的数据。其中第25行代码设置需查询数据的字段名称。
第26、27行代码，使用ClearContents方法清除表中原来的数据。
第28行代码，将查询到数据写入到工作表中。
第29、30行代码，使用ClearContents方法清除导入数据的最后一行，即最后的合计行。
第31行到第39行代码，根据B列中的人员姓名生成助记码，方便在使用时输入人员姓名。请参阅技巧114 。
第40行代码，根据C列的技能工资和D列的岗位工资计算日工资标准并写入到E列中。
第41行代码，将生成的人员姓名助记码写入到F列中。
第44行代码，使用Protect方法保护Sheet2表。
第48行代码，如果文件选择错误，使用消息框进行提示。
运行ImportWages过程将显示一个“打开”对话框用来获得需打开的工资表文件的路径及文件名称，如图 193 2所示。

图 193 2    “打开”对话框
当选择好最新的工资表文件后单击“打开”按钮，将最新的工资数据导入到Sheet2表中，如图 193 3所示。

图 193 3    导入工资数据</code></pre>
<p>在ImportWages过程的第35行代码使用自定义LChin函数将中文字符转换为拼音首字母，需要在模块中写入下面的代码。</p>
<pre><code class="vb">Public Function LChin(Str As String) As Variant
    On Error Resume Next
    Str = StrConv(Str, vbNarrow)
    If Asc(Str) &gt; 0 Or Err.Number = 1004 Then LChin = &quot;&quot;
    LChin = WorksheetFunction.VLookup(Str, [{&quot;吖&quot;,&quot;a&quot;;&quot;八&quot;,&quot;b&quot;;&quot;嚓&quot;,&quot;c&quot;;&quot;咑&quot;,&quot;d&quot;;&quot;鵽&quot;,&quot;e&quot;;&quot;发&quot;,&quot;f&quot;;&quot;猤&quot;,&quot;g&quot;;&quot;铪&quot;,&quot;h&quot;;&quot;夻&quot;,&quot;j&quot;;&quot;咔&quot;,&quot;k&quot;;&quot;垃&quot;,&quot;l&quot;;&quot;嘸&quot;,&quot;m&quot;;&quot;旀&quot;,&quot;n&quot;;&quot;噢&quot;,&quot;o&quot;;&quot;妑&quot;,&quot;p&quot;;&quot;七&quot;,&quot;q&quot;;&quot;囕&quot;,&quot;r&quot;;&quot;仨&quot;,&quot;s&quot;;&quot;他&quot;,&quot;t&quot;;&quot;屲&quot;,&quot;w&quot;;&quot;夕&quot;,&quot;x&quot;;&quot;丫&quot;,&quot;y&quot;;&quot;帀&quot;,&quot;z&quot;}], 2)
#006  End Function
关于拼音首字母的转化请参阅技巧114 中的相关内容。
步骤3，将Sheet1工作表重命名为“加班费计算”并设置成如图 193 4所示。

图 193 4    加班费计算
步骤4，为了方便输入人员姓名，需要输入时能逐步提示信息，而工作表的单元格处于编辑状态时是无法运行宏代码，所以需要在Sheet1表中添加一个文本框控件和一个列表框控件，文本框用来代替单元格进行输入，列表框显示提示的信息。</code></pre>
<p>为了使文本框控件和列表框控件只有在需要输入人员姓名时显示，在Sheet1表写入下面的代码。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim i As Integer
    Dim r As Integer
    Dim arr As Variant
    r = Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row
    If Target.Count = 1 Then
        If Target.Column = 2 And Target.Row &gt; 4 And Target.Row &lt; r Then
            If Target.Row = r - 1 Then
                Sheet1.Unprotect
                Rows(r).Insert Shift:=xlDown
                Sheet1.Protect
            End If
            With Me.TextBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Left
                .Width = Target.Width
                .Height = Target.Height
            End With
            With Me.ListBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Offset(, 1).Left
                .Width = 80
                .Height = Target.Height * 8
                .ColumnCount = 2
                .ColumnWidths = &quot;30,45&quot;
                arr = Sheet2.Range(&quot;A3:B&quot; &amp; Sheet2.[B63556].End(xlUp).Row)
                .Column = Application.WorksheetFunction.Transpose(arr)
            End With
        Else
            Me.ListBox1.Clear
            Me.TextBox1 = &quot;&quot;
            Me.ListBox1.Visible = False
            Me.TextBox1.Visible = False
        End If
    End If
End Sub
代码解析：
工作表的SelectionChange事件，当选择工作表的B列单元格时显示文本框控件和列表框控件供输入人员姓名。请参阅技巧114 中的相关内容。
当选择Sheet1表的B列单元格时效果如图 193 5所示。

图 193 5    人员选择</code></pre>
<p>为了输入时能逐步提示信息，在文本框控件和列表框控件中写入下面的代码。</p>
<pre><code class="vb">Private Sub TextBox1_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim i As Integer
    Dim Language As String
    Dim myStr As String
    Me.ListBox1.Clear
    With Me.TextBox1
        For i = 1 To Len(.Value)
            Select Case Asc(Mid$(.Value, i, 1))
                Case 48 To 56
                    Language = &quot;S&quot;
                    myStr = myStr &amp; Mid$(.Value, i, 1)
                Case Is &lt; 0, Is &gt; 255
                    Language = &quot;Z&quot;
                    myStr = myStr &amp; Mid$(.Value, i, 1)
                Case Else
                    Language = &quot;P&quot;
                    myStr = myStr &amp; LCase(Mid$(.Value, i, 1))
            End Select
        Next
    End With
    With Sheet2
        For i = 3 To .Range(&quot;A65536&quot;).End(xlUp).Row
            Select Case Language
                Case &quot;S&quot;
                    If Left(.Cells(i, 1).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
                Case &quot;Z&quot;
                    If Left(.Cells(i, 2).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
                Case Else
                    If Left(.Cells(i, 6).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
            End Select
        Next
    End With
End Sub
代码解析：
文本框的KeyUp事件，在文本框中输入姓名时根据输入的内容进行逐步提示，可以使用三种方法进行输入，人员编号、中文字符和拼音首字母。
第7行到第19行代码，使用字符串变量Language保存输入的方式，字符串变量myStr保存输入的内容。
第21行到第42行代码，根据输入方法的不同，在Sheet2表的不同列中查找符合字符串变量myStr的单元格，并赋给列表框控件。</code></pre>
<pre><code class="vb">Private Sub TextBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = vbKeyReturn Then
        Sheet1.ListBox1.Activate
    End If
End Sub
代码解析：
文本框的KeyDown事件，在文本框中输入查询条件，当列表框中出现符合条件的数据后按回车键后选择列表框，方便输入。</code></pre>
<pre><code class="vb">Private Sub ListBox1_GotFocus()
    On Error Resume Next
    ListBox1.ListIndex = 0
End Sub
代码解析：
列表框的GotFocus事件，当列表框激活后选择第一条条目，以便用户按上下键进行选择或按回车键后输入到工作表中。</code></pre>
<pre><code class="vb">#Private Sub ListBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    On Error Resume Next
    If KeyCode = vbKeyReturn Then
        Sheet1.Unprotect
        ActiveCell.Value = Me.ListBox1.Column(1)
        ActiveCell.Offset(, -1).Value = Me.ListBox1.Column(0)
        Me.ListBox1.Clear
        Me.TextBox1 = &quot;&quot;
        Me.ListBox1.Visible = False
        Me.TextBox1.Visible = False
        Sheet1.Protect
    End If
End Sub
代码解析：
列表框的KeyDown事件，按回车键后将列表框中选择的条目输入到工作表中，并清除文本框和列表框的内容后隐藏，以便下一次输入。</code></pre>
<pre><code class="vb">Private Sub ListBox1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    On Error Resume Next
    Sheet1.Unprotect
    ActiveCell.Value = Me.ListBox1.Column(1)
    ActiveCell.Offset(, -1).Value = Me.ListBox1.Column(0)
    Me.ListBox1.Clear
    Me.TextBox1 = &quot;&quot;
    Me.ListBox1.Visible = False
    Me.TextBox1.Visible = False
    Sheet1.Protect
End Sub
代码解析：
列表框的DblClick事件，双击列表框中选择的条目，输入到工作表中，并清除文本框和列表框的内容后隐藏，以便下一次输入。输入时逐步提示信息请参阅技巧114 。
步骤5，为了在输入人员姓名后在Sheet1工作表的C列中写入相应的日工资标准，在Sheet1工作表的写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Dim rng As Range
    Dim r As Integer
    On Error Resume Next
    With Target
        If .Row &gt; 4 And .Count = 1 Then
            If .Column = 1 Then
                r = Sheet2.Range(&quot;A63556&quot;).End(xlUp).Row
                For Each rng In Sheet2.Range(&quot;A3:A&quot; &amp; r)
                    If rng.Text Like .Text Then
                        .Offset(, 2).Value = rng.Offset(, 4).Value
                    End If
                Next
            End If
            If .Column = 2 Then
                If .Text = &quot;&quot; Then
                    Application.EnableEvents = False
                    Sheet1.Unprotect
                    Rows(.Row).Delete
                    Sheet1.Protect
                    Application.EnableEvents = True
                End If
            End If

        End If
    End With
End Sub
代码解析：
Sheet1工作表的Change事件，当输入人员编号和人员姓名后，将对应的日工资标准写入到Sheet1工作表的C列中。
第6行代码设置事件的触发条件。
第7行到第14行代码，删除B列单元格中的人员姓名则同时删除对应的人员编号和日工资标准。
第18行到第29行代码，检查输入的人员姓名是否重复。因为单位中可能有重复的人员姓名，但是人员编号是唯一的，所以根据人员编号检查输入的人员姓名是否重复。
第30行到第34行代码，使用Like方法在根据人员编号在Sheet2表的A列中查找相对应的人员编号，找到后将日工资标准写入到Sheet1工作表的C列中。
在Sheet1工作表的B列中输入人员姓名后效果如图 193 6所示。

图 193 6    写入日工资标准</code></pre>
<p>步骤6，在某些情况下，可能需要输入全部人员的姓名，比如在笔者单位每年的7、8月份要发放高温加班工资，这时可以从Sheet2表中将所有人员的姓名和编号导入到Sheet1表中，需要在模块中写入下面的代码。</p>
<pre><code class="vb">Sub ImportName()
    Dim r1 As Integer
    Dim r2 As Integer
    Dim i As Long
    r1 = Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row
    r2 = Sheet2.Range(&quot;B63556&quot;).End(xlUp).Row
    If MsgBox(&quot;确定要导入所有人员姓名吗&quot;, 32 + vbYesNo, &quot;系统提示&quot;) = vbNo Then Exit Sub
    Application.ScreenUpdating = False
    With Sheet1
        .Select
        .Unprotect
        If r1 &lt;= r2 + 3 Then .Rows(r1).Resize(r2 - r1 + 4).Insert
        For i = 5 To Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row - 2
            .Cells(i, 1) = Sheet2.Cells(i - 2, 1)
            .Cells(i, 2) = Sheet2.Cells(i - 2, 2)
        Next
        .Protect
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
ImportName过程将Sheet2工作表的人员姓名导入到Sheet1工作表的B列单元格中。
第5、6行代码，取得两个工作表中现有数据的行号。
第12行代码，根据两个工作表中现有数据的行号决定在到Sheet1工作表需要插入的行数。
第13行第16行代码，将Sheet2工作表的人员编号和人员姓名导入到Sheet1工作表的B列单元格中，因为在写入的过程中同时会触发工作表的Change事件，所以日工资标准无需导入。
如果有少量不需要计算的人员姓名可以在导入后删除。</code></pre>
<p>步骤7，如果在输入时Sheet1工作表中已有数据，可以先进行清除，在模块中写入下面的代码。</p>
<pre><code class="vb">Sub DataClear()
    Dim r As Integer
    With Sheet1
        .Select
        If MsgBox(&quot;是否清除加班费数据?&quot;, 32 + vbYesNo, &quot;系统提示&quot;) = vbNo Then Exit Sub
        .Unprotect
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        If r &gt;= 6 Then
            .Rows(&quot;5:&quot; &amp; r - 2).Delete
        End If
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        Union(.Cells(2, 12), .Range(.Cells(r, 5), .Cells(r, 12))).ClearContents
        .Protect
        Application.GoTo Reference:=.Cells(5, 4), Scroll:=True
    End With
End Sub
代码解析：
DataClear过程清除计算表中已有的数据。</code></pre>
<p>步骤8，在VBE中插入一个窗体，用于计算加班费时选择计算的月份并对Sheet2表的D、F、H和J列中输入的加班班数计算应发的加班费合计，如图 193 7所示。</p>
<p>图 193 7    计算加班费窗体<br>双击窗体写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    SpinButton1.Value = Year(Date)
    SpinButton2.Value = Month(Date)
    TextBox1.Text = Year(Date) &amp; &quot;年&quot;
    TextBox2.Text = Month(Date) &amp; &quot;月份&quot;
End Sub
代码解析：
窗体的Initialize事件，在窗体初始化时文本框中显示当前的年月。</code></pre>
<p>双击窗体中的SpinButton控件，写入下面的代码。</p>
<pre><code class="vb">Private Sub SpinButton1_Change()
    TextBox1.Text = SpinButton1.Value &amp; &quot;年&quot;
End Sub
Private Sub SpinButton2_Change()
    With SpinButton2
        Select Case .Value
            Case 1 To 12
                TextBox2.Text = .Value &amp; &quot;月份&quot;
            Case Is &gt; 12
                TextBox1.Text = Left(TextBox1.Text, 4) + 1 &amp; &quot;年&quot;
                .Value = 1
            Case Is &lt; 1
                TextBox1.Text = Left(TextBox1.Text, 4) - 1 &amp; &quot;年&quot;
                .Value = 12
        End Select
    End With
End Sub
代码解析：
使用SpinButton控件调节窗体中显示的年月，请参阅技巧140 。</code></pre>
<p>双击窗体中的“确定”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim r As Integer
    With Sheet1
        .Select
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        If .Cells(5, 2) = &quot;&quot; Then
            MsgBox &quot;请把数据填写完整后再计算!&quot;, 64, &quot;系统提示&quot;
            Unload Me
            Exit Sub
        End If
        For i = 5 To r - 2
            If WorksheetFunction.CountIf(.Range(&quot;B5:B&quot; &amp; i), .Cells(i, 2)) &gt; 1 Then
                If MsgBox(.Cells(i, 2) &amp; &quot;输入重复,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
                    Unload Me
                    Exit Sub
                End If
            End If
        Next
        .Unprotect
        .Cells(2, 12) = TextBox2.Text
        For i = 5 To r - 1
            .Cells(i, 5) = Round(100 * .Cells(i, 4), 2)
            .Cells(i, 7) = Round(.Cells(i, 3) * 1.5 * .Cells(i, 6), 2)
            .Cells(i, 9) = Round(.Cells(i, 3) * 2 * .Cells(i, 8), 2)
            .Cells(i, 11) = Round(.Cells(i, 3) * 3 * .Cells(i, 10), 2)
            .Cells(i, 12) = .Cells(i, 5) + .Cells(i, 7) + .Cells(i, 9) + .Cells(i, 11)
        Next
            .Cells(r, 5) = WorksheetFunction.Sum(.Range(&quot;E5:E&quot; &amp; r - 1))
            .Cells(r, 7) = WorksheetFunction.Sum(.Range(&quot;G5:G&quot; &amp; r - 1))
            .Cells(r, 9) = WorksheetFunction.Sum(.Range(&quot;I5:I&quot; &amp; r - 1))
            .Cells(r, 11) = WorksheetFunction.Sum(.Range(&quot;K5:K&quot; &amp; r - 1))
            .Cells(r, 12) = WorksheetFunction.Sum(.Range(&quot;L5:L&quot; &amp; r - 1))
        .Protect
    End With
    Unload Me
    MsgBox TextBox1.Text &amp; TextBox2.Text &amp; &quot;的加班费已计算完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
窗体中的“确定”按钮的Click事件过程，计算Sheet1表中的加班费合计。
第7行到第11行代码，检查Sheet1表中是否已输入人员姓名及加班班数。
第12行到第19行代码，检查Sheet1表中的人员编号是否重复。
第21行代码，在Sheet1表中写入所计算的月份。
第22行到第28行代码，根据加班班数和相应的系数计算加班费金额。
第29行到第33行代码，计算合计栏的金额。
在Sheet1表中输入人员姓名和加班天数后按窗体的“确定”按钮后效果如图 193 8所示。

图 193 8    计算加班费</code></pre>
<p>为了计算高温加班工资，VBE中插入一个和计算加班费类似的窗体，双击窗体中的“确定”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim rng As Range
    Dim i As Integer
    Dim r As Integer
    With Sheet1
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        .Select
        If .Cells(5, 2) = &quot;&quot; Then
            MsgBox &quot;请把数据填写完整后再计算!&quot;, 64, &quot;系统提示&quot;
            Unload Me
            Exit Sub
        End If
        For i = 5 To r - 2
            If WorksheetFunction.CountIf(.Range(&quot;B5:B&quot; &amp; i), .Cells(i, 2)) &gt; 1 Then
                If MsgBox(.Cells(i, 2) &amp; &quot;输入重复,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
                    Unload Me
                    Exit Sub
                End If
            End If
        Next
        Application.ScreenUpdating = False
        .Unprotect
        .Cells(2, 12) = TextBox2.Text
        With Sheet2.Range(&quot;A:A&quot;)
            For i = 5 To r - 1
                Set rng = .Find(What:=Cells(i, 1).Value, _
                    After:=.Cells(.Cells.Count), _
                    LookIn:=xlFormulas, _
                    LookAt:=xlWhole, _
                    SearchOrder:=xlByRows, _
                    SearchDirection:=xlNext, _
                    MatchCase:=False)
                If Not rng Is Nothing Then
                    Sheet1.Cells(i, 12) = Round(((Val(rng.Offset(0, 2)) + Val(rng.Offset(0, 3))) / 2), 2)
                End If
            Next
        End With
        .Cells(r, 12) = WorksheetFunction.Sum(.Range(&quot;L5:L&quot; &amp; r - 1))
        .Protect
    End With
    Application.ScreenUpdating = True
    Unload Me
    MsgBox TextBox1.Text &amp; TextBox2.Text &amp; &quot;的高温工资计算完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
窗体中的“确定”按钮的Click事件过程，计算Sheet1表中的高温工资。
第8行到第12行代码，检查Sheet1表中是否已输入人员姓名。
第13行到第20行代码，检查Sheet1表中的人员编号是否重复。
第23行代码，在Sheet1表中写入所计算的月份。
第24行到第37行代码，根据Sheet1表中的人员编号在Sheet2表中查找对应的“技能工资”和“岗位工资”并将其合计数的二分之一写入到Sheet1表中。（笔者所在单位每年发一次高温加班工资，为职工“技能工资”和“岗位工资”之和，分两个月发放）
第38行代码，计算合计栏的金额。
在Sheet1表中输入人员姓名和加班天数后按窗体的“确定”按钮后效果如图 193 9所示。

图 193 9    计算高温工资</code></pre>
<p>步骤8，加班费计算完毕后，需要进行汇总，以便统计全年的加班费总额。将Sheet3工作表重命名为“加班费汇总”并设置成如图 193 10所示的格式，在A列和B列中分别写入人员编号和姓名。</p>
<p>图 193 10    加班费汇总表<br>在模块中写入下面的代码。</p>
<pre><code class="vb">Sub DataSummary()
    Dim MyMonth As String
    Dim c As Integer
    Dim rng As Range
    Dim r As Integer
    Dim i As Integer
    MyMonth = Sheet1.Cells(2, 12).Value
    If MsgBox(&quot;是否汇总加班费数据?&quot;, 36, &quot;系统提示&quot;) = 7 Then
        Exit Sub
    End If
    If Sheet1.Cells(5, 12) = &quot;&quot; Then
        MsgBox &quot;没有可汇总的数据,请先计算加班费!&quot;, 64, &quot;系统提示&quot;
        Exit Sub
    End If
    With Sheet3
        r = .Range(&quot;A63556&quot;).End(xlUp).Row
        For i = 3 To 14
            If .Cells(1, i).Value = MyMonth Then
                c = i
                Exit For
            End If
        Next
        If .Cells(r, c).Value &gt; 0 Then
            If MsgBox(MyMonth &amp; &quot;加班费已经汇总,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
            Exit Sub
        End If
        End If
        .Unprotect
        Application.ScreenUpdating = False
        With .Range(&quot;A:A&quot;)
            For i = 5 To Sheet1.Range(&quot;A63556&quot;).End(xlUp).Row
                Set rng = .Find(What:=Sheet1.Cells(i, 1).Text, _
                    After:=.Cells(.Cells.Count), _
                    LookIn:=xlFormulas, _
                    LookAt:=xlWhole, _
                    SearchOrder:=xlByRows, _
                    SearchDirection:=xlNext, _
                    MatchCase:=False)
                If Not rng Is Nothing Then
                    rng.Offset(, c - 1) = Val(rng.Offset(, c - 1)) + Val(Sheet1.Cells(i, 12))
                End If
            Next
        End With
       .Cells(r, c).ClearContents
        For i = 2 To r - 1
            .Cells(r, c) = Val(.Cells(r, c)) + Val(.Cells(i, c))
        Next
        For i = 2 To r
            .Cells(i, 15) = WorksheetFunction.Sum(.Range(&quot;C&quot; &amp; i &amp; &quot;:N&quot; &amp; i))
        Next
        Application.GoTo Reference:=.Cells(1, c), Scroll:=True
        .Protect
    End With
    Application.ScreenUpdating = True
    MsgBox MyMonth &amp; &quot;的加班费汇总完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
DataSummary过程将“加班费计算”表中计算好的加班费合计汇总到“加班费汇总”表中。
第8行代码获得需要汇总的月份。
第17行到第22行代码，获得需要汇总的月份在“加班费汇总”表中的列号。
第23行代码到第27行代码，如果“加班费汇总”表中相应的列中已有合计金额，询问是否继续汇总，防止重复汇总。
第30行到第43行代码，使用Find方法将加班费金额进行汇总。关于Find方法请参阅技巧5-1。
第44行到第50行代码在汇总表中重新计算每行每列的合计数。
第51行代码使用GoTo方法选择汇总表中相应的单元格。关于GoTo方法请参阅技巧2-3。
步骤9，加班费计算、汇总完毕后需要进行打印，首先在工作表窗口中单击菜单“文件”→“页面设置”，在“工作表”选项卡中将“顶端标题行”设置为“$1:$4”，然后在VBE中插入一个窗体，如图 193 11所示。

图 193 11 打印窗体</code></pre>
<p>双击窗体中的“打印”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Byte
    Dim i As Integer
    Dim i1 As Integer
    Dim i2 As Integer
    Application.ScreenUpdating = False
    ActiveWindow.View = xlPageBreakPreview
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .ResetAllPageBreaks
        If .HPageBreaks.Count = 0 Then
            .Unprotect
            .Cells(100, 2) = &quot;123&quot;
            i1 = .HPageBreaks(1).Location.Row
            .Cells(100, 2) = &quot;&quot;
            .Unprotect
            For i = r To i1 - 2
                .Rows(r).Insert
            Next
            .Protect
        Else
            .HPageBreaks.Add Before:=.Range(&quot;B65536&quot;).End(xlUp).Offset(1, 0)
            i1 = .HPageBreaks(1).Location.Row - 5
            i2 = .HPageBreaks(.HPageBreaks.Count).Location.Row - .HPageBreaks(.HPageBreaks.Count - 1).Location.Row
            .Unprotect
            For i = 1 To i1 - i2
                .HPageBreaks(.HPageBreaks.Count).Location.Offset(-1, 0).EntireRow.Insert
            Next
            .Protect
        End If
    End With
    ActiveWindow.View = xlNormalView
    Application.ScreenUpdating = True
    Unload Me
    Sheet1.PrintOut Copies:=ComboBox1.Value
End Sub
代码解析：
打印窗体中 “打印”按钮的Click事件过程，打印“加班费计算表”。
第7行代码，将窗口中的视图设置为分页预览。应用于Window对象的View属性返回或设置在窗口中显示的视图，设置成xlPageBreakPreview为分页预览，xlNormalView则为普通视图。
第11行代码，判断Sheet1表是否满页。HPageBreaks属性返回 HPageBreaks集合，代表工作表上的水平分页符，如果工作表中没有水平分页符说明没有满页。
第13行到第15行代码，在B列单元格中写入字符取得Sheet1表中第一个分页符的位置后再删除。
第17行到第19行代码，在Sheet1表中的B列合计栏中插入一定数量的空行使其满页。
第22行代码，如果Sheet1表的打印内容不止一页，在最后一行插入一个分页符。
第23行代码，取得Sheet1表中满页的行数。
第24行代码，取得Sheet1表最后一页中的行数，两者相减即能得到最后一页中需插入的行数。
第26行到第28行代码，在Sheet1表中的B列合计栏中插入一定数量的空行使其满页。
第32行代码，将窗口中的视图设置为普通视图。
当使用“打印”窗体打印Sheet1表时，将自动插入一定数量的空行使其满页打印。
步骤10，为了使用方便，需要在菜单栏中添加自定义菜单来使用各项功能，在模块中写入下面的代码。</code></pre>
<pre><code class="vb">Sub AddNewMenu()
    Dim HelpMenu As CommandBarControl
    Dim NewMenu As CommandBarPopup
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set HelpMenu = .FindControl(ID:=.Controls(&quot;帮助(&amp;H)&quot;).ID)
        If HelpMenu Is Nothing Then
            Set NewMenu = .Controls.Add(Type:=msoControlPopup)
        Else
            Set NewMenu = .Controls.Add(Type:=msoControlPopup, Before:=HelpMenu.Index)
        End If
        With NewMenu
            .Caption = &quot;加班费(&amp;S)&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;导入数据&quot;
                .OnAction = &quot;ImportWages&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;清除加班费&quot;
                .OnAction = &quot;DataClear&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;批量导入人员&quot;
                .OnAction = &quot;ImportName&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;计算加班费&quot;
                .OnAction = &quot;DataCalculation&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;计算高温工资&quot;
                .OnAction = &quot;TemperatureCalculation&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;加班费汇总&quot;
                .OnAction = &quot;DataSummary&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;打印加班费&quot;
                .OnAction = &quot;HPageBreak&quot;
            End With
        End With
    End With
    Set HelpMenu = Nothing
    Set NewMenu = Nothing
End Sub
Sub DelNewMenu()
    Application.CommandBars(&quot;Worksheet menu bar&quot;).Reset
End Sub
代码解析：
AddNewMenu过程在“帮助”菜单前添加一个自定义的“加班费”菜单。
DelNewMenu过程删除自定义的“加班费”菜单。
为了工作簿打开时自动添加“加班费”菜单和关闭时自动删除“加班费”菜单，需要在VBE中双击ThisWorkbook写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Workbook_Activate()
    Call AddNewMenu
End Sub
Private Sub Workbook_Deactivate()
    Call DelNewMenu
End Sub
关于自定义菜单请参阅技巧80 。
保存关闭工作簿，重新打开，将在菜单栏中添加自定义的“加班费”菜单，可以方便的使用加班费计算表中的各项功能，如图 193 12所示。

图 193 12 “加班费”菜单</code></pre>
<h3 id="技巧194-制作发放条"><a href="#技巧194-制作发放条" class="headerlink" title="技巧194     制作发放条"></a>技巧194     制作发放条</h3><p>虽然大多数企业的工资核算都已使用了专业软件，但是有些不能上工资表的项目还是需要使用Excel来制作发放表，比如如图 194 1所示的奖金发放表，这时往往需要提供发放条给每一个职工。</p>
<p>图 194 1    发放表<br>制作发放条的方法有很多，其中使用VBA制作发放条是最方便快捷的，如下面的代码所示。</p>
<pre><code class="vb">Sub Printissued()
    Dim r As Integer
    Dim Sh As Worksheet
    Dim i As Integer
    Application.ScreenUpdating = False
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    With Worksheets
        Set Sh = .Add(after:=Worksheets(.Count))
    End With
    With Sh
        Sheet1.Range(&quot;A1:K&quot; &amp; r).Copy .Range(&quot;A1&quot;)
        .Range(&quot;A5:K&quot; &amp; r) = Sheet1.Range(&quot;A5:K&quot; &amp; r).Value
        .Range(&quot;F2,K2&quot;) = &quot;&quot;
        With .PageSetup
            .PrintTitleRows = &quot;$1:$1&quot;
            .LeftMargin = Application.CentimetersToPoints(1)
            .RightMargin = Application.CentimetersToPoints(1)
            .CenterHorizontally = True
        End With
        For i = 1 To r
            .Rows(i).RowHeight = Sheet1.Rows(i).RowHeight
        Next
        For i = 1 To 11
            Columns(i).ColumnWidth = Sheet1.Columns(i).ColumnWidth
        Next
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        For i = r To 6 Step -1
            .Rows(&quot;2:4&quot;).Copy
            .Rows(i).Insert Shift:=xlDown
        Next
        Application.CutCopyMode = False
        ActiveWindow.View = xlPageBreakPreview
        For i = 1 To .HPageBreaks.Count
            If .HPageBreaks(i).Location.Offset(-1, 0) &lt;&gt; &quot;&quot; Then
                .HPageBreaks.Add Before:=.HPageBreaks(i).Location.Offset(-2, 0)
            End If
        Next
        ActiveWindow.View = xlNormalView
        .PrintOut
        Application.DisplayAlerts = False
        .Delete
        Application.DisplayAlerts = True
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
Printissued过程将发放表以发放条的形式打印。
第5行代码关闭屏幕刷新加快运行速度。
第7行到第9行代码，为了不破坏原表的结构，在工作簿中新建一张工作表用来制作发放条。
第11行代码，将发放表中需要制作发放条的区域拷贝到新工作表中。
第12行代码，将表中的公式部分转化为数值。
第13行代码，删除原表中的年度和人数。
第14行到第19行代码，设置发放条表的打印标题行、左右边距及水平居中。
第20行到第25行代码，设置发放条表的行高列宽与原表一致。
第26行到第31行代码，在发放条的每行数据前插入表头部分。
第32行到第38行代码，因为可能存在同一个人表头和数据不在同一页面的现象，所以逐一检查分页符，如果分页符所在单元格的上面单元格不是空白行则将分页符上移两行。
第39行代码，使用PrintOut方法打印发放条。
第40行到第42行代码，使用Delete方法删除发放条表。
运行Printissued过程，发放条表没删除前如图 194 2所示。

图 194 2    发放条</code></pre>
<h3 id="技巧195-费用统计表"><a href="#技巧195-费用统计表" class="headerlink" title="技巧195     费用统计表"></a>技巧195     费用统计表</h3><p>对于经常发生的一些费用开支，可以使用Excel进行录入和统计，比如使用本统计表可以方便的录入汽车费用明细，对费用明细按时间或类别进行统计，并以图表的形式在窗体中显示出来。<br>步骤1，新建工作簿，将Sheet1表重命名为“费用明细”并设置为如图 195 1所示的格式。</p>
<p>图 195 1        工作表设置<br>步骤2，在Sheet1工作表中单击菜单“视图”→“工具栏”→“控件工具箱”，在显示的工具栏中选择“其他附件”中的DTPicker控件，在工作表中拖动添加一个DTPicker控件。如果“其他附件”中没有该控件，请参阅技巧118 对其进行注册。<br>步骤3，在VBE中双击Sheet1，在工作表的SelectionChange事件过程中写入以下代码。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    If Target.Row &gt; 1 And Target.Row &lt; r And Target.Count = 1 Then
        If Target.Column = 1 Then
            With Me.DTPicker1
                .Visible = True
                .Value = Date
                .Top = Target.Top
                .Left = Target.Left
                .Width = Target.Width + 15
                .Height = Target.Height
            End With
        Else
            Me.DTPicker1.Visible = False
        End If
        If Target.Column = 3 Then
            With Target.Validation
                .Delete
                .Add Type:=xlValidateList, _
                AlertStyle:=xlValidAlertStop, _
                Operator:=xlBetween, _
                Formula1:=&quot;汽油费,过路费,保险费,修理费,保养费,装饰费,改装费,养路费,其他费&quot;
            End With
        End If
     End If
End Sub 
代码解析：
工作表的SelectionChange事件，当选择A列单元格时显示日历控件，选择C列时建立数据有效性，便于在工作表中录入时间及费用类别。
第4行代码，设置该事件的触发条件，只有在选择第2行和“合计”行之间单元格并且只选择一个单元格时事件触发。
第5行到第16行代码如果选择的是第一列录入日期的单元格时，显示日历控件并对其格式进行相应的设置，如图 195 2所示，方便录入费用日期，否则隐藏日历控件。

图 195 2        显示日历控件
第17行到第26行代码如果选择的是第三列录入费用类别的单元格时，在单元格中建立数据有效性设置，如图 195 3所示。关于在工作表中建立数据有效性请参阅12-1。

图 195 3        建立数据有效性
在VBE中双击Sheet1，在工作表的Change事件过程中写入以下代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Dim r1 As Integer
    Dim r2 As Integer
    With Sheet1
        r1 = .Range(&quot;D65536&quot;).End(xlUp).Row
        r2 = .Range(&quot;E65536&quot;).End(xlUp).Row
        If Target.Column = 4 And Target.Row &gt; 1 And Target.Count = 1 Then
            .Range(&quot;E2:E&quot; &amp; r1).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Range(&quot;E2:E&quot; &amp; r1) = Range(&quot;E2:E&quot; &amp; r1).Value
            .Cells(r2, 5).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Cells(r2, 5) = .Cells(r2, 5).Value
        End If
    End With
End Sub
代码解析：
工作表的Change事件过程，当工作表的第四列单元格中录入费用金额时，在第五列“合计”单元格中写入金额合计的公式，并将公式转化为数值。
在设计模式下双击DTPicker控件，写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub DTPicker1_CloseUp()
    ActiveCell = DTPicker1.Value
    DTPicker1.Visible = False
End Sub
代码解析：
DTPicker控件的Change事件，选择日历控件的日期时将日期写入到工作表的活动单元格中。
步骤4，在VBE窗口中单击菜单“插入”→“用户窗体”，添加一个“统计”窗体，在窗体中添加一个ListView和一个框架控件控件，在框架控件中添加三个组合框控件、三个按钮控件和一个框架控件，在其中添加一个标签控件，如图 195 4所示。</code></pre>
<p>图 195 4        统计窗体<br>在VBE中双击窗体写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Col As New Collection
    Dim rng As Range, arr, Category
    Dim i As Integer
    On Error Resume Next
    For Each rng In Sheet1.Range(&quot;A2:A&quot; &amp; [A65536].End(xlUp).Row)
        Col.Add Left(rng, 7), Key:=CStr(Left(rng, 7))
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    Me.Frame1.ComboBox1.List = arr
    Me.Frame1.ComboBox2.List = arr
    Category = Array(&quot;汽油费&quot;, &quot;过路费&quot;, &quot;保险费&quot;, &quot;修理费&quot;, &quot;保养费&quot;, &quot;装饰费&quot;, &quot;其他费&quot;)
    Me.Frame1.ComboBox3.List = Category
    With Me.ListView1
        .ColumnHeaders.Clear
        .ColumnHeaders.Add , , &quot;   日期&quot;, 55, lvwColumnLeft
        .ColumnHeaders.Add , , &quot;       费用内容&quot;, 110, lvwColumnLeft
        .ColumnHeaders.Add , , &quot;费用类别&quot;, 50, lvwColumnCenter
        .ColumnHeaders.Add , , &quot;金额   &quot;, 50, lvwColumnRight
        .ColumnHeaders.Add , , &quot;合计   &quot;, 60, lvwColumnRight
        .View = lvwReport
        .Gridlines = True
    End With
    Me.CommandButton3.Enabled = False
End Sub
代码解析：
窗体的Initialize事件，窗体初始化时对其中的控件进行相应的设置。
第6行到第14行代码，使用Add方法将第一列中的日期去除重复值后取其年月添加到“开始日期”和“结束日期”组合框中，关于使用Add方法去除重复值请参阅技巧110 。
第15、16行代码在“费用类别”组合框中添加列表项。关于在组合框中添加列表项的方法请参阅技巧109 。
第17行到第26行代码在ListView控件中添加标题列并进行相应的设置，请参阅技巧131 。
第27行代码将“图表”按钮的Enabled属性设置为False，使之暂不可用。
在VBE中双击窗体上的“统计”按钮写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim StartDate As Date
    Dim EndDate As Date
    Dim r As Integer
    Dim r2 As Integer
    Dim Itm As ListItem
    Dim i As Integer
    Dim Col As New Collection
    Dim rng As Range
    Dim StrResults As String
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    With Me.Frame1.ComboBox1
        If .Value = &quot;&quot; Then
            StartDate = .List(0) &amp; &quot;-1&quot;
        Else
            StartDate = .Value &amp; &quot;-1&quot;
        End If
    End With
    With Me.Frame1.ComboBox2
        If .Value = &quot;&quot; Then
            EndDate = DateSerial(Year(.List(.ListCount - 1) &amp; &quot;-1&quot;), Month(.List(.ListCount - 1) &amp; &quot;-1&quot;) + 1, 0)
        Else
            EndDate = DateSerial(Year(.Value &amp; &quot;-1&quot;), Month(.Value &amp; &quot;-1&quot;) + 1, 0)
        End If
    End With
    If StartDate &gt; EndDate Then
        MsgBox &quot;开始日期不能大于结束日期,请重新选择!&quot;, , &quot;提示&quot;
        Exit Sub
    End If
    If Me.Frame1.ComboBox3 = &quot;&quot; Then
        Me.CommandButton3.Enabled = True
    Else
        Me.CommandButton3.Enabled = False
    End If
    Application.ScreenUpdating = False
    Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter Field:=1, Criteria1:=&quot;&gt;=&quot; &amp; StartDate, Criteria2:=&quot;&lt;=&quot; &amp; EndDate
    If Me.Frame1.ComboBox3 &lt;&gt; &quot;&quot; Then
        Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter Field:=3, Criteria1:=Me.Frame1.ComboBox3.Value
    End If
    With Sheet2
        .Cells.Clear
        Sheet1.AutoFilter.Range.SpecialCells(12).Copy .Cells(1, 1)
        r2 = .Range(&quot;A65536&quot;).End(xlUp).Row
        If r2 &gt; 1 Then
            .Range(&quot;E2:E&quot; &amp; r2).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Range(&quot;E2:E&quot; &amp; r2) = .Range(&quot;E2:E&quot; &amp; r2).Value
        End If
    End With
    Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter
    With Me.ListView1
        .ListItems.Clear
        For i = 2 To r2
            Set Itm = .ListItems.Add()
            With Sheet2
                Itm.Text = .Cells(i, 1)
                Itm.SubItems(1) = .Cells(i, 2)
                Itm.SubItems(2) = .Cells(i, 3)
                Itm.SubItems(3) = Format(.Cells(i, 4), &quot;0.00&quot;)
                Itm.SubItems(4) = Format(.Cells(i, 5), &quot;0.00&quot;)
            End With
        Next
    End With
    On Error Resume Next
    Sheet3.Range(&quot;A1:B30&quot;).Clear
    If r2 &gt; 1 Then
        For Each rng In Sheet2.Range(&quot;C2:C&quot; &amp; r2)
            Col.Add rng, Key:=CStr(rng)
        Next
        For i = 1 To Col.Count
            With Sheet3
                .Cells(i, 1) = Col(i)
                .Cells(i, 2).FormulaR1C1 = &quot;=SUMIF(统计数据!R2C[1]:R&quot; &amp; r2 &amp; &quot;C[1],RC[-1],统计数据!R2C[2]:R&quot; &amp; r2 &amp; &quot;C[2])&quot;
                .Cells(i, 2) = .Cells(i, 2).Value
                StrResults = StrResults &amp; Space(2) &amp; .Cells(i, 1) &amp; &quot;：&quot; &amp; Space(3) &amp; .Cells(i, 2) &amp; &quot;元&quot; &amp; Chr(13)
            End With
        Next
        Label4.Caption = Space(2) &amp; StartDate &amp; &quot; 至：&quot; &amp; Chr(13) &amp; Space(2) &amp; EndDate &amp; &quot; 期间&quot; &amp; Chr(13) &amp; StrResults &amp; Space(2) &amp; &quot;合  计：&quot; &amp; Space(3) &amp; Sheet2.Cells(r2, 5).Value &amp; &quot;元&quot;
    Else
        Label4.Caption = Space(2) &amp; StartDate &amp; &quot; 至：&quot; &amp; Chr(13) &amp; Space(2) &amp; EndDate &amp; &quot; 期间&quot; &amp; Chr(13) &amp; Space(2) &amp; Me.Frame1.ComboBox3.Value &amp; &quot;没有发生!&quot;
    End If
    Application.ScreenUpdating = True
End Sub
代码解析：
窗体上的“统计”按钮的单击事件，按日期统计费用类型和金额并显示在ListView控件中。
第12行到第18行代码取得需要统计的开始日期，如果没有选择开始日期则默认为工作表中已录入日期的第一个月的第一天。
第19行到第25行代码取得需要统计的结束日期，如果没有选择结束日期则默认为工作表中已录入日期的最后一个月的最后一天。
第26行到第29行代码检查开始日期和结束日期，开始日期不能大于结束日期，否则无法正确统计数据。
第30行到第34行代码设置“图表”按钮的Enabled属性，如果没有选择“费用类别”说明统计的是全部类别，则“图表”按钮有效；如果选择了“费用类别”中的明细类别，则不需要“图表”按钮，因为单一的费用类别是不需要使用图表进行分析的。
第36行代码对工作表中的数据进行自定义筛选，筛选出介于所选开始日期和结束日期之间的数据。
第37行到第39行代码如果同时选择了“费用类别”中的明细类别，则对工作表中筛选出来的数据进行第二次筛选，筛选出该类别的数据。
第40行到第48行代码将筛选结果复制到Sheet2工作表中，请参阅技巧36 。
第49行代码取消筛选模式。
第50行到第62行代码将Sheet2工作表中的筛选结果显示到窗体的ListView控件中。关于ListView控件请参阅技巧131 。
第63行到第68行代码将Sheet2工作表中的筛选结果中的C列中的明细类别使用使用Add方法去除重复值。请参阅技巧110 。
第69行到第80行代码在Sheet3工作表A列中写入类别明细并在B列中写入SUMIF函数计算该费用类别在统计时段中的合计发生费用，并将公式转化为数值。最后使用标签将类别明细和费用金额显示有窗体中。
在VBE中双击窗体上的“图表”按钮写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim myRange As Range
    Dim myChart As ChartObject
    Application.ScreenUpdating = False
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        .ChartObjects.Delete
        Set myRange = .Range(&quot;A&quot; &amp; 1 &amp; &quot;:B&quot; &amp; r)
        Set myChart = .ChartObjects.Add(120, 40, 400, 250)
        With myChart.Chart
            .ChartType = xlPie
            .SetSourceData Source:=myRange, PlotBy:=xlColumns
            .Location xlLocationAsObject, &quot;统计图表&quot;
            .Legend.Position = -4152
            .Legend.Font.Size = 9
            .PlotArea.Interior.ColorIndex = -4142
            .PlotArea.Border.LineStyle = -4142
            .SeriesCollection(1).ApplyDataLabels _
                AutoText:=True, _
                HasLeaderLines:=True, _
                ShowValue:=True, _
                ShowCategoryName:=True, _
                ShowPercentage:=True
            .SeriesCollection(1).DataLabels.Font.Size = 9
        End With
        Set myChart = Nothing
    End With
    Sheet1.Select
    Application.ScreenUpdating = True
    UserForm2.Show
End Sub
代码解析：
窗体中“图表”按钮的单击事件，在Sheet3工作表中根据统计数据建立图表。
第8行代码，首先删除工作表原有的图表。
第10行代码，在Sheet3表中建立新的图表。
第11行到第26行代码，对新建立的图表进行格式设置。关于图表请参阅技巧60 。
第31行代码显示图表窗体。
步骤5，在VBE窗口中单击菜单“插入”→“用户窗体”，添加一个“图表”窗体，在窗体中添加一个Image控件和一个按钮控件，如图 195 5所示。

图 195 5        图表窗体</code></pre>
<p>在VBE中双击窗体，写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Charts As Chart
    Dim cName As String
    Set Charts = Sheet3.ChartObjects(1).Chart
    cName = ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
    Charts.Export Filename:=cName, FilterName:=&quot;GIF&quot;
    Image1.Picture = LoadPicture(cName)
End Sub
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    Kill ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
End Sub
Private Sub CommandButton1_Click()
    Unload Me
End Sub
代码解析：
第1行到第8行代码是窗体的Initialize事件，在窗体初始化时将工作表中的图表显示在窗体中。
第9行到第11行代码是窗体的QueryClose事件，在窗体关闭时删除临时文件。
关于将图表显示在窗体上的方法请参阅技巧146-1。</code></pre>
<p>步骤6，为了方便使用，需要在菜单栏上添加自定义菜单，在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码。</p>
<pre><code class="vb">Sub AddNewMenu()
    Dim HelpMenu As CommandBarControl
    Dim NewMenu As CommandBarPopup
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set HelpMenu = .FindControl(ID:=.Controls(&quot;帮助(&amp;H)&quot;).ID)
        If HelpMenu Is Nothing Then
            Set NewMenu = .Controls.Add(Type:=msoControlPopup)
        Else
            Set NewMenu = .Controls.Add(Type:=msoControlPopup, _
                Before:=HelpMenu.Index)
        End If
        With NewMenu
            .Caption = &quot;汽车费用(&amp;S)&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;批量插入空行(&amp;D)&quot;
                .FaceId = 162
                .OnAction = &quot;InSertRows&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;汽车费用统计(&amp;T)&quot;
                .FaceId = 590
                .OnAction = &quot;Form&quot;
            End With
        End With
    End With
    Set HelpMenu = Nothing
    Set NewMenu = Nothing
End Sub
Sub DelNewMenu()
    Application.CommandBars(&quot;Worksheet menu bar&quot;).Reset
End Sub
Sub Form()
    UserForm1.Show
End Sub
Sub InSertRows()
    Dim dInput As Byte
    Dim i As Byte
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    dInput = Application.InputBox(Prompt:=&quot;请输入插入的行数：&quot;, Title:=&quot;批量插入空行&quot;, Type:=1)
    If dInput &lt;&gt; False Then
        Application.ScreenUpdating = False
        For i = 1 To dInput
            Sheet1.Rows(r).Insert
        Next
        Application.ScreenUpdating = True
    End If
End Sub
代码解析：
AddNewMenu过程在菜单栏的帮助菜单前添加“汽车费用”菜单。
DelNewMenu过程删除添加的“汽车费用”菜单。
Form过程是“汽车费用”菜单中的子菜单“汽车费用统计”所运行的宏过程，显示“图表”窗体。
关于在工作表菜单栏中添加自定义菜单请参阅技巧80 。
InSertRows过程是“汽车费用”菜单中的子菜单“批量插入空行”所运行的宏过程，使用InputBox方法显示一个对话框，输入需要插入的行数后使用Insert方法在工作表中插入空行。
关于InputBox方法请参阅技巧76 ，关于Insert方法请参阅技巧30 。</code></pre>
<p>为了在打开工作簿时自动添加菜单项，需要在工作簿的Activate事件中调用myTools过程，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Activate()
    Call AddNewMenu
End Sub
为了在关闭工作簿时删除新添加的菜单项，还需要在工作簿的Deactivate事件中调用DelmyTools过程，如下面的代码所示。

​```vb
Private Sub Workbook_Deactivate()
    Call DelNewMenu
End Sub
步骤7，因为在平时使用时是不需要操作Sheet2表和Sheet3表的，在VBE中分别选择Sheet2表和Sheet3表的属性窗口，将Visible设置为xlSheetVeryHidden，使工作表深度隐藏，这样在“格式”菜单中就不能取消隐藏。
保存关闭工作簿，重新打开工作簿，在费用明细表中录入数据后，点击“汽车费用”菜单后显示“费用统计”窗体，选择统计条件后即能统计出明细费用，如图 195 6所示。

图 195 6        统计窗体
此时单击窗体中的“图表”按钮将用窗体显示该期间费用的图表，如图 195 7所示。

图 195 7        图表窗体</code></pre>
<h3 id="技巧196-职工花名册"><a href="#技巧196-职工花名册" class="headerlink" title="技巧196     职工花名册"></a>技巧196     职工花名册</h3><p>在实际工作中，往往需要一个花名册用于录入职工的各项信息，在需要时可以方便的进行查找、统计以方便日常工作。<br>使用Excel制作职工花名册可以方便的录入职工信息，对所录入的信息进行修改、筛选择等，制作步骤如下：<br>步骤1，新建工作簿，将Sheet1工作表名称修改为“花名册”，设置成如图 196 1所示的格式。</p>
<p>图 196 1    花名册格式<br>步骤2，在工作表的B列输入职工姓名，F列输入身份证号码，G列输入职称。<br>“部门”、“职务”及“备注”从工作表中的数据有效性中选择，在VBE中双击Sheet1表，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    With Target
        If .Count = 1 And .Row &gt; 5 And .Row &lt;= r Then
            Sheet1.Unprotect
            Select Case .Column
            Case 8
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;经理室,办公室,行政科,生技科,财务科,&quot; _
                            &amp; &quot;营业部,制水车间,污水厂,其他,安装公司,退休&quot;
                End With
            Case 9
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;经理,副经理,支书,副支书,经理助理,&quot; _
                            &amp; &quot;中层正职,中层副职,总账会计,辅助会计,&quot; _
                            &amp; &quot;辅助会计,出纳会计,协理员,管理员,驾驶员,&quot; _
                            &amp; &quot;办事员,科档员,计量员,收费员,发货员,&quot; _
                            &amp; &quot;采购员,化验员,监察队员,班组长,拆表工,&quot; _
                            &amp; &quot;抄表工,勘估设计,预决算,校表工,换表工,&quot; _
                            &amp; &quot;机修工,电工,中控值班,制水工,安装工,&quot; _
                            &amp; &quot;外借,内退&quot;
                End With
            Case 10
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;在职,内退,退休&quot;
                End With
            End Select
            Sheet1.Protect
        End If
    End With
End Sub
代码解析：
工作表的SelectionChange事件过程，当选择工作表的H、I和J列时自动生成相应的数据有效性，请参阅技巧12-1。</code></pre>
<p>“性别”、“出生年月”及“年龄”由输入的身份证号码自动生成，在Sheet1表的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Sheet1.Unprotect
    With Target
        If .Count = 1 And .Row &gt; 5 And .Column = 6 Then
            If .Text &lt;&gt; &quot;&quot; Then
                Application.EnableEvents = False
                .Offset(0, -5).FormulaR1C1 = &quot;=ROW()-5&quot;
                .Offset(0, -3) = IIf(Mid(.Text, 17, 1) Mod 2 = 0, &quot;女&quot;, &quot;男&quot;)
                .Offset(0, -2) = Format(Mid(.Text, 7, 8), &quot;#-00-00&quot;)
                .Offset(0, -1).FormulaR1C1 = &quot;=DATEDIF(TEXT(MID(RC[1],7,8),&quot;&quot;#-00-00&quot;&quot;),TODAY(),&quot;&quot;y&quot;&quot;)&quot;
                Application.EnableEvents = True
            Else
                Rows(.Row) = &quot;&quot;
            End If
        End If
    End With
    Sheet1.Protect
End Sub
代码解析：
工作表的Change事件过程，当输入职工身份证号码后在工作表的C、D和E列自动生成相应的“性别”、“出生年月”及“年龄”。
第7行代码，在A列写入序号的公式。
第8行代码，根据身份证号码的最后第二位数在C列中写入性别。
第9行代码，根据身份证号码中的出生年月信息在D列中写入出生年月。
第10行代码，根据身份证号码中的出生年月信息在E列中写入判断年龄的公式，因为年龄是动态的，所以只能写入公式。
在工作表的H2、H3单元格中写入统计人员类别的公式。</code></pre>
<p>步骤3，为了方便使用，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub SectorSort()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        If MsgBox(&quot;是否按公司部门顺序进行排序?&quot;, 36) = 6 Then
            .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;H6&quot;), _
                Order1:=xlAscending, Key2:=Range(&quot;D6&quot;), _
                OrderCustom:=13
        End If
        .Protect
    End With
End Sub
代码解析：
SectorSort过程对职工花名册按部门进行排序。
第7行到第9行代码使用Sort方法对职工花名册进行排序，应用于Range对象的Sort方法对数据透视表、单元格区域或活动区域（如果指定区域仅包含一个单元格）进行排序，语法如下：
expression.Sort(Key1, Order1, Key2, Type, Order2, Key3, Order3, Header, OrderCustom, MatchCase, Orientation, SortMethod, DataOption1, DataOption2, DataOption3)
其中Key1参数是可选的，指定第一个排序字段，本例中按部门进行排序。
Order1参数是可选的，在Key1参数中指定的字段或区域的排序顺序。
Key2参数是可选的，指定第二个排序字段，本例中按出生年月进行排序。
OrderCustom参数是可选的，是从 1 开始的整数，指定了在自定义排序顺序列表中的索引号。如果省略参数，则使用常规排序。本例中在工作簿中添加了自定义的部门序列，索引号为13，如图 196 2所示。</code></pre>
<p>图 196 2    自定义序列</p>
<pre><code class="vb">Sub AgeSort()
    Dim r As Integer
    Dim imsg As Integer
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        imsg = MsgBox(&quot;选择[是]按升降序排序,选择[否]按降序排序&quot;, 3)
        Select Case imsg
            Case 6
                .Unprotect
                .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
                    Order1:=xlAscending, Key2:=.Range(&quot;D6&quot;)
            Case 7
                .Unprotect
                .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
                    Order1:=xlDescending, Key2:=.Range(&quot;D6&quot;)
            End Select
        .Protect
    End With
End Sub
代码解析：
AgeSort过程对职工花名册依据年龄进行排序。
第10、11行代码，使用Sort方法对职工花名册按年龄进行升序排序，Sort方法的Order1参数排序顺序，可为表格 196 1所示的XlSortOrder 常量之一。
常量    值    描述
xlDescending    2    按降序排序
xlAscending    1    按升序排序
表格 196 1    XlSortOrder 常量
第14、15行代码，使用Sort方法对职工花名册按年龄进行降序排序。</code></pre>
<pre><code class="vb">Sub Forshow()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;H6&quot;), _
            Order1:=xlAscending, Key2:=Range(&quot;D6&quot;), _
            OrderCustom:=13
        .Protect
    End With
    UserForm1.Show
End Sub
代码解析：
Forshow过程对职工花名册按部门进行排序后显示按部门进行筛选的窗体。</code></pre>
<pre><code class="vb">Sub AgeSortForshow()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
            Order1:=xlAscending, Key2:=.Range(&quot;D6&quot;)
        .Protect
    End With
    UserForm2.Show
End Sub
代码解析：
AgeSortForshow过程对职工花名册按年龄进行排序后显示按年龄进行筛选的窗体。</code></pre>
<p>步骤4，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个列表框控件和两个按钮按件，如图 196 3所示。</p>
<p>图 196 3    按部门筛选窗体<br>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    On Error Resume Next
    Dim Col As New Collection
    Dim rng As Range, arr
    Dim i As Integer
    For Each rng In Sheet1.Range(&quot;H6:H&quot; &amp; Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row)
        If Trim(rng) &lt;&gt; &quot;&quot; Then
            Col.Add rng, key:=CStr(rng)
        End If
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    With Me.ListBox1
        .List = arr
        .ListStyle = 1
        .MultiSelect = 1
    End With
End Sub
代码解析：
窗体的Initialize事件过程，窗体显示时将部门名称加载到窗体的列表框中。
第6行到第14行代码，使用Add方法将工作表H列中的部门名称去除重复值。
第15行到第19行代码，将部门名称加载到窗体的列表框并将列表框设置为显示多重选择列表的列表框。窗体显示时如图 196 4所示。

图 196 4    多重选择列表框</code></pre>
<p>双击窗体的“筛选”按钮写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim r As Integer
    Dim r2 As Integer
    Sheet1.Unprotect
    Sheet2.Unprotect
    Application.ScreenUpdating = False
    r2 = Sheet2.Range(&quot;B65536&quot;).End(xlUp).Row
    If r2 &gt; 5 Then
        With Sheet2.Range(&quot;A6:J&quot; &amp; r2)
            .ClearContents
            .Borders.LineStyle = xlNone
        End With
    End If
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    For i = 0 To ListBox1.ListCount - 1
        If ListBox1.Selected(i) = True Then
            Sheet1.Range(&quot;A5:J&quot; &amp; r).AutoFilter Field:=8, Criteria1:=&quot;=&quot; &amp; ListBox1.List(i)
            With Sheet2
                r2 = .Range(&quot;B65536&quot;).End(xlUp).Row
                Sheet1.Range(&quot;A6:J&quot; &amp; r).SpecialCells(12).Copy
                .Cells(r2 + 1, 1).PasteSpecial Paste:=xlPasteValues
                Application.CutCopyMode = False
                With .Range(&quot;A6:A&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row)
                    .FormulaR1C1 = &quot;=ROW()-5&quot;
                    .Value = .Value
                End With
            End With
        End If
    Next
    With Sheet2
        .Range(&quot;A6:J&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row).Borders.LineStyle = xlContinuous
        Application.Goto Reference:=.Range(&quot;A2&quot;), Scroll:=True
        .Protect
    End With
    Sheet1.Range(&quot;A1:J&quot; &amp; r).AutoFilter
    Sheet1.Protect
    Unload Me
    Application.ScreenUpdating = True
End Sub
代码解析：
“筛选”按钮的单击过程，将窗体列表框中所选中的部门数据筛选后复制到工作表中。
第10行到第12行代码，删除工作表中原有的数据，去除边框线。
第16行到第29行代码，将窗体列表框中所选中的部门数据进行筛选后依次复制到工作表中。
其中第18行代码使用AutoFilter方法进行筛选。应用于Range对象的AutoFilter方法使用“自动筛选”筛选出一个列表，语法如下：
expression.AutoFilter(Field, Criteria1, Operator, Criteria2, VisibleDropDown)
参数Field是可选的，相对于作为筛选基准字段（从列表左侧开始，最左侧的字段为第一个字段）的偏移量。本例中设置为8，即指定工作表中的H列进行筛选。
参数Criteria1是可选的，筛选条件。本例中设置为窗体列表框中所选中的部门名称。
第32行代码，将筛选后的数据画上边框线。
步骤5，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件和两个组合框按件，如图 196 5所示。

图 196 5    按年龄筛选窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    On Error Resume Next
    Dim Col As New Collection
    Dim rng As Range, arr
    Dim i As Integer
    For Each rng In Sheet1.Range(&quot;E6:E&quot; &amp; Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row)
        Col.Add rng, key:=CStr(rng)
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    Me.ComboBox1.List = arr
    Me.ComboBox2.List = arr
End Sub
代码解析：
窗体的Initialize事件过程，窗体显示时将所有的年龄加载到窗体的组合框中。
第6行到第12行代码，使用Add方法将工作表E列中的年龄去除重复值。
第13、14行代码，将年龄加载到窗体的组合框中。</code></pre>
<p>双击窗体的“筛选”按钮写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim r2 As Integer
    Dim dInput As Double
    If Me.ComboBox1.Value = &quot;&quot; Or Me.ComboBox2.Value = &quot;&quot; Then
        MsgBox &quot;请选择需要筛选的年龄!&quot;
        Exit Sub
    End If
    If Me.ComboBox1.Value &gt; Me.ComboBox2.Value Then
        MsgBox &quot;开始年龄不能等结束年龄,请重新选择!&quot;
        Me.ComboBox1.ListIndex = -1
        Me.ComboBox2.ListIndex = -1
        Exit Sub
    End If
    Application.ScreenUpdating = False
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Unprotect
        .Range(&quot;A5:J&quot; &amp; r).AutoFilter Field:=5, Criteria1:=&quot;&gt;=&quot; &amp; Me.ComboBox1.Value, Operator:=xlAnd, Criteria2:=&quot;&lt;=&quot; &amp; Me.ComboBox2.Value
        With Sheet2
            .Unprotect
            r2 = .Range(&quot;B65536&quot;).End(xlUp).Row
            If r2 &gt; 5 Then
                With .Range(&quot;A6:J&quot; &amp; r2)
                    .ClearContents
                    .Borders.LineStyle = xlNone
                End With
            End If
            Sheet1.Range(&quot;A6:J&quot; &amp; r).SpecialCells(12).Copy
            .Cells(6, 1).PasteSpecial Paste:=xlPasteValues
            Application.CutCopyMode = False
            With .Range(&quot;A6:A&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row)
                .FormulaR1C1 = &quot;=ROW()-5&quot;
                .Value = .Value
            End With
                .Range(&quot;A6:J&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row).Borders.LineStyle = xlContinuous
            Unload Me
            Application.Goto Reference:=.Range(&quot;A3&quot;), Scroll:=True
            .Protect
        End With
        .Range(&quot;A1:J&quot; &amp; r).AutoFilter
        .Protect
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
“筛选”按钮的单击过程，将根据窗体组合框中所选中的年龄进行筛选后的数据复制到工作表中。
第5行到第8行代码，年龄不能为空。
第9行到第14行代码，开始年龄不能小于结束年龄。
第19行代码，使用AutoFilter方法进行筛选。将第一个筛选条件设置为开始年龄，第二个筛选条件设置为结束年龄。
第23行到第28行代码，删除工作表中原有的数据，去除边框线。
第29行到第35行代码，将筛选后的数据复制到工作表中。
第36行代码，将筛选后的数据画上边框线。
步骤6，为了方便使用，在工作表中单击菜单“视图”→“工具栏”→“窗体”，添加两个框架，在每个框架中添加两个单选框，将模块中的宏指定给单选框，如图 196 6所示。

图 196 6    添加窗体控件
步骤7，为了保存筛选后的数据，将工作簿的Sheet2表重命名为“筛选数据”，并设置成如图 196 7所示的格式。

图 196 7    保存筛选数据
步骤8，选择“花名册”表的B、F和G列第6行以下区域，去除其锁定属性后保护工作表，对“筛选数据”表进行保护。在工作表中单击菜单“工具”→“选项”，在显示的选项对话框的视图页中去除工作表的行号列标及网格线后保存关闭工作簿。
打开工作簿，在“花名册”表中输入职工姓名、身份证号及职称后“花名册”表如图 196 8所示。

图 196 8    职工花名册
对表中数据进行筛选，比如按部门中的“生技科”进行筛选后“筛选数据”表中如图 196 9所示。

图 196 9    筛选后的数据</code></pre>
<h3 id="技巧197-收据系统"><a href="#技巧197-收据系统" class="headerlink" title="技巧197     收据系统"></a>技巧197     收据系统</h3><p>开具收据是财务工作中的一项经常性的工作，如果需要开具大量收据，采用手工方法开具收据时不仅繁琐而且极易出错，此时除了使用专业软件，还可以使用VBA制作的收据填写、打印系统，简化日常工作，减轻劳动强度。<br>步骤1，新建工作簿，将Sheet2工作表名称重命名为“维护”，设置成如图 197 1所示的格式，用来保存收据系统使用过程中必需的信息。</p>
<p>图 197 1    维护表<br>步骤2，因为收据系统是财务方面的系统，在使用时需要相应的权限，需要使用密码登陆，所以需要一个系统登陆窗体。<br>在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加三个标签控件、一个文本框控件、一个组合框和两个按钮按件，在窗体的属性窗口将其Picture属性设置为合适的图片并调整好控件的大小与位置，如图 197 2所示。</p>
<p>图 197 2    系统登陆窗体<br>双击登陆窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal hwnd As Long) As Long
Private Const GWL_STYLE = (-16)
Private Const WS_SYSMENU = &amp;H80000
Private hwnd As Long
Private Sub UserForm_Initialize()
    Dim Istype As Long
    Dim r As Integer
    Dim i As Integer
    hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    Istype = GetWindowLong(hwnd, GWL_STYLE)
    Istype = Istype And Not WS_SYSMENU
    SetWindowLong hwnd, GWL_STYLE, Istype
    DrawMenuBar hwnd
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    For i = 2 To r
        Me.ComboBox1.AddItem Sheet2.Cells(i, 1).Value
    Next
    Me.Label3.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
End Sub
代码解析：
登陆窗体的Initialize事件过程，窗体显示时使用API函数去除窗体的关闭按钮，组合框控件显示所有的用户名。
第1行到第7行代码，API函数声明。
第12行到第16行代码，去除窗体的关闭按钮。请参阅技巧138 。
第18行到第20行代码，组合框控件显示所有的用户名供用户选择。
第21行代码，窗体标签显示使用单位的名称。</code></pre>
<p>双击窗体上的“登陆”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim rng As Range
    If ComboBox1.Value = &quot;&quot; Then
        MsgBox &quot;请选择用户!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet2
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        With .Range(&quot;A2:A&quot; &amp; r)
            Set rng = .Find(What:=ComboBox1, _
                After:=.Cells(.Cells.Count), _
                LookIn:=xlValues, _
                LookAt:=xlWhole, _
                SearchOrder:=xlByRows, _
                SearchDirection:=xlNext, _
                MatchCase:=False)
            If Not rng Is Nothing And rng.Offset(0, 1) = TextBox1 Then
                Sheet2.Range(&quot;C2:C&quot; &amp; r).ClearContents
                rng.Offset(0, 2) = &quot;√&quot;
                Unload Me
                主界面.Show
            Else
                MsgBox &quot;对不起,密码不正确,你无权进入!&quot;, 64, &quot;提示&quot;
                TextBox1 = &quot;&quot;
                TextBox1.SetFocus
            End If
        End With
    End With
End Sub
代码解析：
“登陆”按钮的单击事件过程，在用户选择用户名和输入正确密码后显示“主界面”操作窗体。
第4行到第7行代码，判断是否选择了用户名。第一次使用时默认的用户为“系统管理员”，登陆后可以自行添加其他用户。
第10行到第17行代码，根据所选择的用户在“维护”工作表的A列中查找对应的用户名所在的单元格。
第18行到第27行代码，找到后判断该用户名的密码是否与文本框中输入的密码一致。如果一致则关闭登陆窗体显示“主界面”操作窗体，否则提示用户密码错误。
双击窗体上的“取消”按钮，写入下面的代码：

​```vb
Private Sub CommandButton2_Click()
    Unload Me
    ThisWorkbook.Saved = True
    Application.Quit
End Sub
代码解析：
“取消”按钮的单击事件过程，在用户选择取消后退出程序。
双击窗体上的组合框控件，写入下面的代码：
Private Sub ComboBox1_Change()
    TextBox1.SetFocus
End Sub
代码解析：
组合框控件的Change事件过程，在用户选择用户名后将焦点移到文本框中方便用户输入密码。
步骤3，将Sheet3工作表名称重命名为“存档”，设置成如图 197 3所示的格式，用来保存已填写收据的数据。

图 197 3    存档表
步骤4，“存档”表只是用来保存已开具收据的数据，而收据系统的日常操作都在“主界面”窗体中进行，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个多页（MultiPage）控件和一个状态栏（StatusBar）控件。在MultiPage控件的Page1页上添加一个Image控件和三个标签控件，在第一个标签的属性窗口中将其BackStyle属性设置为0，使标签背景为透明，在其他两个标签的Caption属性中写上版本信息及作者和邮箱，在Image控件的属性窗口将其Picture属性设置为合适的图片并调整好控件的大小与位置，如图 197 4所示。

图 197 4    主界面窗体</code></pre>
<p>双击“主界面”窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function SetMenu Lib &quot;user32&quot; (ByVal hwnd As Long, ByVal hMenu As Long) As Long
Private Declare Function CreateMenu Lib &quot;user32&quot; () As Long
Private Declare Function AppendMenu Lib &quot;user32&quot; Alias &quot;AppendMenuA&quot; (ByVal hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem As Long, ByVal lpNewItem As Any) As Long
Private Declare Function DestroyMenu Lib &quot;user32&quot; (ByVal hMenu As Long) As Long
Private Declare Function CreatePopupMenu Lib &quot;user32&quot; () As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Const GWL_WNDPROC = (-4)
Private Const MF_STRING = &amp;H0&amp;
Private Const MF_POPUP = &amp;H10&amp;
Private Const MF_SEPARATOR = &amp;H800&amp;
Dim MenuWnd As Long, Dump As Long, PopupMenuID As Long, PopupMenuWnd As Long, MenuID As Long
Private Sub UserForm_Initialize()
    Dim i As Integer
    Dim str As String
    Dim arr As Variant
    If Val(Application.Version) &lt; 9 Then
        hwnd = FindWindow(&quot;ThunderXFrame&quot;, Me.Caption)
    Else
        hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    End If
    MenuWnd = CreateMenu()
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;系统(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 100, &quot;单位设置(&amp;C)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 101, &quot;用户设置(&amp;U)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 102, &quot;切换用户(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 103, &quot;密码修改(&amp;P)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 104, &quot;打开Excel(&amp;O)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 105, &quot;退出系统(&amp;Q)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;编辑(&amp;E)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 110, &quot;收款人(&amp;R)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 111, &quot;交款人(&amp;P)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 112, &quot;交款单位(&amp;U)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 113, &quot;常用事由(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 114, &quot;常用备注(&amp;R)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;操作(&amp;O)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 120, &quot;增加(&amp;I)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 121, &quot;查询(&amp;Q)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;帮助(&amp;H)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 130, &quot;帮助(&amp;H)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 131, &quot;关于(&amp;R)&quot;)
    Dump = SetMenu(hwnd, MenuWnd)
    PreWinProc = GetWindowLong(hwnd, GWL_WNDPROC)
    SetWindowLong hwnd, GWL_WNDPROC, AddressOf MsgProcess
    Me.MultiPage1.Value = 0
    For i = 2 To Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
        If Sheet2.Cells(i, 3) = &quot;√&quot; Then
            str = Sheet2.Cells(i, 1)
        End If
    Next
    arr = Array(168, 100, 100, 80)
    With Me.StatusBar1
        For i = 1 To 4
            .Panels.Add(i, , &quot;&quot;).Style = 0
            .Panels(i).Width = arr(i - 1)
        Next
        .Panels(1).Text = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
        .Panels(2).Text = &quot;当前用户：&quot; &amp; str
        .Panels(3).Text = &quot;今天是&quot; &amp; Format(Date, &quot;yyyy年m月d日&quot;)
        .Panels(4).Text = Time
    End With
    Me.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    Me.Label12.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
End Sub
Private Sub UserForm_Terminate()
    DestroyMenu MenuWnd
    DestroyMenu PopupMenuID
    DestroyMenu PopupMenuWnd
    SetWindowLong hwnd, GWL_WNDPROC, PreWinProc
End Sub
代码解析：
“主界面”窗体的Initialize事件过程，窗体显示时使用API函数添加菜单及状态栏信息。
第1行到第13行代码，API函数声明。
第18行到第49行代码，使用API函数添加菜单。请参阅技巧148 。
第50行代码，“主界面”窗体显示时选择MultiPage控件的第一页。
第51行到第55行代码，将当前用户名赋给字符串变量str。
第56行到第66行代码，在状态栏控件中添加四个窗格及显示的信息。请参阅技巧152 。
第67、67行代码，设置“主界面”窗体的标题栏及标签显示的内容。</code></pre>
<p>步骤5，为了使用“主界面”窗体中添加的菜单，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Public PreWinProc As Long, hwnd As Long
Public Declare Function CheckMenuRadioItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal un1 As Long, ByVal un2 As Long, ByVal un3 As Long, ByVal un4 As Long) As Long
Public Declare Function CheckMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDCheckItem As Long, ByVal wCheck As Long) As Long
Public Declare Function EnableMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDEnableItem As Long, ByVal wEnable As Long) As Long
Public Const MF_UNCHECKED = &amp;H0&amp;
Public Const MF_CHECKED = &amp;H8&amp;
Public Const MF_DISABLED = &amp;H2&amp;
Public Const MF_GRAYED = &amp;H1&amp;
Public Const MF_ENABLED = &amp;H0&amp;
Private Declare Function CallWindowProc Lib &quot;user32&quot; Alias &quot;CallWindowProcA&quot; (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetMenu Lib &quot;user32&quot; (ByVal hwnd As Long) As Long
Private Declare Function GetSubMenu Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal nPos As Long) As Long
Private Const MF_BYCOMMAND = &amp;H0&amp;
Public Function MsgProcess(ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
    Dim SubMenu_hWnd As Long
    Select Case wParam
        Case 100
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                设置使用单位.Show
            End If
        Case 101
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                用户设置.Show
            End If
        Case 102
            Unload 主界面
            登陆.Show
        Case 103
            修改密码.Show
        Case 104
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                Unload 主界面
                Application.Visible = True
            End If
        Case 105
            If MsgBox(&quot;确定要退出收据系统吗?&quot;, 64 + vbYesNo, &quot;提示&quot;) = vbYes Then
                Unload 主界面
                ThisWorkbook.Save
                Application.Quit
            End If
        Case 110
            主界面.MultiPage1.Value = 0
            编辑收款人.Show
        Case 111
            主界面.MultiPage1.Value = 0
            编辑交款人.Show
        Case 112
            主界面.MultiPage1.Value = 0
            设置交款单位.Show
        Case 113
            主界面.MultiPage1.Value = 0
            编辑常用事由.Show
        Case 114
            主界面.MultiPage1.Value = 0
            编辑常用备注.Show
        Case 120
            主界面.MultiPage1.Value = 1
        Case 121
            主界面.MultiPage1.Value = 2
        Case 130
            帮助.Show
        Case 131
            关于.Show
        Case Else
            MsgProcess = CallWindowProc(PreWinProc, hwnd, Msg, wParam, lParam)
    End Select
End Function
代码解析：
根据“主界面”窗体中添加菜单的ID设置其各项功能。
第1行到第13行代码，API函数声明。
第17行到第22行代码，“系统”菜单中的“单位设置”菜单功能，显示“设置使用单位”窗体设置收据系统的使用单位名称。其中第18、19行代码判断当前用户是否是系统管理员，只有系统管理员才能设置收据系统的使用单位名称。设置单位名称需使用“设置使用单位”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及两个按钮按件，在框架控件中添加一个文本框控件，如图 197 5所示。

图 197 5    设置使用单位窗体</code></pre>
<p>双击窗体中的“确定”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    If Sheet2.Cells(2, 4) &lt;&gt; &quot;&quot; Then
        If MsgBox(&quot;是否重新设置单位名称？&quot;, 36, &quot;提示&quot;) = vbNo Then
            Unload Me
            Exit Sub
        End If
    End If
    If Trim(Me.Frame1.TextBox1.Value) = &quot;&quot; Then
        MsgBox &quot;单位名称不能为空!&quot;, 64, &quot;提示&quot;
        Me.Frame1.TextBox1.SetFocus
        Exit Sub
    End If
    Sheet2.Cells(2, 4) = Trim(Me.Frame1.TextBox1.Value)
    主界面.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    主界面.Label12.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    主界面.StatusBar1.Panels(1).Text = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    Unload Me
End Sub
重新设置收据系统的使用单位名称并更新“主界面”窗体的标题、标签及状态栏中显示的信息。
第23行到第28行代码，“系统”菜单中的“用户设置”菜单功能，显示“用户设置”窗体设置收据系统的用户名称。其中第24、25行代码判断当前用户是否是系统管理员，只有系统管理员才能设置收据系统的用户。设置用户需使用“用户设置”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加两个框架控件和三个按钮按件，在两个框架控件中分别添加一个列表框控件和一个文本框控件，如图 197 6所示。

图 197 6    用户设置窗体</code></pre>
<p>双击“用户设置”窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim r As Integer
    Dim i As Integer
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    For i = 3 To r
        Me.Frame1.ListBox1.AddItem Sheet2.Cells(i, 1).Value
    Next
    Me.Frame2.TextBox1.SetFocus
End Sub
Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim rng As Range
    If Me.Frame1.ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需删除的用户姓名!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    With Sheet2.Range(&quot;A3:F&quot; &amp; r)
        Set rng = .Find(What:=Me.Frame1.ListBox1.Value, _
            After:=.Cells(.Cells.Count), _
            LookIn:=xlValues, _
            LookAt:=xlWhole, _
            SearchOrder:=xlByRows, _
            SearchDirection:=xlNext, _
            MatchCase:=False)
        If Not rng Is Nothing Then
            rng.Offset(0, 1).Delete Shift:=xlUp
            rng.Delete Shift:=xlUp
            Me.Frame1.ListBox1.RemoveItem (ListBox1.ListIndex)
            MsgBox &quot;已经成功删除!&quot;, 64, &quot;提示&quot;
        End If
    End With
End Sub
Private Sub CommandButton2_Click()
    Dim r As Integer
    With Me.Frame2.TextBox1
        r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
        If Trim(.Value) = &quot;&quot; Then
            MsgBox &quot;用户姓名不能为空!&quot;, 64, &quot;提示&quot;
            .SetFocus
            Exit Sub
        End If
        If WorksheetFunction.CountIf(Sheet2.Range(&quot;A3:A&quot; &amp; r), Trim(.Text)) &gt; 0 Then
            MsgBox &quot;用户已经存在!&quot;, 64, &quot;提示&quot;
            .Value = &quot;&quot;
            Exit Sub
        End If
        Sheet2.Range(&quot;A&quot; &amp; r + 1) = Trim(.Text)
        Me.Frame1.ListBox1.AddItem Trim(.Text)
        .Value = &quot;&quot;
        .SetFocus
    End With
    MsgBox &quot;用户成功增加!&quot;, 64, &quot;提示&quot;
End Sub
Private Sub CommandButton3_Click()
    Unload Me
End Sub
“用户设置”窗体显示时列表框控件显示系统中已有用户的名称，因为系统管理员是不能删除的，所以并不显示。单击“删除”按钮可以删除列表框中选中的用户。单击“增加”按钮可以新增用户，新增用户的初始密码为空，登陆系统后可以重新设置密码。
第29行到第31行代码，“系统”菜单中的“切换用户”菜单功能，关闭主界面窗体，显示系统登陆窗体。
第32、33行代码，“系统”菜单中的“密码修改”菜单功能，显示“密码修改”窗体重新设置当前用户的密码，设置用户密码需使用“密码修改”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架和两个按钮按件，在框架控件中添加三个标签控件及三个文本框控件，如图 197 7所示。

图 197 7    密码修改窗体</code></pre>
<p>双击“密码修改”窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    Dim p As Integer
    Dim Password As String
    With Sheet2
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        For i = 2 To r
            If .Cells(i, 3) = &quot;√&quot; Then
                Password = .Cells(i, 2).Text
                p = i
                Exit For
            End If
        Next
        If Me.TextBox1.Text &lt;&gt; Password Then
            MsgBox &quot;对不起,密码不正确,你无权修改!&quot;, 64, &quot;提示&quot;
            Me.TextBox1 = &quot;&quot;
            Me.TextBox1.SetFocus
            Exit Sub
        End If
        If Me.TextBox2.Text &lt;&gt; Me.TextBox3.Text Then
            MsgBox &quot;确认密码不一致,请重新输入!&quot;, 64, &quot;提示&quot;
            Me.TextBox3 = &quot;&quot;
            Me.TextBox3.SetFocus
            Exit Sub
        End If
        .Cells(p, 2) = Me.TextBox3.Text
    End With
    Unload Me
End Sub
使用“密码修改”窗体可以重新设置当前用户的密码。第15行到第20行代码判断所输入的旧密码是否正确，第21行到第26行代码判断两次输入的新密码是否一致，第27行代码，将新密码写入到工作表中。
第34行到第40行代码，“系统”菜单中的“打开Excel”菜单功能，收据系统日常使用时只能在“主界面窗体”中操作，只有系统管理员才能打开工作表对其进行维护。
第41行到第46行代码，“系统”菜单中的“退出系统”菜单功能，关闭Excel程序。
第47行第61行代码，“编辑”菜单的各项功能，对使用收据系统所需的一些信息进行添加和删除。其中第47、48行代码显示“编辑收款人”窗体对常用收款人进行编辑，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加两个框架控件和三个按钮按件，在框架控件中分别添加一个列表框控件和一个文本框控件，如图 197 8所示。

图 197 8    编辑收款人窗体
其他窗体与“编辑收款人”窗体类似，窗体中的代码请参考“用户设置”窗体中的代码。
第62、63行代码，“操作”菜单中的“增加”菜单功能，选择主界面窗体中多页控件的Page2页，可以填写、打印收据。
第64、65行代码，“操作”菜单中的“查询”菜单功能，选择主界面窗体中多页控件的Page3页，可以对已填写收据进行查询、打印。
第66、67行代码，“帮助”菜单中的“关于”菜单功能，显示“关于”窗体。
第68、69行代码，“帮助”菜单中的“帮助”菜单功能，显示“帮助”窗体。
步骤6，在VBE窗口中选择“主界面”窗体的Page2页，在Page2页中添加一个框架控件和四个按钮控件，框架控件中添加六个文本框控件、四个组合框控件、一个DTP控件及相应的标签，如图 197 9所示。

图 197 9    Page2页中的控件</code></pre>
<p>双击窗体上的“新增”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    Dim Number As String
    With Sheet2
        If .Range(&quot;D2&quot;) = &quot;&quot; Then
            MsgBox &quot;请先设置使用单位!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        MultiPage1.Page2.TextBox2 = .Range(&quot;D2&quot;)
        If .Cells(2, 3) = &quot;√&quot; Then
            MsgBox &quot;请以用户身份登陆!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        For i = 3 To r
            If .Cells(i, 3) = &quot;√&quot; Then
                MultiPage1.Page2.TextBox5 = .Cells(i, 1)
            End If
        Next
    End With
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        If .Range(&quot;A2&quot;) = &quot;&quot; Then
            Number = Year(DTPicker1.Value) &amp; Format(1, &quot;0000&quot;)
        End If
        If Val(Year(DTPicker1.Value)) &gt; Val(Left(.Range(&quot;A&quot; &amp; r).Value, 4)) Then
            Number = Year(DTPicker1.Value) &amp; Format(1, &quot;0000&quot;)
        Else
            Number = Format(.Range(&quot;A&quot; &amp; r).Value + 1, &quot;00000000&quot;)
        End If
    End With
    With MultiPage1.Page2
        .ComboBox1.Value = &quot;&quot;
        .ComboBox2.Value = &quot;&quot;
        .ComboBox3.Value = &quot;&quot;
        .ComboBox4.Value = &quot;&quot;
        .TextBox1.Value = Number
        .TextBox3.Value = &quot;&quot;
        .TextBox4.Value = &quot;&quot;
        .TextBox6.Value = &quot;&quot;
    End With
End Sub
代码解析：
“新增”按钮的单击过程，将收据号码、使用单位及用户名称显示在文本框中。
第6行到第9行代码，判断收据系统是否已设置使用单位。
第10行代码，将工作表中已设置好的单位名称显示在“收款单位名称”文本框中。
第11行到第14行代码，判断当前用户是否是系统管理员，系统管理员不能进行新增收据的操作。
第15行到第20行代码，将当前用户名显示在“签发人”文本框中。
第23行到第26行代码，判断收据系统是否第一次使用。如果是第一次使用，新增收据号码为当前年份加0001。
第27、28行代码，判断收据系统是否是跨年度使用。如果是跨年度使用，新增收据号码为当前年份加0001。
第30行代码，如果收据系统是本年度中正常使用且已开具过收据，新增收据号码为最后所开具的收据号码加一。
第33行到第42行代码，将收据号码显示在“收据号码”文本框中并清除其他内容。
填写完毕的收据需保存到工作表中，将Sheet3工作表重命名为“存档”表并设置成如图 197 10所示的格式用来保存已开具收据的内容。

图 197 10    “存档”表</code></pre>
<p>双击窗体上的“保存”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim r As Integer
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    If MultiPage1.Page2.TextBox1 = &quot;&quot; Then
        MsgBox &quot;没有可保存的收据,请选择新增按钮!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If WorksheetFunction.CountIf(Sheet3.Range(&quot;A2:A&quot; &amp; r), Trim(MultiPage1.Page2.TextBox1.Text)) &gt; 0 Then
        MsgBox &quot;收据已经保存!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If If Sheet3.Range(&quot;A2&quot;) &lt;&gt; &quot;&quot; And MultiPage1.Page2.DTPicker1.Value &lt; Sheet3.Cells(r, 2) Then
        MsgBox &quot;日期错误，请重新选择日期!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox4.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款事由!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox4.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox1.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款单位!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox1.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox2.Value = &quot;&quot; Then
        MsgBox &quot;请填写收款人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox2.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox3.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox3.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.TextBox4.Value = &quot;&quot; Then
        MsgBox &quot;请填写收款金额!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.TextBox4.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.TextBox6.Value = &quot;&quot; Then
        MsgBox &quot;请填写备注!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.TextBox6.SetFocus
        Exit Sub
    End If
    With Sheet3
        .Cells(r + 1, 1) = MultiPage1.Page2.TextBox1.Value
        .Cells(r + 1, 2) = MultiPage1.Page2.DTPicker1.Value
        .Cells(r + 1, 3) = MultiPage1.Page2.ComboBox4.Value
        .Cells(r + 1, 4) = MultiPage1.Page2.ComboBox1.Value
        .Cells(r + 1, 5) = MultiPage1.Page2.ComboBox3.Value
        .Cells(r + 1, 6) = MultiPage1.Page2.TextBox2.Value
        .Cells(r + 1, 7) = MultiPage1.Page2.ComboBox2.Value
        .Cells(r + 1, 8) = MultiPage1.Page2.TextBox3.Value
        .Cells(r + 1, 9) = MultiPage1.Page2.TextBox4.Value
        .Cells(r + 1, 10) = MultiPage1.Page2.TextBox6.Value
        .Cells(r + 1, 11) = MultiPage1.Page2.TextBox2.Value
        .Cells(r + 1, 12) = MultiPage1.Page2.TextBox5.Value
    End With
    Sheet4.Range(&quot;K1&quot;) = MultiPage1.Page2.TextBox1.Value
    MsgBox &quot;收据已保存，请打印!&quot;, 64, &quot;提示&quot;
End Sub
代码解析：
“保存”按钮的单击过程，将填写完整的收据内容保存到“存档”表中。
第4行到第7行代码，判断是否已选择“新增”按钮。因为“收据号码”文本框中的号码是不能通过手工输入的，只能选择“新增”按钮由系统输入。
第8行到第11行代码，判断收据号码与“存档”表中保存的收据号码是否重复，使同一收据不能重复保存。
第12行到第15行代码，判断收据日期是否大于等于“存档”表中保存的最后一张收据的日期，使收据只能按日期顺序开具。
第16行到第45行代码，判断收据内容是否填写完整。
第46行到第59行代码，将收据内容保存到“存档”表的最后一行。
第60行代码，将所开收据的号码写入到“打印”表的K1单元格。
收据保存后需要打印，将Sheet4工作表重命名为“打印”表。因为笔者所在单位不使用针式打印机，不能进行套打，所以只能将“打印”表设置成如图 197 11所示的格式，使用激光打印机打印。如果需要进行套打，只需按所要打印收据的页面重新进行设置即可。

图 197 11    打印表
“打印”表中的单元格写入VLOOKUP函数，根据K1单元格中的号码在“存档”表中查找相应的数据显示在各单元格中。</code></pre>
<p>双击窗体上的“打印”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim rng As Range
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        If MultiPage1.Page2.TextBox1.Value = &quot;&quot; Then
            MsgBox &quot;没有可打印的收据!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        If WorksheetFunction.CountIf(.Range(&quot;A2:A&quot; &amp; r), Trim(MultiPage1.Page2.TextBox1.Text)) = 0 Then
            MsgBox &quot;请保存后再打印!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        With .Range(&quot;A2:A&quot; &amp; r)
            Set rng = .Find(What:=MultiPage1.Page2.TextBox1.Value, _
                After:=.Cells(.Cells.Count), _
                LookIn:=xlValues, _
                LookAt:=xlWhole, _
                SearchOrder:=xlByRows, _
                SearchDirection:=xlNext, _
                MatchCase:=False)
            If Not rng Is Nothing Then
                If rng.Offset(0, 12).Text = &quot;√&quot; Then
                    MsgBox &quot;已经打印的收据不可再打印!&quot;, 64, &quot;提示&quot;
                    Exit Sub
                End If
            End If
        End With
        .Range(&quot;M&quot; &amp; r).Value = &quot;√&quot;
    End With
    Sheet4.Range(&quot;K1&quot;) = MultiPage1.Page2.TextBox1.Value
    Sheet4.PrintOut
End Sub
代码解析：
“打印”按钮的单击过程，打印收据。
第6行到第9行代码，判断是否有需要打印的收据。
第10行到第13行代码，判断当前收据是否已经保存。
第14行到第28行代码，判断当前收据是否已经打印。已经打印过的收据在“存档”表的M列中会写上已打印标识“√”。
第29行代码，在“存档”表的该收据内容所在的M列中写上已打印标识“√”。
第31、32行代码，将收据号码写入到“打印”表的K1单元格，打印该收据。</code></pre>
<p>双击窗体上的“取消”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton4_Click()
    With MultiPage1.Page2
        .ComboBox1.Value = &quot;&quot;
        .ComboBox2.Value = &quot;&quot;
        .ComboBox3.Value = &quot;&quot;
        .ComboBox4.Value = &quot;&quot;
        .TextBox1.Value = &quot;&quot;
        .TextBox3.Value = &quot;&quot;
        .TextBox4.Value = &quot;&quot;
        .TextBox6.Value = &quot;&quot;
    End With
    主界面.MultiPage1.Value = 0
End Sub
代码解析：
“取消”按钮的单击过程，清除数据并返回主界面的Page1页面。
为了方便收据的填写，在开具收据时，日期由DTP控件选择，事由、单位名称、收款人及交款人可以手工输入，也可以从窗体中的组合框中选择已有的信息。</code></pre>
<p>双击MultiPage1控件写入下面的代码：</p>
<pre><code class="vb">Private Sub MultiPage1_Change()
    Dim i As Integer
    Dim c As Integer
    Select Case MultiPage1.Value
        Case 1
            For c = 1 To 4
                MultiPage1.Page2.Controls(&quot;ComboBox&quot; &amp; c).Clear
                For i = 2 To Sheet2.Cells(65536, c + 4).End(xlUp).Row
                    MultiPage1.Page2.Controls(&quot;ComboBox&quot; &amp; c).AddItem Sheet2.Cells(i, c + 4).Value
                Next
            Next
            MultiPage1.Page2.DTPicker1 = Date
        Case 2
            With MultiPage1.Page3.ListView1
                .ListItems.Clear
                .ColumnHeaders.Add , , Space(3) &amp; &quot;号码&quot;, 54, 0
                .ColumnHeaders.Add , , Space(3) &amp; &quot;日期&quot;, 54, 0
                .ColumnHeaders.Add , , Space(12) &amp; &quot;事由&quot;, 130, 0
                .ColumnHeaders.Add , , Space(6) &amp; &quot;交款单位&quot;, 100, 0
                .ColumnHeaders.Add , , &quot;交款人&quot;, 40, 0
                .ColumnHeaders.Add , , Space(6) &amp; &quot;收款单位&quot;, 90, 0
                .ColumnHeaders.Add , , &quot;收款人&quot;, 40, 0
                .ColumnHeaders.Add , , Space(10) &amp; &quot;金额大写&quot;, 130, 0
                .ColumnHeaders.Add , , &quot;金额小写&quot;, 50, 1
                .ColumnHeaders.Add , , Space(14) &amp; &quot;备注&quot;, 150, 0
                .ColumnHeaders.Add , , Space(5) &amp; &quot;填发单位&quot;, 84, 0
                .ColumnHeaders.Add , , &quot;签发人&quot;, 40, 0
                .View = lvwReport
                .Gridlines = True
                .FullRowSelect = True
            End With
    End Select
End Sub
代码解析：
MultiPage控件的Change事件过程。
第6行到第12行代码，当选择MultiPage控件的Page2页面新增收据时，将“维护”表中所保存的信息加载到组合框中，并将DTP控件的日期设置为当前日期。
第13行到第31行代码，当选择MultiPage控件的Page3页面查询收据时，为Page3页中的ListView控件添加列标题。请参阅技巧131 。
为了将输入的小写金额转换为人民币大写金额，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：
Public Function RMBDX(M)
    On Error Resume Next
    RMBDX = Replace(Application.Text(Round(M + 0.00000001, 2), &quot;[DBnum2]&quot;), &quot;.&quot;, &quot;元&quot;)
    RMBDX = IIf(Left(Right(RMBDX, 3), 1) = &quot;元&quot;, Left(RMBDX, Len(RMBDX) - 1) &amp; &quot;角&quot; &amp; Right(RMBDX, 1) &amp; &quot;分&quot;, IIf(Left(Right(RMBDX, 2), 1) = &quot;元&quot;, RMBDX &amp; &quot;角整&quot;, IIf(RMBDX = &quot;零&quot;, &quot;&quot;, RMBDX &amp; &quot;元整&quot;)))
    RMBDX = Replace(Replace(Replace(Replace(RMBDX, &quot;零元零角&quot;, &quot;&quot;), &quot;零元&quot;, &quot;&quot;), &quot;零角&quot;, &quot;零&quot;), &quot;-&quot;, &quot;负&quot;)
End Function
代码解析：
自定义RMBDX函数，将小写金额转换为人民币大写金额，请参阅技巧163 。</code></pre>
<p>双击小写金额文本框，写入下面的代码：</p>
<pre><code class="vb">Private Sub TextBox4_Change()
    If Not IsNumeric(TextBox4.Text) And TextBox4.Text &lt;&gt; &quot;&quot; Then
        MsgBox &quot;请输入正确的小写金额!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    MultiPage1.Page2.TextBox3 = RMBDX(MultiPage1.Page2.TextBox4.Value)
End Sub
Private Sub TextBox4_AfterUpdate()
    Me.TextBox4.Value = Format(TextBox4.Value, &quot;0.00&quot;)
End Sub
代码解析：
第1行到第6行代码，文本框的Change事件过程，将小写文本框中输入的正确的小写金额转换为人民币大写金额写入到大写文本框中。
第8行到第10行代码，文本框的AfterUpdate事件过程，将小写金额格式化为两位小数格式。
备注可以手工输入，也可以从窗体中选择已有的信息。在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个MultiPage控件和两个按钮按件，在MultiPage控件的Page1页中添加一个框架控件，在框架控件中添加六个文本框控件和六个标签控件，如图 197 12所示。

图 197 12输入常用备注窗体（一）
在MultiPage控件的Page2页中添加一个框架控件，在框架控件中添加两个文本框控件和两个标签控件，如图 197 13所示。

图 197 13输入常用备注窗体（二）
在MultiPage控件的Page3页中添加一个框架控件，在框架控件中添加一个列表框控件，如图 197 14所示。

图 197 14输入常用备注窗体（三）</code></pre>
<p>双击“输入常用备注”窗体，写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim r As Integer
    Dim i As Integer
    MultiPage1.Value = 0
    r = Sheet2.Range(&quot;I65536&quot;).End(xlUp).Row
    For i = 2 To r
        MultiPage1.Page3.ListBox1.AddItem Sheet2.Cells(i, 9).Value
    Next
End Sub
代码解析：
“输入常用备注”窗体的Initialize事件，窗体显示时MultiPage控件选择Page1页并将“维护”表中保存的常用备注信息加载到Page3页的列表框中。</code></pre>
<p>双击“输入常用备注”窗体的“确定”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim str As String
    Dim dou As Double
    Dim i As Integer
    With MultiPage1
        Select Case .Value
            Case 0
                For i = 1 To 6
                    str = str &amp; .Page1.Controls(&quot;Label&quot; &amp; i) &amp; Chr(9) &amp; .Page1.Controls(&quot;TextBox&quot; &amp; i) &amp; &quot;元&quot; &amp; Chr(9)
                    If i = 2 Or i = 4 Then
                        str = str &amp; Chr(10)
                    End If
                    dou = dou + Val(.Page1.Controls(&quot;TextBox&quot; &amp; i).Value)
                Next
            Case 1
                For i = 7 To 8
                    str = str &amp; .Page2.Controls(&quot;Label&quot; &amp; i) &amp; .Page2.Controls(&quot;TextBox&quot; &amp; i) &amp; &quot;元&quot; &amp; Chr(9)
                    dou = dou + Val(.Page2.Controls(&quot;TextBox&quot; &amp; i).Value)
                Next
            Case 2
                str = .Page3.ListBox1.Value
                dou = 0
        End Select
    End With
    With 主界面.MultiPage1.Page2
        .TextBox6 = str
        .TextBox4 = IIf(dou &lt;&gt; 0, Format(dou, &quot;0.00&quot;), .TextBox4)
    End With
    Unload Me
End Sub
代码解析：
“输入常用备注”窗体中“确定”按钮的单击过程，将常用备注及小写金额写入到主界面窗体的备注文本框及小写金额文本框中。</code></pre>
<p>双击“输入常用备注”窗体中Page3页的列表框，写入下面的代码：</p>
<pre><code class="vb">Private Sub ListBox1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    主界面.MultiPage1.Page2.TextBox6 = MultiPage1.Page3.ListBox1
    Unload Me
End Sub
代码解析：
“输入常用备注”窗体中列表框的双击过程，将选中的备注写入到主界面窗体的备注文本框中。</code></pre>
<p>双击“输入常用备注”窗体中的TextBox1文本框，写入下面的代码：</p>
<pre><code class="vb">Private Sub TextBox1_AfterUpdate()
    MultiPage1.Page1.TextBox1 = Format(MultiPage1.Page1.TextBox1, &quot;0.00&quot;)
End Sub
代码解析：
“输入常用备注”窗体中文本框的AfterUpdate事件过程，将金额格式化为两位小数格式。其他文本框设置与之相同。
步骤7，在VBE窗口中选择“主界面”窗体的Page3页，在Page3页中添加一个ListView控件和三个按钮控件，如图 197 15所示。

图 197 15    Page3页中的控件</code></pre>
<p>双击窗体中的“查询”按钮，写入下面的代码：</p>
<pre><code>Private Sub CommandButton6_Click()
    Dim Itm As ListItem
    Dim r As Integer
    Dim c As Integer
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    With MultiPage1.Page3.ListView1
        .ListItems.Clear
        For r = 2 To r
            Set Itm = .ListItems.Add()
            Itm.Text = Space(2) &amp; Sheet3.Cells(r, 1)
            For c = 1 To 11
                Itm.SubItems(c) = Sheet3.Cells(r, c + 1)
            Next
            Itm.SubItems(1) = Format(Itm.SubItems(1), &quot;yyyy-mm-dd&quot;)
            Itm.SubItems(8) = Format(Itm.SubItems(8), &quot;0.00&quot;)
        Next
    End With
    Set Itm = Nothing
End Sub
代码解析：
“查询”按钮的单击过程，将“存档”表中已开具收据的信息显示到ListView控件中，请参阅技巧131 。</code></pre><p>双击窗体中的“打印”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton5_Click()
    Dim r As Integer
    Dim rng As Range
    Dim str As String
    str = Val(MultiPage1.Page3.ListView1.SelectedItem)
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    With Sheet3.Range(&quot;A2:A&quot; &amp; r)
        Set rng = .Find(What:=str, _
            After:=.Cells(.Cells.Count), _
            LookIn:=xlValues, _
            LookAt:=xlWhole, _
            SearchOrder:=xlByRows, _
            SearchDirection:=xlNext, _
            MatchCase:=False)
        If Not rng Is Nothing Then
            If rng.Offset(0, 12).Text = &quot;√&quot; Then
                MsgBox &quot;已经打印的收据不可再打印!&quot;, 64, &quot;提示&quot;
            Else
                With Sheet4
                    .Range(&quot;K1&quot;) = str
                    .PrintOut
                End With
                Sheet3.Range(&quot;M&quot; &amp; rng.Row).Value = &quot;√&quot;
            End If
        End If
    End With
End Sub
代码解析：
“打印”按钮的单击过程，打印“存档”表中已开具保存还没有打印的收据。
第5行代码，将ListView控件中所选中的收据号码赋给变量str。
第7行到第14行代码，使用该号码在“存档”表中查找数据。
第16、17行代码，如果该号码所在行的M列已有打印标识则不能打印。
第20、21行代码，如果该号码没有打印则将号码写入到“打印”表的K1单元格并打印收据。
在日常使用时，已经打印过后收据是不能重复打印的，如果确实需要重新打印收据，可以使用系统管理员身份进入系统，在窗体菜单中打开Excel，删除该收据在“存档”表M列中的打印标识。</code></pre>
<p>步骤8，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件，在框架控件中添加一个标签控件，双击窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim str As String
    str = Space(4) &amp; &quot;欢迎使用&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;使用前请仔细阅读使用说明：&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;一、第一次使用本系统时请以系统管理员身份登陆。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;二、第一次使用本系统时请先设置使用单位和添加用户。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;三、常用信息可以自行增加及删除。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;四、开具的收据只能打印一次，未打印的收据可以在查询界面中补充打印。&quot; &amp; vbLf _
        &amp; vbLf _
        &amp; Space(4) &amp; &quot;使用过程中如有问题或好的建议请与我联系：&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;Tel：0513-86548930&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;Tel：13861958666&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;E-mail： yuanzhuping@yeah.net&quot;
    Label8.Caption = str
    Label8.Height = 150
    Label8.Top = 6
    Label8.Left = 6
    Frame1.ScrollBars = fmScrollBarsVertical
    Frame1.ScrollHeight = Label8.Height
End Sub
代码解析：
使用窗体显示系统帮助信息，请参阅技巧122 。窗体运行后效果如图 197 16所示。

图 197 16    帮助窗体</code></pre>
<p>在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个Image控件和一个框架控件，在框架控件中添加一个Image控件和一个标签控件，在Image控件的属性窗口将其Picture属性设置为合适的图片，双击窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim str As String
    str = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot; &amp; vbLf _
        &amp; &quot;版本： V2.0.00&quot; &amp; vbLf _
        &amp; &quot;版权： (C) 2009-2022&quot; &amp; vbLf _
        &amp; &quot;作者： yuanzhuping (2009-7-8)&quot; &amp; vbLf _
        &amp; &quot;邮箱： yuanzhuping@yeah.net &quot;
    Label1.Caption = str
End Sub
代码解析：
使用窗体显示系统信息，运行后效果如图 197 17所示。

图 197 17    关于窗体
步骤9，在“主界面”窗体的属性窗口中选择MultiPage控件，将其Style属性设置为2，使其不显示MultiPage控件的标签。</code></pre>
<p>步骤10，因为收据系统正常使用时只需在“主界面”窗体操作，所以需要隐藏工作簿。在VBE的“工程”窗口双击ThisWorkbook，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Application.Visible = False
    登陆.Show
End Sub
代码解析：
收据系统打开时隐藏工作簿，显示“登陆”窗体供用户登陆。
步骤11，使用收据系统，在打开时必需启用宏，所以将工作簿设置为禁用宏则关闭工作簿。请参阅技巧44 。
步骤12，设置VBA工程的密码。示例VBA工程密码为六个8。
保存工作簿后重新打开，显示如图 197 18所示的“登陆”窗体供用户登陆，第一次使用时默认用户为“系统管理员”，初始密码为六个8。

图 197 18    用户登陆
在密码输入框中输入正确的密码后按“登陆”按钮后显示如图 197 19所示的“主界面”操作窗体。

图 197 19    主界面
选择“系统”菜单，设置使用单位和用户后选择“操作”菜单中的“增加”菜单，进入如图 197 20所示的新增收据界面。

图 197 20    新增收据界面
选择“操作”菜单中的“查询”菜单，进入收据查询界面，按“查询”按钮后查询结果如图 197 21所示。

图 197 21    查询收据界面</code></pre>
<h3 id="技巧198-职工考勤系统"><a href="#技巧198-职工考勤系统" class="headerlink" title="技巧198     职工考勤系统"></a>技巧198     职工考勤系统</h3><p>笔者所在单位没有使用电子考勤，每到月底各部门需手工填写部门所有职工的考勤考核表及部门的考勤汇总表，工作量大、出错机率高、统计分析麻烦，因此使用VBA开发的考勤系统可以使部门考勤员简化工作，提高工作效率。<br>步骤1，新建工作簿，将Sheet1工作表名称重命名为“资料”，设置成如图 198 1所示的格式，用来保存考勤系统使用过程中必需的资料。<br>“资料”表中的B1单元格保存单位的名称，B2单元格保存考勤周期中开始考勤的日期，第三行以下用于保存考勤部门的资料，其中第四列往右的单元格保存部门职工的资料。</p>
<p>图 198 1    资料表格式<br>步骤2，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件和两个按钮按件，在框架控件添加两个标签控件、一个文本框控件及一个组合框控件，调整好控件的大小与位置，如图 198 2所示。</p>
<p>图 198 2    单位设置窗体<br>单位设置窗体用于设置使用单位及开始考勤的日期，双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim arr As Variant
    TextBox1.SetFocus
    arr = Array(&quot;26日-25日&quot;, &quot;27日-26日&quot;, &quot;28日-27日&quot;, &quot;1日-31日&quot;, &quot;2日-1日&quot;, &quot;3日-2日&quot;, &quot;4日-3日&quot;, &quot;5日-4日&quot;)
    With ComboBox1
        .List = arr
        .ListIndex = 0
    End With
End Sub
代码解析：
单位设置窗体的初始化事件，为组合框控件添加考勤周期。</code></pre>
<p>双击窗体中的“确定”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    If Trim(TextBox1) = &quot;&quot; Then
        MsgBox &quot;请输入单位名称!&quot;, 64, &quot;提示&quot;
        TextBox1.SetFocus
        Exit Sub
    End If
    With Sheet1
        .Cells(1, 2) = Trim(TextBox1.Text)
        .Cells(2, 2) = Val(ComboBox1.Text)
        Application.Caption = .Cells(1, 2)
    End With
    Unload Me
End Sub
代码解析：
单位设置窗体中“确定”按钮的单击事件，将输入的单位名称及考勤周期的开始日期录入到”资料”表中并更新工作簿标题。
步骤3，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个MultiPage（多页）控件，将MultiPage控件中的Page分别重命名为“增加”、“删除”和“编辑”。
在“增加”页中添加一个框架控件和两个按钮按件，在框架控件添加三个标签控件及三个文本框控件，调整好控件的大小与位置，如图 198 3所示。

图 198 3    部门增加页</code></pre>
<p>双击“增加”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    If Trim(MultiPage1.Page1.TextBox1.Text) = &quot;&quot; Then
        MsgBox &quot;请输入部门名称!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox1.SetFocus
        Exit Sub
    End If
    If Application.CountIf(Sheet1.Range(&quot;A:A&quot;), MultiPage1.Page1.TextBox1.Text) &gt; 0 Then
        MsgBox &quot;部门名称已经存在,请重新输入!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox1.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page1.TextBox2.Text) = &quot;&quot; Then
        MsgBox &quot;请输入部门负责人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox2.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page1.TextBox3.Text) = &quot;&quot; Then
        MsgBox &quot;请输入考勤员姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox3.SetFocus
        Exit Sub
    End If
    For i = 1 To 3
        Sheet1.Cells(r + 1, i) = MultiPage1.Page1.Controls(&quot;TextBox&quot; &amp; i)
    Next
    MsgBox &quot;部门已成功增加,请增加部门人员!&quot;, 64, &quot;提示&quot;
    Unload Me
End Sub
代码解析：
部门设置窗体中“增加”按钮的单击事件，将输入的部门名称、部门负责人及部门考勤员录入到”资料”表中。
第5行到第9行代码，判断是否已输入部门名称。
第10行到第14行代码，判断输入的部门名称是否重复。
第15行到第19行代码，判断是否已输入部门负责人姓名。
第20行到第24行代码，判断是否已输入部门考勤员姓名。
第25行到第27行代码，将所输入的部门信息录入中资料表的最后一行。
在“删除”页中添加一个框架控件和两个按钮按件，在框架控件添加一个列表框控件，调整好控件的大小与位置，如图 198 4所示。

图 198 4    部门删除页</code></pre>
<p>双击“删除”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim r As Integer
    Dim s As String
    Dim i As Integer
    r = Sheet1.Range(&quot;a65536&quot;).End(xlUp).Row
    If MultiPage1.Page2.ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需要删除的部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    s = MultiPage1.Page2.ListBox1.Text
    If MsgBox(&quot;确定要删除&quot; &amp; s &amp; &quot;吗?&quot;, 36, &quot;警告&quot;) = 6 Then
        For i = 4 To r
            If s = Sheet1.Cells(i, 1) Then
                Sheet1.Cells(i, 1).EntireRow.Delete
                MultiPage1.Page2.ListBox1.RemoveItem (ListBox1.ListIndex)
                MsgBox s &amp; &quot;已经成功删除!&quot;, 64, &quot;提示&quot;
            End If
        Next
    End If
    Unload Me
End Sub
代码解析：
部门设置窗体中“删除”按钮的单击事件，删除“资料”表中已保存的部门资料。
第6行到第9行代码，判断在列表框中是否已选择了要删除的部门。
第10行代码，将所要删除的部门名称赋给变量s。
第14行代码，将“资料”表中该部门所在的行删除。
第15行代码，将列表框中该部门所在的行删除。
在“编辑”页中添加一个框架控件和两个按钮按件，在框架控件添加四个标签控件、一个组合框控件及三个文本框控件，调整好控件的大小与位置，如图 198 5所示。

图 198 5    部门编辑页</code></pre>
<p>双击窗体中的组合框控件，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub ComboBox1_Change()
    Dim r As Integer
    Dim c As Integer
    For r = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If MultiPage1.Page3.ComboBox1 = Sheet1.Cells(r, 1) Then
            For c = 1 To 3
                MultiPage1.Page3.Controls(&quot;TextBox&quot; &amp; c + 3) = Sheet1.Cells(r, c)
            Next
        End If
    Next
End Sub
代码解析：
组合框控件的Change事件，当用户选择所需编辑的部门名称后，文本框中显示该部门编辑前的信息。</code></pre>
<p>双击“编辑”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim i As Integer
    Dim j As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    If MultiPage1.Page3.ComboBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需要编辑的部门名称!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox4.Text) = &quot;&quot; Then
        MsgBox &quot;部门名称不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox4.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox5.Text) = &quot;&quot; Then
        MsgBox &quot;部门负责人不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox5.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox6.Text) = &quot;&quot; Then
        MsgBox &quot;部门考勤员不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox6.SetFocus
        Exit Sub
    End If
    If MsgBox(&quot;是否重新编辑&quot; &amp; MultiPage1.Page3.ComboBox1 &amp; &quot;的信息?&quot;, 36, &quot;提示&quot;) = 6 Then
        For i = 4 To r
            If MultiPage1.Page3.ComboBox1 = Sheet1.Cells(i, 1) Then
                For j = 1 To 3
                    Sheet1.Cells(i, j) = MultiPage1.Page3.Controls(&quot;TextBox&quot; &amp; j + 3)
                Next
            End If
        Next
    End If
    Unload Me
End Sub
代码解析：
部门设置窗体中“编辑”按钮的单击事件，编辑“资料”表中已保存的部门信息。
第6行到第9行代码，判断是否已选择了部门。
第10行到第14行代码，判断部门名称是否为空。
第15行到第19行代码，判断部门负责人是否为空。
第20行到第24行代码，判断部门考勤员是否为空。
第26行到第32行代码，将重新编辑的部门信息录入中资料表该部门所在的行中。
步骤4，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及一个按钮控件，在框架控件中添加两个标签控件、两个按钮控件、一个组合框控件、一个文本框控件及一个列表框控件，如图 198 6所示。

图 198 6    人员设置窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim i As Integer
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        ComboBox1.AddItem Sheet1.Cells(i, 1)
    Next
    ComboBox1.ListIndex = -1
End Sub
代码解析：
人员设置窗体的初始化事件，为组合框控件添加部门名称。
双击窗体上的组合框控件，在打开的代码窗口写入下面的代码：
Private Sub ComboBox1_Change()
    Dim r As Integer
    Dim c As Integer
    For r = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If ComboBox1.Text = Sheet1.Cells(r, 1) Then
            ListBox1.Clear
            For c = 4 To Sheet1.Cells(r, 255).End(xlToLeft).Column
                ListBox1.AddItem Sheet1.Cells(r, c).Value
            Next
        End If
    Next
    TextBox1.SetFocus
End Sub
代码解析：
组合框控件的Change事件，当用户选择所需增加或删除人员的部门名称后，文本框中显示该部门中已有的人员姓名。</code></pre>
<p>双击窗体上的“增加”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim c As Integer
    If ComboBox1.Text = &quot;&quot; Then
        MsgBox &quot;请选择增加人员的部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If Trim(TextBox1.Text) = &quot;&quot; Then
        MsgBox &quot;请输入人员姓名!&quot;, 64, &quot;提示&quot;
        TextBox1.SetFocus
        Exit Sub
    End If
    With Sheet1
        For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = .Cells(i, 1) Then
                c = .Cells(i, 255).End(xlToLeft).Column
                If Application.CountIf(.Range(.Cells(i, 4), .Cells(i, c)), TextBox1) &gt; 0 Then
                    MsgBox &quot;人员姓名重复,请重新输入!&quot;, 64, &quot;提示&quot;
                    TextBox1 = &quot;&quot;
                    TextBox1.SetFocus
                    Exit Sub
                Else
                    .Cells(i, c + 1) = TextBox1
                    ListBox1.AddItem TextBox1
                End If
            End If
        Next
    End With
    TextBox1.Text = &quot;&quot;
    TextBox1.SetFocus
End Sub
代码解析：
人员设置窗体中“增加”按钮的单击事件，将输入的人员姓名保存到“资料”表中该人员所在部门的行中。
第4行到第7行代码，判断是否已选择了所需增加人员的部门。
第8行到第12行代码，判断是否已输入所增加的人员姓名。
第15、16行代码，取得该部门在“资料”表中最右边列的列号。
第17行到第22行代码，判断所增加的人员姓名是否重复。
第23行代码，将所增加的人员姓名保存到“资料”表中。
第24行代码，将增加的人员姓名添加到列表框中。
第29、30行代码，清空文本框以便再次增加部门人员。</code></pre>
<p>双击窗体上的“删除”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim i As Integer
    Dim c As Integer
    Dim j  As Integer
    If ComboBox1.Text = &quot;&quot; Then
        MsgBox &quot;请先选择一个部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需删除的人员姓名!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet1
        If MsgBox(&quot;确定要删除&quot; &amp; ListBox1 &amp; &quot;吗?&quot;, 36, &quot;警告&quot;) = 6 Then
            For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
                If ComboBox1.Text = .Cells(i, 1).Value Then
                    c = .Cells(i, 255).End(xlToLeft).Column
                    For j = 4 To c
                        If .Cells(i, j) = ListBox1 Then
                            .Cells(i, j).Delete Shift:=xlToLeft
                        End If
                    Next
                End If
            Next
            ListBox1.RemoveItem (ListBox1.ListIndex)
        End If
    End With
End Sub
代码解析：
人员设置窗体中“删除”按钮的单击事件，删除所选部门中的人员姓名。
第5行到第8行代码，判断是否已选择了部门。
第9行到第12行代码，判断是否已选择了所需删除的人员。
第13行到第24行代码，删除该人员所在部门保存在“资料”表中该人员的单元格。
第25行代码，从列表框中删除该人员。
设置了使用单位、部门和人员的“资料”表如图 198 7所示。

图 198 7    “资料”表
步骤5，将Sheet3工作表名称重命名为“考勤统计”，设置成如图 198 8所示的格式，用来汇总部门考勤考核数据及打印“考勤统计”表。

图 198 8    “考勤统计”表
步骤6，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及两个按钮控件，在框架控件中添加四个标签控件、一个组合框控件、一个文本框控件和一个SpinButton控件，如图 198 9所示。

图 198 9    部门考勤窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim i As Integer
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        ComboBox1.AddItem Sheet1.Cells(i, 1)
    Next
    ComboBox1.ListIndex = 0
    Label4 = Sheet1.Range(&quot;B1&quot;)
    SpinButton1.Value = Month(Date)
    TextBox1.Text = Year(Date) &amp; &quot;年&quot; &amp; Month(Date) &amp; &quot;月&quot;
End Sub
代码解析：
部门考勤窗体的初始化事件，为组合控件添加部门名称，为文本框控件添加考勤月份。
双击窗体上的SpinButton控件，在打开的代码窗口写入下面的代码：
Private Sub SpinButton1_Change()
    With SpinButton1
        Select Case .Value
            Case 1 To 12
                TextBox1 = Left(TextBox1, 4) &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
            Case Is &gt; 12
                .Value = 1
                TextBox1 = Left(TextBox1, 4) + 1 &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
            Case Is &lt; 1
                .Value = 12
                TextBox1 = Left(TextBox1, 4) - 1 &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
        End Select
    End With
End Sub
代码解析：
SpinButton控件的Change事件，调节文本框控件中的考勤月份。</code></pre>
<p>双击窗体上的“确定”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim s As Integer
    Dim Sh As Worksheet
    Dim arr As Variant
    Dim arrName As Variant
    Dim i As Integer
    Dim i1 As Integer
    Dim j As Integer
    Dim j1 As Integer
    Dim r As Integer
    Dim c As Integer
    Dim str As String
    Dim d As Integer
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    For s = Worksheets.Count To 4 Step -1
        Worksheets(s).Delete
    Next
    Application.DisplayAlerts = True
    With Sheet1
        For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = .Cells(i, 1) And .Cells(i, 4) = &quot;&quot; Then
                MsgBox &quot;请增加部门人员!&quot;, 64, &quot;提示&quot;
                Unload Me
                Exit Sub
            End If
        Next
    End With
    With Sheet3
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        If r &gt;= 50 Then
            .Rows(&quot;50:&quot; &amp; r).Delete Shift:=xlUp
        End If
        .Range(&quot;B1&quot;) = Sheet1.Range(&quot;B1&quot;) &amp; &quot;出缺勤统计表&quot;
        .Range(&quot;C2&quot;) = ComboBox1.Text
        .Range(&quot;O2&quot;) = TextBox1.Text
        For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = Sheet1.Cells(i, 1) Then
                r = Sheet1.Cells(i, 255).End(xlToLeft).Column
                .Range(&quot;C30&quot;) = Sheet1.Cells(i, 2)
                .Range(&quot;O30&quot;) = Sheet1.Cells(i, 3)
                For c = 4 To r
                    .Cells(c + 46, 2) = Sheet1.Cells(i, c)
                Next
            End If
        Next
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;I50:I&quot; &amp; r).FormulaR1C1 = &quot;=SUM(RC[-4]:RC[-1])&quot;
        .Range(&quot;M50:M&quot; &amp; r).FormulaR1C1 = &quot;=SUM(RC[-3]:RC[-1])&quot;
        .Range(&quot;B50:O&quot; &amp; r).Borders.LineStyle = xlContinuous
        .Range(&quot;C50:C&quot; &amp; r).Locked = False
        .Range(&quot;E50:H&quot; &amp; r).Locked = False
        .Range(&quot;J50:L&quot; &amp; r).Locked = False
        .ScrollArea = &quot;&quot;
        Application.Goto Reference:=.Range(&quot;A50&quot;), Scroll:=True
        .ScrollArea = &quot;A50:O&quot; &amp; r
        .Protect
        .EnableSelection = xlUnlockedCells
    End With
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If ComboBox1.Text = Sheet1.Cells(i, 1) Then
            c = i
            For j = 4 To Sheet1.Cells(i, 255).End(xlToLeft).Column
                str = str &amp; Sheet1.Cells(i, j) &amp; &quot;,&quot;
            Next
        End If
    Next
    arrName = Split(Left(str, (Len(str) - 1)), &quot;,&quot;)
    For i1 = 0 To UBound(arrName)
        Set Sh = Worksheets.Add(after:=Worksheets(Worksheets.Count))
        With Sh
            .Name = arrName(i1)
            arr = Array(1.75, 4.5, 3, 3, 3, 3, 45, 9, 1.75)
            For i = LBound(arr) To UBound(arr)
                .Columns(i + 1).ColumnWidth = arr(i)
            Next
            arr = Array(33, 24, 18)
            For i = LBound(arr) To UBound(arr)
                .Rows(i + 1).RowHeight = arr(i)
            Next
            .Rows(&quot;4:36&quot;).RowHeight = 16.5
            .Rows(37).RowHeight = 30
            .Range(&quot;B1:H1,B2:H2,C4:D4,E4:F4,B4:B5,G4:G5,H4:H5,B37:G37&quot;).Merge
            With .Range(&quot;B4:H37&quot;)
                .Borders.LineStyle = xlContinuous
                .BorderAround xlDouble
            End With
            With .Range(&quot;B1&quot;)
                .HorizontalAlignment = xlCenter
                .Value = Sheet1.Range(&quot;B1&quot;) &amp; &quot;人员考核记录表&quot;
                .Font.Name = &quot;黑体&quot;
                .Font.Size = 16
                .Font.Bold = True
            End With
            With .Range(&quot;B2&quot;)
                .HorizontalAlignment = xlCenter
                .Value = TextBox1.Text
                .Font.Bold = True
            End With
            With .Range(&quot;B3&quot;)
                .Value = &quot;姓名：&quot; &amp; arrName(i1)
                .HorizontalAlignment = xlLeft
                .Font.Size = 10
            End With
            With .Range(&quot;B4：H37&quot;)
                .HorizontalAlignment = xlCenter
                .Font.Size = 10
            End With
            .Range(&quot;B4&quot;).Value = &quot;日&quot; &amp; Chr(10) &amp; &quot;期&quot;
            .Range(&quot;C4&quot;).Value = &quot;上午&quot;
            .Range(&quot;E4&quot;).Value = &quot;下午&quot;
            .Range(&quot;G4&quot;).Value = &quot;工作内容（加班情况或外出记录）&quot;
            .Range(&quot;H4&quot;).Value = &quot;备注&quot;
            .Range(&quot;C5,E5&quot;).Value = &quot;到&quot;
            .Range(&quot;D5,F5&quot;).Value = &quot;缺&quot;
            .Range(&quot;B37&quot;).Value = &quot;本月考核得分总计&quot;
            With .Range(&quot;B38&quot;)
                .Value = &quot;部门负责人：&quot; &amp; Sheet1.Cells(c, 2)
                .HorizontalAlignment = xlLeft
                .Font.Size = 10
            End With
            With .Range(&quot;H38&quot;)
                .Value = &quot;考勤员：&quot; &amp; Sheet1.Cells(c, 3)
                .Font.Size = 10
                .HorizontalAlignment = xlRight
            End With
            Select Case Val(Sheet1.Cells(2, 2))
                 Case 26 To 28
                    If Month(TextBox1.Text &amp; &quot;1日&quot;) &lt;&gt; 1 Then
                        .Cells(6, 2) = Year(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Month(DateAdd(&quot;m&quot;, -1, TextBox1.Text &amp; &quot;1日&quot;)) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
                    Else
                        .Cells(6, 2) = (Year(TextBox1.Text &amp; &quot;1日&quot;) - 1) &amp; &quot;-&quot; &amp; Month(DateAdd(&quot;m&quot;, -1, TextBox1.Text &amp; &quot;1日&quot;)) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
                    End If
                Case 1 To 5
                    .Cells(6, 2) = Year(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Month(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
            End Select
            For i = 1 To 30
                Cells(i + 6, 2) = .Cells(6, 2) + i
                If .Cells(i + 6, 2).Value = DateAdd(&quot;m&quot;, 1, .Cells(6, 2)) - 1 Then Exit For
            Next
            .Range(&quot;B6:B36&quot;).NumberFormatLocal = &quot;d&quot;
            For i = 6 To 36
                If .Cells(i, 2) &lt;&gt; &quot;&quot; Then
                    Select Case DatePart(&quot;w&quot;, .Cells(i, 2))
                        Case 7, 1
                            .Cells(i, 7) = &quot;休  息&quot;
                        Case 2, 3, 4, 5, 6
                            .Cells(i, 3) = &quot;√&quot;
                            .Cells(i, 5) = &quot;√&quot;
                            .Cells(i, 7) = &quot;上  班&quot;
                            d = d + 1
                    End Select
                    Select Case Mid(Cells(i, 2), 6, Len(Cells(i, 2)) - 5)
                        Case &quot;01-01&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;元  旦&quot;
                            d = d - 1
                        Case &quot;05-01&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;五一节&quot;
                            d = d - 1
                        Case &quot;10-01&quot;, &quot;10-02&quot;, &quot;10-03&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;国庆节&quot;
                            d = d - 1
                    End Select
                    Select Case Mid(NongLi(Cells(i, 2)), 9, 5)
                        Case &quot;正月初一&quot;, &quot;正月初二&quot;, &quot;正月初三&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;春  节&quot;
                            d = d - 1
                        Case &quot;四月初四&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;清明节&quot;
                            d = d - 1
                        Case &quot;五月初五&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;端午节&quot;
                            d = d - 1
                        Case &quot;八月十五&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;中秋节&quot;
                            d = d - 1
                    End Select
                End If
            Next
            .Range(&quot;E3&quot;) = d
            d = 0
            .Range(&quot;H3&quot;).FormulaR1C1 = &quot;=(COUNTA(R[3]C[-5]:R[33]C[-5],R[3]C[-3]:R[33]C[-3],&quot;&quot;√&quot;&quot;&quot;&quot;&quot;&quot;)-1)/2&quot;
            .Range(&quot;H37&quot;).FormulaR1C1 = &quot;=ROUND(IF(R[-34]C/R[-34]C[-3]*100&gt;100,100,R[-34]C/R[-34]C[-3]*100),0)&quot;
            .Range(&quot;E3,H3&quot;).Font.ColorIndex = 2
            .Range(&quot;C6:G36&quot;).Locked = False
            .Rows(&quot;6&quot;).Select
            .PageSetup.CenterHorizontally = True
            .DisplayAutomaticPageBreaks = False
            With ActiveWindow
                .DisplayGridlines = False
                .DisplayHeadings = False
                .DisplayOutline = False
                .FreezePanes = True
                .DisplayGridlines = False
            End With
            .ScrollArea = &quot;B1:O42&quot;
            .Range(&quot;G6&quot;).Select
            .Protect
            .EnableSelection = xlUnlockedCells
        End With
    Next
    Sheets(&quot;考勤统计&quot;).Select
    Unload Me
    Application.ScreenUpdating = True
End Sub
代码解析：
部门考勤窗体中“确定”按钮的单击事件，将所考勤部门的人员姓名写入到“考勤统计”表的姓名列中并在工作簿中该部门所有人员的个人考核表。
第15行到第19行代码，删除工作簿中原有的个人考核表。
第20行到第28行代码，判断所要考勤的部门是否已添加了部门人员。
第32行到第34行代码，删除“考勤统计”表中原有的统计数据，因为“考勤统计”表中B1：O30的表格是打印表格用的，统计数据是保存在B50以下单元格中，所以考勤前需要删除。
第35行代码，将单位名称写入到“考勤统计”表的B1单元格。
第36行代码，将考勤部门写入到“考勤统计”表的C2单元格。
第4行代码，将考勤月份写入到“考勤统计”表的O2单元格。
第41行代码，将部门负责人写入到“考勤统计”表的C30单元格。
第42行代码，将考勤员写入到“考勤统计”表的O30单元格。
第43行到第45行代码，将“资料”表中所保存的该部门人员姓名写入“考勤统计”表的B50及B50往下单元格中。
第49、50行代码，在“考勤统计”表的I50、M50及以下单元格中写入合计公式并将单元格属性设置为锁定。
第51行代码，将“考勤统计”表的B50至O列的最后一行单元格添加边框线。
第52行到第54行代码，取消“考勤统计”表中需要编辑单元格的锁定属性。
第55行到第57行代码，将“考勤统计”表的可选择区域设置为B50至O列的最后一行单元格并使用Goto方法选择B50单元格。
第58、59行代码，保护“考勤统计”表，使之只能选择未锁定的单元格。
写入考勤数据的“考勤统计”表如图 198 10所示。

图 198 10    “考勤统计”表
第61行到第69代码，将该部门保存在“资料”表中的人员姓名赋给数组arrName。
第70、71行代码，根据数组arrName保存的人员姓名依次在工作簿中添加个人考核表。
第73行代码，将添加的工作表以人员姓名重新命名。
第74行到第83行代码，设置个人考核表的行高、列宽。
第84行代码，合并个人考核表中的单元格。
第85行到第88行代码，设置个人考核表的边框线。
第59行到第127行代码，在个人考核表写入表格内容并设置格式。
第128行到第142行代码，在个人考核表的日期栏中根据考勤月份及考勤周期写入考勤日期并设置自定义格式。
第145行到第153行代码，使用DatePart函数判断考勤日期的星期并在个人考核表的“到”栏和“工作内容”栏中写入系统默认的内容，其中第152行代码，将应出勤天数赋给变量d。
第154行到第170行代码，判断考勤日期是否是“元旦”、“五一节”及“国庆节”，如果是则去除个人考核表的“到”栏中的应出勤标志，在“工作内容”栏中写入节假日名称并将应出勤天数减去放假天数。
第171行到第192行代码，判断考勤日期是否是“春节”、“清明节”、“端午节”及“中秋节”，如果是则去除个人考核表的“到”栏中的应出勤标志，在“工作内容”栏中写入节假日名称并将应出勤天数减去放假天数。</code></pre>
<p>判断考勤日期的农历日期需使用自定义函数，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Public Function NongLi(Optional XX_DATE As Date)
    Dim MonthAdd(11), NongliData(99), TianGan(9), DiZhi(11), ShuXiang(11), DayName(30), MonName(12)
    Dim curTime, curYear, curMonth, curDay
    Dim GongliStr, NongliStr, NongliDayStr
    Dim i, m, n, k, isEnd, bit, TheDate
    代码略，详见附件
    NongliStr = &quot;农历&quot; &amp; TianGan(((curYear - 4) Mod 60) Mod 10) &amp; DiZhi(((curYear - 4) Mod 60) Mod 12) &amp; &quot;年&quot;
    NongliStr = NongliStr &amp; &quot;(&quot; &amp; ShuXiang(((curYear - 4) Mod 60) Mod 12) &amp; &quot;)&quot;
    If (curMonth &lt; 1) Then
        NongliDayStr = &quot;闰&quot; &amp; MonName(-1 * curMonth)
    Else
        NongliDayStr = MonName(curMonth)
    End If
    NongliDayStr = NongliDayStr &amp; &quot;月&quot;
    NongliDayStr = NongliDayStr &amp; DayName(curDay)
    NongLi = NongliStr &amp; NongliDayStr
End Function
自定义NongLi函数根据日期生成农历天干、地支、属相等，来自网络，未做任何修改。其中第171行代码使用Mid函数取得农历日期。
第195行代码，将统计出的应出勤天数写入到个人考核表的E3单元格。
第197行代码，在个人考核表的H3单元格中写入统计实际出勤天数的公式。
第198行代码，在个人考核表的H36单元格中写入计算考核得分的公式。
第199行到第216行代码，设置个人考核表的页面格式及工作表保护。
添加好的个人考核表如图 198 11所示。

图 198 11    个人考核表</code></pre>
<p>在实际应用时，系统统计出的出勤数据与实际出勤数据可能有出入，为了方便修改数据，在VBE中双击ThisWorkbook写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_SheetSelectionChange(ByVal Sh As Object, ByVal Target As Range)
    If Sh.Index &gt; 3 And Target.Count = 1 Then
        If Sh.Range(&quot;B&quot; &amp; Target.Row) &lt;&gt; &quot;&quot; Then
            If Not Application.Intersect(Target, Union(Sh.Range(&quot;C6:C36&quot;), Sh.Range(&quot;E6:E36&quot;))) Is Nothing Then
                Target = &quot;√&quot;
                Target.Offset(, 1) = &quot;&quot;
            End If
            If Not Application.Intersect(Target, Union(Sh.Range(&quot;D6:D36&quot;), Sh.Range(&quot;F6:F36&quot;))) Is Nothing Then
                Target = &quot;△&quot;
                Target.Offset(, -1) = &quot;&quot;
            End If
        End If
    End If
End Sub
代码解析：
工作簿的SheetSelectionChange事件，选择个人考核表中的“到”或“缺”栏中的单元格时，自动在单元格中写入出缺勤标志。

​```vb
Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    Dim rng As Range
    If Sh.Index &gt; 3 And Target.Count = 1 Then
        If Sh.Range(&quot;B&quot; &amp; Target.Row) &lt;&gt; &quot;&quot; Then
            If Not Application.Intersect(Target, Sh.Range(&quot;C6:F36&quot;)) Is Nothing Then
                Select Case Target
                    Case &quot;√&quot;
                        Sh.Range(&quot;G&quot; &amp; Target.Row) = &quot;上  班&quot;
                    Case &quot;△&quot;
                        Sh.Range(&quot;G&quot; &amp; Target.Row) = &quot;缺  勤&quot;
                    End Select
            End If
        End If
    End If
End Sub
代码解析：
工作簿的SheetChange事件，根据个人考核表中的“到”或“缺”栏中写入出缺勤标志自动调整工作内容栏中的工作内容。</code></pre>
<p>步骤7，在实际应用中，因为隐藏了工作表标签，当需要选择个人考核表时，只能使用自定义的菜单，所以在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub check()
    On Error GoTo Line
    Sheets(4).Activate
    Exit Sub
Line:
    MsgBox &quot;本月还没有考勤,请先考勤!&quot;, 64, &quot;提示&quot;
End Sub
代码解析：
Check过程激活工作簿中的第四张工作表，也就是第一张个人考核表。如果还没有进行部门考勤，激活命令会发生错误，所以使用On Error语句执行第6行代码进行提示。</code></pre>
<p>在修改个人考核表过程中，需要在工作簿中进行上下翻页，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub NextPage()
    Select Case ActiveSheet.Index
        Case Is &lt; 4
            MsgBox &quot;请选择【个人考核】按纽!&quot;, 64, &quot;提示&quot;
        Case Is = Worksheets.Count
            MsgBox &quot;已经是最后一页!&quot;, 64, &quot;提示&quot;
        Case Else
            Sheets(ActiveSheet.Index + 1).Activate
    End Select
End Sub
代码解析：
NextPage过程通过活动工作表的Index属性判断活动工作表是否在个人考核表的范围内，如果在则激活活动工作表的下一张工作表，否则进行提示。</code></pre>
<pre><code class="vb">Sub Onpage()
    Select Case ActiveSheet.Index
        Case Is &lt; 4
            MsgBox &quot;请选择【个人考核】按纽!&quot;, 64, &quot;提示&quot;
        Case Is = 4
            MsgBox &quot;已经是第一页!&quot;, 64, &quot;提示&quot;
        Case Else
            Sheets(ActiveSheet.Index - 1).Activate
    End Select
End Sub
代码解析：
Onpage过程通过活动工作表的Index属性判断活动工作表是否在个人考核表的范围内，如果在则激活活动工作表的上一张工作表，否则进行提示。</code></pre>
<p>步骤8，当所有的个人考核表修改完成后，需要对个人考核数据进行汇总，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub Gather()
    Dim i As Integer
    If Worksheets.Count &lt; 4 Then
        MsgBox &quot;本月还没有考勤,请先进行部门考勤!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet3
        .Select
        If MsgBox(&quot;是否汇总&quot; &amp; .Range(&quot;C2&quot;) &amp; .Range(&quot;O2&quot;).Text &amp; &quot;份的考勤记录?&quot;, 36, &quot;提示&quot;) = 6 Then
            .Unprotect
            For i = 50 To .Range(&quot;B65536&quot;).End(xlUp).Row
                If .Cells(i, 2) &lt;&gt; &quot;&quot; Then
                .Cells(i, 3) = Sheets(i - 46).Range(&quot;E3&quot;)
                .Cells(i, 4) = Sheets(i - 46).Range(&quot;H3&quot;)
                .Cells(i, 14) = Sheets(i - 46).Range(&quot;H37&quot;)
                End If
            Next
        .Protect
        End If
    End With
End Sub
代码解析：
Gather过程将每个职工的个人考核表中的考核数据汇总到“考勤统计”表。
第3行到第6行代码，判断是否已进行了部门考勤，因为如果还没有进行部门考勤，工作簿中只有三张工作表。
第11行到第16行代码，将个人考核表中的应出勤天数、实际出勤天数及考核得分写入到“考勤统计”表第50行主以下的单元格中。因为“考勤统计”表中的姓名和个人考核表的工作表名称的顺序是一致的，所以只需按顺序写入即可。如果应出勤天数与实际情况有出入可以在“考勤统计”表的C列单元格中进行修改。</code></pre>
<p>步骤9，当汇总好考核数据后，需要打印“考勤统计”表和所有的个人考核表，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub stamp()
    Dim i As Integer
    Dim r As Integer
    Dim a As Integer
    Dim p As Integer
    Dim c As Integer
    If Worksheets.Count &lt; 4 Then
        MsgBox &quot;本月还没有考勤,请先进行部门考勤!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet3
        .Select
        If .Range(&quot;C50&quot;) = &quot;&quot; Then
            MsgBox &quot;请先汇总考核数据!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        Application.ScreenUpdating = False
        If MsgBox(&quot;是否打印&quot; &amp; .Range(&quot;C2&quot;) &amp; .Range(&quot;O2&quot;).Text &amp; &quot;份的考勤记录?&quot;, 36, &quot;提示&quot;) = 7 Then
            Exit Sub
        End If
        .Unprotect
        r = .Range(&quot;B63536&quot;).End(xlUp).Row
        a = Abs(Int(-(r - 49) / 25))
        For p = 1 To a
            For i = 5 To 29
                For c = 2 To 15
                    .Cells(i, c) = .Cells(i + 45 + (p - 1) * 25, c)
                Next
            Next
            .PrintOut
        Next
        For i = 4 To Worksheets.Count
            Sheets(i).PrintOut
        Next
        .Protect
        .EnableSelection = 1
        Application.ScreenUpdating = True
    End With
End Sub
代码解析：
stamp过程打印“考勤统计”表和所有的个人考核表。
第7行到第10行代码，判断是否已进行了部门考勤，因为如果还没有进行部门考勤，工作簿中只有三张工作表。
第13行到第16行代码，判断是否已将考核数据进行汇总。
第22、23行代码，计算“考勤统计”表需打印的张数，因为预设的表格只有25行，如果部门人数超过25人需要进行分次打印。
第24行到第31行代码，将考核数据每次25行写入到打印表格中进行打印。
第32行到第34行代码，打印所有人员的个人考核表。</code></pre>
<p>步骤10，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个Image控件、一个框架控件及一个按钮控件，在框架控件中添加一个Image控件和一个标签控件，将Image控件的Picture属性设置为合适的图片，如图 198 12所示。</p>
<p>图 198 12 关于窗体<br>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Note As String
    Note = &quot;名称： 职工考勤系统&quot; &amp; vbLf _
        &amp; &quot;版本： V2.0&quot; &amp; vbLf _
        &amp; &quot;作者： yuanzhuping&quot; &amp; vbLf _
        &amp; &quot;E-mail： yuanzhuping@yeah.net &quot;
    Label1.Caption = Note
End Sub
代码解析：
“关于”窗体的初始化事件，使用标签控件显示系统信息。
步骤11，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及一个按钮控件，在框架控件中添加一个标签控件，如图 198 13所示。

图 198 13    帮助窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Note As String
    With Label1
        .Caption = Note
        .Height = 296
        .Top = 6
        .Left = 6
        Frame1.ScrollBars = fmScrollBarsVertical
        Frame1.ScrollHeight = .Height
    End With
End Sub
代码解析：
“帮助”窗体的初始化事件，使用标签控件显示帮助信息。请参阅技巧122 。</code></pre>
<p>步骤12，在实际应用中，需要在菜单栏上添加自定义菜单来使用各项功能，在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码：</p>
<pre><code class="vb">Sub AddNowBar()
    Dim NewBar As CommandBar
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = False
        .CommandBars(&quot;Formatting&quot;).Visible = False
        .CommandBars(&quot;Stop Recording&quot;).Visible = False
        .CommandBars(&quot;toolbar list&quot;).Enabled = False
        .CommandBars.DisableAskAQuestionDropdown = True
        .DisplayFormulaBar = False
        .DisplayStatusBar = False
        .CommandBars(&quot;NewBar&quot;).Delete
    End With
    Set NewBar = Application.CommandBars.Add(Name:=&quot;NewBar&quot;, Position:=msoBarTop, MenuBar:=True, Temporary:=True)
   # 。。。。。。。。。代码略，详见附件
    End With
    Set NewBar = Nothing
    Application.StatusBar = &quot;&quot;
End Sub
Sub DelNowBar()
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = True
        .CommandBars(&quot;Formatting&quot;).Visible = True
        .CommandBars(&quot;Stop Recording&quot;).Visible = True
        .CommandBars(&quot;toolbar list&quot;).Enabled = True
        .CommandBars.DisableAskAQuestionDropdown = False
        .DisplayFormulaBar = True
        .DisplayStatusBar = True
        .CommandBars(&quot;NewBar&quot;).Delete
        Application.StatusBar = False
    End With
End Sub
代码解析：
第1行到第19行代码，AddNowBar过程，去除工作簿中的菜单栏、工具栏、编辑栏及状态栏等，添加自定义的菜单栏。
第20行到第33行代码，DelNowBar过程，恢复系统原来的设置。
关于自定义菜单请参阅技巧83 。
自定义菜单如图 198 14所示。

图 198 14    自定义菜单</code></pre>
<p>为了使用自定义菜单，除了以上已经解析过的过程以外，还需在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码：</p>
<pre><code class="vb">Sub SetUnits()
    If Sheet1.Cells(1, 2) &lt;&gt; &quot;&quot; Then
        If MsgBox(&quot;是否重新设置使用单位？&quot;, 36, &quot;提示&quot;) = 7 Then
            Exit Sub
        End If
    End If
    单位设置.Show
End Sub
Sub Setbranch()
    If Sheet1.Cells(1, 2) = &quot;&quot; Then
        MsgBox &quot;请先设置使用单位!&quot;, 36, &quot;提示&quot;
        Exit Sub
    End If
    部门设置.Show
End Sub
Sub Setcrew()
    If Sheet1.Cells(4, 1) = &quot;&quot; Then
        MsgBox &quot;请先设置使用部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    人员设置.Show
End Sub
Sub Attendance()
    If Sheet1.Cells(4, 1) = &quot;&quot; Then
        MsgBox &quot;请先设置使用部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    部门考勤.Show
End Sub
Sub backtrack()
    Sheet2.Select
End Sub
Sub ThemeHelp()
    关于.Show
End Sub
Sub OnHelp()
    帮助.Show
End Sub
Sub myQuit()
    If Workbooks.Count &gt; 1 Then
        ThisWorkbook.Close
    Else
        Application.Quit
    End If
End Sub
代码解析：
第1行到第8行代码，“系统设置”菜单中的“单位设置”菜单指定的过程，显示“单位设置”窗体。
第9行到第15行代码，“系统设置”菜单中的“部门设置”菜单指定的过程，显示“部门设置”窗体。
第16行到第22行代码，“系统设置”菜单中的“人员设置”菜单指定的过程，显示“人员设置”窗体。
第23行到第29行代码，“部门考勤”菜单指定的过程，显示“部门考勤”窗体。其中第24行到第27行代码判断是否已设置了使用部门。
第30行到第32行代码，“返回”菜单指定的过程，选择主界面表。
第33行到第35行代码，“帮助”菜单中的“关于”菜单指定的过程，显示“关于”窗体。
第36行到第38行代码，“帮助”菜单中的“帮助”菜单指定的过程，显示“帮助”窗体。
第39行到第45行代码，“退出系统”菜单指定的过程，根据当前打开的工作簿数量采用Close方法关闭工作簿或Quit方法关闭应用程序。
步骤13，为了在使用过程中有一个友好的用户界面，将Sheet2表重命名为“欢迎”，在工作表中插入合适的图片，在图片上添加标签控件并把宏指定给标签控件。</code></pre>
<p>步骤14，在VBE窗口中双击“ThisWorkbook”，在打开的代码窗口中写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_Open()
    With Sheet2
        .ScrollArea = &quot;A1&quot;
        .Select
    End With
End Sub
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim s As Integer
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    For s = Worksheets.Count To 4 Step -1
        Worksheets(s).Delete
    Next
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    ThisWorkbook.Save
End Sub
Private Sub Workbook_Activate()
    Application.Caption = IIf(Sheet1.Cells(1, 2) &lt;&gt; &quot;&quot;, Sheet1.Cells(1, 2), &quot;&quot;)
    Call AddNowBar
End Sub
Private Sub Workbook_Deactivate()
    Application.Caption = &quot;&quot;
    Call DelNowBar
End Sub
代码解析：
第1行到第6行代码，工作簿的Open事件，打开考勤系统时选择欢迎界面。
第7行到第17行代码，工作簿的BeforeClose事件，关闭考勤系统时删除所有的个人考核表。
第18行到第21行代码，工作簿的Activate事件，考勤系统激活时创建自定义菜单。
第22行到第25行代码，工作簿的Deactivate事件，考勤系统非激活时删除自定义菜单。
步骤15，最后在VBE中将“资料”表的Visible属性设置为xlSheetVeryHidden使之隐藏；单击菜单“工具”→“数字签名”，为VBA工程签署数字证书。
保存、关闭工作簿，重新打开工作簿，职工考勤系统如图 198 15所示。</code></pre>

    </div>
</article>
                </main>
                <aside class="aside">
                    <section class="aside-section">
                        
    <h1>Categories</h1>

    <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/生の术/">生の术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生の迹/">生の迹</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/生の道/">生の道</a></li></ul>

                    </section>
                    <section class="aside-section">
                        
    <h1>Archives</h1>

    <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archiveshl/2018/">2018</a></li></ul>


                    </section>
                    <section class="aside-section tag">
                        
    <h1>Tags</h1>

    <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Markdown/">Markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Oracle/">Oracle</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VBA/">VBA</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/数据科学/">数据科学</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/爬虫/">爬虫</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/自言语/">自言语</a></li></ul>

                    </section>
                </aside>
        </div>
    </body>

</html>