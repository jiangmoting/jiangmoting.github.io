<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="dns-prefetch" href="http://jiangmoting.com">
  <title>TT ❤ LL 印迹</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="生长的印迹">
<meta name="keywords" content="绛墨铤的博客">
<meta property="og:type" content="website">
<meta property="og:title" content="TT ❤ LL 印迹">
<meta property="og:url" content="http://jiangmoting.com/index.html">
<meta property="og:site_name" content="TT ❤ LL 印迹">
<meta property="og:description" content="生长的印迹">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="TT ❤ LL 印迹">
<meta name="twitter:description" content="生长的印迹">
  
    <link rel="alternative" href="/atom.xml" title="TT ❤ LL 印迹" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" type="text/css" href="/./main.0cf68a.css">
  <style type="text/css">
  
    #container.show {
      background: linear-gradient(200deg,#a0cfe4,#e8c37e);
    }
  </style>
  

  

</head>
</html>
<body>
  <div id="container" q-class="show:isCtnShow">
    <canvas id="anm-canvas" class="anm-canvas"></canvas>
    <div class="left-col" q-class="show:isShow">
      
<div class="overlay" style="background: #4d4d4d"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			<img src class="js-avatar">
		</a>
		<hgroup>
		  <h1 class="header-author"><a href="/">绛墨铤</a></h1>
		</hgroup>
		

		<nav class="header-menu">
			<ul>
			
				<li><a href="/">主页</a></li>
	        
				<li><a href="/tags/随笔/">随笔</a></li>
	        
			</ul>
		</nav>
		<nav class="header-smart-menu">
    		
    			
    			<a q-on="click: openSlider(e, 'innerArchive')" href="javascript:void(0)">所有文章</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'friends')" href="javascript:void(0)">友链</a>
    			
            
    			
    			<a q-on="click: openSlider(e, 'aboutme')" href="javascript:void(0)">关于我</a>
    			
            
		</nav>
		<nav class="header-nav">
			<div class="social">
				
					<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
		        
					<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
		        
					<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
		        
					<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
		        
			</div>
		</nav>
	</header>		
</div>

    </div>
    <div class="mid-col" q-class="show:isShow,hide:isShow|isFalse">
      
<nav id="mobile-nav">
  	<div class="overlay js-overlay" style="background: #4d4d4d"></div>
	<div class="btnctn js-mobile-btnctn">
  		<div class="slider-trigger list" q-on="click: openSlider(e)"><i class="icon icon-sort"></i></div>
	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img src class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author js-header-author">绛墨铤</h1>
			</hgroup>
			
			
			
				
			
				
			
			
			
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="#" title="github"><i class="icon-github"></i></a>
			        
						<a class="weibo" target="_blank" href="#" title="weibo"><i class="icon-weibo"></i></a>
			        
						<a class="rss" target="_blank" href="#" title="rss"><i class="icon-rss"></i></a>
			        
						<a class="zhihu" target="_blank" href="#" title="zhihu"><i class="icon-zhihu"></i></a>
			        
				</div>
			</nav>

			<nav class="header-menu js-header-menu">
				<ul style="width: 50%">
				
				
					<li style="width: 50%"><a href="/">主页</a></li>
		        
					<li style="width: 50%"><a href="/tags/随笔/">随笔</a></li>
		        
				</ul>
			</nav>
		</header>				
	</div>
	<div class="mobile-mask" style="display:none" q-show="isShow"></div>
</nav>

      <div id="wrapper" class="body-wrap">
        <div class="menu-l">
          <div class="canvas-wrap">
            <canvas data-colors="#eaeaea" data-sectionHeight="100" data-contentId="js-content" id="myCanvas1" class="anm-canvas"></canvas>
          </div>
          <div id="js-content" class="content-ll">
            
  
    <article id="post-VBA常用技巧11--其他应用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/03/VBA常用技巧11--其他应用/">VBA常用技巧11--其他应用</a>
    </h1>
  

        
        <a href="/2018/06/03/VBA常用技巧11--其他应用/" class="archive-article-date">
  	<time datetime="2018-06-02T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-06-03</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第11章-其他应用"><a href="#第11章-其他应用" class="headerlink" title="第11章     其他应用"></a>第11章     其他应用</h2><h3 id="技巧181-取得电脑名称"><a href="#技巧181-取得电脑名称" class="headerlink" title="技巧181     取得电脑名称"></a>技巧181     取得电脑名称</h3><p>如果希望使用VBA开发的程序只能在某一特定的电脑中使用，那么可以在程序开始时检查当前电脑的名称是否是指定的名称，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Dim myName As String
    myName = Environ(&quot;Computername&quot;)
    If myName &lt;&gt; &quot;ERPSERVER&quot; Then
        MsgBox &quot;对不起您不是合法用户，文件将关闭!&quot;
        ThisWorkbook.Close
    End If
End Sub
代码解析：
工作簿的Open事件过程，在工作簿打开时判断电脑的名称，如果不是“ERPSERVER”则退出关闭工作簿。
第3行代码取得电脑的名称。Environ函数返回String，关连一个操作系统环境变量，语法如下：
Environ({envstring | number})
参数envstring是可选的，包含一个环境变量名的字符串表达式。如果在环境字符串表格中找到参数envstring，则Environ函数返回在环境字符串表格中对应那个环境变量的等号后面的那段文本。
Environ(&quot;Computername&quot;)返回电脑名称，如果需要取得当前登录用户的用户名则使用Environ(&quot;UserName&quot;)。
参数number是可选的，用来表示环境字符串在环境字符串表格中的数值顺序。number 参数可以是任意的数值表达式，不过在计算前，它会先转换为一个整数。
第4行到第7行代码，如果当前电脑不是指定的电脑，关闭工作簿。在实际应用中需要配合其他方法使用户在打开时强制启用宏才能达到这一效果。</code></pre>
<h3 id="技巧182-取得逻辑盘序列号"><a href="#技巧182-取得逻辑盘序列号" class="headerlink" title="技巧182     取得逻辑盘序列号"></a>技巧182     取得逻辑盘序列号</h3><p>在技巧181 中使用Environ函数返回电脑的名称，使程序只能在某一特定的电脑中使用。但是电脑名称并不是唯一的，有可能多台电脑使用同一名称，所以更好的方法是程序开始时检查电脑的逻辑盘序列号是否是指定的序列号。取得逻辑盘序列号可以使用下面的代码。</p>
<pre><code class="vb">Sub DriveID()
    Dim DriveID
    Set DriveID = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MsgBox &quot;C盘的序列号是：&quot; &amp; DriveID.GetDrive(&quot;C&quot;).SerialNumber, 64
End Sub
代码解析：
DriveID过程使用GetDrive方法取得电脑C盘的序列号。
应用于FileSystemObject对象的GetDrive方法返回一个与指定路径中的驱动器相对应的Drive对象，语法如下：
object.GetDrive drivespec
object参数是必需的， FileSystemObject对象的名字。关于FileSystemObject对象的引用请参阅技巧180 。
Drivespec参数是必需的，可以是一个驱动器字符（c）、一个驱动器字符加一个冒号（c:）、一个驱动器字符加冒号和路径分隔符（c:\）或任何网络共享的说明（\\computer2\share1）。
在使用GetDrive方法返回一个Drive对象后，就可以使用其SerialNumber属性返回C盘的序列号。Drive对象对特定磁盘驱动器或网络共享的属性提供访问，而应用于Drive对象的SerialNumber属性用于唯一标识磁盘卷标的十进制序列号，语法如下：
object.SerialNumber
运行DriveID过程将使用消息框显示电脑C盘的序列号，如图 182 1所示。

图 182 1    C盘的序列号</code></pre>
<h3 id="技巧183-使用API取得硬盘信息"><a href="#技巧183-使用API取得硬盘信息" class="headerlink" title="技巧183     使用API取得硬盘信息"></a>技巧183     使用API取得硬盘信息</h3><p>在VBA中可以使用API函数取得逻辑盘序列号和唯一的物理系列号，如下面的代码所示。</p>
<pre><code class="vb">Private Const MAX_IDE_DRIVES As Long = 4
Private Const READ_ATTRIBUTE_BUFFER_SIZE As Long = 512
Private Const IDENTIFY_BUFFER_SIZE As Long = 512
Private Const READ_THRESHOLD_BUFFER_SIZE As Long = 512
Private Const DFP_GET_VERSION As Long = &amp;H74080
Private Const DFP_SEND_DRIVE_COMMAND As Long = &amp;H7C084
Private Const DFP_RECEIVE_DRIVE_DATA As Long = &amp;H7C088
……代码略，详见附件
&#39;取得硬盘信息：型号/物理系列号（唯一）
Function GetHardDiskInfo(Optional ByVal numDisk As eumDiskNo = hdPrimaryMaster, Optional ByVal numType As eumInfoType = hdOnlySN) As String
    If GetDiskInfo(numDisk) = 1 Then
        Dim pSerialNumber As String, pModelNumber As String
        pSerialNumber = StrConv(m_DiskInfo.sSerialNumber, vbUnicode)
        pModelNumber = StrConv(m_DiskInfo.sModelNumber, vbUnicode)
        Select Case numType
            Case hdOnlyModel  &#39;仅型号
                GetHardDiskInfo = Trim(pModelNumber)
            Case hdOnlySN  &#39;仅系列号
                GetHardDiskInfo = Trim(pSerialNumber)
            Case Else   &#39;型号,系列号
                GetHardDiskInfo = Trim(pModelNumber) &amp; &quot;,&quot; &amp; Trim(pSerialNumber)
        End Select
     End If
End Function
代码解析;
使用API函数取得逻辑盘序列号和唯一的硬盘物理系列号，其中GetDiskVolume函数过程取得逻辑盘序列号，GetHardDiskInfo函数过程取得唯一的硬盘物理系列号。</code></pre>
<p>调用此函数的代码如下。</p>
<pre><code class="vb">Sub DiskId()
    MsgBox &quot;硬盘的物理系列号：&quot; &amp; GetHardDiskInfo(hdPrimaryMaster, hdOnlySN) _
        &amp; Chr(13) &amp; &quot;C盘的序列号：&quot; &amp; GetDiskVolume(&quot;C&quot;)
End Sub
运行DiskId过程，使用消息框显示硬盘信息，如图 183 1所示。

图 183 1    硬盘系列号</code></pre>
<h3 id="技巧184-使用数字签名"><a href="#技巧184-使用数字签名" class="headerlink" title="技巧184     使用数字签名"></a>技巧184     使用数字签名</h3><p>对于Excel中包含VBA的文档，用户最恐惧的一件事情便是是否有病毒，因此往往把Excel安全级别设置为“中”，即对不可靠的来源提醒用户是否启用宏。而对于VBA开发人员来说，最想做的就是使Excel程序启动时不出现警告对话框，直接进入（在安全级别为中的情况下），这时就可以使用数字签名。<br>数字签名仅在安装了Microsoft Internet Explorer 4.0 或其后续版本的计算机上有效，并且在安装Excel时，需要选择数字签名一项。<br>从“开始”→“程序”→“Microsoft Office” →“Microsoft Office工具” →“VBA项目的数字证书”，在打开的窗口中输入的名称，这时已经完成数字证书的制作，如图 184 1所示。</p>
<p>图 184 1    制作数字证书<br>在Office的安装目录下双击文件“Selfcert.exe”，也可以制作数字证书。<br>当程序开发完成后，在VBE窗口中选择“工具”→“数字签名”，在如图 184 2所示的对话框中选择“选择”按钮，在显示的如图 184 3所示的对话框中选择新建的数字证书后按“确定”按钮后保存文件。</p>
<p>图 184 2    选择数字证书</p>
<p>图 184 3    选择证书<br>第一次打开含有数字签名的文件时，会显示如图 184 4所示的“安全警告”对话框。此时只需要选择“总是相信来自此发布者的宏”选项，这样只要是用此证书签名的文档都会被认为是可靠来源，以后不会再出现“安全警告”对话框。</p>
<p>图 184 4    安全警告对话框<br>如果在打开别人签名的文件时“总是相信来自此发布者的宏”选项为灰，只需选择“详细信息”，在显示的“数字签名详细信息”对话框的“常规”选项中选择“查看证书”，如图 184 5所示，然后在显示的“证书”对话框中选择“安装证书”即可，如图 184 6所示。</p>
<p>图 184 5    数字签名详细信息</p>
<p>图 184 6    安装证书<br>如果需要删除数字证书，可以打开IE属性对话框，在“内容”选项中选择“证书”，在显示的“证书”对话框中选择证书后删除，如图 184 7所示。</p>
<p>图 184 7    从证书管理器中删除数字证书<br>如果有些数字证书在IE属性对话框看不到，可以点击Windows的开始菜单，点击“运行”，键入“Regedit”，回车便打开了注册表编辑器。在“HKEY_CURRENT_USER\Software\Microsoft\SystemCertificates\”位置选择相应的选项删除即可，如图 184 8所示。</p>
<p>图 184 8    从注册表中删除数字证书</p>
<h3 id="技巧185-暂停代码的运行"><a href="#技巧185-暂停代码的运行" class="headerlink" title="技巧185     暂停代码的运行"></a>技巧185     暂停代码的运行</h3><p>在程序运行过程中，如果需要暂时停止宏代码的执行，可以使用Wait方法，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Activate()
    Dim i As Integer
    For i = 1 To 10
        Label1.Caption = &quot;这是个演示窗体,将在&quot; &amp; 11 - i &amp; &quot;秒后自动关闭!&quot;
        Application.Wait Now() + VBA.TimeValue(&quot;00:00:01&quot;)
        DoEvents
    Next
    Unload Me
End Sub
代码解析：
窗体的激活事件，使用Wait方法使窗体显示10秒后关闭。
第4行代码在窗体的标签中显示倒计时关闭的秒数。
第5行代码使用Wait方法使代码暂停运行1秒钟。应用于Application对象的Wait方法暂停运行宏，直到一特定时间才继续运行宏，语法如下：
Wait(Time)
参数Time是必需的，指定想要重新继续执行宏的时间点，以Microsoft Excel日期格式表示。
使用该方法将暂停Microsoft Excel的所有操作，但不影响后台操作，例如打印和重新计算。
第6行代码使用DoEvents函数转让控制权，更新标签中倒计时秒数。
运行窗体，标签中显示倒计时关闭的秒数并在10秒后关闭，如图 185 1所示。

图 185 1    暂停代码的运行</code></pre>
<p>使用Wait方法只能提供精度为1秒的延时，如果需要更低精度的延时，需要使用Sleep API函数，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Sub Sleep Lib &quot;kernel32&quot; (ByVal dwMilliseconds As Long)
Sub TypeDemo()
    Dim sTest As String
    Dim i As Integer
    sTest = &quot;这是Sleep API函数的一个简单演示。&quot;
    For i = 1 To Len(sTest)
        Range(&quot;A1&quot;).Value = Left(sTest, i)
        Sleep 200
    Next
End Sub
代码解析：
TypeDemo过程模拟打字效果在单元格A1中输入一行文字。
第1行代码Sleep API函数声明，参数dwMilliseconds为以毫秒为单位的时间长度。
在第6行到第9行代码在每次循环时增加显示的数据，并且在每次增加时使用Sleep语句延时200毫秒，好像字符逐个输入，从而达到模拟打字的效果。</code></pre>
<h3 id="技巧186-定时关机"><a href="#技巧186-定时关机" class="headerlink" title="技巧186     定时关机"></a>技巧186     定时关机</h3><p>在VBA中可以使用Shell函数执行Shutdown.exe程序实现定时关闭电脑，如下面的代码所示。</p>
<pre><code class="vb">Sub Shutdown()
    Shell (&quot;at 08:31 Shutdown.exe -s&quot;)
End Sub
代码解析：
Shutdown过程使用Shell函数在08:31时自动关闭电脑。Shell函数执行一个可执行文件，语法如下：
Shell(pathname[,windowstyle])
参数pathname是必需的，要执行的程序名，以及任何必需的参数或命令行变量，可能还包括目录或文件夹，以及驱动器。在Macintosh中，可以使用MacID函数来指定一个应用程序的署名而不是名称。表格 186 1列出了执行windows中常用程序的代码。
常用程序    代码
打开系统时间    &quot;Rundll32.exe Shell32.dll,Control_RunDLL Timedate.cpl&quot;
打开系统属性    &quot;control.exe sysdm.cpl&quot;
打开控制面板    &quot;control.exe&quot;
Internet 属性    &quot;control.exe inetcpl.cpl&quot;
显示属性    &quot;control.exe desk.cpl&quot;
调用计算器    &quot;calc.exe&quot;
调用画图    &quot;mspaint&quot;
表格 186 1    执行windows中常用程序的代码
参数windowstyle是可选的，表示在程序运行时窗口的样式。如果省略，则程序是以具有焦点的最小化窗口来执行的。windowstyle参数的值如表格 186 2所示。
常量    值    描述
vbHide    0    窗口被隐藏，且焦点会移到隐式窗口。
VbNormalFocus    1    窗口具有焦点，且会还原到它原来的大小和位置。
VbMinimizedFocus    2    窗口会以一个具有焦点的图标来显示。
VbMaximizedFocus    3    窗口是一个具有焦点的最大化窗口。
VbNormalNoFocus    4    窗口会被还原到最近使用的大小和位置，而当前活动的窗口仍然保持活动。
VbMinimizedNoFocus    6    窗口会以一个图标来显示。而当前活动的的窗口仍然保持活动。
表格 186 2    windowstyle参数值</code></pre>
<h3 id="技巧187-打开指定的网页"><a href="#技巧187-打开指定的网页" class="headerlink" title="技巧187     打开指定的网页"></a>技巧187     打开指定的网页</h3><p>使用VBA可以打开指定的网页，如下面的代码所示。</p>
<pre><code class="vb">Sub Hyperlink()
    ActiveWorkbook.FollowHyperlink _
        Address:=&quot;http://club.excelhome.net/dispbbs.asp&quot;, _
        NewWindow:=True
End Sub
代码解析：
Hyperlink过程使用FollowHyperlink方法打开Excel Home论坛的主页。
FollowHyperlink方法对指定超链接进行处理以下载目标文档，然后将该文档在适当的应用程序中显示出来，语法如下：
expression.FollowHyperlink(Address, SubAddress, NewWindow, AddHistory, ExtraInfo, Method, HeaderInfo)
其中参数expression是必需的，返回一个Workbook对象。
参数Address是必需的，String类型，目标文档的地址。
参数SubAddress是可选的，目标文档中的位置，默认值为空字符串。
参数NewWindow是可选的，Variant类型，如果该值为True，则将目标应用程序显示到一个新窗口中。默认值为False。
运行Hyperlink过程将打开Excel Home论坛的主页。</code></pre>
<h3 id="技巧188-VBE的操作"><a href="#技巧188-VBE的操作" class="headerlink" title="技巧188     VBE的操作"></a>技巧188     VBE的操作</h3><h4 id="188-1-添加模块和过程"><a href="#188-1-添加模块和过程" class="headerlink" title="188-1    添加模块和过程"></a>188-1    添加模块和过程</h4><p>在工作簿中添加新的模块和过程，除了使用手工添加的方法外，还可以采用程序的方式自动添加，如下面的代码所示。</p>
<pre><code class="vb">Sub NowModule()
    Dim VBC As VBComponent
    Set VBC = ThisWorkbook.VBProject.VBComponents _
        .Add(vbext_ct_StdModule)
    VBC.Name = &quot;NowModule&quot;
    With VBC.CodeModule
        If .Lines(1, 1) &lt;&gt; &quot;Option Explicit&quot; Then
            .InsertLines 1, &quot;Option Explicit&quot;
        End If
        .InsertLines 2, &quot;Sub Process1()&quot;
        .InsertLines 3, vbTab &amp; &quot;MsgBox &quot;&quot;这是第一个过程!&quot;&quot;&quot;
        .InsertLines 4, &quot;End Sub&quot;
        .AddFromString &quot;Sub Process2()&quot; &amp; Chr(13) &amp; vbTab _
            &amp; &quot;MsgBox &quot;&quot;这是第二个过程!&quot;&quot;&quot; &amp; Chr(13) &amp; &quot;End Sub&quot;
    End With
    Set VBC = Nothing
End Sub
代码解析：
NowModule过程在VBE中添加一个“NowModule”模块和两个过程。
第2行代码声明变量VBC为VBComponent对象。VBComponent对象代表一个包含在工程中的部件，例如类模块或标准模块。
第3、4行代码使用Add方法添加一个模块。应用于VBComponents集合的Add方法将一个对象添加到集合，语法如下：
object.Add(component)
参数object是必需的，一个有效的对象表达式。
参数component是必需的，对于VBComponents集合，则为表示类模块、窗体、标准模块的列举常数，如表格 188 1所示。
常数    值    描述
vbext_ct_StdModule    1    将标准模块添加到集合
vbext_ct_ClassModule    2    将一个类模块添加到集合
Vbext_ct_MSForm    3    将窗体添加到集合
表格 188 1    component参数值
第5行代码将新添加的模块重命名为“NowModule”。
第7行到第12行代码使用InsertLines方法在新添加的模块中插入过程“Process1”。应用于CodeModule对象的InsertLines方法在一个代码块的某个指定位置，插入一行或多行的代码，语法如下：
object.InsertLines(line, code)
参数object是必需的，一个有效的对象表达式。
参数line是必需的，Long型数据，用来指定要插入代码的位置。
参数code是必需的，String型数据，插入的代码。
其中第7行到第9行代码判断模块中首行代码是否为要求变量声明，如不是则添加要求变量声明语句。
第13、14行代码使用AddFromString方法在新添加的模块中插入过程“Process2”。应用于CodeModule对象的AddFromString方法将文本添加到模块，与InsertLines方法不同的是，所插入文本的位置始终在模块中的第一个过程之前，如果模块中没有包含过程则将插入的文本放置在模块的最后。
运行NowModule过程，在VBE中添加一个“NowModule”模块以及在模块中添加两个过程，如图 188 1所示。

图 188 1    添加模块和过程</code></pre>
<h4 id="188-2-建立事件过程"><a href="#188-2-建立事件过程" class="headerlink" title="188-2    建立事件过程"></a>188-2    建立事件过程</h4><p>在使用VBA代码添加工作表后，如果需要在新工作表中添加事件过程，可以使用技巧188-1中的添加代码的方法，但是事件过程一般包含参数，因此此方法容易出错，所以更好的方法是使用CreateEventProc方法，如下面的代码所示。</p>
<pre><code class="vb">Sub AddMatter()
    Dim Sh As Worksheet
    Dim i As Integer
    For Each Sh In Worksheets
        If Sh.Name = &quot;abc&quot; Then
            MsgBox &quot;工作簿中已有&quot;&quot;abc&quot;&quot;工作表,不能重复添加!&quot;
            Exit Sub
        End If
    Next
    Set Sh = Sheets.Add(After:=Sheets(Sheets.Count))
    Sh.Name = &quot;abc&quot;
    Application.VBE.MainWindow.Visible = True
    With ThisWorkbook.VBProject.VBComponents(Sh.CodeName).CodeModule
        i = .CreateEventProc(&quot;SelectionChange&quot;, &quot;Worksheet&quot;)
        .ReplaceLine i + 1, vbTab _
            &amp; &quot;MsgBox &quot;&quot;你选择了&quot;&quot; &amp; Target.Address(0, 0) &amp; &quot;&quot;单元格!&quot;&quot;&quot;
    End With
    Application.VBE.MainWindow.Visible = False
    Set Sh = Nothing
End Sub
代码解析：
AddMatter过程在工作簿中新建一张“abc”工作表，并在工作表的SelectionChange事件中写入事件代码。
第4行到第11行代码使用Add方法在工作簿中新建一张工作表，请参阅技巧25 。
第12行代码打开VBE窗口。
第14行代码使用CreateEventProc方法在新添加的工作表中创建“SelectionChange”过程并将起始行号赋给变量i。
应用于CodeModule对象的CreateEventProc方法创建一个事件过程，语法如下：
object.CreateEventProc(eventname, objectname) As Long
参数object是必需的，一个有效的对象表达式。
参数eventname是必需的，用来指定欲添加到模块的事件名称。
参数objectname是必需的，用来指定事件源的对象名称。
CreateEventProc方法创建成功则返回事件过程开始行的行号，其创建的过程只包含一个空行。
第15、16行代码使用ReplaceLine方法将空行替换为指定的代码。应用于CodeModule对象的ReplaceLine方法用特定的代码代替原代码，语法如下：
object.ReplaceLine(line, code)
参数object是必需的，一个有效的对象表达式。
参数line是必需的，用来指定所要代替的行号。
参数code是必需的，用来指定要插入的代码。
第18行代码关闭VBE窗口。
运行AddMatter过程在工作簿中新建一张“abc”工作表，并在工作表中写入事件代码，如图 188 2所示。

图 188 2     添加事件过程</code></pre>
<h4 id="188-3-模块的导入与导出"><a href="#188-3-模块的导入与导出" class="headerlink" title="188-3    模块的导入与导出"></a>188-3    模块的导入与导出</h4><p>在使用InsertLines方法和CreateEventProc方法在模块中插入代码，如果插入的代码量较大时，编写的代码会比较长，此时更好的方法是将代码直接导入到模块中，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyModule()
    Dim Nowbook As Workbook
    ThisWorkbook.VBProject.VBComponents(&quot;AddMatter&quot;).Export ThisWorkbook.Path &amp; &quot;\Tese.txt&quot;
    Set Nowbook = Workbooks.Add
    With Nowbook
        .SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;CopyModule.xls&quot;
        .VBProject.VBComponents.Import ThisWorkbook.Path &amp; &quot;\CopyModule.txt&quot;
        .Close Savechanges:=True
    End With
    Kill ThisWorkbook.Path &amp; &quot;\Tese.txt&quot;
End Sub
代码解析：
CopyModule过程将示例工作簿中的“AddMatter”模块导入到新建的工作簿“CopyModule.xls”中。
第3行代码使用Export方法将“AddMatter”模块导出为文本文件。应用于VBComponent 对象的Export方法将部件按文件进行保存，语法如下：
object.Export(filename)
参数object是必需的，一个有效的对象表达式。
参数filename是必需的，用来指定部件输出为文件的文件名称。
第4行代码使用Add方法创建一个工作簿。关于Add方法请参阅技巧41 。
第7行代码使用Import方法给新工作簿的VBA工程添加部件。Import方法从文件给工程添加部件，返回该被添加的新部件，语法如下：
object.Import(filename) As VBComponent
参数object是必需的，一个有效的对象表达式。
参数filename是必需的，用来指定欲添加部件的路径及文件名称。
第8行代码使用Close方法保存新建工作簿后关闭该工作簿。关于Close方法请参阅技巧48 。
第10行代码使用Kill方法删除导出的文本文件。关于Kill方法请参阅技巧178 。
运行CopyModule过程将创建新工作簿并把示例工作簿中的“AddMatter”模块导入到新工作簿中。</code></pre>
<h4 id="188-4-删除宏代码"><a href="#188-4-删除宏代码" class="headerlink" title="188-4    删除宏代码"></a>188-4    删除宏代码</h4><p>在将一个含有宏代码的工作簿拷贝给用户使用时，如果用户并不需要其中的宏代码，可以使用代码删除其中部分或全部的宏代码后再拷贝给用户使用，如下面的代码所示。</p>
<pre><code class="vb">Sub DelMacro()
    Dim Wb As Workbook
    Dim FileName As String
    Dim Vbc As VBComponent
    FileName = ThisWorkbook.Path &amp; &quot;\DelMacro.xls&quot;
    Application.EnableEvents = False
    Set Wb = Workbooks.Open(FileName)
    For Each Vbc In Wb.VBProject.VBComponents
        If Vbc.Type &lt;&gt; vbext_ct_Document Then
            If Vbc.Name = &quot;NowModule&quot; Then
                Vbc.CodeModule.DeleteLines 3, Vbc.CodeModule.CountOfLines - 4
            Else
                Wb.VBProject.VBComponents.Remove Vbc
            End If
        End If
    Next
    &#39;Wb.Close True
    Application.EnableEvents = True
End Sub
代码解析：
DelMacro过程删除“DelMacro.xls”工作簿中的部分宏代码。
第5行代码指定需要删除宏代码的工作簿。
第6行代码打开工作簿时禁止触发事件。
第7行代码使用Open方法打开指定工作簿。关于Open方法请参阅技巧42 。
第8行代码遍历指定工作簿中所有的VBA部件。
第9行代码保留Excel对象事件的代码。应用于VBComponent对象的Type属性返回对象的类型，常用的Type属性值如表格 188 2所示。
常数    值    描述
Vbext_ct_StdModule    1    标准模块
Vbext_ct_ClassModule    2    类模块
Vbext_ct_MSForm    3    用户窗体
Vbext_ct_Document    100    Excel对象
表格 188 2    VBComponent对象的Type属性值
第10、11行代码，如果模块名称是“NowModule”则删除其中指定行数代码。应用于CodeModule对象的DeleteLines方法删除一个单行或指定行范围的代码，语法如下：
object.DeleteLines (startline) [count]
参数object是必需的，一个有效的对象表达式。
参数startline是必需的，用来指定删除的开始行。
参数count是可选的，用来指定删除的行数。如果没有指定count参数，则只删除一行代码。
而应用于CodeModule对象的CountOfLines属性返回代码模块中的总行数。
第13行代码，如果不是需保留的项目全部则删除。应用于VBComponents集合的Remove方法从集合中删除项目，语法如下：
object.Remove(component)
参数object是必需的，一个有效的对象表达式。
参数component是必需的，对于VBComponents集合，代表一个类模块、一个窗体，或者是一个标准模块。
在示例所在文件夹中的“DelMacro.xls”工作簿的VBA项目中有两个模块、一个用户窗体及一个BeforeClose事件过程，运行DelMacro过程，只保留其中的BeforeClose事件过程和“NowModule”模块中的部分代码，其他的全部删除。
为了演示方便在“DelMacro.xls”工作簿的BeforeClose事件过程中将Saved属性设置为True使其关闭时不保存修改。在实际应用中应该在DelMacro过程的最后添加一行保存后关闭“DelMacro.xls”工作簿的代码：
Wb.Close True。
使用Close方法关闭“DelMacro.xls”工作簿，请参阅技巧45 。</code></pre>
<h3 id="技巧189-保护VBA代码"><a href="#技巧189-保护VBA代码" class="headerlink" title="技巧189     保护VBA代码"></a>技巧189     保护VBA代码</h3><p>VBA项目的源代码是完全开放的，如果不希望其他人看到源代码，可以使用以下两种方法将代码保护起来。</p>
<h4 id="189-1-设置工程密码"><a href="#189-1-设置工程密码" class="headerlink" title="189-1    设置工程密码"></a>189-1    设置工程密码</h4><p>设置VBA工程的密码，只有在输入正确密码后才能看到源代码。<br>在VBE窗口中单击菜单“工具”→“VBAProject属性”，在显示的如图 189 1所示的“VBAProject—工程属性”对话框的“保护”选项卡中选中“查看时锁定工程”复选框，并在“密码”文本框和“确认密码”文本框中输入密码后单击“确定”按钮关闭该对话框，保存并关闭文件。</p>
<p>图 189 1    “VBAProject—工程属性”对话框<br>密码保护完成后，当试图打开该工程时会显示“VBAProject密码”的对话框，如图 189 2所示。只有在输入正确的密码后才能看到该工程的源代码。</p>
<p>图 189 2    密码输入对话框</p>
<h4 id="189-2-设置“工程不可查看”"><a href="#189-2-设置“工程不可查看”" class="headerlink" title="189-2    设置“工程不可查看”"></a>189-2    设置“工程不可查看”</h4><p>使用“保护并共享工作簿”功能将工程设置为不可查看。<br>在Excel中选择菜单“工具”→“保护”→“保护并共享工作簿”，在显示的如图 189 3所示的“保护并共享工作簿”对话框中选中“以追踪修订方式共享”复选框，激活对话框中灰色的输入密码区域，在“密码”文本框中输入密码后单击“确定”按钮。</p>
<p>图 189 3    “保护并共享工作簿”对话框<br>在显示的“确认密码”对话框中再次输入密码后单击“确定”按钮，如图 189 4所示。</p>
<p>图 189 4    “确认密码”对话框<br>此时系统会显示如图 189 5所示的“此操作将导致保存文档。是否继续？”的对话框。</p>
<p>图 189 5    询问对话框<br>单击“确定”按钮后在显示的如图 189 6所示的对话框中单击“确定”按钮即可。</p>
<p>图 189 6    警告对话框<br>完成设置后当在VBE中查看工程时则会出现一个“工程锁定”的对话框，提示“工程不可查看”，如图 189 7所示。</p>
<p>图 189 7    “工程锁定”对话框<br>如果需要取消“工程不可查看”只需在Excel中选择菜单“工具”→“保护”→“撤消对共享工作簿的保护”，在显示的“取消共享保护”对话框中需要输入正确的密码中单击“确定”按钮即可，如图 189 8所示。</p>
<p>图 189 8    “取消共享保护”对话框</p>
<h3 id="技巧190-优化代码"><a href="#技巧190-优化代码" class="headerlink" title="技巧190     优化代码"></a>技巧190     优化代码</h3><h4 id="190-1-关闭屏幕刷新"><a href="#190-1-关闭屏幕刷新" class="headerlink" title="190-1    关闭屏幕刷新"></a>190-1    关闭屏幕刷新</h4><p>在使用代码改变工作表的显示内容或格式时关闭屏幕刷新可以加快运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Screen()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    Application.ScreenUpdating = False
    t = Timer
    For i = 1 To 30000
        Cells(1, 1) = i
    Next
    t1 = Timer - t
    Application.ScreenUpdating = True
    t = Timer
    For i = 1 To 30000
        Cells(1, 1) = i
    Next
    t2 = Timer - t
    MsgBox &quot;关闭屏幕刷新运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;开启屏幕刷新运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
Screen过程使用两次For...Next语句给A1单元格填充数据，最后使用消息框显示两次运行的时间。在第一次循环时关闭屏幕刷新，应用于Application对象的ScreenUpdating属性设置屏幕刷新功能是否打开，设置为False关闭屏幕刷新，将看不到代码的执行过程，但可以加快代码的运行速度。
运行Screen过程，消息框显示两次代码的运行时间，可以看出关闭屏幕刷新后运行时间远远小于开启屏幕刷新时运行的时间，如图 190 1所示。

图 190 1    运行时间比较</code></pre>
<h4 id="190-2-使用工作表函数"><a href="#190-2-使用工作表函数" class="headerlink" title="190-2    使用工作表函数"></a>190-2    使用工作表函数</h4><p>在VBA中使用工作表函数比仅仅使用VBA代码的运行时间要快得多，如下面的代码所示。</p>
<pre><code class="vb">Sub ShFunction()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    Range(&quot;B1:B2&quot;).ClearContents
    Application.ScreenUpdating = False
    t = Timer
    For i = 1 To 30000
        Cells(1, 2) = Cells(1, 2) + Cells(i, 1)
    Next
    t1 = Timer - t
    t = Timer
    Cells(2, 2) = Application.WorksheetFunction.Sum(Range(&quot;A1:A30000&quot;))
    t2 = Timer - t
    Application.ScreenUpdating = True
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
ShFunction过程分别使用VBA代码和调用工作表Sum函数对单元格区域进行求和计算，最后使用消息显示运行时间。
第9行到第11行代码使用VBA的累加方法计算单元格A1：A30000的和。
第14行代码调用工作表Sum函数计算单元格A1：A30000的和。VBA中调用工作表函数请参阅技巧153 。
运行ShFunction过程，消息框显示两种方法的运行时间，可以看出调用工作表函数进行计算的运行时间要远远小于使用累加方法运行的时间，如图 190 2所示。

图 190 2    运行时间比较</code></pre>
<h4 id="190-3-使用更快的单元格操作方法"><a href="#190-3-使用更快的单元格操作方法" class="headerlink" title="190-3    使用更快的单元格操作方法"></a>190-3    使用更快的单元格操作方法</h4><p>在对单元格区域进行操作时，使用Find、Replace、SpecialCells等方法可以比使用VBA代码获得更快的速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Methods()
    Dim arr As Variant
    Dim i As Long
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    With Range(&quot;A1:A20000&quot;)
        arr = .Value
        t = Timer
        For i = 20000 To 1 Step -1
            If Cells(i, 1) = &quot;Excel&quot; Then
                Cells(i, 1).EntireRow.Delete
            End If
        Next
        t1 = Timer - t
        .Value = arr
        t = Timer
        .Replace &quot;Excel&quot;, &quot;&quot;
        .SpecialCells(4).EntireRow.Delete
    End With
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
Methods过程分别使用VBA代码和使用Replace、SpecialCells方法删除工作表A列内容为“Excel”的单元格所在的行，最后使用消息显示运行时间。
第8行代码将单元格数据保存在数组arr中，因为在运行第2种方法前需要恢复单元格数据。
第10行到第14行代码，采用遍历单元格的方法删除内容为“Excel”的单元格所在的行。
第16行代码恢复单元格原有的数据。
第18行代码使用Replace方法将内容为“Excel”的单元格替换成空白单元格。
第19行代码使用SpecialCells方法定位到空白单元格后一次性删除其所在的行。
关于Replace方法和SpecialCells方法请参阅技巧33 。
运行Methods过程，消息框显示两种方法的运行时间，可以看出使用Replace方法和SpecialCells方法的运行时间要远远小于使用VBA代码运行的时间，如图 190 3所示。

图 190 3    运行时间比较</code></pre>
<h4 id="190-4-使用With语句引用对象"><a href="#190-4-使用With语句引用对象" class="headerlink" title="190-4    使用With语句引用对象"></a>190-4    使用With语句引用对象</h4><p>在需要重复引用同一个对象时可以使用With语句来获得较快的运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub WithSta()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet1&quot;).Cells(1, 1) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 2) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 3) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 4) = 10
        Sheets(&quot;Sheet1&quot;).Cells(1, 5) = 10
    Next
    t1 = Timer - t
    t = Timer
    With Sheets(&quot;Sheet1&quot;)
        For i = 1 To 5000
            .Cells(1, 1) = 10
            .Cells(1, 2) = 10
            .Cells(1, 3) = 10
            .Cells(1, 4) = 10
            .Cells(1, 5) = 10
        Next
    End With
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
WithSta过程在单元格填充时使用With语句来引用工作表对象从而获得较快的运行速度。
With语句在一个单一对象或一个用户定义类型上执行一系列的语句，语法如下：
With Object
    [statements]
End With
参数object是必需的，一个对象或用户自定义类型的名称。
参数statements是可选的，要执行的一条或多条语句。
With语句可以对某个对象执行一系列的语句，而不用重复指出对象的名称。在运行时只需引用对象一次而不是在每个属性赋值时都要引用，从而获得较快的运行速度。
运行WithSta过程，消息框显示两种方法的运行时间，可以看出使用With语句来引用工作表对象的运行速度较快，如图 190 4所示。

图 190 4    运行时间比较</code></pre>
<h4 id="190-5-少用激活或选择语句"><a href="#190-5-少用激活或选择语句" class="headerlink" title="190-5    少用激活或选择语句"></a>190-5    少用激活或选择语句</h4><p>在学习VBA的过程中我们经常通过录制新宏的方法来获得所需的代码，但是在录制宏的过程中会记录所有的动作，代码中有大量的Select和Activate语句，而这些代码往往是不必要而且会影响代码的运行速度。所以通过录制新宏的方法获得的代码在使用时需要进行修改以加快运行速度，如下面的代码所示。</p>
<pre><code class="vb">Sub Sta()
    Dim i As Integer
    Dim t As Date
    Dim t1 As String
    Dim t2 As String
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet2&quot;).Select
        Range(&quot;A1&quot;).Select
        ActiveCell.FormulaR1C1 = &quot;1&quot;
    Next
    t1 = Timer - t
    t = Timer
    For i = 1 To 5000
        Sheets(&quot;Sheet2&quot;).Range(&quot;A1&quot;) = 1
    Next
    t2 = Timer - t
    MsgBox &quot;第一次运行时间:&quot; &amp; Format(t1, &quot;0.00000&quot;) &amp; &quot;秒&quot; _
         &amp; Chr(13) &amp; &quot;第二次运行时间:&quot; &amp; Format(t2, &quot;0.00000&quot;) &amp; &quot;秒&quot;
End Sub
代码解析：
Sta过程分别使用录制宏所得的代码和修改后的代码给单元格填充，最后使用消息显示运行时间。
第8行代码到第10行代码是录制宏所得的代码，其中有两次使用Select方法，第15行代码是修改后的代码，在代码量不大的情况下运行速度区别不大，但是在循环5000次后运行速度就会差别很大。
运行Sta过程，消息框显示两种方法的运行时间，可以看出后一种方法的运行时间要远远小于录制宏所得的代码的运行时间，如图 190 5所示。

图 190 5    运行时间比较</code></pre>
<h3 id="技巧191-取得文件的基本名称"><a href="#技巧191-取得文件的基本名称" class="headerlink" title="技巧191     取得文件的基本名称"></a>技巧191     取得文件的基本名称</h3><p>技巧77-2中介绍了如何使用Excel内置的“打开”对话框来获得选定文件的文件名称，此名称包含文件路径及文件扩展名，有时在操作时只需要文件的基本名称，此时可以使用GetBaseName方法，如下面的代码所示。</p>
<pre><code class="vb">Sub GetName()
    Dim MyFile As Object
    Dim Filename As Variant
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    Filename = Application.GetOpenFilename
    If Filename &lt;&gt; False Then
        MsgBox MyFile.GetBaseName(Filename)
    End If
End Sub
代码解析：
GetName过程取得用户选定文件的基本文件名称。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile，请参阅技巧180 。
第5行代码使用GetOpenFilename方法显示标准的内置“打开”对话框，请参阅技巧77-2。
第6行到第8行代码，如果用户选定了文件，使用消息框显示选定文件的基本名称。应用于FileSystemObject对象的GetBaseName方法返回一个包含路径中最后部件的基本名字（去掉任何文件扩展名）的字符串，语法如下：
object.GetBaseName(path)
参数object是必需的，FileSystemObject对象的名称。
参数path是必需的，要返回其基本名字的部件的路径说明。
注意   GetBaseName方法只对参数path提供的字符串起作用，既不试图去辨认路径，也不检查指定路径是否存在。
运行GetName过程，在打开对话框中选定示例文件后结果如图 191 1所示。

图 191 1    取得文件的基本名称</code></pre>
<h3 id="技巧192-防止用户中断代码运行"><a href="#技巧192-防止用户中断代码运行" class="headerlink" title="技巧192     防止用户中断代码运行"></a>技巧192     防止用户中断代码运行</h3><p>在使用VBA开发的程序交予用户使用后，如果在运行需要长时间执行的宏代码时，用户在代码运行期间按下了<esc>键或者&lt;Ctrl+Break&gt;组合键，会显示如图 192 1所示的消息框。</esc></p>
<p>图 192 1    代码中断消息框<br>此时单击“继续”按钮将继续执行代码，单击“结束”按钮结束过程，单击“调试”按钮进入中断模式，这显然不是用户所希望出现的，此时需要使用Application对象的EnableCancelKey属性来进行控制，如下面的代码所示。</p>
<pre><code class="vb">Sub EnablEsc()
    Dim i As Integer
    Application.EnableCancelKey = xlDisabled
    For i = 1 To 2000
        Cells(1, 1) = i
    Next
End Sub
代码解析：
EnablEsc过程在代码运行期间禁用“取消”键的捕获功能。
应用于Application对象的EnableCancelKey属性控制将用户中断用于运行程序的处理，语法如下：
expression.EnableCancelKey
参数是expression必需的，Application对象。
EnableCancelKey属性值为表格 192 1所示的XlEnableCancelKey常量之一。
常量    值    描述
xlDisabled    0    完全禁用“取消”键捕获功能
xlErrorHandler    2    将中断作为错误信号传递给运行程序，由 On Error GoTo 语句设置的错误处理程序捕获。可捕获的错误代码为 18
xlInterrupt    1    中断当前运行程序，用户可进行调试或结束程序的运行
表格 192 1    XlEnableCancelKey常量
只要Microsoft Excel返回空闲状态并且没有程序处于运行状态，EnableCancelKey属性都会重置为xlInterrupt。若要在程序运行中捕获或者禁用取消过程，则每次在程序被调用时必须明确更改EnableCancelKey属性。
### 技巧193     加班费计算表
财务人员在工作中经常需要计算职工的加班费，在计算过程中需要根据职工的技能工资、岗位工资之和除以21天得到日工资标准，再根据当月的加班天数乘以相应的系数才能计算出加班费总额，计算时非常的烦琐，很不方便。使用Excel制作的加班费计算表可以很方便的计算职工的加班费。
步骤1，新建工作簿，将Sheet2工作表重命名为“人员信息”，在第一行中写入所需信息的字段名称，如图 193 1所示。

图 193 1    人员信息表</code></pre>
<p>步骤2，所需的人员信息无需在工作表中一一输入，前四个可以从工资软件中导出的文本文件中获取，后两个可以使用代码自动生成。在VBE窗口中插入模块，写入下面的代码。</p>
<pre><code class="vb">Sub ImportWages()
    Dim GetName As Variant
    Dim TxtPath As String
    Dim TxtName As String
    Dim Tbtext As String
    Dim sField As String
    Dim Cnn As ADODB.Connection
    Dim rs As New ADODB.Recordset
    Dim r As Integer
    Dim i As Integer
    Dim b As Integer
    Dim StrName As String
    If MsgBox(&quot;是否重新导入工资表数据?&quot;, vbQuestion + vbYesNo, &quot;系统提示&quot;) = vbNo Then: Exit Sub
    On Error GoTo line
    GetName = Application.GetOpenFilename(Title:=&quot;导入工资&quot;, fileFilter:=&quot;All files (*.*),*.*&quot;)
    With Sheet2
        .Select
        .Unprotect
        If GetName &lt;&gt; False Then
            TxtPath = CreateObject(&quot;Scripting.FileSystemObject&quot;).GetParentFolderName(GetName)
            TxtName = CreateObject(&quot;Scripting.FileSystemObject&quot;).GetFileName(GetName)
            Tbtext = &quot; [Text;DATABASE=&quot; &amp; TxtPath &amp; &quot;].&quot; &amp; TxtName
            Set Cnn = New ADODB.Connection
            Cnn.Open &quot;provider=microsoft.jet.oledb.4.0;extended properties=&#39;excel 8.0;hdr=yes&#39;;data source=&quot; &amp; ThisWorkbook.FullName
            rs.Open &quot;select 人员编号,姓名,技能工资,岗位工资 from &quot; &amp; Tbtext, Cnn
            r = .Range(&quot;A65536&quot;).End(xlUp).Row
            If r &gt;= 3 Then .Range(&quot;A3:F&quot; &amp; r).ClearContents
            .Range(&quot;A3&quot;).CopyFromRecordset rs
            r = .Range(&quot;A65536&quot;).End(xlUp).Row
            .Range(&quot;A&quot; &amp; r &amp; &quot;:F&quot; &amp; r).ClearContents
            For i = 3 To r
                StrName = &quot;&quot;
                For b = 1 To Len(.Cells(i, 2))
                    If Asc(Mid$(.Cells(i, 2), b, 1)) &gt; 255 Or Asc(Mid$(.Cells(i, 2), b, 1)) &lt; 0 Then
                        StrName = StrName &amp; LChin(Mid$(.Cells(i, 2), b, 1))
                    Else
                        StrName = StrName &amp; LCase(Mid$(.Cells(i, 2), b, 1))
                    End If
                Next b
                .Cells(i, 5) = Round((Val(.Cells(i, 3)) + Val(.Cells(i, 4))) / 21, 2)
                .Cells(i, 6) = StrName
            Next i
        End If
        .Protect
    End With
    Exit Sub
line:
    MsgBox &quot;请选择正确的文本文件!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
ImportWages过程从工资软件导出的文本文件中导入人员的工资信息并计算日工资、生成助记码。
第13行代码，确认是否需要重新导入工资信息。
第14行代码，错误处理语句。在第25行代码中，如果打开的文件不是从工资软件中导出的文本文件，会因找不到所查询的字段名称而发生错误。
第15行代码，使用GetOpenFilename方法显示“打开”对话框，用来获得从工资软件中导出的文本文件的文件路径。关于GetOpenFilename方法请参阅77-2。
第18行代码，取消Sheet2表的工作表保护。
第19行到第21行代码，如果在“打开”对话框中选择了文件并按下了“打开”按钮使用GetParentFolderName方法将返回的路径中的文件路径赋给字符串变量TxtPath，使用GetFileName方法将返回的路径中的包含扩展名的文件名称赋给字符串变量TxtName。关于FileSystemObject对象的一些方法请参阅技巧180 。
第22行到第25行代码，使用ADO语句从选择文本文件中查询需要的数据。其中第25行代码设置需查询数据的字段名称。
第26、27行代码，使用ClearContents方法清除表中原来的数据。
第28行代码，将查询到数据写入到工作表中。
第29、30行代码，使用ClearContents方法清除导入数据的最后一行，即最后的合计行。
第31行到第39行代码，根据B列中的人员姓名生成助记码，方便在使用时输入人员姓名。请参阅技巧114 。
第40行代码，根据C列的技能工资和D列的岗位工资计算日工资标准并写入到E列中。
第41行代码，将生成的人员姓名助记码写入到F列中。
第44行代码，使用Protect方法保护Sheet2表。
第48行代码，如果文件选择错误，使用消息框进行提示。
运行ImportWages过程将显示一个“打开”对话框用来获得需打开的工资表文件的路径及文件名称，如图 193 2所示。

图 193 2    “打开”对话框
当选择好最新的工资表文件后单击“打开”按钮，将最新的工资数据导入到Sheet2表中，如图 193 3所示。

图 193 3    导入工资数据</code></pre>
<p>在ImportWages过程的第35行代码使用自定义LChin函数将中文字符转换为拼音首字母，需要在模块中写入下面的代码。</p>
<pre><code class="vb">Public Function LChin(Str As String) As Variant
    On Error Resume Next
    Str = StrConv(Str, vbNarrow)
    If Asc(Str) &gt; 0 Or Err.Number = 1004 Then LChin = &quot;&quot;
    LChin = WorksheetFunction.VLookup(Str, [{&quot;吖&quot;,&quot;a&quot;;&quot;八&quot;,&quot;b&quot;;&quot;嚓&quot;,&quot;c&quot;;&quot;咑&quot;,&quot;d&quot;;&quot;鵽&quot;,&quot;e&quot;;&quot;发&quot;,&quot;f&quot;;&quot;猤&quot;,&quot;g&quot;;&quot;铪&quot;,&quot;h&quot;;&quot;夻&quot;,&quot;j&quot;;&quot;咔&quot;,&quot;k&quot;;&quot;垃&quot;,&quot;l&quot;;&quot;嘸&quot;,&quot;m&quot;;&quot;旀&quot;,&quot;n&quot;;&quot;噢&quot;,&quot;o&quot;;&quot;妑&quot;,&quot;p&quot;;&quot;七&quot;,&quot;q&quot;;&quot;囕&quot;,&quot;r&quot;;&quot;仨&quot;,&quot;s&quot;;&quot;他&quot;,&quot;t&quot;;&quot;屲&quot;,&quot;w&quot;;&quot;夕&quot;,&quot;x&quot;;&quot;丫&quot;,&quot;y&quot;;&quot;帀&quot;,&quot;z&quot;}], 2)
#006  End Function
关于拼音首字母的转化请参阅技巧114 中的相关内容。
步骤3，将Sheet1工作表重命名为“加班费计算”并设置成如图 193 4所示。

图 193 4    加班费计算
步骤4，为了方便输入人员姓名，需要输入时能逐步提示信息，而工作表的单元格处于编辑状态时是无法运行宏代码，所以需要在Sheet1表中添加一个文本框控件和一个列表框控件，文本框用来代替单元格进行输入，列表框显示提示的信息。</code></pre>
<p>为了使文本框控件和列表框控件只有在需要输入人员姓名时显示，在Sheet1表写入下面的代码。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim i As Integer
    Dim r As Integer
    Dim arr As Variant
    r = Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row
    If Target.Count = 1 Then
        If Target.Column = 2 And Target.Row &gt; 4 And Target.Row &lt; r Then
            If Target.Row = r - 1 Then
                Sheet1.Unprotect
                Rows(r).Insert Shift:=xlDown
                Sheet1.Protect
            End If
            With Me.TextBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Left
                .Width = Target.Width
                .Height = Target.Height
            End With
            With Me.ListBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Offset(, 1).Left
                .Width = 80
                .Height = Target.Height * 8
                .ColumnCount = 2
                .ColumnWidths = &quot;30,45&quot;
                arr = Sheet2.Range(&quot;A3:B&quot; &amp; Sheet2.[B63556].End(xlUp).Row)
                .Column = Application.WorksheetFunction.Transpose(arr)
            End With
        Else
            Me.ListBox1.Clear
            Me.TextBox1 = &quot;&quot;
            Me.ListBox1.Visible = False
            Me.TextBox1.Visible = False
        End If
    End If
End Sub
代码解析：
工作表的SelectionChange事件，当选择工作表的B列单元格时显示文本框控件和列表框控件供输入人员姓名。请参阅技巧114 中的相关内容。
当选择Sheet1表的B列单元格时效果如图 193 5所示。

图 193 5    人员选择</code></pre>
<p>为了输入时能逐步提示信息，在文本框控件和列表框控件中写入下面的代码。</p>
<pre><code class="vb">Private Sub TextBox1_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim i As Integer
    Dim Language As String
    Dim myStr As String
    Me.ListBox1.Clear
    With Me.TextBox1
        For i = 1 To Len(.Value)
            Select Case Asc(Mid$(.Value, i, 1))
                Case 48 To 56
                    Language = &quot;S&quot;
                    myStr = myStr &amp; Mid$(.Value, i, 1)
                Case Is &lt; 0, Is &gt; 255
                    Language = &quot;Z&quot;
                    myStr = myStr &amp; Mid$(.Value, i, 1)
                Case Else
                    Language = &quot;P&quot;
                    myStr = myStr &amp; LCase(Mid$(.Value, i, 1))
            End Select
        Next
    End With
    With Sheet2
        For i = 3 To .Range(&quot;A65536&quot;).End(xlUp).Row
            Select Case Language
                Case &quot;S&quot;
                    If Left(.Cells(i, 1).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
                Case &quot;Z&quot;
                    If Left(.Cells(i, 2).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
                Case Else
                    If Left(.Cells(i, 6).Value, Len(myStr)) = myStr Then
                        Me.ListBox1.AddItem
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 0) = .Cells(i, 1).Value
                        Me.ListBox1.List(Me.ListBox1.ListCount - 1, 1) = .Cells(i, 2).Value
                    End If
            End Select
        Next
    End With
End Sub
代码解析：
文本框的KeyUp事件，在文本框中输入姓名时根据输入的内容进行逐步提示，可以使用三种方法进行输入，人员编号、中文字符和拼音首字母。
第7行到第19行代码，使用字符串变量Language保存输入的方式，字符串变量myStr保存输入的内容。
第21行到第42行代码，根据输入方法的不同，在Sheet2表的不同列中查找符合字符串变量myStr的单元格，并赋给列表框控件。</code></pre>
<pre><code class="vb">Private Sub TextBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = vbKeyReturn Then
        Sheet1.ListBox1.Activate
    End If
End Sub
代码解析：
文本框的KeyDown事件，在文本框中输入查询条件，当列表框中出现符合条件的数据后按回车键后选择列表框，方便输入。</code></pre>
<pre><code class="vb">Private Sub ListBox1_GotFocus()
    On Error Resume Next
    ListBox1.ListIndex = 0
End Sub
代码解析：
列表框的GotFocus事件，当列表框激活后选择第一条条目，以便用户按上下键进行选择或按回车键后输入到工作表中。</code></pre>
<pre><code class="vb">#Private Sub ListBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    On Error Resume Next
    If KeyCode = vbKeyReturn Then
        Sheet1.Unprotect
        ActiveCell.Value = Me.ListBox1.Column(1)
        ActiveCell.Offset(, -1).Value = Me.ListBox1.Column(0)
        Me.ListBox1.Clear
        Me.TextBox1 = &quot;&quot;
        Me.ListBox1.Visible = False
        Me.TextBox1.Visible = False
        Sheet1.Protect
    End If
End Sub
代码解析：
列表框的KeyDown事件，按回车键后将列表框中选择的条目输入到工作表中，并清除文本框和列表框的内容后隐藏，以便下一次输入。</code></pre>
<pre><code class="vb">Private Sub ListBox1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    On Error Resume Next
    Sheet1.Unprotect
    ActiveCell.Value = Me.ListBox1.Column(1)
    ActiveCell.Offset(, -1).Value = Me.ListBox1.Column(0)
    Me.ListBox1.Clear
    Me.TextBox1 = &quot;&quot;
    Me.ListBox1.Visible = False
    Me.TextBox1.Visible = False
    Sheet1.Protect
End Sub
代码解析：
列表框的DblClick事件，双击列表框中选择的条目，输入到工作表中，并清除文本框和列表框的内容后隐藏，以便下一次输入。输入时逐步提示信息请参阅技巧114 。
步骤5，为了在输入人员姓名后在Sheet1工作表的C列中写入相应的日工资标准，在Sheet1工作表的写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Dim rng As Range
    Dim r As Integer
    On Error Resume Next
    With Target
        If .Row &gt; 4 And .Count = 1 Then
            If .Column = 1 Then
                r = Sheet2.Range(&quot;A63556&quot;).End(xlUp).Row
                For Each rng In Sheet2.Range(&quot;A3:A&quot; &amp; r)
                    If rng.Text Like .Text Then
                        .Offset(, 2).Value = rng.Offset(, 4).Value
                    End If
                Next
            End If
            If .Column = 2 Then
                If .Text = &quot;&quot; Then
                    Application.EnableEvents = False
                    Sheet1.Unprotect
                    Rows(.Row).Delete
                    Sheet1.Protect
                    Application.EnableEvents = True
                End If
            End If

        End If
    End With
End Sub
代码解析：
Sheet1工作表的Change事件，当输入人员编号和人员姓名后，将对应的日工资标准写入到Sheet1工作表的C列中。
第6行代码设置事件的触发条件。
第7行到第14行代码，删除B列单元格中的人员姓名则同时删除对应的人员编号和日工资标准。
第18行到第29行代码，检查输入的人员姓名是否重复。因为单位中可能有重复的人员姓名，但是人员编号是唯一的，所以根据人员编号检查输入的人员姓名是否重复。
第30行到第34行代码，使用Like方法在根据人员编号在Sheet2表的A列中查找相对应的人员编号，找到后将日工资标准写入到Sheet1工作表的C列中。
在Sheet1工作表的B列中输入人员姓名后效果如图 193 6所示。

图 193 6    写入日工资标准</code></pre>
<p>步骤6，在某些情况下，可能需要输入全部人员的姓名，比如在笔者单位每年的7、8月份要发放高温加班工资，这时可以从Sheet2表中将所有人员的姓名和编号导入到Sheet1表中，需要在模块中写入下面的代码。</p>
<pre><code class="vb">Sub ImportName()
    Dim r1 As Integer
    Dim r2 As Integer
    Dim i As Long
    r1 = Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row
    r2 = Sheet2.Range(&quot;B63556&quot;).End(xlUp).Row
    If MsgBox(&quot;确定要导入所有人员姓名吗&quot;, 32 + vbYesNo, &quot;系统提示&quot;) = vbNo Then Exit Sub
    Application.ScreenUpdating = False
    With Sheet1
        .Select
        .Unprotect
        If r1 &lt;= r2 + 3 Then .Rows(r1).Resize(r2 - r1 + 4).Insert
        For i = 5 To Sheet1.Range(&quot;B63556&quot;).End(xlUp).Row - 2
            .Cells(i, 1) = Sheet2.Cells(i - 2, 1)
            .Cells(i, 2) = Sheet2.Cells(i - 2, 2)
        Next
        .Protect
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
ImportName过程将Sheet2工作表的人员姓名导入到Sheet1工作表的B列单元格中。
第5、6行代码，取得两个工作表中现有数据的行号。
第12行代码，根据两个工作表中现有数据的行号决定在到Sheet1工作表需要插入的行数。
第13行第16行代码，将Sheet2工作表的人员编号和人员姓名导入到Sheet1工作表的B列单元格中，因为在写入的过程中同时会触发工作表的Change事件，所以日工资标准无需导入。
如果有少量不需要计算的人员姓名可以在导入后删除。</code></pre>
<p>步骤7，如果在输入时Sheet1工作表中已有数据，可以先进行清除，在模块中写入下面的代码。</p>
<pre><code class="vb">Sub DataClear()
    Dim r As Integer
    With Sheet1
        .Select
        If MsgBox(&quot;是否清除加班费数据?&quot;, 32 + vbYesNo, &quot;系统提示&quot;) = vbNo Then Exit Sub
        .Unprotect
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        If r &gt;= 6 Then
            .Rows(&quot;5:&quot; &amp; r - 2).Delete
        End If
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        Union(.Cells(2, 12), .Range(.Cells(r, 5), .Cells(r, 12))).ClearContents
        .Protect
        Application.GoTo Reference:=.Cells(5, 4), Scroll:=True
    End With
End Sub
代码解析：
DataClear过程清除计算表中已有的数据。</code></pre>
<p>步骤8，在VBE中插入一个窗体，用于计算加班费时选择计算的月份并对Sheet2表的D、F、H和J列中输入的加班班数计算应发的加班费合计，如图 193 7所示。</p>
<p>图 193 7    计算加班费窗体<br>双击窗体写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    SpinButton1.Value = Year(Date)
    SpinButton2.Value = Month(Date)
    TextBox1.Text = Year(Date) &amp; &quot;年&quot;
    TextBox2.Text = Month(Date) &amp; &quot;月份&quot;
End Sub
代码解析：
窗体的Initialize事件，在窗体初始化时文本框中显示当前的年月。</code></pre>
<p>双击窗体中的SpinButton控件，写入下面的代码。</p>
<pre><code class="vb">Private Sub SpinButton1_Change()
    TextBox1.Text = SpinButton1.Value &amp; &quot;年&quot;
End Sub
Private Sub SpinButton2_Change()
    With SpinButton2
        Select Case .Value
            Case 1 To 12
                TextBox2.Text = .Value &amp; &quot;月份&quot;
            Case Is &gt; 12
                TextBox1.Text = Left(TextBox1.Text, 4) + 1 &amp; &quot;年&quot;
                .Value = 1
            Case Is &lt; 1
                TextBox1.Text = Left(TextBox1.Text, 4) - 1 &amp; &quot;年&quot;
                .Value = 12
        End Select
    End With
End Sub
代码解析：
使用SpinButton控件调节窗体中显示的年月，请参阅技巧140 。</code></pre>
<p>双击窗体中的“确定”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim r As Integer
    With Sheet1
        .Select
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        If .Cells(5, 2) = &quot;&quot; Then
            MsgBox &quot;请把数据填写完整后再计算!&quot;, 64, &quot;系统提示&quot;
            Unload Me
            Exit Sub
        End If
        For i = 5 To r - 2
            If WorksheetFunction.CountIf(.Range(&quot;B5:B&quot; &amp; i), .Cells(i, 2)) &gt; 1 Then
                If MsgBox(.Cells(i, 2) &amp; &quot;输入重复,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
                    Unload Me
                    Exit Sub
                End If
            End If
        Next
        .Unprotect
        .Cells(2, 12) = TextBox2.Text
        For i = 5 To r - 1
            .Cells(i, 5) = Round(100 * .Cells(i, 4), 2)
            .Cells(i, 7) = Round(.Cells(i, 3) * 1.5 * .Cells(i, 6), 2)
            .Cells(i, 9) = Round(.Cells(i, 3) * 2 * .Cells(i, 8), 2)
            .Cells(i, 11) = Round(.Cells(i, 3) * 3 * .Cells(i, 10), 2)
            .Cells(i, 12) = .Cells(i, 5) + .Cells(i, 7) + .Cells(i, 9) + .Cells(i, 11)
        Next
            .Cells(r, 5) = WorksheetFunction.Sum(.Range(&quot;E5:E&quot; &amp; r - 1))
            .Cells(r, 7) = WorksheetFunction.Sum(.Range(&quot;G5:G&quot; &amp; r - 1))
            .Cells(r, 9) = WorksheetFunction.Sum(.Range(&quot;I5:I&quot; &amp; r - 1))
            .Cells(r, 11) = WorksheetFunction.Sum(.Range(&quot;K5:K&quot; &amp; r - 1))
            .Cells(r, 12) = WorksheetFunction.Sum(.Range(&quot;L5:L&quot; &amp; r - 1))
        .Protect
    End With
    Unload Me
    MsgBox TextBox1.Text &amp; TextBox2.Text &amp; &quot;的加班费已计算完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
窗体中的“确定”按钮的Click事件过程，计算Sheet1表中的加班费合计。
第7行到第11行代码，检查Sheet1表中是否已输入人员姓名及加班班数。
第12行到第19行代码，检查Sheet1表中的人员编号是否重复。
第21行代码，在Sheet1表中写入所计算的月份。
第22行到第28行代码，根据加班班数和相应的系数计算加班费金额。
第29行到第33行代码，计算合计栏的金额。
在Sheet1表中输入人员姓名和加班天数后按窗体的“确定”按钮后效果如图 193 8所示。

图 193 8    计算加班费</code></pre>
<p>为了计算高温加班工资，VBE中插入一个和计算加班费类似的窗体，双击窗体中的“确定”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim rng As Range
    Dim i As Integer
    Dim r As Integer
    With Sheet1
        r = .Range(&quot;B63556&quot;).End(xlUp).Row
        .Select
        If .Cells(5, 2) = &quot;&quot; Then
            MsgBox &quot;请把数据填写完整后再计算!&quot;, 64, &quot;系统提示&quot;
            Unload Me
            Exit Sub
        End If
        For i = 5 To r - 2
            If WorksheetFunction.CountIf(.Range(&quot;B5:B&quot; &amp; i), .Cells(i, 2)) &gt; 1 Then
                If MsgBox(.Cells(i, 2) &amp; &quot;输入重复,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
                    Unload Me
                    Exit Sub
                End If
            End If
        Next
        Application.ScreenUpdating = False
        .Unprotect
        .Cells(2, 12) = TextBox2.Text
        With Sheet2.Range(&quot;A:A&quot;)
            For i = 5 To r - 1
                Set rng = .Find(What:=Cells(i, 1).Value, _
                    After:=.Cells(.Cells.Count), _
                    LookIn:=xlFormulas, _
                    LookAt:=xlWhole, _
                    SearchOrder:=xlByRows, _
                    SearchDirection:=xlNext, _
                    MatchCase:=False)
                If Not rng Is Nothing Then
                    Sheet1.Cells(i, 12) = Round(((Val(rng.Offset(0, 2)) + Val(rng.Offset(0, 3))) / 2), 2)
                End If
            Next
        End With
        .Cells(r, 12) = WorksheetFunction.Sum(.Range(&quot;L5:L&quot; &amp; r - 1))
        .Protect
    End With
    Application.ScreenUpdating = True
    Unload Me
    MsgBox TextBox1.Text &amp; TextBox2.Text &amp; &quot;的高温工资计算完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
窗体中的“确定”按钮的Click事件过程，计算Sheet1表中的高温工资。
第8行到第12行代码，检查Sheet1表中是否已输入人员姓名。
第13行到第20行代码，检查Sheet1表中的人员编号是否重复。
第23行代码，在Sheet1表中写入所计算的月份。
第24行到第37行代码，根据Sheet1表中的人员编号在Sheet2表中查找对应的“技能工资”和“岗位工资”并将其合计数的二分之一写入到Sheet1表中。（笔者所在单位每年发一次高温加班工资，为职工“技能工资”和“岗位工资”之和，分两个月发放）
第38行代码，计算合计栏的金额。
在Sheet1表中输入人员姓名和加班天数后按窗体的“确定”按钮后效果如图 193 9所示。

图 193 9    计算高温工资</code></pre>
<p>步骤8，加班费计算完毕后，需要进行汇总，以便统计全年的加班费总额。将Sheet3工作表重命名为“加班费汇总”并设置成如图 193 10所示的格式，在A列和B列中分别写入人员编号和姓名。</p>
<p>图 193 10    加班费汇总表<br>在模块中写入下面的代码。</p>
<pre><code class="vb">Sub DataSummary()
    Dim MyMonth As String
    Dim c As Integer
    Dim rng As Range
    Dim r As Integer
    Dim i As Integer
    MyMonth = Sheet1.Cells(2, 12).Value
    If MsgBox(&quot;是否汇总加班费数据?&quot;, 36, &quot;系统提示&quot;) = 7 Then
        Exit Sub
    End If
    If Sheet1.Cells(5, 12) = &quot;&quot; Then
        MsgBox &quot;没有可汇总的数据,请先计算加班费!&quot;, 64, &quot;系统提示&quot;
        Exit Sub
    End If
    With Sheet3
        r = .Range(&quot;A63556&quot;).End(xlUp).Row
        For i = 3 To 14
            If .Cells(1, i).Value = MyMonth Then
                c = i
                Exit For
            End If
        Next
        If .Cells(r, c).Value &gt; 0 Then
            If MsgBox(MyMonth &amp; &quot;加班费已经汇总,是否继续?&quot;, 36, &quot;系统提示&quot;) = 7 Then
            Exit Sub
        End If
        End If
        .Unprotect
        Application.ScreenUpdating = False
        With .Range(&quot;A:A&quot;)
            For i = 5 To Sheet1.Range(&quot;A63556&quot;).End(xlUp).Row
                Set rng = .Find(What:=Sheet1.Cells(i, 1).Text, _
                    After:=.Cells(.Cells.Count), _
                    LookIn:=xlFormulas, _
                    LookAt:=xlWhole, _
                    SearchOrder:=xlByRows, _
                    SearchDirection:=xlNext, _
                    MatchCase:=False)
                If Not rng Is Nothing Then
                    rng.Offset(, c - 1) = Val(rng.Offset(, c - 1)) + Val(Sheet1.Cells(i, 12))
                End If
            Next
        End With
       .Cells(r, c).ClearContents
        For i = 2 To r - 1
            .Cells(r, c) = Val(.Cells(r, c)) + Val(.Cells(i, c))
        Next
        For i = 2 To r
            .Cells(i, 15) = WorksheetFunction.Sum(.Range(&quot;C&quot; &amp; i &amp; &quot;:N&quot; &amp; i))
        Next
        Application.GoTo Reference:=.Cells(1, c), Scroll:=True
        .Protect
    End With
    Application.ScreenUpdating = True
    MsgBox MyMonth &amp; &quot;的加班费汇总完毕!&quot;, 64, &quot;系统提示&quot;
End Sub
代码解析：
DataSummary过程将“加班费计算”表中计算好的加班费合计汇总到“加班费汇总”表中。
第8行代码获得需要汇总的月份。
第17行到第22行代码，获得需要汇总的月份在“加班费汇总”表中的列号。
第23行代码到第27行代码，如果“加班费汇总”表中相应的列中已有合计金额，询问是否继续汇总，防止重复汇总。
第30行到第43行代码，使用Find方法将加班费金额进行汇总。关于Find方法请参阅技巧5-1。
第44行到第50行代码在汇总表中重新计算每行每列的合计数。
第51行代码使用GoTo方法选择汇总表中相应的单元格。关于GoTo方法请参阅技巧2-3。
步骤9，加班费计算、汇总完毕后需要进行打印，首先在工作表窗口中单击菜单“文件”→“页面设置”，在“工作表”选项卡中将“顶端标题行”设置为“$1:$4”，然后在VBE中插入一个窗体，如图 193 11所示。

图 193 11 打印窗体</code></pre>
<p>双击窗体中的“打印”按钮，写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Byte
    Dim i As Integer
    Dim i1 As Integer
    Dim i2 As Integer
    Application.ScreenUpdating = False
    ActiveWindow.View = xlPageBreakPreview
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .ResetAllPageBreaks
        If .HPageBreaks.Count = 0 Then
            .Unprotect
            .Cells(100, 2) = &quot;123&quot;
            i1 = .HPageBreaks(1).Location.Row
            .Cells(100, 2) = &quot;&quot;
            .Unprotect
            For i = r To i1 - 2
                .Rows(r).Insert
            Next
            .Protect
        Else
            .HPageBreaks.Add Before:=.Range(&quot;B65536&quot;).End(xlUp).Offset(1, 0)
            i1 = .HPageBreaks(1).Location.Row - 5
            i2 = .HPageBreaks(.HPageBreaks.Count).Location.Row - .HPageBreaks(.HPageBreaks.Count - 1).Location.Row
            .Unprotect
            For i = 1 To i1 - i2
                .HPageBreaks(.HPageBreaks.Count).Location.Offset(-1, 0).EntireRow.Insert
            Next
            .Protect
        End If
    End With
    ActiveWindow.View = xlNormalView
    Application.ScreenUpdating = True
    Unload Me
    Sheet1.PrintOut Copies:=ComboBox1.Value
End Sub
代码解析：
打印窗体中 “打印”按钮的Click事件过程，打印“加班费计算表”。
第7行代码，将窗口中的视图设置为分页预览。应用于Window对象的View属性返回或设置在窗口中显示的视图，设置成xlPageBreakPreview为分页预览，xlNormalView则为普通视图。
第11行代码，判断Sheet1表是否满页。HPageBreaks属性返回 HPageBreaks集合，代表工作表上的水平分页符，如果工作表中没有水平分页符说明没有满页。
第13行到第15行代码，在B列单元格中写入字符取得Sheet1表中第一个分页符的位置后再删除。
第17行到第19行代码，在Sheet1表中的B列合计栏中插入一定数量的空行使其满页。
第22行代码，如果Sheet1表的打印内容不止一页，在最后一行插入一个分页符。
第23行代码，取得Sheet1表中满页的行数。
第24行代码，取得Sheet1表最后一页中的行数，两者相减即能得到最后一页中需插入的行数。
第26行到第28行代码，在Sheet1表中的B列合计栏中插入一定数量的空行使其满页。
第32行代码，将窗口中的视图设置为普通视图。
当使用“打印”窗体打印Sheet1表时，将自动插入一定数量的空行使其满页打印。
步骤10，为了使用方便，需要在菜单栏中添加自定义菜单来使用各项功能，在模块中写入下面的代码。</code></pre>
<pre><code class="vb">Sub AddNewMenu()
    Dim HelpMenu As CommandBarControl
    Dim NewMenu As CommandBarPopup
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set HelpMenu = .FindControl(ID:=.Controls(&quot;帮助(&amp;H)&quot;).ID)
        If HelpMenu Is Nothing Then
            Set NewMenu = .Controls.Add(Type:=msoControlPopup)
        Else
            Set NewMenu = .Controls.Add(Type:=msoControlPopup, Before:=HelpMenu.Index)
        End If
        With NewMenu
            .Caption = &quot;加班费(&amp;S)&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;导入数据&quot;
                .OnAction = &quot;ImportWages&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;清除加班费&quot;
                .OnAction = &quot;DataClear&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;批量导入人员&quot;
                .OnAction = &quot;ImportName&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;计算加班费&quot;
                .OnAction = &quot;DataCalculation&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;计算高温工资&quot;
                .OnAction = &quot;TemperatureCalculation&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;加班费汇总&quot;
                .OnAction = &quot;DataSummary&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;打印加班费&quot;
                .OnAction = &quot;HPageBreak&quot;
            End With
        End With
    End With
    Set HelpMenu = Nothing
    Set NewMenu = Nothing
End Sub
Sub DelNewMenu()
    Application.CommandBars(&quot;Worksheet menu bar&quot;).Reset
End Sub
代码解析：
AddNewMenu过程在“帮助”菜单前添加一个自定义的“加班费”菜单。
DelNewMenu过程删除自定义的“加班费”菜单。
为了工作簿打开时自动添加“加班费”菜单和关闭时自动删除“加班费”菜单，需要在VBE中双击ThisWorkbook写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Workbook_Activate()
    Call AddNewMenu
End Sub
Private Sub Workbook_Deactivate()
    Call DelNewMenu
End Sub
关于自定义菜单请参阅技巧80 。
保存关闭工作簿，重新打开，将在菜单栏中添加自定义的“加班费”菜单，可以方便的使用加班费计算表中的各项功能，如图 193 12所示。

图 193 12 “加班费”菜单</code></pre>
<h3 id="技巧194-制作发放条"><a href="#技巧194-制作发放条" class="headerlink" title="技巧194     制作发放条"></a>技巧194     制作发放条</h3><p>虽然大多数企业的工资核算都已使用了专业软件，但是有些不能上工资表的项目还是需要使用Excel来制作发放表，比如如图 194 1所示的奖金发放表，这时往往需要提供发放条给每一个职工。</p>
<p>图 194 1    发放表<br>制作发放条的方法有很多，其中使用VBA制作发放条是最方便快捷的，如下面的代码所示。</p>
<pre><code class="vb">Sub Printissued()
    Dim r As Integer
    Dim Sh As Worksheet
    Dim i As Integer
    Application.ScreenUpdating = False
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    With Worksheets
        Set Sh = .Add(after:=Worksheets(.Count))
    End With
    With Sh
        Sheet1.Range(&quot;A1:K&quot; &amp; r).Copy .Range(&quot;A1&quot;)
        .Range(&quot;A5:K&quot; &amp; r) = Sheet1.Range(&quot;A5:K&quot; &amp; r).Value
        .Range(&quot;F2,K2&quot;) = &quot;&quot;
        With .PageSetup
            .PrintTitleRows = &quot;$1:$1&quot;
            .LeftMargin = Application.CentimetersToPoints(1)
            .RightMargin = Application.CentimetersToPoints(1)
            .CenterHorizontally = True
        End With
        For i = 1 To r
            .Rows(i).RowHeight = Sheet1.Rows(i).RowHeight
        Next
        For i = 1 To 11
            Columns(i).ColumnWidth = Sheet1.Columns(i).ColumnWidth
        Next
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        For i = r To 6 Step -1
            .Rows(&quot;2:4&quot;).Copy
            .Rows(i).Insert Shift:=xlDown
        Next
        Application.CutCopyMode = False
        ActiveWindow.View = xlPageBreakPreview
        For i = 1 To .HPageBreaks.Count
            If .HPageBreaks(i).Location.Offset(-1, 0) &lt;&gt; &quot;&quot; Then
                .HPageBreaks.Add Before:=.HPageBreaks(i).Location.Offset(-2, 0)
            End If
        Next
        ActiveWindow.View = xlNormalView
        .PrintOut
        Application.DisplayAlerts = False
        .Delete
        Application.DisplayAlerts = True
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
Printissued过程将发放表以发放条的形式打印。
第5行代码关闭屏幕刷新加快运行速度。
第7行到第9行代码，为了不破坏原表的结构，在工作簿中新建一张工作表用来制作发放条。
第11行代码，将发放表中需要制作发放条的区域拷贝到新工作表中。
第12行代码，将表中的公式部分转化为数值。
第13行代码，删除原表中的年度和人数。
第14行到第19行代码，设置发放条表的打印标题行、左右边距及水平居中。
第20行到第25行代码，设置发放条表的行高列宽与原表一致。
第26行到第31行代码，在发放条的每行数据前插入表头部分。
第32行到第38行代码，因为可能存在同一个人表头和数据不在同一页面的现象，所以逐一检查分页符，如果分页符所在单元格的上面单元格不是空白行则将分页符上移两行。
第39行代码，使用PrintOut方法打印发放条。
第40行到第42行代码，使用Delete方法删除发放条表。
运行Printissued过程，发放条表没删除前如图 194 2所示。

图 194 2    发放条</code></pre>
<h3 id="技巧195-费用统计表"><a href="#技巧195-费用统计表" class="headerlink" title="技巧195     费用统计表"></a>技巧195     费用统计表</h3><p>对于经常发生的一些费用开支，可以使用Excel进行录入和统计，比如使用本统计表可以方便的录入汽车费用明细，对费用明细按时间或类别进行统计，并以图表的形式在窗体中显示出来。<br>步骤1，新建工作簿，将Sheet1表重命名为“费用明细”并设置为如图 195 1所示的格式。</p>
<p>图 195 1        工作表设置<br>步骤2，在Sheet1工作表中单击菜单“视图”→“工具栏”→“控件工具箱”，在显示的工具栏中选择“其他附件”中的DTPicker控件，在工作表中拖动添加一个DTPicker控件。如果“其他附件”中没有该控件，请参阅技巧118 对其进行注册。<br>步骤3，在VBE中双击Sheet1，在工作表的SelectionChange事件过程中写入以下代码。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    If Target.Row &gt; 1 And Target.Row &lt; r And Target.Count = 1 Then
        If Target.Column = 1 Then
            With Me.DTPicker1
                .Visible = True
                .Value = Date
                .Top = Target.Top
                .Left = Target.Left
                .Width = Target.Width + 15
                .Height = Target.Height
            End With
        Else
            Me.DTPicker1.Visible = False
        End If
        If Target.Column = 3 Then
            With Target.Validation
                .Delete
                .Add Type:=xlValidateList, _
                AlertStyle:=xlValidAlertStop, _
                Operator:=xlBetween, _
                Formula1:=&quot;汽油费,过路费,保险费,修理费,保养费,装饰费,改装费,养路费,其他费&quot;
            End With
        End If
     End If
End Sub 
代码解析：
工作表的SelectionChange事件，当选择A列单元格时显示日历控件，选择C列时建立数据有效性，便于在工作表中录入时间及费用类别。
第4行代码，设置该事件的触发条件，只有在选择第2行和“合计”行之间单元格并且只选择一个单元格时事件触发。
第5行到第16行代码如果选择的是第一列录入日期的单元格时，显示日历控件并对其格式进行相应的设置，如图 195 2所示，方便录入费用日期，否则隐藏日历控件。

图 195 2        显示日历控件
第17行到第26行代码如果选择的是第三列录入费用类别的单元格时，在单元格中建立数据有效性设置，如图 195 3所示。关于在工作表中建立数据有效性请参阅12-1。

图 195 3        建立数据有效性
在VBE中双击Sheet1，在工作表的Change事件过程中写入以下代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Dim r1 As Integer
    Dim r2 As Integer
    With Sheet1
        r1 = .Range(&quot;D65536&quot;).End(xlUp).Row
        r2 = .Range(&quot;E65536&quot;).End(xlUp).Row
        If Target.Column = 4 And Target.Row &gt; 1 And Target.Count = 1 Then
            .Range(&quot;E2:E&quot; &amp; r1).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Range(&quot;E2:E&quot; &amp; r1) = Range(&quot;E2:E&quot; &amp; r1).Value
            .Cells(r2, 5).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Cells(r2, 5) = .Cells(r2, 5).Value
        End If
    End With
End Sub
代码解析：
工作表的Change事件过程，当工作表的第四列单元格中录入费用金额时，在第五列“合计”单元格中写入金额合计的公式，并将公式转化为数值。
在设计模式下双击DTPicker控件，写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub DTPicker1_CloseUp()
    ActiveCell = DTPicker1.Value
    DTPicker1.Visible = False
End Sub
代码解析：
DTPicker控件的Change事件，选择日历控件的日期时将日期写入到工作表的活动单元格中。
步骤4，在VBE窗口中单击菜单“插入”→“用户窗体”，添加一个“统计”窗体，在窗体中添加一个ListView和一个框架控件控件，在框架控件中添加三个组合框控件、三个按钮控件和一个框架控件，在其中添加一个标签控件，如图 195 4所示。</code></pre>
<p>图 195 4        统计窗体<br>在VBE中双击窗体写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Col As New Collection
    Dim rng As Range, arr, Category
    Dim i As Integer
    On Error Resume Next
    For Each rng In Sheet1.Range(&quot;A2:A&quot; &amp; [A65536].End(xlUp).Row)
        Col.Add Left(rng, 7), Key:=CStr(Left(rng, 7))
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    Me.Frame1.ComboBox1.List = arr
    Me.Frame1.ComboBox2.List = arr
    Category = Array(&quot;汽油费&quot;, &quot;过路费&quot;, &quot;保险费&quot;, &quot;修理费&quot;, &quot;保养费&quot;, &quot;装饰费&quot;, &quot;其他费&quot;)
    Me.Frame1.ComboBox3.List = Category
    With Me.ListView1
        .ColumnHeaders.Clear
        .ColumnHeaders.Add , , &quot;   日期&quot;, 55, lvwColumnLeft
        .ColumnHeaders.Add , , &quot;       费用内容&quot;, 110, lvwColumnLeft
        .ColumnHeaders.Add , , &quot;费用类别&quot;, 50, lvwColumnCenter
        .ColumnHeaders.Add , , &quot;金额   &quot;, 50, lvwColumnRight
        .ColumnHeaders.Add , , &quot;合计   &quot;, 60, lvwColumnRight
        .View = lvwReport
        .Gridlines = True
    End With
    Me.CommandButton3.Enabled = False
End Sub
代码解析：
窗体的Initialize事件，窗体初始化时对其中的控件进行相应的设置。
第6行到第14行代码，使用Add方法将第一列中的日期去除重复值后取其年月添加到“开始日期”和“结束日期”组合框中，关于使用Add方法去除重复值请参阅技巧110 。
第15、16行代码在“费用类别”组合框中添加列表项。关于在组合框中添加列表项的方法请参阅技巧109 。
第17行到第26行代码在ListView控件中添加标题列并进行相应的设置，请参阅技巧131 。
第27行代码将“图表”按钮的Enabled属性设置为False，使之暂不可用。
在VBE中双击窗体上的“统计”按钮写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim StartDate As Date
    Dim EndDate As Date
    Dim r As Integer
    Dim r2 As Integer
    Dim Itm As ListItem
    Dim i As Integer
    Dim Col As New Collection
    Dim rng As Range
    Dim StrResults As String
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    With Me.Frame1.ComboBox1
        If .Value = &quot;&quot; Then
            StartDate = .List(0) &amp; &quot;-1&quot;
        Else
            StartDate = .Value &amp; &quot;-1&quot;
        End If
    End With
    With Me.Frame1.ComboBox2
        If .Value = &quot;&quot; Then
            EndDate = DateSerial(Year(.List(.ListCount - 1) &amp; &quot;-1&quot;), Month(.List(.ListCount - 1) &amp; &quot;-1&quot;) + 1, 0)
        Else
            EndDate = DateSerial(Year(.Value &amp; &quot;-1&quot;), Month(.Value &amp; &quot;-1&quot;) + 1, 0)
        End If
    End With
    If StartDate &gt; EndDate Then
        MsgBox &quot;开始日期不能大于结束日期,请重新选择!&quot;, , &quot;提示&quot;
        Exit Sub
    End If
    If Me.Frame1.ComboBox3 = &quot;&quot; Then
        Me.CommandButton3.Enabled = True
    Else
        Me.CommandButton3.Enabled = False
    End If
    Application.ScreenUpdating = False
    Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter Field:=1, Criteria1:=&quot;&gt;=&quot; &amp; StartDate, Criteria2:=&quot;&lt;=&quot; &amp; EndDate
    If Me.Frame1.ComboBox3 &lt;&gt; &quot;&quot; Then
        Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter Field:=3, Criteria1:=Me.Frame1.ComboBox3.Value
    End If
    With Sheet2
        .Cells.Clear
        Sheet1.AutoFilter.Range.SpecialCells(12).Copy .Cells(1, 1)
        r2 = .Range(&quot;A65536&quot;).End(xlUp).Row
        If r2 &gt; 1 Then
            .Range(&quot;E2:E&quot; &amp; r2).FormulaR1C1 = &quot;=SUM(R2C4:RC4)&quot;
            .Range(&quot;E2:E&quot; &amp; r2) = .Range(&quot;E2:E&quot; &amp; r2).Value
        End If
    End With
    Sheet1.Range(&quot;A1:E&quot; &amp; r).AutoFilter
    With Me.ListView1
        .ListItems.Clear
        For i = 2 To r2
            Set Itm = .ListItems.Add()
            With Sheet2
                Itm.Text = .Cells(i, 1)
                Itm.SubItems(1) = .Cells(i, 2)
                Itm.SubItems(2) = .Cells(i, 3)
                Itm.SubItems(3) = Format(.Cells(i, 4), &quot;0.00&quot;)
                Itm.SubItems(4) = Format(.Cells(i, 5), &quot;0.00&quot;)
            End With
        Next
    End With
    On Error Resume Next
    Sheet3.Range(&quot;A1:B30&quot;).Clear
    If r2 &gt; 1 Then
        For Each rng In Sheet2.Range(&quot;C2:C&quot; &amp; r2)
            Col.Add rng, Key:=CStr(rng)
        Next
        For i = 1 To Col.Count
            With Sheet3
                .Cells(i, 1) = Col(i)
                .Cells(i, 2).FormulaR1C1 = &quot;=SUMIF(统计数据!R2C[1]:R&quot; &amp; r2 &amp; &quot;C[1],RC[-1],统计数据!R2C[2]:R&quot; &amp; r2 &amp; &quot;C[2])&quot;
                .Cells(i, 2) = .Cells(i, 2).Value
                StrResults = StrResults &amp; Space(2) &amp; .Cells(i, 1) &amp; &quot;：&quot; &amp; Space(3) &amp; .Cells(i, 2) &amp; &quot;元&quot; &amp; Chr(13)
            End With
        Next
        Label4.Caption = Space(2) &amp; StartDate &amp; &quot; 至：&quot; &amp; Chr(13) &amp; Space(2) &amp; EndDate &amp; &quot; 期间&quot; &amp; Chr(13) &amp; StrResults &amp; Space(2) &amp; &quot;合  计：&quot; &amp; Space(3) &amp; Sheet2.Cells(r2, 5).Value &amp; &quot;元&quot;
    Else
        Label4.Caption = Space(2) &amp; StartDate &amp; &quot; 至：&quot; &amp; Chr(13) &amp; Space(2) &amp; EndDate &amp; &quot; 期间&quot; &amp; Chr(13) &amp; Space(2) &amp; Me.Frame1.ComboBox3.Value &amp; &quot;没有发生!&quot;
    End If
    Application.ScreenUpdating = True
End Sub
代码解析：
窗体上的“统计”按钮的单击事件，按日期统计费用类型和金额并显示在ListView控件中。
第12行到第18行代码取得需要统计的开始日期，如果没有选择开始日期则默认为工作表中已录入日期的第一个月的第一天。
第19行到第25行代码取得需要统计的结束日期，如果没有选择结束日期则默认为工作表中已录入日期的最后一个月的最后一天。
第26行到第29行代码检查开始日期和结束日期，开始日期不能大于结束日期，否则无法正确统计数据。
第30行到第34行代码设置“图表”按钮的Enabled属性，如果没有选择“费用类别”说明统计的是全部类别，则“图表”按钮有效；如果选择了“费用类别”中的明细类别，则不需要“图表”按钮，因为单一的费用类别是不需要使用图表进行分析的。
第36行代码对工作表中的数据进行自定义筛选，筛选出介于所选开始日期和结束日期之间的数据。
第37行到第39行代码如果同时选择了“费用类别”中的明细类别，则对工作表中筛选出来的数据进行第二次筛选，筛选出该类别的数据。
第40行到第48行代码将筛选结果复制到Sheet2工作表中，请参阅技巧36 。
第49行代码取消筛选模式。
第50行到第62行代码将Sheet2工作表中的筛选结果显示到窗体的ListView控件中。关于ListView控件请参阅技巧131 。
第63行到第68行代码将Sheet2工作表中的筛选结果中的C列中的明细类别使用使用Add方法去除重复值。请参阅技巧110 。
第69行到第80行代码在Sheet3工作表A列中写入类别明细并在B列中写入SUMIF函数计算该费用类别在统计时段中的合计发生费用，并将公式转化为数值。最后使用标签将类别明细和费用金额显示有窗体中。
在VBE中双击窗体上的“图表”按钮写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim myRange As Range
    Dim myChart As ChartObject
    Application.ScreenUpdating = False
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        .ChartObjects.Delete
        Set myRange = .Range(&quot;A&quot; &amp; 1 &amp; &quot;:B&quot; &amp; r)
        Set myChart = .ChartObjects.Add(120, 40, 400, 250)
        With myChart.Chart
            .ChartType = xlPie
            .SetSourceData Source:=myRange, PlotBy:=xlColumns
            .Location xlLocationAsObject, &quot;统计图表&quot;
            .Legend.Position = -4152
            .Legend.Font.Size = 9
            .PlotArea.Interior.ColorIndex = -4142
            .PlotArea.Border.LineStyle = -4142
            .SeriesCollection(1).ApplyDataLabels _
                AutoText:=True, _
                HasLeaderLines:=True, _
                ShowValue:=True, _
                ShowCategoryName:=True, _
                ShowPercentage:=True
            .SeriesCollection(1).DataLabels.Font.Size = 9
        End With
        Set myChart = Nothing
    End With
    Sheet1.Select
    Application.ScreenUpdating = True
    UserForm2.Show
End Sub
代码解析：
窗体中“图表”按钮的单击事件，在Sheet3工作表中根据统计数据建立图表。
第8行代码，首先删除工作表原有的图表。
第10行代码，在Sheet3表中建立新的图表。
第11行到第26行代码，对新建立的图表进行格式设置。关于图表请参阅技巧60 。
第31行代码显示图表窗体。
步骤5，在VBE窗口中单击菜单“插入”→“用户窗体”，添加一个“图表”窗体，在窗体中添加一个Image控件和一个按钮控件，如图 195 5所示。

图 195 5        图表窗体</code></pre>
<p>在VBE中双击窗体，写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Charts As Chart
    Dim cName As String
    Set Charts = Sheet3.ChartObjects(1).Chart
    cName = ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
    Charts.Export Filename:=cName, FilterName:=&quot;GIF&quot;
    Image1.Picture = LoadPicture(cName)
End Sub
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    Kill ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
End Sub
Private Sub CommandButton1_Click()
    Unload Me
End Sub
代码解析：
第1行到第8行代码是窗体的Initialize事件，在窗体初始化时将工作表中的图表显示在窗体中。
第9行到第11行代码是窗体的QueryClose事件，在窗体关闭时删除临时文件。
关于将图表显示在窗体上的方法请参阅技巧146-1。</code></pre>
<p>步骤6，为了方便使用，需要在菜单栏上添加自定义菜单，在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码。</p>
<pre><code class="vb">Sub AddNewMenu()
    Dim HelpMenu As CommandBarControl
    Dim NewMenu As CommandBarPopup
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set HelpMenu = .FindControl(ID:=.Controls(&quot;帮助(&amp;H)&quot;).ID)
        If HelpMenu Is Nothing Then
            Set NewMenu = .Controls.Add(Type:=msoControlPopup)
        Else
            Set NewMenu = .Controls.Add(Type:=msoControlPopup, _
                Before:=HelpMenu.Index)
        End If
        With NewMenu
            .Caption = &quot;汽车费用(&amp;S)&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;批量插入空行(&amp;D)&quot;
                .FaceId = 162
                .OnAction = &quot;InSertRows&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;汽车费用统计(&amp;T)&quot;
                .FaceId = 590
                .OnAction = &quot;Form&quot;
            End With
        End With
    End With
    Set HelpMenu = Nothing
    Set NewMenu = Nothing
End Sub
Sub DelNewMenu()
    Application.CommandBars(&quot;Worksheet menu bar&quot;).Reset
End Sub
Sub Form()
    UserForm1.Show
End Sub
Sub InSertRows()
    Dim dInput As Byte
    Dim i As Byte
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    dInput = Application.InputBox(Prompt:=&quot;请输入插入的行数：&quot;, Title:=&quot;批量插入空行&quot;, Type:=1)
    If dInput &lt;&gt; False Then
        Application.ScreenUpdating = False
        For i = 1 To dInput
            Sheet1.Rows(r).Insert
        Next
        Application.ScreenUpdating = True
    End If
End Sub
代码解析：
AddNewMenu过程在菜单栏的帮助菜单前添加“汽车费用”菜单。
DelNewMenu过程删除添加的“汽车费用”菜单。
Form过程是“汽车费用”菜单中的子菜单“汽车费用统计”所运行的宏过程，显示“图表”窗体。
关于在工作表菜单栏中添加自定义菜单请参阅技巧80 。
InSertRows过程是“汽车费用”菜单中的子菜单“批量插入空行”所运行的宏过程，使用InputBox方法显示一个对话框，输入需要插入的行数后使用Insert方法在工作表中插入空行。
关于InputBox方法请参阅技巧76 ，关于Insert方法请参阅技巧30 。</code></pre>
<p>为了在打开工作簿时自动添加菜单项，需要在工作簿的Activate事件中调用myTools过程，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Activate()
    Call AddNewMenu
End Sub
为了在关闭工作簿时删除新添加的菜单项，还需要在工作簿的Deactivate事件中调用DelmyTools过程，如下面的代码所示。

​```vb
Private Sub Workbook_Deactivate()
    Call DelNewMenu
End Sub
步骤7，因为在平时使用时是不需要操作Sheet2表和Sheet3表的，在VBE中分别选择Sheet2表和Sheet3表的属性窗口，将Visible设置为xlSheetVeryHidden，使工作表深度隐藏，这样在“格式”菜单中就不能取消隐藏。
保存关闭工作簿，重新打开工作簿，在费用明细表中录入数据后，点击“汽车费用”菜单后显示“费用统计”窗体，选择统计条件后即能统计出明细费用，如图 195 6所示。

图 195 6        统计窗体
此时单击窗体中的“图表”按钮将用窗体显示该期间费用的图表，如图 195 7所示。

图 195 7        图表窗体</code></pre>
<h3 id="技巧196-职工花名册"><a href="#技巧196-职工花名册" class="headerlink" title="技巧196     职工花名册"></a>技巧196     职工花名册</h3><p>在实际工作中，往往需要一个花名册用于录入职工的各项信息，在需要时可以方便的进行查找、统计以方便日常工作。<br>使用Excel制作职工花名册可以方便的录入职工信息，对所录入的信息进行修改、筛选择等，制作步骤如下：<br>步骤1，新建工作簿，将Sheet1工作表名称修改为“花名册”，设置成如图 196 1所示的格式。</p>
<p>图 196 1    花名册格式<br>步骤2，在工作表的B列输入职工姓名，F列输入身份证号码，G列输入职称。<br>“部门”、“职务”及“备注”从工作表中的数据有效性中选择，在VBE中双击Sheet1表，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim r As Integer
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    With Target
        If .Count = 1 And .Row &gt; 5 And .Row &lt;= r Then
            Sheet1.Unprotect
            Select Case .Column
            Case 8
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;经理室,办公室,行政科,生技科,财务科,&quot; _
                            &amp; &quot;营业部,制水车间,污水厂,其他,安装公司,退休&quot;
                End With
            Case 9
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;经理,副经理,支书,副支书,经理助理,&quot; _
                            &amp; &quot;中层正职,中层副职,总账会计,辅助会计,&quot; _
                            &amp; &quot;辅助会计,出纳会计,协理员,管理员,驾驶员,&quot; _
                            &amp; &quot;办事员,科档员,计量员,收费员,发货员,&quot; _
                            &amp; &quot;采购员,化验员,监察队员,班组长,拆表工,&quot; _
                            &amp; &quot;抄表工,勘估设计,预决算,校表工,换表工,&quot; _
                            &amp; &quot;机修工,电工,中控值班,制水工,安装工,&quot; _
                            &amp; &quot;外借,内退&quot;
                End With
            Case 10
                With .Validation
                    .Delete
                    .Add Type:=xlValidateList, _
                        AlertStyle:=xlValidAlertStop, _
                        Operator:=xlBetween, _
                        Formula1:=&quot;在职,内退,退休&quot;
                End With
            End Select
            Sheet1.Protect
        End If
    End With
End Sub
代码解析：
工作表的SelectionChange事件过程，当选择工作表的H、I和J列时自动生成相应的数据有效性，请参阅技巧12-1。</code></pre>
<p>“性别”、“出生年月”及“年龄”由输入的身份证号码自动生成，在Sheet1表的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Sheet1.Unprotect
    With Target
        If .Count = 1 And .Row &gt; 5 And .Column = 6 Then
            If .Text &lt;&gt; &quot;&quot; Then
                Application.EnableEvents = False
                .Offset(0, -5).FormulaR1C1 = &quot;=ROW()-5&quot;
                .Offset(0, -3) = IIf(Mid(.Text, 17, 1) Mod 2 = 0, &quot;女&quot;, &quot;男&quot;)
                .Offset(0, -2) = Format(Mid(.Text, 7, 8), &quot;#-00-00&quot;)
                .Offset(0, -1).FormulaR1C1 = &quot;=DATEDIF(TEXT(MID(RC[1],7,8),&quot;&quot;#-00-00&quot;&quot;),TODAY(),&quot;&quot;y&quot;&quot;)&quot;
                Application.EnableEvents = True
            Else
                Rows(.Row) = &quot;&quot;
            End If
        End If
    End With
    Sheet1.Protect
End Sub
代码解析：
工作表的Change事件过程，当输入职工身份证号码后在工作表的C、D和E列自动生成相应的“性别”、“出生年月”及“年龄”。
第7行代码，在A列写入序号的公式。
第8行代码，根据身份证号码的最后第二位数在C列中写入性别。
第9行代码，根据身份证号码中的出生年月信息在D列中写入出生年月。
第10行代码，根据身份证号码中的出生年月信息在E列中写入判断年龄的公式，因为年龄是动态的，所以只能写入公式。
在工作表的H2、H3单元格中写入统计人员类别的公式。</code></pre>
<p>步骤3，为了方便使用，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub SectorSort()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        If MsgBox(&quot;是否按公司部门顺序进行排序?&quot;, 36) = 6 Then
            .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;H6&quot;), _
                Order1:=xlAscending, Key2:=Range(&quot;D6&quot;), _
                OrderCustom:=13
        End If
        .Protect
    End With
End Sub
代码解析：
SectorSort过程对职工花名册按部门进行排序。
第7行到第9行代码使用Sort方法对职工花名册进行排序，应用于Range对象的Sort方法对数据透视表、单元格区域或活动区域（如果指定区域仅包含一个单元格）进行排序，语法如下：
expression.Sort(Key1, Order1, Key2, Type, Order2, Key3, Order3, Header, OrderCustom, MatchCase, Orientation, SortMethod, DataOption1, DataOption2, DataOption3)
其中Key1参数是可选的，指定第一个排序字段，本例中按部门进行排序。
Order1参数是可选的，在Key1参数中指定的字段或区域的排序顺序。
Key2参数是可选的，指定第二个排序字段，本例中按出生年月进行排序。
OrderCustom参数是可选的，是从 1 开始的整数，指定了在自定义排序顺序列表中的索引号。如果省略参数，则使用常规排序。本例中在工作簿中添加了自定义的部门序列，索引号为13，如图 196 2所示。</code></pre>
<p>图 196 2    自定义序列</p>
<pre><code class="vb">Sub AgeSort()
    Dim r As Integer
    Dim imsg As Integer
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        imsg = MsgBox(&quot;选择[是]按升降序排序,选择[否]按降序排序&quot;, 3)
        Select Case imsg
            Case 6
                .Unprotect
                .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
                    Order1:=xlAscending, Key2:=.Range(&quot;D6&quot;)
            Case 7
                .Unprotect
                .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
                    Order1:=xlDescending, Key2:=.Range(&quot;D6&quot;)
            End Select
        .Protect
    End With
End Sub
代码解析：
AgeSort过程对职工花名册依据年龄进行排序。
第10、11行代码，使用Sort方法对职工花名册按年龄进行升序排序，Sort方法的Order1参数排序顺序，可为表格 196 1所示的XlSortOrder 常量之一。
常量    值    描述
xlDescending    2    按降序排序
xlAscending    1    按升序排序
表格 196 1    XlSortOrder 常量
第14、15行代码，使用Sort方法对职工花名册按年龄进行降序排序。</code></pre>
<pre><code class="vb">Sub Forshow()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;H6&quot;), _
            Order1:=xlAscending, Key2:=Range(&quot;D6&quot;), _
            OrderCustom:=13
        .Protect
    End With
    UserForm1.Show
End Sub
代码解析：
Forshow过程对职工花名册按部门进行排序后显示按部门进行筛选的窗体。</code></pre>
<pre><code class="vb">Sub AgeSortForshow()
    Dim r As Integer
    With Sheet1
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;A6:J&quot; &amp; r).Sort Key1:=.Range(&quot;E6&quot;), _
            Order1:=xlAscending, Key2:=.Range(&quot;D6&quot;)
        .Protect
    End With
    UserForm2.Show
End Sub
代码解析：
AgeSortForshow过程对职工花名册按年龄进行排序后显示按年龄进行筛选的窗体。</code></pre>
<p>步骤4，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个列表框控件和两个按钮按件，如图 196 3所示。</p>
<p>图 196 3    按部门筛选窗体<br>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    On Error Resume Next
    Dim Col As New Collection
    Dim rng As Range, arr
    Dim i As Integer
    For Each rng In Sheet1.Range(&quot;H6:H&quot; &amp; Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row)
        If Trim(rng) &lt;&gt; &quot;&quot; Then
            Col.Add rng, key:=CStr(rng)
        End If
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    With Me.ListBox1
        .List = arr
        .ListStyle = 1
        .MultiSelect = 1
    End With
End Sub
代码解析：
窗体的Initialize事件过程，窗体显示时将部门名称加载到窗体的列表框中。
第6行到第14行代码，使用Add方法将工作表H列中的部门名称去除重复值。
第15行到第19行代码，将部门名称加载到窗体的列表框并将列表框设置为显示多重选择列表的列表框。窗体显示时如图 196 4所示。

图 196 4    多重选择列表框</code></pre>
<p>双击窗体的“筛选”按钮写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim r As Integer
    Dim r2 As Integer
    Sheet1.Unprotect
    Sheet2.Unprotect
    Application.ScreenUpdating = False
    r2 = Sheet2.Range(&quot;B65536&quot;).End(xlUp).Row
    If r2 &gt; 5 Then
        With Sheet2.Range(&quot;A6:J&quot; &amp; r2)
            .ClearContents
            .Borders.LineStyle = xlNone
        End With
    End If
    r = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
    For i = 0 To ListBox1.ListCount - 1
        If ListBox1.Selected(i) = True Then
            Sheet1.Range(&quot;A5:J&quot; &amp; r).AutoFilter Field:=8, Criteria1:=&quot;=&quot; &amp; ListBox1.List(i)
            With Sheet2
                r2 = .Range(&quot;B65536&quot;).End(xlUp).Row
                Sheet1.Range(&quot;A6:J&quot; &amp; r).SpecialCells(12).Copy
                .Cells(r2 + 1, 1).PasteSpecial Paste:=xlPasteValues
                Application.CutCopyMode = False
                With .Range(&quot;A6:A&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row)
                    .FormulaR1C1 = &quot;=ROW()-5&quot;
                    .Value = .Value
                End With
            End With
        End If
    Next
    With Sheet2
        .Range(&quot;A6:J&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row).Borders.LineStyle = xlContinuous
        Application.Goto Reference:=.Range(&quot;A2&quot;), Scroll:=True
        .Protect
    End With
    Sheet1.Range(&quot;A1:J&quot; &amp; r).AutoFilter
    Sheet1.Protect
    Unload Me
    Application.ScreenUpdating = True
End Sub
代码解析：
“筛选”按钮的单击过程，将窗体列表框中所选中的部门数据筛选后复制到工作表中。
第10行到第12行代码，删除工作表中原有的数据，去除边框线。
第16行到第29行代码，将窗体列表框中所选中的部门数据进行筛选后依次复制到工作表中。
其中第18行代码使用AutoFilter方法进行筛选。应用于Range对象的AutoFilter方法使用“自动筛选”筛选出一个列表，语法如下：
expression.AutoFilter(Field, Criteria1, Operator, Criteria2, VisibleDropDown)
参数Field是可选的，相对于作为筛选基准字段（从列表左侧开始，最左侧的字段为第一个字段）的偏移量。本例中设置为8，即指定工作表中的H列进行筛选。
参数Criteria1是可选的，筛选条件。本例中设置为窗体列表框中所选中的部门名称。
第32行代码，将筛选后的数据画上边框线。
步骤5，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件和两个组合框按件，如图 196 5所示。

图 196 5    按年龄筛选窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    On Error Resume Next
    Dim Col As New Collection
    Dim rng As Range, arr
    Dim i As Integer
    For Each rng In Sheet1.Range(&quot;E6:E&quot; &amp; Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row)
        Col.Add rng, key:=CStr(rng)
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    Me.ComboBox1.List = arr
    Me.ComboBox2.List = arr
End Sub
代码解析：
窗体的Initialize事件过程，窗体显示时将所有的年龄加载到窗体的组合框中。
第6行到第12行代码，使用Add方法将工作表E列中的年龄去除重复值。
第13、14行代码，将年龄加载到窗体的组合框中。</code></pre>
<p>双击窗体的“筛选”按钮写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim r2 As Integer
    Dim dInput As Double
    If Me.ComboBox1.Value = &quot;&quot; Or Me.ComboBox2.Value = &quot;&quot; Then
        MsgBox &quot;请选择需要筛选的年龄!&quot;
        Exit Sub
    End If
    If Me.ComboBox1.Value &gt; Me.ComboBox2.Value Then
        MsgBox &quot;开始年龄不能等结束年龄,请重新选择!&quot;
        Me.ComboBox1.ListIndex = -1
        Me.ComboBox2.ListIndex = -1
        Exit Sub
    End If
    Application.ScreenUpdating = False
    With Sheet1
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Unprotect
        .Range(&quot;A5:J&quot; &amp; r).AutoFilter Field:=5, Criteria1:=&quot;&gt;=&quot; &amp; Me.ComboBox1.Value, Operator:=xlAnd, Criteria2:=&quot;&lt;=&quot; &amp; Me.ComboBox2.Value
        With Sheet2
            .Unprotect
            r2 = .Range(&quot;B65536&quot;).End(xlUp).Row
            If r2 &gt; 5 Then
                With .Range(&quot;A6:J&quot; &amp; r2)
                    .ClearContents
                    .Borders.LineStyle = xlNone
                End With
            End If
            Sheet1.Range(&quot;A6:J&quot; &amp; r).SpecialCells(12).Copy
            .Cells(6, 1).PasteSpecial Paste:=xlPasteValues
            Application.CutCopyMode = False
            With .Range(&quot;A6:A&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row)
                .FormulaR1C1 = &quot;=ROW()-5&quot;
                .Value = .Value
            End With
                .Range(&quot;A6:J&quot; &amp; .Range(&quot;B65536&quot;).End(xlUp).Row).Borders.LineStyle = xlContinuous
            Unload Me
            Application.Goto Reference:=.Range(&quot;A3&quot;), Scroll:=True
            .Protect
        End With
        .Range(&quot;A1:J&quot; &amp; r).AutoFilter
        .Protect
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
“筛选”按钮的单击过程，将根据窗体组合框中所选中的年龄进行筛选后的数据复制到工作表中。
第5行到第8行代码，年龄不能为空。
第9行到第14行代码，开始年龄不能小于结束年龄。
第19行代码，使用AutoFilter方法进行筛选。将第一个筛选条件设置为开始年龄，第二个筛选条件设置为结束年龄。
第23行到第28行代码，删除工作表中原有的数据，去除边框线。
第29行到第35行代码，将筛选后的数据复制到工作表中。
第36行代码，将筛选后的数据画上边框线。
步骤6，为了方便使用，在工作表中单击菜单“视图”→“工具栏”→“窗体”，添加两个框架，在每个框架中添加两个单选框，将模块中的宏指定给单选框，如图 196 6所示。

图 196 6    添加窗体控件
步骤7，为了保存筛选后的数据，将工作簿的Sheet2表重命名为“筛选数据”，并设置成如图 196 7所示的格式。

图 196 7    保存筛选数据
步骤8，选择“花名册”表的B、F和G列第6行以下区域，去除其锁定属性后保护工作表，对“筛选数据”表进行保护。在工作表中单击菜单“工具”→“选项”，在显示的选项对话框的视图页中去除工作表的行号列标及网格线后保存关闭工作簿。
打开工作簿，在“花名册”表中输入职工姓名、身份证号及职称后“花名册”表如图 196 8所示。

图 196 8    职工花名册
对表中数据进行筛选，比如按部门中的“生技科”进行筛选后“筛选数据”表中如图 196 9所示。

图 196 9    筛选后的数据</code></pre>
<h3 id="技巧197-收据系统"><a href="#技巧197-收据系统" class="headerlink" title="技巧197     收据系统"></a>技巧197     收据系统</h3><p>开具收据是财务工作中的一项经常性的工作，如果需要开具大量收据，采用手工方法开具收据时不仅繁琐而且极易出错，此时除了使用专业软件，还可以使用VBA制作的收据填写、打印系统，简化日常工作，减轻劳动强度。<br>步骤1，新建工作簿，将Sheet2工作表名称重命名为“维护”，设置成如图 197 1所示的格式，用来保存收据系统使用过程中必需的信息。</p>
<p>图 197 1    维护表<br>步骤2，因为收据系统是财务方面的系统，在使用时需要相应的权限，需要使用密码登陆，所以需要一个系统登陆窗体。<br>在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加三个标签控件、一个文本框控件、一个组合框和两个按钮按件，在窗体的属性窗口将其Picture属性设置为合适的图片并调整好控件的大小与位置，如图 197 2所示。</p>
<p>图 197 2    系统登陆窗体<br>双击登陆窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal hwnd As Long) As Long
Private Const GWL_STYLE = (-16)
Private Const WS_SYSMENU = &amp;H80000
Private hwnd As Long
Private Sub UserForm_Initialize()
    Dim Istype As Long
    Dim r As Integer
    Dim i As Integer
    hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    Istype = GetWindowLong(hwnd, GWL_STYLE)
    Istype = Istype And Not WS_SYSMENU
    SetWindowLong hwnd, GWL_STYLE, Istype
    DrawMenuBar hwnd
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    For i = 2 To r
        Me.ComboBox1.AddItem Sheet2.Cells(i, 1).Value
    Next
    Me.Label3.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
End Sub
代码解析：
登陆窗体的Initialize事件过程，窗体显示时使用API函数去除窗体的关闭按钮，组合框控件显示所有的用户名。
第1行到第7行代码，API函数声明。
第12行到第16行代码，去除窗体的关闭按钮。请参阅技巧138 。
第18行到第20行代码，组合框控件显示所有的用户名供用户选择。
第21行代码，窗体标签显示使用单位的名称。</code></pre>
<p>双击窗体上的“登陆”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim rng As Range
    If ComboBox1.Value = &quot;&quot; Then
        MsgBox &quot;请选择用户!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet2
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        With .Range(&quot;A2:A&quot; &amp; r)
            Set rng = .Find(What:=ComboBox1, _
                After:=.Cells(.Cells.Count), _
                LookIn:=xlValues, _
                LookAt:=xlWhole, _
                SearchOrder:=xlByRows, _
                SearchDirection:=xlNext, _
                MatchCase:=False)
            If Not rng Is Nothing And rng.Offset(0, 1) = TextBox1 Then
                Sheet2.Range(&quot;C2:C&quot; &amp; r).ClearContents
                rng.Offset(0, 2) = &quot;√&quot;
                Unload Me
                主界面.Show
            Else
                MsgBox &quot;对不起,密码不正确,你无权进入!&quot;, 64, &quot;提示&quot;
                TextBox1 = &quot;&quot;
                TextBox1.SetFocus
            End If
        End With
    End With
End Sub
代码解析：
“登陆”按钮的单击事件过程，在用户选择用户名和输入正确密码后显示“主界面”操作窗体。
第4行到第7行代码，判断是否选择了用户名。第一次使用时默认的用户为“系统管理员”，登陆后可以自行添加其他用户。
第10行到第17行代码，根据所选择的用户在“维护”工作表的A列中查找对应的用户名所在的单元格。
第18行到第27行代码，找到后判断该用户名的密码是否与文本框中输入的密码一致。如果一致则关闭登陆窗体显示“主界面”操作窗体，否则提示用户密码错误。
双击窗体上的“取消”按钮，写入下面的代码：

​```vb
Private Sub CommandButton2_Click()
    Unload Me
    ThisWorkbook.Saved = True
    Application.Quit
End Sub
代码解析：
“取消”按钮的单击事件过程，在用户选择取消后退出程序。
双击窗体上的组合框控件，写入下面的代码：
Private Sub ComboBox1_Change()
    TextBox1.SetFocus
End Sub
代码解析：
组合框控件的Change事件过程，在用户选择用户名后将焦点移到文本框中方便用户输入密码。
步骤3，将Sheet3工作表名称重命名为“存档”，设置成如图 197 3所示的格式，用来保存已填写收据的数据。

图 197 3    存档表
步骤4，“存档”表只是用来保存已开具收据的数据，而收据系统的日常操作都在“主界面”窗体中进行，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个多页（MultiPage）控件和一个状态栏（StatusBar）控件。在MultiPage控件的Page1页上添加一个Image控件和三个标签控件，在第一个标签的属性窗口中将其BackStyle属性设置为0，使标签背景为透明，在其他两个标签的Caption属性中写上版本信息及作者和邮箱，在Image控件的属性窗口将其Picture属性设置为合适的图片并调整好控件的大小与位置，如图 197 4所示。

图 197 4    主界面窗体</code></pre>
<p>双击“主界面”窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function SetMenu Lib &quot;user32&quot; (ByVal hwnd As Long, ByVal hMenu As Long) As Long
Private Declare Function CreateMenu Lib &quot;user32&quot; () As Long
Private Declare Function AppendMenu Lib &quot;user32&quot; Alias &quot;AppendMenuA&quot; (ByVal hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem As Long, ByVal lpNewItem As Any) As Long
Private Declare Function DestroyMenu Lib &quot;user32&quot; (ByVal hMenu As Long) As Long
Private Declare Function CreatePopupMenu Lib &quot;user32&quot; () As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Const GWL_WNDPROC = (-4)
Private Const MF_STRING = &amp;H0&amp;
Private Const MF_POPUP = &amp;H10&amp;
Private Const MF_SEPARATOR = &amp;H800&amp;
Dim MenuWnd As Long, Dump As Long, PopupMenuID As Long, PopupMenuWnd As Long, MenuID As Long
Private Sub UserForm_Initialize()
    Dim i As Integer
    Dim str As String
    Dim arr As Variant
    If Val(Application.Version) &lt; 9 Then
        hwnd = FindWindow(&quot;ThunderXFrame&quot;, Me.Caption)
    Else
        hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    End If
    MenuWnd = CreateMenu()
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;系统(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 100, &quot;单位设置(&amp;C)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 101, &quot;用户设置(&amp;U)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 102, &quot;切换用户(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 103, &quot;密码修改(&amp;P)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 104, &quot;打开Excel(&amp;O)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 105, &quot;退出系统(&amp;Q)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;编辑(&amp;E)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 110, &quot;收款人(&amp;R)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 111, &quot;交款人(&amp;P)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 112, &quot;交款单位(&amp;U)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 113, &quot;常用事由(&amp;S)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 114, &quot;常用备注(&amp;R)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;操作(&amp;O)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 120, &quot;增加(&amp;I)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 121, &quot;查询(&amp;Q)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;帮助(&amp;H)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 130, &quot;帮助(&amp;H)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 131, &quot;关于(&amp;R)&quot;)
    Dump = SetMenu(hwnd, MenuWnd)
    PreWinProc = GetWindowLong(hwnd, GWL_WNDPROC)
    SetWindowLong hwnd, GWL_WNDPROC, AddressOf MsgProcess
    Me.MultiPage1.Value = 0
    For i = 2 To Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
        If Sheet2.Cells(i, 3) = &quot;√&quot; Then
            str = Sheet2.Cells(i, 1)
        End If
    Next
    arr = Array(168, 100, 100, 80)
    With Me.StatusBar1
        For i = 1 To 4
            .Panels.Add(i, , &quot;&quot;).Style = 0
            .Panels(i).Width = arr(i - 1)
        Next
        .Panels(1).Text = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
        .Panels(2).Text = &quot;当前用户：&quot; &amp; str
        .Panels(3).Text = &quot;今天是&quot; &amp; Format(Date, &quot;yyyy年m月d日&quot;)
        .Panels(4).Text = Time
    End With
    Me.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    Me.Label12.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
End Sub
Private Sub UserForm_Terminate()
    DestroyMenu MenuWnd
    DestroyMenu PopupMenuID
    DestroyMenu PopupMenuWnd
    SetWindowLong hwnd, GWL_WNDPROC, PreWinProc
End Sub
代码解析：
“主界面”窗体的Initialize事件过程，窗体显示时使用API函数添加菜单及状态栏信息。
第1行到第13行代码，API函数声明。
第18行到第49行代码，使用API函数添加菜单。请参阅技巧148 。
第50行代码，“主界面”窗体显示时选择MultiPage控件的第一页。
第51行到第55行代码，将当前用户名赋给字符串变量str。
第56行到第66行代码，在状态栏控件中添加四个窗格及显示的信息。请参阅技巧152 。
第67、67行代码，设置“主界面”窗体的标题栏及标签显示的内容。</code></pre>
<p>步骤5，为了使用“主界面”窗体中添加的菜单，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Public PreWinProc As Long, hwnd As Long
Public Declare Function CheckMenuRadioItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal un1 As Long, ByVal un2 As Long, ByVal un3 As Long, ByVal un4 As Long) As Long
Public Declare Function CheckMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDCheckItem As Long, ByVal wCheck As Long) As Long
Public Declare Function EnableMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDEnableItem As Long, ByVal wEnable As Long) As Long
Public Const MF_UNCHECKED = &amp;H0&amp;
Public Const MF_CHECKED = &amp;H8&amp;
Public Const MF_DISABLED = &amp;H2&amp;
Public Const MF_GRAYED = &amp;H1&amp;
Public Const MF_ENABLED = &amp;H0&amp;
Private Declare Function CallWindowProc Lib &quot;user32&quot; Alias &quot;CallWindowProcA&quot; (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetMenu Lib &quot;user32&quot; (ByVal hwnd As Long) As Long
Private Declare Function GetSubMenu Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal nPos As Long) As Long
Private Const MF_BYCOMMAND = &amp;H0&amp;
Public Function MsgProcess(ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
    Dim SubMenu_hWnd As Long
    Select Case wParam
        Case 100
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                设置使用单位.Show
            End If
        Case 101
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                用户设置.Show
            End If
        Case 102
            Unload 主界面
            登陆.Show
        Case 103
            修改密码.Show
        Case 104
            If Sheet2.Cells(2, 3) &lt;&gt; &quot;√&quot; Then
                MsgBox &quot;请使用系统管理员登陆系统!&quot;, 64, &quot;提示&quot;
            Else
                Unload 主界面
                Application.Visible = True
            End If
        Case 105
            If MsgBox(&quot;确定要退出收据系统吗?&quot;, 64 + vbYesNo, &quot;提示&quot;) = vbYes Then
                Unload 主界面
                ThisWorkbook.Save
                Application.Quit
            End If
        Case 110
            主界面.MultiPage1.Value = 0
            编辑收款人.Show
        Case 111
            主界面.MultiPage1.Value = 0
            编辑交款人.Show
        Case 112
            主界面.MultiPage1.Value = 0
            设置交款单位.Show
        Case 113
            主界面.MultiPage1.Value = 0
            编辑常用事由.Show
        Case 114
            主界面.MultiPage1.Value = 0
            编辑常用备注.Show
        Case 120
            主界面.MultiPage1.Value = 1
        Case 121
            主界面.MultiPage1.Value = 2
        Case 130
            帮助.Show
        Case 131
            关于.Show
        Case Else
            MsgProcess = CallWindowProc(PreWinProc, hwnd, Msg, wParam, lParam)
    End Select
End Function
代码解析：
根据“主界面”窗体中添加菜单的ID设置其各项功能。
第1行到第13行代码，API函数声明。
第17行到第22行代码，“系统”菜单中的“单位设置”菜单功能，显示“设置使用单位”窗体设置收据系统的使用单位名称。其中第18、19行代码判断当前用户是否是系统管理员，只有系统管理员才能设置收据系统的使用单位名称。设置单位名称需使用“设置使用单位”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及两个按钮按件，在框架控件中添加一个文本框控件，如图 197 5所示。

图 197 5    设置使用单位窗体</code></pre>
<p>双击窗体中的“确定”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    If Sheet2.Cells(2, 4) &lt;&gt; &quot;&quot; Then
        If MsgBox(&quot;是否重新设置单位名称？&quot;, 36, &quot;提示&quot;) = vbNo Then
            Unload Me
            Exit Sub
        End If
    End If
    If Trim(Me.Frame1.TextBox1.Value) = &quot;&quot; Then
        MsgBox &quot;单位名称不能为空!&quot;, 64, &quot;提示&quot;
        Me.Frame1.TextBox1.SetFocus
        Exit Sub
    End If
    Sheet2.Cells(2, 4) = Trim(Me.Frame1.TextBox1.Value)
    主界面.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    主界面.Label12.Caption = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    主界面.StatusBar1.Panels(1).Text = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot;
    Unload Me
End Sub
重新设置收据系统的使用单位名称并更新“主界面”窗体的标题、标签及状态栏中显示的信息。
第23行到第28行代码，“系统”菜单中的“用户设置”菜单功能，显示“用户设置”窗体设置收据系统的用户名称。其中第24、25行代码判断当前用户是否是系统管理员，只有系统管理员才能设置收据系统的用户。设置用户需使用“用户设置”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加两个框架控件和三个按钮按件，在两个框架控件中分别添加一个列表框控件和一个文本框控件，如图 197 6所示。

图 197 6    用户设置窗体</code></pre>
<p>双击“用户设置”窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim r As Integer
    Dim i As Integer
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    For i = 3 To r
        Me.Frame1.ListBox1.AddItem Sheet2.Cells(i, 1).Value
    Next
    Me.Frame2.TextBox1.SetFocus
End Sub
Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim rng As Range
    If Me.Frame1.ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需删除的用户姓名!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    With Sheet2.Range(&quot;A3:F&quot; &amp; r)
        Set rng = .Find(What:=Me.Frame1.ListBox1.Value, _
            After:=.Cells(.Cells.Count), _
            LookIn:=xlValues, _
            LookAt:=xlWhole, _
            SearchOrder:=xlByRows, _
            SearchDirection:=xlNext, _
            MatchCase:=False)
        If Not rng Is Nothing Then
            rng.Offset(0, 1).Delete Shift:=xlUp
            rng.Delete Shift:=xlUp
            Me.Frame1.ListBox1.RemoveItem (ListBox1.ListIndex)
            MsgBox &quot;已经成功删除!&quot;, 64, &quot;提示&quot;
        End If
    End With
End Sub
Private Sub CommandButton2_Click()
    Dim r As Integer
    With Me.Frame2.TextBox1
        r = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
        If Trim(.Value) = &quot;&quot; Then
            MsgBox &quot;用户姓名不能为空!&quot;, 64, &quot;提示&quot;
            .SetFocus
            Exit Sub
        End If
        If WorksheetFunction.CountIf(Sheet2.Range(&quot;A3:A&quot; &amp; r), Trim(.Text)) &gt; 0 Then
            MsgBox &quot;用户已经存在!&quot;, 64, &quot;提示&quot;
            .Value = &quot;&quot;
            Exit Sub
        End If
        Sheet2.Range(&quot;A&quot; &amp; r + 1) = Trim(.Text)
        Me.Frame1.ListBox1.AddItem Trim(.Text)
        .Value = &quot;&quot;
        .SetFocus
    End With
    MsgBox &quot;用户成功增加!&quot;, 64, &quot;提示&quot;
End Sub
Private Sub CommandButton3_Click()
    Unload Me
End Sub
“用户设置”窗体显示时列表框控件显示系统中已有用户的名称，因为系统管理员是不能删除的，所以并不显示。单击“删除”按钮可以删除列表框中选中的用户。单击“增加”按钮可以新增用户，新增用户的初始密码为空，登陆系统后可以重新设置密码。
第29行到第31行代码，“系统”菜单中的“切换用户”菜单功能，关闭主界面窗体，显示系统登陆窗体。
第32、33行代码，“系统”菜单中的“密码修改”菜单功能，显示“密码修改”窗体重新设置当前用户的密码，设置用户密码需使用“密码修改”窗体，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架和两个按钮按件，在框架控件中添加三个标签控件及三个文本框控件，如图 197 7所示。

图 197 7    密码修改窗体</code></pre>
<p>双击“密码修改”窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    Dim p As Integer
    Dim Password As String
    With Sheet2
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        For i = 2 To r
            If .Cells(i, 3) = &quot;√&quot; Then
                Password = .Cells(i, 2).Text
                p = i
                Exit For
            End If
        Next
        If Me.TextBox1.Text &lt;&gt; Password Then
            MsgBox &quot;对不起,密码不正确,你无权修改!&quot;, 64, &quot;提示&quot;
            Me.TextBox1 = &quot;&quot;
            Me.TextBox1.SetFocus
            Exit Sub
        End If
        If Me.TextBox2.Text &lt;&gt; Me.TextBox3.Text Then
            MsgBox &quot;确认密码不一致,请重新输入!&quot;, 64, &quot;提示&quot;
            Me.TextBox3 = &quot;&quot;
            Me.TextBox3.SetFocus
            Exit Sub
        End If
        .Cells(p, 2) = Me.TextBox3.Text
    End With
    Unload Me
End Sub
使用“密码修改”窗体可以重新设置当前用户的密码。第15行到第20行代码判断所输入的旧密码是否正确，第21行到第26行代码判断两次输入的新密码是否一致，第27行代码，将新密码写入到工作表中。
第34行到第40行代码，“系统”菜单中的“打开Excel”菜单功能，收据系统日常使用时只能在“主界面窗体”中操作，只有系统管理员才能打开工作表对其进行维护。
第41行到第46行代码，“系统”菜单中的“退出系统”菜单功能，关闭Excel程序。
第47行第61行代码，“编辑”菜单的各项功能，对使用收据系统所需的一些信息进行添加和删除。其中第47、48行代码显示“编辑收款人”窗体对常用收款人进行编辑，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加两个框架控件和三个按钮按件，在框架控件中分别添加一个列表框控件和一个文本框控件，如图 197 8所示。

图 197 8    编辑收款人窗体
其他窗体与“编辑收款人”窗体类似，窗体中的代码请参考“用户设置”窗体中的代码。
第62、63行代码，“操作”菜单中的“增加”菜单功能，选择主界面窗体中多页控件的Page2页，可以填写、打印收据。
第64、65行代码，“操作”菜单中的“查询”菜单功能，选择主界面窗体中多页控件的Page3页，可以对已填写收据进行查询、打印。
第66、67行代码，“帮助”菜单中的“关于”菜单功能，显示“关于”窗体。
第68、69行代码，“帮助”菜单中的“帮助”菜单功能，显示“帮助”窗体。
步骤6，在VBE窗口中选择“主界面”窗体的Page2页，在Page2页中添加一个框架控件和四个按钮控件，框架控件中添加六个文本框控件、四个组合框控件、一个DTP控件及相应的标签，如图 197 9所示。

图 197 9    Page2页中的控件</code></pre>
<p>双击窗体上的“新增”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    Dim Number As String
    With Sheet2
        If .Range(&quot;D2&quot;) = &quot;&quot; Then
            MsgBox &quot;请先设置使用单位!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        MultiPage1.Page2.TextBox2 = .Range(&quot;D2&quot;)
        If .Cells(2, 3) = &quot;√&quot; Then
            MsgBox &quot;请以用户身份登陆!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        For i = 3 To r
            If .Cells(i, 3) = &quot;√&quot; Then
                MultiPage1.Page2.TextBox5 = .Cells(i, 1)
            End If
        Next
    End With
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        If .Range(&quot;A2&quot;) = &quot;&quot; Then
            Number = Year(DTPicker1.Value) &amp; Format(1, &quot;0000&quot;)
        End If
        If Val(Year(DTPicker1.Value)) &gt; Val(Left(.Range(&quot;A&quot; &amp; r).Value, 4)) Then
            Number = Year(DTPicker1.Value) &amp; Format(1, &quot;0000&quot;)
        Else
            Number = Format(.Range(&quot;A&quot; &amp; r).Value + 1, &quot;00000000&quot;)
        End If
    End With
    With MultiPage1.Page2
        .ComboBox1.Value = &quot;&quot;
        .ComboBox2.Value = &quot;&quot;
        .ComboBox3.Value = &quot;&quot;
        .ComboBox4.Value = &quot;&quot;
        .TextBox1.Value = Number
        .TextBox3.Value = &quot;&quot;
        .TextBox4.Value = &quot;&quot;
        .TextBox6.Value = &quot;&quot;
    End With
End Sub
代码解析：
“新增”按钮的单击过程，将收据号码、使用单位及用户名称显示在文本框中。
第6行到第9行代码，判断收据系统是否已设置使用单位。
第10行代码，将工作表中已设置好的单位名称显示在“收款单位名称”文本框中。
第11行到第14行代码，判断当前用户是否是系统管理员，系统管理员不能进行新增收据的操作。
第15行到第20行代码，将当前用户名显示在“签发人”文本框中。
第23行到第26行代码，判断收据系统是否第一次使用。如果是第一次使用，新增收据号码为当前年份加0001。
第27、28行代码，判断收据系统是否是跨年度使用。如果是跨年度使用，新增收据号码为当前年份加0001。
第30行代码，如果收据系统是本年度中正常使用且已开具过收据，新增收据号码为最后所开具的收据号码加一。
第33行到第42行代码，将收据号码显示在“收据号码”文本框中并清除其他内容。
填写完毕的收据需保存到工作表中，将Sheet3工作表重命名为“存档”表并设置成如图 197 10所示的格式用来保存已开具收据的内容。

图 197 10    “存档”表</code></pre>
<p>双击窗体上的“保存”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim r As Integer
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    If MultiPage1.Page2.TextBox1 = &quot;&quot; Then
        MsgBox &quot;没有可保存的收据,请选择新增按钮!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If WorksheetFunction.CountIf(Sheet3.Range(&quot;A2:A&quot; &amp; r), Trim(MultiPage1.Page2.TextBox1.Text)) &gt; 0 Then
        MsgBox &quot;收据已经保存!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If If Sheet3.Range(&quot;A2&quot;) &lt;&gt; &quot;&quot; And MultiPage1.Page2.DTPicker1.Value &lt; Sheet3.Cells(r, 2) Then
        MsgBox &quot;日期错误，请重新选择日期!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox4.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款事由!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox4.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox1.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款单位!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox1.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox2.Value = &quot;&quot; Then
        MsgBox &quot;请填写收款人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox2.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.ComboBox3.Value = &quot;&quot; Then
        MsgBox &quot;请填写交款人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.ComboBox3.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.TextBox4.Value = &quot;&quot; Then
        MsgBox &quot;请填写收款金额!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.TextBox4.SetFocus
        Exit Sub
    End If
    If MultiPage1.Page2.TextBox6.Value = &quot;&quot; Then
        MsgBox &quot;请填写备注!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page2.TextBox6.SetFocus
        Exit Sub
    End If
    With Sheet3
        .Cells(r + 1, 1) = MultiPage1.Page2.TextBox1.Value
        .Cells(r + 1, 2) = MultiPage1.Page2.DTPicker1.Value
        .Cells(r + 1, 3) = MultiPage1.Page2.ComboBox4.Value
        .Cells(r + 1, 4) = MultiPage1.Page2.ComboBox1.Value
        .Cells(r + 1, 5) = MultiPage1.Page2.ComboBox3.Value
        .Cells(r + 1, 6) = MultiPage1.Page2.TextBox2.Value
        .Cells(r + 1, 7) = MultiPage1.Page2.ComboBox2.Value
        .Cells(r + 1, 8) = MultiPage1.Page2.TextBox3.Value
        .Cells(r + 1, 9) = MultiPage1.Page2.TextBox4.Value
        .Cells(r + 1, 10) = MultiPage1.Page2.TextBox6.Value
        .Cells(r + 1, 11) = MultiPage1.Page2.TextBox2.Value
        .Cells(r + 1, 12) = MultiPage1.Page2.TextBox5.Value
    End With
    Sheet4.Range(&quot;K1&quot;) = MultiPage1.Page2.TextBox1.Value
    MsgBox &quot;收据已保存，请打印!&quot;, 64, &quot;提示&quot;
End Sub
代码解析：
“保存”按钮的单击过程，将填写完整的收据内容保存到“存档”表中。
第4行到第7行代码，判断是否已选择“新增”按钮。因为“收据号码”文本框中的号码是不能通过手工输入的，只能选择“新增”按钮由系统输入。
第8行到第11行代码，判断收据号码与“存档”表中保存的收据号码是否重复，使同一收据不能重复保存。
第12行到第15行代码，判断收据日期是否大于等于“存档”表中保存的最后一张收据的日期，使收据只能按日期顺序开具。
第16行到第45行代码，判断收据内容是否填写完整。
第46行到第59行代码，将收据内容保存到“存档”表的最后一行。
第60行代码，将所开收据的号码写入到“打印”表的K1单元格。
收据保存后需要打印，将Sheet4工作表重命名为“打印”表。因为笔者所在单位不使用针式打印机，不能进行套打，所以只能将“打印”表设置成如图 197 11所示的格式，使用激光打印机打印。如果需要进行套打，只需按所要打印收据的页面重新进行设置即可。

图 197 11    打印表
“打印”表中的单元格写入VLOOKUP函数，根据K1单元格中的号码在“存档”表中查找相应的数据显示在各单元格中。</code></pre>
<p>双击窗体上的“打印”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim rng As Range
    With Sheet3
        r = .Range(&quot;A65536&quot;).End(xlUp).Row
        If MultiPage1.Page2.TextBox1.Value = &quot;&quot; Then
            MsgBox &quot;没有可打印的收据!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        If WorksheetFunction.CountIf(.Range(&quot;A2:A&quot; &amp; r), Trim(MultiPage1.Page2.TextBox1.Text)) = 0 Then
            MsgBox &quot;请保存后再打印!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        With .Range(&quot;A2:A&quot; &amp; r)
            Set rng = .Find(What:=MultiPage1.Page2.TextBox1.Value, _
                After:=.Cells(.Cells.Count), _
                LookIn:=xlValues, _
                LookAt:=xlWhole, _
                SearchOrder:=xlByRows, _
                SearchDirection:=xlNext, _
                MatchCase:=False)
            If Not rng Is Nothing Then
                If rng.Offset(0, 12).Text = &quot;√&quot; Then
                    MsgBox &quot;已经打印的收据不可再打印!&quot;, 64, &quot;提示&quot;
                    Exit Sub
                End If
            End If
        End With
        .Range(&quot;M&quot; &amp; r).Value = &quot;√&quot;
    End With
    Sheet4.Range(&quot;K1&quot;) = MultiPage1.Page2.TextBox1.Value
    Sheet4.PrintOut
End Sub
代码解析：
“打印”按钮的单击过程，打印收据。
第6行到第9行代码，判断是否有需要打印的收据。
第10行到第13行代码，判断当前收据是否已经保存。
第14行到第28行代码，判断当前收据是否已经打印。已经打印过的收据在“存档”表的M列中会写上已打印标识“√”。
第29行代码，在“存档”表的该收据内容所在的M列中写上已打印标识“√”。
第31、32行代码，将收据号码写入到“打印”表的K1单元格，打印该收据。</code></pre>
<p>双击窗体上的“取消”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton4_Click()
    With MultiPage1.Page2
        .ComboBox1.Value = &quot;&quot;
        .ComboBox2.Value = &quot;&quot;
        .ComboBox3.Value = &quot;&quot;
        .ComboBox4.Value = &quot;&quot;
        .TextBox1.Value = &quot;&quot;
        .TextBox3.Value = &quot;&quot;
        .TextBox4.Value = &quot;&quot;
        .TextBox6.Value = &quot;&quot;
    End With
    主界面.MultiPage1.Value = 0
End Sub
代码解析：
“取消”按钮的单击过程，清除数据并返回主界面的Page1页面。
为了方便收据的填写，在开具收据时，日期由DTP控件选择，事由、单位名称、收款人及交款人可以手工输入，也可以从窗体中的组合框中选择已有的信息。</code></pre>
<p>双击MultiPage1控件写入下面的代码：</p>
<pre><code class="vb">Private Sub MultiPage1_Change()
    Dim i As Integer
    Dim c As Integer
    Select Case MultiPage1.Value
        Case 1
            For c = 1 To 4
                MultiPage1.Page2.Controls(&quot;ComboBox&quot; &amp; c).Clear
                For i = 2 To Sheet2.Cells(65536, c + 4).End(xlUp).Row
                    MultiPage1.Page2.Controls(&quot;ComboBox&quot; &amp; c).AddItem Sheet2.Cells(i, c + 4).Value
                Next
            Next
            MultiPage1.Page2.DTPicker1 = Date
        Case 2
            With MultiPage1.Page3.ListView1
                .ListItems.Clear
                .ColumnHeaders.Add , , Space(3) &amp; &quot;号码&quot;, 54, 0
                .ColumnHeaders.Add , , Space(3) &amp; &quot;日期&quot;, 54, 0
                .ColumnHeaders.Add , , Space(12) &amp; &quot;事由&quot;, 130, 0
                .ColumnHeaders.Add , , Space(6) &amp; &quot;交款单位&quot;, 100, 0
                .ColumnHeaders.Add , , &quot;交款人&quot;, 40, 0
                .ColumnHeaders.Add , , Space(6) &amp; &quot;收款单位&quot;, 90, 0
                .ColumnHeaders.Add , , &quot;收款人&quot;, 40, 0
                .ColumnHeaders.Add , , Space(10) &amp; &quot;金额大写&quot;, 130, 0
                .ColumnHeaders.Add , , &quot;金额小写&quot;, 50, 1
                .ColumnHeaders.Add , , Space(14) &amp; &quot;备注&quot;, 150, 0
                .ColumnHeaders.Add , , Space(5) &amp; &quot;填发单位&quot;, 84, 0
                .ColumnHeaders.Add , , &quot;签发人&quot;, 40, 0
                .View = lvwReport
                .Gridlines = True
                .FullRowSelect = True
            End With
    End Select
End Sub
代码解析：
MultiPage控件的Change事件过程。
第6行到第12行代码，当选择MultiPage控件的Page2页面新增收据时，将“维护”表中所保存的信息加载到组合框中，并将DTP控件的日期设置为当前日期。
第13行到第31行代码，当选择MultiPage控件的Page3页面查询收据时，为Page3页中的ListView控件添加列标题。请参阅技巧131 。
为了将输入的小写金额转换为人民币大写金额，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：
Public Function RMBDX(M)
    On Error Resume Next
    RMBDX = Replace(Application.Text(Round(M + 0.00000001, 2), &quot;[DBnum2]&quot;), &quot;.&quot;, &quot;元&quot;)
    RMBDX = IIf(Left(Right(RMBDX, 3), 1) = &quot;元&quot;, Left(RMBDX, Len(RMBDX) - 1) &amp; &quot;角&quot; &amp; Right(RMBDX, 1) &amp; &quot;分&quot;, IIf(Left(Right(RMBDX, 2), 1) = &quot;元&quot;, RMBDX &amp; &quot;角整&quot;, IIf(RMBDX = &quot;零&quot;, &quot;&quot;, RMBDX &amp; &quot;元整&quot;)))
    RMBDX = Replace(Replace(Replace(Replace(RMBDX, &quot;零元零角&quot;, &quot;&quot;), &quot;零元&quot;, &quot;&quot;), &quot;零角&quot;, &quot;零&quot;), &quot;-&quot;, &quot;负&quot;)
End Function
代码解析：
自定义RMBDX函数，将小写金额转换为人民币大写金额，请参阅技巧163 。</code></pre>
<p>双击小写金额文本框，写入下面的代码：</p>
<pre><code class="vb">Private Sub TextBox4_Change()
    If Not IsNumeric(TextBox4.Text) And TextBox4.Text &lt;&gt; &quot;&quot; Then
        MsgBox &quot;请输入正确的小写金额!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    MultiPage1.Page2.TextBox3 = RMBDX(MultiPage1.Page2.TextBox4.Value)
End Sub
Private Sub TextBox4_AfterUpdate()
    Me.TextBox4.Value = Format(TextBox4.Value, &quot;0.00&quot;)
End Sub
代码解析：
第1行到第6行代码，文本框的Change事件过程，将小写文本框中输入的正确的小写金额转换为人民币大写金额写入到大写文本框中。
第8行到第10行代码，文本框的AfterUpdate事件过程，将小写金额格式化为两位小数格式。
备注可以手工输入，也可以从窗体中选择已有的信息。在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个MultiPage控件和两个按钮按件，在MultiPage控件的Page1页中添加一个框架控件，在框架控件中添加六个文本框控件和六个标签控件，如图 197 12所示。

图 197 12输入常用备注窗体（一）
在MultiPage控件的Page2页中添加一个框架控件，在框架控件中添加两个文本框控件和两个标签控件，如图 197 13所示。

图 197 13输入常用备注窗体（二）
在MultiPage控件的Page3页中添加一个框架控件，在框架控件中添加一个列表框控件，如图 197 14所示。

图 197 14输入常用备注窗体（三）</code></pre>
<p>双击“输入常用备注”窗体，写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim r As Integer
    Dim i As Integer
    MultiPage1.Value = 0
    r = Sheet2.Range(&quot;I65536&quot;).End(xlUp).Row
    For i = 2 To r
        MultiPage1.Page3.ListBox1.AddItem Sheet2.Cells(i, 9).Value
    Next
End Sub
代码解析：
“输入常用备注”窗体的Initialize事件，窗体显示时MultiPage控件选择Page1页并将“维护”表中保存的常用备注信息加载到Page3页的列表框中。</code></pre>
<p>双击“输入常用备注”窗体的“确定”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim str As String
    Dim dou As Double
    Dim i As Integer
    With MultiPage1
        Select Case .Value
            Case 0
                For i = 1 To 6
                    str = str &amp; .Page1.Controls(&quot;Label&quot; &amp; i) &amp; Chr(9) &amp; .Page1.Controls(&quot;TextBox&quot; &amp; i) &amp; &quot;元&quot; &amp; Chr(9)
                    If i = 2 Or i = 4 Then
                        str = str &amp; Chr(10)
                    End If
                    dou = dou + Val(.Page1.Controls(&quot;TextBox&quot; &amp; i).Value)
                Next
            Case 1
                For i = 7 To 8
                    str = str &amp; .Page2.Controls(&quot;Label&quot; &amp; i) &amp; .Page2.Controls(&quot;TextBox&quot; &amp; i) &amp; &quot;元&quot; &amp; Chr(9)
                    dou = dou + Val(.Page2.Controls(&quot;TextBox&quot; &amp; i).Value)
                Next
            Case 2
                str = .Page3.ListBox1.Value
                dou = 0
        End Select
    End With
    With 主界面.MultiPage1.Page2
        .TextBox6 = str
        .TextBox4 = IIf(dou &lt;&gt; 0, Format(dou, &quot;0.00&quot;), .TextBox4)
    End With
    Unload Me
End Sub
代码解析：
“输入常用备注”窗体中“确定”按钮的单击过程，将常用备注及小写金额写入到主界面窗体的备注文本框及小写金额文本框中。</code></pre>
<p>双击“输入常用备注”窗体中Page3页的列表框，写入下面的代码：</p>
<pre><code class="vb">Private Sub ListBox1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    主界面.MultiPage1.Page2.TextBox6 = MultiPage1.Page3.ListBox1
    Unload Me
End Sub
代码解析：
“输入常用备注”窗体中列表框的双击过程，将选中的备注写入到主界面窗体的备注文本框中。</code></pre>
<p>双击“输入常用备注”窗体中的TextBox1文本框，写入下面的代码：</p>
<pre><code class="vb">Private Sub TextBox1_AfterUpdate()
    MultiPage1.Page1.TextBox1 = Format(MultiPage1.Page1.TextBox1, &quot;0.00&quot;)
End Sub
代码解析：
“输入常用备注”窗体中文本框的AfterUpdate事件过程，将金额格式化为两位小数格式。其他文本框设置与之相同。
步骤7，在VBE窗口中选择“主界面”窗体的Page3页，在Page3页中添加一个ListView控件和三个按钮控件，如图 197 15所示。

图 197 15    Page3页中的控件</code></pre>
<p>双击窗体中的“查询”按钮，写入下面的代码：</p>
<pre><code>Private Sub CommandButton6_Click()
    Dim Itm As ListItem
    Dim r As Integer
    Dim c As Integer
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    With MultiPage1.Page3.ListView1
        .ListItems.Clear
        For r = 2 To r
            Set Itm = .ListItems.Add()
            Itm.Text = Space(2) &amp; Sheet3.Cells(r, 1)
            For c = 1 To 11
                Itm.SubItems(c) = Sheet3.Cells(r, c + 1)
            Next
            Itm.SubItems(1) = Format(Itm.SubItems(1), &quot;yyyy-mm-dd&quot;)
            Itm.SubItems(8) = Format(Itm.SubItems(8), &quot;0.00&quot;)
        Next
    End With
    Set Itm = Nothing
End Sub
代码解析：
“查询”按钮的单击过程，将“存档”表中已开具收据的信息显示到ListView控件中，请参阅技巧131 。</code></pre><p>双击窗体中的“打印”按钮，写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton5_Click()
    Dim r As Integer
    Dim rng As Range
    Dim str As String
    str = Val(MultiPage1.Page3.ListView1.SelectedItem)
    r = Sheet3.Range(&quot;A65536&quot;).End(xlUp).Row
    With Sheet3.Range(&quot;A2:A&quot; &amp; r)
        Set rng = .Find(What:=str, _
            After:=.Cells(.Cells.Count), _
            LookIn:=xlValues, _
            LookAt:=xlWhole, _
            SearchOrder:=xlByRows, _
            SearchDirection:=xlNext, _
            MatchCase:=False)
        If Not rng Is Nothing Then
            If rng.Offset(0, 12).Text = &quot;√&quot; Then
                MsgBox &quot;已经打印的收据不可再打印!&quot;, 64, &quot;提示&quot;
            Else
                With Sheet4
                    .Range(&quot;K1&quot;) = str
                    .PrintOut
                End With
                Sheet3.Range(&quot;M&quot; &amp; rng.Row).Value = &quot;√&quot;
            End If
        End If
    End With
End Sub
代码解析：
“打印”按钮的单击过程，打印“存档”表中已开具保存还没有打印的收据。
第5行代码，将ListView控件中所选中的收据号码赋给变量str。
第7行到第14行代码，使用该号码在“存档”表中查找数据。
第16、17行代码，如果该号码所在行的M列已有打印标识则不能打印。
第20、21行代码，如果该号码没有打印则将号码写入到“打印”表的K1单元格并打印收据。
在日常使用时，已经打印过后收据是不能重复打印的，如果确实需要重新打印收据，可以使用系统管理员身份进入系统，在窗体菜单中打开Excel，删除该收据在“存档”表M列中的打印标识。</code></pre>
<p>步骤8，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件，在框架控件中添加一个标签控件，双击窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim str As String
    str = Space(4) &amp; &quot;欢迎使用&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;使用前请仔细阅读使用说明：&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;一、第一次使用本系统时请以系统管理员身份登陆。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;二、第一次使用本系统时请先设置使用单位和添加用户。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;三、常用信息可以自行增加及删除。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;四、开具的收据只能打印一次，未打印的收据可以在查询界面中补充打印。&quot; &amp; vbLf _
        &amp; vbLf _
        &amp; Space(4) &amp; &quot;使用过程中如有问题或好的建议请与我联系：&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;Tel：0513-86548930&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;Tel：13861958666&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;E-mail： yuanzhuping@yeah.net&quot;
    Label8.Caption = str
    Label8.Height = 150
    Label8.Top = 6
    Label8.Left = 6
    Frame1.ScrollBars = fmScrollBarsVertical
    Frame1.ScrollHeight = Label8.Height
End Sub
代码解析：
使用窗体显示系统帮助信息，请参阅技巧122 。窗体运行后效果如图 197 16所示。

图 197 16    帮助窗体</code></pre>
<p>在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个Image控件和一个框架控件，在框架控件中添加一个Image控件和一个标签控件，在Image控件的属性窗口将其Picture属性设置为合适的图片，双击窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim str As String
    str = Sheet2.Cells(2, 4) &amp; &quot;收据系统&quot; &amp; vbLf _
        &amp; &quot;版本： V2.0.00&quot; &amp; vbLf _
        &amp; &quot;版权： (C) 2009-2022&quot; &amp; vbLf _
        &amp; &quot;作者： yuanzhuping (2009-7-8)&quot; &amp; vbLf _
        &amp; &quot;邮箱： yuanzhuping@yeah.net &quot;
    Label1.Caption = str
End Sub
代码解析：
使用窗体显示系统信息，运行后效果如图 197 17所示。

图 197 17    关于窗体
步骤9，在“主界面”窗体的属性窗口中选择MultiPage控件，将其Style属性设置为2，使其不显示MultiPage控件的标签。</code></pre>
<p>步骤10，因为收据系统正常使用时只需在“主界面”窗体操作，所以需要隐藏工作簿。在VBE的“工程”窗口双击ThisWorkbook，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Application.Visible = False
    登陆.Show
End Sub
代码解析：
收据系统打开时隐藏工作簿，显示“登陆”窗体供用户登陆。
步骤11，使用收据系统，在打开时必需启用宏，所以将工作簿设置为禁用宏则关闭工作簿。请参阅技巧44 。
步骤12，设置VBA工程的密码。示例VBA工程密码为六个8。
保存工作簿后重新打开，显示如图 197 18所示的“登陆”窗体供用户登陆，第一次使用时默认用户为“系统管理员”，初始密码为六个8。

图 197 18    用户登陆
在密码输入框中输入正确的密码后按“登陆”按钮后显示如图 197 19所示的“主界面”操作窗体。

图 197 19    主界面
选择“系统”菜单，设置使用单位和用户后选择“操作”菜单中的“增加”菜单，进入如图 197 20所示的新增收据界面。

图 197 20    新增收据界面
选择“操作”菜单中的“查询”菜单，进入收据查询界面，按“查询”按钮后查询结果如图 197 21所示。

图 197 21    查询收据界面</code></pre>
<h3 id="技巧198-职工考勤系统"><a href="#技巧198-职工考勤系统" class="headerlink" title="技巧198     职工考勤系统"></a>技巧198     职工考勤系统</h3><p>笔者所在单位没有使用电子考勤，每到月底各部门需手工填写部门所有职工的考勤考核表及部门的考勤汇总表，工作量大、出错机率高、统计分析麻烦，因此使用VBA开发的考勤系统可以使部门考勤员简化工作，提高工作效率。<br>步骤1，新建工作簿，将Sheet1工作表名称重命名为“资料”，设置成如图 198 1所示的格式，用来保存考勤系统使用过程中必需的资料。<br>“资料”表中的B1单元格保存单位的名称，B2单元格保存考勤周期中开始考勤的日期，第三行以下用于保存考勤部门的资料，其中第四列往右的单元格保存部门职工的资料。</p>
<p>图 198 1    资料表格式<br>步骤2，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件和两个按钮按件，在框架控件添加两个标签控件、一个文本框控件及一个组合框控件，调整好控件的大小与位置，如图 198 2所示。</p>
<p>图 198 2    单位设置窗体<br>单位设置窗体用于设置使用单位及开始考勤的日期，双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim arr As Variant
    TextBox1.SetFocus
    arr = Array(&quot;26日-25日&quot;, &quot;27日-26日&quot;, &quot;28日-27日&quot;, &quot;1日-31日&quot;, &quot;2日-1日&quot;, &quot;3日-2日&quot;, &quot;4日-3日&quot;, &quot;5日-4日&quot;)
    With ComboBox1
        .List = arr
        .ListIndex = 0
    End With
End Sub
代码解析：
单位设置窗体的初始化事件，为组合框控件添加考勤周期。</code></pre>
<p>双击窗体中的“确定”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    If Trim(TextBox1) = &quot;&quot; Then
        MsgBox &quot;请输入单位名称!&quot;, 64, &quot;提示&quot;
        TextBox1.SetFocus
        Exit Sub
    End If
    With Sheet1
        .Cells(1, 2) = Trim(TextBox1.Text)
        .Cells(2, 2) = Val(ComboBox1.Text)
        Application.Caption = .Cells(1, 2)
    End With
    Unload Me
End Sub
代码解析：
单位设置窗体中“确定”按钮的单击事件，将输入的单位名称及考勤周期的开始日期录入到”资料”表中并更新工作簿标题。
步骤3，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个MultiPage（多页）控件，将MultiPage控件中的Page分别重命名为“增加”、“删除”和“编辑”。
在“增加”页中添加一个框架控件和两个按钮按件，在框架控件添加三个标签控件及三个文本框控件，调整好控件的大小与位置，如图 198 3所示。

图 198 3    部门增加页</code></pre>
<p>双击“增加”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    If Trim(MultiPage1.Page1.TextBox1.Text) = &quot;&quot; Then
        MsgBox &quot;请输入部门名称!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox1.SetFocus
        Exit Sub
    End If
    If Application.CountIf(Sheet1.Range(&quot;A:A&quot;), MultiPage1.Page1.TextBox1.Text) &gt; 0 Then
        MsgBox &quot;部门名称已经存在,请重新输入!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox1.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page1.TextBox2.Text) = &quot;&quot; Then
        MsgBox &quot;请输入部门负责人姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox2.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page1.TextBox3.Text) = &quot;&quot; Then
        MsgBox &quot;请输入考勤员姓名!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page1.TextBox3.SetFocus
        Exit Sub
    End If
    For i = 1 To 3
        Sheet1.Cells(r + 1, i) = MultiPage1.Page1.Controls(&quot;TextBox&quot; &amp; i)
    Next
    MsgBox &quot;部门已成功增加,请增加部门人员!&quot;, 64, &quot;提示&quot;
    Unload Me
End Sub
代码解析：
部门设置窗体中“增加”按钮的单击事件，将输入的部门名称、部门负责人及部门考勤员录入到”资料”表中。
第5行到第9行代码，判断是否已输入部门名称。
第10行到第14行代码，判断输入的部门名称是否重复。
第15行到第19行代码，判断是否已输入部门负责人姓名。
第20行到第24行代码，判断是否已输入部门考勤员姓名。
第25行到第27行代码，将所输入的部门信息录入中资料表的最后一行。
在“删除”页中添加一个框架控件和两个按钮按件，在框架控件添加一个列表框控件，调整好控件的大小与位置，如图 198 4所示。

图 198 4    部门删除页</code></pre>
<p>双击“删除”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim r As Integer
    Dim s As String
    Dim i As Integer
    r = Sheet1.Range(&quot;a65536&quot;).End(xlUp).Row
    If MultiPage1.Page2.ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需要删除的部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    s = MultiPage1.Page2.ListBox1.Text
    If MsgBox(&quot;确定要删除&quot; &amp; s &amp; &quot;吗?&quot;, 36, &quot;警告&quot;) = 6 Then
        For i = 4 To r
            If s = Sheet1.Cells(i, 1) Then
                Sheet1.Cells(i, 1).EntireRow.Delete
                MultiPage1.Page2.ListBox1.RemoveItem (ListBox1.ListIndex)
                MsgBox s &amp; &quot;已经成功删除!&quot;, 64, &quot;提示&quot;
            End If
        Next
    End If
    Unload Me
End Sub
代码解析：
部门设置窗体中“删除”按钮的单击事件，删除“资料”表中已保存的部门资料。
第6行到第9行代码，判断在列表框中是否已选择了要删除的部门。
第10行代码，将所要删除的部门名称赋给变量s。
第14行代码，将“资料”表中该部门所在的行删除。
第15行代码，将列表框中该部门所在的行删除。
在“编辑”页中添加一个框架控件和两个按钮按件，在框架控件添加四个标签控件、一个组合框控件及三个文本框控件，调整好控件的大小与位置，如图 198 5所示。

图 198 5    部门编辑页</code></pre>
<p>双击窗体中的组合框控件，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub ComboBox1_Change()
    Dim r As Integer
    Dim c As Integer
    For r = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If MultiPage1.Page3.ComboBox1 = Sheet1.Cells(r, 1) Then
            For c = 1 To 3
                MultiPage1.Page3.Controls(&quot;TextBox&quot; &amp; c + 3) = Sheet1.Cells(r, c)
            Next
        End If
    Next
End Sub
代码解析：
组合框控件的Change事件，当用户选择所需编辑的部门名称后，文本框中显示该部门编辑前的信息。</code></pre>
<p>双击“编辑”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim r As Integer
    Dim i As Integer
    Dim j As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    If MultiPage1.Page3.ComboBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需要编辑的部门名称!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox4.Text) = &quot;&quot; Then
        MsgBox &quot;部门名称不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox4.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox5.Text) = &quot;&quot; Then
        MsgBox &quot;部门负责人不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox5.SetFocus
        Exit Sub
    End If
    If Trim(MultiPage1.Page3.TextBox6.Text) = &quot;&quot; Then
        MsgBox &quot;部门考勤员不能为空!&quot;, 64, &quot;提示&quot;
        MultiPage1.Page3.TextBox6.SetFocus
        Exit Sub
    End If
    If MsgBox(&quot;是否重新编辑&quot; &amp; MultiPage1.Page3.ComboBox1 &amp; &quot;的信息?&quot;, 36, &quot;提示&quot;) = 6 Then
        For i = 4 To r
            If MultiPage1.Page3.ComboBox1 = Sheet1.Cells(i, 1) Then
                For j = 1 To 3
                    Sheet1.Cells(i, j) = MultiPage1.Page3.Controls(&quot;TextBox&quot; &amp; j + 3)
                Next
            End If
        Next
    End If
    Unload Me
End Sub
代码解析：
部门设置窗体中“编辑”按钮的单击事件，编辑“资料”表中已保存的部门信息。
第6行到第9行代码，判断是否已选择了部门。
第10行到第14行代码，判断部门名称是否为空。
第15行到第19行代码，判断部门负责人是否为空。
第20行到第24行代码，判断部门考勤员是否为空。
第26行到第32行代码，将重新编辑的部门信息录入中资料表该部门所在的行中。
步骤4，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及一个按钮控件，在框架控件中添加两个标签控件、两个按钮控件、一个组合框控件、一个文本框控件及一个列表框控件，如图 198 6所示。

图 198 6    人员设置窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim i As Integer
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        ComboBox1.AddItem Sheet1.Cells(i, 1)
    Next
    ComboBox1.ListIndex = -1
End Sub
代码解析：
人员设置窗体的初始化事件，为组合框控件添加部门名称。
双击窗体上的组合框控件，在打开的代码窗口写入下面的代码：
Private Sub ComboBox1_Change()
    Dim r As Integer
    Dim c As Integer
    For r = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If ComboBox1.Text = Sheet1.Cells(r, 1) Then
            ListBox1.Clear
            For c = 4 To Sheet1.Cells(r, 255).End(xlToLeft).Column
                ListBox1.AddItem Sheet1.Cells(r, c).Value
            Next
        End If
    Next
    TextBox1.SetFocus
End Sub
代码解析：
组合框控件的Change事件，当用户选择所需增加或删除人员的部门名称后，文本框中显示该部门中已有的人员姓名。</code></pre>
<p>双击窗体上的“增加”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim c As Integer
    If ComboBox1.Text = &quot;&quot; Then
        MsgBox &quot;请选择增加人员的部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If Trim(TextBox1.Text) = &quot;&quot; Then
        MsgBox &quot;请输入人员姓名!&quot;, 64, &quot;提示&quot;
        TextBox1.SetFocus
        Exit Sub
    End If
    With Sheet1
        For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = .Cells(i, 1) Then
                c = .Cells(i, 255).End(xlToLeft).Column
                If Application.CountIf(.Range(.Cells(i, 4), .Cells(i, c)), TextBox1) &gt; 0 Then
                    MsgBox &quot;人员姓名重复,请重新输入!&quot;, 64, &quot;提示&quot;
                    TextBox1 = &quot;&quot;
                    TextBox1.SetFocus
                    Exit Sub
                Else
                    .Cells(i, c + 1) = TextBox1
                    ListBox1.AddItem TextBox1
                End If
            End If
        Next
    End With
    TextBox1.Text = &quot;&quot;
    TextBox1.SetFocus
End Sub
代码解析：
人员设置窗体中“增加”按钮的单击事件，将输入的人员姓名保存到“资料”表中该人员所在部门的行中。
第4行到第7行代码，判断是否已选择了所需增加人员的部门。
第8行到第12行代码，判断是否已输入所增加的人员姓名。
第15、16行代码，取得该部门在“资料”表中最右边列的列号。
第17行到第22行代码，判断所增加的人员姓名是否重复。
第23行代码，将所增加的人员姓名保存到“资料”表中。
第24行代码，将增加的人员姓名添加到列表框中。
第29、30行代码，清空文本框以便再次增加部门人员。</code></pre>
<p>双击窗体上的“删除”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim i As Integer
    Dim c As Integer
    Dim j  As Integer
    If ComboBox1.Text = &quot;&quot; Then
        MsgBox &quot;请先选择一个部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    If ListBox1.ListIndex &lt; 0 Then
        MsgBox &quot;请选择需删除的人员姓名!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet1
        If MsgBox(&quot;确定要删除&quot; &amp; ListBox1 &amp; &quot;吗?&quot;, 36, &quot;警告&quot;) = 6 Then
            For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
                If ComboBox1.Text = .Cells(i, 1).Value Then
                    c = .Cells(i, 255).End(xlToLeft).Column
                    For j = 4 To c
                        If .Cells(i, j) = ListBox1 Then
                            .Cells(i, j).Delete Shift:=xlToLeft
                        End If
                    Next
                End If
            Next
            ListBox1.RemoveItem (ListBox1.ListIndex)
        End If
    End With
End Sub
代码解析：
人员设置窗体中“删除”按钮的单击事件，删除所选部门中的人员姓名。
第5行到第8行代码，判断是否已选择了部门。
第9行到第12行代码，判断是否已选择了所需删除的人员。
第13行到第24行代码，删除该人员所在部门保存在“资料”表中该人员的单元格。
第25行代码，从列表框中删除该人员。
设置了使用单位、部门和人员的“资料”表如图 198 7所示。

图 198 7    “资料”表
步骤5，将Sheet3工作表名称重命名为“考勤统计”，设置成如图 198 8所示的格式，用来汇总部门考勤考核数据及打印“考勤统计”表。

图 198 8    “考勤统计”表
步骤6，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及两个按钮控件，在框架控件中添加四个标签控件、一个组合框控件、一个文本框控件和一个SpinButton控件，如图 198 9所示。

图 198 9    部门考勤窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim i As Integer
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        ComboBox1.AddItem Sheet1.Cells(i, 1)
    Next
    ComboBox1.ListIndex = 0
    Label4 = Sheet1.Range(&quot;B1&quot;)
    SpinButton1.Value = Month(Date)
    TextBox1.Text = Year(Date) &amp; &quot;年&quot; &amp; Month(Date) &amp; &quot;月&quot;
End Sub
代码解析：
部门考勤窗体的初始化事件，为组合控件添加部门名称，为文本框控件添加考勤月份。
双击窗体上的SpinButton控件，在打开的代码窗口写入下面的代码：
Private Sub SpinButton1_Change()
    With SpinButton1
        Select Case .Value
            Case 1 To 12
                TextBox1 = Left(TextBox1, 4) &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
            Case Is &gt; 12
                .Value = 1
                TextBox1 = Left(TextBox1, 4) + 1 &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
            Case Is &lt; 1
                .Value = 12
                TextBox1 = Left(TextBox1, 4) - 1 &amp; &quot;年&quot; &amp; .Value &amp; &quot;月&quot;
        End Select
    End With
End Sub
代码解析：
SpinButton控件的Change事件，调节文本框控件中的考勤月份。</code></pre>
<p>双击窗体上的“确定”按钮，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim s As Integer
    Dim Sh As Worksheet
    Dim arr As Variant
    Dim arrName As Variant
    Dim i As Integer
    Dim i1 As Integer
    Dim j As Integer
    Dim j1 As Integer
    Dim r As Integer
    Dim c As Integer
    Dim str As String
    Dim d As Integer
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    For s = Worksheets.Count To 4 Step -1
        Worksheets(s).Delete
    Next
    Application.DisplayAlerts = True
    With Sheet1
        For i = 4 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = .Cells(i, 1) And .Cells(i, 4) = &quot;&quot; Then
                MsgBox &quot;请增加部门人员!&quot;, 64, &quot;提示&quot;
                Unload Me
                Exit Sub
            End If
        Next
    End With
    With Sheet3
        .Unprotect
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        If r &gt;= 50 Then
            .Rows(&quot;50:&quot; &amp; r).Delete Shift:=xlUp
        End If
        .Range(&quot;B1&quot;) = Sheet1.Range(&quot;B1&quot;) &amp; &quot;出缺勤统计表&quot;
        .Range(&quot;C2&quot;) = ComboBox1.Text
        .Range(&quot;O2&quot;) = TextBox1.Text
        For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
            If ComboBox1.Text = Sheet1.Cells(i, 1) Then
                r = Sheet1.Cells(i, 255).End(xlToLeft).Column
                .Range(&quot;C30&quot;) = Sheet1.Cells(i, 2)
                .Range(&quot;O30&quot;) = Sheet1.Cells(i, 3)
                For c = 4 To r
                    .Cells(c + 46, 2) = Sheet1.Cells(i, c)
                Next
            End If
        Next
        r = .Range(&quot;B65536&quot;).End(xlUp).Row
        .Range(&quot;I50:I&quot; &amp; r).FormulaR1C1 = &quot;=SUM(RC[-4]:RC[-1])&quot;
        .Range(&quot;M50:M&quot; &amp; r).FormulaR1C1 = &quot;=SUM(RC[-3]:RC[-1])&quot;
        .Range(&quot;B50:O&quot; &amp; r).Borders.LineStyle = xlContinuous
        .Range(&quot;C50:C&quot; &amp; r).Locked = False
        .Range(&quot;E50:H&quot; &amp; r).Locked = False
        .Range(&quot;J50:L&quot; &amp; r).Locked = False
        .ScrollArea = &quot;&quot;
        Application.Goto Reference:=.Range(&quot;A50&quot;), Scroll:=True
        .ScrollArea = &quot;A50:O&quot; &amp; r
        .Protect
        .EnableSelection = xlUnlockedCells
    End With
    For i = 4 To Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
        If ComboBox1.Text = Sheet1.Cells(i, 1) Then
            c = i
            For j = 4 To Sheet1.Cells(i, 255).End(xlToLeft).Column
                str = str &amp; Sheet1.Cells(i, j) &amp; &quot;,&quot;
            Next
        End If
    Next
    arrName = Split(Left(str, (Len(str) - 1)), &quot;,&quot;)
    For i1 = 0 To UBound(arrName)
        Set Sh = Worksheets.Add(after:=Worksheets(Worksheets.Count))
        With Sh
            .Name = arrName(i1)
            arr = Array(1.75, 4.5, 3, 3, 3, 3, 45, 9, 1.75)
            For i = LBound(arr) To UBound(arr)
                .Columns(i + 1).ColumnWidth = arr(i)
            Next
            arr = Array(33, 24, 18)
            For i = LBound(arr) To UBound(arr)
                .Rows(i + 1).RowHeight = arr(i)
            Next
            .Rows(&quot;4:36&quot;).RowHeight = 16.5
            .Rows(37).RowHeight = 30
            .Range(&quot;B1:H1,B2:H2,C4:D4,E4:F4,B4:B5,G4:G5,H4:H5,B37:G37&quot;).Merge
            With .Range(&quot;B4:H37&quot;)
                .Borders.LineStyle = xlContinuous
                .BorderAround xlDouble
            End With
            With .Range(&quot;B1&quot;)
                .HorizontalAlignment = xlCenter
                .Value = Sheet1.Range(&quot;B1&quot;) &amp; &quot;人员考核记录表&quot;
                .Font.Name = &quot;黑体&quot;
                .Font.Size = 16
                .Font.Bold = True
            End With
            With .Range(&quot;B2&quot;)
                .HorizontalAlignment = xlCenter
                .Value = TextBox1.Text
                .Font.Bold = True
            End With
            With .Range(&quot;B3&quot;)
                .Value = &quot;姓名：&quot; &amp; arrName(i1)
                .HorizontalAlignment = xlLeft
                .Font.Size = 10
            End With
            With .Range(&quot;B4：H37&quot;)
                .HorizontalAlignment = xlCenter
                .Font.Size = 10
            End With
            .Range(&quot;B4&quot;).Value = &quot;日&quot; &amp; Chr(10) &amp; &quot;期&quot;
            .Range(&quot;C4&quot;).Value = &quot;上午&quot;
            .Range(&quot;E4&quot;).Value = &quot;下午&quot;
            .Range(&quot;G4&quot;).Value = &quot;工作内容（加班情况或外出记录）&quot;
            .Range(&quot;H4&quot;).Value = &quot;备注&quot;
            .Range(&quot;C5,E5&quot;).Value = &quot;到&quot;
            .Range(&quot;D5,F5&quot;).Value = &quot;缺&quot;
            .Range(&quot;B37&quot;).Value = &quot;本月考核得分总计&quot;
            With .Range(&quot;B38&quot;)
                .Value = &quot;部门负责人：&quot; &amp; Sheet1.Cells(c, 2)
                .HorizontalAlignment = xlLeft
                .Font.Size = 10
            End With
            With .Range(&quot;H38&quot;)
                .Value = &quot;考勤员：&quot; &amp; Sheet1.Cells(c, 3)
                .Font.Size = 10
                .HorizontalAlignment = xlRight
            End With
            Select Case Val(Sheet1.Cells(2, 2))
                 Case 26 To 28
                    If Month(TextBox1.Text &amp; &quot;1日&quot;) &lt;&gt; 1 Then
                        .Cells(6, 2) = Year(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Month(DateAdd(&quot;m&quot;, -1, TextBox1.Text &amp; &quot;1日&quot;)) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
                    Else
                        .Cells(6, 2) = (Year(TextBox1.Text &amp; &quot;1日&quot;) - 1) &amp; &quot;-&quot; &amp; Month(DateAdd(&quot;m&quot;, -1, TextBox1.Text &amp; &quot;1日&quot;)) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
                    End If
                Case 1 To 5
                    .Cells(6, 2) = Year(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Month(TextBox1.Text &amp; &quot;1日&quot;) &amp; &quot;-&quot; &amp; Val(Sheet1.Cells(2, 2))
            End Select
            For i = 1 To 30
                Cells(i + 6, 2) = .Cells(6, 2) + i
                If .Cells(i + 6, 2).Value = DateAdd(&quot;m&quot;, 1, .Cells(6, 2)) - 1 Then Exit For
            Next
            .Range(&quot;B6:B36&quot;).NumberFormatLocal = &quot;d&quot;
            For i = 6 To 36
                If .Cells(i, 2) &lt;&gt; &quot;&quot; Then
                    Select Case DatePart(&quot;w&quot;, .Cells(i, 2))
                        Case 7, 1
                            .Cells(i, 7) = &quot;休  息&quot;
                        Case 2, 3, 4, 5, 6
                            .Cells(i, 3) = &quot;√&quot;
                            .Cells(i, 5) = &quot;√&quot;
                            .Cells(i, 7) = &quot;上  班&quot;
                            d = d + 1
                    End Select
                    Select Case Mid(Cells(i, 2), 6, Len(Cells(i, 2)) - 5)
                        Case &quot;01-01&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;元  旦&quot;
                            d = d - 1
                        Case &quot;05-01&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;五一节&quot;
                            d = d - 1
                        Case &quot;10-01&quot;, &quot;10-02&quot;, &quot;10-03&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;国庆节&quot;
                            d = d - 1
                    End Select
                    Select Case Mid(NongLi(Cells(i, 2)), 9, 5)
                        Case &quot;正月初一&quot;, &quot;正月初二&quot;, &quot;正月初三&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;春  节&quot;
                            d = d - 1
                        Case &quot;四月初四&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;清明节&quot;
                            d = d - 1
                        Case &quot;五月初五&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;端午节&quot;
                            d = d - 1
                        Case &quot;八月十五&quot;
                            .Cells(i, 3) = &quot;&quot;
                            .Cells(i, 5) = &quot;&quot;
                            .Cells(i, 7) = &quot;中秋节&quot;
                            d = d - 1
                    End Select
                End If
            Next
            .Range(&quot;E3&quot;) = d
            d = 0
            .Range(&quot;H3&quot;).FormulaR1C1 = &quot;=(COUNTA(R[3]C[-5]:R[33]C[-5],R[3]C[-3]:R[33]C[-3],&quot;&quot;√&quot;&quot;&quot;&quot;&quot;&quot;)-1)/2&quot;
            .Range(&quot;H37&quot;).FormulaR1C1 = &quot;=ROUND(IF(R[-34]C/R[-34]C[-3]*100&gt;100,100,R[-34]C/R[-34]C[-3]*100),0)&quot;
            .Range(&quot;E3,H3&quot;).Font.ColorIndex = 2
            .Range(&quot;C6:G36&quot;).Locked = False
            .Rows(&quot;6&quot;).Select
            .PageSetup.CenterHorizontally = True
            .DisplayAutomaticPageBreaks = False
            With ActiveWindow
                .DisplayGridlines = False
                .DisplayHeadings = False
                .DisplayOutline = False
                .FreezePanes = True
                .DisplayGridlines = False
            End With
            .ScrollArea = &quot;B1:O42&quot;
            .Range(&quot;G6&quot;).Select
            .Protect
            .EnableSelection = xlUnlockedCells
        End With
    Next
    Sheets(&quot;考勤统计&quot;).Select
    Unload Me
    Application.ScreenUpdating = True
End Sub
代码解析：
部门考勤窗体中“确定”按钮的单击事件，将所考勤部门的人员姓名写入到“考勤统计”表的姓名列中并在工作簿中该部门所有人员的个人考核表。
第15行到第19行代码，删除工作簿中原有的个人考核表。
第20行到第28行代码，判断所要考勤的部门是否已添加了部门人员。
第32行到第34行代码，删除“考勤统计”表中原有的统计数据，因为“考勤统计”表中B1：O30的表格是打印表格用的，统计数据是保存在B50以下单元格中，所以考勤前需要删除。
第35行代码，将单位名称写入到“考勤统计”表的B1单元格。
第36行代码，将考勤部门写入到“考勤统计”表的C2单元格。
第4行代码，将考勤月份写入到“考勤统计”表的O2单元格。
第41行代码，将部门负责人写入到“考勤统计”表的C30单元格。
第42行代码，将考勤员写入到“考勤统计”表的O30单元格。
第43行到第45行代码，将“资料”表中所保存的该部门人员姓名写入“考勤统计”表的B50及B50往下单元格中。
第49、50行代码，在“考勤统计”表的I50、M50及以下单元格中写入合计公式并将单元格属性设置为锁定。
第51行代码，将“考勤统计”表的B50至O列的最后一行单元格添加边框线。
第52行到第54行代码，取消“考勤统计”表中需要编辑单元格的锁定属性。
第55行到第57行代码，将“考勤统计”表的可选择区域设置为B50至O列的最后一行单元格并使用Goto方法选择B50单元格。
第58、59行代码，保护“考勤统计”表，使之只能选择未锁定的单元格。
写入考勤数据的“考勤统计”表如图 198 10所示。

图 198 10    “考勤统计”表
第61行到第69代码，将该部门保存在“资料”表中的人员姓名赋给数组arrName。
第70、71行代码，根据数组arrName保存的人员姓名依次在工作簿中添加个人考核表。
第73行代码，将添加的工作表以人员姓名重新命名。
第74行到第83行代码，设置个人考核表的行高、列宽。
第84行代码，合并个人考核表中的单元格。
第85行到第88行代码，设置个人考核表的边框线。
第59行到第127行代码，在个人考核表写入表格内容并设置格式。
第128行到第142行代码，在个人考核表的日期栏中根据考勤月份及考勤周期写入考勤日期并设置自定义格式。
第145行到第153行代码，使用DatePart函数判断考勤日期的星期并在个人考核表的“到”栏和“工作内容”栏中写入系统默认的内容，其中第152行代码，将应出勤天数赋给变量d。
第154行到第170行代码，判断考勤日期是否是“元旦”、“五一节”及“国庆节”，如果是则去除个人考核表的“到”栏中的应出勤标志，在“工作内容”栏中写入节假日名称并将应出勤天数减去放假天数。
第171行到第192行代码，判断考勤日期是否是“春节”、“清明节”、“端午节”及“中秋节”，如果是则去除个人考核表的“到”栏中的应出勤标志，在“工作内容”栏中写入节假日名称并将应出勤天数减去放假天数。</code></pre>
<p>判断考勤日期的农历日期需使用自定义函数，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Public Function NongLi(Optional XX_DATE As Date)
    Dim MonthAdd(11), NongliData(99), TianGan(9), DiZhi(11), ShuXiang(11), DayName(30), MonName(12)
    Dim curTime, curYear, curMonth, curDay
    Dim GongliStr, NongliStr, NongliDayStr
    Dim i, m, n, k, isEnd, bit, TheDate
    代码略，详见附件
    NongliStr = &quot;农历&quot; &amp; TianGan(((curYear - 4) Mod 60) Mod 10) &amp; DiZhi(((curYear - 4) Mod 60) Mod 12) &amp; &quot;年&quot;
    NongliStr = NongliStr &amp; &quot;(&quot; &amp; ShuXiang(((curYear - 4) Mod 60) Mod 12) &amp; &quot;)&quot;
    If (curMonth &lt; 1) Then
        NongliDayStr = &quot;闰&quot; &amp; MonName(-1 * curMonth)
    Else
        NongliDayStr = MonName(curMonth)
    End If
    NongliDayStr = NongliDayStr &amp; &quot;月&quot;
    NongliDayStr = NongliDayStr &amp; DayName(curDay)
    NongLi = NongliStr &amp; NongliDayStr
End Function
自定义NongLi函数根据日期生成农历天干、地支、属相等，来自网络，未做任何修改。其中第171行代码使用Mid函数取得农历日期。
第195行代码，将统计出的应出勤天数写入到个人考核表的E3单元格。
第197行代码，在个人考核表的H3单元格中写入统计实际出勤天数的公式。
第198行代码，在个人考核表的H36单元格中写入计算考核得分的公式。
第199行到第216行代码，设置个人考核表的页面格式及工作表保护。
添加好的个人考核表如图 198 11所示。

图 198 11    个人考核表</code></pre>
<p>在实际应用时，系统统计出的出勤数据与实际出勤数据可能有出入，为了方便修改数据，在VBE中双击ThisWorkbook写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_SheetSelectionChange(ByVal Sh As Object, ByVal Target As Range)
    If Sh.Index &gt; 3 And Target.Count = 1 Then
        If Sh.Range(&quot;B&quot; &amp; Target.Row) &lt;&gt; &quot;&quot; Then
            If Not Application.Intersect(Target, Union(Sh.Range(&quot;C6:C36&quot;), Sh.Range(&quot;E6:E36&quot;))) Is Nothing Then
                Target = &quot;√&quot;
                Target.Offset(, 1) = &quot;&quot;
            End If
            If Not Application.Intersect(Target, Union(Sh.Range(&quot;D6:D36&quot;), Sh.Range(&quot;F6:F36&quot;))) Is Nothing Then
                Target = &quot;△&quot;
                Target.Offset(, -1) = &quot;&quot;
            End If
        End If
    End If
End Sub
代码解析：
工作簿的SheetSelectionChange事件，选择个人考核表中的“到”或“缺”栏中的单元格时，自动在单元格中写入出缺勤标志。

​```vb
Private Sub Workbook_SheetChange(ByVal Sh As Object, ByVal Target As Range)
    Dim rng As Range
    If Sh.Index &gt; 3 And Target.Count = 1 Then
        If Sh.Range(&quot;B&quot; &amp; Target.Row) &lt;&gt; &quot;&quot; Then
            If Not Application.Intersect(Target, Sh.Range(&quot;C6:F36&quot;)) Is Nothing Then
                Select Case Target
                    Case &quot;√&quot;
                        Sh.Range(&quot;G&quot; &amp; Target.Row) = &quot;上  班&quot;
                    Case &quot;△&quot;
                        Sh.Range(&quot;G&quot; &amp; Target.Row) = &quot;缺  勤&quot;
                    End Select
            End If
        End If
    End If
End Sub
代码解析：
工作簿的SheetChange事件，根据个人考核表中的“到”或“缺”栏中写入出缺勤标志自动调整工作内容栏中的工作内容。</code></pre>
<p>步骤7，在实际应用中，因为隐藏了工作表标签，当需要选择个人考核表时，只能使用自定义的菜单，所以在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub check()
    On Error GoTo Line
    Sheets(4).Activate
    Exit Sub
Line:
    MsgBox &quot;本月还没有考勤,请先考勤!&quot;, 64, &quot;提示&quot;
End Sub
代码解析：
Check过程激活工作簿中的第四张工作表，也就是第一张个人考核表。如果还没有进行部门考勤，激活命令会发生错误，所以使用On Error语句执行第6行代码进行提示。</code></pre>
<p>在修改个人考核表过程中，需要在工作簿中进行上下翻页，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub NextPage()
    Select Case ActiveSheet.Index
        Case Is &lt; 4
            MsgBox &quot;请选择【个人考核】按纽!&quot;, 64, &quot;提示&quot;
        Case Is = Worksheets.Count
            MsgBox &quot;已经是最后一页!&quot;, 64, &quot;提示&quot;
        Case Else
            Sheets(ActiveSheet.Index + 1).Activate
    End Select
End Sub
代码解析：
NextPage过程通过活动工作表的Index属性判断活动工作表是否在个人考核表的范围内，如果在则激活活动工作表的下一张工作表，否则进行提示。</code></pre>
<pre><code class="vb">Sub Onpage()
    Select Case ActiveSheet.Index
        Case Is &lt; 4
            MsgBox &quot;请选择【个人考核】按纽!&quot;, 64, &quot;提示&quot;
        Case Is = 4
            MsgBox &quot;已经是第一页!&quot;, 64, &quot;提示&quot;
        Case Else
            Sheets(ActiveSheet.Index - 1).Activate
    End Select
End Sub
代码解析：
Onpage过程通过活动工作表的Index属性判断活动工作表是否在个人考核表的范围内，如果在则激活活动工作表的上一张工作表，否则进行提示。</code></pre>
<p>步骤8，当所有的个人考核表修改完成后，需要对个人考核数据进行汇总，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub Gather()
    Dim i As Integer
    If Worksheets.Count &lt; 4 Then
        MsgBox &quot;本月还没有考勤,请先进行部门考勤!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet3
        .Select
        If MsgBox(&quot;是否汇总&quot; &amp; .Range(&quot;C2&quot;) &amp; .Range(&quot;O2&quot;).Text &amp; &quot;份的考勤记录?&quot;, 36, &quot;提示&quot;) = 6 Then
            .Unprotect
            For i = 50 To .Range(&quot;B65536&quot;).End(xlUp).Row
                If .Cells(i, 2) &lt;&gt; &quot;&quot; Then
                .Cells(i, 3) = Sheets(i - 46).Range(&quot;E3&quot;)
                .Cells(i, 4) = Sheets(i - 46).Range(&quot;H3&quot;)
                .Cells(i, 14) = Sheets(i - 46).Range(&quot;H37&quot;)
                End If
            Next
        .Protect
        End If
    End With
End Sub
代码解析：
Gather过程将每个职工的个人考核表中的考核数据汇总到“考勤统计”表。
第3行到第6行代码，判断是否已进行了部门考勤，因为如果还没有进行部门考勤，工作簿中只有三张工作表。
第11行到第16行代码，将个人考核表中的应出勤天数、实际出勤天数及考核得分写入到“考勤统计”表第50行主以下的单元格中。因为“考勤统计”表中的姓名和个人考核表的工作表名称的顺序是一致的，所以只需按顺序写入即可。如果应出勤天数与实际情况有出入可以在“考勤统计”表的C列单元格中进行修改。</code></pre>
<p>步骤9，当汇总好考核数据后，需要打印“考勤统计”表和所有的个人考核表，在VBE窗口中单击菜单“插入”→“模块”，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Sub stamp()
    Dim i As Integer
    Dim r As Integer
    Dim a As Integer
    Dim p As Integer
    Dim c As Integer
    If Worksheets.Count &lt; 4 Then
        MsgBox &quot;本月还没有考勤,请先进行部门考勤!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    With Sheet3
        .Select
        If .Range(&quot;C50&quot;) = &quot;&quot; Then
            MsgBox &quot;请先汇总考核数据!&quot;, 64, &quot;提示&quot;
            Exit Sub
        End If
        Application.ScreenUpdating = False
        If MsgBox(&quot;是否打印&quot; &amp; .Range(&quot;C2&quot;) &amp; .Range(&quot;O2&quot;).Text &amp; &quot;份的考勤记录?&quot;, 36, &quot;提示&quot;) = 7 Then
            Exit Sub
        End If
        .Unprotect
        r = .Range(&quot;B63536&quot;).End(xlUp).Row
        a = Abs(Int(-(r - 49) / 25))
        For p = 1 To a
            For i = 5 To 29
                For c = 2 To 15
                    .Cells(i, c) = .Cells(i + 45 + (p - 1) * 25, c)
                Next
            Next
            .PrintOut
        Next
        For i = 4 To Worksheets.Count
            Sheets(i).PrintOut
        Next
        .Protect
        .EnableSelection = 1
        Application.ScreenUpdating = True
    End With
End Sub
代码解析：
stamp过程打印“考勤统计”表和所有的个人考核表。
第7行到第10行代码，判断是否已进行了部门考勤，因为如果还没有进行部门考勤，工作簿中只有三张工作表。
第13行到第16行代码，判断是否已将考核数据进行汇总。
第22、23行代码，计算“考勤统计”表需打印的张数，因为预设的表格只有25行，如果部门人数超过25人需要进行分次打印。
第24行到第31行代码，将考核数据每次25行写入到打印表格中进行打印。
第32行到第34行代码，打印所有人员的个人考核表。</code></pre>
<p>步骤10，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个Image控件、一个框架控件及一个按钮控件，在框架控件中添加一个Image控件和一个标签控件，将Image控件的Picture属性设置为合适的图片，如图 198 12所示。</p>
<p>图 198 12 关于窗体<br>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Note As String
    Note = &quot;名称： 职工考勤系统&quot; &amp; vbLf _
        &amp; &quot;版本： V2.0&quot; &amp; vbLf _
        &amp; &quot;作者： yuanzhuping&quot; &amp; vbLf _
        &amp; &quot;E-mail： yuanzhuping@yeah.net &quot;
    Label1.Caption = Note
End Sub
代码解析：
“关于”窗体的初始化事件，使用标签控件显示系统信息。
步骤11，在VBE窗口中单击菜单“插入”→“插入窗体”，在窗体中添加一个框架控件及一个按钮控件，在框架控件中添加一个标签控件，如图 198 13所示。

图 198 13    帮助窗体</code></pre>
<p>双击窗体，在打开的代码窗口写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Note As String
    With Label1
        .Caption = Note
        .Height = 296
        .Top = 6
        .Left = 6
        Frame1.ScrollBars = fmScrollBarsVertical
        Frame1.ScrollHeight = .Height
    End With
End Sub
代码解析：
“帮助”窗体的初始化事件，使用标签控件显示帮助信息。请参阅技巧122 。</code></pre>
<p>步骤12，在实际应用中，需要在菜单栏上添加自定义菜单来使用各项功能，在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码：</p>
<pre><code class="vb">Sub AddNowBar()
    Dim NewBar As CommandBar
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = False
        .CommandBars(&quot;Formatting&quot;).Visible = False
        .CommandBars(&quot;Stop Recording&quot;).Visible = False
        .CommandBars(&quot;toolbar list&quot;).Enabled = False
        .CommandBars.DisableAskAQuestionDropdown = True
        .DisplayFormulaBar = False
        .DisplayStatusBar = False
        .CommandBars(&quot;NewBar&quot;).Delete
    End With
    Set NewBar = Application.CommandBars.Add(Name:=&quot;NewBar&quot;, Position:=msoBarTop, MenuBar:=True, Temporary:=True)
   # 。。。。。。。。。代码略，详见附件
    End With
    Set NewBar = Nothing
    Application.StatusBar = &quot;&quot;
End Sub
Sub DelNowBar()
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = True
        .CommandBars(&quot;Formatting&quot;).Visible = True
        .CommandBars(&quot;Stop Recording&quot;).Visible = True
        .CommandBars(&quot;toolbar list&quot;).Enabled = True
        .CommandBars.DisableAskAQuestionDropdown = False
        .DisplayFormulaBar = True
        .DisplayStatusBar = True
        .CommandBars(&quot;NewBar&quot;).Delete
        Application.StatusBar = False
    End With
End Sub
代码解析：
第1行到第19行代码，AddNowBar过程，去除工作簿中的菜单栏、工具栏、编辑栏及状态栏等，添加自定义的菜单栏。
第20行到第33行代码，DelNowBar过程，恢复系统原来的设置。
关于自定义菜单请参阅技巧83 。
自定义菜单如图 198 14所示。

图 198 14    自定义菜单</code></pre>
<p>为了使用自定义菜单，除了以上已经解析过的过程以外，还需在VBE窗口中单击菜单“插入”→“模块”，在模块中写入下面的代码：</p>
<pre><code class="vb">Sub SetUnits()
    If Sheet1.Cells(1, 2) &lt;&gt; &quot;&quot; Then
        If MsgBox(&quot;是否重新设置使用单位？&quot;, 36, &quot;提示&quot;) = 7 Then
            Exit Sub
        End If
    End If
    单位设置.Show
End Sub
Sub Setbranch()
    If Sheet1.Cells(1, 2) = &quot;&quot; Then
        MsgBox &quot;请先设置使用单位!&quot;, 36, &quot;提示&quot;
        Exit Sub
    End If
    部门设置.Show
End Sub
Sub Setcrew()
    If Sheet1.Cells(4, 1) = &quot;&quot; Then
        MsgBox &quot;请先设置使用部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    人员设置.Show
End Sub
Sub Attendance()
    If Sheet1.Cells(4, 1) = &quot;&quot; Then
        MsgBox &quot;请先设置使用部门!&quot;, 64, &quot;提示&quot;
        Exit Sub
    End If
    部门考勤.Show
End Sub
Sub backtrack()
    Sheet2.Select
End Sub
Sub ThemeHelp()
    关于.Show
End Sub
Sub OnHelp()
    帮助.Show
End Sub
Sub myQuit()
    If Workbooks.Count &gt; 1 Then
        ThisWorkbook.Close
    Else
        Application.Quit
    End If
End Sub
代码解析：
第1行到第8行代码，“系统设置”菜单中的“单位设置”菜单指定的过程，显示“单位设置”窗体。
第9行到第15行代码，“系统设置”菜单中的“部门设置”菜单指定的过程，显示“部门设置”窗体。
第16行到第22行代码，“系统设置”菜单中的“人员设置”菜单指定的过程，显示“人员设置”窗体。
第23行到第29行代码，“部门考勤”菜单指定的过程，显示“部门考勤”窗体。其中第24行到第27行代码判断是否已设置了使用部门。
第30行到第32行代码，“返回”菜单指定的过程，选择主界面表。
第33行到第35行代码，“帮助”菜单中的“关于”菜单指定的过程，显示“关于”窗体。
第36行到第38行代码，“帮助”菜单中的“帮助”菜单指定的过程，显示“帮助”窗体。
第39行到第45行代码，“退出系统”菜单指定的过程，根据当前打开的工作簿数量采用Close方法关闭工作簿或Quit方法关闭应用程序。
步骤13，为了在使用过程中有一个友好的用户界面，将Sheet2表重命名为“欢迎”，在工作表中插入合适的图片，在图片上添加标签控件并把宏指定给标签控件。</code></pre>
<p>步骤14，在VBE窗口中双击“ThisWorkbook”，在打开的代码窗口中写入下面的代码：</p>
<pre><code class="vb">Private Sub Workbook_Open()
    With Sheet2
        .ScrollArea = &quot;A1&quot;
        .Select
    End With
End Sub
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim s As Integer
    Application.ScreenUpdating = False
    Application.DisplayAlerts = False
    For s = Worksheets.Count To 4 Step -1
        Worksheets(s).Delete
    Next
    Application.DisplayAlerts = True
    Application.ScreenUpdating = True
    ThisWorkbook.Save
End Sub
Private Sub Workbook_Activate()
    Application.Caption = IIf(Sheet1.Cells(1, 2) &lt;&gt; &quot;&quot;, Sheet1.Cells(1, 2), &quot;&quot;)
    Call AddNowBar
End Sub
Private Sub Workbook_Deactivate()
    Application.Caption = &quot;&quot;
    Call DelNowBar
End Sub
代码解析：
第1行到第6行代码，工作簿的Open事件，打开考勤系统时选择欢迎界面。
第7行到第17行代码，工作簿的BeforeClose事件，关闭考勤系统时删除所有的个人考核表。
第18行到第21行代码，工作簿的Activate事件，考勤系统激活时创建自定义菜单。
第22行到第25行代码，工作簿的Deactivate事件，考勤系统非激活时删除自定义菜单。
步骤15，最后在VBE中将“资料”表的Visible属性设置为xlSheetVeryHidden使之隐藏；单击菜单“工具”→“数字签名”，为VBA工程签署数字证书。
保存、关闭工作簿，重新打开工作簿，职工考勤系统如图 198 15所示。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/06/03/VBA常用技巧11--其他应用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧10--文件操作" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/02/VBA常用技巧10--文件操作/">VBA常用技巧10--文件操作</a>
    </h1>
  

        
        <a href="/2018/06/02/VBA常用技巧10--文件操作/" class="archive-article-date">
  	<time datetime="2018-06-01T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-06-02</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第10章-文件操作"><a href="#第10章-文件操作" class="headerlink" title="第10章     文件操作"></a>第10章     文件操作</h2><h3 id="技巧170-导入文本文件"><a href="#技巧170-导入文本文件" class="headerlink" title="技巧170     导入文本文件"></a>技巧170     导入文本文件</h3><p>在实际应用中，我们经常从软件中将数据导出为文本文件，在需要将这些文本文件导入到Excel中时可以使用以下的方法。</p>
<h4 id="170-1-使用查询表导入"><a href="#170-1-使用查询表导入" class="headerlink" title="170-1    使用查询表导入"></a>170-1    使用查询表导入</h4><p>在Excel VBA中可以使用Add方法新建查询表后导入文本文件，如下面的代码所示。</p>
<pre><code class="vb">Sub AddQuery()
    Sheet1.UsedRange.ClearContents
    With Sheet1.QueryTables.Add( _
        Connection:=&quot;TEXT;&quot; &amp; ThisWorkbook.Path &amp; &quot;\工资表.txt&quot;, _
        Destination:=Range(&quot;A1&quot;))
        .TextFilePlatform = 936
        .TextFileCommaDelimiter = True
        .Refresh
    End With
End Sub
代码解析：
AddQuery过程使用QueryTable对象的Add方法新建查询表后将文本文件“工资表.txt”的内容导入到工作表中。
应用于QueryTable对象的Add方法新建一个查询表，返回QueryTable对象，该对象代表新建的查询表，语法如下：
expression.Add(Connection, Destination, Sql)
参数expression是必需的，返回一个QueryTables对象。
参数Connection是必需的，查询表的数据源。如果数据源是文本文件，是“TEXT;&lt;文本文件路径和名称&gt;”形式的字符串，其他数据源请参阅帮助。
参数Destination是必需的，Range类型，查询表目标区域左上角单元格用于放置生成的查询表的区域。目标区域必须在包含expression 指定的QueryTables对象的工作表上。
参数Sql是可选的，在ODBC数据源上运行的SQL查询字符串，当将QueryTable对象、文本文件、或是ADO或DAO Recordset对象指定为数据源时不能使用该参数。
第3行到第5行代码在工作表中建立对位于同一目录中的“工资表.txt”文本文件的查询，并将查询结果放置到工作表中。
第6行代码设置导入的文本文件的原始格式，QueryTables对象的TextFilePlatform属性返回或设置正向查询表中导入的文本文件的原始格式，默认值是在“文本导入向导”的“文件原始格式”选项中的当前设置。
第7行代码设置文本文件导入查询表中时，是以逗号作为分隔符。
第8行代码使用Refresh方法更新外部数据区域，应用于QueryTable对象的Refresh方法更新外部数据区域，语法如下：
expression.Refresh(BackgroundQuery)
参数expression是必需的，返回一个QueryTable对象。
参数BackgroundQuery是可选的的，只用于基于SQL查询结果的QueryTable。</code></pre>
<h4 id="170-2-使用Open-语句导入"><a href="#170-2-使用Open-语句导入" class="headerlink" title="170-2    使用Open 语句导入"></a>170-2    使用Open 语句导入</h4><p>使用Open语句输入文本文件，如下面的代码所示。</p>
<pre><code class="vb">Sub OpenText()
    Dim Filename As String
    Dim myText As String
    Dim mArr() As String
    Dim i As Integer
    Dim j As Integer
    Filename = ThisWorkbook.Path &amp; &quot;\工资表.txt&quot;
    j = 1
    Sheet1.UsedRange.ClearContents
    Open Filename For Input As #1
    Do While Not EOF(1)
        Line Input #1, myText
        mArr = Split(myText, &quot;,&quot;)
        For i = 0 To UBound(mArr)
            Sheet1.Cells(j, i + 1) = mArr(i)
        Next
        j = j + 1
    Loop
    Close #1
End Sub
代码解析：
OpenText过程使用Open语句将文本“工资表.txt”的内容输入到工作表中。
第10行代码使用Open语句打开文本文件以完成对文本文件的输入。Open语句能够对文件输入/输出（I/O），语法如下：。
Open pathname For mode [Access access] [lock] As [#]filenumber [Len=reclength]
Pathname是必需的，指定文件名，该文件名可能还包括目录、文件夹及驱动器。
mode是必需的，指定文件方式，有Append、Binary、Input、Output、或Random方式。如果未指定方式，则以Random访问方式打开文件。
Access是可选的，说明打开的文件可以进行的操作，有Read、Write、或Read Write操作。
lock是可选的，说明限定于其它进程打开的文件的操作，有Shared、Lock Read、Lock Write、和Lock Read Write操作。
filenumber是必需的，一个有效的文件号，范围在 1 到 511 之间。使用FreeFile函数可得到下一个可用的文件号。
reclength是可选的，小于或等于 32，767（字节）的一个数。对于用随机访问方式打开的文件，该值就是记录长度。对于顺序文件，该值就是缓冲字符数。
第11行代码使用Do...Loop 语句重复执行第12行到第17行代码，直到文本文件的结尾。EOF函数返回一个Integer，它返回Boolean值True，表明已经到达为Random或顺序Input打开的文件结尾，语法如下：
EOF(filenumber)
参数filenumber是必需的，是一个Integer，包含任何有效的文件号。
第12行代码使用Line Input # 语句读入一行数据并将其赋予变量myText。Line Input # 语句从已打开的顺序文件中读出一行并将它分配给String变量，语法如下：
Line Input #filenumber, varname
Filenumber是必需的，任何有效的文件号。
varnamer是必需的，有效的Variant或String变量名。
第13行代码使用Split函数按逗号作为分隔符分开这行字符，赋值数组mArr。关于Split函数请参阅技巧169-2。
第14行到第16行代码将数组mArr循环赋值给单元格，请参阅技巧169-1。
第19行代码关闭文本文件。Close语句关闭Open语句所打开的输入/输出 (I/O) 文件，语法如下：
Close [filenumberlist]
参数filenumberlist是可选的，为一个或多个文件号，如省略则将关闭所有由Open语句打开的活动文件。</code></pre>
<h4 id="170-3-使用OpenText方法"><a href="#170-3-使用OpenText方法" class="headerlink" title="170-3    使用OpenText方法"></a>170-3    使用OpenText方法</h4><p>使用OpenText方法载入一个文本文件并将其作为包含单个工作表的工作簿处理，如下面的代码所示。</p>
<pre><code class="vb">Sub OpenText()
    Dim myFileName As String
    myFileName = &quot;工资表.txt&quot;
    Sheet1.UsedRange.ClearContents
    Workbooks.OpenText _
        Filename:=ThisWorkbook.Path &amp; &quot;\&quot; &amp; myFileName, _
        StartRow:=1, DataType:=xlDelimited, Comma:=True
    With ActiveWorkbook
        With .Sheets(&quot;工资表&quot;).Range(&quot;A1&quot;).CurrentRegion
            ThisWorkbook.Sheets(&quot;Sheet1&quot;).Range(&quot;A1&quot;).Resize(.Rows.Count, .Columns.Count).Value = .Value
        End With
        .Close False
    End With
End Sub
代码解析：
OpenText过程使用OpenText方法载入“工资表.txt”文本文件并将其数据写入到工作表中。
第5行到第7行代码使用OpenText方法载入“工资表.txt”文本文件。OpenText方法载入一个文本文件，并将其作为包含单个工作表的工作簿进行分列处理，然后在此工作表中放入经过分列处理的文本文件数据，语法如下：
expression.OpenText(FileName, Origin, StartRow, DataType, TextQualifier, ConsecutiveDelimiter, Tab, Semicolon, Comma, Space, Other, OtherChar, FieldInfo, TextVisualLayout, DecimalSeparator, ThousandsSeparator, TrailingMinusNumbers, Local)
其中参数FileName是必需的，指定要载入并作分列处理的文件名称。
参数StartRow是可选的，作分列处理的起始行号，默认值为 1。
参数DataType是可选的，在文件中指定数据的列格式。
参数Comma是可选的，如果该值为True，则将分隔符设为逗号。
其他参数请参阅VBA中的帮助文档。
第9行到第11行代码将作为工作表打开的文本文件中的数据写入到工作表中。
第13行代码使用Close方法关闭打开的文本文件。
技巧171     将数据写入文本文件
在需要时可以将Excel中的数据写入到文本文件中，有以下方法可以实现。</code></pre>
<h4 id="171-1-使用Print-语句"><a href="#171-1-使用Print-语句" class="headerlink" title="171-1    使用Print # 语句"></a>171-1    使用Print # 语句</h4><p>使用Print # 语句将数据写入文本文件中，如下面的代码所示。</p>
<pre><code class="vb">Sub PrintText()
    Dim myFileName As String
    Dim myDataAr() As Variant
    Dim myStr As String
    Dim myRow As Integer
    Dim myCol As Integer
    Dim i As Integer
    Dim j As Integer
    On Error Resume Next
    myFileName = &quot;工资表.txt&quot;
    Kill ThisWorkbook.Path &amp; &quot;\&quot; &amp; myFileName
    With Sheet1
        myRow = .Range(&quot;A65536&quot;).End(xlUp).Row
        myCol = .Range(&quot;IV1&quot;).End(xlToLeft).Column
        ReDim myDataAr(1 To myRow, 1 To myCol)
        For i = 1 To myRow
            For j = 1 To myCol
                myDataAr(i, j) = .Cells(i, j).Value
            Next
        Next
        Open ThisWorkbook.Path &amp; &quot;\&quot; &amp; myFileName For Output As #1
        For i = 1 To UBound(myDataAr, 1)
            myStr = &quot;&quot;
            For j = 1 To UBound(myDataAr, 2)
                myStr = myStr &amp; CStr(myDataAr(i, j)) &amp; &quot;,&quot;
            Next
            myStr = Left(myStr, (Len(myStr) - 1))
            Print #1, myStr
        Next
        Close #1
    End With
    MsgBox &quot;文件保存成功!&quot;
End Sub
代码解析：
PrintText过程将工作表中数据写入到文本文件“工资表.txt”中。
第11行代码使用Kill方法删除同一目录中可能存在的同名文本文件。
第13、14行使用单元格的End属性取得工作表中已使用数据的行、列号，关于End属性请参阅技巧3 。
第15行代码重新定义动态数组myDataAr的大小。关于动态数组请参阅技巧169-3。
第16行到第20行代码将工作表数据赋给数组myDataAr。
第21行代码使用Open语句打开文本文件以完成对文本文件的输入。关于Open语句请参阅技巧170-2。
第22行到第29行代码使用Print #语句将数组myDataAr中的所有元素写入到文本文件中。Print #语句将格式化显示的数据写入顺序文件中，语法如下：
Print #filenumber, [outputlist]
Filenumber是必需的，任何有效的文件号。
第30行代码Close语句关闭文本文件。</code></pre>
<h4 id="171-2-另存为文本文件"><a href="#171-2-另存为文本文件" class="headerlink" title="171-2    另存为文本文件"></a>171-2    另存为文本文件</h4><p>使用SaveAs方法将工作表另存为文本文件，如下面的代码所示。</p>
<pre><code class="vb">Sub SaveText()
    Dim myFileName As String
    myFileName = &quot;工资表.txt&quot;
    On Error Resume Next
    Kill ThisWorkbook.Path &amp; &quot;\&quot; &amp; myFileName
    Application.ScreenUpdating = False
    Worksheets(&quot;Sheet1&quot;).Copy
    ActiveWorkbook.SaveAs Filename:=ThisWorkbook.Path _
        &amp; &quot;\&quot; &amp; myFileName, _
        FileFormat:=xlCSV
    MsgBox &quot;文件保存成功!&quot;
    ActiveWorkbook.Close SaveChanges:=False
    Application.ScreenUpdating = True
End Sub
代码解析：
SaveText过程将工作表“Sheet1”保存为文本文件。
第4、5行代码使用Kill方法删除同一目录中可能存在的同名文本文件。
第7行代码使用Copy方法复制工作表“Sheet1”。
第8行到第10行代码使用SaveAs方法将文件保存为文本文件。应用于Workbook对象的SaveAs方法保存对不同文件中的工作表的更改，语法如下：
expression.SaveAs(FileName, FileFormat, Password, WriteResPassword, ReadOnlyRecommended, CreateBackup, AccessMode, ConflictResolution, AddToMru, TextCodepage, TextVisualLayout, Local)
其中参数Filename表示要保存的文件名。可包含完整路径。如果不指定路径，Microsoft Excel 将文件保存到当前文件夹中。
其中参数FileFormat指定保存文件时使用的文件格式，在本例中指定为xlCSV即保存为文本文件。
第12行代码使用Close方法关闭活动工作簿。</code></pre>
<h3 id="技巧172-文件修改的日期和时间"><a href="#技巧172-文件修改的日期和时间" class="headerlink" title="技巧172     文件修改的日期和时间"></a>技巧172     文件修改的日期和时间</h3><p>在VBA过程中如果需要获得文件最后修改的日期和时间，可以使用FileDateTime函数，如下面的代码所示。</p>
<pre><code class="vb">Sub myDateTime()
    Dim Stmp As String
    Dim myDateTime As Date
    Stmp = ThisWorkbook.Path &amp; &quot;\&quot; &amp; ThisWorkbook.Name
    myDateTime = FileDateTime(Stmp)
    MsgBox Stmp &amp; &quot;最后修改时间是：&quot; &amp; Chr(13) &amp; myDateTime
End Sub
代码解析：
myDateTime过程使用消息框显示文件最后修改的日期和时间。
FileDateTime函数返回一个文件被创建或最后修改后的日期和时间，语法如下：
FileDateTime(pathname)
pathname 参数是必需的，用来指定文件名的字符串表达式。pathname 可以包含目录或文件夹、以及驱动器。
第4行代码使用变量Stmp保存代码所在工作簿的路径和名称。
第5行代码使用变量myDateTime保存FileDateTime函数返回的日期和时间。
运行myDateTime过程结果如图 172 1所示。

图 172 1    文件最后修改的日期和时间</code></pre>
<h3 id="技巧173-查找文件或文件夹"><a href="#技巧173-查找文件或文件夹" class="headerlink" title="技巧173     查找文件或文件夹"></a>技巧173     查找文件或文件夹</h3><p>在磁盘中查找文件或文件夹，可以使用Dir函数，如下面的代码所示。</p>
<pre><code class="vb">Sub mydir()
    Dim mydir As String
    Dim b As Byte
    b = 1
    Range(&quot;A:A&quot;).ClearContents
    mydir = Dir(ThisWorkbook.Path &amp; &quot;\*.xls&quot;, vbNormal)
    Do While mydir &lt;&gt; &quot;&quot;
        Cells(b, 1) = mydir
        mydir = Dir
        b = b + 1
    Loop
End Sub
代码解析：
Mydir过程使用Dir函数在代码所在工作簿的文件夹中查找所有的Excel文件，找到后写入到工作表的A列单元格中。
第2行代码声明变量mydir保存返回的文件名称。
第3行代码声明变量b保存返回的文件数目。
第4行代码设置变量b的初始值。
第5行代码清除A列所有数据。
第6行代码使用Dir函数在代码所在工作簿的文件夹中查找Excel文件。Dir函数返回一个String，用以表示一个文件名、目录名或文件夹名称，语法如下：
Dir[(pathname[, attributes])]
参数pathname是可选的，用来指定文件名的字符串表达式，可能包含目录或文件夹、以及驱动器。如果没有找到pathname，则会返回零长度字符串 (&quot;&quot;)。
参数attributes是可选的，常数或数值表达式，其总和用来指定文件属性，如表格 173 1所示。如果省略，则会返回不包含属性的匹配文件。
常数    值    描述
vbNormal    0    (缺省) 指定没有属性的文件。
vbReadOnly    1    指定无属性的只读文件。
vbHidden    2    指定无属性的隐藏文件。
VbSystem    4    指定无属性的系统文件，在Macintosh中不可用。
vbVolume    8    指定卷标文件；如果指定了其它属性，则忽略。vbVolume 在Macintosh中不可用。
vbDirectory    16    指定无属性文件及其路径和文件夹。
vbAlias    64    指定的文件名是别名，只在Macintosh上可用。
表格 173 1    attributes设置值
注意 在第一次调用Dir函数时，必须指定pathname，否则会产生错误。
第7行到第11行代码将返回的文件名称写入到A列单元格中。Dir函数会返回匹配 pathname参数的第一个文件名，若想得到其他匹配pathname参数的文件名，需再一次调用Dir函数，且不要使用参数。如果已没有合乎条件的文件，则Dir函数会返回一个零长度字符串 (&quot;&quot;)。
运行Mydir过程工作表中如图 173 1所示。</code></pre>
<h3 id="技巧174-获得当前文件夹的名称"><a href="#技巧174-获得当前文件夹的名称" class="headerlink" title="技巧174     获得当前文件夹的名称"></a>技巧174     获得当前文件夹的名称</h3><p>在处理文件时经常需要获得当前文件夹的名称，此时可以使用CurDir函数，如下面的代码所示。</p>
<pre><code class="vb">Sub CurFolder()
    MsgBox CurDir(&quot;F&quot;)
End Sub
CurFolder过程使用消息框显示F盘中的当前文件夹名称。
CurDir函数返回一个Variant类型的文件路径。如果需要返回字符串类型的文件路径则使用CurDir$，语法如下：
CurDir[(drive)]
参数drive是可选的，字符串表达式，指定一个存在的驱动器。如果没有指定驱动器，或参数drive 是零长度字符串 (&quot;&quot;)，则CurDir函数会返回当前驱动器的路径。
假设示例文件保存在F盘的“VBA常用技巧\示例文件\第10章 文件操作”文件夹中，运行CurFolder过程结果如图 174 1所示。

图 174 1    获得当前文件夹的名称</code></pre>
<h3 id="技巧175-创建和删除文件夹"><a href="#技巧175-创建和删除文件夹" class="headerlink" title="技巧175     创建和删除文件夹"></a>技巧175     创建和删除文件夹</h3><p>可以在程序运行时创建和删除文件夹，如下面的代码所示。</p>
<pre><code class="vb">Sub TempFolder()
    On Error Resume Next
    MkDir ThisWorkbook.Path &amp; &quot;\Temp&quot;
End Sub
代码解析：
TempFolder过程使用MkDir语句在示例所在的文件夹中创建“Temp”文件夹。MkDir语句创建一个新的目录或文件夹，语法如下：
MkDir path
参数path是必需的，指定所要创建的目录或文件夹的字符串表达式，可以包含驱动器。如果没有指定驱动器，则在当前驱动器上创建新的目录或文件夹。
第2行代码启动错误处理程序，因为在创建过程中如果文件夹中已存在相同名称的“Temp”文件夹会发生 “路径未找到”错误，所以使用On Error Resume Next语句忽略错误。
第3行代码使用MkDir语句创建“Temp”文件夹。</code></pre>
<p>如果需要删除不需要的文件夹可以使用RmDir语句，如下面的代码所示。</p>
<pre><code class="vb">Sub RmFolder()
    On Error Resume Next
    RmDir ThisWorkbook.Path &amp; &quot;\Temp&quot;
End Sub
代码解析：
RmFolder过程使用RmDir语句删除在示例所在的文件夹中创建“Temp”文件夹。RmDir语句删除一个存在的目录或文件夹，语法如下：
RmDir path
参数path是必需的，指定所要创建的目录或文件夹的字符串表达式，可以包含驱动器。如果没有指定驱动器，则在当前驱动器上创建新的目录或文件夹。
第2行代码启动错误处理程序，因为在使用RmDir语句删除并不存在的文件夹或删除含有文件的文件夹时会发生 “路径未找到”错误，所以使用On Error Resume Next语句忽略错误。
第3行代码使用RmDir语句删除“Temp”文件夹。如果“Temp”文件夹中含有文件可以在删除文件夹之前，先使用Kill语句来删除所有文件，请参阅技巧178 。</code></pre>
<h3 id="技巧176-重命名文件或文件夹"><a href="#技巧176-重命名文件或文件夹" class="headerlink" title="技巧176     重命名文件或文件夹"></a>技巧176     重命名文件或文件夹</h3><p>使用Name语句可以重命名文件或文件夹，如下面的代码所示。</p>
<pre><code class="vb">Sub Filename()
    On Error Resume Next
    Name ThisWorkbook.Path &amp; &quot;\123&quot; As ThisWorkbook.Path &amp; &quot;\ABC&quot;
    Name ThisWorkbook.Path &amp; &quot;\123.xls&quot; As ThisWorkbook.Path &amp; &quot;\ABC\ABC.xls&quot;
End Sub
Filename过程使用Name语句重命名示例文件所在文件夹中的“123”文件夹和“123.xls”Excel文件并将重命名后的Excel文件移动到重命名后的文件夹中。
Name语句重新命名一个文件、目录、或文件夹，语法如下：
Name oldpathname As newpathname
参数oldpathname是必需的，字符串表达式，指定已存在的文件名和位置，可以包含目录或文件夹、以及驱动器。
参数newpathname是必需的，字符串表达式，指定新的文件名和位置，可以包含目录或文件夹、以及驱动器。
第2行代码启动错误处理程序，因为在重命名过程中如果参数oldpathname指定的文件或文件夹不存在会发生 “文件未找到”错误，所以使用On Error Resume Next语句忽略错误。
第3行代码使用Name语句将示例文件所在文件夹中的“123”文件夹重命名为“ABC”文件夹。
第4行代码使用Name语句将示例文件所在文件夹中的“123.xls”Excel文件重命名为“ABC.xls”文件并移动到“ABC”文件夹中。
在运行Filename过程前请确认示例文件所在文件夹中包含一个“123”文件夹和一个“123.xls”Excel文件。</code></pre>
<h3 id="技巧177-复制指定的文件"><a href="#技巧177-复制指定的文件" class="headerlink" title="技巧177     复制指定的文件"></a>技巧177     复制指定的文件</h3><p>如果需要把文件从一个地方复制到另一个地方，可以使用FileCopy语句复制文件，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyFile()
    Dim SourceFile As String
    Dim DestinationFile As String
    SourceFile = ThisWorkbook.Path &amp; &quot;\123.xls&quot;
    DestinationFile = ThisWorkbook.Path &amp; &quot;\ABC\abc.xls&quot;
    FileCopy SourceFile, DestinationFile
End Sub
代码解析：
CopyFile过程使用FileCopy语句将示例文件所在文件夹中的“123.xls”Excel文件复制到示例文件目录下的“ABC”文件夹中并重新命名为“abc.xls”。
FileCopy语句复制一个文件，语法如下：
FileCopy source, destination
Source参数是必需的，字符串表达式，用来表示要被复制的文件名。source参数可以包含目录或文件夹、以及驱动器。
destination参数是必需的，字符串表达式，用来指定要复制的目地文件名。destination参数 可以包含目录或文件夹、以及驱动器。
注意 不能对一个已打开的文件使用 FileCopy 语句，否则会产生错误。
第4行代码指定被复制的文件名称和路径。
第5行代码指定目的文件名称和路径，如果已存在相同名称的文件则会覆盖原文件。
第6行代码使用FileCopy语句复制文件。</code></pre>
<h3 id="技巧178-删除指定的文件"><a href="#技巧178-删除指定的文件" class="headerlink" title="技巧178     删除指定的文件"></a>技巧178     删除指定的文件</h3><p>使用Kill方法删除指定的文件，如下面的代码所示。</p>
<pre><code class="vb">Sub KillFile()
    Dim myFile As String
    myFile = ThisWorkbook.Path &amp; &quot;\123.xls&quot;
    If Dir(myFile) &lt;&gt; &quot;&quot; Then Kill myFile
End Sub
代码解析：
KillFile过程使用Kill方法示例文件所在文件夹中的“123.xls”文件。
第3行代码指定所要删除文件的路径和文件名称。
第4行代码使用Dir函数返回指定文件名，（关于Dir函数请参阅技巧173 ）如果存在该文件则使用Kill语句删除。Kill语句从磁盘中删除文件，语法如下：
Kill pathname
参数pathname是必需的，用来指定一个文件名的字符串表达式，可以包含目录或文件夹、以及驱动器。
在Microsoft Windows中，Kill方法支持多字符 (*) 和单字符(?)的统配符来指定多重文件，如需要删除当前目录下所有*. Xls文件可以使用下面的代码：
Kill &quot;*.xls&quot;
注意 使用Kill方法不能删除已打开的文件，否则会产生错误。</code></pre>
<h3 id="技巧179-搜索特定的文件"><a href="#技巧179-搜索特定的文件" class="headerlink" title="技巧179     搜索特定的文件"></a>技巧179     搜索特定的文件</h3><p>如果需要对文件夹中所有的Excel文件进行相同的操作，那么可以使用Execute方法进行文件搜索，示例代码如下所示。</p>
<pre><code class="vb">Sub Sort()
    Dim i As Byte
    Application.ScreenUpdating = False
    With Application.FileSearch
        .LookIn = ThisWorkbook.Path
        .FileType = msoFileTypeExcelWorkbooks
        If .Execute &gt; 0 Then
            For i = 1 To .FoundFiles.Count
                If .FoundFiles(i) &lt;&gt; ThisWorkbook.FullName Then
                    Workbooks.Open .FoundFiles(i)
                    With ActiveWorkbook
                        .Sheets(&quot;Sheet1&quot;).Range(&quot;A1&quot;) = &quot;最后打开时间：&quot; &amp; Now
                        .Close True
                    End With
                End If
            Next
        End If
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
Sort过程搜索同一目录中的所有Excel文件并对其进行操作。
第3行代码关闭屏幕更新功能，加快代码的运行速度。
第4行代码为文件搜索创建一个FoundFiles对象。
第5行代码设置要搜索的文件夹，应用于FoundFiles对象的LookIn属性返回或设置在指定的文件搜索过程中要搜索的文件夹。
第6行代码设置搜索的文件类型为Excel文件，应用于FoundFiles对象的FileType属性返回或设置文件搜索过程中要查找的文件类型，设置为msoFileTypeExcelWorkbooks返回Excel文件。
第7行代码开始对指定文件进行搜索，应用于FoundFiles对象的Execute方法用于搜索文件，语法如下：
expression.Execute(SortBy, SortOrder, AlwaysAccurate)
参数expression是必需的，返回一个FoundFiles对象。
参数SortBy是可选的，用于对返回的文件进行排序。
参数SortOrder是可选的，表明所返回文件的排序顺序。
参数AlwaysAccurate是可选的，设置为True使文件搜索包括上次更新文件索引以来添加、修改或删除的文件。
在使用Execute方法搜索文件时，如果没有找到文件，则返回零(0)，如果找到一个或多个文件，则返回一个正数。
第8行代码使用For...Next 语句遍历Execute方法返回的返回的文件列表。应用于FoundFiles对象的FoundFiles属性返回一个FoundFiles对象，代表由文件搜索过程中返回的文件列表。
第9行代码判断返回的单个FoundFiles对象的名称是否是示例文件的名称，如果否则执行后续代码。
第10行代码使用应用于Workbooks对象的Open方法打开由返回的单个FoundFiles对象代表的工作簿。
第11行到第14行代码在打开的活动工作簿的工作表中写入打开时间后保存、关闭活动工作簿。
运行Sort过程将打开示例所在文件夹中所有的Excel文件并对其进行相应的操作。</code></pre>
<h3 id="技巧180-使用WSH处理文件"><a href="#技巧180-使用WSH处理文件" class="headerlink" title="技巧180     使用WSH处理文件"></a>技巧180     使用WSH处理文件</h3><p>Windows Scripting Host(WSH)可以创建一些控制Windows操作系统和应用程序以及从操作系统中获取信息的小程序，而使用WSH的FileSystemObject对象可以用来处理文件系统。<br>在使用WSH处理文件时，必需使用CreateObject函数创建一个ActiveX对象（FileSystemObject对象），用来提供访问计算机的文件系统，如下面的代码所示：<br>Dim MyFile As Object<br>Set MyFile = CreateObject(“Scripting.FileSystemObject”)<br>上面的代码首先声明一个名为MyFile的对象变量，然后使用CreateObject函数创建一个ActiveX对象并将该对象赋给对象变量。<br>CreateObject函数创建并返回一个对ActiveX对象的引用，语法如下：<br>CreateObject(class,[servername])<br>其中参数class是必需的，要创建的应用程序名称和类，使用appname.objecttype这种语法，appname指定该对象的应用程序名称，objecttype指定该对象的类型或类。<br>在声明了对象变量MyFile为Windows Scripting库的FileSystemObject对象后就能使用该对象的属性、方法来处理文件系统。</p>
<h4 id="180-1-获取文件信息"><a href="#180-1-获取文件信息" class="headerlink" title="180-1    获取文件信息"></a>180-1    获取文件信息</h4><p>如果需要获得指定文件的信息，可以使用File对象的Getfile方法，如下面的代码所示。</p>
<pre><code class="vb">Sub Fileinfo()
    Dim MyFile As Object
    Dim Str As String
    Dim StrMsg As String
    Str = ThisWorkbook.Path &amp; &quot;\123.xls&quot;
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    With MyFile.Getfile(Str)
        StrMsg = StrMsg &amp; &quot;文件名称：&quot; &amp; .Name &amp; Chr(13) _
            &amp; &quot;文件创建日期：&quot; &amp; .DateCreated &amp; Chr(13) _
            &amp; &quot;文件修改日期：&quot; &amp; .DateLastModified &amp; Chr(13) _
            &amp; &quot;文件访问日期：&quot; &amp; .DateLastAccessed &amp; Chr(13) _
            &amp; &quot;文件保存路径：&quot; &amp; .ParentFolder
    End With
    MsgBox StrMsg
    Set MyFile = Nothing
End Sub
代码解析：
Fileinfo过程使用Getfile方法获取示例所在文件夹中的“123.xls”文件的信息。
第5行代码将文件路径名称赋给变量Str。
第6行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第7行代码使用Getfile方法返回一个File对象。Getfile方法返回一个和指定路径中文件相对应的File对象，语法如下：
object.GetFile(filespec)
参数object是必需的，FileSystemObject对象的名称。
参数filespec是必需的，指定文件的路径。
第8行到第12行代码根据File对象的属性取得文件信息，File对象的常用属性如表格 180 1所示。
属性    描述
Name    文件名称
DateCreated    文件创建日期
DateLastModified    文件最后修改日期
DateLastAccessed    文件最后访问日期
ParentFolder    文件的父文件夹
Path    文件的完整路径
Type    文件类型
Size    以字节表示的文件大小
表格 180 1    File对象的常用属性
运行Fileinfo过程使用消息框显示“123.xls”文件的信息，如图 180 1所示。

图 180 1    获取文件信息</code></pre>
<h4 id="180-2-查找文件"><a href="#180-2-查找文件" class="headerlink" title="180-2    查找文件"></a>180-2    查找文件</h4><p>使用FileSystemObject对象的FileExists方法可以查找指定的文件，如下面的代码所示。</p>
<pre><code class="vb">Sub FileExis()
    Dim MyFile As Object
    Dim Str As String
    Dim StrMsg As String
    Str = ThisWorkbook.Path &amp; &quot;\123.xls&quot;
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    If MyFile.FileExists(Str) Then
        MsgBox &quot;文件已找到!&quot;
    Else
        MsgBox &quot;文件不存在!&quot;
    End If
    Set MyFile = Nothing
End Sub
代码解析：
FileExis过程使用FileExists方法查找示例所在文件夹中是否存在“123.xls”文件。
第6行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第7行代码使用FileExists方法可以查找文件。应用于FileSystemObject对象的FileExists方法查找指定的文件，语法如下：
object.FileExists(filespec)
参数object是必需的，FileSystemObject对象的名称。
参数filespec是必需的，要确定是否存在的文件的名字。如果文件不在当前文件夹中，必须提供一个完整的路径说明。
使用FileExists方法查找文件时如果指定的文件存在，返回True，若不存在，则返回False，根据返回值可以确定所要查找的文件是否存在。</code></pre>
<h4 id="180-3-移动文件"><a href="#180-3-移动文件" class="headerlink" title="180-3    移动文件"></a>180-3    移动文件</h4><p>如果需要把文件从一个地方移动到另一个地方，可以使用FileSystemObject对象的MoveFile方法，如下面的代码所示。</p>
<pre><code class="vb">Sub MoveFile()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.MoveFile ThisWorkbook.Path &amp; &quot;\123.xls&quot;, ThisWorkbook.Path &amp; &quot;\ABC\&quot;
    Set MyFile = Nothing
End Sub
代码解析：
MoveFile过程使用MoveFile方法将示例文件所在文件夹中的“123.xls”文件移动到“ABC”文件夹中。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使用MoveFile方法移动文件。应用于FileSystemObject对象的MoveFile方法将一个或多个文件从一个地方移动到另一个地方，语法如下：
object.MoveFile source, destination 
参数object是必需的， FileSystemObject对象的名称。
参数source是必需的，一个或多个要移动文件的路径，source参数字符串在路径的最后部件中可以使用通配符。
参数destinatio是必需的，一个或多个文件要移动到的目标路径，不能使用通配符。
运行MoveFile过程将示例文件所在文件夹中的“123.xls”文件移动到同一目录中的“ABC”文件夹。</code></pre>
<h4 id="180-4-复制文件"><a href="#180-4-复制文件" class="headerlink" title="180-4    复制文件"></a>180-4    复制文件</h4><p>如果需要把文件从一个地方复制到另一个地方，可以使用CopyFile方法，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyFile()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.CopyFile ThisWorkbook.Path &amp; &quot;\123.xls&quot;, ThisWorkbook.Path &amp; &quot;\ABC\&quot;
    Set MyFile = Nothing
End Sub
代码解析：
CopyFile过程使用CopyFile方法将示例文件所在文件夹中的“123.xls”文件复制到“ABC”文件夹中。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使用CopyFile方法复制文件。应用于FileSystemObject对象的CopyFile方法把一个或多个文件从一个地方复制到另一个地方，语法如下：
object.CopyFile source, destination[, overwrite]
参数object是必需的， FileSystemObject对象的名字。
参数source是必需的，指明一个或多个要被复制文件的字符串文件说明，可以包括通配符。
参数destination是必需的，指明参数source中的一个或多个文件要被复制到的接受端的字符串，不允许有通配符。
参数overwrite是可选的，表示存在的文件是否被覆盖。如果是True，文件将被覆盖；如果是False，它们不被覆盖，缺省值是True。
注意 如果参数destination指定的接受端具有只读属性设置，不论参数overwrite的值如何设置，CopyFile方法都将失败。
运行CopyFile过程将示例文件所在文件夹中的“123.xls”文件复制到“ABC”文件夹中。</code></pre>
<h4 id="180-5-删除文件"><a href="#180-5-删除文件" class="headerlink" title="180-5    删除文件"></a>180-5    删除文件</h4><p>如果需要删除一个指定的文件，可以使用DeleteFile方法，如下面的代码所示。</p>
<pre><code class="vb">Sub DelFile()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.DeleteFile ThisWorkbook.Path &amp; &quot;\123.xls&quot;
    Set MyFile = Nothing
End Sub
代码解析：
DelFile过程使DeleteFile方法删除示例文件所在文件夹中的“123.xls”文件。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使用DeleteFile方法复制文件。应用于FileSystemObject对象的DeleteFile方法删除一个指定的文件，语法如下：
object.DeleteFile filespec[, force]
参数object是必需的， FileSystemObject对象的名字。
参数filespec是必需的，指明要删除文件的名字，可以在最后的路径部件中包含通配符。
参数force是可选的，如果要删除具有只读属性设置的文件，其值为True。如果其值为False（缺省），则不能删除具有只读属性设置的文件。
运行DelFile过程删除示例文件所在文件夹中的“123.xls”文件。</code></pre>
<p>180-6    创建文件夹<br>如果需要创建一个文件夹，可以使用CreateFolder方法，如下面的代码所示。</p>
<pre><code class="vb">Sub CreFolder()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.CreateFolder (ThisWorkbook.Path &amp; &quot;\ABC&quot;)
    Set MyFile = Nothing
End Sub
代码解析：
CreFolder过程使CreateFolder方法在示例文件所在文件夹中创建一个“ABC”文件夹。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使用CreateFolder方法创建文件夹。应用于FileSystemObject对象的CreateFolder方法创建一个文件夹，语法如下：
object.CreateFolder(foldername)
参数object是必需的， FileSystemObject对象的名字。
参数foldername是必需的，字符串表达式，指明要创建文件夹的名称和路径。
运行CreFolder过程将在示例文件所在文件夹中创建一个“ABC”文件夹。</code></pre>
<h4 id="180-7-复制文件夹"><a href="#180-7-复制文件夹" class="headerlink" title="180-7    复制文件夹"></a>180-7    复制文件夹</h4><p>如果需要复制文件夹，可以使用CopyFolder方法，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyFolder()
    Dim MyFile As Object
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.CopyFolder ThisWorkbook.Path &amp; &quot;\ABC&quot;, ThisWorkbook.Path &amp; &quot;\123&quot;
    Set MyFile = Nothing
End Sub
代码解析：
CopyFolder过程使CopyFolder方法将示例文件所在文件夹中的“ABC”文件夹复制并改名为“123”文件夹。
第3行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第4行代码使用CopyFolder方法复制文件夹。应用于FileSystemObject对象的CreateObject方法从一个地方递归地复制一个文件夹到另一个地方，语法如下：
object.CopyFolder source, destination[, overwrite]
参数object是必需的， FileSystemObject对象的名字。
参数source是必需的，指明一个或多个被复制文件夹的字符串文件夹说明，可以包括通配符。
参数destination是必需的，被复制文件夹和子文件夹的接受端的字符串，不允许有通配符。
参数overwrite是可选的，表示已存在的文件夹是否被覆盖。如果为True，文件被覆盖，如果为False，文件不被覆盖。缺省值为True。
如果参数source中包含通配符或参数destination以路径分隔符（\）为结尾，则认为参数destination是一个已存在的文件夹，在其中复制相匹配的文件夹和子文件夹。否则认为参数destination是一个要创建的文件夹的名字。
运行CopyFolder过程将示例文件所在文件夹中的“ABC”文件夹复制并改名为“123”文件夹。</code></pre>
<h4 id="180-8-移动文件夹"><a href="#180-8-移动文件夹" class="headerlink" title="180-8    移动文件夹"></a>180-8    移动文件夹</h4><p>如果需要移动文件夹，可以使用MoveFolder方法，如下面的代码所示。</p>
<pre><code class="vb">Sub MoveFolder()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.MoveFolder ThisWorkbook.Path &amp; &quot;\123&quot;, &quot;F:\123&quot;
    Set MyFile = Nothing
End Sub
代码解析：
MoveFolder过程使MoveFolder方法将示例文件所在文件夹中的“123”文件夹移动到F盘中。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使MoveFolder方法移动文件夹。应用于FileSystemObject对象的MoveFolder方法将一个或多个文件夹从一个地方移动到另一个地方，语法如下：
object.MoveFolder source, destination
参数object是必需的， FileSystemObject对象的名字。
参数source是必需的，指明一个或多个要移动文件夹的字符串文件夹说明，在路径的最后部件中可以包括通配符。
参数destination是必需的，一个或多个文件夹要移动到的目标路径，不能包含通配符。
如果参数source中包含通配符或参数destination以路径分隔符（\）为结尾，则认为参数destination是一个已存在的文件夹，在此文件夹中移动相匹配的文件。否则认为参数destination是一个要创建的文件夹的名字。
运行MoveFolder过程将示例文件所在文件夹中的“123”文件夹移动到F盘中。</code></pre>
<h4 id="180-9-删除文件夹"><a href="#180-9-删除文件夹" class="headerlink" title="180-9    删除文件夹"></a>180-9    删除文件夹</h4><p>如果需要删除一个文件夹，可以使用DeleteFolder方法，如下面的代码所示。</p>
<pre><code class="vb">Sub DelFolder()
    Dim MyFile As Object
    On Error Resume Next
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;)
    MyFile.DeleteFolder ThisWorkbook.Path &amp; &quot;\123&quot;
    Set MyFile = Nothing
End Sub
代码解析：
DelFolder过程使DeleteFolder方法删除示例文件所在文件夹中的“123”文件夹。
第4行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile。
第5行代码使用DeleteFolder方法删除文件。应用于FileSystemObject对象的DeleteFolder方法删除一个指定的文件夹和其中的内容，语法如下：
object.DeleteFolder folderspec[, force]
参数object是必需的， FileSystemObject对象的名字。
参数filespec是必需的，指明要删除的文件夹的名称，可以在最后的路径部件中包含通配符。
参数force是可选的，如果要删除具有只读属性设置的文件夹，其值为True。如果其值为False（缺省），则不能删除具有只读属性设置的文件夹。
运行DelFolder过程删除示例文件所在文件夹中的“123.xls”文件夹。</code></pre>
<h4 id="180-10-导入文本文件"><a href="#180-10-导入文本文件" class="headerlink" title="180-10    导入文本文件"></a>180-10    导入文本文件</h4><p>如果需要从文本文件中导入数据，可以使用OpenTextFile方法，如下面的代码所示。</p>
<pre><code class="vb">Sub OpenText()
    Dim MyFile As Object
    Dim mArr() As String
    Dim j As Integer, i As Integer
    j = 1
    Sheet1.UsedRange.ClearContents
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;) _
        .OpenTextFile(ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;工资表.txt&quot;)
    Do While Not MyFile.AtEndOfStream
        mArr = Split(MyFile.ReadLine, &quot;,&quot;)
        For i = 0 To UBound(mArr)
            Sheet1.Cells(j, i + 1) = mArr(i)
        Next
        j = j + 1
    Loop
    MyFile.Close
    Set MyFile = Nothing
End Sub
代码解析：
OpenText过程使用OpenTextFile方法打开示例文件所在文件夹中的“工资表.txt”文件并将数据导入到工作表中。
第7、8行代码使用OpenTextFile方法打开文本文件。应用于FileSystemObject对象的OpenTextFile方法打开一个指定的文件并返回一个TextStream对象，该对象可用于对文件进行读操作或追加操作，语法如下：
object.OpenTextFile(filename[, iomode[, create[, format]]])
参数object是必需的，FileSystemObject对象的名字。
参数filename是必需的，需要打开的文件名称。
参数iomode是可选的，表示输入/输出方式，设置值如表格 180 2所示。
常数    值    描述
ForReading    1    打开一个只读文件，不能对此文件进行写操作。
ForAppending    8    打开一个文件并写到文件的尾部。

表格 180 2    iomode参数设置值
参数create是可选的，它表示如果指定的参数filename不存在是否可以创建一个新文件。如果创建新文件，其值为True。若不创建文件其值为False。缺省值为False。
参数format是可选的，打开文件的格式，设置值如表格 180 3所示。
常数    值    描述
TristateUseDefault    -2    使用系统缺省打开文件
TristateTrue    -1    以 Unicode 格式打开文件
TristateFalse    0    以 ASCII 格式打开文件
表格 180 3    format参数设置值
第9行代码开始对文本文件进行读操作。应用于TextStream对象的AtEndOfStream属性指示文件指针是否位于TextStream文件中的结尾，如果是返回True，否则返回False。
第10行代码使用Split函数将逐行读取的字符串以逗号进行分隔后赋给数组mArr。关于Split函数请参阅技巧169-2。
应用于TextStream对象的ReadLine方法从一个TextStream文件读取一整行（到换行符但不包括换行符）并返回得到的字符串，语法如下：
object.ReadLine
参数object是必需的，TextStream对象的名字。
第11行到第14行代码将数组元素写入到工作表的单元格。
第15行代码重新读取下一行数据。
第16行使用Close方法关闭打开的文本文件。
运行OpenText过程将“工资表.txt”文件的数据导入到工作表中。</code></pre>
<h4 id="180-11-创建文本文件"><a href="#180-11-创建文本文件" class="headerlink" title="180-11    创建文本文件"></a>180-11    创建文本文件</h4><p>如果需要将工作表中的数据保存为文本文件，可以创建一个文本文件用于保存数据。<br>使用CreateTextFile方法创建文本文件，如下面的代码所示。</p>
<pre><code class="vb">Sub CreText()
    Dim MyFile As Object
    Dim myStr As String
    Dim j As Integer, i As Integer
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;) _
        .CreateTextFile(ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;工资表.txt&quot;, True)
        For i = 1 To Range(&quot;A65536&quot;).End(xlUp).Row
            myStr = &quot;&quot;
            For j = 1 To Range(&quot;IV&quot;&amp; i).End(xlToLeft).Column
                myStr = myStr &amp; Cells(i, j) &amp; &quot;,&quot;
            Next
            myStr = Left(myStr, (Len(myStr) - 1))
            MyFile.WriteLine (myStr)
        Next
    MyFile.Close
    Set MyFile = Nothing
End Sub
代码解析：
CreText过程使CreateTextFile方法创建一个指定名称的文本文件并将工作表数据写入到文件内。
第5、6行代码使用CreateObject函数创建FileSystemObject对象并将该对象赋给变量MyFile后使用CreateTextFile方法创建一个指定名称的文本文件。
应用于FileSystemObject对象的CreateTextFile方法创建一个指定的文件并且返回一个用于该文件读写的TextStream对象，语法如下：
object.CreateTextFile(filename[, overwrite[, unicode]])
参数object是必需的，FileSystemObject对象的名字。
参数filename是必需的，需要创建的文件名称。
参数overwrite是可选的，表示是否覆盖已存在文件。如果可被覆盖其值为True，其值为False时不能覆盖，如果省略，则已存在文件不能覆盖。
参数unicode是可选的，表示文件是作为一个Unicode文件创建的还是作为一个ASCII文件创建的。如果作为一个Unicode文件创建，其值为True，作为一个ASCII 文件创建，其值为False，如果省略，则认为是一个ASCII文件。
第7行代码逐行读取工作表数据。
第8行代码清空字符串变量myStr的内容，用来保存下一行的数据。
第9行代码遍历当前行的所有单元格。
第10行代码将当前行的所有单元格保存到字符串变量myStr中并以逗号进行分隔。
第12行代码去除保存在字符串变量myStr中当前行数据的最后一个逗号。
第13行代码使用WriteLine方法将当前行数据写入到创建的文本文件。
应用于TextStream对象的WriteLine方法写入一个指定的字符串和换行符到一个TextStream文件中，语法如下：
object.WriteLine([string])
参数object是必需的，TextStream对象的名字。
参数string是可选的，要写入文件的正文。如果省略，写入一个换行符。
第15行使用Close方法关闭打开的文本文件。</code></pre>
<p>还可以使用OpenTextFile方法创建文本文件，如下面的代码所示。</p>
<pre><code class="vb">Sub OpenText()
    Dim MyFile As Object
    Dim myStr As String
    Dim j As Integer, i As Integer
    Set MyFile = CreateObject(&quot;Scripting.FileSystemObject&quot;) _
        .OpenTextFile(ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;工资表.txt&quot;, 8, True)
        For i = 1 To Range(&quot;A65536&quot;).End(xlUp).Row
            myStr = &quot;&quot;
            For j = 1 To Range(&quot;IV&quot; &amp; i).End(xlToLeft).Column
                myStr = myStr &amp; Cells(i, j) &amp; &quot;,&quot;
            Next
            myStr = Left(myStr, (Len(myStr) - 1))
            MyFile.WriteLine (myStr)
        Next
    MyFile.Close
    Set MyFile = Nothing
End Sub
代码解析：
OpenText过程使OpenTextFile方法创建一个指定名称的文本文件并将工作表数据写入到文件内。
应用于FileSystemObject对象的OpenTextFile方法打开一个指定的文件并返回一个 TextStream对象，该对象可用于对文件进行读操作或追加操作，请参阅技巧180-10。 
示例中将OpenTextFile方法的iomode参数设置为8，打开文本文件后在文件的尾部进行追加操作；将create参数设置为True，如果指定的文本文件不存在则创建一个新文件。
注意 如果重复运行OpenText过程将在文本文件中重复写入工作表数据，所以OpenTextFile方法更适用于对文本文件进行追加操作。
OpenText过程的其他代码请参阅CreText过程的代码解析。
运行CreText过程和OpenText过程将在示例所在的文件夹中创建一个名称为“工资表”的文本文件并将工作表数据读入到文件内。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/06/02/VBA常用技巧10--文件操作/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧9--函数的使用" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/31/VBA常用技巧9--函数的使用/">VBA常用技巧9--函数的使用</a>
    </h1>
  

        
        <a href="/2018/05/31/VBA常用技巧9--函数的使用/" class="archive-article-date">
  	<time datetime="2018-05-30T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-31</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第9章-函数的使用"><a href="#第9章-函数的使用" class="headerlink" title="第9章     函数的使用"></a>第9章     函数的使用</h2><h3 id="技巧153-调用工作表函数求和"><a href="#技巧153-调用工作表函数求和" class="headerlink" title="技巧153     调用工作表函数求和"></a>技巧153     调用工作表函数求和</h3><p>在对工作表的单元格区域进行求和计算时，使用工作表Sum函数比使用VBA代码遍历单元格进行累加求和效率要高得多，代码如下所示。</p>
<pre><code class="vb">Sub rngSum()
    Dim rng As Range
    Dim d As Double
    Set rng = Range(&quot;A1:F7&quot;)
    d = Application.WorksheetFunction.Sum(rng)
    MsgBox rng.Address(0, 0) &amp; &quot;单元格的和为&quot; &amp; d
End Sub
代码解析：
rngSum过程调用工作表Sum函数对工作表的单元格区域进行求和计算。
在VBA中调用工作表函数需要在工作表函数前加上WorksheetFunction属性。应用于Application对象的WorksheetFunction属性返回WorksheetFunction对象，作为VBA中调用工作表函数的容器，在实际应用中可省略Application对象识别符。</code></pre>
<h3 id="技巧154-查找最大、最小值"><a href="#技巧154-查找最大、最小值" class="headerlink" title="技巧154     查找最大、最小值"></a>技巧154     查找最大、最小值</h3><p>在VBA中没有内置的函数可以进行最大、最小值的查找，借助工作表Max、Min函数可以快速地在工作表区域中查找最大、最小值，如下面的代码所示。</p>
<p>​```vb<br>Sub seeks()<br>    Dim rng As Range<br>    Dim myRng As Range<br>    Dim k1 As Integer, k2 As Integer<br>    Dim max As Double, min As Double<br>    Set myRng = Sheet1.Range(“A1:F30”)<br>    For Each rng In myRng<br>        If rng.Value = WorksheetFunction.max(myRng) Then<br>            rng.Interior.ColorIndex = 3<br>            k1 = k1 + 1<br>            max = rng.Value<br>        ElseIf rng.Value = WorksheetFunction.min(myRng) Then<br>            rng.Interior.ColorIndex = 5<br>            k2 = k2 + 1<br>            min = rng.Value<br>        Else<br>            rng.Interior.ColorIndex = 0<br>        End If<br>    Next<br>    MsgBox “最大值是:” &amp; max &amp; “共有 “ &amp; k1 &amp; “个” _
        &amp; Chr(13) &amp; “最小值是:” &amp; min &amp; “共有 “ &amp; k2 &amp; “个”<br>End Sub<br>代码解析：<br>seeks过程在工作表单元格区域中查找最大、最小值，并将其所在的单元格底色分别设置为红色和蓝色。<br>第2行到第5行代码声明变量类型。<br>第6行代码使用关键字Set将单元格引用赋给变量myRng。<br>第7行到第19行代码遍历单元格区域，使用工作表Max、Min函数判断单元格数值是否是所在区域的最大、最小值，如果是，将其所在的单元格底色设置为红色或蓝色，并保存其数值和数量。<br>第20、21行代码使用消息框显示最大、最小值数值和数量。<br>运行seeks过程后将工作表区域最大、最小值所在的单元格的底色设置为红色或蓝色并用消息框显示其数值和数量，如图 154 1所示。</p>
<p>图 154 1    查找最大、最小值</p>
<pre><code>
### 技巧155     不重复值的录入
在工作表中录入数据时，有时希望能限制重复值的录入，比如在示例的A列单元格只能录入唯一的人员编号，此时可以利用工作表的Change事件结合工作表的CountIf 函数来判断所录入的人员编号是否重复，示例代码如下。

​```vb
Private Sub Worksheet_Change(ByVal Target As Range)
    With Target
        If .Column &lt;&gt; 1 Or .Count &gt; 1 Then Exit Sub
        If Application.CountIf(Range(&quot;A:A&quot;), .Value) &gt; 1 Then
            .Select
            MsgBox &quot;不能输入重复的人员编号!&quot;, 64
            Application.EnableEvents = False
            .Value = &quot;&quot;
            Application.EnableEvents = True
        End If
    End With
End Sub
代码解析：
工作表的Change事件过程，使A列单元格只能录入唯一的人员编号。
第4行代码使用工作表的CountIf 函数来判断在A列单元格输入的人员编号是否重复。工作表的CountIf 函数计算区域中满足给定条件的单元格的个数，语法如下：
COUNTIF(range, criteria)
参数range为需要计算其中满足条件的单元格数目的单元格区域。
参数criteria为确定哪些单元格将被计算在内的条件，其形式可以为数字、表达式、单元格引用或文本。
在示例中以所录入的人员编号与A列单元格区域进行比较，如果CountIf 函数的返回值大于1，说明录入的是重复编号。
第5行代码，重新选择该单元格便于下一步清空后重新录入。
第7、8、9行代码，清除录入的重复编号，在清除前将Application对象的EnableEvents属性设置为False，禁用事件。因为如果不禁用事件，那么在清除重复值的过程中会不断地触发工作表的Change事件，从而造成代码运行的死循环。
经过以上的设置，在工作表的A列中只能录入唯一的人员编号，如果录入重复值会进行提示，如图 155 1所示，点击确定后自动清除录入的重复编号。</code></pre><h3 id="技巧156-获得当月的最后一天"><a href="#技巧156-获得当月的最后一天" class="headerlink" title="技巧156     获得当月的最后一天"></a>技巧156     获得当月的最后一天</h3><p>在实际工作中经常需要根据给定的日期计算其所属月份的最后一天，此时可以使用DateSerial函数完成计算，如下面的代码所示。</p>
<pre><code class="vb">Sub Serial()
    Dim DateStr As Byte
    DateStr = Day(DateSerial(Year(Date), Month(Date) + 1, 0))
    MsgBox &quot;本月的最后一天是&quot; &amp; Month(Date) &amp; &quot;月&quot; &amp; DateStr &amp; &quot;号&quot;
End Sub
代码解析：
Serial过程配合使用了4个VBA内置函数Year、Month、Day和DateSerial完成计算并使用消息框显示当月最后一天的日期。
Year、Month和Day函数分别返回代表指定日期的年、月、日的整数，语法如下：
Year(Date)
Month(Date)
Day(Date)
其中参数Date可以是任何能够表示日期的Variant、数值表达式、字符串表达式或它们的组合。
DateSerial函数返回包含指定的年、月、日的Variant (Date)，语法如下：
DateSerial(year, month, day)
其中参数year、 month、day分别表示指定的年、月、日。
为了指定某个日期， DateSerial 函数中的每个参数的取值范围应该是可接受的，即日的取值范围应在1-31之间，而月的取值范围应在1-12之间。但是，当一个数值表达式表示某日之前或其后的年、月、日数时，也可以为每个使用这个数值表达式的参数指定相对日期。当任何一个参数的取值超出可接受的范围时，它会自动地在可接受的时间单位进行调整，例如本例中的day参数设置为0，则被解释成month参数指定月的前一天，即表达式Month(Date) + 1指定的下一个月的前一天，也就是本月的最后一天。</code></pre>
<h3 id="技巧157-四舍五入运算"><a href="#技巧157-四舍五入运算" class="headerlink" title="技巧157     四舍五入运算"></a>技巧157     四舍五入运算</h3><p>在实际工作中经常需要对数值或计算结果进行四舍五入运算，此时可以使用VBA内置的Round函数。Round函数返回一个数值，该数值是按照指定的小数位数进行四舍五入运算的结果，语法如下：<br>Round(expression [,numdecimalplaces])<br>参数expression是必需的，要进行四舍五入运算的数值表达式。<br>参数numdecimalplaces是可选的，数字值，表示进行四舍五入运算时，小数点右边应保留的位数。如果忽略，则Round函数返回整数。<br>但是VBA内置的Round函数在对数值进行四舍五入运算时实行的是Bankre舍入，而不是算术舍入。按Bankre舍入规则，如果保留位数的下一个数字正好是5则其后没有其他有效数字，则按保留位最后一位“偶舍奇入”的方法进行处理。比如Round(1.5)的保留位最后为1，是奇数，小数位的5入上去，因此Round(1.5)的运算结果是2；而Round(4.5)的保留位最后为4，是偶数，小数位的5舍去，因此Round(4.5) 的运算结果是4而不是5。<br>Bankre舍入规则虽然有其合理性，但不符合实际工作的需要。在实际应用中使用以下两种方法避免Bankre舍入：</p>
<h4 id="157-1-极小值修正法"><a href="#157-1-极小值修正法" class="headerlink" title="157-1    极小值修正法"></a>157-1    极小值修正法</h4><p>在使用Round函数时对需要舍入的数值先加上极小值再调用VBA内置的Round函数，如下面的代码所示。</p>
<pre><code class="vb">Sub aTestRound()
    MsgBox &quot;Round(4.5)=&quot; &amp; Round(4.5) &amp; Chr(13) &amp; &quot;Round(4.5)=&quot; &amp; Round(4.5 + 0.0000001)
End Sub
代码解析：
aTestRound过程分别调用VBA内置的Round函数和加上极小值再调用VBA内置的Round函数在洗染店框中显示两者运算结果，如图 157 1所示。

图 157 1    加上极小值进行运算结果
从运算结果中可以发现，加上极小值后Round(4.5)已正确运算为5而不是4。</code></pre>
<h4 id="157-2-调用工作表函数法"><a href="#157-2-调用工作表函数法" class="headerlink" title="157-2    调用工作表函数法"></a>157-2    调用工作表函数法</h4><p>还可以使用工作表函数Round代替VBA内置的Round函数。工作表函数Round和VBA内置的Round函数的用法相同，但它采用算术舍入而不是Bankre舍入，所以不会有“偶舍奇入”的问题，如下面的代码所示。</p>
<pre><code class="vb">Sub bTestRound()
    MsgBox &quot;Round(4.5)=&quot; &amp; Round(4.5) &amp; Chr(13) &amp; &quot;Round(4.5)=&quot; &amp; Application.Round(4.5, 0)
End Sub
代码解析：
bTestRound过程分别调用VBA内置的Round函数和工作表Round函数在消息框中显示两者运算结果，如图 157 2所示。

图 157 2    工作表函数运算结果
从运算结果中可以发现，使用工作表Round函数后Round(4.5)已正确运算为5而不是4。</code></pre>
<h3 id="技巧158-使用字符串函数"><a href="#技巧158-使用字符串函数" class="headerlink" title="技巧158     使用字符串函数"></a>技巧158     使用字符串函数</h3><p>使用VBA的字符串函数可以对字符串进行各种操作，如下面的代码所示。</p>
<pre><code class="vb">Sub StrFunctions()
    Dim Str As String
    Str = &quot;AbcD EFG hijk Lmn&quot;
    MsgBox &quot;原始字符串为：&quot; &amp; Str &amp; Chr(13) _
        &amp; &quot;字符串长度为：&quot; &amp; Len(Str) &amp; Chr(13) _
        &amp; &quot;左边8个字符为：&quot; &amp; Left(Str, 8) &amp; Chr(13) _
        &amp; &quot;右边6个字符为：&quot; &amp; Right(Str, 6) &amp; Chr(13) _
        &amp; &quot;从左边第2个开始取5个字符为：&quot; &amp; Mid(Str, 2, 5) &amp; Chr(13) _
        &amp; &quot;转换为大写：&quot; &amp; UCase(Str) &amp; Chr(13) _
        &amp; &quot;转换为小写：&quot; &amp; LCase(Str) &amp; Chr(13)
End Sub
代码解析：
StrFunctions过程使用字符串函数对字符串进行各种操作，如计算字符数、取得一定数量的字符、大小写转换等。
第5行代码使用Len函数返回字符串内字符的数目，Len函数语法如下：
Len(string | varname)
参数string为任何有效的字符串表达式。
参数varname为任何有效的变量名称。
两个可能的参数必须有一个，而且只能有一个参数。
第6行代码使用Left函数从字符串左边起返回8个字符。
第7行代码使用Right函数从字符串右边起返回6个字符
Left函数语法如下：
Left(string, length)
Right函数语法如下：
Right(string, length)
参数string是必需的，字符串表达式。
参数length是必需的，数值表达式，将返回的字符数量。如果为0，返回零长度字符串 (&quot;&quot;)；如果大于或等于参数string的字符数，则返回整个字符串。
第8行代码使用Mid函数从字符串第2位起返回5个字符。Mid函数语法如下：
Mid(string, start[, length])
参数string是必需的，字符串表达式。
参数start是必需的，string中被取出部分的字符位置。如果超过string的字符数，将返回零长度字符串 (&quot;&quot;)。
参数length是可选的，要返回的字符数。如果省略或超过string的字符数，将返回字符串中所有字符。
第9行代码使用UCase函数将字符串转换成大写的字符串。
第10行代码使用LCase函数将字符串转换成小写的字符串。
UCase函数的语法如下：
UCase(string)
LCase函数的语法如下：
LCase(string)
参数string是必需的，任何有效的字符串表达式。
运行StrFunctions过程结果如图 158 1所示。

图 158 1    使用字符串函数</code></pre>
<h3 id="技巧159-使用日期函数"><a href="#技巧159-使用日期函数" class="headerlink" title="技巧159     使用日期函数"></a>技巧159     使用日期函数</h3><p>使用VBA的日期函数可以对日期进行各种计算，如下面的代码所示。</p>
<pre><code class="vb">Sub DatFunctions()
    Dim Str As String
    Dim Week As String
    Str = InputBox(&quot;请输入日期：&quot;)
    If Len(Str) &gt; 0 Then
        If IsDate(Str) Then
            Select Case Weekday(Str, vbMonday)
                Case 1
                    Week = &quot;一&quot;
                Case 2
                    Week = &quot;二&quot;
                Case 3
                    Week = &quot;三&quot;
                Case 4
                    Week = &quot;四&quot;
                Case 5
                    Week = &quot;五&quot;
                Case 6
                    Week = &quot;六&quot;
                Case 7
                    Week = &quot;日&quot;
            End Select
            MsgBox &quot;你输入的日期是&quot; &amp; DateValue(Str) &amp; Chr(13) _
                &amp; &quot;是&quot; &amp; Year(Str) &amp; &quot;年的第&quot; &amp; DatePart(&quot;q&quot;, Str) &amp; &quot;季度&quot; &amp; Chr(13) _
                &amp; &quot;是星期&quot; &amp; Week &amp; Chr(13) _
                &amp; &quot;距离今天有&quot; &amp; Abs(DateDiff(&quot;d&quot;, Date, Str)) &amp; &quot;天&quot; &amp; Chr(13) _
                &amp; &quot;60天后的日期是&quot; &amp; DateAdd(&quot;d&quot;, 60, Str)
        Else
            MsgBox &quot;请输入正确格式的日期!&quot;
        End If
    End If
End Sub
代码解析：
DatFunctions过程在对话框中输入日期后使用各种日期函数对其进行计算并用消息框显示。
第4、5行代码使用InputBox函数显示一个对话框，供用户在对话框中输入一个日期。
第6行代码使用IsDate函数判断输入的日期是否正确。IsDate函数返回Boolean值，指出一个表达式是否可以转换成日期，语法如下：
IsDate(expression)
参数expression是必需的，日期表达式或字符串表达式，如果表达式是一个日期，或者可以作为有效日期识别，则IsDate函数返回True，否则返回False。
第7行到第22行代码使用Weekday函数判断所输入的日期是星期几。Weekday函数返回一个整数，代表某个日期是星期几，语法如下：
Weekday(date, [firstdayofweek])
参数date是必需的，能够表示日期的 Variant、数值表达式、字符串表达式或它们的组合。
参数firstdayofweek是可选的，指定一星期第一天的常数，如表格 159 1所示。
常数    值    描述
vbUseSystem    0    使用 NLS API 设置
VbSunday    1    星期日（缺省值）
vbMonday    2    星期一
vbTuesday    3    星期二
vbWednesday    4    星期三
vbThursday    5    星期四
vbFriday    6    星期五
vbSaturday    7    星期六
表格 159 1    firstdayofweek参数值
Weekday函数返回一个1到7之间的整数，当firstdayofweek参数设置为vbMonday（2）时，返回1时说明是星期一，以此类推。
第23行代码根据系统中指定的短日期格式来显示所输入的日期。DateValue函数的语法如下：
DateValue(date)
参数date是必需的，任何表达式，表示从 100 年 1 月 1 日到 9999 年 12 月 31 日之间的一个日期。如果是一个字符串，且其内容只有数字以及分隔数字的日期分隔符，则 DateValue函数就会根据系统中指定的短日期格式来识别月、日、年的顺序。DateValue函数也识别明确的英文月份名称，全名或缩写均可。例如，除了12/30/1991 和12/30/91 之外，DateValue函数也能识别December 30, 1991 和Dec 30, 1991。
如果date参数中略去了年这一部分，DateValue函数就会使用由计算机系统日期设置的当前年份。
第24行代码判断输入的日期的季度。DatePart函数返回一个包含已知日期的指定时间部分的值，语法如下：
DatePart(interval, date[,firstdayofweek[, firstweekofyear]])
其中参数interval是必需的，字符串表达式，是要返回的时间间隔，设定值如表格 159 2所示。
设置    说明
yyyy    年
q    季
m    日
y    一年的日数
d    日
w    一周的日数
ww    周
h    时
n    分钟
s    秒
表格 159 2    interval参数设定值
第26行代码计算所输入的日期距当天的天数。DateDiff函数返回两个指定日期间的时间间隔数目，语法如下：
DateDiff(interval, date1, date2[, firstdayofweek[, firstweekofyear]])
其中参数interval是必需的，字符串表达式，表示用来计算date1和date2的时间差的时间间隔，设定值如表格 159 2所示。
参数date1和date2是必需的，计算中要用到的两个日期。
因为如果输入的日期是当前日期以前的日期，DateDiff函数会返回负值，所以使用Abs函数返回绝对值将其转换为正值。
第27行代码计算所输入的日期距当天的天数，DateAdd返回加上了一段时间间隔的一个日期，语法如下：
DateAdd(interval, number, date)
参数interval是必需的，字符串表达式，是所要加上去的时间间隔，设定值如表格 159 2所示。
参数number是必需的，是要加上的时间间隔的数目。其数值可以为正数（得到未来的日期），也可以为负数（得到过去的日期）。
参数date是必需的，需要加上时间间隔的字符串表达式。
运行DatFunctions过程，在显示的对话框中输入一个日期，结果如图 159 1所示。

图 159 1    使用日期函数</code></pre>
<h3 id="技巧160-判断是否为数值"><a href="#技巧160-判断是否为数值" class="headerlink" title="技巧160     判断是否为数值"></a>技巧160     判断是否为数值</h3><p>使用IsNumeric函数可以判断表达式的运算结果是否为数值，如下面的代码所示。</p>
<pre><code class="vb">Sub Numeric()
    Dim i As Integer
    Dim n As String
    Dim s As String
    With Sheet1
        For i = 1 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If IsNumeric(.Cells(i, 1)) Then
                n = n &amp; .Cells(i, 1).Address(0, 0) &amp; Chr(9) &amp; .Cells(i, 1) &amp; Chr(13)
            Else
                s = s &amp; .Cells(i, 1).Address(0, 0) &amp; Chr(9) &amp; .Cells(i, 1) &amp; Chr(13)
            End If
        Next
    End With
    MsgBox &quot;A列中数值单元格：&quot; &amp; Chr(13) &amp; n &amp; Chr(13) _
        &amp; &quot;A列中非数值单元格：&quot; &amp; Chr(13) &amp; s
End Sub
代码解析：
Numeric过程使用IsNumeric函数判断工作表的A列单元格是否为数值，并使用消息框显示。
第7行代码判断工作表的A列单元格是否为数值。IsNumeric函数返回Boolean值，指出表达式的运算结果是否为数，语法如下：
IsNumeric(expression)
参数expression是必需的，Variant类型，包含数值表达式或字符串表达式。
如果参数expression的运算结果为数字，则IsNumeric返回True，否则返回False。
第8行代码将数值单元格的地址和数值保存在变量 e中。
第10行代码将非数值单元格的地址和内容保存在变量 s中。在保存时插入制表符对数据列进行分隔，使之排列整齐，请参阅技巧73-5。
运行Numeric过程结果如图 160 1所示。

图 160 1    判断是否为数值</code></pre>
<h3 id="技巧161-格式化数值、日期和时间"><a href="#技巧161-格式化数值、日期和时间" class="headerlink" title="技巧161     格式化数值、日期和时间"></a>技巧161     格式化数值、日期和时间</h3><p>Format函数是VBA中的常用函数，可以实现数值、日期和时间格式的转变，示例代码如下：</p>
<pre><code class="vb">Sub FromatCurrent()
    MsgBox Format(123456.789, &quot;0.00&quot;) &amp; Chr(13) _
        &amp; Format(123456.789, &quot;0.00%&quot;) &amp; Chr(13) _
        &amp; Format(123456.789, &quot;##,##0.00&quot;) &amp; Chr(13) _
        &amp; Format(-123456.789, &quot;$#,##0.00;($#,##0.00)&quot;) &amp; Chr(13) _
        &amp; Format(-123456.789, &quot;￥#,##0.00;(￥#,##0.00)&quot;) &amp; Chr(13) _
        &amp; Format(Date, &quot;yyyy-mm-dd&quot;) &amp; Chr(13) _
        &amp; Format(Date, &quot;yyyymmdd&quot;) &amp; Chr(13) _
        &amp; Format(Date, &quot;Long Date&quot;) &amp; Chr(13) _
        &amp; Format(Now, &quot;hh:mm:ss&quot;) &amp; Chr(13) _
        &amp; Format(Now, &quot;hh:mm:ss AMPM&quot;)
End Sub
代码解析：
FromatCurrent过程使用消息框显示格式化后的数值、日期和时间。
Format函数根据格式表达式中的指令来格式化的数值、日期和时间，语法如下：
Format(expression[, format[, firstdayofweek[, firstweekofyear]]])
其中参数expression是必需的，任何有效的表达式。
参数format是可选的，有效的命名表达式或用户自定义格式表达式。
第2行代码将数值格式化为两位小数格式显示。
第3行代码将数值格式化为两位小数的百分比格式显示。
第4行代码将数值格式化为千位分隔符显示。
第5行代码将数值格式化为以美元符号显示的两位小数，以千位分隔符分隔，如果是负值则以小括号显示。
第6行代码将数值格式化为以人民币符号显示的两位小数，以千位分隔符分隔，如果是负值则以小括号显示。
第7行代码将系统日期格式化为“yyyy-mm-dd”格式显示。
第8行代码将系统日期格式化为“yyyymmdd”格式显示。
第9行代码将系统日期格式化为长日期格式显示。
第10行代码将系统时间格式化为24小时、分钟和秒的格式显示。
第11行代码将系统时间格式化为分12小时、分钟和秒的格式显示。
运行FromatCurrent过程结果如图 161 1所示。

图 161 1    格式化数值、日期和时间</code></pre>
<h3 id="技巧162-个人所得税自定义函数"><a href="#技巧162-个人所得税自定义函数" class="headerlink" title="技巧162     个人所得税自定义函数"></a>技巧162     个人所得税自定义函数</h3><p>在财务工作中经常需要计算个人所得税，而在Excel中没有计算个人所得税的函数，此时可以使用自定义函数来计算，如下面的代码所示。</p>
<pre><code class="vb">Public Function PITax(Income, Optional Threshold) As Single
    Dim Rate As Single
    Dim Debit As Single
    Dim Taxliability As Single
    If IsMissing(Threshold) Then Threshold = 2000
    Taxliability = Income - Threshold
    Select Case Taxliability
        Case 0 To 500
            Rate = 0.05
            Debit = 0
        Case 500.01 To 2000
            Rate = 0.1
            Debit = 25
        Case 2000.01 To 5000
            Rate = 0.15
            Debit = 125
        Case 5000.01 To 20000
            Rate = 0.2
            Debit = 375
        Case 20000.01 To 40000
            Rate = 0.25
            Debit = 1375
        Case 40000.01 To 60000
            Rate = 0.3
            Debit = 3375
        Case 60000.01 To 80000
            Rate = 0.35
            Debit = 6375
        Case 80000.01 To 10000
            Rate = 0.4
            Debit = 10375
        Case Else
            Rate = 0.45
            Debit = 15375
    End Select
    If Taxliability &lt;= 0 Then
        PITax = 0
    Else
        PITax = Application.Round(Taxliability * Rate - Debit, 2)
    End If
End Function
代码解析：
自定义PITax函数根据应纳税额计算应纳的个人所得税额。
第5行代码设置个人所得税的起征点为2000元，如果以后需要调整起征点，可把2000元改为调整后的起征点。
第6行代码设置全月应纳税所得额等于应纳税收入减去起征点。
第7行到第35行代码根据全月应纳税所得额取得税率和速算扣除数。税率和速算扣除数根据如表格 162 1所示的工资、薪金所得适用个人所得税九级超额累进税率表计算。
级数    全月应纳税所得额（含税所得额）    税率%    速算扣除数（元）
一    不超过500元    5    0
二    超过500元至2000元    10    25
三    超过2000元至5000元    15    125
四    超过5000元至20000元    20    375
五    超过20000元至40000元    25    1375
六    超过40000元至60000元    30    3375
七    超过60000元至80000元    35    6375
八    超过80000元至100000元    40    10375
九    超过100000元    45    15375
表格 162 1    个人所得税九级超额累进税率表
第36行到第40行代码根据应纳税所得额、税率和速算扣除数计算应纳的个人所得税额。其中第39行代码中使用工作表函数Round对计算结果进行四舍五入运算，请参阅技巧157-2。
在工作表中使用自定义PITax函数结果如图 162 1所示。

图 162 1    工作表中使用自定义PITax函数</code></pre>
<h3 id="技巧163-人民币大写函数"><a href="#技巧163-人民币大写函数" class="headerlink" title="技巧163     人民币大写函数"></a>技巧163     人民币大写函数</h3><p>在VBA中没有内置的函数进行人民币大写转换，此时可以编写自定义函数进行人民币大写转换，如下面的代码所示。</p>
<pre><code class="vb">Public Function RMBDX(M)
    RMBDX = Replace(Application.Text(Round(M + 0.00000001, 2), &quot;[DBnum2]&quot;), &quot;.&quot;, &quot;元&quot;)
    RMBDX = IIf(Left(Right(RMBDX, 3), 1) = &quot;元&quot;, Left(RMBDX, Len(RMBDX) - 1) &amp; &quot;角&quot; &amp; Right(RMBDX, 1) &amp; &quot;分&quot;, IIf(Left(Right(RMBDX, 2), 1) = &quot;元&quot;, RMBDX &amp; &quot;角整&quot;, IIf(RMBDX = &quot;零&quot;, &quot;&quot;, RMBDX &amp; &quot;元整&quot;)))
    RMBDX = Replace(Replace(Replace(Replace(RMBDX, &quot;零元零角&quot;, &quot;&quot;), &quot;零元&quot;, &quot;&quot;), &quot;零角&quot;, &quot;零&quot;), &quot;-&quot;, &quot;负&quot;)
End Function
代码解析：
第2行代码首先使用Round函数对小写数字加上极小值后进行四舍五入运算，关于Round函数请参阅技巧157-1。其次使用工作表Text函数将数值转换成人民币大写格式表示的文本。Text函数将数值转换为按指定数字格式表示的文本，语法如下：
TEXT(value,format_text)
Value参数为数值、计算结果为数值的公式，或对包含数值的单元格的引用。
Format_text参数为“单元格格式“对话框中”数字“选项卡上”分类框中的文本形式的数字格式。
最后使用Replace函数将人民币大写格式表示的文本中的小数点替换成“元”。Replace函数返回一个字符串，该字符串中指定的子字符串已被替换成另一子字符串，并且替换发生的次数也是指定的，语法如下：
Replace(expression, find, replace[, start[, count[, compare]]])
其中参数expression是必需的，包含要替换的子字符串。
参数find是必需的，要搜索到的子字符串。
参数replace是必需的，用来替换的子字符串。
参数start是可选的，在表达式中子字符串搜索的开始位置。
第3行代码使用了IIF函数、Left函数、Right函数根据第2行代码返回的人民币大写格式表示的文本中的“元”的位置在文本中插入正确的“元”、“角”、“分”字符，使之符合人民币大写习惯。
IIf函数根据表达式的值，来返回两部分中的其中一个，语法如下：
IIf(expr, truepart, falsepart)
参数expr是必需的，用来判断真伪的表达式。
参数truepart是必需的，如果expr为True，则返回这部分的值或表达式。
参数falsepart是必需的，如果expr为False，则返回这部分的值或表达式。
Left、Right函数请参阅技巧158 。
第4行代码使用Replace函数将人民币大写格式表示的文本中可能出现的“零元零角”、“零元”替换成空白字符；可能出现的“零角”替换成“零”。如果输入负数的话，将“-”替换成“负”。
在工作表中使用自定义RMBDX函数转换人民币大写的效果如图 163 1所示。

图 163 1    人民币大写转换</code></pre>
<h3 id="技巧164-列号转换为列标"><a href="#技巧164-列号转换为列标" class="headerlink" title="技巧164     列号转换为列标"></a>技巧164     列号转换为列标</h3><p>使用VBA获取单元格的列号时，只能返回一个数值。如果需要获取以字符表示的列标，可以使用下面的自定义GetColumn函数过程。</p>
<pre><code class="vb">Function GetColumn(C As Integer) As String
    GetColumn = Split(Cells(1, C).Address, &quot;$&quot;)(1)
End Function
代码解析：
GetColumn函数过程代码中，将参数iCol作为列号传递给Cells属性，并获取其绝对地址字串符，然后以“$”字符为分隔符，通过Split函数返回一个一维数组。 
Split函数返回一个下标从零开始的一维数组，它包含指定数目的子字符串，语法如下：
Split(expression[, delimiter[, limit[, compare]]])
其中参数expression是必需的，包含子字符串和分隔符的字符串表达式 。如果expression是一个长度为零的字符串(&quot;&quot;)，则返回一个空数组，即没有元素和数据的数组。
参数delimiter是可选的，用于标识子字符串边界的字符串字符。如果忽略，则使用空格字符(&quot; &quot;)作为分隔符。
返回一维数组后获取该数组的第2个元素（下标为1），即该列号的字符列标。
下面的代码使用GetColumn函数过程获得所选单元格的字符列标。 
Private Sub Worksheet_SelectionChange(ByVal Target As Range)
#002      MsgBox GetColumn(Selection.Column)
#003  End Sub
在工作表中选择单元格后结果如图 164 1所示。

图 164 1    返回列标字符串</code></pre>
<h3 id="技巧165-判断工作表是否为空表"><a href="#技巧165-判断工作表是否为空表" class="headerlink" title="技巧165     判断工作表是否为空表"></a>技巧165     判断工作表是否为空表</h3><p>VBA中没有专门的属性或函数可以判断工作表是否为空白工作表，可以使用自定义函数返回指定工作表是否为空工作表，如下面的代码所示。</p>
<pre><code class="vb">Function IsBlankSht(Sh As Variant) As Boolean
    If TypeName(Sh) = &quot;String&quot; Then Set Sh = Worksheets(Sh)
    If Application.CountA(Sh.UsedRange.Cells) = 0 Then
        IsBlankSht = True
    End If
End Function
代码解析：
自定义IsBlankSht函数包含一个Variant变量类型的参数，代表工作表名称或者对象名称。如果指定的工作表为空工作表，则该函数返回True。
第2行代码使用TypeName函数判断参数Sh是否为字符串类型（“String”），如果是字符串，则将以该字符串作为名称的工作表赋值给变量Sh。
第3行代码通过工作表函数CountA统计工作表已使用区域的非空单元格个数，如果统计结果为0，则表示该工作表为空工作表。</code></pre>
<p>现在就可以像使用VBA函数一样使用自定义的IsBlankSht函数，如下面的代码所示。</p>
<pre><code class="vb">Sub DelBlankSht()
    Dim Sh As Worksheet
    Application.DisplayAlerts = False
    For Each Sh In ThisWorkbook.Sheets
        If IsBlankSht(Sh) Then Sh.Delete
    Next
    Application.DisplayAlerts = True
End Sub
代码解析：
使用自定义的IsBlankSht函数删除工作簿中所有空工作表。
第3行代码将Application对象的DisplayAlerts属性设置为False，使删除时不显示系统警告对话框。
第4行到第6行代码，使用For Each...Next语句遍历所有工作表，使用自定义的IsBlankSht函数判断是否为空表，如果为空表则使用Delete方法删除。
注意 自定义IsBlankSht函数仅仅判断工作表单元格区域内容是否为空，如果工作表中存在其它对象（如图形对象、数据有效性、单元格批注等），还需要再进一步判断。</code></pre>
<h3 id="技巧166-查找指定工作表"><a href="#技巧166-查找指定工作表" class="headerlink" title="技巧166     查找指定工作表"></a>技巧166     查找指定工作表</h3><p>判断工作簿中是否存在指定名称的工作表，除了使用遍历工作簿中所有工作表的方法外，还可以使用自定义函数，如下面的代码所示。</p>
<pre><code class="vb">Function ExistSh(Sh As String) As Boolean
    Dim Sht As Object
    On Error Resume Next
    Set Sht = Sheets(Sh)
    If Err.Number = 0 Then ExistSh = True
    Set Sht = Nothing
End Function
代码解析：
自定义ExistSh函数包含一个String类型的参数，代表需要判断的工作表名称。如果该工作表存在，则返回True。
第5行代码判断前面的代码是否出错，如果前面的代码存在错误，则表示不存在指定名称的表。</code></pre>
<p>使用自定义ExistSheet函数判断工作簿中是否存在指定名称的工作表，如下面的代码所示。</p>
<pre><code class="vb">Sub NotSht()
    Dim Sh As String
    Sh = InputBox(&quot;请输入工作表名称：&quot;)
    If Len(Sh) &gt; 0 Then
        If Not ExistSh(Sh) Then
            MsgBox &quot;对不起,&quot; &amp; Sh &amp; &quot;表不存在!&quot;
        Else
            Sheets(Sh).Select
        End If
    End If
End Sub
代码解析：
NotSht过程使用自定义的ExistSh函数判断工作簿中是否存在指定名称的工作表，如果不存在则使用消息框进行提示，如图 166 1所示。

图 166 1    查找指定工作表</code></pre>
<h3 id="技巧167-查找指定工作簿是否打开"><a href="#技巧167-查找指定工作簿是否打开" class="headerlink" title="技巧167     查找指定工作簿是否打开"></a>技巧167     查找指定工作簿是否打开</h3><p>如果需要判断指定名称的工作簿是否已经打开，除了使用技巧43 的方法外，还可以使用与技巧166 类似的自定义函数，如下面的代码所示。</p>
<pre><code class="vb">Function ExistWorkbook(WbName As String) As Boolean
    Dim wb As Workbook
    On Error Resume Next
    Set wb = Workbooks(WbName)
    If Err.Number = 0 Then ExistWorkbook = True
    Set wb = Nothing
End Function
代码解析：
自定义ExistWorkbook函数判断指定名称的工作簿是否已经打开。
第5行代码判断前面的赋值语句是否存在错误。如果没有指定名称的工作簿，则第4行代码会产生错误，自定义ExistWorkbook函数返回False。
下面使用自定义ExistWorkbook函数判断名称为“Excel Home”的工作簿是否已经打开，如果没有打开则使用消息框进行提示，如图 167 1所示。</code></pre>
<pre><code class="vb">Sub NotWorkbook()
    If Not (ExistWorkbook(&quot;Excel Home&quot;)) Then MsgBox &quot;对不起,Excel Home工作簿没有打开!&quot;
End Sub

图 167 1    消息框提示</code></pre>
<h3 id="技巧168-取得应用程序的安装路径"><a href="#技巧168-取得应用程序的安装路径" class="headerlink" title="技巧168     取得应用程序的安装路径"></a>技巧168     取得应用程序的安装路径</h3><p>使用自定义函数取得应用程序的安装路径，如下面的代码所示。</p>
<pre><code class="vb">Function GetSetupPath(AppName As String)
    Dim WSH As Object
    Set WSH = CreateObject(&quot;Wscript.Shell&quot;)
    GetSetupPath = WSH.RegRead(&quot;HKEY_LOCAL_MACHINE\Software&quot; _
        &amp; &quot;\Microsoft\Windows\CurrentVersion\App Paths\&quot; _
        &amp; AppName &amp; &quot;\Path&quot;)
    Set WSH = Nothing
End Function
Sub WinRARPath()
    MsgBox GetSetupPath(&quot;WinRAR.exe&quot;)
End Sub
代码解析：
自定义GetSetupPath函数取得应用程序的安装路径，其中参数AppName代表指定的应用程序的名称。
第3行代码使用CreateObject函数将Wscript.Shell对象的引用赋给变量WSH。
CreateObject函数创建并返回一个对ActiveX 对象的引用，语法如下：
CreateObject(class,[servername])
参数class是必需的，Variant (String)，要创建的应用程序名称和类。
参数servername是可选的，Variant (String)，要在其上创建对象的网络服务器名称。如果servername是一个空字符串(&quot;&quot;)，即使用本地机器。
第4行代码取得AppName参数指定的应用程序在注册表中的路径。
WinRARPath过程使用消息框显示由自定义的GetSetupPath函数取得的应用程序“WinRAR”的安装路径。
运行WinRARPath过程结果如图 168 1所示。

图 168 1    应用程序安装路径</code></pre>
<h3 id="技巧169-数组的使用"><a href="#技巧169-数组的使用" class="headerlink" title="技巧169     数组的使用"></a>技巧169     数组的使用</h3><h4 id="169-1-代码运行时创建数组"><a href="#169-1-代码运行时创建数组" class="headerlink" title="169-1    代码运行时创建数组"></a>169-1    代码运行时创建数组</h4><p>使用Array函数可以在代码运行时创建数组并把一系列数据保存在数组中，示例代码如下：</p>
<pre><code class="vb">Option Base 1
Sub arr()
    Dim arr As Variant
    Dim i As Integer
    arr = Array(&quot;王晓明&quot;, &quot;吴胜玉&quot;, &quot;周志国&quot;, &quot;曹武伟&quot;, &quot;张新发&quot;, &quot;卓雪梅&quot;, &quot;沈煜婷&quot;, &quot;丁林平&quot;)
    For i = LBound(arr) To UBound(arr)
        Cells(i, 1) = arr(i)
    Next
End Sub
代码解析：
Arr过程使用Array函数创建一个数组用来保存数据并将其写入到工作表的单元格区域。
第1行代码使用Option Base语句声明数组下标的缺省下界为1，数组下标的缺省下界默认为0。
第5行代码使用Array函数创建数组用来保存数据。Array函数返回一个包含数组的Variant，语法如下：
Array(arglist)
Arglist参数是一个用逗号隔开的值表，这些值用于给Variant所包含的数组的各元素赋值。如果不提供Arglist参数，则创建一个长度为 0 的数组。
第6行代码使用LBound函数和UBound函数取得数组的最小和最大下标。
LBound函数返回一个Long型数据，其值为指定数组维可用的最小下标，语法如下：
LBound(arrayname[, dimension])
UBound函数返回一个Long型数据，其值为指定数组维可用的最大下标，语法如下：
UBound(arrayname[, dimension])
参数arrayname是必需的，数组变量的名称。
参数dimension是可选的，指定返回哪一维的下界，1表示第一维，2表示第二维，如此类推。默认为1。
UBound函数与LBound函数一起使用，可以用来确定数组的大小。
第7行代码确定数组的大小后使用For...Next语句遍历数组元素并将数组元素依次写入到工作表的A列单元格中，如图 169 1所示。

图 169 1    将数组元素写入工作表</code></pre>
<h4 id="169-2-文本转换为数组"><a href="#169-2-文本转换为数组" class="headerlink" title="169-2    文本转换为数组"></a>169-2    文本转换为数组</h4><p>在处理字符串时可以使用Split 函数将字符串按指定的分隔符分开并以数组返回，代码如下：</p>
<pre><code class="vb">Sub Splitarr()
    Dim Arr As Variant
    Arr = Split(Sheet2.Cells(1, 1), &quot;,&quot;)
    Sheet1.Cells(1, 1).Resize(UBound(Arr) + 1, 1) = Application.Transpose(Arr)
End Sub
代码解析：
Splitarr过程使用Split 函数将工作表Sheet2中A1单元格的姓名分别写入到工作表Sheet1中的A列单元格。
Split 函数返回一个下标从零开始的一维数组，包含指定数目的子字符串，语法如下：
Split(expression[, delimiter[, limit[, compare]]])
参数expression是必需的，包含子字符串和分隔符的字符串表达式。
参数delimiter是必需的，用来标识子字符串边界的字符串字符。如果忽略，则使用空格字符(&quot; &quot;)作为分隔符。
第4行代码，首先使用UBound函数取得返回数组的最大下标后调整单元格区域，因为数组下标的缺省下界默认为0，所以在使用Resize属性调整单元格区域时参数RowSize需要在返回数组的最大下标上加一。
然后使用工作表Transpose函数将返回数组转置后写入到工作表调整后的单元格区域中。
工作表Transpose函数返回转置单元格区域，即将一行单元格区域转置成一列单元格区域，反之亦然，语法如下：
TRANSPOSE(array)
参数array为需要进行转置的数组或工作表中的单元格区域。
Splitarr过程将如图 169 2所示的工作表单元格中的字符串以逗号分隔后依次写入到工作表的A列单元格中，如图 169 3所示。

图 169 2    工作表单元格中的字符串

图 169 3    文本转换为数组写入单元格</code></pre>
<h4 id="169-3-使用动态数组去除重复值"><a href="#169-3-使用动态数组去除重复值" class="headerlink" title="169-3    使用动态数组去除重复值"></a>169-3    使用动态数组去除重复值</h4><p>在技巧169-2中使用数组函数将单元格中的文本进行分隔后写入到工作表Sheet1中的A列单元格，但是如果文本中含有大量的重复值，在写入时也会将重复值写入到工作表中，此时可以使用动态数组去除文本中的重复值，如下面的代码所示。</p>
<pre><code class="vb">Sub Splitarr()
    Dim Splarr() As String
    Dim Arr() As String
    Dim Temp() As String
    Dim r As Integer
    Dim i As Integer
    On Error Resume Next
    Splarr = Split(Sheet2.Range(&quot;a1&quot;), &quot;,&quot;)
    For i = 0 To UBound(Splarr)
        Temp = Filter(Arr, Splarr(i))
        If UBound(Temp) &lt; 0 Then
            r = r + 1
            ReDim Preserve Arr(1 To r)
            Arr(r) = Splarr(i)
        End If
    Next
    Sheet1.Range(&quot;a1&quot;).Resize(r, 1) = Application.Transpose(Arr)
End Sub
代码解析：
Splitarr过程将工作表Sheet2中A1单元格的文本去除重复值后写入到工作表Sheet1中的A列单元格。
第2行代码声明数组Splarr用来保存Sheet2中A1单元格的文本。
第3行代码声明数组Arr用来保存去除重复值后的文本。
第4行代码声明数组Temp用来判断文本是否重复。
第5行代码声明变量r用来保存去除重复值后的文本数量。
第7行代码启动错误处理程序来忽略错误，因为在程序运行到第11行代码会发生下标越界错误。
第8行代码使用Split 函数以Sheet2中A1单元格的文本创建一个下标从零开始的一维数组。关于Split 函数请参阅技巧169-2。
第9行代码使用For...Next语句遍历数组Splarr的所有元素。
第10行代码使用Filter函数创建一个数组Temp用来保存以当前Splarr数组的值在Arr数组中的搜索结果。Filter函数返回一个下标从零开始的数组，该数组包含基于指定筛选条件的一个字符串数组的子集，语法如下：
Filter(sourcesrray, match[, include[, compare]])
参数sourcesrray是必需的，要执行搜索的一维字符串数组。
参数match是必需的，要搜索的字符串。
参数include是可选的，Boolean值，表示返回子串是否包含match字符串。如果参数include是True，Filter函数返回的是包含match参数子字符串的数组子集。如果参数include是False，Filter函数返回的是不包含match参数子字符串的数组子集。
参数compare是可选的，所使用的字符串比较类型。
第11行代码根据返回的数组Temp的最大下标来判断当前Splarr数组的值是否重复。在使用使用Filter函数时如果没有相匹配的值，将返回一个空数组，最大下标小于0。
第12行代码如果当前Splarr数组的值不重复则将变量r的值加1。
第13行代码重新定义动态数组大小。ReDim语句，在过程级别中使用，用于为动态数组变量重新分配存储空间，语法如下：
ReDim [Preserve] varname(subscripts) [As type] [, varname(subscripts) [As type]]
参数Preserve是可选的，关键字，当改变原有数组最末维的大小时，使用此关键字可以保持数组中原来的数据。
参数varname是必需的，变量的名称。
参数subscripts是必需的，数组变量的维数，最多可以定义 60 维的多维数组，使用下面的语法；
[lower To] upper [,[lower To] upper]
第14行代码将不重复值添加到数组Arr中。
第15行代码使用工作表Transpose函数将去除重复值的的文本转置后写入到工作表的A列单元格中。
如果需要将去除重复值的的文本写入到第一行单元格中，可以将第15行代码改成下面的代码：
Sheet1.Range(&quot;a1&quot;).Resize(1, r) = Arr
如果需要将去除重复值的的文本还是以逗号作为分隔符写入到A1单元格中，可以将第15行代码改成下面的代码：
Sheet1.Range(&quot;a1&quot;) = Join(Arr, &quot;,&quot;)
Join函数返回一个字符串，该字符串是通过连接某个数组中的多个子字符串而创建的，语法如下：
Join(sourcearray[, delimiter])
参数sourcearray是必需的，包含被连接子字符串的一维数组。
参数delimiter是可选的，在返回字符串中用于分隔子字符串的字符，如果忽略则使用空格(&quot; &quot;)来分隔子字符串。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/31/VBA常用技巧9--函数的使用/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧8--控件与用户窗体" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/29/VBA常用技巧8--控件与用户窗体/">VBA常用技巧8--控件与用户窗体</a>
    </h1>
  

        
        <a href="/2018/05/29/VBA常用技巧8--控件与用户窗体/" class="archive-article-date">
  	<time datetime="2018-05-28T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-29</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第8章-控件与用户窗体"><a href="#第8章-控件与用户窗体" class="headerlink" title="第8章     控件与用户窗体"></a>第8章     控件与用户窗体</h2><h3 id="技巧98-限制文本框的输入"><a href="#技巧98-限制文本框的输入" class="headerlink" title="技巧98     限制文本框的输入"></a>技巧98     限制文本框的输入</h3><p>用户在使用文本框输入数据时，往往希望能限制输入数据的类型，比如只能输入数字。但是没有内置的属性能限制在文本框中只能输入数字，只能在文本框的事件过程中使用代码来测试输入的是哪类字符，然后只允许输入数字字符和一个“-”号、一个“.”号，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_KeyPress(ByVal KeyANSI As MSForms.ReturnInteger)
    Select Case KeyANSI
     Case Asc(&quot;0&quot;) To Asc(&quot;9&quot;)
        Case Asc(&quot;-&quot;)
            If InStr(1, Me.TextBox1.Text, &quot;-&quot;) &gt; 0 Or _
                Me.TextBox1.SelStart &gt; 0 Then
                KeyANSI = 0
            End If
        Case Asc(&quot;.&quot;)
            If InStr(1, Me.TextBox1.Text, &quot;.&quot;) &gt; 0 Then
                KeyANSI = 0
            End If
        Case Else
            KeyANSI = 0
    End Select
End Sub
代码解析：
文本框的KeyPress事件过程，测试键盘输入的是哪类字符，只允许输入数字字符和一个“-”号、一个“.”号。
KeyPress事件的语法如下：
Private Sub object_KeyPress( ByVal KeyANSI As MSForms.ReturnInteger)
参数Object是必需的，一个有效的对象。
参数KeyANSI是可选的，整数值，代表标准的数字ANSI 键代码。
第2行代码使用Case Else语句测试文本框KeyPress事件的KeyANSI参数值。
第3行代码，如果键盘输入的是0到9之间的数字字符，则允许输入。如果想在文本框中允许其它类型的字符输入，在此句代码中列出允许输入的字符即可。
第4行到第8行代码，如果键盘输入的是“-”号，先使用InStr函数测试文本框中是否已有“-”号，如果InStr函数返回值大于0，说明文本框中已有“-”号。接下来使用文本框的SelStart 属性来测试插入点，如果文本框的SelStart 属性值大于0，说明“-”号的插入点不是第一个。如果以上两个条件中有任何一个成立，将KeyAscii参数值设置为0，使文本框只能在第一位输入一个“-”号。
第9行到第12行代码，如果键盘输入的是“.”号的话，使用InStr函数测试文本框中是否已有“.”号，如果已有“.”号，将KeyAscii参数值设置为0，使文本框只能输入一个“.”号。
第13、14行代码，如果键盘输入的是其他字符则将KeyAscii参数值设置为0，使文本框不能输入其他字符。</code></pre>
<p>经过以上设置文本框只允许输入数字字符和一个“-”号、一个“.”号，但是能输入中文字符。如果希望限制中文字符的输入，可以在文本框的Change事件中进行设置，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_Change()
    Dim i As Integer
    Dim s As String
    With TextBox1
        For i = 1 To Len(.Text)
            s = Mid(.Text, i, 1)
            Select Case s
                Case &quot;.&quot;, &quot;-&quot;, &quot;0&quot; To &quot;9&quot;
                Case Else
                    .Text = Replace(.Text, s, &quot;&quot;)
            End Select
        Next
    End With
End Sub
代码解析：
文本框的Change事件，判断输入的字符是否为数字字符和“-”号、“.”号，如果不是则使用Replace函数将文本框中输入的其他字符替换成空白。
第5、6行代码在文本框输入的所有字符中循环。
第8行代码列出允许输入的字符。如果想在文本框中允许其它字符输入，在此句代码中列出即可。
第9、10行代码，如果不是允许输入的字符，使用Replace函数替换成空白。
经过以上的设置，文本框中只能在第一位输入一个“-”号、一个“.”号和“0”到“9”的数字。</code></pre>
<h3 id="技巧99-文本框添加右键快捷菜单"><a href="#技巧99-文本框添加右键快捷菜单" class="headerlink" title="技巧99     文本框添加右键快捷菜单"></a>技巧99     文本框添加右键快捷菜单</h3><p>VBA中的控件没有提供右键快捷菜单，用户可以使用Excel 中的命令栏自已添加右键快捷菜单。<br>步骤1：按&lt;Alt+F11&gt;组合键进入VBE窗口，单击菜单“插入”→“模块”，在其代码窗口输入以下代码：</p>
<pre><code class="vb">Private ActiveTB As MSForms.TextBox
Public Sub CreateShortCutMenu()
    Dim ShortCutMenu As CommandBar
    Dim ShortCutMenuItem As CommandBarButton
    Dim sCaption As Variant
    Dim iFaceId As Variant
    Dim sAction As Variant
    Dim i As Integer
    sCaption = Array(&quot;剪切(&amp;C)&quot;, &quot;复制(&amp;T)&quot;, &quot;贴粘(&amp;P)&quot;, &quot;删除(&amp;D)&quot;)
    iFaceId = Array(21, 19, 22, 1786)
    sAction = Array(&quot;Action_Cut&quot;, &quot;Action_Copy&quot;, &quot;Action_Paste&quot;, &quot;Action_Delete&quot;)
    On Error Resume Next
    Application.CommandBars(&quot;ShortCut&quot;).Delete
    Set ShortCutMenu = Application.CommandBars.Add(&quot;ShortCut&quot;, msoBarPopup)
    With ShortCutMenu
        For i = 0 To 3
            Set ShortCutMenuItem = .Controls.Add(msoControlButton)
            With ShortCutMenuItem
                .Caption = sCaption(i)
                .faceID = Val(iFaceId(i))
                .OnAction = sAction(i)
            End With
        Next
    End With
End Sub
代码解析：
第1行代码，在模块级别中声明变量ActiveTB是用来对应窗体中的文本框所触发的所有事件的变量。
CreateShortCutMenu过程用来创建标题为“ShortCut”的右键快捷菜单，并添加4个菜单项。关于自定义右键快捷菜单请参阅技巧86 。</code></pre>
<pre><code class="vb">Public Sub ShowPopupMenu(txtCtr As MSForms.TextBox)
    Dim Action As Variant
    Set ActiveTB = txtCtr
    With Application.CommandBars(&quot;ShortCut&quot;)
        .Controls(1).Enabled = txtCtr.SelLength &gt; 0
        .Controls(2).Enabled = .Controls(1).Enabled
                .Controls(3).Enabled = txtCtr.CanPaste
        .Controls(4).Enabled = .Controls(1).Enabled
        .ShowPopup
    End With
End Sub
代码解析：
ShowPopupMenu过程根据文本框中字符的选中状态设置右键快捷菜单菜单项的Enabled属性后使用ShowPopup方法显示右键快捷菜单。
第5行代码，如果当前文本框中已有选中的字符则“剪切”按钮有效。
第6行代码，如果当前文本框中已有选中的字符则“复制”按钮有效。
第7行代码，如果剪贴板中包含对象支持的数据。则“贴粘”按钮有效。
第8行代码，如果当前文本框中已有选中的字符则“删除”按钮有效。
第9行代码，显示快捷菜单。</code></pre>
<pre><code class="vb">Public Sub Action_Cut()
    ActiveTB.Cut
End Sub
Public Sub Action_Copy()
    ActiveTB.Copy
End Sub
Public Sub Action_Paste()
    ActiveTB.Paste
End Sub
Public Sub Action_Delete()
    Dim s As String
    With ActiveTB
        s = .SelText
        .Value = Replace(.Value, s, &quot;&quot;)
    End With
End Sub
代码解析：
Action_Cut过程是快捷菜单中单击“剪切”菜单项所运行的过程。使用Cut 方法将当前选中的文本框中的文本删除并移至剪贴板。
Action_Copy过程是快捷菜单中单击“复制”菜单项所运行的过程。使用Copy方法将文本框选中的文本复制到剪贴板上。
Action_Paste过程是快捷菜单中单击“贴粘”菜单项所运行的过程。使用Paste方法把剪贴板上的内容传送到一个文本框中。
Action_Delete过程是快捷菜单中单击“贴粘”菜单项所运行的过程。使用Replace函数将文本框中选中的文本的文本替换成空字符。</code></pre>
<pre><code class="vb">Public Sub DeleteShortCutMenu()
    On Error Resume Next
    Application.CommandBars(&quot;ShortCut&quot;).Delete
End Sub
代码解析：
DeleteShortCutMenu过程删除创建的右键快捷菜单。
步骤2：在VBE窗口中，单击菜单“插入”→“用户窗体”，在窗体上添加两个文本框控件。双击窗体，在其代码窗口中输入下面的代码。</code></pre>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Call CreateShortCutMenu
End Sub
Private Sub TextBox1_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    If Button = 2 Then ShowPopupMenu ActiveControl
End Sub
Private Sub TextBox2_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    If Button = 2 Then ShowPopupMenu ActiveControl
End Sub
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    Call DeleteShortCutMenu
End Sub
代码解析：
第1行到第3行代码，窗体的Initialize事件，在窗体初始化时运行CreateShortCutMenu过程创建右键快捷菜单。
第4行到第9行代码，文本框的MouseUp事件，当用户右健单击文本框时运行ShowPopupMenu过程在选中的菜单项上显示右键快捷菜单。
第10行到第12行代码，窗体的QueryClose事件，在关闭窗体时运行DeleteShortCutMenu过程删除右键快捷菜单。
窗体运行后，右键单击文本框显示右键快捷菜单，如图 99 1所示。</code></pre>
<h3 id="技巧100-文本框回车自动输入"><a href="#技巧100-文本框回车自动输入" class="headerlink" title="技巧100     文本框回车自动输入"></a>技巧100     文本框回车自动输入</h3><p>在使用文本框向工作表输入数据时，为了加快输入速度，可以利用文本框的KeyDown事件，回车后自动输入并清空文本框，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    With TextBox1
        If Len(Trim(.Value)) &gt; 0 Then
            If KeyCode = vbKeyReturn Then
                Sheet1.Range(&quot;A65536&quot;).End(xlUp).Offset(1, 0) = .Value
                .Text = &quot;&quot;
            End If
        End If
    End With
End Sub
代码解析：
文本框的KeyDown事件，在输入数据并按&lt;Enter&gt;键后自动将数据录入到工作表A列最后一个非空单元格的下一个单元格中。
KeyDown事件在按下键盘按键时发生，语法如下：
Private Sub object_KeyDown( ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As fmShiftState)
参数object是必需的，一个有效的对象。
参数KeyCode是必需的，代表被按下的键的键代码。
参数Shift是可选的，Shift、Ctrl 和Alt的状态。
第3行代码，为了防止误输入空白数据，使用Len 函数和Trim 函数检查文本框内是否为有效数据。
第4行代码，根据KeyCode参数值判断是否按下了回车键。如果用户按下了回车键，KeyCode参数返回常数vbKeyReturn。
第5、6行代码，将文本框数据输入到工作表A列的最后一个单元格内，同时清空文本框内容准备下一次输入。</code></pre>
<h3 id="技巧101-自动选择文本框内容"><a href="#技巧101-自动选择文本框内容" class="headerlink" title="技巧101     自动选择文本框内容"></a>技巧101     自动选择文本框内容</h3><p>如果希望光标进入文本框时能自动选择文本框内容，可以在文本框的MouseUp事件中来完成，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_MouseUp(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    With TextBox1
        If Button = 2 Then
            .SelStart = 0
            .SelLength = Len(.Text)
        End If
    End With
End Sub
代码解析：
文本框的MouseUp事件，在光标进入文本框释放鼠标右键时自动选择文本框内容。
MouseUp事件在用户释放鼠标按键时发生，语法如下：
Private Sub object_MouseUp( ByVal Button As fmButton, ByVal Shift As fmShiftState, ByVal X As Single, ByVal Y As Single)
参数object是必需的，一个有效的对象。
参数Button是可选的，设置引起该事件的鼠标按键的整数值，如表格 101 1所示。
常数    值    说明
fmButtonLeft    1    按下左键。
fmButtonRight    2    按下右键。
fmButtonMiddle    3    按下中键。
表格 101 1    Button参数值
参数Shift是可选的，Shift、Ctrl 和Alt的状态。
参数X和参数Y是可选的，窗体、框架或页的位置的横坐标与纵坐标。
第3行到第6行代码，如果用户进入文本框释放鼠标右键，设置文本框的SelStart 属性为0，SelLength属性为文本框的全部字符数。
SelStart 属性指定选中文本的起点，语法如下：
object.SelStart [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，指定选中文本的起点。
SelLength 属性指定文本框或组合框的文本部分中选中的字符数，语法如下：
object.SelLength [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，指定选中的字符数。
运行窗体，当光标进入文本框释放鼠标右键时自动选择文本框内容，如图 101 1所示。</code></pre>
<h3 id="技巧102-设置文本框数据格式"><a href="#技巧102-设置文本框数据格式" class="headerlink" title="技巧102     设置文本框数据格式"></a>技巧102     设置文本框数据格式</h3><p>文本框在用来输入数据时，除了限制输入的数据类型外，还可以设置文本框的数据格式，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    TextBox1 = Format(TextBox1, &quot;0.00&quot;)
End Sub
Private Sub TextBox2_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    TextBox2 = Format(TextBox2, &quot;0.00&quot;)
End Sub
代码解析：
文本框的Exit事件过程，在文本框输入数据时使用Format函数格式化为两位小数格式。
控件的Exit事件在同一窗体中的一个控件即将把焦点转移到另一个控件之前发生，语法如下：
Private Sub object_Exit( ByVal Cancel As MSForms.ReturnBoolean)
参数Object是必需的，一个有效的对象。
参数Cancel是必需的，事件状态。如果设置为False表示由该控件处理这个事件（默认方式）。设置为True表示由应用程序处理这个事件，并且焦点留在当前控件上。
当文本框在输入完数据失去焦点时使用Format函数格式化自定义数值格式。Format函数语法如下：
Format(expression[, format[, firstdayofweek[, firstweekofyear]]])
参数expression是必需的，任何有效的表达式。
参数format是可选的，有效的命名表达式或用户自定义格式表达式。
参数firstdayofweek是可选的，常数，表示一星期的第一天。
参数firstweekofyear是可选的，常数，表示一年的第一周。
在本例中，将文本框的数据格式化成自定义的两位小数的数值格式，关于Format函数格式化日期和时间等其他数据请参阅VBA中Format函数的帮助。</code></pre>
<pre><code class="vb">Private Sub TextBox1_Change()
    TextBox3 = Format(Val(TextBox1) * Val(TextBox2), &quot;0.00&quot;)
End Sub
Private Sub TextBox2_Change()
    TextBox3 = Format(Val(TextBox1) * Val(TextBox2), &quot;0.00&quot;)
End Sub
代码解析：
文本框的Change事件过程，在两个文本框输入完数据后，使用文本框的Change事件使TextBox3显示其相乘的金额并格式化为两位小数的数据格式。
Change事件在控件的 Value 属性改变时发生，语法如下：
Private Sub object_Change( )
参数object是必需的，一个有效的对象。
Change事件过程可以使显示在控件上的数据同步或一致。在本例中，当TextBox1或TextBox2的数据发生改变时，两者相乘的金额的金额也随之改变并在TextBox3中显示。
因为文本框的数据类型是文本字符串，不能直接进行计算的，所以计算前先使用Val函数转换为数字，才能进行计算。
运行窗体，输入数据后格式化为两位小数的数据格式，如图 102 1所示。

图 102 1    设置文本框的数据格式</code></pre>
<h3 id="技巧103-限制文本框的输入长度"><a href="#技巧103-限制文本框的输入长度" class="headerlink" title="技巧103     限制文本框的输入长度"></a>技巧103     限制文本框的输入长度</h3><p>在使用文本框输入数据时，可能希望限制能输入的字符长度，即只能输入一定长度的字符，超过设置数值就不能输入，这时可以通过设置文本框的MaxLength属性来实现，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Worksheet_Activate()
    Me.TextBox1.MaxLength = 6
End Sub
代码解析：
工作表的激活事件过程，将文本框的MaxLength属性设置为6，使文本框只能输入6个字符，超过6个字符即不能输入。
应用于文本框控件的MaxLength属性规定用户可以在文本框中输入的最多字符数，语法如下：
object.MaxLength [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，整数，表示所允许的字符数。
如果将MaxLength属性设置为0，表示只要内存允许则没有限制。</code></pre>
<h3 id="技巧104-将光标返回文本框中"><a href="#技巧104-将光标返回文本框中" class="headerlink" title="技巧104     将光标返回文本框中"></a>技巧104     将光标返回文本框中</h3><p>在用文本框往工作表录入数据时，一般会在录入到工作表前验证输入的数据是否正确，如果错误，则清空文本框内容，提示用户重新输入。但此时光标已经不在文本框中，需要重新选择文本框才能输入。<br>可以在Exit事件中可以设置Cancel参数值使光标停留在当前文本框中，如下面的代码所示。</p>
<pre><code class="vb">Private Sub TextBox1_Exit(ByVal Cancel As MSForms.ReturnBoolean)
    With TextBox1
        If .Text &lt;&gt; &quot;&quot; And Len(Trim(.Text)) &lt;&gt; 15 And Len(Trim(.Text)) &lt;&gt; 18 Then
            .Text = &quot;&quot;
            MsgBox &quot;身份证号码录入错误!&quot;
            Cancel = True
        End If
    End With
End Sub
代码解析：
文本框的Exit事件，在输入身份证号码后即将把焦点转移到录入按钮控件之前检查输入的身份证号码是否正确。
Exit事件在一个控件从同一窗体的另一个控件实际接收到焦点之前发生,语法如下:
Private Sub object_Exit( ByVal Cancel As MSForms.ReturnBoolean)
Cancel参数为事件状态。False表示由该控件处理这个事件（这是默认方式）。True表示由应用程序处理这个事件，并且焦点应当留在当前控件上。
第3行代码，使用Len函数和Trim函数检查输入的身份证号码是否为15位或18位。
第4行到第6行代码，如果输入的身份证号码不正确，清空文本框以便重新输入并提示用户，设置Cancel参数为True使光标停留在文本框中。
在Exit事件中之所以把文本框为空也做为通过验证的条件之一，因为如果不加上“TextBox1.Text &lt;&gt; &quot;&quot;”这一条件，那么在窗体显示后，如果用户取消输入或关闭输入窗体，也会提示输入错误。所以在录入到工作表之前再验证文本框是否为空，如下面的代码所示。</code></pre>
<pre><code class="vb">Private Sub CommandButton1_Click()
    With TextBox1
        If .Text &lt;&gt; &quot;&quot; Then
            Sheet1.Range(&quot;a65536&quot;).End(xlUp).Offset(1, 0) = .Text
            .Text = &quot;&quot;
        Else
            MsgBox &quot;请输入身份证号码!&quot;
        End If
            .SetFocus
    End With
End Sub
代码解析：
输入按钮的Click事件，把文本框数据录入到工作表A列最后一个单元格中并重新选择文本框准备下一次输入。
第3行代码，在输入到工作表前检查文本框是否为空。
第4、5行代码，如果文本框不为空，录入数据到工作表并清空文本框内容。
第7行代码，如果文本框为空，提示用户输入数据。
第8行代码，使用SetFocus方法将光标返回到文本框中以便重新输入。
SetFocus方法将焦点移动到对象的实例中，语法如下 ：
object.SetFocus
参数object.是必需的，一个有效的对象。
运行窗体，在输入框中输入身份证号码后自动验证输入的数据，如果输入数据错误，清空文本框并提示用户重新输入，如图 104 1所示。

图 104 1    提示用户重新输入</code></pre>
<h3 id="技巧105-文本框的自动换行"><a href="#技巧105-文本框的自动换行" class="headerlink" title="技巧105     文本框的自动换行"></a>技巧105     文本框的自动换行</h3><p>在使用使用文本框显示或录入一段很长的文本时，需要将文本框设置成多行显示，否则文本内容只能在一行中显示，示例代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    With TextBox1
        .WordWrap = True
        .MultiLine = True
        .Text = Space(4) &amp; &quot;VBA(Visual Basic for Application)是&quot; _
                &amp; &quot;微软公司为了加强Office软件的二次开发能力而附加&quot; _
                &amp; &quot;于其中的编程语言。VBA的确非常强大，其与VB完全一&quot; _
                &amp; &quot;致的语法结构，高效控制Office对象模型的能力，令无&quot; _
                &amp; &quot;数人为之折腰。利用VBA，几乎可以在Office里面做任何&quot; _
                &amp; &quot;其他程序能做的事情。但是，应该清楚的认识到VBA是依&quot; _
                &amp; &quot;托其宿主─—Excel（或其他Office组件）而存在的，对&quot; _
                &amp; &quot;于Excel用户来讲，VBA只不过是锦上添花的东西，切不可&quot; _
                &amp; &quot;本末倒置，捡了芝麻丢了西瓜，把明明能够利用Excel内置&quot; _
                &amp; &quot;功能完成的任务，硬是搬到VBA里面去做，以为用代码实现&quot; _
                &amp; &quot;就是高人一头的表现。其实，真正的高手，会尽量发挥&quot; _
                &amp; &quot;Excel自身的威力，不到万不得已的时候是不会去&lt;Alt+F11&gt;的。&quot;
    End With
End Sub
代码解析：
窗体的Initialize事件过程，在窗体显示时将文本框设置成多行显示文本。
第3行代码设置文本框的WordWrap属性。WordWrap属性指定一个控件的内容在行末是否自动换行，语法如下：
object.WordWrap [= Boolean]
参数object是必需的，一个有效的对象。
参数Boolean是可选的，控件是否扩展以适应文本的大小，设置为True，文本换行，设置为False，文本不换行。
第4行代码设置文本框的MultiLine属性。MultiLine属性规定控件能否接受和显示多行文本，语法如下：
object.MultiLine [= Boolean]
参数object是必需的，一个有效的对象。
参数Boolean是可选的，控件是否支持多行文本，设置为True，以多行显示文本，设置为False，不多行显示文本。如果将多行文本框的MultiLine属性设置为False，则文本框的所有字符都将合并为一行，包括非打印字符（如，回车和换行）。
对于既支持WordWrap属性又支持MultiLine属性的控件，当MultiLine属性为False时，WordWrap属性被忽略。
运行窗体，文本框显示如图 105 1所示。

图 105 1    文本框自动换行</code></pre>
<h3 id="技巧106-多个文本框数据相加"><a href="#技巧106-多个文本框数据相加" class="headerlink" title="技巧106     多个文本框数据相加"></a>技巧106     多个文本框数据相加</h3><p>在技巧102 中，我们在TextBox1、TextBox2中输入完数据后，利用文本框的Change事件使TextBox3显示其两者相乘的金额，但是如果窗体中有多个文本框，需要在每一个文本框的Change事件中写上相同的重复代码，因此使用类模块可以简化代码。<br>在附件的窗体有七个文本框，其中六个用来输入数据，一个用来显示其他六个文本框相加后的合计数，首先打开VBE，插入一个类模块建立一个类，类模块的名字就是类的名字修改为“cmds”，在类模块中输入下面的代码：<br>Public WithEvents cmd As MSForms.TextBox<br>代码解析：<br>使用Public语句声明变量cmd是用来响应由TextBox对象触发的事件的对象变量。<br>在窗体的Initialize事件中写入下面的代码：</p>
<pre><code class="vb">Dim col As New Collection
Private Sub UserForm_Initialize()
    Dim i As Integer
    Dim myc As cmds
    For i = 1 To 6
        Set myc = New cmds
        Set myc.cmd = Me.Controls(&quot;TextBox&quot; &amp; i)
        col.Add myc
    Next
    Set myc = Nothing
End Sub
代码解析：
第1行代码在模块顶部声明变量col的类型为集合。
第5行到第9行代码，将窗体中的六个文本框赋给col集合。
（关于类模块请参阅论坛中有关的资料。）</code></pre>
<p>在类模块中写入下面的代码：</p>
<pre><code class="vb">Private Sub cmd_Change()
    Dim i As Integer
    Dim Dval As Double
    For i = 1 To 6
        Dval = Dval + Val(UserForm1.Controls(&quot;TextBox&quot; &amp; i))
        UserForm1.TextBox7.Value = Dval
    Next
End Sub
代码解析：
窗体中的六个文本框统一的Change事件，当任何一个文本框中的数据发生变化时，所有文本框相加的合计数显示在最后一个文本框中。
运行窗体在文本框中输入数据结果如图 106 1所示。

图 106 1    多个文本框数据相加</code></pre>
<h3 id="技巧107-控件跟随活动单元格"><a href="#技巧107-控件跟随活动单元格" class="headerlink" title="技巧107     控件跟随活动单元格"></a>技巧107     控件跟随活动单元格</h3><p>在工作表中使用控件时一般都把控件放在工作表的上部，如果工作表中数据较多，当页面滚动到工作表下面的区域时，控件会离开当前可视区域，这时操作起来很不方便。解决方法除了冻结工作表的第一行放置控件的外，还可以使控件出现在选定的单元格位置，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    With Me.CommandButton1
        .Top = Target.Top
        .Left = Target.Left + Target.Width
    End With
End Sub
代码解析：
工作表的SelectionChange事件，使工作表中的按钮控件出现在选定单元格的右边。
第3行代码，设置按钮的Top属性等于选定单元格的Top属性。Top属性设置对象顶端到第一行顶端的距离。
第4行代码，设置按钮的Left属性等于选定单元格的Left属性加上选定单元格的宽度，即按钮出现在选定单元格的右边。Left属性设置对象左边界至 A 列左边界的距离。
当单击工作表区域的任一单元格，按钮出现在单元格的右边，如图 107 1所示。

图 107 1    控件跟随活动单元格</code></pre>
<h3 id="技巧108-高亮显示按钮"><a href="#技巧108-高亮显示按钮" class="headerlink" title="技巧108     高亮显示按钮"></a>技巧108     高亮显示按钮</h3><p>为了达到当鼠标掠过按钮时以高亮和凸起显示按钮的效果，可以在窗体和按钮的MouseMove事件中进行模拟，如下面的代码所示。</p>
<pre><code class="vb">#001  Private Sub CommandButton1_MouseMove(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    With Me.CommandButton1
        .BackColor = &amp;HFFFF00
        .Width = 62
        .Height = 62
        .Top = 69
        .Left = 31
    End With
End Sub
Private Sub UserForm_MouseMove(ByVal Button As Integer, ByVal Shift As Integer, ByVal X As Single, ByVal Y As Single)
    With Me.CommandButton1
        .BackColor = Me.BackColor
        .Width = 60
        .Height = 60
        .Top = 70
        .Left = 32
    End With
End Sub
代码解析：
窗体和按钮的MouseMove事件过程，以高亮和凸起显示按钮。
当用户在窗体中移动鼠标时，分别在窗体和按钮的MouseMove事件设置按钮的BackColor属性值，指定按钮的背景色，当鼠标移动到按钮时以高亮显示，当鼠标移动到窗体时恢复原来的设置。接下来分别设置按钮不同的Width属性、Height属性、Top属性和Left属性值，以模拟按钮凸起的效果。
运行窗体，当鼠标掠过按钮时效果如图 108 1所示。

图 108 1    高亮和凸起显示按钮</code></pre>
<h3 id="技巧109-组合框和列表框添加列表项的方法"><a href="#技巧109-组合框和列表框添加列表项的方法" class="headerlink" title="技巧109     组合框和列表框添加列表项的方法"></a>技巧109     组合框和列表框添加列表项的方法</h3><p>组合框和列表框是Excel中最常用的控件，可以用来显示工作表中的数据。为组合框和列表框添加列表项的方法有多种，下面以列表框为例演示添加列表项的方法。</p>
<h4 id="109-1-使用RowSource属性添加列表项"><a href="#109-1-使用RowSource属性添加列表项" class="headerlink" title="109-1    使用RowSource属性添加列表项"></a>109-1    使用RowSource属性添加列表项</h4><p>使用RowSource属性将列表框直接与工作表上的一个单元格区域相链接，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim iRow As Integer
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    Me.ListBox1.RowSource = &quot;sheet1!a1:a&quot; &amp; iRow
End Sub
代码解析：
在窗体初始化时使用RowSource属性为列表框添加列表项。
RowSource属性的语法如下：
object.RowSource [= String]
参数object是必需的，一个有效的对象。
参数String是可选的，组合框或列表框列表的来源。
RowSource属性也可以使用单元格地址，第4行代码可以改成下面的代码：
Me.ListBox1.RowSource = Sheet1.Range(&quot;A1:A&quot; &amp; iRow).Address(External:=True)
需要注意的是，如果RowSource属性指定的工作表区域不是活动工作表的话，Address属性的External参数是不可缺的，设置为True表示是外部引用，如果缺省此参数或为False，将不能为列表框添加列表项。
RowSource属性还可以使用命名的单元格区域，如果已把工作表区域命名为“城市”，第4行代码可以改成下面的代码：
Me.ListBox1.RowSource = &quot;城市&quot;</code></pre>
<p>对于工作表中的列表框控件或使用窗体添加的列表框控件不能使用RowSource属性，需要使用ListFillRange属性指定填充列表框的工作表区域，如下面的代码所示。</p>
<pre><code class="vb">Sub ListFillRange()
    Dim iRow As Integer
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    Sheet2.ListBox1.ListFillRange = &quot;Sheet1!a1:a&quot; &amp; iRow
    Sheet2.Shapes(&quot;列表框&quot;).ControlFormat.ListFillRange = &quot;Sheet1!a1:a&quot; &amp; iRow
End Sub
代码解析：
ListFillRange过程为工作表中的列表框的填充区域，ListFillRange属性用于指定填充列表框的工作表区域。
第4行代码对于使用窗体添加的列表框控件需要使用ControlFormat属性来返回窗体控件以后才能设置其ListFillRange属性。
109-2    使用List属性添加列表项</code></pre>
<p>使用List属性为列表框添加列表项，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Arr As Variant
    Dim iRow As Integer
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    Arr = Sheet1.Range(&quot;A1:A&quot; &amp; iRow)
    Me.ListBox1.List = Arr
End Sub
代码解析：
在窗体初始化时使用List属性为列表框添加列表项。</code></pre>
<p>List属性的语法如下：<br>object.List( row, column ) [= Variant]<br>参数object是必需的，一个有效对象。<br>参数row是必需的，取值范围为 0 到列表条目数减 1 之间的数值。<br>参数column是必需的，取值范围为 0 到总列数减 1 之间的数值。<br>参数Variant是可选的，列表框中指定条目的内容。<br>第6行代码，使用List属性把数组复制到列表框控件上。<br>除了使用数组外，List属性还可以使用命名的单元格区域，如果已把工作表区域命名为“城市”，可以改成下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Me.ComboBox1.List = Range(&quot;城市&quot;).Value
End Sub</code></pre>
<p>对于工作表中使用窗体添加的列表框控件使用List属性添加列表项，如下面的代码所示。</p>
<pre><code class="vb">Sub List()
    Dim Arr As Variant
    Dim iRow As Integer
    Dim myObj As Object
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    Arr = Sheet1.Range(&quot;A1:A&quot; &amp; iRow)
    Set myObj = Sheet2.Shapes(&quot;列表框&quot;).ControlFormat
    myObj.List = Arr
End Sub
代码解析：
List过程设置列表框的List性，用于指定填充列表框的工作表区域。
109-3    使用AddItem方法添加列表项</code></pre>
<p>使用AddItem方法添加列表项，对于单列的列表框，在列表中添加一项。对于多列的列表框，在列表中添加一行，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim iRow As Integer
    Dim i As Integer
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    For i = 1 To iRow
        Me.ListBox1.AddItem (Sheet1.Cells(i, 1))
    Next
End Sub
代码解析：
在窗体初始化时使用AddItem方法为列表框添加列表项。
AddItem方法的语法如下：
object.AddItem [ item [, varIndex]]
参数object是必需的，一个有效的对象。
参数item是可选的，指定要添加的项或行。第一个项或行的编号为 0；第二个项或行的编号为 1，依此类推。
参数varIndex是可选的，指定新的项或行在对象中的位置。
如果提供一个有效的varIndex的值，AddItem方法就把项或行放在列表中的那个位置。如果忽略 varIndex，此方法就把项或行添加在列表的末尾。对于多列列表框或者组合框，AddItem 方法插入一个完整的行，为控件的每一列都插入一项。为了给第一列后面的项赋值，可用List或Column属性来规定项的行和列。</code></pre>
<p>对于工作表中使用窗体添加的列表框控件使用AddItem方法添加列表项，如下面的代码所示。</p>
<pre><code class="vb">Sub AddItem()
    Dim iRow As Integer
    Dim i As Integer
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    With Sheet2.Shapes(&quot;列表框&quot;).ControlFormat
        .RemoveAllItems
        For i = 1 To iRow
            .AddItem Sheet1.Cells(i, 1)
        Next
    End With
End Sub
代码解析：
AddItem过程设置使用AddItem方法添加为工作表中使用窗体控件添加的列表框添加列表项。
其中第5行代码使用ControlFormat属性来返回窗体控件，第6行代码使用RemoveAllItems方法删除窗体控件中的列表框的所有数据项，如果控件是ActiveX 列表框则需要使用Clear方法。</code></pre>
<h3 id="技巧110-去除列表框数据源的重复值和空格"><a href="#技巧110-去除列表框数据源的重复值和空格" class="headerlink" title="技巧110     去除列表框数据源的重复值和空格"></a>技巧110     去除列表框数据源的重复值和空格</h3><p>列表框的数据源引用工作表的数据时，如果工作表数据有重复值和空格，列表框也会出现重复值和空格，如图 110 1所示。</p>
<p>图 110 1    列表框中的重复值和空格<br>为了在窗体显示时去除列表框的重复值和空格，可以使用Add方法，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    On Error Resume Next
    Dim Col As New Collection
    Dim rng As Range, arr
    Dim i As Integer
    For Each rng In Range(&quot;A1:A&quot; &amp; [a65536].End(xlUp).Row)
        If Trim(rng) &lt;&gt; &quot;&quot; Then
            Col.Add rng, key:=CStr(rng)
        End If
    Next
    ReDim arr(1 To Col.Count)
    For i = 1 To Col.Count
        arr(i) = Col(i)
    Next
    Me.ListBox1.List = arr
End Sub
代码解析：
窗体的初始化事件，去除列表框引用工作表数据中的重复值和空格。
第2行代码，错误处理语句，忽略错误。
第3行到第5行代码，声明变量类型。
第6行到第9行代码代码，在列表框引用的工作表数据中循环，把工作表数据源中的空格去除后使用Add方法添加到变量Col中。Add方法添加一个成员到Collection 对象，语法如下：
object.Add item, key, before, after
参数object是必需的，一个有效的对象。
参数Item是必需的，任意类型的表达式，指定要添加到集合中的成员。
参数Key是可选的，唯一字符串表达式，指定可以使用的键字符串，代替位置索引来访问集合中的成员。
如果指定的key和集合中现有成员的key发生重复，则会导致错误发生。所以在第2行代码中使用错误处理语句，忽略错误，继续执行下一句代码，这样就将数据源中的重复值去除。
参数before是可选的，指定集合中的相对位置。在集合中将添加的成员放置在before参数识别的成员之前。如果参数是数值表达式，则before必须是介于 1 和集合Count属性值之间的值。如果参数是字符串表达式，则当添加一个被引用的成员到集合时，before 必须对应于指定的key值。可以指定before位置或after位置，但不能同时指定这两个位置。
参数after是可选的，指定集合中的相对位置。在集合中将添加的成员放置在After参数识别的成员之后。如果参数是数值表达式，则after必须是介于 1 和集合Count属性值之间的值；如果参数是字符串表达式，则当添加一个被引用的成员到集合时，after 必须对应于指定的key值。可以指定before位置或after位置，但不能同时指定这两个位置。
第10行到第14行代码，重新定义数组arr大小，把Col中数据赋给数组。
第15行代码，把数组arr复制到列表框中。
运行窗体，窗体中的列表框引用去除重复值和空格后的工作表数据，如图 110 2所示。

图 110 2    去除重复值和空格的列表框</code></pre>
<h3 id="技巧111-移动列表框条目"><a href="#技巧111-移动列表框条目" class="headerlink" title="技巧111     移动列表框条目"></a>技巧111     移动列表框条目</h3><p>将列表框中的条目进行上下移动，如下面的代码所示。</p>
<pre><code class="vb">Dim Intlist As Integer
Dim Strlist As String
Private Sub CommandButton1_Click() 
    With Me.ListBox1
        Intlist = .ListIndex
        Select Case Intlist
            Case -1
                MsgBox &quot;请选择一行后再移动!&quot;
            Case 0
                MsgBox &quot;已经是最上一行了!&quot;
            Case Is &gt; 0
                Strlist = .List(Intlist)
                .List(Intlist) = .List(Intlist - 1)
                .List(Intlist - 1) = Strlist
                .ListIndex = Intlist - 1
        End Select
    End With
End Sub
Private Sub CommandButton2_Click() 
    With ListBox1
        Intlist = .ListIndex
        Select Case Intlist
            Case -1
                MsgBox &quot;请选择一行后再移动!&quot;
            Case .ListCount - 1
                MsgBox &quot;已经是最下一行了!&quot;
            Case Is &lt; .ListCount - 1
                Strlist = .List(Intlist)
                .List(Intlist) = .List(Intlist + 1)
                .List(Intlist + 1) = Strlist
                .ListIndex = Intlist + 1
        End Select
    End With
End Sub
代码解析：
第1、2行代码在模块顶部声明两个变量分别用于保存列表框当前选中行的索引和内容。
第3行到第18行代码，将列表框当前选中行的内容上移一行的代码。其中第5行代码使用变量Intlist保存列表框当前选中行的索引号，第6行代码判断索引号,，第7、8行代码如果变量Intlist值为-1 ，说明当前没有选中的行，显示一个消息框进行提示。第9、10行代码变量Intlist值为0 ，说明当前选中的行已是第一行了。
列表框的ListIndex属性指定当前选中的列表框或组合框条目，语法如下：
object.ListIndex [= Variant]
参数object是必需的，一个有效的对象。
参数Variant是可选的，控件中当前被选的条目。
第11行到第15行代码将当前选中的行向下移动一行，其中第12行代码将当前选中的行的内容赋给变量Strlist，第13行代码将当前选中行的内容更改为下面一行的内容，第14行代码将当前选中行的下面一行的内容更改为变量Strlist保存的内容，第15行代码将选中行向下移动一行，这样就将当前选中的行向下移动了一行。
第19行到第34行代码将当前选中的行向上移动一行。</code></pre>
<p>将移动后的列表框条目保存到工作表中的代码如下：</p>
<pre><code class="vb">Private Sub CommandButton3_Click()
    Dim i As Integer
    For i = 1 To ListBox1.ListCount
        Sheet1.Cells(i + 1, 1) = ListBox1.List(i - 1)
    Next
End Sub
代码解析：
窗体中“保存”按钮的单击过程，将移动后的列表框条目保存到工作表。
第3行到第5行代码使用For...Next 语句循环遍历列表框所有条目，将List属性返回的列表框的列表条目写入到工作表中。List属性返回或设置列表框或组合框的列表条目数，语法请参阅技巧109-2。
运行窗体效果如所示。</code></pre>
<h3 id="技巧112-允许多项选择的列表框"><a href="#技巧112-允许多项选择的列表框" class="headerlink" title="技巧112     允许多项选择的列表框"></a>技巧112     允许多项选择的列表框</h3><p>一般情况下在显示的列表框中用户只能选择一个列表项，而经过简单的设置，列表框条目前可以显示选项按钮，允许进行多项选择，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim arr As Variant
    arr = Array(&quot;经理室&quot;, &quot;办公室&quot;, &quot;生技科&quot;, &quot;财务科&quot;, &quot;营业部&quot;, &quot;制水车间&quot;, &quot;污水厂&quot;, &quot;安装公司&quot;, &quot;其他&quot;)
    With Me.ListBox1
        .List = arr
        .ListStyle = 1
        .MultiSelect = 1
    End With
End Sub
代码解析：
窗体的Initialize事件过程，在窗体初始化时对列表框进行设置。
其中第5行代码使用List属性为列表框添加列表项，请参阅技巧109-2。
第6行代码将列表框的ListStyle属性设置为1（fmListStyleOption），显示用于多重选择列表的复选框，ListStyle属性规定列表框或组合框中的列表的外观，语法如下：
object.ListStyle [= fmListStyle]
参数object是必需的，一个有效的对象。
参数fmListStyle是可选的，列表的可视风格，设置值如表格 112 1所示。
常量    值    说明
fmListStylePlain    0    外观与常规的列表框相似，条目的背景为高亮
fmListStyleOption    1    显示选项按钮，或显示用于多重选择列表的复选框（默认）。当用户选定组中的条目时，与该条目相关的选项按钮即被选中，而该组其他条目的选项按钮则被取消选择
表格 112 1    fmListStyle设置值
ListStyle 属性可用来改变列表框或组合框的可视外观。通过一种不同于 fmListStylePlain 的设置，可以将任意控件的内容作为一组单独项目演示，每个项目都包含一个可视记号用以表示它是否被选中。
如果控件支持单一选择（MultiSelect属性被设置为mMultiSelectSingle），则可按下组中的一个按钮。如果控件支持多重选择，则可以按下组中两个或更多的按钮。
第7行代码将MultiSelect属性设置为1（fmMultiSelectMulti），允许列表框进行多项选择，MultiSelect属性表示对象是否允许多项选择，语法如下：
object.MultiSelect [= fmMultiSelect]
参数object是必需的，一个有效的对象。
参数fmMultiSelect是可选的，控件所用的选择方式，设置值如表格 112 2所示。
常量    值    说明
fmMultiSelectSingle    0    只可选择一个条目（默认）
fmMultiSelectMulti    1    按空格键或单击鼠标以选定列表中一个条目或取消选定
fmMultiSelectExtended    2    按 Shift 并单击鼠标，或按 Shift 的同时按一个方向键，将所选条目由前一项扩展到当前项。按 Ctrl 的同时单击鼠标可选定或取消选定
表格 112 2    fmMultiSelect设置值
经过以上设置，列表框显示时可以进行多项选择并且条目前都有一个选项按钮用以表示它是否被选中，如图 112 1所示。

图 112 1    允许多项选择的列表框
如果将列表框的ListStyle属性设置为0则与常规的列表框相似。
如果将列表框的MultiSelect属性设置0则列表框只能进行单项选择，如图 112 2所示。

图 112 2    允许单项选择的列表框</code></pre>
<p>通过列表框的Selected属性值可以判断列表框中条目的选定状态，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Dim s As String
    For i = 0 To ListBox1.ListCount - 1
        If ListBox1.Selected(i) = True Then
            s = s &amp; ListBox1.List(i) &amp; Chr(13)
        End If
    Next
    If s &lt;&gt; &quot;&quot; Then
        MsgBox &quot;你选择了：&quot; &amp; Chr(13) &amp; s
    Else
        MsgBox &quot;请最少选择一个部门!&quot;
    End If
End Sub
代码解析：
按钮的单击过程，将列表框中选中的条目使用消息框显示出来。
第4行到第8行代码使用For...Next 语句循环遍历列表框所有条目，通过返回的Selected属性值判断列表框中条目的选定状态，如果处于选中状态，第6行代码将列表框选中条目的值赋给字符串变量s。
Selected属性判断列表框中条目的选定状态，语法如下：
object.Selected( index ) [= Boolean]
参数object是必需的，一个有效的对象。
参数index是必需的，整数，取值范围是0到列表中的条目数减1之间的数值。
参数Boolean是必需的，判断一个条目是否被选中。
第9行到第13行代码使用消息框显示列表框中选中的条目。
运行窗体结果如图 112 3所示。

图 112 3    允许多项选择的列表框</code></pre>
<h3 id="技巧113-多列组合框和列表框的设置"><a href="#技巧113-多列组合框和列表框的设置" class="headerlink" title="技巧113     多列组合框和列表框的设置"></a>技巧113     多列组合框和列表框的设置</h3><h4 id="113-1-多列组合框和列表框添加列表项"><a href="#113-1-多列组合框和列表框添加列表项" class="headerlink" title="113-1    多列组合框和列表框添加列表项"></a>113-1    多列组合框和列表框添加列表项</h4><p>如果组合框和列表框是多列的话，除了使用技巧109 的方法外，还需要设置控件的其他属性，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim iRow As Integer
    Dim Arr As Variant
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    Arr = Sheet1.Range(&quot;A1:G&quot; &amp; iRow)
    With Me.ListBox1
        .ColumnCount = 7
        .ColumnWidths = &quot;45,45,45,45,45,30,45&quot;
        .BoundColumn = 1
        .Column = Application.WorksheetFunction.Transpose(Arr)
    End With
End Sub
代码解析：
在窗体初始化时为多列列表框添加列表项。
第4行代码，设置列表框显示的列数。ColumnCount 属性指定列表框或组合框的显示列数，语法如下：
object.ColumnCount [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，指定需显示的列数。
如果将ColumnCount设为 -1，将显示所有列。
第8行代码，设置列表框各列的宽度。ColumnWidths 属性指定多列的组合框或列表框中的各列的宽度，语法如下：
object.ColumnWidths [= String]
参数object是必需的，一个有效的对象。
参数String是可选的，以磅为单位设置列的宽度。
如将ColumnWidths 属性设为 -1 或空，则将控件宽度等分，给予列表中的各列。设为 0 则隐藏该列，大于 0 的数值则是该列的精确宽度值。若要指定另一种不同的度量单位，设置时必须包括该度量单位。
第9行代码，设置多列列表框中的第一列为数据的来源。BoundColumn 属性标识多列组合框或列表框中的数据的来源，语法如下：
object.BoundColumn [= Variant]
参数object是必需的，一个有效的对象。
参数Variant是可选的，标识选择 BoundColumn 属性值的方法，设置值如表格 113 1所示：
值    说明
0    将 ListIndex 属性的值赋予控件。
1 或者大于 1    将指定列中的值赋予控件。当采用此属性时，列从 1 开始计数（默认值）。
表格 113 1    Variant 的设置值
当选择了多列列表框的一行时，BoundColumn 属性标识出将该行的哪一条目作为控件的值存储。BoundColumn属性设为 0，将所选行的行号赋予控件，作为控件的值。如果BoundColumn属性设为1 或者大于 1，则将指定列中的值赋予控件。
第10行代码，设置多列列表框中列表的来源。在设置列表来源时除了可以使用技巧109 所介绍的方法外，还可以使用Column属性指定列表框中的一个或多个条目，Column属性语法如下：
object.Column( column, row ) [= Variant]
参数object是必需的，一个有效对象。
参数column是可选的，取值范围为0到总列数减1之间的数值。
参数row是可选的，取值范围为0到总行数减1之间的数值。
参数Variant是可选的，指定欲加载到列表框的一个值、一列值或一个二维数组。
注意   当从一个二维数组中复制数据时，使用Column属性将转置控件中数组的内容，所以在加载时需使用Transpose函数对数组进行转置。
多列列表框设置完成后效果如图 113 1所示。

图 113 1    多列列表框</code></pre>
<h4 id="113-2-多列列表框写入工作表"><a href="#113-2-多列列表框写入工作表" class="headerlink" title="113-2    多列列表框写入工作表"></a>113-2    多列列表框写入工作表</h4><p>在把多列列表框的写入工作表中时，只能把BoundColumn属性所指定列中的值写入工作表中，不能把选中的整行内容写入到工作表中。如果需要把多列列表框中选中行的整行内容写入工作表中，可以使用循环语句将列表框各列的写入工作表，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim iRow As Integer
    iRow = Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
    With Me.ListBox1
        .ColumnCount = 7
        .ColumnWidths = &quot;45,45,45,45,45,30,45&quot;
        .BoundColumn = 1
        .ColumnHeads = True
        .RowSource = Sheet2.Range(&quot;A2:G&quot; &amp; iRow).Address(External:=True)
    End With
End Sub
Private Sub ListBox1_Click()
    Dim iRow As Integer
    Dim i As Byte
    iRow = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row + 1
    For i = 1 To ListBox1.ColumnCount
        Sheet1.Cells(iRow, i) = ListBox1.Column(i - 1)
    Next
End Sub
代码解析：
第1行到第11行代码窗体的Initialize事件过程，在窗体初始化时为多列列表框添加列表项，请参阅技巧113-1。
第8行代码，设置多列列表框中的第一行为列标题行。ColumnHeads 属性显示列表框、组合框及接受列题注的对象中的列标题行，语法如下：
object.ColumnHeads [= Boolean]
参数object是必需的，一个有效的对象。
参数Boolean是可选的，指定是否显示列标题。
将ColumnHeads 属性设置为True，多列列表框的第一行显示为列标题，默认值为False，不显示列标题。
需要注意的是，当数据项中的第一行作为列标题时，则不可选中该行。
第9行代码，使用RowSource属性设置多列列表框中列表的来源。关于RowSource属性请参阅技巧109-1。
注意 如果已将多列列表框中列表项来源的第一行设置为列标题，在设置RowSource属性时应从列表项来源的第二行开始设置。
第12行到第19行代码列表框的Click事件，单击多列列表框时把选中行的整行内容写入工作表中。其中第17行代码，使用循环语句将多列列表框选中行的各列的值写入工作表对应的单元格中。关于Column属性请参阅技巧113-1，在本例中没有指定row参数，所以是把当前选中行的内容写入工作表。
运行窗体后，单击列表框将选中的整行内容写入工作表中，如图 113 2所示。

图 113 2    多列列表框选中的整行内容写入工作表</code></pre>
<h3 id="技巧114-输入时逐步提示信息"><a href="#技巧114-输入时逐步提示信息" class="headerlink" title="技巧114     输入时逐步提示信息"></a>技巧114     输入时逐步提示信息</h3><p>用户在录入数据时，比如在工作表中输入产品名称，除了希望有所有产品名称的下拉列表供选择外，更希望能逐步给出提示信息。比如在输入一两个字符后把符合条件的数据筛选出来供选择，最好是中英文、拼音首字母、大小写能混合查询，如输入“LJ”或“六角”后所有以“六角”开头的产品名称都筛选到列表中供选择，这将大大提高录入速度和正确率。<br>为了达到这一目的，首先在工作簿需要有如图 114 1所示的基础数据表。</p>
<p>图 114 1    基础数据表<br>基础数据表中A列保存不重复的产品名称，为了能用中英文、拼音首字母、大小写混合查询，要把产品名称转换成小写的拼音首字母保存在B列。<br>步骤1：在VBE窗口单击菜单“插入”→“模块”，在代码窗口写入下面的代码。</p>
<pre><code class="vb">Public Function LChin(Str As String) As Variant
    On Error Resume Next
    Str = StrConv(Str, vbNarrow)
    If Asc(Str) &gt; 0 Or Err.Number = 1004 Then LChin = &quot;&quot;
    LChin = WorksheetFunction.VLookup(Str, [{&quot;吖&quot;,&quot;a&quot;;&quot;八&quot;,&quot;b&quot;;&quot;嚓&quot;,&quot;c&quot;;&quot;咑&quot;,&quot;d&quot;;&quot;鵽&quot;,&quot;e&quot;;&quot;发&quot;,&quot;f&quot;;&quot;猤&quot;,&quot;g&quot;;&quot;铪&quot;,&quot;h&quot;;&quot;夻&quot;,&quot;j&quot;;&quot;咔&quot;,&quot;k&quot;;&quot;垃&quot;,&quot;l&quot;;&quot;嘸&quot;,&quot;m&quot;;&quot;旀&quot;,&quot;n&quot;;&quot;噢&quot;,&quot;o&quot;;&quot;妑&quot;,&quot;p&quot;;&quot;七&quot;,&quot;q&quot;;&quot;囕&quot;,&quot;r&quot;;&quot;仨&quot;,&quot;s&quot;;&quot;他&quot;,&quot;t&quot;;&quot;屲&quot;,&quot;w&quot;;&quot;夕&quot;,&quot;x&quot;;&quot;丫&quot;,&quot;y&quot;;&quot;帀&quot;,&quot;z&quot;}], 2)
#006  End Function
代码解析：
自定义LChin函数，该函数把中文字符转换为拼音首字母。
步骤2：在VBE窗口双击Sheet2表，在代码窗口写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_Change(ByVal Target As Range)
    Dim i As Integer
    Dim myStr As String
    With Target
        If .Column &lt;&gt; 1 Or .Count &gt; 1 Then Exit Sub
        If WorksheetFunction.CountIf(Sheet2.Range(&quot;A:A&quot;), .Value) &gt; 1 Then
            .Value = &quot;&quot;
            MsgBox &quot;不能输入重复的产品名称!&quot;, 64
            Exit Sub
        End If
        For i = 1 To Len(.Value)
            If Asc(Mid$(.Value, i, 1)) &gt; 255 Or Asc(Mid$(.Value, i, 1)) &lt; 0 Then
                myStr = myStr &amp; LChin(Mid$(.Value, i, 1))
            Else
                myStr = myStr &amp; LCase(Mid$(.Value, i, 1))
            End If
        Next
        .Offset(, 1).Value = myStr
    End With
End Sub
代码解析：
工作表的Change事件，当A列输入不重复的产品名称后，转换成小写的字母保存在B列的单元格中，便于以后的查询。
第11行代码，设置事件触发的条件，只有在A列输入产品名称后才触发Change事件。
第12行到第16行代码，使用工作表CountIf函数检查输入的产品名称是否重复。
第17行到第23行代码，字符的转换过程。首先检查是否是中文字符，如果是使用自定义函数LChin转换成小写拼音首字母。如果是大写的英文字母使用LCase函数转换成小写字母。
第24行代码，将转换后的字符保存到B列。
步骤3：基础数据表完成后，在工作表“录入表”中添加一个文本框控件和一个列表框控件。在VBE窗口中双击Sheet1表，写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    Dim i As Integer
    If Target.Count = 1 Then
        If Target.Column = 1 And Target.Row &gt; 1 Then
            With Me.TextBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Left
                .Width = Target.Width
                .Height = Target.Height
                .Activate
            End With
            With Me.ListBox1
                .Visible = True
                .Top = Target.Top
                .Left = Target.Left + Target.Width
                .Width = Target.Width
                .Height = Target.Height * 5
                For i = 2 To Sheet2.Range(&quot;A65536&quot;).End(xlUp).Row
                    .AddItem Sheet2.Cells(i, 1).Value
                Next
            End With
        Else
            Me.ListBox1.Clear
            Me.TextBox1 = &quot;&quot;
            Me.ListBox1.Visible = False
            Me.TextBox1.Visible = False
        End If
    End If
End Sub
代码解析：
工作表的SelectionChange事件，当用户选定工作表A列第2行以下的单个单元格时，设置文本框和列表框的Visible为True，使它们成为可见的，并设置其外观，同时给列表框加载列表项。当用户选定其他列的单元格时隐藏文本框和列表框控件。
步骤4：在设计模式下双击文本框，在代码窗口写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub TextBox1_KeyUp(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    Dim i As Integer
    Dim Language As Boolean
    Dim myStr As String
    Me.ListBox1.Clear
    With Me.TextBox1
        For i = 1 To Len(.Value)
            If Asc(Mid$(.Value, i, 1)) &gt; 255 Or Asc(Mid$(.Value, i, 1)) &lt; 0 Then
                Language = True
                myStr = myStr &amp; Mid$(.Value, i, 1)
            Else
                myStr = myStr &amp; LCase(Mid$(.Value, i, 1))
            End If
        Next
    End With
    With Sheet2
        For i = 2 To .Range(&quot;A65536&quot;).End(xlUp).Row
            If Language = True Then
                If Left(.Cells(i, 1).Value, Len(myStr)) = myStr Then
                    Me.ListBox1.AddItem .Cells(i, 1).Value
                End If
            Else
                If Left(.Cells(i, 2).Value, Len(myStr)) = myStr Then
                    Me.ListBox1.AddItem .Cells(i, 1).Value
                End If
            End If
        Next
    End With
End Sub
代码解析：
文本框的KeyUp事件，在文本框输入查询条件时筛选符合条件的数据加载到列表框。
第3行代码，声明变量Language为Boolean数据类型，在下面的代码中使用Language的值判断输入的是否为中文。
第5行代码，使用Clear方法删除列表框所有的列表项，语法如下：
object.Clear
参数object是必需的，一个有效的对象。
注意 如果列表框绑定了数据，Clear方法将会失败。
第6行到第15行代码，判断文本框输入的是否为中文字符。如果是中文字符，将变量Language赋值为True，并把文本框中的字符赋给变量myStr。如果是英文字符则转换成小写字母后赋变量myStr。
第16行到第29行代码，如果变量Language的值为True，在基础数据表的A列中使用Left函数查找与文本框字符相符的单元格并加载到列表框，否则就在B列查找。
步骤5：在设计模式下双击文本框，在代码窗口写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub TextBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = vbKeyReturn Then
        Sheet1.ListBox1.Activate
    End If
End Sub
代码解析：
文本框的KeyDown事件，当用户在文本框中输入完成，列表框中已显示所需的内容后按回车键后选择列表框。
步骤6：在设计模式下双击列表框，在代码窗口写入下面的代码</code></pre>
<pre><code class="vb">Private Sub ListBox1_GotFocus()
    On Error Resume Next
    ListBox1.ListIndex = 0
End Sub
代码解析：
列表框的GotFocus事件，当用户在文本框中输入完成按回车键后，选定列表框中第1个条目，方便用户进行下一步操作。</code></pre>
<pre><code class="vb">Private Sub ListBox1_KeyDown(ByVal KeyCode As MSForms.ReturnInteger, ByVal Shift As Integer)
    If KeyCode = vbKeyReturn Then
        ActiveCell.Value = ListBox1.Value
        Me.ListBox1.Clear
        Me.TextBox1 = &quot;&quot;
        Me.ListBox1.Visible = False
        Me.TextBox1.Visible = False
    End If
End Sub
代码解析：
列表框的KeyDown事件，当用户在列表框中按下回车后将列表框选中的条目写入到活动工作表的单元格中，同时清空文本框和列表框内容后隐藏，准备下一次录入。</code></pre>
<pre><code class="vb">Private Sub ListBox1_DblClick(ByVal Cancel As MSForms.ReturnBoolean)
    ActiveCell.Value = ListBox1.Value
    Me.ListBox1.Clear
    Me.TextBox1 = &quot;&quot;
    Me.ListBox1.Visible = False
    Me.TextBox1.Visible = False
End Sub
代码解析：
列表框的DblClick事件，当用户双击列表框的列表项时，把列表框数据赋给活动单元格，同时清空文本框和列表框内容后隐藏，准备下一次录入。
以上设置完成后，在“录入”工作表的A列选定单元格后，显示一个文本框和一个列表框，在文本框中输入查询条件后列表框显示符合查询条件的所有内容供用户选择，如图 114 2所示。

图 114 2    输入时逐步提示信息</code></pre>
<h3 id="技巧115-二级组合框"><a href="#技巧115-二级组合框" class="headerlink" title="技巧115     二级组合框"></a>技巧115     二级组合框</h3><p>在使用多个组合框输入数据时，往往希望后一个组合框中的条目能根据前一个组合框的内容有所不同，如示例中第二个选择城市的组合框根据第一个选择省份的组合框所选择的不同省份加载不同的县市名称，示例代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim col As New Collection
    Dim arr As Variant
    Dim rng As Range
    Dim i As Integer
    On Error Resume Next
    For Each rng In Range(&quot;A2:A&quot; &amp; Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row)
        If rng &lt;&gt; &quot;&quot; Then col.Add rng, CStr(rng)
    Next
    ReDim arr(1 To col.Count)
    For i = 1 To col.Count
        arr(i) = col(i)
    Next
    ComboBox1.List = arr
    ComboBox1.ListIndex = 0
    CommandButton1.Accelerator = &quot;D&quot;
End Sub
Private Sub ComboBox1_Change()
    Dim myAddress As String
    Dim rng As Range
    Dim mymsg As Integer
    ComboBox2.Clear
    With Sheet1.Range(&quot;A:A&quot;)
        Set rng = .Find(What:=ComboBox1.Text)
            If Not rng Is Nothing Then
                myAddress = rng.Address
                Do
                    ComboBox2.AddItem rng.Offset(, 1)
                    Set rng = .FindNext(rng)
                Loop While Not rng Is Nothing And rng.Address &lt;&gt; myAddress
            End If
        End With
        ComboBox2.ListIndex = 0
End Sub
代码解析：
第1行到第17行代码窗体的Initialize事件过程，在窗体显示时将工作表A列中的省份名称去除重复后加载到组合框中。
其中第7行到第13行代码把工作表A列中的省份名称使用Add方法去除重复后加载到组合框中，应用于Collection 对象的Add方法添加一个成员对象，请参阅技巧110 。
第15行代码设置组合框的ListIndex属性为0，选中组合框的第一行条目。ListIndex属性指定当前选中的列表框或组合框条目，语法如下：
object.ListIndex [= Variant]
参数Variant是可选的，控件中当前被选的条目。
ListIndex 属性包含列表中被选行的索引，取值范围为 -1 到列表总行数减 1（即ListCount - 1）之间的数值。当用户没有选中行时，ListIndex 返回 -1。列表中第一行的 ListIndex值是0，第二行的ListIndex 值是1，依此类推。
第16行代码设置窗体中按钮的Accelerator属性值。Accelerator属性设置或检索控件的加速键，语法如下：
object.Accelerator [= String]
参数String是可选的，用作加速键的字符。
先按住 Alt 再紧接着按加速键，会将焦点定位到该对象上，并初始化与该对象关联的一个或多个事件，也就是说窗体显示后按Alt+D组合键将会执行“关闭”按钮中的代码关闭窗体。
第18行到第34行代码ComboBox1的Change事件过程，使用Find方法将所有属于ComboBox1所选择的省份的县市加载到ComboBox2中。关于Find方法请参阅技巧5-1。
窗体运行后效果如图 115 1所示。

图 115 1    二级组合框</code></pre>
<h3 id="技巧116-使用DTP控件输入日期"><a href="#技巧116-使用DTP控件输入日期" class="headerlink" title="技巧116     使用DTP控件输入日期"></a>技巧116     使用DTP控件输入日期</h3><p>在工作表中输入日期可以使用日期时间控件（Microsoft Date and Time Picker Control 6.0，简称DTP控件）。<br>在工作表中单击菜单“视图”→“工具栏”→“控件工具箱”，选择“其他控件”中的DTP控件如图 116 1所示，在工作表中添加一个DTP控件。</p>
<p>图 116 1    选择DTP控件<br>在设计模式下双击DTP控件写入下面的代码：</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    With Me.DTPicker1
        If Target.Count = 1 And Target.Column = 2 And (Not Target.Row = 1) Or Target.MergeCells Then
            .Visible = True
            .Top = Selection.Top
            .Left = Selection.Left
            .Height = Selection.Height
            .Width = Selection.Width
            If Target.Cells(1, 1) &lt;&gt; &quot;&quot; Then
                .Value = Target.Cells(1, 1).Value
            Else
                .Value = Date
            End If
        Else
            .Visible = False
        End If
    End With
End Sub
Private Sub DTPicker1_CloseUp()
    ActiveCell.Value = Me.DTPicker1.Value
    Me.DTPicker1.Visible = False
End Sub
Private Sub Worksheet_Change(ByVal Target As Range)
    If Target.Count = 1 And Target.Column = 2 Or Target.MergeCells Then
        If Target.Cells(1, 1).Value = &quot;&quot; Then
            DTPicker1.Visible = False
        End If
    End If
End Sub
代码解析：
第1行到第18行代码工作表的SelectionChange事件，当选择工作表的B列第2行以下的单个单元格时显示日期控件供用户选择日期。
其中第3行代码设置显示日期控件的触发条件。只有当用户选择B列第2行以下单元格且只能选择单个单元格时才显示日期控件，因为本例B列中存在合并单元格，所以需要加上Or Target.MergeCells这个条件，否则单击合并单元格不显示日期控件。
第4行到第8行代码显示日期控件并设置日期控件的大小等于所选单元格的大小。
第9行到第13行代码，如果单元格已经输入了日期，将单元格中的日期赋给日期控件，否则将当前日期赋给日期控件。因为本例B列中存在合并单元格，而合并区域的值在该区域左上角的单元格中指定，所以用Target.Cells(1, 1) 指定合并单元格的值，否则代码会出错。
第15行代码如果选择的是其他列则隐藏日期控件。
第19行到第22行代码日期控件的CloseUp事件，将日期控件的值赋给活动单元格后隐藏日期控件。
第23行到第29行代码工作表的Change事件，如果删除了B列单元格的日期则隐藏日期控件。
当用户选择B列单元格时效果如图 116 2所示。

图 116 2    使用DTP控件输入日期</code></pre>
<h3 id="技巧117-使用RefEdit控件选择区域"><a href="#技巧117-使用RefEdit控件选择区域" class="headerlink" title="技巧117     使用RefEdit控件选择区域"></a>技巧117     使用RefEdit控件选择区域</h3><p>在技巧76-2中介绍了如何使用InputBox方法获得所选单元格区域的地址，而使用RefEdit控件获得单元格区域的地址比使用InputBox方法更加方便，可以单击RefEdit控件中的按钮以折叠用户窗体，选定区域后再单击按钮展开用户窗体，示例代码如下：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim Rng As Range
    On Error GoTo line
    Set Rng = Range(RefEdit1.Value)
        Rng.Interior.ColorIndex = 15
        Unload UserForm1
        Exit Sub
line:
    MsgBox &quot;你选择的是非单元格区域!&quot;
End Sub
代码解析：
用户窗体中按钮的单击事件过程，改变用户使用RefEdit控件所选择的单元格区域内部的颜色。
第3行代码，错误处理语句。因为如果用户输入或选定了错误的单元格区域地址，将显示一错误信息，如图 117 1所示，所以必需使用On Error GoTo语句来绕过错误。

图 117 1    提示运行错误
第4行代码，使用Set语句将用户选择的单元格区域赋给变量rng。
第5行代码，改变用户所选单元格区域内部的颜色。
注意 不能在无模式用户窗体中使用RefEdit控件。
窗体运行后，当用户在工作表中选择一个单元格区域后改变所选单元格区域内部的颜色，如图 117 2所示。

图 117 2    使用RefEdit控件获得区域地址</code></pre>
<h3 id="技巧118-如何注册控件"><a href="#技巧118-如何注册控件" class="headerlink" title="技巧118     如何注册控件"></a>技巧118     如何注册控件</h3><p>Excel文件中如果有ActiveX控件如日期时间控件（Microsoft Date and Time Picker Control 6.0，简称DTP控件），在有些电脑上运行时会出现“无法装载这个对象，因为它不适于这台计算机”的提示，如图 118 1所示。文件中的控件丢失，无法正常使用。</p>
<p>图 118 1    无法装载对象提示<br>这是因为DTP控件没有注册引起的，解决办法是在能运行该控件的电脑中复制DTP控件的文件到目标电脑中进行注册。在VBE窗口中右键单击“工具箱”，选择“附加控件”，在“附加控件”对话框中选择DTP控件，对话框底部会显示控件的名称和文件所在的路径，如图 118 2所示。</p>
<p>图 118 2    OCX文件名称和路径<br>DTP控件的文件名为MSCOMCT2.OCX，在C盘的Windows\system32文件夹中，把该文件复制到目标电脑C盘的Windows\system32文件夹中，单击“开始”→“运行”，在“运行”对话框中键入“regsvr32 C:\Windows\system32\MSCOMCT2.OCX”，注册成功后会出现如图 118 3所示的对话框，DTP控件即能正常使用。</p>
<p>图 118 3    注册成功提示<br>在Excel中可以使用程序代码进行自动注册，代码如下：</p>
<pre><code class="vb">Sub regsvrs()
    Dim SouFile As String
    Dim DesFile As String
    On Error Resume Next
    SouFile = ThisWorkbook.Path &amp; &quot;\MSCOMCT2.OCX&quot;
    DesFile = &quot;c:\Windows\system32\MSCOMCT2.OCX&quot;
    FileCopy SouFile, DesFile
    Shell &quot;regsvr32 /s&quot; &amp; DesFile
    MsgBox &quot;DTP控件已成功注册，现在可以使用了!&quot;
End Sub
代码解析：
Regsvrs过程将保存在同一目录中的MSCOMCT2.OCX文件复制到电脑的文件夹中，使用Shell函数注册DTP控件。
第4行代码，错误处理语句，用于忽略复制文件时可能出现的错误。因为如果电脑文件夹中已存在MSCOMCT2.OCX文件，使用FileCopy方法复制时会发生错误，如图 118 4所示。

图 118 4    复制文件错误提示
第7行代码，使用FileCopy方法复制MSCOMCT2.OCX文件到电脑中。
FileCopy方法的语法如下：
FileCopy source, destination
参数Source是必需的，字符串表达式，用来表示要被复制的文件名。
参数destination是必需的，字符串表达式，用来指定要复制的目的文件名。
第8行代码，使用Shell函数注册DTP控件。
Shell函数执行一个可执行文件，语法如下：
Shell(pathname[,windowstyle])
参数pathname是必需的，要执行的程序名，以及任何必需的参数或命令行变量，可能还包括目录或文件夹，以及驱动器。
参数windowstyle是可选的，表示在程序运行时窗口的样式。windowstyle参数值如表格 118 1所示。</code></pre>
<p>常量    值    描述<br>vbHide    0    窗口被隐藏，且焦点会移到隐式窗口。常数vbHide在Macintosh平台不可用。<br>VbNormalFocus    1    窗口具有焦点，且会还原到它原来的大小和位置。<br>VbMinimizedFocus    2    窗口会以一个具有焦点的图标来显示。<br>VbMaximizedFocus    3    窗口是一个具有焦点的最大化窗口。<br>VbNormalNoFocus    4    窗口会被还原到最近使用的大小和位置，而当前活动的窗口仍然保持活动。<br>VbMinimizedNoFocus    6    窗口会以一个图标来显示。而当前活动的的窗口仍然保持活动。<br>表格 118 1    windowstyle参数值<br>运行程序前应确保在工作簿同一目录中存在MSCOMCT2.OCX文件。此代码相当于在“运行”对话框中键入“regsvr32 C:\ Windows\system32\MSCOMCT2.OCX”后进行注册，只是在“REGSVR32”后加上了s参数，使注册成功后不会出现如图 118 3所示的对话框。<br>可以使用程序代码卸载该控件，代码如下：</p>
<pre><code class="vb">Sub regsvru()
    Shell &quot;REGSVR32 /u &quot; &amp; ThisWorkbook.Path &amp; &quot;\MSCOMCT2.OCX&quot;
End Sub
代码解析：
Regsvru过程使用Shell函数注册DTP控件，在pathname参数“REGSVR32”后加上u参数，对DTP控件进行反注册。</code></pre>
<h3 id="技巧119-遍历控件的方法"><a href="#技巧119-遍历控件的方法" class="headerlink" title="技巧119     遍历控件的方法"></a>技巧119     遍历控件的方法</h3><p>如果窗体或工作表中的控件很多，在写代码时，如果是相同的代码，可以使用循环语句遍历控件，无需每个控件都写相同的代码，以减少代码量。</p>
<h4 id="119-1-使用名称中的变量遍历控件"><a href="#119-1-使用名称中的变量遍历控件" class="headerlink" title="119-1    使用名称中的变量遍历控件"></a>119-1    使用名称中的变量遍历控件</h4><p>如果控件使用系统缺省名称，如“TextBox1”、“TextBox2”，前面是固定的字符串，后面是序号的，可以使用For…Next 语句循环遍历控件。<br>对于窗体中的控件，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    For i = 1 To 3
        Me.Controls(&quot;TextBox&quot; &amp; i) = &quot;&quot;
    Next
End Sub
代码解析：
窗体按钮的单击事件，一次性清空窗体中三个文本框的内容。
第4行代码，将窗体中三个文本框名称中的最后一个序号设成变量，在文本框中循环并清空其内容。
对于工作表中的控件，如下面的代码所示。</code></pre>
<pre><code class="vb">    Dim i As Integer
    For i = 1 To 4
        Me.OLEObjects(&quot;TextBox&quot; &amp; i).Object.Text = &quot;&quot;
    Next
End Sub
代码解析：
工作表中按钮的单击事件，在工作表中的三个文本框中循环，清空文本框的内容。
第4行代码，将工作表中四个文本框名称中的最后一个序号设成变量，使用OLEObjects方法在工作表中的文本框中循环。
OLEObjects方法返回图表或工作表上单个OLE对象（OLEObject）或所有OLE对象的集合（OLEObjects集合）的对象，语法如下：
expression.OLEObjects(Index)
参数expression是必需的，返回一个Chart 对象或Worksheet 对象。
参数Index 是可选的，OLE对象的名称或编号。
注意 控件的名称是指控件在属性窗口中的名称，如图 119 1所示。如果控件的名称没有规律不适用此方法。</code></pre>
<h4 id="119-2-使用对象类型遍历控件"><a href="#119-2-使用对象类型遍历控件" class="headerlink" title="119-2    使用对象类型遍历控件"></a>119-2    使用对象类型遍历控件</h4><p>如果控件的名称没有规律，可以使用For Each…Next 语句循环遍历所有控件，使用TypeName函数返回控件的对象类型，根据控件的对象类型进行相应的操作。<br>对于窗体中的控件，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim Ctr As Control
    For Each Ctr In Me.Controls
        If TypeName(Ctr) = &quot;TextBox&quot; Then
            Ctr = &quot;&quot;
        End If
    Next
End Sub
代码解析：
按钮的单击事件，遍历所有控件并把所有文本框的内容清空。
第2行代码，声明变量类型。
第3行代码，使用For Each...Next 语句遍历窗体所有控件。
第4行代码，使用TypeName 函数返回变量的对象类型。
TypeName 函数返回一个字符串，提供有关变量的信息，语法如下：
TypeName(varname)
参数varname是必需的，它包含用户定义类型变量之外的任何变量。
如果变量Ctr是文本框控件，无论该文本框的名称是否已经被修改，TypeName(Ctr)都会返回“TextBox”字符串。
对于工作表中的控件，则使用下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim Obj As OLEObject
    For Each Obj In Me.OLEObjects
        If TypeName(Obj.Object) = &quot;TextBox&quot; Then
            Obj.Object.Text = &quot;&quot;
        End If
    Next
End Sub</code></pre>
<h4 id="119-3-使用程序标识符遍历控件"><a href="#119-3-使用程序标识符遍历控件" class="headerlink" title="119-3    使用程序标识符遍历控件"></a>119-3    使用程序标识符遍历控件</h4><p>工作表中的ActiveX控件还可以根据控件的程序标识符找到相应的控件，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim Obj As OLEObject
    For Each Obj In Me.OLEObjects
        If Obj.progID = &quot;Forms.TextBox.1&quot; Then
            Obj.Object.Text = &quot;&quot;
        End If
    Next
End Sub
代码解析：
工作表中按钮的单击事件，遍历工作表中的所有控件并把工作表中所有文本框的内容清空。
第2行代码，声明变量类型。
第3行代码，使用For Each...Next 语句遍历工作表中的所有控件。
第4行代码，使用控件的ProgId 属性返回控件的程序标识符。
ProgId 属性返回控件的程序标识符，语法如下：
expression.ProgId
参数expression是必需的，一个有效的对象。</code></pre>
<p>ActiveX 控件的程序标识符如表格 119 1所示。<br>控件名称    标识符<br>复选框    Forms.CheckBox.1<br>组合框    Forms.ComboBox.1<br>命令按钮    Forms.CommandButton.1<br>框架    Forms.Frame.1<br>图像    Forms.Image.1<br>标签    Forms.Label.1<br>列表框    Forms.ListBox.1<br>多页    Forms.ListBox.1<br>选项按钮    Forms.OptionButton.1<br>滚动条    Forms.ScrollBar.1<br>旋转按钮    Forms.SpinButton.1<br>TabStrip    Forms.TabStrip.1<br>文字框    Forms.TextBox.1<br>切换按钮    Forms.ToggleButton.1<br>表格 119 1    ActiveX 控件的程序标识符<br>文本框控件返回的程序标识符是“Forms.TextBox.1”，此返回值并不受文本框控件名称的影响，所以根据工作表中控件的程序标识符可以找出全部文本框控件。</p>
<h4 id="119-4-使用名称中的变量遍历图形"><a href="#119-4-使用名称中的变量遍历图形" class="headerlink" title="119-4    使用名称中的变量遍历图形"></a>119-4    使用名称中的变量遍历图形</h4><p>如果工作表中有多个图形，可以根据名称的序号使用For…Next 语句遍历图形，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    For i = 1 To 3
        Me.Shapes(&quot;文本框 &quot; &amp; i).TextFrame.Characters.Text = &quot;TextBox&quot; &amp; i
    Next
End Sub
代码解析：
工作表中按钮的单击事件，在工作表中的三个图形文本框中依次写入“TextBox1”、“TextBox2”和“TextBox3”字符串。
第3行到第5行代码，使用Shapes属性在工作表上的三个图形文本框中循环。
Shapes属性返回Shapes对象，代表工作表或图形工作表上的所有图形，可以使用Shapes(index)（其中index是图形的名称或索引号）返回单个的Shape对象。
返回单个的Shape对象后使用Characters 方法向图形文本框中添加字符。Characters 方法的语法如下：
expression.Characters(Start, Length)
参数expression是必需的，返回一个指定文本框内Characters对象的表达式。
参数Start是可选的，表示将要返回的第一个字符。如果此参数设置为 1 或被忽略，则Characters方法会返回以第一个字符为起始字符的字符区域。
参数Length是可选的，表示要返回的字符个数。如果此参数被忽略，则Characters 方法会返回该字符串的剩余部分。
119-5    使用FormControlType属性遍历图形</code></pre>
<p>如果工作表中的是窗体控件，可以使用For Each…Next语句遍历工作表中图形并根据其FormControlType属性返回特定的窗体控件，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton2_Click()
    Dim myShape As Shape
    For Each myShape In Sheet4.Shapes
        If myShape.Type = msoFormControl Then
            If myShape.FormControlType = xlCheckBox Then
                myShape.ControlFormat.Value = 1
            End If
        End If
    Next
End Sub
代码解析：
工作表中按钮的单击事件，清除工作表中所有的复选框。
第2行代码声明变量myShape为图形对象。
第3行代码使用For Each...Next语句遍历工作表中的图形。
第4行代码根据图形的Type属性判断图形是否为窗体控件。应用于Shape对象的Type属性返回或设置图形类型，窗体控件返回常量msoFormControl。
第5行代码根据控件的FormControlType属性判断窗体控件是否为复选框控件。FormControlType属性返回窗体控件的类型，可以为表格 119 2所示的XlFormControl常量之一。</code></pre>
<p>常量    值    控件类型<br>xlButtonControl    0    按钮<br>xlCheckBox    1    复选框<br>xlDropDown    2    组合框<br>xlGroupBox    4    分组框<br>xlLabel    5    标签<br>xlListBox    6    列表框<br>xlOptionButton    7    选项按钮<br>xlScrollBar    8    滚动条<br>xlSpinner    9    微调项<br>表格 119 2    XlFormControl常量<br>第6行代码使用ControlFormat属性返回工作表中的复选框，并将其他Value属性设置为1选中复选框，如果需要取消复选框只需将Value属性设置为-4146。</p>
<h3 id="技巧120-使微调框最小变动量小于"><a href="#技巧120-使微调框最小变动量小于" class="headerlink" title="技巧120     使微调框最小变动量小于"></a>技巧120     使微调框最小变动量小于</h3><p>在用微调框调节数值时，默认的变动量只能设置成整数。为了使微调框的变动量小于1，如每次的变动量为0.01，需要在代码中做必要的设置，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    With Me.SpinButton1
        .Max = 10000
        .Min = -10000
        .SmallChange = 1
        .Value = 0
        Me.TextBox1 = Format(.Value, &quot;0.00&quot;)
    End With
End Sub
Private Sub SpinButton1_Change()
    Me.TextBox1 = Format(Me.SpinButton1 * 0.01, &quot;0.00&quot;)
End Sub
代码解析：
使用微调框调节文本框的数值，每次的变动量为0.01。
第1行代码到第9行代码，窗体的初始化事件，在窗体显示时对微调框控件进行必要的设置。
第3、4行代码，设置微调框控件的Max、Min 属性。Max、Min 属性规定滚动条或数值调节钮的 Value 属性可接收的最大值和最小值，语法如下：
object.Max [= Long]
object.Min [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，指定Value属性的最大设置值或最小设置值。
第5行代码，设置微调框控件的SmallChange属性为1。SmallChange属性设定当用户单击滚动条或数值调节钮中的滚动箭头时发生的变动量，语法如下：
object.SmallChange [= Long]
参数object是必需的，一个有效的对象。
参数Long是可选的，设定Value属性的变动量。
SmallChange属性只能设置为整数。
第6行代码，设置窗体显示时微调框控件的Value属性为0。
第7行代码，使用Format函数将将文本框的初始值格式化为“0.00”。关于Format函数请参阅技巧102 。
第11行代码，微调框控件的Change事件，在微调框控件的Value属性发生变动时，将变动量乘0.01后赋给文本框，使文本框的变动量每次为0.01。
窗体运行后效果如图 120 1所示。

图 120 1    微调框变动量小于1</code></pre>
<h3 id="技巧121-不打印工作表中的控件"><a href="#技巧121-不打印工作表中的控件" class="headerlink" title="技巧121     不打印工作表中的控件"></a>技巧121     不打印工作表中的控件</h3><p>在打印工作表时，如果工作表中有控件，会把控件也一起打印出来，从而影响打印出来的工作表的美观。经过简单的设置能使工作表中的控件不被打印出来。</p>
<h4 id="121-1-设置控件格式"><a href="#121-1-设置控件格式" class="headerlink" title="121-1    设置控件格式"></a>121-1    设置控件格式</h4><p>如果工作表中的是窗体控件，设置时右键单击控件，在显示的右键快捷菜单中选择“设置控件格式”，在“设置控件格式”选项卡中选择“属性”页面，使“打印对象”前的复选框为空白状态，如图 121 1所示。</p>
<p>图 121 1    窗体控件<br>如果工作表中的控件是ActiveX控件，那么需要在设计模式下右键单击控件，在显示的右键快捷菜单中选择“设置控件格式”，在“设置控件格式”选项卡中选择“属性”页面，使“打印对象”前的复选框为空白状态，如图 121 2所示。</p>
<p>图 121 2    ActiveX控件</p>
<h4 id="121-2-设置控件的printobjcet属性"><a href="#121-2-设置控件的printobjcet属性" class="headerlink" title="121-2    设置控件的printobjcet属性"></a>121-2    设置控件的printobjcet属性</h4><p>如果工作表中的控件是ActiveX控件，使用除了使用技巧121-1的方法外，还可以在设计模式下右键单击控件，选择“属性”，设置控件的printobjcet属性为False。如图 121 3所示。</p>
<p>图 121 3    设置控件printobjcet属性</p>
<h3 id="技巧122-在框架中使用滚动条"><a href="#技巧122-在框架中使用滚动条" class="headerlink" title="技巧122     在框架中使用滚动条"></a>技巧122     在框架中使用滚动条</h3><p>如果需要在窗体中显示较多的内容，比如使用标签显示一段很长的文本内容，而又不希望窗体很大的话，可以在窗体中使用框架放置标签，设置框架可滚动区域的高度，使标签可以进行上下移动以查看全部区域。<br>在VBE窗口中单击菜单“插入”→“用户窗体”，在窗体中添加一个框架控件，在框架中添加一个标签控件。根据需要显示的内容调整好标签的大小，再将框架和窗体调整为合适的大小。<br>在VBE中双击窗体，写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim sLab As String
    sLab = Space(4) &amp; &quot;欢迎来到ExcelHome技术论坛，全球最领先的Excel技术论坛之一。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;在这里，我们讨论Microsoft Office系列产品的应用技术，重点讨论Microsoft Excel。本论坛从属于Excel Home这一全球最大的华语Excel技术门户，目前是个人、非营利性质的网站学习平台。各行各业的Excel使用者都活跃在此，各种形式的学习资源也汇聚于在此，所以，只要您愿意花时间，并使用正确的方法，我们有理由相信您的绝大部分应用问题和学习愿望都在这里被满足。无数已经取得了非凡进步的人，也可以证明这一点。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;Let’s do it better!这是Excel Home的口号，我们的宗旨是帮助大家解决在使用Office软件中的问题，提升自己的应用技能。&quot; &amp; vbLf _
        &amp; Space(4) &amp; &quot;鉴于许多人在此之前没有正确使用网络学习资源的经验，或者对Excel Home的行为规则缺乏了解，我们特别准备了这样一篇文章，送给每一位有志与我们一起成长的朋友。本文将重点叙述学习方法和论坛的规则，对于如何使用论坛的各项功能，请阅读论坛的帮助系统（http://club.excelhome.net/boardhelp.asp ）&quot;
    Label1.Caption = sLab
    With Frame1
        .ScrollBars = 2
        .ScrollHeight = Label1.Height
    End With
End Sub
代码解析：
窗体的初始化事件，在窗体加载时使用标签显示文本内容。
第3行到第6行代码，变量sLab为要显示的文本，使用Space函数在每段的首字前插入4个空格，使首字缩进。在需要换行的地方插入常数vbLf进行换行。
第9行代码，设置框架的ScrollBars属性为显示垂直滚动条。ScrollBars属性指定一个控件、窗体或页面是否有垂直或水平滚动条，或两者都有，语法如下：
object.ScrollBars [= fmScrollBars]
参数object是必需的，一个有效的对象。
参数fmScrollBars是可选的，滚动条的显示位置，设置值如表格 122 1所示。
常量    值    说明
fmScrollBarsNone    0    不显示滚动条（默认）。
fmScrollBarsHorizontal    1    显示水平滚动条。
fmScrollBarsVertical    2    显示垂直滚动条。
fmScrollBarsBoth    3    垂直和水平滚动条都显示。
表格 122 1    ScrollBars属性设置值
第10行代码，设置框架的ScrollHeight属性为标签的高度。ScrollHeight属性指定通过移动控件、窗体或页面中的滚动条，可以查看的全部区域的高度，语法如下：
object.ScrollHeight [= Single]
参数object是必需的，一个有效的对象。
参数Single是可选的，可滚动区域的高度。
如果框架具有水平滚动条，可以设置框架的ScrollWidth属性来设置可以查看的全部区域的宽度。
运行窗体，使用标签显示文本内容，可通过框架的滚动条查看全部内容，如图 122 1所示。</code></pre>
<h3 id="技巧123-使用多页控件"><a href="#技巧123-使用多页控件" class="headerlink" title="技巧123     使用多页控件"></a>技巧123     使用多页控件</h3><p>在处理可以划分为不同类别的大量信息时可以使用多页控件。例如，在示例中，多页控件的第一页用于显示欢迎信息，另三页显示其他信息。利用多页控件能够将相关信息组织在一起显示出来，同时又能够随时访问整条记录。<br>多页控件中的每个页面都是一个窗体，含有自己的控件，并且可以有唯一的布局。一般情况下，多页控件中的页面都有标签，以便让用户选择单个页面。<br>在窗体中使用多页控件时，往往希望窗体显示时能显示特定的页面，比如每次打开窗体时先显示第一页的欢迎信息，除了在VBE中选择多页控件的第一页后保存外，还可以通过设置多页控件的Value属性来实现，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    MultiPage1.Value = 0
End Sub
代码解析：
窗体的Initialize事件，在窗体显示时选择多页控件的第一页。
控件的Value属性定义某给定的控件的状态或内容，对于多页控件标识当前激活页。
Value属性是多页控件的默认属性，该属性返回当前活动页面的索引编号（位于多页控件的Pages集合中），零 ( 0 ) 表示是第一页，最大值比总页数少一。</code></pre>
<p>多页控件的默认事件是Change事件，示例中使用消息框显示当前活动页面的Caption属性，代码如下：</p>
<pre><code class="vb">Private Sub MultiPage1_Change()
    If MultiPage1.SelectedItem.Index &gt; 0 Then
        MsgBox &quot;欢迎来到&quot; &amp; MultiPage1.SelectedItem.Caption &amp; &quot;版块!&quot;
    End If
End Sub
代码解析：
MultiPage1_Change过程根据当前活动页面是否是第一页，如果不是则使用消息框显示当前活动页面的Caption属性。
应用于Page对象的Index属性指Pages集合中Page对象的位置，语法如下：
object.Index [= Integer]
参数object是必需的，一个有效对象。
参数Integer是可选的，当前选定的Page对象的索引。
Index 属性指定了标签出现的顺序，改变Index属性的值将改变多页控件中页面的顺序，第一页的索引值是0，第二页的索引值是 1，依此类推。
应用于多页控件的SelectedItem属性返回当前选中的Page对象，SelectedItem属性是只读的，用SelectedItem属性可对当前选中的Page对象进行可编程控制。
运行窗体，多页控件显示第一页的欢迎信息，当选择其他页面时显示提示信息，如图 123 1所示。

图 123 1    使用多页控件</code></pre>
<h3 id="技巧124-标签文字垂直居中对齐"><a href="#技巧124-标签文字垂直居中对齐" class="headerlink" title="技巧124     标签文字垂直居中对齐"></a>技巧124     标签文字垂直居中对齐</h3><p>在使用标签控件为其他控件作题注时，只能设置题注文字在水平方向的对齐方式，不能设置为垂直居中。要达到题注文字垂直居中的效果，可以使用两个标签控件组合来完成。<br>步骤1，在窗体中添加一个标签控件Label1，将Caption属性设置为空，再设置需要的背景颜色及边框颜色。<br>步骤2，添加一个标签控件Label2，将Caption属性设置为需要的标题；AutoSize属性设置为True，BackStyle属性设置为0，TextAligh属性设置为fmTextAlignCenter，其它属性不改变。<br>AutoSize属性规定对象是否自动调整大小以显示其完整的内容，语法如下：<br>object.AutoSize [= Boolean]<br>参数object是必需的，一个有效对象。<br>参数Boolean是可选的，是否自动调整大小。设置值为True控件可自动调整大小以显示其完整的内容，设置为False控件尺寸保持不变。如果内容超出了控件的区域，内容将被剪裁（默认）。<br>BorderStyle属性指定控件或窗体的边框类型，语法如下：<br>object.BorderStyle [= fmBorderStyle]<br>参数object是必需的，一个有效对象。<br>参数fmBorderStyle是可选的，指定边框类型，设置值如表格 124 1所示。<br>常量    值    描述<br>fmBackStyleTransparent    0    背景为透明<br>fmBackStyleOpaque    1    背景为不透明（默认值）<br>表格 124 1    fmBorderStyle设置值<br>TextAligh属性定义控件中文本的对齐方式，语法如下：<br>object.TextAlign [= fmTextAlign]<br>参数object是必需的，一个有效对象。<br>参数fmTextAlign是可选的，控件中文本的对齐方式，设置值如表格 124 2所示。<br>常量    值    描述<br>fmTextAlignLeft    1    将所显示文本的第一个字符与控件显示或编辑区的左边界对齐（默认值）。<br>fmTextAlignCenter    2    在控件的显示或编辑区中，使文本中央对齐<br>fmTextAlignRight    3    将所显示文本的最后一个字符与控件显示或编辑区的右边界对齐。<br>表格 124 2    fmTextAlign设置值<br>步骤3，同时选中两个标签控件，在右键弹出菜单中选择“统一尺寸”→“宽度相同”，再右击选择“对齐”→“左对齐”，重新右键“对齐”→“中间对齐”。<br>步骤4，最后同时选中两个标签控件，在右键弹出菜单中选择“生成组”，就达到标题为垂直居中的效果了，如图 124 1窗体中左边的标签所示。</p>
<p>图 124 1    标签控件标题垂直居中</p>
<h3 id="技巧125-使用TabStrip控件"><a href="#技巧125-使用TabStrip控件" class="headerlink" title="技巧125     使用TabStrip控件"></a>技巧125     使用TabStrip控件</h3><p>使用TabStrip控件，可以在用户窗体中的同一区域定义多个数据页面，也就是说使用TabStrip控件可以使用户窗体中的同一组控件根据TabStrip控件所选择的页面具有不同的功能，而不必像多页控件那样需要在每个页面中放置相同的控件。<br>在示例的窗体中使用一个图像控件和一个标签控件，根据TabStrip控件所选择的页面来显示相应城市的图片和标签控件的题注。<br>步骤1，在窗体中添加一个TabStrip控件，默认情况下，一个TabStrip控件包含两个页面，所以需要在TabStrip控件上右键单击，在显示的右键菜单中选择“新建页”继续添加三个页面。因为TabStrip控件不像多页控件具有分页的属性窗口，所以需要在显示的右键菜单中选择“重命名”将页面分别重命名为各城市的名称。<br>步骤2，在TabStrip控件上添加一个Image控件和一个Label控件，调整为合适的大小。<br>步骤3，双击窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub TabStrip1_Change()
    Dim FilPath As String
    FilPath = ThisWorkbook.Path &amp; &quot;\&quot; &amp; TabStrip1.SelectedItem.Caption &amp; &quot;.jpg&quot;
    Image1.Picture = LoadPicture(FilPath)
    Label1.Caption = TabStrip1.SelectedItem.Caption &amp; &quot;欢迎您!&quot;
End Sub
Private Sub UserForm_Initialize()
    TabStrip1.Value = 0
End Sub
代码解析：
第1行到第6行代码，TabStrip控件的Change事件过程，根据TabStrip控件所选择的页面来显示相应城市的图片和标签控件的题注。
第3行代码设置Image控件需加载图片的完整路径，使用SelectedItem属性返回TabStrip控件当前选中页面的Caption属性，即窗体中所选城市的名称，将图片的完整路径设置为保存在同一目录中已命名为所选城市的图片。
 第4行代码为Image控件加载图片。Picture 属性指定显示在对象上的位图，语法如下：
object.Picture = LoadPicture( pathname )
参数expression是必需的，一个有效的对象。
参数pathname是必需的，一个图片文件的完整路径。
第5行代码设置标签控件的题注为窗体中所选城市的名称和“欢迎您!”。
第7行到第9行代码窗体的Initialize事件过程，为了使窗体显示时TabStrip控件显示第一页，将其Value设置为零 ( 0 )。
运行窗体，选择不同的标签将显示不同城市的图片，如图 125 1所示。

图 125 1    使用TabStrip控件（一）
如果将TabStrip控件的Style属性设置为1则在标签条中显示的是按钮而不是标签，如图 125 2所示。

图 125 2    使用TabStrip控件（二）</code></pre>
<h3 id="技巧126-显示GIF动画图片"><a href="#技巧126-显示GIF动画图片" class="headerlink" title="技巧126     显示GIF动画图片"></a>技巧126     显示GIF动画图片</h3><p>如果希望在Excel中显示GIF格式的动画图片，可以使用AniGif控件。<br>步骤1，在工作表中单击菜单“视图”→“工具栏”→“控件工具箱”→“其他控件”，选择“VBAniGIF. AniGif”后在工作表中拖动添加AniGif控件，如图 126 1所示。</p>
<p>图 126 1    添加AniGif控件<br>如果“其他控件”中没有该控件，那么需要对该控件进行注册。注册控件请参阅技巧118 。AniGif控件的文件名为VBAniGIF.OCX，也可以在工作表中单击菜单“视图”→“工具栏”→“控件工具箱”→“其他控件”，选择“注册自定义控件”，在显示的对话框中选择VBAniGIF.OCX文件进行注册，如图 126 2所示。</p>
<p>图 126 2    注册AniGif控件<br>步骤2，在设计模式下右键单击AniGif控件，选择“属性”，设置AniGif控件的Filename属性为CIF图片所在的路径，如图 126 3所示。</p>
<p>图 126 3    设置Filename属性<br>可以使用代码设置AniGif控件的Filename属性，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Sheet1.AniGif1.Filename = ThisWorkbook.Path &amp; &quot;\001.gif&quot;
End Sub
代码解析：
工作簿打开时将AniGif控件的Filename属性设置为同一目录中的“001.gif”文件。
工作簿打开时可能出现如图 126 4所示的对话框，这是因为当打开包含ActiveX控件的文件时，如果该控件被标识为初始化不安全时，Office程序不加载或激活未被标志为初始化安全的ActiveX控件。

图 126 4    初始化不安全ActiveX控件提示</code></pre>
<p>解决此问题的方法是更改Office程序处理ActiveX组件的方式，需要对注册表进行修改。也可以使用以下代码修改注册表：</p>
<pre><code class="vb">Sub RegWriteProc()
    Dim WshShell
    Set WshShell = CreateObject(&quot;Wscript.Shell&quot;)
    WshShell.RegWrite &quot;HKCU\Software\Microsoft\Office\Common\Security\UFIControls&quot;, 1, &quot;REG_DWORD&quot;
    WshShell.RegWrite &quot;HKCU\Software\Microsoft\VBA\Security\LoadControlsInForms&quot;, 1, &quot;REG_DWORD&quot;
    Set WshShell = Nothing
End Sub
代码解析：
RegWriteProc过程修改注册表设置。第4行代码将UFIControls子项设置为1（最不安全）。第5行代码将LoadControlsInForms子项设置为1（最不安全）。关于为ActiveX控件授予权限请参阅微软的技术文章：http://support.microsoft.com/kb/827742/zh-cn
退出设计模式后，将在工作表中显示GIF动画图片，如图 126 5所示。

图 126 5    显示GIF动画图片</code></pre>
<h3 id="技巧127-播放Flash文件"><a href="#技巧127-播放Flash文件" class="headerlink" title="技巧127     播放Flash文件"></a>技巧127     播放Flash文件</h3><p>如果需要在工作表中播放Flash文件，那么可以使用ShockwaveFlash控件。<br>步骤1，在工作表中单击菜单“视图”→“工具栏”→“控件工具箱”→“其他控件”，选择“ShocKwave Flash Object”后在工作表中拖动添加ShockwaveFlash控件，如图 127 1所示。</p>
<p>图 127 1    添加ShockwaveFlash控件<br>如果“其他控件”中没有该控件，请参阅技巧126 对其进行注册，ShockwaveFlash控件的文件名为Flash9d.OCX。<br>步骤2，在设计模式下右键单击ShockwaveFlash控件，选择“属性”，设置ShockwaveFlash控件的Base属性和Movie属性为Flash文件所在的路径，设置Embedmovie属性为True，使Flash文件嵌入到Excel中，如图 127 2所示。</p>
<p>图 127 2    设置ShockwaveFlash控件属性<br>可以使用代码设置ShockwaveFlash控件的各项属性，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    With Sheet1.ShockwaveFlash1
        .Base = ThisWorkbook.Path &amp; &quot;\face.swf&quot;
        .Movie = ThisWorkbook.Path &amp; &quot;\face.swf&quot;
        .EmbedMovie = True
    End With
End Sub
代码解析：
工作簿打开时将ShockwaveFlash控件的Base属性和Movie属性设置为同一目录中的“face.swf”文件，设置Embedmovie属性为True。
退出设计模式后，将在工作表中显示Flash动画，如图 127 3所示。

图 127 3    显示Flash动画</code></pre>
<h3 id="技巧128-在工作表中添加窗体控件"><a href="#技巧128-在工作表中添加窗体控件" class="headerlink" title="技巧128     在工作表中添加窗体控件"></a>技巧128     在工作表中添加窗体控件</h3><p>在工作表中添加窗体控件，除了使用手工添加外，还可以使用代码添加，方法如下：</p>
<h4 id="128-1-使用AddFormControl方法"><a href="#128-1-使用AddFormControl方法" class="headerlink" title="128-1    使用AddFormControl方法"></a>128-1    使用AddFormControl方法</h4><p>使用AddFormControl方法在工作表中添加窗体控件，如下面的代码所示。</p>
<pre><code class="vb">Sub AddFormControls()
    Dim myShape As Shape
    On Error Resume Next
    Sheet1.Shapes(&quot;myButton&quot;).Delete
    Set myShape = Sheet1.Shapes.AddFormControl(0, 108, 72, 108, 27)
    With myShape
        .Name = &quot;myButton&quot;
        With .TextFrame.Characters
            .Font.ColorIndex = 3
            .Font.Size = 12
            .Text = &quot;新建的按钮&quot;
        End With
        .OnAction = &quot;myButton&quot;
    End With
End Sub
Sub myButton()
    MsgBox &quot;这是使用AddFormControl方法新建的按钮!&quot;
End Sub
代码解析：
AddFormControls过程使用AddFormControl方法在工作表中添加窗体控件。
第3、4行代码为了避免在工作表中重复添加按钮控件，先删除工作表中的“myButton”按钮。
第5行代码，使用AddFormControl方法在工作表中添加命令按钮控件并设置控件的坐标和大小。应用于Shapes对象的AddFormContl方法创建一个Microsoft Excel控件，返回一个Shape对象，该对象代表新建的控件，语法如下：
expression.AddFormControl(Type, Left, Top, Width, Height)
参数expression是必需的，一个有效的对象。
参数Type是必需的，Microsoft Excel控件类型，可以为表格 128 1所列XlFormControl 常量之一。
常量    值    说明
xlButtonControl    0    命令按钮
xlCheckBox    1    复选框
xlDropDown    2    组合框
xlEditBox    3    编辑框
xlGroupBox    4    分组框
xlLabel    5    标签
xlListBox    6    列表框
xlOptionButton    7    选项按钮
xlScrollBar    8    滚动条
xlSpinner    9    微调项
表格 128 1    XlFormControl 常量
参数Left是必需的，新对象的初始坐标（以磅为单位）相对于工作表 A1 单元格的左上角或图表的左上角。
参数Top是必需的，新对象的初始坐标（以磅为单位）相对于工作表 A1 单元格的左上角或图表的左上角。
参数Width是必需的，以磅为单位的新对象的初始大小。
参数Height是必需的，以磅为单位的新对象的初始大小。
第7行代码将新添加的按钮名称设置为“myButton”。
第8行到第12行代码设置新添加的按钮文字设置为“新建的按钮”，并设置文字的大小和颜色。
第13行代码，指定新添加按钮所执行的宏名称。
myButton过程是单击新添加按钮所执行的过程，显示一个消息框。
运行AddFormControls过程将在工作表中添加一个命令按钮，单击按钮显示一个消息框，如图 128 1所示。

图 128 1    使用AddFormControl方法添加窗体控件</code></pre>
<h4 id="128-2-使用Add方法"><a href="#128-2-使用Add方法" class="headerlink" title="128-2    使用Add方法"></a>128-2    使用Add方法</h4><p>在工作表中添加窗体控件还可以使用Add方法，如下面的代码所示。</p>
<pre><code class="vb">Sub AddChartObjects()
    Dim myButton As Button
    On Error Resume Next
    Sheet1.Shapes(&quot;myButton&quot;).Delete
    Set myButton = Sheet1.Buttons.Add(108, 72, 108, 27)
    With myButton
        .Name = &quot;myButton&quot;
        .Font.Size = 12
        .Font.ColorIndex = 5
        .Characters.Text = &quot;新建的按钮&quot;
        .OnAction = &quot;myButton&quot;
    End With
End Sub
Sub myButton()
    MsgBox &quot;这是使用Add方法新建的按钮!&quot;
End Sub
代码解析：
AddChartObjects过程使用Add方法在工作表中添加窗体控件。
第3、4行代码为了避免在工作表中重复添加按钮控件，先删除工作表中的“myButton”按钮。
第5行代码，使用Add方法在工作表中添加命令按钮控件，Add方法适用于ChartObjects对象的语法如下：
expression.Add(Left, Top, Width, Height)
参数expression是必需的，该表达式返回一个ChartObjects对象。
如果需要在工作表中添加其他窗体控件，可以将参数expression设置为表格 128 2所示的ChartObjects对象之一。
类型    ChartObjects对象
复选框    CheckBoxes
组合框    DropDowns
标签    Labels
列表框    ListBoxes
选项按钮    OptionButtons
滚动条    ScrollBars
微调项    Spinners
表格 128 2    ChartObjects对象
参数Left和Top是必需的，以磅为单位给出新对象的初始坐标，该坐标是相对于工作表上单元格 A1 的左上角或图表的左上角的坐标。
参数Width和参数Height是必需的，以磅为单位给出新对象的初始大小。
第7行代码将新添加的按钮的名称设置为“myButton”。
第8行到第10代码新添加的按钮的文字设置为“新建的按钮”并设置文字的大小和颜色。
第11行代码，指定新添加命令按钮所执行的宏名称。
myButton过程是单击新添加按钮所执行的过程，显示一个消息框。
运行AddChartObjects过程将在工作表中添加一个命令按钮，单击按钮显示一个消息框，如图 128 2所示。</code></pre>
<h3 id="技巧129-在工作表中添加ActiveX控件"><a href="#技巧129-在工作表中添加ActiveX控件" class="headerlink" title="技巧129     在工作表中添加ActiveX控件"></a>技巧129     在工作表中添加ActiveX控件</h3><p>技巧128 中使用代码在工作表中添加的是窗体控件，而本例中使用代码在工作表中添加的是ActiveX控件，两者是有区别的，在工作表中前者是使用窗体对话框添加，而后者是使用控件工具箱添加，如图 129 1所示。 </p>
<p>图 129 1    窗体控件和ActiveX控件的区别</p>
<h4 id="129-1-使用Add方法"><a href="#129-1-使用Add方法" class="headerlink" title="129-1    使用Add方法"></a>129-1    使用Add方法</h4><p>使用Add方法在工作表中添加ActiveX控件，如下面的代码所示。</p>
<pre><code class="vb">Sub AddObj()
    Dim Obj As New OLEObject
    On Error Resume Next
    Sheet1.OLEObjects(&quot;MyButton&quot;).Delete
    Set Obj = Sheet1.OLEObjects.Add(ClassType:=&quot;Forms.CommandButton.1&quot;, _
            Left:=108, Top:=72, Width:=108, Height:=27)
    With Obj
        .Name = &quot;MyButton&quot;
        .Object.Caption = &quot;新建的按钮&quot;
        .Object.Font.Size = 16
        .Object.ForeColor = &amp;HFF&amp;
    End With
    With ActiveWorkbook.VBProject.VBComponents(Sheet1.CodeName).CodeModule
        If .Lines(1, 1) &lt;&gt; &quot;Option Explicit&quot; Then
            .InsertLines 1, &quot;Option Explicit&quot;
        End If
        If .Lines(2, 1) = &quot;Private Sub MyButton_Click()&quot; Then Exit Sub
        .InsertLines 2, &quot;Private Sub MyButton_Click()&quot;
        .InsertLines 3, vbTab &amp; &quot;MsgBox &quot;&quot;这是使用Add方法新建的按钮!&quot;&quot;&quot;
        .InsertLines 4, &quot;End Sub&quot;
    End With
End Sub
代码解析：
AddOLEObject过程使用Add方法在向工作表中添加ActiveX控件中的命令按钮和相应的代码。
第3、4行代码为了避免在工作表中重复添加按钮控件，先删除工作表中的名称为“myButton”的按钮。
第5、6行代码，使用Add方法在向工作表中添加ActiveX控件中的命令按钮，Add方法应用于OLEObjects 对象的语法如下：
expression.Add(ClassType, FileName, Link, DisplayAsIcon, IconFileName, IconIndex, IconLabel, Left, Top, Width, Height)
其中参数expression是必需的，返回一个 OLEObjects 对象。
参数ClassType是可选的，创建的对象的程序标识符。如果指定了 ClassType参数，则忽略FileName参数和Link参数。
在本例中指定添加控件的程序标识符为“Forms.CommandButton.1”，即命令按钮控件，关于对象的程序标识符请参阅技巧119-3。
参数Left和参数Top是必需的，以磅为单位给出新对象的初始坐标，该坐标是相对于工作表上单元格 A1 的左上角或图表的左上角的坐标。
参数Width和参数Height是可选的，以磅为单位给出OLE对象的初始大小。
第8行代码，设置命令按钮的名称为“MyButton”。
第9行代码，设置命令按钮的文字为“新建的按钮”
第10行代码，设置命令按钮的文字的大小。
第11行代码，设置命令按钮的文字的颜色。
第13行到第21行代码，在工作表中写入新添加的命令按钮的单击事件代码。
ActiveX控件不能像窗体控件用OnAction属性来指定宏，需要使用CodeModule对象的InsertLines方法在工作表中插入代码。
应用于CodeModule对象的InsertLines方法的语法如下：
object.InsertLines(line, code)
参数object是必需的，一个有效的对象。
参数line是必需的，用来指定要插入代码的位置。
参数code是必需的，要插入的代码。
第14行到第16行代码判断首行内容是否为要求变量声明，如不是则添加要求变量声明语句。
第17行到第20行代码判断是否已存在相同名称的过程，如不存在则使用InsertLines方法在工作表中插入代码。
运行AddOLEObject过程，将在工作表中添加一个命令按钮和相应的代码，单击按钮显示一个消息框，如图 129 2所示。

图 129 2    使用Add方法添加ActiveX控件</code></pre>
<h4 id="129-2-使用AddOLEObject方法"><a href="#129-2-使用AddOLEObject方法" class="headerlink" title="129-2    使用AddOLEObject方法"></a>129-2    使用AddOLEObject方法</h4><p>在工作表中添加ActiveX控件，还可以使用AddOLEObject方法，如下面的代码所示。</p>
<pre><code class="vb">Sub AddShapes()
    Dim ShpBut As Shape
    On Error Resume Next
    Sheet1.OLEObjects(&quot;MyButton&quot;).Delete
    Set ShpBut = Sheet1.Shapes.AddOLEObject(ClassType:=&quot;Forms.CommandButton.1&quot;, _
            Left:=108, Top:=72, Width:=108, Height:=27)
            ShpBut.Name = &quot;MyButton&quot;
    With ActiveWorkbook.VBProject.VBComponents(Sheet1.CodeName).CodeModule
        If .Lines(1, 1) &lt;&gt; &quot;Option Explicit&quot; Then
            .InsertLines 1, &quot;Option Explicit&quot;
        End If
        If .Lines(2, 1) = &quot;Private Sub MyButton_Click()&quot; Then Exit Sub
        .InsertLines 2, &quot;Private Sub MyButton_Click()&quot;
        .InsertLines 3, vbTab &amp; &quot;MsgBox &quot;&quot;这是使用AddOLEObject方法新建的按钮!&quot;&quot;&quot;
        .InsertLines 4, &quot;End Sub&quot;
    End With
End Sub
代码解析：
AddShapes过程使用AddOLEObject方法在向工作表中添加ActiveX控件中的命令按钮和相应的代码。
第5、6行代码，使用AddOLEObject方法在向工作表中添加ActiveX控件中的命令按钮，AddOLEObject方法创建OLE对象，语法如下：
expression.AddOLEObject(ClassType, FileName, Link, DisplayAsIcon, IconFileName, IconIndex, IconLabel, Left, Top, Width, Height)
AddOLEObject方法参数与Add方法类似，请参阅技巧129-1。
运行AddShapes过程，将在工作表中添加一个命令按钮和相应的代码，单击按钮显示一个消息框，如图 129 3所示。

图 129 3    使用AddOLEObject方法添加ActiveX控件</code></pre>
<h3 id="技巧130-使用spreadsheet控件"><a href="#技巧130-使用spreadsheet控件" class="headerlink" title="技巧130     使用spreadsheet控件"></a>技巧130     使用spreadsheet控件</h3><p>如果希望在窗体中显示类似工作表的表格，并且可以像工作表一样进行操作，那么可以在窗体中使用表格控件（Spreadsheet控件）。<br>步骤1，在VBE窗口中单击菜单“插入”→“用户窗体”，在窗体上添加一个Spreadsheet控件，双击窗体，在其代码窗口中输入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim iRow As Integer
    Dim arr As Variant
    With Me.Spreadsheet1
        .DisplayToolbar = False
        .DisplayHorizontalScrollBar = False
        .DisplayVerticalScrollBar = False
        .DisplayWorkbookTabs = False
        iRow = Sheet1.Range(&quot;B65536&quot;).End(xlUp).Row
        arr = Sheet1.Range(&quot;B2:H&quot; &amp; iRow)
        With .Range(&quot;B2:H&quot; &amp; iRow)
            .Value = arr
            .Borders.LineStyle = xlContinuous
            .Borders.Weight = xlMedium
            .Borders.ColorIndex = 10
        End With
        With .Range(&quot;B2:H2&quot;)
            .HorizontalAlignment = -4108
            .VerticalAlignment = -4108
            .Interior.ColorIndex = 44
        End With
        .Range(&quot;B3:B&quot; &amp; iRow).HorizontalAlignment = -4108
        .Range(&quot;C3:H&quot; &amp; iRow).NumberFormat = &quot;0.00&quot;
        .Rows(2).RowHeight = 23.25
        .Columns(&quot;A&quot;).ColumnWidth = 2.75
        .Columns(&quot;B:H&quot;).ColumnWidth = 8
    End With
End Sub
代码解析：
用户窗体的初始化事件过程，使用窗体显示工作表中的表格。
第5行代码，设置Spreadsheet控件不显示工具栏。
DisplayToolbar 属性设置工具栏是否隐藏，语法如下：
expression.DisplayToolbar
参数expression是必需的，一个有效的对象。
如果指定电子表格、图表区或“数据透视表”列表显示了工具栏，则返回True。
第6、7行代码，设置Spreadsheet控件不显示水平和垂直滚动条。
第8行代码，设置Spreadsheet控件不显示工作表标签。
第9行代码，取得工作表B列有数据的最后一行的行号。
第10行代码，把工作表数据赋值给数组。
第11行到16行代码，把数组赋给Spreadsheet控件的单元格，使Spreadsheet控件显示工作表内容，并且添加加框线。
第17行到第21行代码，设置Spreadsheet控件中表格第一行的字体对齐方式为居中并添加单元格的底纹颜色。
第22行代码，设置Spreadsheet控件中表格第一列的字体对齐方式为居中。
第23行代码，设置Spreadsheet控件中表格数据的格式。
第24行到26行代码，设置Spreadsheet控件的行高与列宽。</code></pre>
<p>步骤2，在窗体上添加一个按钮控件，将其Caption属性设置为“保存”，双击按钮控件，在其代码窗口中输入下面的代码：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim iRow As Integer
    Dim arr As Variant
    If MsgBox(&quot;是否保存对表格所作的修改?&quot;, 4 + 32) = 6 Then
        With Me.Spreadsheet1
            iRow = .Range(&quot;B65536&quot;).End(xlUp).Row
            arr = .Range(&quot;B2:H&quot; &amp; iRow).Value
            Sheet1.Range(&quot;B2:H&quot; &amp; iRow).Value = arr
        End With
    End If
    Unload Me
End Sub
代码解析：
用户窗体中“保存”按钮的单击过程，把在窗体中对数据的修改重新保存到工作表。
第4行代码，询问用户是否保存修改。
第5行到第10行代码，如果用户选择保存，把Spreadsheet控件中的数据保存到工作表。
运行窗体，显示效果如图 130 1所示。

图 130 1    使用Spreadsheet控件</code></pre>
<h3 id="技巧131-使用Listview控件"><a href="#技巧131-使用Listview控件" class="headerlink" title="技巧131     使用Listview控件"></a>技巧131     使用Listview控件</h3><p>ListView控件是VBA程序开发中的常用控件，可以用来显示各项带图标的列表，也可以用来显示带有子项的列表。</p>
<h4 id="131-1-使用Listview控件显示数据列表"><a href="#131-1-使用Listview控件显示数据列表" class="headerlink" title="131-1    使用Listview控件显示数据列表"></a>131-1    使用Listview控件显示数据列表</h4><p>使用Listview控件在用户窗体中显示数据列表，代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Itm As ListItem
    Dim r As Integer
    Dim c As Integer
    With ListView1
        .ColumnHeaders.Add , , &quot;人员编号 &quot;, 50, 0
        .ColumnHeaders.Add , , &quot;技能工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;岗位工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;工龄工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;浮动工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;其他  &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;应发合计&quot;, 50, 1
        .View = lvwReport
        .Gridlines = True
        For r = 2 To Sheet1.[A65536].End(xlUp).Row
            Set Itm = .ListItems.Add()
            Itm.Text = Space(2) &amp; Sheet1.Cells(r, 1)
            For c = 1 To 6
                Itm.SubItems(c) = Format(Sheet1.Cells(r, c + 1), &quot;##,#,0.00&quot;)
            Next
        Next
        End With
    Set Itm = Nothing
End Sub
代码解析：
窗体的初始化事件，在窗体显示时将工作表中数据显示在Listview控件中。
第6行到第12行代码，使用ColumnHeader对象的Add方法在Listview控件中添加标题列，并设置列标题、列宽和文本对齐方式。
ColumnHeader对象是ListView控件中包含标题文字的项目，应用于ColumnHeader对象的Add方法语法如下：
object.ColumnHeader.Add(index,key,text,width,alignment)
其中参数text代表标题文字，参数width代表标题的列宽，参数alignment代表列标题中文本对齐方式。Listview控件中文本的对齐方法有三种，如表格 131 1所示。
常数    值    说明
lvwColumnLeft    0    文本向左对齐。（缺省值）
lvwColumnRight    1    文本向右对齐。
lvwColumnCenter    2    文本居中对齐。
表格 131 1    Listview控件中文本的对齐方法
在Listview控件中第一列的文本对齐方式只能设置为左对齐。
第13行代码，设置Listview控件的View属性为lvwReport，使Listview控件显示为报表型。View属性决定在列表中控件使用何种视图显示项目，语法如下：
object.view [= value]
参数object是必需的，对象表达式，listview控件。
参数value是必需的，指定控件外观的整数或常数，如表格 131 2所示。
常数    值    说明
lvwicon    0    图标
lvwsmallicon    1    小图标
lvwlist      2    列表
lvwreport    3    报表
表格 131 2    View属性的设置值
第14行代码，设置Listview控件的Gridlines属性为True，显示网格线。只有在将View属性设置为lvwReport时才能显示网格线，否则Gridlines属性无效。
第16行代码，使用ListItem对象的Add方法在Listview控件中添加项目。应用于ListItem对象的Add方法语法如下：
ListItems.Add(index,key,text,icon,smallIcon)
其中参数text代表添加的项目内容。
第17行代码，添加行标题。ListItem对象的text属性代表Listview控件的第一列内容，因为Listview控件的第一列的文本对齐方式只能设置为左对齐，所以在添加时使用Space函数插入两个空格，使行标题达到居中显示的效果。
第18行到20行代码，继续添加其他列的内容。Listview控件其他列的项目需要使用SubItems属性来添加。
运行窗体，Listview控件显示工作表中的内容，如图 131 1所示。

图 131 1    使用Listview控件显示数据</code></pre>
<h4 id="131-2-在Listview控件中使用复选框"><a href="#131-2-在Listview控件中使用复选框" class="headerlink" title="131-2    在Listview控件中使用复选框"></a>131-2    在Listview控件中使用复选框</h4><p>在Listview控件中使用复选框，可以进行多重选择，示例代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Itm As ListItem
    Dim r As Integer
    Dim c As Integer
    With ListView1
        .ColumnHeaders.Add , , &quot;人员编号 &quot;, 50, 0
        .ColumnHeaders.Add , , &quot;技能工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;岗位工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;工龄工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;浮动工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;其他  &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;应发合计&quot;, 50, 1
        .View = lvwReport
        .Gridlines = True
        .FullRowSelect = True
        .CheckBoxes = True
        For r = 2 To Sheet2.[A65536].End(xlUp).Row - 1
            Set Itm = .ListItems.Add()
            Itm.Text = Sheet2.Cells(r, 1)
            For c = 1 To 6
                Itm.SubItems(c) = Format(Sheet2.Cells(r, c + 1), &quot;##,#,0.00&quot;)
            Next
        Next
        End With
    Set Itm = Nothing
End Sub
Private Sub CommandButton1_Click()
    Dim r As Integer
    Dim i As Integer
    Dim c As Integer
    r = Sheet1.[A65536].End(xlUp).Row
    If r &gt; 1 Then Sheet1.Range(&quot;A2:G&quot; &amp; r) = &quot;&quot;
    With ListView1
        For i = 1 To .ListItems.Count
            If .ListItems(i).Checked = True Then
                Sheet1.Range(&quot;A65536&quot;).End(xlUp).Offset(1, 0) = .ListItems(i)
                For c = 1 To 6
                    Sheet1.Cells(65536, c + 1).End(xlUp).Offset(1, 0) = .ListItems(i).SubItems(c)
                Next
            End If
        Next
    End With
End Sub
代码解析：
第1行到第26行代码，用户窗体的Initialize事件过程，在窗体显示时将工作表中数据显示在Listview控件中，请参阅技巧0。
其中第15行代码设置Listview控件的FullRowSelect属性为True，使用户可以选择整行。
第16行代码设置Listview控件的CheckBoxes属性为True，使Listview控件在列表的每个项的旁边显示复选框。
第27行到第43行代码，用户窗体中“保存”按钮的单击过程，将Listview控件中选中的项目写入到工作表中。
第31、32行代码，删除工作表中原有的数据，
第34、35行代码遍历Listview控件中所有的ListItem对象，判定其Checked值，如果为True，即说明其处于选中状态。
第36行到第40行代码将Listview控件中选中的内容依次写入到工作表中。
运行窗体，Listview控件显示工作表中的内容，单击“保存”按钮将如Listview控件中选中的内容依次写入到工作表中，如图 131 2所示。

图 131 2    Listview控件使用复选框</code></pre>
<h4 id="131-3-调整Listview控件的行距"><a href="#131-3-调整Listview控件的行距" class="headerlink" title="131-3    调整Listview控件的行距"></a>131-3    调整Listview控件的行距</h4><p>在使用Listview控件显示数据列表时，行距是由Listview控件所设置的字体大小决定的，无法自定义行距，即使调整了字体大小，行距还是很近。<br>如果需要自定义Listview控件的行距，可以在窗体中添加一个ImageList控件，在ImageList控件中导入一张大小合适的空白图片，然后指定Listview控件的SmallIcons属性为ImageList控件中的图片，代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Itm As ListItem
    Dim r As Integer
    Dim c As Integer
    Dim Img As ListImage
    With ListView1
        .ColumnHeaders.Add , , &quot;人员编号 &quot;, 50, 0
        .ColumnHeaders.Add , , &quot;技能工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;岗位工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;工龄工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;浮动工资 &quot;, 50, 1
        .ColumnHeaders.Add , , &quot;其他  &quot;, 50, 1#013          .ColumnHeaders.Add , , &quot;应发合计&quot;, 50, 1
        .View = lvwReport
        .Gridlines = True
        .FullRowSelect = True
        Set Img = ImageList1.ListImages.Add(, , LoadPicture(ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;1×25.bmp&quot;))
        .SmallIcons = ImageList1
        For r = 2 To Sheet1.[A65536].End(xlUp).Row - 1
            Set Itm = .ListItems.Add()
            Itm.Text = Space(2) &amp; Sheet1.Cells(r, 1)
            For c = 1 To 6
                Itm.SubItems(c) = Format(Sheet1.Cells(r, c + 1), &quot;##,#,0.00&quot;)
            Next
        Next
    End With
    Set Itm = Nothing
    Set Img = Nothing
End Sub
代码解析：
用户窗体的Initialize事件过程，在窗体显示时将工作表中数据显示在Listview控件中并调整Listview控件的行距。
第17行代码使用Add方法在ImageList控件中添加图片。ImageList控件是一个向其他控件提供图像的资料中心，它包含了一组ListImage对象即一组图像的集合，该集合中的每个对象都可以通过其索引或关键字被其他控件所引用，但控件本身并不能单独使用。
在运行时给ImageList控件添加图片需要使用Add方法，语法如下：
Add(index,key,picture)
参数index是可选的，整数，指定要插入的ListImage对象的位置。如果没有指定index，ListImage对象将被添加到ListImages集合的末尾。
参数key是可选的，用来标识ListImage对象的唯一字符串。
参数picture是必需的，指定欲添加到集合中的图片。
也可以在设计时在ImageList控件中添加图片，这样就无需在文件夹中保留图片文件。在VBE中选择ImageList控件属性页中的“自定义”，在显示的“属性页”对话框中插入图片，如图 131 3所示。

图 131 3    在ImageList控件中添加图片
第18行代码，指定Listview控件的SmallIcons属性为ImageList控件中的图片，使用图片来调整行距。
运行窗体，Listview控件显示工作表中的内容，调整Listview控件的行距，如图 131 4所示。

图 131 4    调整Listview控件的行距</code></pre>
<h4 id="131-4-在Listview控件中排序"><a href="#131-4-在Listview控件中排序" class="headerlink" title="131-4    在Listview控件中排序"></a>131-4    在Listview控件中排序</h4><p>在使用Listview控件显示报表型的数据时，可能通过单击Listview控件的列标题对列表数据进行排序，代码如下：</p>
<pre><code class="vb">Private Sub ListView1_ColumnClick(ByVal ColumnHeader As MSComctlLib.ColumnHeader)
    With ListView1
        .Sorted = True
        .SortOrder = (.SortOrder + 1) Mod 2
        .SortKey = ColumnHeader.Index - 1
    End With
End Sub
代码解析：
Listview控件的ColumnClick事件过程，单击列标题时触发，对列表数据进行升序或降序排序。
第3行代码将Listview控件的Sorted属性设置为True。Sorted属性返回或设置确定ListView控件中的ListItem对象是否排序，设置为False则不进行排序。
第4行代码设置Listview控件的排序方式。SortOrder属性返回或设置一个值，决定ListView控件中的ListItem对象以升序或降序排序，设置为0以升序排序，设置为1则以降序排序。在设置SortOrder属性值时使用Mod运算符以达到第一次排序以降序排序，再次排序时以升序排序，交替进行的效果。
第5行代码设置Listview控件排序关键字的整数，即指定Listview控件以当前选定的列数据进排序。SortKey属性返回或设置一个值，此值决定ListView控件中的ListItem对象如何排序，语法如下：
object.SortKey [=integer]
参数object是必需的，对象表达式，其值为ListView控件。
参数integer是必需的，指定排序关键字的整数，设置为0使用ListItem对象的Text属性排序，即第一列的数据进行排序。设置为大于0的整数则使用子项目的集合索引排序。
运行窗体，Listview控件显示工作表中的内容，单击列标题对列表数据进行升序或降序排序，如图 131 5所示。

图 131 5    在Listview控件中排序
#### 131-5    Listview控件的图标设置
ListView 控件作为一个可以显示图标或者子项的列表控件，可以在控件中显示自定义的图标，它最重要的属性就是View 属性，该属性决定了以哪种视图模式显示控件的项，请参阅技巧131-1。
在ListView 控件中显示图标，需要在用户窗体中添加一个ImageList控件用于保存图像文件。关于ImageList控件的使用请参阅技巧131-3。</code></pre>
<p>以大图标模式显示ListView控件的代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim ITM As ListItem
    Dim r As Integer
    With ListView1
        .View = lvwIcon
        .Icons = ImageList1
        For r = 2 To 6
            Set ITM = .ListItems.Add()
            ITM.Text = Cells(r, 1)
            ITM.Icon = r - 1
        Next
    End With
    Set ITM = Nothing
End Sub
代码解析：
在用户窗体中以大图标模式显示ListView控件，可使用鼠标拖放图标，并重新排列。
第5行代码将ListView控件的View属性设置为lvwIcon，大图标视图模式。
第6行代码使用ListView控件的Icons 属性建立与ImageList控件的关联。
第7行到第11行代码在ListView控件中添加ListItem对象，其中第10行代码设置使用ListItem对象的Icon属性指定其图像文件在ImageList控件中的编号。
ListView控件以大图标视图模式显示时如图 131 6所示。

图 131 6    大图标视图模式</code></pre>
<p>以小图标模式显示ListView控件的代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim ITM As ListItem
    Dim r As Integer
    With ListView1
        .View = lvwSmallIcon
        .SmallIcons = ImageList1
        For r = 2 To 6
            Set ITM = .ListItems.Add()
            ITM.Text = Sheet1.Cells(r, 1)
            ITM.SmallIcon = r - 1
        Next
    End With
    Set ITM = Nothing
End Sub
代码解析：
在用户窗体中以小图标模式显示ListView控件，可使用鼠标拖放图标，并重新排列。
第5行代码将ListView控件的View属性设置为lvwSmallIcon，小图标视图模式。
与大图标视图模式有所不同的是，当使用小图标视图模式时需要使用ListView控件的SmallIcons属性建立与ImageList控件的关联，使用ListItem对象的SmallIcon属性指定其图像文件在ImageList控件中的编号。
ListView控件以小图标视图模式显示时如图 131 7所示。

图 131 7    小图标视图模式
将ListView控件的View属性设置为lvwList，以列表视图模式显示，如图 131 8所示。

图 131 8    列表视图模式
将ListView控件的View属性设置为lvwReport，以报表视图模式显示，如图 131 9所示。

图 131 9    报表视图模式</code></pre>
<h3 id="技巧132-调用非模式窗体"><a href="#技巧132-调用非模式窗体" class="headerlink" title="技巧132     调用非模式窗体"></a>技巧132     调用非模式窗体</h3><p>在VBA中显示用户窗体需要使用Show方法，Show方法显示窗体对象，语法如下：<br>[object.]Show modal<br>参数object是可选的，对象表达式。如果省略掉object，则将与活动的窗体模块相关联的窗体当作object。<br>参数modal是可选的，决定窗体是模态的还是非模式的。Modal参数的设置值如表格 132 1所示。<br>常数    值    描述<br>vbModal    1    UserForm是模态的，缺省值。<br>vbModeless    0    UserForm是非模式的。<br>表格 132 1    modal参数的设置值<br>当窗体显示时是模态时，用户在使用应用程序的其它部分之前，必须先对其作出响应。在隐藏或卸载窗体之前，后续代码不会被执行。<br>比如下面的代码，希望在显示窗体的同时给单元格赋值，但因为窗体显示为模态的，在窗体没有关闭之前，给单元格赋值的代码是不会执行的，所以达不到显示窗体的同时给单元格赋值的目的。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    Columns(1).ClearContents
    UserForm1.Show 0
    For i = 1 To 1000
        Cells(i, 1) = i
    Next
End Sub
只有在窗体显示为非模式时，后续代码才一出现即被执行。模态下是无法操作工作表的，所以应将第4行代码改成如下的代码，才能在显示窗体的同时给单元格赋值，如图 132 1所示。
UserForm1.Show 0

图 132 1    调用非模式窗体</code></pre>
<h3 id="技巧133-进度条的制作"><a href="#技巧133-进度条的制作" class="headerlink" title="技巧133     进度条的制作"></a>技巧133     进度条的制作</h3><p>如果程序执行时间较长，使用进度条能让用户知道程序执行到何种程度，大约需等待多长时间，可以使界面显得友好。</p>
<h4 id="133-1-使用进度条控件"><a href="#133-1-使用进度条控件" class="headerlink" title="133-1    使用进度条控件"></a>133-1    使用进度条控件</h4><p>使用窗体加进度条控件（ProgressBar）制作进度条是最常用的方法。<br>在VBE窗口中单击菜单“插入”→“用户窗体”，在窗体上添加一个进度条控件，调整为合适的大小，如图 133 1所示。</p>
<p>图 133 1    使用ProgressBar控件<br>在工作表中添加一个命令按钮，双击后写入下面的代码。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim i As Integer
    UserForm1.Show 0
    With UserForm1.ProgressBar1
        .Min = 1
        .Max = 10000
        .Scrolling = 0
        For i = 1 To 10000
            Cells(i, 1) = i
            .Value = i
            UserForm1.Caption = &quot;正在运行,已完成&quot; &amp; i / 100 &amp; &quot;%,请稍候!&quot;
        Next
    End With
    Unload UserForm1
    Columns(1).ClearContents
End Sub
代码解析：
工作表中命令按钮的单击事件，在给工作表A1到A10000单元格赋值的同时使用进度条显示其运行速度。
第3行代码，使用Show方法显示进度条控件所在的窗体，并且设置为无模式显示，请参阅技巧132 。
第5、6行代码，设置进度条控件的最小值和最大值，应与第8行代码中的循环计数器的start参数和End参数相一致。
第7行代码，设置进度条控件显示为有间隔的。如果将Scrolling属性设置为1则显示为无间隔的。
第9行代码，在单元格中进行无意义的填充数据以演示进度条。在实际应用中可以将进度条嵌入到程序的循环中。
第11行代码，在窗体的标题栏中显示已完成的百分比。
第14行代码，使用Unload 语句卸载窗体。
Unload 语句从内存中删除一个对象，语法如下：
Unload object
参数object参数是必需的，一个有效的对象。
第19行代码，清空A列填充的数据。
单击工作表中的命令按钮，填充单元格并显示进度条，如图 133 2所示。</code></pre>
<h4 id="133-2-使用标签控件"><a href="#133-2-使用标签控件" class="headerlink" title="133-2    使用标签控件"></a>133-2    使用标签控件</h4><p>在窗体中使用标签可以制作双色的进度条。<br>步骤1，在VBE窗口中单击菜单“插入”→“用户窗体”，在窗体上添加一个框架控件，在框架控件中添加两个标签控件。<br>步骤2，在控件的属性窗口中将框架的BackColor 属性设为&amp;H000000FF&amp;，使框架的背景色为红色。将标签1的BackColor属性设为&amp;H0000C000&amp;，使标签1的背景色为绿色。将标签2的BackStyle属性设为fmBackStyleTransparent，使标签2的背景为透明，并把它们的Caption属性全部设置为空白。<br>步骤3，将窗体和控件调整为合适的大小，如图 133 3所示。</p>
<p>图 133 3    制作标签进度条</p>
<p>步骤4，在VBE中双击窗体，写入下面的代码。</p>
<pre><code class="vb">Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal Hwnd As Long) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Const GWL_STYLE As Long = (-16)
Private Const GWL_EXSTYLE = (-20)
Private Const WS_CAPTION As Long = &amp;HC00000
Private Sub UserForm_Initialize()
    Dim IStyle As Long
    Dim Hwnd As Long
    If Val(Application.Version) &lt; 9 Then
        Hwnd = FindWindow(&quot;ThunderXFrame&quot;, Me.Caption)
    Else
        Hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    End If
    IStyle = GetWindowLong(Hwnd, GWL_STYLE)
    IStyle = IStyle And Not WS_CAPTION
    SetWindowLong Hwnd, GWL_STYLE, IStyle
    DrawMenuBar Hwnd
    UserForm1.Height = 28
End Sub
代码解析：
窗体的初始化事件，在窗体加载时使用API函数去除其标题栏。
第1行到第7行代码，API函数的声明。
第11行到第15行代码，获取窗口句柄。
第16行到第19行代码，去除窗体标题栏。
第20行代码，设置窗体的高度。
步骤5，在工作表中添加一个命令按钮，双击后写入下面的代码。</code></pre>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim n As Integer
    Dim i As Integer
    n = 10000
    With UserForm1
        .Show 0
        For i = 1 To n
            Cells(i, 1) = i
            .Label1.Width = i / n * .Frame1.Width
            .Label2.Caption = &quot;已完成&quot; &amp; Round(i / n * 100, 0) &amp; &quot;%&quot;
            .Label2.Left = .Label1.Width - 50
            DoEvents
        Next
    End With
    Unload UserForm1
    Range(&quot;A1:A&quot; &amp; n).ClearContents
End Sub
代码解析：
工作表中命令按钮的单击事件，在给工作表A1到A10000单元格赋值的同时使用进度条显示其运行速度。
第4行代码，设置循环最大值，可根据实际需要设置。
第6行代码，使用Show方法显示窗体，并且设置为无模式的。
第8行代码，在单元格中进行无意义的填充数据以演示进度条。
第9行代码，根据程序运行程度动态设置标签1的宽度，使之达到进度条的效果。
第10行代码，标签2显示已完成百分比。
第11行代码，根据标签1的宽度动态设置标签2的Left属性，使已完成百分比跟随标签1移动。
第12行代码，使用DoEvents函数转让控制权。DoEvents函数将控制权传给操作系统。当操作系统处理完队列中的事件，并且在 SendKeys队列中的所有键也都已送出之后，返回控制权。如果不使用DoEvents函数转让控制权，进度条不能正常显示。
第15行代码，使用Unload 语句卸载窗体。
单击工作表中的命令按钮，填充单元格并显示进度条，如图 133 4所示。

图 133 4    标签进度条</code></pre>
<h3 id="技巧134-使用TreeView控件显示层次"><a href="#技巧134-使用TreeView控件显示层次" class="headerlink" title="技巧134     使用TreeView控件显示层次"></a>技巧134     使用TreeView控件显示层次</h3><p>TreeView控件是一个树形结构的控件，该控件用于显示分层数据，如目录或文件目录，使程序的表现更为灵活，用户的操作更加方便，示例代码如下：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim c As Integer
    Dim r As Integer
    Dim rng As Variant
    rng = Sheet1.UsedRange
    With Me.TreeView1
        .Style = tvwTreelinesPlusMinusPictureText
        .LineStyle = tvwRootLines
        .CheckBoxes = False
        With .Nodes
            .Clear
            .Add Key:=&quot;科目&quot;, Text:=&quot;科目名称&quot;
            For c = 1 To Sheet1.UsedRange.Columns.Count
                For r = 2 To Sheet1.UsedRange.Rows.Count
                    If Not IsEmpty(rng(r, c)) Then
                        If c = 1 Then
                            .Add relative:=&quot;科目&quot;, relationship:=tvwChild, Key:=rng(r, c), Text:=rng(r, c)
                        ElseIf Not IsEmpty(rng(r, c - 1)) Then
                            .Add relative:=rng(r, c - 1), relationship:=tvwChild, Key:=rng(r, c), Text:=rng(r, c)
                        Else
                            .Add relative:=CStr(Sheet1.Cells(r, c - 1).End(xlUp)), relationship:=tvwChild, Key:=rng(r, c), Text:=rng(r, c)
                        End If
                    End If
                Next
            Next
        End With
    End With
End Sub
代码解析：
在窗体初始化时将工作表中的科目名称填充TreeView控件。
第7行代码，设置TreeView控件每个列表的组成方式。Style属性设置值如表格 131 2所示。
常量    值    描述
tvwTextOnly    0    文本
tvwPictureText    1    图像文本
tvwPlusMinusText    2    符号文本
tvwTreelinesText    4    直线文本
tvwTreelinesPlusMinusPictureText    7    正常显示
表格 134 1    Style属性设置值
第8行代码，设置TreeView控件显示根节点连线。TreeView控件的LineStyle属性设置为tvwRootLines显示根节点连线，设置为tvwTreeLines则隐藏根节点连线。
第9行代码，设置TreeView控件不显示复选框。
第10行代码使用Nodes属性返回对TreeView控件的Node对象的集合的引用。
第11行代码，清除TreeView控件所有的节点。
第12行代码，使用Add方法在Treeview控件的Nodes集合中添加一个Node对象。，Add方法语法如下：
object.Add(relative, relationship, key, text, image, selectedimage)
参数Object是必需的，一个有效的对象。
参数Relative是可选的，代表已存在的Node对象的索引号或键值。
参数relationship是可选的，代表新节点与已存在的节点间的关系，指定的Node对象的相对位置。relationship的设置值如表格 134 2所示。
常量    值    说明
tvwFirst    0    首节点，该Node和在relative中被命名的节点位于同一层，并位于所有同层节点之前。
tvwLast    1    最后的节点，该Node和在relative中被命名的节点位于同一层，并位于所有同层节点之后。任何连续地添加的节点可能位于最后添加的节点之后。
tvwNext    2    下一个节点，该Node位于在relative中被命名的节点之后。
tvwPrevious    3    前一个节点，该Node位于在relative中被命名的节点之前。
tvwChild    4    子节点。该Node 为在relative中被命名的节点的子节点。
表格 134 2    relationship的设置值
参数key是可选的，唯一的字符串，可用于用Item方法检索Node。
参数text 是必需的，在Node中出现的字符串。
参数image是可选的，代表一个图像或在ImageList控件中图象的索引。
参数selectedimage是可选的，代表一个图像或在ImageList控件中图象的索引，在 Node被选中时显示。
第13行到第25行代码代，在根节点下添加子节点。添加子节点仍然使用Add方法，需要一个唯一的Key值，必须提供根节点的Key值（参数relative）和参数relationship值（tvwChild）。要将子节点链接到根节点的下面，参数relative必须与根节点的Key值一致，参数relationship必须设置为tvwchild。要使子节点有效，子节点必须也有自已唯一的Key值。
获得双击TreeView控件后的返回值的代码如下：
Private Sub TreeView1_DblClick()
    If TreeView1.SelectedItem.Children = 0 Then
        Sheet1.Range(&quot;A65536&quot;).End(xlUp).Offset(1) = TreeView1.SelectedItem.Text
    Else
        MsgBox &quot;所选择的不是末级科目,请重新选择科目!&quot;
    End If
End Sub
代码解析：
TreeView1_ DblClick过程是TreeView控件的双击事件，将所选的科目名称写入到工作表中。
第2行代码判断所选节点是否是末级科目。TreeView控件的SelectedItem属性返回当前所选择的节点，而Children属性检查所选节点是否还有子节点，如没有子节点则返回0。
运行窗体效果如图 134 1所示。

图 134 1    使用TreeView控件显示层次</code></pre>
<h3 id="技巧135-用户窗体添加图标"><a href="#技巧135-用户窗体添加图标" class="headerlink" title="技巧135     用户窗体添加图标"></a>技巧135     用户窗体添加图标</h3><p>窗体在显示时标题栏上是没有图标的，如果希望在窗体上添加图标，可以借助API函数在窗体显示时添加自定义的图标。<br>在VBE窗口中单击菜单“插入”→“用户窗体”，插入一个窗体，在窗体中添加一个Image控件，设置Image控件Picture属性为自定义图标的位图，并将Image控件的Visible属性设置为False，使窗体运行时隐藏Image控件，如图 135 1所示。</p>
<p>图 135 1    窗体中添加Image控件<br>在VBE中双击窗体，写入下面的代码。</p>
<pre><code class="vb">Private Declare Function SendMessage Lib &quot;user32&quot; Alias &quot;SendMessageA&quot; (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long
Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal hWnd As Long) As Long
Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Const WM_SETICON = &amp;H80
Private Const ICON_SMALL = 0&amp;
Private Const ICON_BIG = 1&amp;
Sub ChangeIcon(ByVal hWnd As Long, Optional ByVal hicon As Long = 0&amp;)
    SendMessage hWnd, WM_SETICON, ICON_SMALL, ByVal hicon
    SendMessage hWnd, WM_SETICON, ICON_BIG, ByVal hicon
    DrawMenuBar hWnd
End Sub
Private Sub UserForm_Initialize()
    Dim hWnd As Long
    hWnd = FindWindow(vbNullString, Me.Caption)
    Call ChangeIcon(hWnd, Image1.Picture.Handle)
End Sub
代码解析：
窗体的初始化事件，窗体在显示时运行ChangeIcon函数，在标题栏中添加图标。
第1行到第6行代码， API函数声明。
第7行到第11行代码，ChangeIcon过程，用于转换图标。
第14行代码，获得窗口句柄。
第15行代码，运行ChangeIcon过程，将Image控件中的位图显示在窗体的标题栏上。
运行窗体后，在窗体标题栏上添加图标，如图 135 2所示。

图 135 2    在窗体标题栏中添加图标</code></pre>
<h3 id="技巧136-用户窗体添加最大最小化按纽"><a href="#技巧136-用户窗体添加最大最小化按纽" class="headerlink" title="技巧136     用户窗体添加最大最小化按纽"></a>技巧136     用户窗体添加最大最小化按纽</h3><p>VBA中的窗体标题栏上只有关闭按纽，没有最大最小化按纽的，可以使用API函数在窗体的标题栏上添加最大最小化按纽，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hWnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hWnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Const WS_MAXIMIZEBOX = &amp;H10000
Private Const WS_MINIMIZEBOX = &amp;H20000
Private Const GWL_STYLE = (-16)
Private Sub UserForm_Initialize()
    Dim hWndForm As Long
    Dim iStyle As Long
    hWndForm = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    iStyle = GetWindowLong(hWndForm, GWL_STYLE)
    iStyle = iStyle Or WS_MINIMIZEBOX
    iStyle = iStyle Or WS_MAXIMIZEBOX
    SetWindowLong hWndForm, GWL_STYLE, iStyle
End Sub
代码解析：
窗体初始化时使用API函数在标题栏上添加最大最小化按纽。
第1行到第6行代码，API函数声明。
第10行代码，获取窗口句柄。
第11行到第14行代码，在标题栏上添加最大最小化按纽。
运行窗体后效果如图 136 1所示。

图 136 1    标题栏上添加最大最小化按纽</code></pre>
<h3 id="技巧137-禁用窗体标题栏的关闭按钮"><a href="#技巧137-禁用窗体标题栏的关闭按钮" class="headerlink" title="技巧137     禁用窗体标题栏的关闭按钮"></a>技巧137     禁用窗体标题栏的关闭按钮</h3><p>如果不希望用户通过窗体标题栏的关闭命令来关闭窗体，可以禁用窗体标题栏上的关闭按钮，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    If CloseMode &lt;&gt; 1 Then
        Cancel = True
        MsgBox &quot;请点击按钮关闭窗体!&quot;
    End If
End Sub
代码解析：
窗体的QueryClose事件，禁用窗体标题栏上的关闭按钮。
窗体的QueryClose事件发生在窗体关闭之前，语法如下：
Private Sub UserForm_QueryClose(cancel As Integer, closemode As Integer)
参数Cance是可选的，整数。将此参数设置成 0 以外的任意值，在所有加载的用户窗体中停止QueryClose事件，并防止关闭窗体与应用程序。
参数closemode是可选的，一个值或常数，用来指示引起QueryClose事件的原因。
closemode参数的设置值如表格 137 1所示。
常数    值    描述
vbFormControlMenu    0    用户在 UserForm上选择“控制”菜单中的“关闭”命令
VbFormCode    1    由代码调用 Unload 语句
vbAppWindows    2    正在结束当前 Windows 操作环境的过程。(仅用于Visual Basic 5.0 )
vbAppTaskManager    3    Windows 的“任务管理器”正在关闭这个应用。(仅用于Visual Basic 5.0 )
表格 137 1    closemode 参数
第2、3行代码，如果窗体不是由代码调用Unload语句关闭，则停止关闭过程，从而禁用窗体标题栏的关闭按钮。
需要注意的是，一定要在窗体上设置关闭窗体的途径，否则会使窗体无法关闭。
窗体运行后，禁用窗体上的关闭按钮关闭窗体，只能使用按钮关闭窗体，如图 137 1所示。

图 137 1    禁用窗体标题栏的关闭命令</code></pre>
<h3 id="技巧138-屏蔽窗体标题栏的关闭按钮"><a href="#技巧138-屏蔽窗体标题栏的关闭按钮" class="headerlink" title="技巧138     屏蔽窗体标题栏的关闭按钮"></a>技巧138     屏蔽窗体标题栏的关闭按钮</h3><p>使用API函数可以屏蔽窗体标题栏的关闭按钮，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal Hwnd As Long) As Long
Private Const GWL_STYLE = (-16)
Private Const WS_SYSMENU = &amp;H80000
Private Hwnd As Long
Private Sub UserForm_Initialize()
    Dim Istype As Long
    Hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    Istype = GetWindowLong(Hwnd, GWL_STYLE)
    Istype = Istype And Not WS_SYSMENU
    SetWindowLong Hwnd, GWL_STYLE, Istype
    DrawMenuBar Hwnd
End Sub
代码解析：
第1行到第7行代码是API函数声明。
第8行到第15行代码是窗体的Initialize事件，当窗体显示时屏蔽窗体标题栏的关闭按钮。
窗体运行后，屏蔽窗体上的关闭按钮，只能使用按钮关闭窗体，如图 138 1所示。

图 138 1    屏蔽窗体标题栏的关闭按钮</code></pre>
<h3 id="技巧139-无标题栏和边框的窗体"><a href="#技巧139-无标题栏和边框的窗体" class="headerlink" title="技巧139     无标题栏和边框的窗体"></a>技巧139     无标题栏和边框的窗体</h3><p>如果希望制作无标题栏和边框的窗体，那么可以使用API函数。<br>在VBE窗口中单击菜单“插入”→“用户窗体”，双击窗体，在其代码窗口中输入下面的代码：</p>
<pre><code class="vb">Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal Hwnd As Long) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long) As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal Hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Const GWL_STYLE As Long = (-16)
Private Const GWL_EXSTYLE = (-20)
Private Const WS_CAPTION As Long = &amp;HC00000
Private Const WS_EX_DLGMODALFRAME = &amp;H1&amp;
Private Sub UserForm_Initialize()
    Dim IStyle As Long
    Dim Hwnd As Long
    If Val(Application.Version) &lt; 9 Then
        Hwnd = FindWindow(&quot;ThunderXFrame&quot;, Me.Caption)
    Else
        Hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    End If
    IStyle = GetWindowLong(Hwnd, GWL_STYLE)
    IStyle = IStyle And Not WS_CAPTION
    SetWindowLong Hwnd, GWL_STYLE, IStyle
    DrawMenuBar Hwnd
    IStyle = GetWindowLong(Hwnd, GWL_EXSTYLE) And Not WS_EX_DLGMODALFRAME
    SetWindowLong Hwnd, GWL_EXSTYLE, IStyle
End Sub
Private Sub UserForm_Click()
    Unload Me
End Sub
代码解析：
窗体初始化时使用API函数去除其标题栏和边框。
第1行到第8行代码，API函数的声明。
第12行到第16行代码，获取窗口句柄。
第17行到第20行代码，去除窗体标题栏。
第21、22行代码，去除窗体边框。
第24行到第26行代码，窗体的单击事件，单击窗体后关闭该窗体。
窗体运行后如图 139 1所示，单击后关闭该窗体。

图 139 1    无标题栏和边框的窗体</code></pre>
<h3 id="技巧140-制作年月选择窗体"><a href="#技巧140-制作年月选择窗体" class="headerlink" title="技巧140     制作年月选择窗体"></a>技巧140     制作年月选择窗体</h3><p>在工作表中需要输入日期时，可以使用日期时间控件（Microsoft Date and Time Picker Control 6.0，简称DTP控件），请参阅技巧116 。但有时只需要输入年份和月份，使用DTP控件选择月份并不方便，此时可以使用文本框结合微调框做一个年月选择窗体供用户输入年份和月份。<br>步骤1，在VBE窗口中单击菜单“插入”→“用户窗体”，将窗体的Caption属性设置为“请选择年月”。<br>步骤2，在窗体上添加一个框架控件和两个命令按纽控件。在框架控件中添加两个文本框控件和两个SpinButton控件，并把命令按纽的Caption属性分别设置为“确定”和“取消”。<br>步骤3，调整好控件位置，双击窗体写入下面的代码。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    SpinButton1.Value = Year(Date)
    SpinButton2.Value = Month(Date)
    TextBox1.Text = Year(Date) &amp; &quot;年&quot;
    TextBox2.Text = Month(Date) &amp; &quot;月份&quot;
End Sub
Private Sub SpinButton1_Change()
    TextBox1.Text = SpinButton1.Value &amp; &quot;年&quot;
End Sub
Private Sub SpinButton2_Change()
    With SpinButton2
        Select Case .Value
            Case 1 To 12
                TextBox2.Text = .Value &amp; &quot;月份&quot;
            Case Is &gt; 12
                TextBox1.Text = Left(TextBox1.Text, 4) + 1 &amp; &quot;年&quot;
                .Value = 1
            Case Is &lt; 1
                TextBox1.Text = Left(TextBox1.Text, 4) - 1 &amp; &quot;年&quot;
                .Value = 12
        End Select
    End With
End Sub
Private Sub CommandButton1_Click()
    Sheet1.Range(&quot;A65536&quot;).End(xlUp).Offset(1) = TextBox1.Text &amp; TextBox2.Text
End Sub
Private Sub CommandButton2_Click()
    Unload Me
End Sub
代码解析：
第1行到第6行代码，窗体的初始化事件，在窗体加载时设置文本框和微调框的初始值。
第2行代码，设置微调框1的初始值为当前年份。Year函数返回年份的整数，语法如下：
Year(date)
参数date是必需的，可以是任何能够表示日期的Variant、数值表达式、字符串表达式或它们的组合。
第3行代码，设置微调框2的初始值为当前月份。Mont函数返回值为1到12之间的整数，表示一年中的某月，语法如下：
Month(date)
参数date与Year函数的参数date相同。
第4行代码，设置文本框1显示的文本为当前年份。
第5行代码，设置文本框2显示的文本为当前月份。
第7行到第9行代码，微调框1的Change事件过程。当单击微调框1数值调节钮的向上键或向下键调节年份时，文本框1显示的年份等于调节后的年份。
第10行到第23行代码，微调框2的Change事件过程。当单击微调框2数值调节钮的向上键或向下键调节月份时，文本框2显示的月份等于调节后的月份。如果是一年以内的调节，只调节文本框2显示的月份，否则还需要调节文本框1显示的年份。
第25行代码，“确定”按钮的单击过程，将选择好的年月写入工作表中。
第28行代码，使用Unload 语句卸载窗体。
运行窗体后效果如图 140 1所示。

图 140 1    年月选择窗体</code></pre>
<h3 id="技巧141-自定义窗体中的鼠标指针类型"><a href="#技巧141-自定义窗体中的鼠标指针类型" class="headerlink" title="技巧141     自定义窗体中的鼠标指针类型"></a>技巧141     自定义窗体中的鼠标指针类型</h3><p>使用对象的MousePointer属性可以自定义鼠标掠过窗体控件时的指针类型，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    With Me.TextBox1
        .MousePointer = 99
        .MouseIcon = LoadPicture(ThisWorkbook.Path &amp; &quot;\myMouse.ico&quot;)
    End With
End Sub
代码解析：
当用户把鼠标放到窗体的文本框上时，所显示的鼠标指针的类型为自定义图标。
第3行代码设置文本框的MousePointer属性。MousePointer属性指定当用户把鼠标放到特定对象上时，所显示鼠标指针的类型，语法如下：
object.MousePointer [= fmMousePointer]
参数object是必需的，一个有效对象。
参数fmMousePointer是可选的，所需鼠标指针的形状。fmMousePointer的设置值如表格 141 1所示。
常量    值    说明
fmMousePointerDefault    0    标准指针。根据对象来决定指针的图像（默认）
fmMousePointerArrow    1    箭头
fmMousePointerCross    2    十字线指针
fmMousePointerIBeam    3    I 形标
fmMousePointerSizeNESW    6    斜下的双箭头
fmMousePointerSizeNS    7    南北向的双箭头
mMousePointerSizeNWSE    8    斜上的双箭头
fmMousePointerSizeWE    9    东西向的双箭头
fmMousePointerUpArrow    10    向上键
fmMousePointerHourglass    11    沙漏
fmMousePointerNoDrop    12    在被拖动的对象上有 “Not”符号（有一条斜线的圆）。表示是无效的放置目标。
fmMousePointerAppStarting    13    带沙漏的箭头
fmMousePointerHelp    14    带问号的箭头
fmMousePointerSizeAll    15    调整所有尺寸的光标（四向箭头）
fmMousePointerCustom    99    使用由MouseIcon属性指定的图标
表格 141 1    fmMousePointer的设置值
第3行代码将文本框的MousePointer属性设置为99，使用由MouseIcon属性指定的自定义图标。MouseIcon属性为对象指定一个自定义的图标，语法如下：
object.MouseIcon = LoadPicture( pathname )
参数object是必需的，一个有效的对象。
参数pathname是必需的，指定包含自定义图标的文件的路径和文件名。
设置后的鼠标指针的形状如图 141 1所示。

图 141 1    自定义鼠标指针类型</code></pre>
<h3 id="技巧142-调整窗体的显示位置"><a href="#技巧142-调整窗体的显示位置" class="headerlink" title="技巧142     调整窗体的显示位置"></a>技巧142     调整窗体的显示位置</h3><p>用户窗体显示时，默认的位置是窗体所在Excel文件的中央。如果需要调整，可以在窗体加载时对其进行设置，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    With Me
        .StartUpPosition = 0
        .Left = 500
        .Top = 300
    End With
End Sub
代码解析：
窗体的初始化事件，在窗体加载时设置其显示位置。
第3行代码，将窗体的StartUpPosition属性设置成手动。
StartUpPosition属性返回或设置一个值，用来指定窗体第一次出现时的位置，设置值如表格 142 1所示。
设置    值    描述
手动    0    没有初始设置指定
所有者中心    1    在 UserForm 所属项目的中央
屏幕中心    2    在整个屏幕的中央
窗口缺省    3    在屏幕的左上角
表格 142 1    StartUpPosition属性设置值
StartUpPosition属性可以在程序中设置，也可以在窗体的属性窗口中设置。
第4、5行代码，设置窗体的Left属性和Top属性，使其加载时显示在屏幕的右下角。
经过设置后的窗体加载时显示位置如图 142 1所示。

图 142 1    调整窗体的显示位置</code></pre>
<h3 id="技巧143-由鼠标确定窗体显示位置"><a href="#技巧143-由鼠标确定窗体显示位置" class="headerlink" title="技巧143     由鼠标确定窗体显示位置"></a>技巧143     由鼠标确定窗体显示位置</h3><p>窗体加载时其显示位置还可以由鼠标的坐标来确定，如下面的代码所示。</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim ActiveCellX As Integer
    Dim ActiveCellY As Integer
    ActiveCellX = ExecuteExcel4Macro(&quot;GET.CELL(44)&quot;)
    ActiveCellY = ExecuteExcel4Macro(&quot;GET.CELL(43)&quot;)
    With UserForm1
        .Show 0
        .Top = ActiveCellY
        .Left = ActiveCellX
    End With
End Sub
代码解析：
使用ExecuteExcel4Macro方法执行Microsoft Excel 4.0 宏函数取得鼠标的坐标，ExecuteExcel4Macro方法的语法如下：
expression.ExecuteExcel4Macro(String)
expression参数是可选的，返回一个Application对象。
String参数是必需的，一个不带等号的Microsoft Excel 4.0宏语言函数。
第4行代码使用GET.CELL(44) 宏函数取得鼠标的X坐标，第5行代码使用GET.CELL(43) 宏函数取得鼠标的Y坐标。
第6行到第10行代码显示窗体并设置其Top属性和Left属性，调整其显示的位置。</code></pre>
<p>还可以利用工作表SelectionChange事件的Target参数取得鼠标的坐标，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Worksheet_SelectionChange(ByVal Target As Range)
    With UserForm1
        .Show 0
        .Top = Target.Top
        .Left = Target.Left
    End With
End Sub
代码解析：
工作表的SelectionChange事件过程，Target参数代表新选定的区域，返回一个Range对象，在显示窗体时取得其Top和Left属性后设置窗体显示的Top和Left属性。</code></pre>
<h3 id="技巧144-用户窗体的打印"><a href="#技巧144-用户窗体的打印" class="headerlink" title="技巧144     用户窗体的打印"></a>技巧144     用户窗体的打印</h3><p>在使用如图 144 1所示的窗体录入数据时，如果需要把窗体打印出来，可以使用PrintForm方法，如下面的代码所示。</p>
<p>图 144 1    录入窗体</p>
<pre><code class="vb">Private Sub CommandButton7_Click()
    Dim myHeight As Integer
    Application.ScreenUpdating = False
    With UserForm1
        myHeight = .Height
        .DTPicker1.Visible = False
        .Frame1.Visible = False
        .Height = myHeight - 30
        .PrintForm
        .Height = myHeight
        .DTPicker1.Visible = True
        .Frame1.Visible = True
    End With
    Application.ScreenUpdating = True
End Sub
代码解析：
录入窗体中的“打印”按钮的单击代码，使用PrintForm方法打印窗体。
第5行代码使用变量myHeight记录窗体的Height属性值，以便在第10行代码中恢复窗体原有的高度。
第6、7行代码将窗体中的DTP日历控件和功能按钮的Visible属性设置为False，使之隐藏，这样在打印时就不会被打印出来。
第9行代码使用PrintForm方法打印窗体，PrintForm方法将UserForm对象的图象逐位发送到打印机，语法如下：
object.PrintForm
参数object代表对象表达式，其值为“应用于”列表中的对象。如果省略该参数，则把焦点所在的窗体当做object。
第11、12行代码重新显示窗体中的DTP日历控件和功能按钮。
窗体打印后的效果如图 144 2所示。

图 144 2    窗体打印效果</code></pre>
<h3 id="技巧145-使用自定义颜色设置窗体颜色"><a href="#技巧145-使用自定义颜色设置窗体颜色" class="headerlink" title="技巧145     使用自定义颜色设置窗体颜色"></a>技巧145     使用自定义颜色设置窗体颜色</h3><p>在用VBA进行设计时，会发现控件与颜色相关的属性中系统提供可选择的颜色太少。比如窗体的BackColor属性，如果需要把窗体的背景颜色设置为淡蓝色RGB(52,150,203)，可以在窗体初始化过程中对之进行设置，可以实现想要的效果，但是在设计时却不能看到最终效果。<br>其实窗体的BackColor属性（包括ForeColor以及BorderColor等等这些设置颜色的属性）允许输入一个以十六进制表示的长整型数值，这样在设计时就看到效果。<br>首先获取所需要的颜色值并以十六进制表示。还以上面的颜色为例，在立即窗口输入“? Hex(RGB(52,150,203))”可得到一个十六进制数据CB9634，然后把光标定位在窗体属性窗口的BackColor属性值中，删除原来的数值后，输入“&amp;HCB9634&amp;”后按<enter>键，窗体颜色效果立即就出现了，如图 145 1所示。</enter></p>
<p>图 145 1    在窗体设计时显示自定义颜色</p>
<h3 id="技巧146-在窗体中显示图表"><a href="#技巧146-在窗体中显示图表" class="headerlink" title="技巧146     在窗体中显示图表"></a>技巧146     在窗体中显示图表</h3><p>工作表中的图表是不能直接显示在窗体中的，如果需要在窗体上显示图表，除了使用技巧61 介绍的使用ShowWindow属性将工作表中嵌入的图表显示在独立的窗口中，还可以使用以下的方法。</p>
<h4 id="146-1-使用Export方法"><a href="#146-1-使用Export方法" class="headerlink" title="146-1    使用Export方法"></a>146-1    使用Export方法</h4><p>可以把图表以图形格式从工作表中导出，再用窗体上的Image控件把图表显示出来，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Dim Charts As Chart
    Dim cName As String
    Set Charts = Sheets(&quot;Sheet2&quot;).ChartObjects(1).Chart
    cName = ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
    Charts.Export Filename:=cName, FilterName:=&quot;GIF&quot;
    Image1.Picture = LoadPicture(cName)
End Sub
代码解析：
窗体的初始化事件过程，窗体加载时将工作表中的图表显示在窗体中。
第4行到第6行代码，使用Export方法把Sheet2表中的第一个图表导出到工作簿的同一目录下。
Export方法以图形格式导出图表，语法如下：
expression.Export(Filename, FilterName, Interactive)
参数expression是必需的，一个有效的对象。
参数Filename是必需的，导出的文件的名称。
本例中设置Filename参数时加上了导出路径，将图形导出到同一文件夹下。
参数FilterName是可选的，导出文件的格式。
第7行代码，设置窗体中Image控件的Picture属性为导出文件的完整路径。
Picture 属性指定显示在对象上的位图，语法如下：
object.Picture = LoadPicture( pathname )
参数expression是必需的，一个有效的对象。
参数pathname是必需的，一个图片文件的完整路径。
为了使窗体关闭时删除导出的图片文件，在窗体的QueryClose事件中写入下面的代码。
Private Sub UserForm_QueryClose(Cancel As Integer, CloseMode As Integer)
    Kill ThisWorkbook.Path &amp; &quot;\Temp.gif&quot;
End Sub
代码解析：
窗体关闭时使用Kill方法删除导出的图片文件。Kill方法的语法如下：
Kill pathname
参数Pathname是必需的，用来指定一个文件名的字符串表达式。Pathname参数可以包含目录或文件夹、以及驱动器。
运行窗体，将工作表的图表显示在窗体中，如图 146 2所示。

图 146 1    在窗体上显示图表</code></pre>
<h4 id="146-2-使用API函数"><a href="#146-2-使用API函数" class="headerlink" title="146-2    使用API函数"></a>146-2    使用API函数</h4><p>可以使用API函数把图表从工作表中导出，再用窗体上的Image控件把图表显示出来，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function CreateStreamOnHGlobal Lib &quot;ole32&quot; (ByVal hGlobal As Long, ByVal fDeleteOnRelease As Long, ppstm As Any) As Long
Private Declare Function OleLoadPicture Lib &quot;olepro32&quot; (pStream As Any, ByVal lSize As Long, ByVal fRunmode As Long, riid As Any, ppvObj As Any) As Long
………代码略详见附件
Private Declare Function GetClipboardFormatName Lib &quot;user32&quot; Alias &quot;GetClipboardFormatNameA&quot; (ByVal wFormat As Long, ByVal lpString As String, ByVal nMaxCount As Long) As Long
Public Function LoadShapePicture(shp As Object) As IPictureDisp
    Dim nClipsize As Long
    Dim hMem As Long
    Dim lpData As Long
    Dim sdata() As Byte
    Dim fmt As Long
    Dim fmtName As String
    Dim iClipBoardFormatNumber As Long
    Dim IID_IPicture(15)
……代码略详见附件
    EmptyClipboard
    CloseClipboard
End Function
Private Sub UserForm_Initialize()
    Image1.Picture = LoadShapePicture(Sheet1.ChartObjects(1))
End Sub
代码解析：
第1行到第12行代码API函数声明。
第13行到第60行代码LoadShapePicture函数，导出工作表中的图表。
第61行到第63行代码窗体的初始化事件过程，窗体加载时将工作表中的图表显示在窗体中，如图 146 2所示。关于Image 控件的Picture属性请参阅技巧146-1。

图 146 2    在窗体上显示图表</code></pre>
<h3 id="技巧147-窗体运行时调整控件大小"><a href="#技巧147-窗体运行时调整控件大小" class="headerlink" title="技巧147     窗体运行时调整控件大小"></a>技巧147     窗体运行时调整控件大小</h3><p>用户窗体中的控件在运行时是不能调整大小的，而在某些情况下需要在窗体运行时调整控件的大小，此时可以利用控件的MouseMove事件。<br>步骤1，在VBE窗口中单击菜单“插入”→“用户窗体”，在窗体中添加两个框架控件，在框架控件中间添加一个Image控件，如图 147 1所示。</p>
<p>图 147 1    添加控件<br>步骤2，Image控件是用来在窗体运行时拖动调整框架控件大小的，所以需要在Image控件的属性窗口将BackStyle属性设置为fmBackStyleTransparent，使控件的背景为透明；将BorderStyle属性设置为fmBorderStyleNone，使控件无可见的边框线；MousePointer属性设置为fmMousePointerSizeWE，当用户把鼠标放到Image控件上时，鼠标指针的类型为东西向的双箭头。关于控件的MousePointer属性请参阅技巧141 中的表格 141 1。<br>步骤3，在窗体中调整好控件的位置后双击Image控件写入下面的代码：</p>
<pre><code class="vb">Dim Abscissa As Single
Private Sub Image1_MouseDown(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    Abscissa = x
End Sub
Private Sub Image1_MouseMove(ByVal Button As Integer, ByVal Shift As Integer, ByVal x As Single, ByVal y As Single)
    If Button = 1 Then
        If Abscissa - x &gt; Frame1.Width Or x &gt; Frame2.Width Then Exit Sub
        Frame1.Width = Frame1.Width - Abscissa + x
        Image1.Left = Image1.Left - Abscissa + x
        Frame2.Left = Frame2.Left - Abscissa + x
        Frame2.Width = Frame2.Width + Abscissa - x
    End If
End Sub
代码解析：
第2行到第4行代码，Image控件的MouseDown事件过程，用户按下鼠标按键时发生，语法如下：
Private Sub object_MouseDown( ByVal Button As fmButton, ByVal Shift As fmShiftState, ByVal X As Single, ByVal Y As Single)
其中参数x是可选的，控件位置的横坐标，以磅为单位，从左边开始测量。
第3行代码将控件的横坐标赋给变量Abscissa。
第5行到第12行代码，Image控件的MouseMove事件过程，用户移动鼠标时该事件发生，语法如下：
Private Sub object_MouseMove( ByVal Button As fmButton, ByVal Shift As fmShiftState, ByVal X As Single, ByVal Y As Single)
其中参数Button是必需的，标识鼠标按键状态的整数值，其设置值如表格 147 1所示。
值    说明    值    说明
0    按键未被按下    4    按下中键
1    按下左键    5    同时按下左键和中键
2    按下右键    6    同时按下中键和右键
3    同时按下左键和右键    7    三个按键全都按下
表格 147 1    Button参数的设置值
参数x是可选的，控件位置的水平坐标，以磅为单位，从左边开始测量。
在MouseMove事件过程中，当用户在窗体上按下左键移动鼠标时，调整两个框架控件的Width属性和框架2的Left属性，使其达到窗体运行时可以进行拖动调整大小的效果。
当鼠标指针在对象上移动时，MouseMove事件是连续发生的，只要鼠标位于对象的边界之内，对象就会不断的识别MouseMove事件，所以框架控件可以连续的进行拖动调整大小。
运行窗体的，选择两个框架控件的中间位置，当鼠标指针变成东西向的双箭头时按下鼠标左键拖动可以进行拖动调整框架控件的大小，如图 147 2所示。

图 147 2    窗体运行时调整控件大小</code></pre>
<h3 id="技巧148-在用户窗体上添加菜单"><a href="#技巧148-在用户窗体上添加菜单" class="headerlink" title="技巧148     在用户窗体上添加菜单"></a>技巧148     在用户窗体上添加菜单</h3><p>在VBA中，用户窗体上是没有菜单的，为了使用方便，我们可以使用API函数在用户窗体上添加菜单，示例代码如下：</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function SetMenu Lib &quot;user32&quot; (ByVal hwnd As Long, ByVal hMenu As Long) As Long
Private Declare Function CreateMenu Lib &quot;user32&quot; () As Long
Private Declare Function AppendMenu Lib &quot;user32&quot; Alias &quot;AppendMenuA&quot; (ByVal hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem As Long, ByVal lpNewItem As Any) As Long
Private Declare Function DestroyMenu Lib &quot;user32&quot; (ByVal hMenu As Long) As Long
Private Declare Function CreatePopupMenu Lib &quot;user32&quot; () As Long
Private Declare Function SetWindowLong Lib &quot;user32&quot; Alias &quot;SetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long
Private Declare Function GetWindowLong Lib &quot;user32&quot; Alias &quot;GetWindowLongA&quot; (ByVal hwnd As Long, ByVal nIndex As Long) As Long
Private Const GWL_WNDPROC = (-4)
Private Const MF_STRING = &amp;H0&amp;
Private Const MF_POPUP = &amp;H10&amp;
Private Const MF_SEPARATOR = &amp;H800&amp;
Dim MenuWnd As Long, Dump As Long, PopupMenuID As Long, PopupMenuWnd As Long, MenuID As Long
Private Sub UserForm_Initialize()
    If Val(Application.Version) &lt; 9 Then
        hwnd = FindWindow(&quot;ThunderXFrame&quot;, Me.Caption)
    Else
        hwnd = FindWindow(&quot;ThunderDFrame&quot;, Me.Caption)
    End If
    MenuWnd = CreateMenu()
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;系统设置(&amp;X)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 100, &quot;保存(&amp;S)...&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 101, &quot;备份(&amp;E)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 102, &quot;退出(&amp;X)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;会计凭证(&amp;P)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 110, &quot;录入(&amp;L)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 111, &quot;审核(&amp;C)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;会计账簿(&amp;Z)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 112, &quot;记账(&amp;T)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 113, &quot;结账(&amp;J)&quot;)
    PopupMenuID = CreatePopupMenu()
    Dump = AppendMenu(MenuWnd, MF_STRING + MF_POPUP, PopupMenuID, &quot;会计报表(&amp;B)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 114, &quot;资产负债表(&amp;F)&quot;)
    Dump = AppendMenu(PopupMenuID, MF_STRING, 115, &quot;损益表(&amp;Y)&quot;)
    Dump = SetMenu(hwnd, MenuWnd)
    PreWinProc = GetWindowLong(hwnd, GWL_WNDPROC)
    SetWindowLong hwnd, GWL_WNDPROC, AddressOf MsgProcess
End Sub
Private Sub UserForm_Terminate()
    DestroyMenu MenuWnd
    DestroyMenu PopupMenuID
    DestroyMenu PopupMenuWnd
    SetWindowLong hwnd, GWL_WNDPROC, PreWinProc
End Sub
代码解析：
第1行到第13行代码，API函数声明。
第14行到第41代码，用户窗体的Initialize事件过程，在窗体显示时使用API函数在窗体上添加菜单。其中第22行代码添加第一个“系统设置”菜单，第23、24、25行代码在“系统设置”菜单中添加三个子菜单，第26行代码往下继续添加其他菜单。
第40行代码，为窗体中添加的菜单指定所执行的过程名称为“MsgProcess”函数过程。
第42行到第47行代码，用户窗体的Terminate事件过程，将所有引用对象的变量设置成Nothing，从而删除对象的所有引用。</code></pre>
<p>为了能够使用窗体中添加的菜单，需要在模块中写入下面的代码：</p>
<pre><code class="vb">Public PreWinProc As Long, hwnd As Long
Public Declare Function CheckMenuRadioItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal un1 As Long, ByVal un2 As Long, ByVal un3 As Long, ByVal un4 As Long) As Long
Public Declare Function CheckMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDCheckItem As Long, ByVal wCheck As Long) As Long
Public Declare Function EnableMenuItem Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal wIDEnableItem As Long, ByVal wEnable As Long) As Long
Public Const MF_UNCHECKED = &amp;H0&amp;
Public Const MF_CHECKED = &amp;H8&amp;
Public Const MF_DISABLED = &amp;H2&amp;
Public Const MF_GRAYED = &amp;H1&amp;
Public Const MF_ENABLED = &amp;H0&amp;
Private Declare Function CallWindowProc Lib &quot;user32&quot; Alias &quot;CallWindowProcA&quot; (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
Private Declare Function GetMenu Lib &quot;user32&quot; (ByVal hwnd As Long) As Long
Private Declare Function GetSubMenu Lib &quot;user32&quot; (ByVal hMenu As Long, ByVal nPos As Long) As Long
Private Const MF_BYCOMMAND = &amp;H0&amp;
Public Function MsgProcess(ByVal hwnd As Long, ByVal Msg As Long, ByVal wParam As Long, ByVal lParam As Long) As Long
    Dim SubMenu_hWnd As Long
    Select Case wParam
        Case 100
            MsgBox &quot;你选择的是&quot;&quot;保存&quot;&quot;按钮!&quot;
        Case 101
            MsgBox &quot;你选择的是&quot;&quot;备份&quot;&quot;按钮!&quot;
        Case 102
            Unload UserForm1
        Case 110
            MsgBox &quot;你选择的是&quot;&quot;录入&quot;&quot;按钮!&quot;
        Case 111
            MsgBox &quot;你选择的是&quot;&quot;审核&quot;&quot;按钮!&quot;
        Case 112
            MsgBox &quot;你选择的是&quot;&quot;记账&quot;&quot;按钮!&quot;
        Case 113
            MsgBox &quot;你选择的是&quot;&quot;结账&quot;&quot;按钮!&quot;
        Case 114
            MsgBox &quot;你选择的是&quot;&quot;资产负债表&quot;&quot;按钮!&quot;
        Case 115
            MsgBox &quot;你选择的是&quot;&quot;损益表&quot;&quot;按钮!&quot;
        Case Else
            MsgProcess = CallWindowProc(PreWinProc, hwnd, Msg, wParam, lParam)
    End Select
End Function
代码解析：
第1行到第13行代码，API函数声明。
第14行到第36行代码，MsgProcess函数过程，根据参数wParam的值为窗体中的菜单指定所执行的操作，为了演示方便只使用MsgBox函数显示一个消息框，在实际应用中可以为菜单写入代码或指定过程名称。
运行窗体后在窗体上添加菜单，如图 148 1所示。

图 148 1    用户窗体上添加菜单</code></pre>
<h3 id="技巧149-在用户窗体上添加工具栏"><a href="#技巧149-在用户窗体上添加工具栏" class="headerlink" title="技巧149     在用户窗体上添加工具栏"></a>技巧149     在用户窗体上添加工具栏</h3><p>在技巧148 中我们在用户窗体上使用API函数添加了菜单，还可以在用户窗体上继续添加工具栏用以显示一列下拉菜单的位图按钮，单击一个工具栏按钮等于选择一个菜单命令，以提供对常用功能和命令的快速访问。<br>在用户窗体上添加工具栏可以使用Toolbar控件，在设计模式下右键单击“工具箱”，在显示的右键菜单中选择“附加控件”，在显示的对话框中选择“Microsoft Toolbar Control， veision 6.0”控件，在用户窗体上添加一个Toolbar控件。如图 149 1所示。</p>
<p>图 149 1    选择Toolbar控件<br>因为需要在Toolbar控件按钮中使用图标，所以还需要在用户窗体中添加一个ImageList控件保存所需要的图像文件，在ImageList控件的属性页中插入6张图片，如图 149 2所示。</p>
<p>图 149 2    ImageList控件插入图片<br>用户窗体上添加了Toolbar控件后还需要设置其属性和添加按钮控件，可以在Toolbar控件的属性页中进行设置和添加，如图 149 3所示。</p>
<p>图 149 3    设置Toolbar控件属性<br>还可以在代码运行时对其进行设置和添加按钮，双击用户窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    ……使用API函数添加菜单代码略，详见附件
    Dim arr As Variant
    Dim i As Byte
    arr = Array(&quot; 录入 &quot;, &quot; 审核&quot;, &quot; 记账 &quot;, &quot; 结账 &quot;, &quot;负债表&quot;, &quot;损益表&quot;)
    With Toolbar1
        .ImageList = ImageList1
        .Appearance = ccFlat
        .BorderStyle = ccNone
        .TextAlignment = tbrTextAlignBottom
        With .Buttons
            .Add(1, , &quot;&quot;).Style = tbrPlaceholder
            For i = 0 To UBound(arr)
                .Add(i + 2, , , , i + 1).Caption = arr(i)
            Next
        End With
    End With
End Sub
代码解析：
第5行代码数组arr用来保存按钮的标题文字。
第7行代码建立Toolbar控件和ImageList控件的关联。
第8行代码设置Toolbar控件的外观效果，Appearance属性获得或设置控件的外观效果，设置值如表格 149 1所示。
设置值    值    说明
ccFlat    0    平面
cc3D    1    立体
表格 149 1    Appearance属性值
第9行代码设置Toolbar控件的边界样式，BorderStyle属性获得或设置边界样式，设置值如表格 149 2所示。
设置值    值    说明
ccNone    0    无边界线
ccFixedSingle    1    固定单线框
表格 149 2    BorderStyle属性值
第10行代码设置按钮文本显示在按钮图像下方，TextAlignment属性获得或设置一个值，决定按钮文本显示在按钮图像下方还是右侧，设置值如表格 149 3所示。
设置值    值    说明
tbrTextAlignBottom    0    下方
tbrTextAlignRight    1    右侧
表格 149 3    TextAlignment属性值
第11行到第15行代码在Toolbar控件中添加按钮，添加按钮需要在Buttons的集合对象中使用Add方法，语法如下：
object.Buttons.Add(index, key, caption, style, image)
参数object是必需的，代表Toolbar对象。
参数index是可选的，指定新增按钮的索引值，该索引值决定了按钮在Toolbar控件中的位置。如果省略index参数新增按钮添加到Butons集合的最后。
参数key是可选的，指定新增按钮的关键字。
参数caption是可选的，指定新增按钮的标题文本。
参数style是可选的，指定新增按钮的样式，设置值如表格 149 1所示。
属性值    值    说明
tbrDefault    0    一般按钮
tbrCheck    1    开关按钮
tbrButtonGroup    2    编组按钮
tbrSeparator    3    分隔按钮
tbrPlaceholder    4    占位按钮
表格 149 4    Style参数值
参数image是可选的，指定新增按钮载入的图像，图像必须是与该Toolbar控件相关联的ImageList控件图像库中的一个。image参数可以是一个整数，对应ImageList图像库中某个图片的Index值也可以是一个字符串，对应图片的关键字Key。
第12行代码代码首先在Toolbar控件中添加占位按钮，设置其style属性为tbrPlaceholder，添加的就是占位按钮，在Toolbar控件中是不显示的，仅仅起到占位的作用。
第14行代码在占位按钮后继续添加6个按钮，设置其标题文本和图像在ImageList控件中的编号。</code></pre>
<p>为了响应Toolbar控件，双击Toolbar控件写入下面的代码：</p>
<pre><code class="vb">Private Sub Toolbar1_ButtonClick(ByVal Button As MSComctlLib.Button)
    Select Case Button.Index
        Case 2
            MsgBox &quot;录入&quot;
        Case 3
            MsgBox &quot;审核&quot;
        Case 4
            MsgBox &quot;记账&quot;
        Case 5
            MsgBox &quot;结账&quot;
        Case 6
            MsgBox &quot;资产负债表&quot;
        Case 7
            MsgBox &quot;损益表&quot;
    End Select
End Sub
代码解析：
Toolbar控件的ButtonClick事件，在单击Toolbar控件的按钮时发生，参数Button代表单击的按钮。为了演示方便，根据其Index属性值使用消息框显示按钮标题文本，在实际应用中可以为菜单写入代码或指定过程名称。
运行窗体后在窗体上添加工具栏，如图 149 4所示。

图 149 4    在用户窗体上添加工具栏</code></pre>
<h3 id="技巧150-使用代码添加窗体及控件"><a href="#技巧150-使用代码添加窗体及控件" class="headerlink" title="技巧150     使用代码添加窗体及控件"></a>技巧150     使用代码添加窗体及控件</h3><p>VBA中的用户窗体为用户提供了可视化的操作界面，在用户窗体中一般都包含控件以便与用户进行交互。我们通常是在VBE中使用菜单“插入”→“用户窗体”来创建用户窗体，然后拖动工具箱中的控件到用户窗体中，也可以使用代码来添加用户窗体及其控件，代码如下：</p>
<pre><code class="vb">Private Sub CommandButton1_Click()
    Dim myForm As VBComponent
    Dim myTextBox As Control
    Dim myButton As Control
    Dim i As Integer
    Set myForm = ThisWorkbook.VBProject.VBComponents.Add(vbext_ct_MSForm)
    With myForm
        .Properties(&quot;Name&quot;) = &quot;Formtest&quot;
        .Properties(&quot;Caption&quot;) = &quot;演示窗体&quot;
        .Properties(&quot;Height&quot;) = &quot;180&quot;
        .Properties(&quot;Width&quot;) = &quot;240&quot;
        Set myTextBox = .Designer.Controls.Add(&quot;Forms.CommandButton.1&quot;)
        With myTextBox
            .Name = &quot;myTextBox&quot;
            .Caption = &quot;新建文本框&quot;
            .Top = 40
            .Left = 138
            .Height = 20
            .Width = 70
        End With
        Set myButton = .Designer.Controls.Add(&quot;Forms.CommandButton.1&quot;)
        With myButton
            .Name = &quot;myButton&quot;
            .Caption = &quot;删除文本框&quot;
            .Top = 70
            .Left = 138
            .Height = 20
            .Width = 70
        End With
        With .CodeModule
            i = .CreateEventProc(&quot;Click&quot;, &quot;myTextBox&quot;)
            .ReplaceLine i + 1, Space(4) &amp; &quot;Dim myTextBox As Control&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;Dim i As Integer&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;Dim k As Integer&quot; _
                &amp; Chr(10) &amp; Space(4) &amp; &quot;k = 10&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;For i = 1 To 5&quot; &amp; Chr(10) &amp; Space(8) &amp; &quot;Set myTextBox = Me.Controls.Add(bstrprogid:=&quot;&quot;Forms.TextBox.1&quot;&quot;)&quot; _
                &amp; Chr(10) &amp; Space(8) &amp; &quot;With myTextBox&quot; &amp; Chr(10) &amp; Space(12) &amp; &quot;.Name = &quot;&quot;myTextBox&quot;&quot; &amp; i&quot; &amp; Chr(10) &amp; Space(12) &amp; &quot;.Left = 20&quot; _
                &amp; Chr(10) &amp; Space(12) &amp; &quot;.Top = k&quot; &amp; Chr(10) &amp; Space(12) &amp; &quot;.Height = 18&quot; &amp; Chr(10) &amp; Space(12) &amp; &quot;.Width = 80&quot; _
                &amp; Chr(10) &amp; Space(12) &amp; &quot;k = .Top + 28&quot; &amp; Chr(10) &amp; Space(8) &amp; &quot;End With&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;Next&quot;
            i = .CreateEventProc(&quot;Click&quot;, &quot;myButton&quot;)
            .ReplaceLine i + 1, Space(4) &amp; &quot;Dim i As Integer&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;On Error Resume Next&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;For i = 1 To 5&quot; &amp; Chr(10) &amp; Space(8) &amp; &quot;Formtest.Controls.Remove &quot;&quot;myTextBox&quot;&quot; &amp; i&quot; &amp; Chr(10) &amp; Space(4) &amp; &quot;Next&quot;
        End With
    End With
End Sub
代码解析：
使用代码添加一个用户窗体及其两个按钮控件，并为按钮控件添加单击事件及其相应的代码。
第2行到第5行代码声明变量类型，如果发生错误请在菜单“工具”→“引用”中引用“Microsoft Visual Basic for Applications Extensibility 5.3”，如图 150 1所示。

图 150 1    引用
第6行代码，使用Add方法添加用户窗体，应用于VBComponents集合的Add方法将一个对象添加到集合，语法如下：
object.Add(component)
参数object是必需的，一个有效的对象名。
参数component是必需的，对于VBComponents集合，则为表示类模块、窗体、标准模块的列举常数，可以为表格 150 1所示的常量之一。
常量    值    描述
vbext_ct_ClassModule    2    将一个类模块添加到集合
Vbext_ct_MSForm    3    将窗体添加到集合
vbext_ct_StdModule    1    将标准模块添加到集合
表格 150 1    component参数值
第8行到第11行代码，使用VBComponent对象的Properties属性设置用户窗体的相关属性。
第12行代码，使用Add方法添加在用户窗体上添加一个按钮控件。VBComponent对象的Designer属性返回一个设计器对象，其Controls属性返回Controls集合，代表用户窗体中所有的控件。应用于Controls集合对象的Add方法在用户窗体中添加控件，语法如下：
object.Add( ProgID [, Name [, Visible]])
参数object是必需的，一个有效的对象名。
参数ProgID是必需的，程序设计标识符。是用于标识对象类的、没有空格的文本串。关于程序设计标识符请参阅技巧119-3中的表格 119 1。
参数Name是可选的，指定被添加的对象的名称。
参数Visible是可选的，若对象为可见的为True，若对象为隐藏的则为False。默认值为True。
第13行到第20行代码设置添加的按钮控件的相关属性。
第21行到第29行代码继续添加一个按钮控件并设置其相关属性。
第30行到第40行代码为添加的按钮控件创建单击事件过程并在其单击事件中添加代码。
其中第30、39行代码使用CreateEventProc方法为按钮控件创建单击事件过程，应用于CodeModule对象的CreateEventProc方法创建一个事件过程，语法如下：
object.CreateEventProc(eventname, objectname) As Long
参数object是必需的，一个有效的对象名。
参数eventname是必需的，字符串表达式，用来指定欲添加到模块的事件名称。
参数objectname是必需的，字符串表达式，用来指定事件源的对象名称。
CreateEventProc方法可返回事件过程的开始行，所以使用变量i保存开始行。
第32行代码使用ReplaceLine方法在按钮控件的单击事件过程中添加代码，应用于CodeModule对象的ReplaceLine方法用特定的代码代替原代码，语法如下：
object.ReplaceLine(line, code)
参数object是必需的，一个有效的对象名。
参数line是必需的，用来指定所要代替的行。
参数code是必需的，用来指定要插入的代码。
在使用ReplaceLine方法时将line参数设置为变量i加1，也就是在单击事件过程的第2行开始添加代码，在添加代码时使用Space函数插入空格，使用Chr函数进行换行。</code></pre>
<p>运行CommandButton1_Click过程，添加一个用户窗体及两个按钮控件，并在用户窗体中添加以下的代码：</p>
<pre><code class="vb">Private Sub myTextBox_Click()
    Dim myTextBox As Control
    Dim i As Integer
    Dim k As Integer
    k = 10
    For i = 1 To 5
        Set myTextBox = Me.Controls.Add(&quot;Forms.TextBox.1&quot;)
        With myTextBox
            .Name = &quot;myTextBox&quot; &amp; i
            .Left = 20
            .Top = k
            .Height = 18
            .Width = 80
            k = .Top + 28
        End With
    Next
End Sub
Private Sub myButton_Click()
    Dim i As Integer
    On Error Resume Next
    For i = 1 To 5
        Formtest.Controls.Remove &quot;myTextBox&quot; &amp; i
    Next
End Sub
代码解析：
第1行到第17行代码，用户窗体中“添加文本框”按钮的单击事件，在用户窗体运行时使用Add方法在用户窗体中添加5个文本框控件并设置其相关属性。
第18行到第24行代码，用户窗体中“删除文本框”按钮的单击事件，在用户窗体运行时使用Remove方法删除文本框控件。应用于Controls集合的Remove方法从集合中删除一个成员，或者从框架、页面或窗体中删除一个控件，语法如下：
object.Remove( collectionindex)
参数object是必需的，一个有效的对象名。
参数collectionindex是必需的，成员在集合内的位置或索引。
注意 Remove方法只能删除在运行时间添加的控件，如果想删除在设计时间添加的控件则会出错。
运行CommandButton1_Click过程添加的用户窗体如图 150 2所示。

图 150 2    添加的用户窗体
单击“新建文本框”按钮在用户窗体中添加5个文本框控件，如图 150 3所示，而单击“删除文本框”按钮则删除用户窗体中添加的文本框控件。</code></pre>
<h3 id="技巧151-用户窗体的全屏显示"><a href="#技巧151-用户窗体的全屏显示" class="headerlink" title="技巧151     用户窗体的全屏显示"></a>技巧151     用户窗体的全屏显示</h3><p>在需要用户窗体全屏显示时，可以将窗体的Height属性和Width属性设置为一定的数值，使之显示时和显示器一样大小。<br>使用这种方法虽然可以达到全屏显示的要求，但是如果换台显示器不一样的电脑时，此种方法便会失效。为了使用户窗体达到真正的全屏显示，可以使用以下的方法。</p>
<h4 id="151-1-设置用户窗体为应用程序的大小"><a href="#151-1-设置用户窗体为应用程序的大小" class="headerlink" title="151-1    设置用户窗体为应用程序的大小"></a>151-1    设置用户窗体为应用程序的大小</h4><p>将用户窗体的高度和宽度设置为应用程序的高度和宽度，如下面的代码所示。</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    Application.WindowState = xlMaximized
    With Me
        .Width = Application.Width
        .Height = Application.Height
        .Left = Application.Left
        .Top = Application.Top
    End With
End Sub
代码解析：
用户窗体初始化时，将高度和宽度设置成与Excel应用程序窗口一样。
第2行代码，将Excel应用程序的WindowState属性设置为xlMaximized，使Excel应用程序最大化显示。
不使用对象识别符时Application属性返回一个Application对象，代表Excel应用程序。WindowState属性返回或设置窗口的状态，可以为表格 151 1所示的XlWindowState常量之一。
常量    值    说明
xlMaximized    -4137    最大化
xlNormal    -4143    不变化
xlMinimized    -4140    最小化
表格 151 1    XlWindowState常量
第3行到第8行代码将用户窗体的Width属性、Height属性设置为Excel应用程序的高度和宽度，Width属性、Height属性以磅为单位返回或设置对象的高度和宽度。将用户窗体的Left属性、Top属性设置为和最大化后的Excel应用程序的一样。</code></pre>
<h4 id="151-2-根据屏幕分辨率进行设置"><a href="#151-2-根据屏幕分辨率进行设置" class="headerlink" title="151-2    根据屏幕分辨率进行设置"></a>151-2    根据屏幕分辨率进行设置</h4><p>根据屏幕分辨率的大小自动调整用户窗体的高度和宽度，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function GetSystemMetrics Lib &quot;user32&quot; (ByVal nIndex As Long) As Long
Const SM_CXSCREEN As Long = 0
Const SM_CYSCREEN As Long = 1
Private Sub UserForm_Initialize()
    With Me
        .Height = GetSystemMetrics(SM_CYSCREEN) * 0.72 
        .Width = GetSystemMetrics(SM_CXSCREEN) * 0.75
        .Left = 0
        .Top = 0
    End With
End Sub
代码解析：
用户窗体初始化时根据屏幕分辨率的大小自动调整用户窗体的高度和宽度。
第1行到第3行代码，API函数声明。
第6行代码设置用户窗体的高度，屏幕分辨率的Y坐标值乘以0.72将其换算成以磅为单位的数值。
第7行代码设置用户窗体的宽度，屏幕分辨率的X坐标值乘以0.75将其换算成以磅为单位的数值。
经过以上两种方法的设置，用户窗体显示时始终以全屏显示。</code></pre>
<h3 id="技巧152-在用户窗体上添加状态栏"><a href="#技巧152-在用户窗体上添加状态栏" class="headerlink" title="技巧152     在用户窗体上添加状态栏"></a>技巧152     在用户窗体上添加状态栏</h3><p>在技巧148 、技巧149 中我们在用户窗体上添加了菜单和工具栏，为了使窗体更像正规的软件，还需要在用户窗体的底部添加一个状态栏，用于显示程序的各种状态信息。<br>在用户窗体上添加状态栏使用StatusBar控件，StatusBar控件用于设计窗体状态栏，状态栏由一组连续的窗格（最多16个）对象组合而成，用于显示应用程序当前的工作状态，其位置通常在应用程序窗体的底部。在设计模式下右键单击“工具箱”，在显示的右键菜单中选择“附加控件”，在显示的对话框中选择“Microsoft StatusBar Control， veision 6.0”控件如图 152 1所示，拖动后就可以在用户窗体上添加一个StatusBar控件。</p>
<p>在用户窗体上添加了StatusBar控件后还需要添加窗格，可以在StatusBar控件的属性页中进行设置和添加，在StatusBar控件的属性窗口中选择“自定义”按钮，在显示的属性页中设置属性和添加窗格，如图 152 2所示。也可以在代码运行时对其进行属性设置和添加窗格，双击用户窗体写入下面的代码：</p>
<pre><code class="vb">Private Sub UserForm_Initialize()
    ……使用API函数添加菜单代码略，详见附件。
    Dim arr As Variant
    Dim i As Byte
    ……使用Toolbar控件添加工具栏代码略，详见附件。
    arr = Array(0, 6, 5)
    With StatusBar1
        .Width = Me.Width - 10
        For i = 1 To 3
            .Panels.Add(i, , &quot;&quot;).Style = arr(i - 1)
        Next
        .Panels(1).Text = &quot;准备就绪!&quot;
        .Panels(2).Width = 60
        .Panels(3).Width = 75
        .Panels(1).Width = Me.Width - .Panels(1).Width - .Panels(2).Width
        .Panels(3).Picture = LoadPicture(ThisWorkbook.Path &amp; &quot;\123.BMP&quot;)
        For i = 0 To 2
            .Panels(i + 1).Alignment = i
        Next
    End With
End Sub
代码解析：
第8行代码设置StatusBar控件的宽度比用户窗体略小一点。
第9行到第11行代码在StatusBar控件中添加三个窗格并指定窗格的样式。添加窗格需要在Panels集合对象中使用Add方法，语法如下：
object.Panels.Add(index, key, text, style, picture)
参数object是必需的，代表StatusBar对象。
参数index是可选的，指定新增窗格的索引值，该索引值决定了窗格在StatusBar控件中的位置。如果省略index参数新增窗格添加到Panels集合的最后。
参数key是可选的，指定新增窗格的关键字。
参数text是可选的，指定新增窗格中显示的文本。
参数style是可选的，指定新增窗格的样式，设置值如表格 152 1所示。
属性值    值    说明
sbrText    0    显示文本与图形
sbrCaps    1    显示大小写状态
sbrNum    2    显示numlock键状态
sbrIns    3    显示Insert状态
sbrScrl    4    显示Scroll键状态
sbrtime    5    按系统格式显示时间
sbrDate    6    按系统格式显示日期
表格 152 1    Style参数值
参数picture是可选的，指定新增窗格载入的图像。
第12行代码设置第一个窗格显示的文本。
第13行到第15行代码设置三个窗格的宽度。
第16行代码为第三个窗格加载指定的图像。
第17行到第19行代码设置三个窗格中文本的对齐方式。Panels对象的Alignment属性返回或设置窗格中文本的对齐方式，设置值如表格 152 2所示。
属性值    值    说明
sbrLeft    0    文本左对齐
sbrCenter    1    文本居中对齐
sbrRight    3    文本右对齐
表格 152 2    Alignment属性值</code></pre>
<p>在示例中使用StatusBar控件的第一个窗格在用户窗体的文本框输入时显示所输入的内容，需要在文本框中写入下面的代码。</p>
<pre><code class="vb">Private Sub TextBox1_Change()
    StatusBar1.Panels(1).Text = &quot;正在录入:&quot; &amp; TextBox1.Text
End Sub
代码解析：
文本框的Change事件过程，将文本框中输入的内容显示在StatusBar控件的第一个窗格中。
运行窗体后在窗体上添加状态栏，如图 152 3所示</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/29/VBA常用技巧8--控件与用户窗体/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧7--菜单和工具栏" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/27/VBA常用技巧7--菜单和工具栏/">VBA常用技巧7--菜单和工具栏</a>
    </h1>
  

        
        <a href="/2018/05/27/VBA常用技巧7--菜单和工具栏/" class="archive-article-date">
  	<time datetime="2018-05-26T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-27</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第7章-菜单和工具栏"><a href="#第7章-菜单和工具栏" class="headerlink" title="第7章     菜单和工具栏"></a>第7章     菜单和工具栏</h2><h3 id="技巧79-在菜单中添加菜单项"><a href="#技巧79-在菜单中添加菜单项" class="headerlink" title="技巧79     在菜单中添加菜单项"></a>技巧79     在菜单中添加菜单项</h3><p>在Excel工作表的菜单中可以添加新的菜单项和子菜单，如下面的代码所示。</p>
<pre><code class="vb">Sub myTools()
    Dim myTools As CommandBarPopup
    Dim myCap As Variant
    Dim myid As Variant
    Dim i As Byte
    myCap = Array(&quot;基础应用&quot;, &quot;VBA程序开发&quot;, &quot;函数与公式&quot;, &quot;图表与图形&quot;, &quot;数据透视表&quot;)
    myid = Array(281, 283, 285, 287, 292)
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set myTools = .Controls(&quot;帮助(&amp;H)&quot;).Controls.Add(Type:=msoControlPopup, Before:=1)
        With myTools
            .Caption = &quot;Excel Home 技术论坛&quot;
            .BeginGroup = True
            For i = 1 To 5
                With .Controls.Add(Type:=msoControlButton)
                    .Caption = myCap(i - 1)
                    .FaceId = myid(i - 1)
                    .OnAction = &quot;myC&quot;
            End With
            Next
        End With
    End With
    Set myTools = Nothing
End Sub
代码解析：
myTools过程使用Add方法在Excel工作表菜单栏中的“帮助”菜单中添加一个标题为“Excel Home 技术论坛”的菜单项和5个子菜单。
第2行到第5行代码声明变量类型。
第6、7行代码使用Array函数创建两个数组用于保存子菜单的名称和图标ID。
第9行代码，在添加菜单项前先使用Reset方法重置菜单栏以免重复添加菜单项。Reset方法重置一个内置控件，恢复该控件原来对应的动作，并将各属性恢复成初始状态，语法如下：
expression.Reset
参数expression 是必需的，返回一个命令栏或命令栏控件对象。
第10行代码，使用Add方法在Excel工作表菜单栏中的“帮助”菜单中添加菜单项。Add方法应用于CommandBarControls对象时，新建一个CommandBarControl对象并添加到指定命令栏上的控件集合，语法如下：
expression.Add(Type, Id, Parameter, Before, Temporary)
参数expression 是必需的，返回一个CommandBarControls对象，代表命令栏中的所有控件。
参数Type是可选的，添加到指定命令栏的控件类型，可以为表格 79 1所列的MsoControlType常数之一。

常数    值    控件类型
msoControlButton    1    命令按钮
msoControlEdit    2    文本框
msoControlDropdown    3    下拉列表控制框
msoControlComboBox    4    下拉组合控制框
msoControlPopup    10    弹出式控件
表格 79 1    MsoControlType常数
因为在本例中将添加的是带有子菜单的菜单项，所以将参数Type设置为弹出式控件。
参数Id是可选的，标识整数。如果将该参数设置为 1或者忽略，将在命令栏中添加一个空的指定类型的自定义控件。
参数Parameter是可选的，对于内置控件，该参数用于容器应用程序运行命令。对于自定义控件，可以使用该参数向Visual Basic过程传递信息，或用其存储控件信息。
参数Before是可选的，表示新控件在命令栏上位置的数字。新控件将插入到该位置控件之前。如果忽略该参数，控件将添加到指定命令栏的末端。本例中将Before参数设置为1，菜单项添加到“帮助”菜单的顶端。
参数Temporary是可选的。设置为True将使添加的菜单项为临时的，在关闭应用程序时删除。默认值为False。
第12行代码，设定新添加菜单项的Caption属性为“Excel Home 技术论坛”。Caption属性返回或设置命令栏控件的标题。
第13行代码，设置新添加菜单项的BeginGroup属性为True，分组显示。
第14行到第19行代码，在“Excel Home 技术论坛”菜单项上添加五个子菜单并设置其Caption属性、FaceId属性和OnAction属性。
FaceId属性设置出现在菜单标题左侧的图标，以数字表示，一个数字代表一个内置的图标。</code></pre>
<p>OnAction属性设置一个VBA的过程名，该过程在用户单击子菜单时运行，本例中设置为下面的过程。</p>
<pre><code class="vb">Public Sub myC()
    MsgBox &quot;您选择了： &quot; &amp; Application.CommandBars.ActionControl.Caption
End Sub
代码解析：
myC过程是单击新添加子菜单所运行过程，为了演示方便在这里只使用MsgBox函数显示所其Caption属性。</code></pre>
<p>删除新添加的菜单项及子菜单的代码如下所示。</p>
<pre><code class="vb">Sub DelmyTools()
    Application.CommandBars(&quot;Worksheet menu bar&quot;).Reset
End Sub
代码解析：
DelmyTools过程使用Reset方法重置菜单栏，删除添加的菜单项及子菜单。
为了在打开工作簿时自动添加菜单项，需要在工作簿的Activate事件中调用myTools过程，如下面的代码所示。
Private Sub Workbook_Activate()
    Call myTools
End Sub
为了在关闭工作簿时删除新添加的菜单项，还需要在工作簿的Deactivate事件中调用DelmyTools过程，如下面的代码所示。
Private Sub Workbook_Deactivate()
    Call DelmyTools
End Sub
如果希望这个菜单为所有工作簿使用，那么就应该在工作簿的Open事件中调用myTools过程，在BeforeClose事件中调用DelmyTools过程。
运行myTools过程，将在Excel工作表菜单栏中的“帮助”菜单中添加一个名为“Excel Home 技术论坛”的菜单项及五个子菜单，如图 79 1所示。

图 79 1    在“帮助”菜单中添加菜单项及子菜单</code></pre>
<h3 id="技巧80-在菜单栏指定位置添加菜单"><a href="#技巧80-在菜单栏指定位置添加菜单" class="headerlink" title="技巧80     在菜单栏指定位置添加菜单"></a>技巧80     在菜单栏指定位置添加菜单</h3><p>除了可以在工作表菜单中添加菜单项外，还可以在工作表菜单栏的指定位置添加菜单，如下面的代码所示。</p>
<pre><code class="vb">Sub AddNewMenu()
    Dim HelpMenu As CommandBarControl
    Dim NewMenu As CommandBarPopup
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        Set HelpMenu = .FindControl(ID:=.Controls(&quot;帮助(&amp;H)&quot;).ID)
        If HelpMenu Is Nothing Then
            Set NewMenu = .Controls.Add(Type:=msoControlPopup)
        Else
            Set NewMenu = .Controls.Add(Type:=msoControlPopup, _
                Before:=HelpMenu.Index)
        End If
        With NewMenu
            .Caption = &quot;统计(&amp;S)&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;输入数据(&amp;D)&quot;
                .FaceId = 162
                .OnAction = &quot;&quot;
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;汇总数据(&amp;T)&quot;
                .FaceId = 590
                .OnAction = &quot;&quot;
            End With
        End With
    End With
    Set HelpMenu = Nothing
    Set NewMenu = Nothing
End Sub
代码解析：
AddNewMenu过程使用Add方法在工作表“帮助”菜单前添加一个标题为“统计”的菜单和两个菜单项。
第6行代码，使用FindControl方法在工作表菜单栏中查找“帮助”菜单。应用于CommandBars对象的FindControl方法返回一个符合指定条件的CommandBarControl对象。语法如下：
expression.FindControl(Type, Id, Tag, Visible, Recursive)
参数expression是必需的，返回一个CommandBars对象。
参数Type是可选的，要查找控件的类型。
参数Id是可选的，要查找控件的标识符。
参数Tag是可选的，要查找控件的标记值。
参数Visible是可选，如果该值为True，那么只查找屏幕上显示的命令栏控件。默认值为False。
参数Recursive是可选的，如果该值为True，那么将在命令栏及其全部弹出式子工具栏中查找。此参数仅应用于CommandBar对象。默认值为False。
如果没有控件符合搜索条件，那么FindControl方法返回Nothing。
第7行到第12行代码，如果工作表菜单栏中存在“帮助”菜单，将“统计”菜单添加到“帮助”菜单之前，否则添加到工作表菜单栏末尾。
第12行到第25行代码，在“统计”菜单中添加两个子菜单并设置其各种属性。
运行AddNewMenu过程，将在工作表菜单栏的“帮助”菜单之前添加一个“统计”菜单，如图 80 1所示。

图 80 1    在工作表菜单栏中添加菜单</code></pre>
<h3 id="技巧81-屏蔽和删除工作表菜单"><a href="#技巧81-屏蔽和删除工作表菜单" class="headerlink" title="技巧81     屏蔽和删除工作表菜单"></a>技巧81     屏蔽和删除工作表菜单</h3><p>如果不希望用户使用工作表菜单栏的部分功能，可以把菜单或菜单项屏蔽或删除，如下面的代码所示。</p>
<pre><code class="vb">Sub Shibar()
    With Application.CommandBars(&quot;Worksheet menu bar&quot;)
        .Reset
        .Controls(&quot;工具(&amp;T)&quot;).Controls(&quot;宏(&amp;M)&quot;).Enabled = False
        .Controls(&quot;数据(&amp;D)&quot;).Delete
    End With
End Sub
代码解析：
Shibar过程屏蔽 “工具”菜单中的“宏”菜单项，删除菜单栏中的“数据”菜单。
第3行代码，使用Reset方法重置工作表菜单栏。
第4行代码，将“宏”菜单项的Enabled属性设置为False，使之无效。
Enabled属性决定命令栏或命令栏控件是否激活，如果将该属性设置为 False，那么该菜单项将无效。
第5行代码，使用Delete方法将“数据”菜单从工作表菜单栏中删除。
Delete方法应用于命令栏或命令栏控件时，从集合中删除指定对象，语法如下：
expression.Delete(Temporary)
参数expression是必需的，返回命令栏或命令栏控件对象之一。
参数Temporary是可选的，设置为True将从当前会话中删除控件，应用程序在下次会话时将再次显示控件。
运行Shibar过程，将屏蔽工作表“工具”菜单中的“宏”菜单项和删除工作表菜单栏中的“数据”菜单，如图 81 1所示。

图 81 1    屏蔽和删除工作表菜单</code></pre>
<h3 id="技巧82-改变系统菜单的操作"><a href="#技巧82-改变系统菜单的操作" class="headerlink" title="技巧82     改变系统菜单的操作"></a>技巧82     改变系统菜单的操作</h3><p>利用VBA甚至可以改变系统菜单的默认操作，使之达到自定义菜单的效果，如下面的代码所示。</p>
<pre><code class="vb">Dim WithEvents Saveas As CommandBarButton
Private Sub Workbook_Open()
    Set Saveas = Application.CommandBars(&quot;File&quot;).Controls(&quot;另存为(&amp;A)...&quot;)
End Sub
Private Sub Saveas_Click(ByVal Ctrl As Office.CommandBarButton, CancelDefault As Boolean)
    CancelDefault = True
    MsgBox &quot;本工作簿禁止另存!&quot;
End Sub
代码解析：
第1行代码，在模块级别中使用关键词WithEvents声明变量Saveas是用来响应由CommandBarButton对象触发事件的对象变量。
第2行到第4代码工作簿的Open事件过程，在工作簿打开时将变量Saveas赋值为系统菜单的“另存为”菜单。
因为在声明变量Saveas时使用了关键词WithEvents，不能同时使用New关键词隐式地创建对象，所以在使用变量Saveas之前，必须使用Set语句将变量赋值为一个已有对象。
第5行到第8代码变量Saveas的单击事件过程，改变系统菜单“另存为”的默认操作。
变量Saveas的Click事件在用户单击系统菜单“另存为”时发生，语法如下：
Private Sub CommandBarButton_Click(ByVal Ctrl As CommandBarButton,
    ByVal CancelDefault As Boolean)
参数Ctrl是必需的，指示初始化该事件的CommandBarButton控件。
参数CancelDefault是必需的，Boolean类型，如果执行了与CommandBarButton控件关联的默认操作，该值为False。除非其他过程或加载项取消了此操作。
第6、7行代码，将CancelDefault参数设置为True，使单击“另存为”菜单时并不执行默认操作而只显示一个消息框。
将工作簿保存、关闭后，重新打开，单击“另存为”菜单并不执行默认操作，只显示一个消息框，如图 82 1所示。</code></pre>
<p>图 82 1    改变系统菜单的默认操作</p>
<h3 id="技巧83-定制自己的系统菜单"><a href="#技巧83-定制自己的系统菜单" class="headerlink" title="技巧83     定制自己的系统菜单"></a>技巧83     定制自己的系统菜单</h3><p>使用VBA开发的小型应用系统完成后，Excel原有的菜单栏完全可以舍弃不用，只使用自定义的菜单栏，更加方便快捷，如下面的代码所示。</p>
<pre><code class="vb">Sub AddNowBar()
    Dim NewBar As CommandBar
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = False 
        .CommandBars(&quot;Formatting&quot;).Visible = False 
        .CommandBars(&quot;Stop Recording&quot;).Visible = False
        .CommandBars(&quot;toolbar list&quot;).Enabled = False
        .CommandBars.DisableAskAQuestionDropdown = True
        .DisplayFormulaBar = False 
        .CommandBars(&quot;NewBar&quot;).Delete
    End With
    Set NewBar = Application.CommandBars.Add(Name:=&quot;NewBar&quot;, Position:=msoBarTop, MenuBar:=True, Temporary:=True)
    With NewBar
        .Visible = True
        With .Controls.Add(Type:=msoControlPopup)
            .Caption = &quot;系统设置(&amp;X)&quot;
            .BeginGroup = True
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;保存(&amp;S)&quot;
                .BeginGroup = True
                .FaceId = 1975
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;备份(&amp;B)&quot;
                .BeginGroup = True
                .FaceId = 747
            End With
        End With
        With .Controls.Add(Type:=msoControlPopup)
            .Caption = &quot;会计凭证(&amp;P)&quot;
            .BeginGroup = True
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;录入(&amp;L)&quot;
                .BeginGroup = True
                .FaceId = 197
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;审核(&amp;S)&quot;
                .BeginGroup = True
                .FaceId = 714
            End With
        End With
        With .Controls.Add(Type:=msoControlPopup)
            .Caption = &quot;会计账簿(&amp;Z)&quot;
            .BeginGroup = True
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;记账(&amp;L)&quot;
                .BeginGroup = True
                .FaceId = 65
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;结账(&amp;S)&quot;
                .BeginGroup = True
                .FaceId = 47
            End With
        End With
        With .Controls.Add(Type:=msoControlPopup)
            .Caption = &quot;会计报表(&amp;B)&quot;
            .BeginGroup = True
            With .Controls.Add(Type:=msoControlPopup)
                .Caption = &quot;资产负债表(&amp;Y)&quot;
                .BeginGroup = True
                With .Controls.Add(Type:=msoControlButton)
                    .Caption = &quot;月报(&amp;M)&quot;
                    .BeginGroup = True
                    .FaceId = 1180
                End With
                    With .Controls.Add(Type:=msoControlButton)
                        .Caption = &quot;年报(&amp;Y)&quot;
                        .BeginGroup = True
                        .FaceId = 1188
                    End With
                End With
            With .Controls.Add(Type:=msoControlPopup)
                .Caption = &quot;损益表(&amp;S)&quot;
                .BeginGroup = True
                With .Controls.Add(Type:=msoControlButton)
                    .Caption = &quot;月报(&amp;M)&quot;
                    .BeginGroup = True
                    .FaceId = 1180
                End With
                With .Controls.Add(Type:=msoControlButton)
                    .Caption = &quot;年报(&amp;Y)&quot;
                    .BeginGroup = True
                    .FaceId = 1188
                End With
            End With
        End With
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;退出系统(&amp;C)&quot;
            .BeginGroup = True
            .Style = msoButtonCaption
        End With
    End With
    Set NewBar = Nothing
End Sub
代码解析：
AddNowBar过程使用Add方法创建自定义菜单栏替换工作表菜单栏。
第2行代码定义变量NwBar为命令栏。
第3行代码忽略错误语句，以免第11行代码在删除可能不存在的“NewBar”菜单栏时发生错误。
第5行代码隐藏“常用”工具栏。
第6行代码隐藏“格式”工具栏。
第7行代码隐藏“停止录制”工具栏。
第8行代码屏蔽工具栏的右键快捷菜单。
第9行代码屏蔽工具栏的“键入需要帮助的问题”下拉框。
第10行代码屏蔽工具栏的编辑栏。
第11行代码，在添加命令栏前先删除“NewBar”菜单栏，以免重复增加。
第13行代码，使用Add方法创建命令栏。Add方法应用于CommandBars对象的语法如下：
expression.Add(Name, Position, MenuBar, Temporary)
参数expression是必需的，返回一个CommandBars对象，该对象代表应用程序中的命令栏，新建命令栏的控件均以该对象为载体。
参数Name是可选的，设置新建命令栏的标题。如果忽略该参数，则为新建命令栏指定默认标题，本例中设置新建命令栏的标题为“NewBar”。
参数Position是可选的，设置新建命令栏的位置或类型，可以为表格 83 1所列的 MsoBarPosition常数之一。
常数    说明
msoBarLeft、msoBarTop、msoBarRight 和 msoBarBottom    指定新命令栏的左侧、顶部、右侧和底部坐标
msoBarFloating    指定新命令栏不固定
msoBarPopup    指定新命令栏为快捷菜单
msoBarMenuBar    仅适用于 Macintosh 机
表格 83 1    MsoBarPosition 常数
本例中设置“NewBar”命令栏的Position参数为msoBarTop，使“NewBar”命令栏位于Excel窗口的顶部。
参数MenuBar是可选的，设置为True 将以新命令栏替换活动菜单栏，默认值为False。
在本例中，设置“NewBar”命令栏的MenuBar属性为True，以“NewBar”命令栏替换活动菜单栏。
参数Temporary是可选的，设置为True将使新建命令栏为临时命令栏，在关闭应用程序时删除，默认值为False。
在本例中，设置“NewBar”命令栏的Temporary属性为True，使“NewBar”命令栏为临时命令栏，在关闭应用程序时删除。
第15行代码，设置“NewBar”命令栏为可见的。
第16行到95行代码，使用Add方法在“NewBar”命令栏中添加菜单、菜单项及子菜单并设置其各项属性，参阅技巧79 。</code></pre>
<p>恢复Excel原有的菜单栏的代码如下：</p>
<pre><code class="vb">Sub DelNowBar()
    On Error Resume Next
    With Application
        .CommandBars(&quot;Standard&quot;).Visible = True
        .CommandBars(&quot;Formatting&quot;).Visible = True
        .CommandBars(&quot;Stop Recording&quot;).Visible = True
        .CommandBars(&quot;toolbar list&quot;).Enabled = True
        .CommandBars.DisableAskAQuestionDropdown = False
        .DisplayFormulaBar = True
        .CommandBars(&quot;NewBar&quot;).Delete
    End With
End Sub
代码解析：
DelNowBar过程取消 “常用”、“格式”和“停止录制”工具栏的的隐藏，恢复“键入需要帮助的问题”下拉框和编辑栏，删除“NewBar”命令栏。
运行AddNowBar过程，工作表菜单栏如图 83 1所示。

图 83 1    定制自己的系统菜单</code></pre>
<h3 id="技巧84-改变菜单按钮图标"><a href="#技巧84-改变菜单按钮图标" class="headerlink" title="技巧84     改变菜单按钮图标"></a>技巧84     改变菜单按钮图标</h3><p>利用VBA可以改变系统菜单的默认图标，使之达到自定义按钮图标的效果，如下面的代码所示。</p>
<pre><code class="vb">Sub myCbarCnt()
    Dim myCbarCnt As CommandBarControl
    With Sheet1.Shapes.AddShape(17, 1000, 1000, 30, 30)
        .Fill.ForeColor.SchemeColor = 29
        .CopyPicture
        .Delete
    End With
    Set myCbarCnt = Application.CommandBars(&quot;Standard&quot;).Controls(1)
    myCbarCnt.PasteFace
    Set myCbarCnt = Nothing
End Sub
Sub DelmyCbarCnt()
    Application.CommandBars(&quot;Standard&quot;).Controls(1).Reset
End Sub
代码解析：
myCbarCnt过程改变系统菜单的“新建”按钮的图标。
第3行代码使用Shape对象的AddShape方法在工作表中新建一个自选图形。应用于Shape对象的AddShape方法请参阅技巧53 。
在本例中将新建图形的Left参数和Top参数设置为较大的数值使新建的自选图形不在当前窗口的可视区域内。
第4行代码设置新建自选图形的颜色。
第5行代码使用CopyPicture方法将新建自选图形作为图片复制到剪贴板。CopyPicture方法的语法如下：
expression.CopyPicture(Appearance, Format)
参数expression是必需的，一个有效的对象。
参数Appearance是可选的，指定图片的复制方式。
参数Format是可选的，图片的格式。
第6行代码使用Delete方法删除新建的自选图形。
第8行代码使用Set语句将系统菜单的“新建”按钮赋给变量myCbarCnt。
第9行代码PasteFace方法将新建的自选图形粘贴到“新建”按钮中。PasteFace方法将“剪贴板”的内容粘贴到指定命令栏按钮控件上，语法如下：
expression.PasteFace
参数expression是必需的，返回一个CommandBarButton对象。
DelmyCbarCnt过程使用Reset方法恢复“新建”按钮的默认图标。
运行myCbarCnt过程结果如图 84 1所示。

图 84 1    改变“新建”按钮的图标</code></pre>
<h3 id="技巧85-右键快捷菜单增加菜单项"><a href="#技巧85-右键快捷菜单增加菜单项" class="headerlink" title="技巧85     右键快捷菜单增加菜单项"></a>技巧85     右键快捷菜单增加菜单项</h3><p>在Excel的右键快捷菜单中可以添加新的菜单项，如下面的代码所示。</p>
<pre><code class="vb">Sub MyCmb()
    Dim MyCmb As CommandBarButton
    With Application.CommandBars(&quot;Cell&quot;)
        .Reset
        Set MyCmb = .Controls.Add(Type:=msoControlButton, _
            ID:=2521, Before:=.Controls.Count, Temporary:=True)
            MyCmb.BeginGroup = True
        End With
    Set MyCmb = Nothing
End Sub
代码解析：
MyCmb过程使用Add方法在Excel的右键快捷菜单中添加内置的“打印”菜单项。
在使用Add方法添加菜单项时将Id参数设置为2521，添加的就是内置的“打印”菜单项。将Before属性设置成右键快捷菜单中最后一个控件的值，使“打印”菜单项添加到右键快捷菜单中最后一个控件之前。将Temporary参数设置成True，在关闭应用程序时从右键快捷菜单中删除“打印”菜单项。
运行MyCmb过程，将在Excel右键快捷菜单中添加 “打印”菜单项，如图 85 1所示

图 85 1    在右键快捷菜单中添加菜单项</code></pre>
<h3 id="技巧86-自定义右键快捷菜单"><a href="#技巧86-自定义右键快捷菜单" class="headerlink" title="技巧86     自定义右键快捷菜单"></a>技巧86     自定义右键快捷菜单</h3><p>在工作表中创建自定义的右键快捷菜单替换Excel默认的右键快捷菜单，如下面的代码所示。</p>
<pre><code class="vb">Sub Mycell()
    With Application.CommandBars.Add(&quot;Mycell&quot;, msoBarPopup)
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;会计凭证&quot;
            .FaceId = 9893
        End With
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;会计账簿&quot;
            .FaceId = 284
        End With
        With .Controls.Add(Type:=msoControlPopup)
            .Caption = &quot;会计报表&quot;
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;月报&quot;
                .FaceId = 9590
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;季报&quot;
                .FaceId = 9591
            End With
            With .Controls.Add(Type:=msoControlButton)
                .Caption = &quot;年报&quot;
                .FaceId = 9592
            End With
        End With
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;凭证打印&quot;
            .FaceId = 9614
            .BeginGroup = True
        End With
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;账簿打印&quot;
            .FaceId = 707
        End With
        With .Controls.Add(Type:=msoControlButton)
            .Caption = &quot;报表打印&quot;
            .FaceId = 986
        End With
    End With
End Sub
代码解析：
Mycell过程在Excel工作表中创建自定义的右键快捷菜单。
第2行代码，使用Add方法添加名称为“Mycell”命令栏，设置“Mycell”命令栏的Position属性为msoBarPopup，使“Mycell”命令栏为快捷菜单。关于Position参数的MsoBarPosition常数请参阅技巧83 中的表格 83 1。
第3行到第39行代码，使用Add方法在“Mycell”命令栏中添加菜单和菜单项，并设置其各项属性。</code></pre>
<p>为了让自定义右键快捷菜单替换Excel默认的右键快捷菜单，并且只在右键单击Sheet1工作表时显示，需要在Sheet1工作表的BeforeRightClick事件中写入下面的代码。</p>
<pre><code class="vb">Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)
    Application.CommandBars(&quot;Mycell&quot;).ShowPopup
    Cancel = True
End Sub
代码解析：
工作表的BeforeRightClick事件过程，在右键单击工作表时，将“Mycell”命令栏作为右键快捷菜单，在当前光标位置显示。
工作表BeforeRightClick事件语法如下：
Private Sub expression_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)
参数expression是必需的，Worksheet类型对象。
参数Target 是可选的，右键单击发生时最靠近鼠标指针的单元格。
参数Cancel是可选的，当事件发生时为False。如果在事件过程中将Cancel参数设为True，则该过程执行结束之后不进行默认的右键单击操作。
第2行代码，使用ShowPopup方法将“Mycell”命令栏作为右键快捷菜单，在当前光标位置显示。
ShowPopup方法的语法如下：
expression.ShowPopup(x, y)
参数expression是必需的，返回一个CommandBar对象。
参数x是可选的，快捷菜单所在位置的 x 坐标。如果省略此参数，将使用当前光标位置的x坐标。
参数y是可选的，快捷菜单所在位置的y坐标。如果省略此参数，将使用当前光标位置的y坐标。
当用鼠标右键单击工作表中任意单元格时激活BeforeRightClick事件，此事件先于默认的右键单击操作。在使用ShowPopup方法显示“Mycell”命令栏后，将Cancel参数设置为True，过程执行结束之后不进行默认的右键单击操作，Excel右键快捷菜单就不会显示。
运行Mycell过程后，右键单击Sheet1工作表，在工作表中显示自定义右键快捷菜单，如图 86 1所示。</code></pre>
<h3 id="技巧87-使用右键菜单制作数据有效性"><a href="#技巧87-使用右键菜单制作数据有效性" class="headerlink" title="技巧87     使用右键菜单制作数据有效性"></a>技巧87     使用右键菜单制作数据有效性</h3><p>在工作表中输入数据时可以使用自定义右键菜单制作数据有效性，如下面的代码所示。</p>
<pre><code class="vb">Sub Mycell()
    Dim arr As Variant
    Dim i As Integer
    Dim Mycell As CommandBar
    On Error Resume Next
    Application.CommandBars(&quot;Mycell&quot;).Delete
    arr = Array(&quot;经理室&quot;, &quot;办公室&quot;, &quot;生技科&quot;, &quot;财务科&quot;, &quot;营业部&quot;)
    Set Mycell = Application.CommandBars.Add(&quot;Mycell&quot;, 5)
    For i = 0 To 4
        With Mycell.Controls.Add(1)
            .Caption = arr(i)
            .OnAction = &quot;MyOnAction&quot;
        End With
    Next
End Sub
Sub MyOnAction()
    ActiveCell = Application.CommandBars.ActionControl.Caption
End Sub
代码解析：
Mycell过程创建自定义的右键菜单，请参阅技巧86 。
MyOnAction过程是点击自定义右键菜单所运行的过程，将所选右键菜单的名称写入活动单元格。</code></pre>
<p>为了使自定义的右键菜单在Sheet1工作表的特定区域中显示，需要在VBE中双击Sheet1表后写入下面的代码。</p>
<pre><code class="vb">Private Sub Worksheet_BeforeRightClick(ByVal Target As Range, Cancel As Boolean)
    If Target.Column = 2 Then
        Call Mycell
        Application.CommandBars(&quot;Mycell&quot;).ShowPopup
        Cancel = True
    End If
End Sub
代码解析：
工作表的BeforeRightClick事件过程，在右键单击工作表时，将“Mycell”命令栏作为右键快捷菜单，在当前光标位置显示，请参阅技巧86 。
在工作表的B列中点击右键结果如图 87 1所示。</code></pre>
<h3 id="技巧88-禁用工作表右键菜单"><a href="#技巧88-禁用工作表右键菜单" class="headerlink" title="技巧88     禁用工作表右键菜单"></a>技巧88     禁用工作表右键菜单</h3><p>有时并不希望用户使用工作表中的右键菜单对工作表进行操作，那么可以使用下面的代码禁用工作表右键菜单。</p>
<pre><code class="vb">Sub DisBar()
    Dim myBar As CommandBar
    For Each myBar In CommandBars
        If myBar.Type = msoBarTypePopup Then
            myBar.Enabled = False
        End If
    Next
End Sub
代码解析：
DisBar过程禁用工作表中所有的右键菜单。
第3行代码使用For Each...Next 语句遍历CommandBars集合。CommandBars集合代表应用程序中所有的命令栏。
第4行代码根据命令栏的Type属性判断命令栏是否为右键菜单。应用于 CommandBar对象的Type属性返回命令栏的类型，可以为表格 88 1所列的MsoBarType 常量之一。</code></pre>
<p>常量    值    描述<br>msoBarTypeMenuBar    1    菜单栏<br>msoBarTypeNormal    0    工具栏<br>msoBarTypePopup    2    右键快捷菜单<br>表格 88 1    MsoBarType 常量<br>第5行代码将CommandBars集合中右键快捷菜的Enabled属性设置为False，使之无效。<br>运行DisBar过程将禁用工作表中所有的右键菜单，需要恢复时只需将其Enabled属性设置为True即可。</p>
<h3 id="技巧89-创建自定义工具栏"><a href="#技巧89-创建自定义工具栏" class="headerlink" title="技巧89     创建自定义工具栏"></a>技巧89     创建自定义工具栏</h3><p>为了方便用户操作，在Excel原有的的工具栏上，还可以创建自定义的工具栏，如下面的代码所示。</p>
<pre><code class="vb">Sub NowToolbar()
    Dim arr As Variant
    Dim id As Variant
    Dim i As Integer
    Dim Toolbar As CommandBar
    On Error Resume Next
    Application.CommandBars(&quot;MyToolbar&quot;).Delete
    arr = Array(&quot;会计凭证&quot;, &quot;会计账簿&quot;, &quot;会计报表&quot;, &quot;凭证打印&quot;, &quot;账簿打印&quot;, &quot;报表打印&quot;)
    id = Array(9893, 284, 9590, 9614, 707, 986)
    Set Toolbar = Application.CommandBars.Add(&quot;MyToolbar&quot;, msoBarTop)
        With Toolbar
            .Protection = msoBarNoResize
            .Visible = True
            For i = 0 To 5
                With .Controls.Add(Type:=msoControlButton)
                    .Caption = arr(i)
                    .FaceId = id(i)
                    .BeginGroup = True
                    .Style = msoButtonIconAndCaptionBelow
                End With
            Next
        End With
    Set Toolbar = Nothing
End Sub
代码解析：
NowToolbar过程使用Add方法在Excel窗口中创建自定义工具栏。应用于CommandBars对象的Add方法请参阅技巧83 。
第10行代码，使用Add方法在菜单栏上创建名称为“MyToolbar”的命令栏，创建时设置新命令栏的Position参数为msoBarTop，使新命令栏位于应用程序窗口的顶部。如果将Position参数设置成msoBarFloating，新命令栏为浮动工具栏，如图 89 1所示。

图 89 1    浮动命令栏
关于Position参数的MsoBarPosition常数请参阅技巧83 中的表格 83 1。
第12行代码，设置“MyToolbar”命令栏的Protection属性为msoBarNoResize。应用于CommandBar对象的Protection属性指定命令栏的保护类型，可以为表格 89 1所列的MsoBarProtection常数之一。</code></pre>
<p>常数    值    说明<br>msoBarNoProtection    0    不受保护，可自定义(缺省值)<br>msoBarNoCustomize    1    不能自定义<br>msoBarNoResize    2    不能调整大小<br>msoBarNoMove    4    不能移动<br>msoBarNoChangeVisible    8    不能更改可见状态<br>msoBarNoChangeDock    16    不能改变停靠的位置<br>msoBarNoVerticalDock    32    不能沿窗口左侧或右侧停放<br>msoBarNoHorizontalDock    64    不能沿窗口顶部或底部停放<br>表格 89 1    MsoBarProtection常数<br>第14行到第21代码，使用Add方法在新命令栏中添加按钮控件，设置按钮控件的各项属性。其中第19行代码，设置按钮控件的Style属性为msoButtonIconAndCaptionBelow，使工具栏按钮显示时包含图标和标题，且标题位于图标之下。<br>应用于CommandBar对象的Style属性返回或设置工具栏按钮的显示方式，可以为表格 89 2所列的MsoButtonStyle常数之一。<br>常数    值    说明<br>msoButtonIcon    1    包含图标的按钮<br>msoButtonCaption    2    包含标题的按钮<br>ButtonIconandCaption    3    包含图标和标题的按钮<br>msoButtonIconAndCaptionBelow    11    包含图标和标题，且标题位于底部的按钮<br>msoButtonIconAndWrapCaption    7    包含图标和标题，且标题自动换行的按钮<br>msoButtonWrapCaption    14    包含标题，且标题自动换行的按钮<br>表格 89 2    MsoButtonStyle常数<br>运行NowToolbar过程，将在Excel窗口的顶部创建一个自定义的工具栏，如图 89 2所示。</p>
<p>图 89 2    创建自定义工具栏</p>
<h3 id="技巧90-自定义工具栏按钮图标"><a href="#技巧90-自定义工具栏按钮图标" class="headerlink" title="技巧90     自定义工具栏按钮图标"></a>技巧90     自定义工具栏按钮图标</h3><p>在创建自定义的工具栏时，除了可以为工具栏按钮添加Excel内置的图标外，还能为工具栏按钮添加自定义的图标，如下面的代码所示。</p>
<pre><code class="vb">Sub AddCustomButton()
    Dim xBar As CommandBar
    Dim xButton As CommandBarButton
    On Error Resume Next
    Application.CommandBars(&quot;CustomBar&quot;).Delete
    Set xBar = CommandBars.Add(&quot;CustomBar&quot;, msoBarTop)
    Set xButton = xBar.Controls.Add(msoControlButton)
    With xButton
        .Picture = LoadPicture(ThisWorkbook.Path &amp; &quot;\P.BMP&quot;)
        .Mask = LoadPicture(ThisWorkbook.Path &amp; &quot;\M.BMP&quot;)
        .TooltipText = &quot;Excel Home 论坛&quot;
    End With
    xBar.Visible = True
    Set xBar = Nothing
    Set xButton = Nothing
End Sub
代码解析：
AddCustomButton过程创建自定义工具栏，并设置工具栏的按钮自定义图标。
第6、7行代码，使用Add方法在Excel窗口中添加自定义工具栏和按钮。请参阅技巧89 。
第9行代码，设置工具栏按钮的Picture属性为同一目录中的p.bmp图片。
应用于CommandBarButton 对象的Picture属性返回一个IPictureDisp对象，表示 CommandBarButton对象的图像，语法如下：
expression.Picture
参数是必需的，返回一个CommandBarButton对象。
指定对象的Picture属性就能设置对象的图像。
第10行代码，设置工具栏按钮的Mask属性为同一目录中的m.bmp图片。
为了使工具栏按钮图标透明显示，在指定对象的Picture属性后，还需要指定对象的Mask属性。
应用于CommandBarButton 对象的Mask属性返回表示CommandBarButton对象的屏蔽图像的IPictureDisp对象，语法如下：
expression.Mask
参数是必需的，返回一个CommandBarButton对象。
屏蔽图像决定按钮图像透明的部分。在创建作为屏蔽图像使用的图像时，所有要透明的区域应该为白色，所有要显示的区域应该为黑色。
第11行代码，设置按钮的“屏幕提示”为“ExcelHome论坛”。
运行AddCustomButton过程，创建自定义工具栏，并设置工具栏按钮的图标，如图 90 1所示。

图 90 1    自定义工具栏图标</code></pre>
<h3 id="技巧91-自定义工作簿图标"><a href="#技巧91-自定义工作簿图标" class="headerlink" title="技巧91     自定义工作簿图标"></a>技巧91     自定义工作簿图标</h3><p>Excel标题栏的图标是默认的，而借助API函数可以自定义工作簿标题栏图标，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Declare Function DrawMenuBar Lib &quot;user32&quot; (ByVal hWnd As Long) As Long
Private Declare Function SetFocus Lib &quot;user32&quot; (ByVal hWnd As Long) As Long
Private Declare Function SendMessage Lib &quot;user32&quot; Alias &quot;SendMessageA&quot; (ByVal hWnd As Long, ByVal wMsg As Long, ByVal wParam As Integer, ByVal lParam As Long) As Long
Private Declare Function ExtractIcon Lib &quot;shell32.dll&quot; Alias &quot;ExtractIconA&quot; (ByVal hInst As Long, ByVal lpszExeFileName As String, ByVal nIconIndex As Long) As Long
Private Const WM_SETICON = &amp;H80
Private Sub Workbook_Open()
    Dim IStyle As Long
    Dim hIcon As Long
    Dim hWndForm As Long
    hWndForm = FindWindow(vbNullString, Application.Caption)
    hIcon = ExtractIcon(0, ActiveWorkbook.Path &amp; &quot;\p.bmp&quot;, 0)
    SendMessage hWndForm, WM_SETICON, True, hIcon
    SendMessage hWndForm, WM_SETICON, False, hIcon
End Sub
代码解析：
工作簿打开后使用API函数自定义工作簿标题栏的图标。
第1行到第6行代码，API函数声明。
第7行到第15行代码，工作簿的Open事件过程，把工作簿标题栏默认的图标更改为同一文件夹下的p.bmp图片。
工作簿打开后标题栏如图 91 1所示，任务栏图标如图 91 2所示。

图 91 1    自定义工作簿标题和图标

图 91 2    任务栏图标</code></pre>
<h3 id="技巧92-移除工作表的最小最大化和关闭按钮"><a href="#技巧92-移除工作表的最小最大化和关闭按钮" class="headerlink" title="技巧92     移除工作表的最小最大化和关闭按钮"></a>技巧92     移除工作表的最小最大化和关闭按钮</h3><p>如果不希望工作表的最小、最大化和关闭按钮出现在菜单栏中，可以使用以下代码去除：<br>ActiveWorkbook.Protect , , True<br>代码解析：<br>使用Protect方法对工作簿进行保护。Protect方法应用于Workbook对象的时保护工作簿使其不至被修改，语法如下：<br>expression.Protect(Password, Structure, Windows)<br>参数expression是必需的，该表达式返回一个Workbook对象。<br>参数Password是可选的，为工作表或工作簿指定区分大小写的密码。<br>参数Structure是可选的，如果为True，则保护工作簿结构（工作表的相对位置）。默认值为False。<br>参数Windows是可选的，如果为True，则保护工作簿窗口。<br>恢复工作表的最大、最小化和关闭按钮的代码如下：<br>ActiveWorkbook.Protect , , False<br>在本例中将Windows参数设置为True，使工作簿窗口受到保护，工作表的最小、最大化和关闭按钮及图标不出现在菜单栏中，如图 92 1所示。</p>
<p>图 92 1    移除工作表最小、最大化和关闭按钮</p>
<h3 id="技巧93-在工具栏上添加下拉列表框"><a href="#技巧93-在工具栏上添加下拉列表框" class="headerlink" title="技巧93     在工具栏上添加下拉列表框"></a>技巧93     在工具栏上添加下拉列表框</h3><p>如果需要在工具栏中添加类似“字体”这样的下拉列表控制框控件，那么可以使用下面的代码。</p>
<pre><code class="vb">Sub AddDropdown()
    Dim myDropdown As Object
    Dim myCap As Variant
    Dim i As Integer
    myCap = Array(&quot;基础应用&quot;, &quot;VBA程序开发&quot;, &quot;函数与公式&quot;)
    Call DeleteButton
    Set myDropdown = Application.CommandBars(&quot;Formatting&quot;).Controls _
        .Add(Type:=msoControlDropdown, Before:=1)
    With myDropdown
        .Caption = &quot;请选择版块&quot;
        .OnAction = &quot;myOnA&quot;
        .Style = msoComboNormal
        For i = 0 To UBound(myCap)
            .AddItem myCap(i)
        Next
        .ListIndex = 1
    End With
End Sub
Sub DeleteButton()
    With Application.CommandBars(&quot;Formatting&quot;).Controls(1)
        If .Caption = &quot;请选择版块&quot; Then .Delete
    End With
End Sub
Sub myOnA()
    Dim myList As Byte
    myList = Application.CommandBars(&quot;Formatting&quot;) _
        .Controls(1).ListIndex
    ActiveWorkbook.FollowHyperlink _
    Address:=&quot;http://club.excelhome.net/forum-&quot; &amp; myList &amp; &quot;-1.html&quot;, NewWindow:=True
End Sub
代码解析：
AddDropdown过程使用Add方法在工具栏中添加下拉列表控制框控件。
第5行代码使用Array函数创建一个数组用于保存下拉列表控制框控件加载列表项所需的元素。
第6行代码先运行第19行到第23行的DeleteButton过程删除可能存在的下拉列表控制框控件，以免重复添加。DeleteButton过程判断工具栏中第一个控件的Caption属性是否为“请选择版块”，如果是则删除该下拉列表控制框控件。
第7、8行代码使用Add方法在工具栏中添加下拉列表控制框控件。应用于 CommandBarControls 对象的Add方法请参阅技巧79 。示例中将其参数Type设置为msoControlDropdown，添加的就是下拉列表控制框控件。
第10行代码设置下拉列表控制框控件的Caption属性，应用于 CommandBarControls 对象的Caption属性返回或设置指定命令栏控件的题注文字，也可作为默认的“屏幕提示”显示。
第11行代码设置改变下拉列表控制框控件的内容时要运行的过程为第24行到第30行代码的myOnA过程。myOnA过程根据下拉列表控制框控件的ListIndex属性值打开Excel Home论坛中相应的版块。
第12行代码设置下拉列表控制框控件的样式。Style属性返回或设置命令栏控件的显示方式，该属性值可设置为表格 93 1所列MsoComboStyle常量之一。
常量    值    描述
msoComboLabel    1    显示标签
msoComboNormal    0    不显示标签
表格 93 1    MsoComboStyle常量
第13行到第15行代码使用AddItem方法将数组中的元素添加到下拉列表控制框控件的列表项中。
第16行代码将下拉列表控制框控件的ListIndex属性设置为1，使其显示第一条列表项。
运行AddDropdown过程，工具栏如图 93 1所示。

图 93 1    添加下拉列表控制框控件</code></pre>
<h3 id="技巧94-屏蔽工作表的复制功能"><a href="#技巧94-屏蔽工作表的复制功能" class="headerlink" title="技巧94     屏蔽工作表的复制功能"></a>技巧94     屏蔽工作表的复制功能</h3><p>有时我们并不希望用户对工作表中的数据进行复制粘贴操作，此时可以把所有的复制功能都屏蔽，如下面的代码所示。</p>
<pre><code class="vb">    Dim CmdCtrls As CommandBarControls
    Dim Cmd As CommandBarControl
Sub ProCopy()
    Set CmdCtrls = Application.CommandBars.FindControls(ID:=19)
    For Each Cmd In CmdCtrls
        Cmd.Enabled = False
    Next
    Application.CellDragAndDrop = False
    Application.OnKey (&quot;^c&quot;), &quot;&quot;
End Sub
Sub StaCopy()
    Set CmdCtrls = Application.CommandBars.FindControls(ID:=19)
    For Each Cmd In CmdCtrls
        Cmd.Enabled = True
    Next
    Application.CellDragAndDrop = True
    Application.OnKey (&quot;^c&quot;)
End Sub
代码解析：
第1、2行代码在模块顶部声明两个模块级的变量。
第3行到第10行代码ProCopy过程，屏蔽工作表中所有的复制功能。其中第4行到第7行代码使用FindControls方法将所有与“复制”相关的命令栏控件赋给变量CmdCtrls后将其Enabled设置为False。关于FindControls方法请参阅技巧80 。
第8行代码屏蔽单元格拖放功能，关于应用于Application对象的CellDragAndDrop属性请参阅技巧10 。
第9行代码屏蔽&lt;Ctrl+C&gt;组合键功能，关于应用于Application 对象的OnKey方法请参阅技巧68 。
第11行到第18行代码StaCopy过程，恢复所有的复制功能。
### 技巧95     禁用工具栏的自定义
在Excel中，用户可以通过依次单击菜单“视图”→“工具栏”→“自定义”，显示“自定义”选项卡来调整菜单栏和工具栏，如图 95 1、图 95 2所示。

图 95 1    自定义功能

图 95 2    自定义选项卡</code></pre>
<p>如果不希望用户使用“自定义”选项卡来调整菜单栏和工具栏，可以禁用工具栏的自定义功能，如下面的代码所示。</p>
<pre><code class="vb">Sub nCustomize()
    Application.CommandBars.DisableCustomize = True
End Sub
代码解析：
nCustomize 过程禁用工具栏的自定义功能，应用于CommandBars 集合对象的DisableCustomize属性设置是否禁用工具栏的自定义。如果禁用，返回True，否则返回False。
用于启用工具栏的自定义的代码是：
Sub yCustomize()
    Application.CommandBars.DisableCustomize = False
End Sub
运行nCustomize过程，禁用工具栏的自定义对话框，自定义菜单项消失,如图 95 3所示。

图 95 3    禁用工具栏的自定义</code></pre>
<h3 id="技巧96-屏蔽所有的命令栏"><a href="#技巧96-屏蔽所有的命令栏" class="headerlink" title="技巧96     屏蔽所有的命令栏"></a>技巧96     屏蔽所有的命令栏</h3><p>在使用自定义的操作界面时，需要屏蔽Excel中所有的命令栏，可以使用下面的代码。</p>
<pre><code class="vb">Sub Shielding_1()
    Dim i As Integer
    For i = 1 To Application.CommandBars.Count
        Application.CommandBars(i).Enabled = False
    Next
End Sub
代码解析：
Shielding_1过程使用For...Next语句遍历Excel命令栏，并将其Enabled属性设置为False，使之无效。\</code></pre>
<p>还可以使用For Each…Next 语句遍历所有的CommandBars对象，代码如下：</p>
<pre><code class="vb">Sub Shielding_2()
    Dim Cmd As CommandBar
    For Each Cmd In Application.CommandBars
        Cmd.Enabled = False
    Next
End Sub
运行Shielding_1或Shielding_2过程工作簿如图 96 1所示。</code></pre>
<p>图 96 1    屏蔽所有的命令栏<br>在需要恢复时只需将Enabled属性设置为True即可，如下面的代码所示。</p>
<pre><code class="vb">Sub Recovery_1()
    Dim i As Integer
    For i = 1 To Application.CommandBars.Count
        Application.CommandBars(i).Enabled = True
    Next
End Sub
Sub Recover_2()
    Dim Cmd As CommandBar
    For Each Cmd In Application.CommandBars
        Cmd.Enabled = True
    Next
End Sub
代码解析：
Recovery_1和Recover_2过程分别使用For...Next语句和For Each...Next 语句遍历所有的CommandBars对象，设置其Enabled属性为True，显示所有的命令栏。</code></pre>
<h3 id="技巧97-恢复Excel的命令栏"><a href="#技巧97-恢复Excel的命令栏" class="headerlink" title="技巧97     恢复Excel的命令栏"></a>技巧97     恢复Excel的命令栏</h3><p>如果用户经常添加、删除Excel的菜单和工具栏而又没有及时恢复的话，有时会破坏Excel默认的用户界面，即使用Reset方法也不能恢复成初始状态。<br>此时可以在电脑的本地硬盘中查找扩展名为<em>.xlb的文件，该文件在电脑中的位置会因Excel版本的不同而不同，在XP操作系统中，该文件位于系统盘的Documents and Settings\Administrator\Application Data\Microsoft\Excel文件夹，其中Administrator是电脑的用户名。找到它最简单的方法是使用Windows的搜索功能。按&lt;Win+F&gt;组合键调出Windows的搜索窗口，然后用</em>.xlb为目标在本地硬盘中进行搜索，如图 97 1所示。</p>
<p>图 97 1    搜索*.xlb文件<br>如果搜索没有结果，请检查“更多高级选项”中是否选中“搜索隐藏的文件和文件夹”选项，如图 97 2所示。</p>
<p>图 97 2    搜索隐藏的文件和文件夹<br>对Excel用户界面的任何修改都会保存在<em>.xlb文件中，找到后删除该文件，然后重新启动Excel。Excel会重新创建一个</em>.xlb文件，而菜单和工具栏也会全部恢复成初始状态。</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/27/VBA常用技巧7--菜单和工具栏/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧6--使用对话框" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/25/VBA常用技巧6--使用对话框/">VBA常用技巧6--使用对话框</a>
    </h1>
  

        
        <a href="/2018/05/25/VBA常用技巧6--使用对话框/" class="archive-article-date">
  	<time datetime="2018-05-24T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-25</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第6章-使用对话框"><a href="#第6章-使用对话框" class="headerlink" title="第6章     使用对话框"></a>第6章     使用对话框</h2><h3 id="技巧73-使用Msgbox函数"><a href="#技巧73-使用Msgbox函数" class="headerlink" title="技巧73     使用Msgbox函数"></a>技巧73     使用Msgbox函数</h3><h4 id="73-1-显示简单的提示信息"><a href="#73-1-显示简单的提示信息" class="headerlink" title="73-1    显示简单的提示信息"></a>73-1    显示简单的提示信息</h4><p>在使用Excel的过程中，如果需要向用户显示简单的提示信息，可以使用MsgBox函数显示一个消息框，如下面的代码所示。</p>
<pre><code class="vb">Sub mymsgbox()
    MsgBox &quot;欢迎光临Excel Home!&quot;
End Sub
代码解析：
Mymsgbox过程使用MsgBox函数显示一个消息框。MsgBox函数用于显示提示信息，语法如下：
MsgBox(prompt[, buttons] [, title] [, helpfile, context])
参数prompt是必需的，代表在消息框中作为信息显示的字符或字符串，最多只能接受约1024个字符，取决于所使用字符的宽度。
参数buttons是可选的，用于指定消息框中显示按钮的数目及类型、使用的图标样式、缺省按钮以及消息框的强制回应等。如果省略，则buttons参数的缺省值为0，消息框只显示“确定”按钮。
参数title是可选的，代表在消息框标题栏中作为标题的字符或字符串。如果省略，则在标题栏中显示“Microsoft Excel”。
参数helpfile和参数context是可选的，用来为消息框提供上下文相关帮助的帮助文件和帮助主题。如果提供了其中一个参数，则必须提供另一个参数，两者缺一不可。
运行Mymsgbox过程，显示如图 73 1所示的消息框。</code></pre>
<h4 id="73-2-定制个性化的消息框"><a href="#73-2-定制个性化的消息框" class="headerlink" title="73-2    定制个性化的消息框"></a>73-2    定制个性化的消息框</h4><p>如果希望MsgBox函数显示的消息框具有特定的按钮、图标和标题栏，那么可以使用MsgBox函数的buttons参数和title参数，如下面的代码所示。</p>
<pre><code class="vb">Sub Specialmsbox()
    MsgBox Prompt:=&quot;欢迎光临 Excel Home!&quot;, _
        Buttons:=vbOKCancel + vbInformation, _
        Title:=&quot;Excel Home&quot;
End Sub
代码解析：
Specialmsbox过程使用MsgBox函数显示一个具有特定的按钮、图标和标题栏的消息框。
第3行代码设置消息框的Buttons参数，使消息框显示时具有“确定”、“取消”按钮和信息消息图标。MsgBox函数的buttons参数设置值如表格 73 1所示。</code></pre>
<p>参数组    常数    值    描述<br>第一组设置消息框按钮数目和类型    vbOKOnly    0    只显示“确定”按钮（默认设置）<br>    VbOKCancel    1    显示“确定”和“取消”按钮<br>    VbAbortRetryIgnore    2    显示“放弃”、“重试”、和“忽略”按钮<br>    VbYesNoCancel    3    显示“是”、“否”和“取消”按钮<br>    VbYesNo    4    显示“是”和“否”按钮<br>    VbRetryCancel    5    显示“重试”和“取消”按钮<br>第二组设置图标的风格    VbCritical    16    显示危险消息图标<br>    VbQuestion    32    显示警告询问图标<br>    VbExclamation    48    显示警告消息图标<br>    VbInformation    64    显示信息消息图标<br>第三组设置默认按钮    vbDefaultButton1    0    第一个按钮为默认按钮<br>    vbDefaultButton2    256    第二个按钮为默认按钮<br>    vbDefaultButton3    512    第三个按钮为默认按钮<br>    vbDefaultButton4    768    第四个按钮为默认按钮<br>第四组设置消息框特征    vbApplicationModal    0    应用程序模式：用户必须对消息框作出响应才能继续使用当前的应用程序<br>    vbSystemModal    4096    系统模式：应用程序都被挂起直至用户对消息框作出响应<br>第五组附加选项    vbMsgBoxHelpButton    16384    在消息框上添加“帮助”按钮<br>    VbMsgBoxSetForeground    65536    将消息框设置为前景窗口<br>    vbMsgBoxRight    524288    显示右对齐的消息框<br>    vbMsgBoxRtlReading    1048576    指定在希伯来和阿拉伯语系统中显示的文本应当从右到左阅读<br>表格 73 1    MsgBox函数的buttons参数值<br>在设定buttons参数值时，这些值可以相加使用，但每一组中只能选择一个值。在程序代码中也可以使用buttons参数的常数名称，而不必使用实际数值。<br>第4行代码将消息框的Title参数设置为“Excel Home”，使消息框的标题栏显示“Excel Home”。<br>运行Specialmsbox过程后，显示一个如图 73 2所示的消息框，该消息框具有“Excel Home”标题、信息消息图标和“确定”、“取消”按钮并以“确定”按钮作为默认按钮。 </p>
<p>图 73 2    具有特定按钮、图标和标题栏的消息框</p>
<h4 id="73-3-获得消息框的返回值"><a href="#73-3-获得消息框的返回值" class="headerlink" title="73-3    获得消息框的返回值"></a>73-3    获得消息框的返回值</h4><p>如果希望能根据用户对于消息框的不同选择，进行相应的操作，可以对消息框的返回值进行判断，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim iMsg As Integer
    iMsg = MsgBox(&quot;文件即将关闭,是否保存?&quot;, 3 + 32)
    Select Case iMsg
        Case 6
            Me.Save
        Case 7
            Me.Saved = True
        Case 2
            Cancel = True
    End Select
End Sub
代码解析：
工作簿的BeforeClose过程，在关闭工作簿前使用MsgBox函数显示一个消息框，并根据用户的回应用进行相应的操作。
第3行代码，使用MsgBox函数显示一个具有“是”、“否”和“否”按钮的消息框，并把用户的回应，即消息框的返回值赋给变量iMsg。MsgBox是一个函数，这意味着它将返回一个值，如果希望获得返回值，可使用和第3行相似的代码，此时如果不使用括号将参数封闭起来，则会提示编译错误，如图 73 3所示。

图 73 3    提示编译错误
第4行到第11行代码，Select Case结构语句，根据变量iMsg的值判断用户的回应，如果变量iMsg的值为6，说明用户选择了“是”按钮，则使用Save方法保存工作簿；如果变量iMsg的值为7，说明用户选择了“否”按钮，则将工作簿的Saved属性设置为True，不保存更改而直接关闭工作簿。关于Save方法和Saved属性请参阅技巧45-2。如果变量iMsg的值为2，说明用户选择了“取消”按钮，是将BeforeClose过程的Cancel 参数设置为True，取消关闭工作簿操作。
MsgBox函数的返回值如表格 73 2所示，在程序代码中也可以使用常数名称，而不必使用实际数值。</code></pre>
<p>常数    值    描述<br>vbOK    1    确定<br>vbCancel    2    取消<br>vbAbort    3    放弃<br>vbRetry    4    重试<br>vbIgnore    5    忽略<br>vbYes    6    是<br>vbNo    7    否<br>表格 73 2    MsgBox函数的返回值<br>在关闭本工作簿时将显示一个如图 73 4所示的消息框，询问用户是否保存，并根据用户的回应用进行相应的操作。</p>
<p>图 73 4    询问消息框</p>
<h4 id="73-4-在消息框中排版"><a href="#73-4-在消息框中排版" class="headerlink" title="73-4    在消息框中排版"></a>73-4    在消息框中排版</h4><p>如果在消息框中显示的字符串很长，比如是一段多行的文字内容，为了达到美观的效果，需要首字缩进，并将各行分隔开来，如下面代码所示。</p>
<pre><code class="vb">Sub Newlinemsbox()
    MsgBox Space(4) &amp; &quot;欢迎来到 ExcelHome 技术论坛，全球最领先的 Excel 技术论坛之一。&quot; &amp; Chr(10) _
        &amp; Space(4) &amp; &quot;在这里，我们讨论 Microsoft  Office 系列产品的应用技术，重点讨论&quot; &amp; Chr(10) _
        &amp; &quot;Microsoft Excel。&quot; &amp; Chr(10) _
        &amp; Space(4) &amp; &quot;本论坛从属于 Excel Home 这一全球最大的华语 Excel 技术门户，目前&quot; &amp; Chr(10) _
        &amp; &quot;是个人、非营利性质的网站学习平台。&quot; &amp; Chr(10) _
        &amp; Space(4) &amp; &quot;Let’s do it better! 这是 Excel Home 的口号，我们的宗旨是帮助大&quot; &amp; Chr(10) _
        &amp; &quot;家解决在使用Office软件中的问题，提升自己的应用技能。&quot;
End Sub
代码解析：
Newlinemsbox过程使用消息框显示一段经过排版后的文本内容。
代码中使用Space 函数在每段的首字前插入4个空格，使首字缩进，在需要换行的地方插入换行符 （Chr(10)） 将各行分隔开来。也可以使用回车符 （Chr(13)）、或是回车与换行符的组合 （Chr(13) &amp; Chr（10)）换行。
在程序代码中也可以使用vbCrLf、vbNewLine等常数，而不必使用Chr 函数，如表格 73 3所示。</code></pre>
<p>常数    等于    描述<br>vbCrLf    Chr(13) + Chr(10)    回车符与换行符结合<br>vbCr    Chr(13)    回车符<br>vbLf    Chr(10)    换行符<br>vbNewLine    Chr(13) + Chr(10) or, on the Macintosh, Chr(13)    平台指定的新行字符<br>表格 73 3    回车符与换行符<br>运行Newlinemsbox过程, 用消息框显示一段经过排版后的文本内容,效果如图 73 5所示。</p>
<p>图 73 5    在消息框中排版</p>
<h4 id="73-5-对齐消息框中显示的信息"><a href="#73-5-对齐消息框中显示的信息" class="headerlink" title="73-5    对齐消息框中显示的信息"></a>73-5    对齐消息框中显示的信息</h4><p>在用消息框显示如图 73 6所示的工作表中多行多列的单元格区域时，如果只用换行符（Chr(10)）等进行换行，而数据列没有对齐，会使显示的信息显得杂乱无章，缺乏可读性，如图 73 7所示。</p>
<p>图 73 6    工作表单元格区域</p>
<p>图 73 7    没有对列进行分隔的消息框<br>为了达到消息框中显示信息各列对齐的效果，在使用换行符（Chr(10)）等进行换行的基础上，还需要使用制表符（Chr(9)）或常数vbTab，对数据列进行分隔，使之排列整齐，如下面代码所示。</p>
<pre><code class="vb">Sub Outmsbox()
    Dim sMsg As String
    Dim iRow As Integer
    Dim iCom As Integer
    For iRow = 1 To 11
        For iCom = 1 To 5
            sMsg = sMsg &amp; Cells(iRow, iCom) &amp; Chr(9)
        Next
        sMsg = sMsg &amp; Chr(10)
    Next
    MsgBox sMsg
End Sub
代码解析：
Outmsbox过程使用两层循环读取当前工作表中A1到E11单元格的内容，并用消息框显示出来。
第7行代码，iCom循环中在把逐列读取的单元格内容赋给变量myMsg时插入一个制表符（Chr(9)），对列进行分隔。
第9行代码，iRow循环中在读取下一行单元格内容赋给变量myMsg时插入一个换行符（Chr(10)），对行进行换行。
运行Outmsbox过程将用消息框显示当前工作表中A1至E11单元格区域中的内容，并排列整齐，如图 73 8所示。</code></pre>
<h3 id="技巧74-自动关闭的消息框"><a href="#技巧74-自动关闭的消息框" class="headerlink" title="技巧74     自动关闭的消息框"></a>技巧74     自动关闭的消息框</h3><p>在程序执行完毕后给用户一个提示信息，但用MsgBox函数显示的消息框将一直保持，需要用户单击“确定”或“关闭”按钮才会关闭。如果希望显示的消息框自动关闭，那么可以使用以下方法显示消息框。</p>
<pre><code class="vb">74-1    使用WshShell.Popup方法显示消息框
Sub WshShell()
    Dim WshShell As Object
    Set WshShell = CreateObject(&quot;Wscript.Shell&quot;)
    WshShell.popup &quot;执行完毕!&quot;, 2, &quot;提示&quot;, 64
    Set WshShell = Nothing
End Sub
代码解析：
WshShell过程使用WshShell.Popup方法显示消息框，2秒后自动关闭。
WshShell.Popup方法的语法如下：
WshShell.Popup(strText, [natSecondsToWait], [strTitle], [natType]) = intButton
参数strText是必需的，与Msgbox的Prompt参数类似，代表在消息框中作为信息显示的字符或字符串。如果显示的内容超过一行，可以在每一行之间用换行符 （Chr(10)）等将各行分隔开来。
参数natSecondsToWait是可选的，其时间单位为妙。如果提供natSecondsToWait参数且其值大于零，则消息框在natSecondsToWait 参数指定的秒数后关闭。
参数strTitle是可选的，代表在消息框标题栏中作为标题的字符或字符串，若省略，则窗口标题为“Windows 脚本宿主”。
参数natType是可选的，指定消息框中显示按钮的数目及类型、使用的图标样式、缺省按钮以及消息框的强制回应等，与MsgBox函数buttons参数相同，请参阅技巧73-2中的表格 73 1。
参数intButton指示用户所单击的按扭编号，与MsgBox函数的返回值相同，请参阅技巧73-3中的表格 73 2。若用户在natSecondsToWait 秒之前不单击按扭，则返回值为 -1 。
运行WshShell过程显示一个如图 74 1所示消息框，无需点击“确定”按纽，2秒后自动关闭。</code></pre>
<h4 id="74-2-使用API函数显示消息框"><a href="#74-2-使用API函数显示消息框" class="headerlink" title="74-2    使用API函数显示消息框"></a>74-2    使用API函数显示消息框</h4><p>使用API函数也可以达到这一效果，如下面的代码所示。</p>
<pre><code class="vb">Public Declare Function SetTimer Lib &quot;user32&quot; ( _
    ByVal hWnd As Long, _
    ByVal nIDEvent As Long, _
    ByVal uElaspe As Long, _
    ByVal lpTimerFunc As Long) As Long
Public Declare Function KillTimer Lib &quot;user32&quot; ( _
    ByVal hWnd As Long, _
    ByVal nIDEvent As Long) As Long
    Dim TID As Long
Sub Test()
    TID = SetTimer(0, 0, 2000, AddressOf CloseTest)
    MsgBox &quot;执行完毕!&quot;
End Sub
Sub CloseTest(ByVal hWnd As Long, ByVal uMsg As Long, ByVal idevent As Long, _
    ByVal Systime As Long)
    Application.SendKeys &quot;~&quot;, True
    KillTimer 0, TID
End Sub
代码解析：
第1行代码到第9行代码是API函数声明。
Test过程显示一个消息框并在3秒钟后运行CloseTest过程。
CloseTest过程发送一个确定键给Excel程序关闭显示的消息框。
运行Test过程显示一个如图 74 2所示的消息框并在2秒钟后关闭。</code></pre>
<h3 id="技巧75-使用InputBox函数"><a href="#技巧75-使用InputBox函数" class="headerlink" title="技巧75     使用InputBox函数"></a>技巧75     使用InputBox函数</h3><h4 id="75-1-简单的数据输入"><a href="#75-1-简单的数据输入" class="headerlink" title="75-1    简单的数据输入"></a>75-1    简单的数据输入</h4><p>Excel的使用过程中，有时需要用户输入简单的数据，此时可以使用InputBox函数显示一个对话框，供用户在对话框中输入数据信息，如下面的代码所示。</p>
<pre><code class="vb">Sub myInputBox()
    Dim sInt As String
    Dim r As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    sInt = InputBox(&quot;请输入人员姓名：&quot;)
    If Len(Trim(sInt)) &gt; 0 Then
        Sheet1.Cells(r + 1, 1) = sInt
    Else
        MsgBox &quot;您没有输入内容!&quot;
    End If
End Sub
代码解析：
myInputBox过程使用InputBox函数显示一个对话框供用户在对话框中输入数据，InputBox函数显示一个对话框，等待用户输入正文或按下按钮，并返回包含文本框内容的字符串，语法如下：
InputBox(prompt[, title] [, default] [, xpos] [, ypos] [, helpfile, context])
参数prompt是必需的，作为对话框消息出现的字符串表达式。
参数title是可选的，作为显示在对话框标题栏中的字符串表达式，如果省略title参数，则在标题栏中显示“Microsoft Excel”。
参数default是可选的，显示在文本框中的字符串表达式，在没有其它输入时作为缺省值，如果省略default参数，则文本框为空。
参数xpos是可选的，指定对话框的左边与屏幕左边的水平距离。如果省略xpos参数，则对话框会在水平方向居中。
参数ypos是可选的，指定对话框的上边与屏幕上边的距离。如果省略ypos参数，则对话框被放置在屏幕垂直方向距下边大约三分之一的位置。
参数helpfile和参数context是可选的，为对话框提供上下文相关的帮助和编号，如果提供了其中一个参数，则必须提供另一个参数，两者缺一不可。
第5行代码，使用InputBox函数显示一个提示用户输入邮政编码的对话框，其中“请输入人员姓名：”是必需的prompt参数，其他参数使用缺省值。
第4行代码，使用Len函数和Trim函数判断返回的去除空格后的字符串长度。如果字符串长度大于零，说明用户单击了对话框的“确定”按钮，则将用户输入的数据写到工作表的A列单元格。如果返回的是长度为零的字符串，说明用户单击了对话框的“取消”按钮，则显示一条提示消息。
因为当用户单击对话框的“确定”按钮后，InputBox函数返回包含文本框内容的字符串，如果用户单击对话框的“取消”按钮则返回一个长度为零的字符串（&quot;&quot;），通过返回的字符串长度可以判断用户做出的选择。
运行sInput过程将显示一个提示用户输入数据的对话框，如图 75 1所示。</code></pre>
<h4 id="75-2-使用对话框输入密码"><a href="#75-2-使用对话框输入密码" class="headerlink" title="75-2    使用对话框输入密码"></a>75-2    使用对话框输入密码</h4><p>使用InputBox函数显示的对话框输入密码简单方便，但有个明显的缺陷，就是输入过程中不能用占位符显示密码，不够安全。借助API函数可以在输入密码过程中以占位符“*”号来显示密码，如下面的代码所示。</p>
<pre><code class="vb">Public Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; (ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Public Declare Function FindWindowEx Lib &quot;user32&quot; Alias &quot;FindWindowExA&quot; (ByVal hWnd1 As Long, ByVal hWnd2 As Long, ByVal lpsz1 As String, ByVal lpsz2 As String) As Long
Public Declare Function SendMessage Lib &quot;user32&quot; Alias &quot;SendMessageA&quot; (ByVal hwnd As Long, ByVal wMsg As Long, ByVal wParam As Long, lParam As Any) As Long
Public Declare Function timeSetEvent Lib &quot;winmm.dll&quot; (ByVal uDelay As Long, ByVal uResolution As Long, ByVal lpFunction As Long, ByVal dwUser As Long, ByVal uFlags As Long) As Long
Public Declare Function timeKillEvent Lib &quot;winmm.dll&quot; (ByVal uID As Long) As Long
Public Declare Function GetTickCount Lib &quot;kernel32&quot; () As Long
Public Const EM_SETPASSWORDCHAR = &amp;HCC
Public lTimeID As Long
Sub TimeProc(ByVal uID As Long, ByVal uMsg As Long, ByVal dwUser As Long, ByVal dw1 As Long, ByVal dw2 As Long)
    Dim hwd As Long
    hwd = FindWindow(&quot;#32770&quot;, &quot;密码&quot;)
    If hwd &lt;&gt; 0 Then
        hwd = FindWindowEx(hwd, 0, &quot;edit&quot;, vbNullString)
        SendMessage hwd, EM_SETPASSWORDCHAR, 42, 0
        timeKillEvent lTimeID
    End If
  End Sub
Sub Password()
    Dim Password As Variant
    lTimeID = timeSetEvent(10, 0, AddressOf TimeProc, 1, 1)
    Password = InputBox(&quot;请输入密码：&quot;, &quot;密码&quot;)
    If Password = &quot;123456&quot; Then
        MsgBox &quot;密码正确!&quot;
    Else
        MsgBox &quot;密码错误!&quot;
    End If
End Sub
代码解析：
Password过程使用InputBox函数显示一个输入密码的对话框，并且以占位符“*”号显示输入的密码。
第1行到第8行代码，API函数声明。
第9行到第17行代码，TimeProc过程是timeSetEvent的回调函数，获得对话框句柄。
第18行到第27行代码，Password过程显示一个提示用户输入密码的对话框。
运行Password过程将显示一个密码输入框，输入的密码以占位符“*”号代替，如图 75 2所示。</code></pre>
<h3 id="技巧76-使用InputBox方法"><a href="#技巧76-使用InputBox方法" class="headerlink" title="技巧76     使用InputBox方法"></a>技巧76     使用InputBox方法</h3><p>在Excel中输入简单的数据可以使用InputBox函数显示的对话框，但是如果输入的数据类型不匹配时，过程运行时会产生意外错误。为了避免此类情况发生，可以使用另一种获得用户输入的方式——InputBox方法。</p>
<h4 id="76-1-输入指定类型的数据"><a href="#76-1-输入指定类型的数据" class="headerlink" title="76-1    输入指定类型的数据"></a>76-1    输入指定类型的数据</h4><p>使用InputBox方法输入数据时可以指定数据的类型，如下面的代码所示。</p>
<pre><code class="vb">Sub dInput()
    Dim dInput As Double
    Dim r As Integer
    r = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row
    dInput = Application.InputBox(Prompt:=&quot;请输入数字：&quot;, Type:=1)
    If dInput &lt;&gt; False Then
        Sheet1.Cells(r + 1, 1).Value = dInput
    Else
        MsgBox &quot;你已取消了输入!&quot;
    End If
End Sub
代码解析：
dInput过程使用InputBox方法显示一个提示用户输入数字的对话框。
InputBox方法显示一个接收用户输入的对话框，返回此对话框中输入的信息，语法如下：
expression.InputBox(Prompt, Title, Default, Left, Top, HelpFile, HelpContextId, Type)
参数expression是必需的，返回一个Application对象。
参数Prompt是必需的，作为对话框消息显示的字符串表达式。
参数Title是可选的，作为显示在对话框标题栏中的字符串表达式。如果省略Title参数，将使用默认的标题。
参数Default是可选的，在对话框显示时出现在文本框中的初始值。如果省略Default参数，则文本框为空。
参数Left是可选的，指定对话框相对于屏幕左上角的 x 坐标。
参数Top是可选的，指定对话框相对于屏幕左上角的 y 坐标。
参数HelpFile和参数HelpContextId是可选的，为对话框提供上下文相关的帮助和编号，如果提供了其中一个参数，则必须提供另一个参数，两者缺一不可。
参数Type是可选的，指定返回的数据类型。如果省略Type参数，对话框将返回文本。
InputBox方法的语法和InputBox函数的语法相似，最大的区别在于最后一个参数——Type。通过Type参数可以指定返回值的数据类型，表格 76 1列出了Type参数可以使用的数值。</code></pre>
<p>数值    期望的返回值<br>0    一个公式<br>1    一个数字<br>2    文本（字符串）<br>4    一个逻辑值，例如true或false<br>8    一个单元格引用<br>16    一个错误值<br>64    一个值的数组<br>表格 76 1    Type参数的值<br>这些数值可以相加使用，如果希望返回数字和文本，可以将Type参数设置为1+2。<br>InputBox方法与InputBox函数相比，优点是内置的出错处理。在第5行代码中将Type参数值设置为1，这意味着对话框只能输入数值。当用户输入的不是数值时，显示一个如图 76 1所示的消息框提示输入错误。</p>
<p>图 76 1    提示输入错误<br>第6行到第10行代码，如果用户单击对话框的“确定”按钮，将用户输入的数字写入工作表的A列单元格。如果用户单击对话框的“取消”按钮，则显示一条提示消息。<br>InputBox方法和InputBox函数的另一个区别是，当用户单击“取消”按纽时返回False而不是长度为零的字符串。<br>运行dInput过程将显示一个提示用户输入数字的对话框，如图 76 2所示。</p>
<p>图 76 2    InputBox方法显示的对话框<br>注意 在VBA代码中，Application.InputBox 调用的是InputBox方法，不带对象识别符的InputBox调用的是InputBox 函数。\</p>
<h4 id="76-2-获得单元格区域地址"><a href="#76-2-获得单元格区域地址" class="headerlink" title="76-2    获得单元格区域地址"></a>76-2    获得单元格区域地址</h4><p>InputBox方法很适合用户选择工作表单元格区域，并对所选择的单元格区域进行操作，如下面的代码所示。</p>
<pre><code class="vb">Sub RngInput()
    Dim rng As Range
    On Error GoTo line
    Set rng = Application.InputBox(&quot;请使用鼠标选择单元格区域：&quot;, , , , , , , 8)
    rng.Interior.ColorIndex = 15
line:
End Sub
代码解析：
RngInput过程使用InputBox方法显示一个对话框，提示用户在工作表中选择一个单元格区域，并改变所选单元格区域内部的颜色。
第3行代码，错误处理语句。因为当对话框显示后，如果用户单击“取消”按钮，将显示一错误信息，如图 76 3所示，所以必需使用On Error GoTo语句来绕过错误。

图 76 3    提示运行错误
第4行代码，使用Set语句将用户选择的单元格区域赋给变量rng。当Type参数设置为8时，将返回一个Range对象，必须用Set 语句将结果指定给一个Range对象。
第5行代码，改变用户所选单元格区域内部的颜色。
运行RngInput过程，将显示一个对话框，提示用户在工作表中选择一个单元格区域，并改变所选单元格区域内部的颜色，如图 76 4所示。</code></pre>
<p>图 76 4    使用InputBox方法获得区域地址</p>
<h3 id="技巧77-内置对话框"><a href="#技巧77-内置对话框" class="headerlink" title="技巧77     内置对话框"></a>技巧77     内置对话框</h3><h4 id="77-1-调用内置的对话框"><a href="#77-1-调用内置的对话框" class="headerlink" title="77-1    调用内置的对话框"></a>77-1    调用内置的对话框</h4><p>如果需要使用“打开”、“打印”等Excel内置对话框已经具有的功能，可以使用代码直接调用这些内置的对话框，如下面的代码所示。</p>
<pre><code class="vb">Sub DialogOpen()
    Application.Dialogs(xlDialogOpen).Show arg1:=ThisWorkbook.Path &amp; &quot;\*.xls&quot;
End Sub
代码解析：
DialogOpen过程显示内置的“打开”对话框并选定示例所在的文件夹。
显示内置对话框语法如下：
Application.Dialogs(xlDialogConst).Show
Dialogs集合代表所有的内置对话框，每个Dialog对象代表一个内置对话框，不能新建内置对话框或向该集合中添加内置对话框。
参数xlDialogConst是内置对话框的内置常量，每个常量都以“xlDialog”开头，其后是对话框的名称，如“打开”对话框的常量为“xlDialogOpen”。常用内置对话框的内置常量如表格 77 1所示。</code></pre>
<p>常量    值    说明<br>xlDialogActiveCellFont    476    单元格格式(字体）<br>xlDialogBorder    45    单元格格式(边框）<br>xlDialogCellProtection    46    单元格格式(保护）<br>xlDialogDeleteFormat    111    单元格格式(数字）<br>xlDialogFormatNumber    42    单元格格式(数字）<br>xlDialogPatterns    84    单元格格式(图案）<br>xlDialogClear    52    清除<br>xlDialogColumnWidth    47    列宽<br>xlDialogRowHeight    127    行高<br>xlDialogConditionalFormatting    583    条件格式<br>xlDialogDefineName    61    定义名称<br>xlDialogDefineStyle    229    样式<br>xlDialogDisplay    27    显示选项<br>xlDialogFont    26    字体<br>xlDialogSetBackgroundPicture    509    工作表背景<br>xlDialogInsert    55    插入<br>xlDialogInsertHyperlink    596    插入超链接<br>xlDialogInsertPicture    342    插入图片<br>xlDialogNew    119    新建工作簿<br>xlDialogOpen    1    打开<br>xlDialogSaveAs    5    另存为<br>xlDialogWorkbookCopy    283    移动或复制工作表（建立副本）<br>xlDialogWorkbookInsert    354    插入工作表<br>xlDialogWorkbookMove    282    移动或复制工作表<br>xlDialogWorkbookName    386    重命名工作表<br>xlDialogWorkbookNew    302    新建工作表<br>xlDialogWorkbookProtect    417    保护工作簿<br>xlDialogPageSetup    7    页面设置<br>xlDialogPrint    8    打印内容<br>xlDialogPrinterSetup    9    打印机设置<br>xlDialogPrintPreview    222    打印预览<br>xlDialogSetPrintTitles    23    设置打印标题<br>xlDialogRun    17    宏<br>xlDialogTable    41    模拟运算表<br>xlDialogSendMail    189    发送邮件<br>表格 77 1    内置对话框的内置常量<br>显示内置对话框使用Show方法，应用于Dialog对象的Show方法语法如下：<br>expression.Show(Arg1, Arg2, Arg3, Arg4, Arg5, Arg6, Arg7, Arg8, Arg9, Arg10, Arg11, Arg12, Arg13, Arg14, Arg15, Arg16, Arg17, Arg18, Arg19, Arg20, Arg21, Arg22, Arg23, Arg24, Arg25, Arg26, Arg27, Arg28, Arg29, Arg30)<br>参数expression是必需的，返回Dialog对象之一。<br>参数arg1到参数arg30是可选的，仅应用于内置对话框，是命令的初始参数。若要查找要设置的参数，请在内置对话框参数列表中查找对应的对话框常量。<br>运行alogOpen过程，显示内置的“打开”对话框，并且直接选定示例所在的文件夹，如图 77 1所示。</p>
<p>图 77 1    使用内置对话框</p>
<h4 id="77-2-获取选定文件的文件名"><a href="#77-2-获取选定文件的文件名" class="headerlink" title="77-2    获取选定文件的文件名"></a>77-2    获取选定文件的文件名</h4><p>如果只希望获取用户在显示的内置 “打开”对话框中选定文件的文件名，而不想真正打开该文件，那么可以使用GetOpenFilename方法，如下面的代码所示。</p>
<pre><code class="vb">Sub OpenFilename()
    Dim Filename As Variant
    Dim mymsg As Integer
    Dim i As Integer
    Filename = Application.GetOpenFilename(Title:=&quot;删除文件&quot;, MultiSelect:=True)
    If IsArray(Filename) Then
        mymsg = MsgBox(&quot;是否删除所选文件?&quot;, vbYesNo, &quot;提示&quot;)
        If mymsg = vbYes Then
            For i = 1 To UBound(Filename)
                Kill Filename(i) &#39;经询问用户后使用Kill语句从磁盘中删除用户选定的文件
            Next
        End If
    End If
End Sub
代码解析：
OpenFilename过程使用GetOpenFilename方法显示标准的内置“打开”对话框，获取用户选定文件的文件名后使用Kill语句删除。
GetOpenFilename方法显示标准的内置“打开”对话框，获取文件名，语法如下：
expression.GetOpenFilename(FileFilter, FilterIndex, Title, ButtonText, MultiSelect)
参数expression是必需的，返回一个Application对象。
参数FileFilter是可选的，指定文件筛选条件的字符串。如果省略，则默认参数值为“所有文件(*.*)”。
参数FilterIndex是可选的，指定默认文件筛选条件的索引号，取值范围为 1 到由 FileFilter 所指定的筛选条件数目。如果省略，或者取值大于可用筛选数目，则采用第一个文件筛选条件。
参数Title是可选的，指定对话框的标题。如果省略，则使用“打开”作为标题。
参数ButtonText是可选的，仅用于Macintosh。
参数MultiSelect是可选的，如果该值为True，则允许选定多个文件名，如果该值为False，则只允许选定单个文件名。默认值为False。
第5行代码显示标准的“打开”对话框，将对话框的标题设置为“删除文件”，将MultiSelect参数设置为True，允许选定多个文件。
第6行代码，获得返回值。当用户选定文件后，返回的是选定的文件名或用户输入的文件名。因为MultiSelect参数已设置为True，所以返回值将是一个包含所有选定文件名的数组（即使仅选定了一个文件名）。如果用户取消了对话框，则该值为False。
第8行到第12行代码，经询问用户后使用Kill语句从磁盘中删除用户选定的文件。
运行OpenFilename过程，显示标准的内置“打开”对话框，删除用户选定的文件，如所图 77 2示。
注意 VBA中数组下界默认从0开始，但使用GetOpenFilename方法选择多个文件时返回的包含选定文件名的数组下界是从1开始。</code></pre>
<h4 id="77-3-使用“另存为”对话框"><a href="#77-3-使用“另存为”对话框" class="headerlink" title="77-3    使用“另存为”对话框"></a>77-3    使用“另存为”对话框</h4><p>在备份文件时可以使用GetSaveAsFilename方法显示标准的内置“另存为”对话框，获取备份文件的文件名和保存路径，而无须真正保存任何文件。如下面的代码所示。</p>
<pre><code class="vb">Sub CopyFilename()
    Dim NowWorkbook As Workbook
    Dim FileName As String
    On Error GoTo line
    FileName = Application.GetSaveAsFilename _
        (InitialFileName:=&quot;D:\&quot; &amp; Date &amp; &quot; &quot; &amp; ThisWorkbook.Name, _
        fileFilter:=&quot;Excel files(*.xls),*.xls,All files (*.*),*.*&quot;, _
        Title:=&quot;数据备份&quot;)
    If FileName &lt;&gt; &quot;False&quot; Then
        Set NowWorkbook = Workbooks.Add
        With NowWorkbook
            .SaveAs FileName
            ThisWorkbook.Sheets(&quot;Sheet2&quot;).UsedRange.Copy _
            .Sheets(&quot;Sheet1&quot;).Range (&quot;A1&quot;)
            .Save
        End With
        GoTo line
    End If
    Exit Sub
line:
    ActiveWorkbook.Close
End Sub
代码解析：
CopyFilename过程使用GetSaveAsFilename方法显示标准的内置“另存为”对话框，获取备份文件的文件名和保存路径，新建工作簿保存备份数据。
第4行代码，错误处理语句。备份过程中，如果已存在同名工作簿，会出现如图 77 3所示的提示，如果选择了“否”，此时新工作簿已经建立，在执行第12行代码时发生错误，使程序中断，所以使用GoTo语句执行第21行代码，关闭新建立的工作簿。

图 77 3    文件已存在提示
第5行代码，使用GetSaveAsFilename方法显示标准的内置“另存为”对话框。GetSaveAsFilename方法的语法如下：
expression.GetSaveAsFilename(InitialFilename, FileFilter, FilterIndex, Title, ButtonText)
参数expression是必需的，返回一个Application对象。
参数InitialFilename是可选的，指定建议的文件名。如果省略，将活动工作簿的名称作为建议的文件名。
参数FileFilter是可选的，指定文件筛选条件的字符串。
参数FilterIndex是可选的，指定默认文件筛选条件的索引号，取值范围为 1 到 FileFilter 指定的筛选条件数目之间。如果省略，或者取值大于可用筛选数目，则采用第一个文件筛选条件。
参数Title是可选的，指定对话框标题。如果省略，则使用默认标题。
参数ButtonText是可选的，仅用于 Macintosh。
第6行代码，设置对话框的保存路径为D盘，保存文件名为日期加工作簿名称。
第7行代码，设置对话框文件保存类型为Excel文件类型。如果需要设置为文本类型需设置为“文本文件(*.txt), *.txt”，而如果是图片文件则需设置为“图片文件(*.bmp;*.jpg),* bmp;*.jpg”。
第8行代码，设置对话框的标题为“数据备份”。
第9行代码，如果用户没有取消操作。
第10行到第16行代码，使用Add方法新建工作簿保存到对话框选定的路径中，将数据备份到新工作簿中。
第17行代码，使用GoTo语句执行第21行代码，关闭新建工作簿和开启屏幕刷新。
运行CopyFilename过程，显示内置“另存为”对话框，供用户备份工作簿数据，如图 77 4所示。</code></pre>
<h3 id="技巧78-调用操作系统“关于”对话框"><a href="#技巧78-调用操作系统“关于”对话框" class="headerlink" title="技巧78     调用操作系统“关于”对话框"></a>技巧78     调用操作系统“关于”对话框</h3><p>VBA程序开发完成后，有时需要一个“关于”对话框，除了使用窗体外，还可以调用操作系统的“关于”对话框，显示自定义的内容，如下面的代码所示。</p>
<pre><code class="vb">Private Declare Function ShellAbout Lib &quot;shell32.dll&quot; Alias &quot;ShellAboutA&quot; ( _
        ByVal hwnd As Long, ByVal szApp As String, _
        ByVal szOtherStuff As String, ByVal hIcon As Long) As Long
Private Declare Function FindWindow Lib &quot;user32&quot; Alias &quot;FindWindowA&quot; ( _
        ByVal lpClassName As String, ByVal lpWindowName As String) As Long
Private Sub CommandButton1_Click()
    Dim ApphWnd As Long
    ApphWnd = FindWindow(&quot;XLMAIN&quot;, Application.Caption)
    ShellAbout ApphWnd, &quot;财务处理系统&quot;, &quot;yuanzhuping@yeah.net  0513-86548930&quot;, 0
End Sub
代码解析：
第1行到第5行代码是API函数声明。
第8、9行代码调用操作系统的“关于”对话框并显示自定义的内容。
代码运行后显示如图 78 1所示的对话框。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/25/VBA常用技巧6--使用对话框/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧5--Application对象" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/22/VBA常用技巧5--Application对象/">VBA常用技巧5--Application对象</a>
    </h1>
  

        
        <a href="/2018/05/22/VBA常用技巧5--Application对象/" class="archive-article-date">
  	<time datetime="2018-05-21T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-22</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第5章-Application对象"><a href="#第5章-Application对象" class="headerlink" title="第5章     Application对象"></a>第5章     Application对象</h2><h3 id="技巧64-取得Excel版本信息"><a href="#技巧64-取得Excel版本信息" class="headerlink" title="技巧64     取得Excel版本信息"></a>技巧64     取得Excel版本信息</h3><p>Application对象的Version属性可以返回Excel的版本号，如下面的代码所示。</p>
<pre><code class="vb">Sub AppVersion()
    Dim myVersion As String
    Select Case Application.Version
        Case &quot;8.0&quot;
            myVersion = &quot;97&quot;
        Case &quot;9.0&quot;
            myVersion = &quot;2000&quot;
        Case &quot;10.0&quot;
            myVersion = &quot;2002&quot;
        Case &quot;11.0&quot;
            myVersion = &quot;2003&quot;
        Case Else
            myVersion = &quot;版本未知&quot;
    End Select
    MsgBox &quot;Excel 版本是： &quot; &amp; myVersion
End Sub
代码解析：
AppVersion过程返回Application对象的Version属性值来取得Excel版本号。
应用于Application对象的Version属性返回Excel版本号，语法如下：
expression.Version
参数expression是必需的，Application对象。
运行AppVersion过程结果如图 64 1所示。</code></pre>
<p>图 64 1    取得Excel版本号</p>
<h3 id="技巧65-取得当前用户名称"><a href="#技巧65-取得当前用户名称" class="headerlink" title="技巧65     取得当前用户名称"></a>技巧65     取得当前用户名称</h3><p>使用Application对象的UserName属性可以取得当前用户名称，如下面的代码所示。</p>
<pre><code class="vb">Sub UserName()
    MsgBox &quot;当前用户名是: &quot; &amp; Application.UserName
End Sub
代码解析：
UserName过程使用消息框显示当前用户名称。
Application对象的UserName属性返回或设置当前用户的名称。
运行UserName过程效果如图 65 1所示。</code></pre>
<p>图 65 1    显示当前用户名称</p>
<h3 id="技巧66-Excel中的“定时器”"><a href="#技巧66-Excel中的“定时器”" class="headerlink" title="技巧66     Excel中的“定时器”"></a>技巧66     Excel中的“定时器”</h3><p>Excel VBA并没有提供定时器控件，但是用户可以通过Application对象的OnTime方法实现简单的定时器功能，如下面的代码所示。</p>
<pre><code class="vb">Sub StartTimer()
    Sheet1.Cells(1, 2) = Sheet1.Cells(1, 2) + 1
    Application.OnTime Now + TimeValue(&quot;00:00:01&quot;), &quot;StartTimer&quot;
End Sub
代码解析：
StartTimer过程，使用Application对象的OnTime方法循环调用StartTimer过程实现每隔一秒钟运行一次StartTimer过程，从而在B1单元格中不断地显示程序累计运行时间，如图 66 1所示。</code></pre>
<p>图 66 1    简单的定时器<br>第2行代码将B1单元格的值在原有的数字上加1。<br>第3行代码使用OnTime方法在1秒后重新调用StartTimer过程，使B1单元格的值不断的加1，从而显示程序累计运行时间。<br>应用于Application对象的OnTime方法能够安排一个过程在将来的特定时间运行，语法如下：<br>expression.OnTime(EarliestTime, Procedure, LatestTime, Schedule)<br>参数expression是必需的，返回一个Application对象。<br>参数EarliestTime是必需的，设置指定的过程开始运行的时间。使用Now + TimeValue(time)可以安排从现在开始经过一段时间之后运行某个过程，使用TimeValue(time)可以安排在指定的时间运行某个过程。<br>参数Procedure是必需的，设置要运行的过程名称。<br>参数LatestTime是可选的，设置过程开始运行的最晚时间。例如将参数LatestTime设置为EarliestTime+10，当时间到了EarliestTime时如果Excel不处于空闲状态，那么Excel将等待10秒，如果在10秒内Excel不能回到空闲状态，则不运行该过程。如果省略该参数，Excel将一直等待到可以运行该过程为止。<br>参数Schedule是可选的，如果其值为True（默认值），则安排一个新的OnTime过程，如果其值为False，则清除先前设置的过程。<br>取消定时的代码如下：</p>
<pre><code class="vb">Sub EndTimer()
    On Error GoTo Line
    Application.OnTime Now + TimeValue(&quot;00:00:01&quot;), &quot;StartTimer&quot;, , False
    Sheet1.Cells(1, 2) = 0
    Exit Sub
Line:
    MsgBox &quot;请先按[开始]按钮!&quot;
End Sub
代码解析：
EndTimer过程取消StartTimer过程的定时。
第2行代码错误处理语句，因为如果还没有运行StartTimer过程而先运行EndTimer过程取消定时，程序会提示错误，如图 66 2所示，因此使用On Error GoTo Line语句在错误发生时执行第7行代码显示一个如图 66 3所示的提示消息框。</code></pre>
<p>图 66 2    运行错误</p>
<p>图 66 3    提示消息框<br>第3行代码将StartTimer过程的Schedule参数设置为False，取消定时设置。</p>
<h3 id="技巧67-设置活动打印机的名称"><a href="#技巧67-设置活动打印机的名称" class="headerlink" title="技巧67     设置活动打印机的名称"></a>技巧67     设置活动打印机的名称</h3><p>使用Application 对象的ActivePrinter属性可以设置活动打印机的名称，如下面的代码所示。</p>
<pre><code class="vb">Sub myPrinter()
    Dim myPrinter As String
    myPrinter = &quot;HP LaserJet P1008 在 Ne04:&quot;
    Application.ActivePrinter = myPrinter
    MsgBox &quot;活动打印机为：&quot; &amp; Left(myPrinter, InStr(myPrinter, &quot;在&quot;) - 1)
End Sub
代码解析：
myPrinter过程将活动打印机设置为“HP LaserJet P1008”。
第3行代码指定需要设置为活动打印机的名称，第4行代码通过设置Application 对象的ActivePrinter属性将活动打印机设置为“HP LaserJet P1008”。
第5行代码使用消息框显示活动打印机的名称及型号。
运行myPrinter过程结果如图 67 1所示。</code></pre>
<p>图 67 1    设置活动打印机</p>
<h3 id="技巧68-屏蔽、改变组合键的功能"><a href="#技巧68-屏蔽、改变组合键的功能" class="headerlink" title="技巧68     屏蔽、改变组合键的功能"></a>技巧68     屏蔽、改变组合键的功能</h3><p>使用Application 对象的OnKey方法可以屏蔽或改变组合键的默认操作，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Application.OnKey &quot;^{c}&quot;, &quot;myOnKey&quot;
End Sub
Sub myOnKey()
    MsgBox &quot;本工作表禁止复制数据!&quot;
End Sub
代码解析：
第1行到第3行代码工作簿的Open事件，在工作簿打开时使用OnKey方法改变&lt;Ctrl +C&gt;组合键的功能。
应用于Application 对象的OnKey方法指定特定键或特定的组合键运行的过程，语法如下：
expression.OnKey(Key, Procedure)
参数expression是必需的，该表达式返回一个Application 对象。
参数Key是必需的，用于表示要按的键的字符串，具体请参阅VBA中的帮助。
参数Procedure是可选的，表示要运行的过程名称的字符串，本示例中将过程名称指定为第4行到第6行代码的“myOnKey”过程，当按下&lt;Ctrl +C&gt;组合键时并不会执行复制操作而只显示一个消息框。如果将Procedure参数指定为空文本（&quot;&quot;），则按&lt;Ctrl +C&gt;组合键时不发生任何操作，达到屏蔽组合键的效果。
如果省略Procedure参数，则按下&lt;Ctrl +C&gt;组合键时产生Microsoft Excel中的正常结果，同时清除先前使用OnKey方法所做的特殊击键设置，所以恢复&lt;Ctrl +C&gt;组合键的代码如下：
Application.OnKey &quot;^{c}&quot;
为了不影响其他工作簿的功能，恢复代码就放在工作簿的Deactivate事件中，如下面的代码所示：
Private Sub Workbook_Deactivate()
    Application.OnKey &quot;^{c}&quot;
End Sub
代码解析：
当工作簿从活动状态转为非活动状态时恢复&lt;Ctrl +C&gt;组合键的正常功能。</code></pre>
<h3 id="技巧69-设置Excel窗口标题栏"><a href="#技巧69-设置Excel窗口标题栏" class="headerlink" title="技巧69     设置Excel窗口标题栏"></a>技巧69     设置Excel窗口标题栏</h3><p>Excel主窗口标题栏默认的名称是“Microsoft Excel”，通过设置Application对象的Caption属性可以改变Excel主窗口的标题栏，如下面的代码所示。</p>
<pre><code class="vb">Sub AppCaption()
    Application.Caption = &quot;修改标题栏名称&quot;
    MsgBox &quot;下面将恢复默认的标题栏名称!&quot;
    Application.Caption = Empty
End Sub
代码解析：
第2行代码将Excel窗口标题设置为“修改标题栏名称”，如图 69 1所示。
图 69 1    设置Excel窗口标题
应用于Application对象的Caption属性设置显示在Microsoft Excel主窗口标题栏中的名称，语法如下：
expression.Caption
第3行代码恢复Microsoft Excel主窗口标题栏中的名称。如果未设置Caption属性（&quot;&quot;）或将其设置为Empty（表示未初始化的变量值），则本属性返回默认的“Microsoft Excel”。</code></pre>
<p>将Caption属性设置为常数vbNullChar（表示值为 0 的字符）可以删除标题栏中的名称，如下面的代码所示。</p>
<pre><code class="vb">Sub DleCaption()
    Application.Caption = vbNullChar
    MsgBox &quot;下面将恢复默认的标题栏名称!&quot;
    Application.Caption =Empty
End Sub
代码解析：
第2行代码删除Excel主窗口标题栏，结果如图 69 2所示。

图 69 2    删除Excel窗口标题栏的名称</code></pre>
<h3 id="技巧70-自定义Excel状态栏"><a href="#技巧70-自定义Excel状态栏" class="headerlink" title="技巧70     自定义Excel状态栏"></a>技巧70     自定义Excel状态栏</h3><p>Excel状态栏显示应用程序的当前状态（例如就绪、输入等）或上下文提示信息，通过设置Application对象的Statusbar属性可以修改状态栏，以显示用户自定义的信息，代码如下：</p>
<pre><code class="vb">Sub myStatusBar()
    Dim rng As Range
    For Each rng In Sheet1.Range(&quot;A1:D10000&quot;)
        Application.StatusBar = &quot;正在计算单元格 &quot; &amp; rng.Address(0, 0) &amp; &quot; 的数据...&quot;
        rng = 100
    Next
    Application.StatusBar = False
End Sub
代码解析：
myStatusBar过程在给选定单元格区域赋值的同时，将Excel状态栏中的文字设置为正在赋值的单元格地址。
应用于Application对象的StatusBar属性返回或设置状态栏中的文字，如果需要恢复默认的状态栏文字，将本属性设为False即可。
运行myStatusBar过程Excel状态栏如图 70 1所示。</code></pre>
<h3 id="技巧71-灵活退出Excel"><a href="#技巧71-灵活退出Excel" class="headerlink" title="技巧71     灵活退出Excel"></a>技巧71     灵活退出Excel</h3><p>在使用Close方法关闭工作簿时，既使当前只有一个打开的工作簿，也只能关闭工作簿而不能关闭Excel程序，而使用Application对象的Quit方法则会关闭所有打开的工作簿，下面的代码可以做到两者兼顾。</p>
<pre><code class="vb">Sub myQuit()
    If Workbooks.Count &gt; 1 Then
        ThisWorkbook.Close
    Else
        Application.Quit
    End If
End Sub
代码解析：
myQuit过程在关闭Excel程序时根据当前打开的工作簿数量决定采用何种方法关闭工作簿。
第2行代码使用Workbook集合的Count属性判断当前打开的工作簿文件数量。
第3行代码如当前打开两个或两个以上工作簿，使用Close方法关闭代码所在的工作簿。关于Close方法请参阅技巧45-1。
第5行代码如果当前只有一个打开的工作簿文件则使用Quit方法关闭Excel程序。应用于Application对象的Quit方法退出Excel程序，语法如下：
expression.Quit
参数expression是必需的，返回一个Application对象。
使用Quit方法关闭Excel程序时，如果有未保存的工作簿处于打开状态，则将弹出一个询问是否要保存所作更改的对话框，为避免对话框出现，可在使用Quit方法前保存所有的工作簿，或者将Application对象的DisplayAlerts属性设置为False，在退出Excel程序时，即使有未保存的工作簿，也不会显示对话框，而且不保存就退出。
如果一个工作簿的Saved属性值为True，但是并没有将工作簿保存到磁盘上，则Excel程序在退出时不会提示保存该工作簿。</code></pre>
<h3 id="技巧72-隐藏Excel主窗口"><a href="#技巧72-隐藏Excel主窗口" class="headerlink" title="技巧72     隐藏Excel主窗口"></a>技巧72     隐藏Excel主窗口</h3><p>如果希望在程序启动时或运行过程中隐藏Excel主窗口，有以下几种实现方法。</p>
<h4 id="72-1-设置Application对象的Visible属性"><a href="#72-1-设置Application对象的Visible属性" class="headerlink" title="72-1    设置Application对象的Visible属性"></a>72-1    设置Application对象的Visible属性</h4><p>当Application对象的Visible属性设置为False时，Application对象不可见，即能隐藏Excel主窗口，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Application.Visible = False
    UserForm1.Show
End Sub
代码解析：
代码工作簿的Open事件，在工作簿打开时将Application对象的Visible属性设置为False隐藏Excel主窗口。
显示Excel主窗口的方法是将Application对象的Visible属性重新设置为True。
当工作簿文件打开时，隐藏Excel主窗口，只显示用户登录窗体，如图 72 1所示。</code></pre>
<h4 id="72-2-将窗口移出屏幕"><a href="#72-2-将窗口移出屏幕" class="headerlink" title="72-2    将窗口移出屏幕"></a>72-2    将窗口移出屏幕</h4><p>设置Application对象的Left属性（从屏幕左边界至Microsoft Excel主窗口左边界的距离）和/或Top属性（从屏幕顶端到Microsoft Excel主窗口顶端的距离）将Application对象移出屏幕外，实现隐藏Excel主窗口，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    Application.WindowState = xlNormal
    Application.Left = 10000
    UserForm1.StartUpPosition = 2
    UserForm1.Show
End Sub
代码解析：
工作簿的Open事件过程，设置Application对象的Left属性为一个大的数值，从而将应用程序窗口移出屏幕。
第2行代码将应用程序窗口设置为正常状态，只有当应用程序窗口正常显示时才能够设置Application对象的Left属性。
第2行代码将Application对象的Left属性设置为一个大的数值，从而隐藏Excel主窗口。
第4行代码设置用户窗体的StartUpPosition属性值为2，使窗体显示在屏幕的中央。StartUpPosition属性返回或设置一个值，用来指定用户窗体第一次出现时的位置，请参阅技巧142 。
重新显示Excel主窗口的方法是将应用程序窗口设置为最大化状态代码如下：
Application.WindowState = xlMaximized
当工作簿文件打开时，隐藏Excel主窗口，只显示用户登录窗体，如图 72 2所示，与通过设置Visible属性实现的效果不同，设置Left属性在任务栏中仍然会显示应用程序窗口按钮。</code></pre>
<h4 id="72-3-设置工作簿作为加载宏运行"><a href="#72-3-设置工作簿作为加载宏运行" class="headerlink" title="72-3    设置工作簿作为加载宏运行"></a>72-3    设置工作簿作为加载宏运行</h4><p>利用加载宏不显示工作簿窗口的特点，设置工作簿作为加载宏运行来隐藏工作簿窗口，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_Open()
    ThisWorkbook.IsAddin = True
    UserForm1.Show
End Sub
代码解析：
工作簿的Open事件，在工作簿打开时设置其IsAddin属性值为True，指定工作簿作为加载宏运行。
当工作簿作为加载宏运行时，将有工作薄窗口不可见的特征，从而实现隐藏工作簿窗口的目的，如图 72 3所示。

图 72 3    隐藏工作簿窗口
重新显示Excel主窗口的方法是将工作簿的IsAddin属性值设置为False，以显示工作簿窗口。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/22/VBA常用技巧5--Application对象/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧4--Shape（图形）、Chart（图表）对象" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/13/VBA常用技巧4--Shape（图形）、Chart（图表）对象/">VBA常用技巧4--Shape（图形）、Chart（图表）对象</a>
    </h1>
  

        
        <a href="/2018/05/13/VBA常用技巧4--Shape（图形）、Chart（图表）对象/" class="archive-article-date">
  	<time datetime="2018-05-12T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-13</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第4章-Shape（图形）、Chart（图表）对象"><a href="#第4章-Shape（图形）、Chart（图表）对象" class="headerlink" title="第4章     Shape（图形）、Chart（图表）对象"></a>第4章     Shape（图形）、Chart（图表）对象</h2><h3 id="技巧53-在工作表中添加图形"><a href="#技巧53-在工作表中添加图形" class="headerlink" title="技巧53     在工作表中添加图形"></a>技巧53     在工作表中添加图形</h3><p>如果需要在工作表中添加图形对象，可以使用AddShape方法，如下面的代码所示。</p>
<pre><code class="vb">Sub AddShape()
    Dim myShape As Shape
    On Error Resume Next
    Sheet1.Shapes(&quot;myShape&quot;).Delete
    Set myShape = Sheet1.Shapes.AddShape(msoShapeRectangle, 40, 120, 280, 30)
    With myShape
        .Name = &quot;myShape&quot;
        With .TextFrame.Characters
            .Text = &quot;单击将选择Sheet2!&quot;
            With .Font
                .Name = &quot;华文行楷&quot;
                .FontStyle = &quot;常规&quot;
                .Size = 22
                .ColorIndex = 7
            End With
        End With
        With .TextFrame    
            .HorizontalAlignment = -4108
            .VerticalAlignment = -4108
        End With
        .Placement = 3
     End With
    myShape.Select
    With Selection.ShapeRange
        With .Line
            .Weight = 1
            .DashStyle = msoLineSolid
            .Style = msoLineSingle
            .Transparency = 0
            .Visible = msoTrue
            .ForeColor.SchemeColor = 40
            .BackColor.RGB = RGB(255, 255, 255)
        End With
        With .Fill
            .Transparency = 0
            .Visible = msoTrue
            .ForeColor.SchemeColor = 41
            .OneColorGradient 1, 4, 0.23
        End With
    End With
    Sheet1.Range(&quot;A1&quot;).Select
    Sheet1.Hyperlinks.Add Anchor:=myShape, Address:=&quot;&quot;, _
        SubAddress:=&quot;Sheet2!A1&quot;, ScreenTip:=&quot;选择Sheet2!&quot;
    Set myShape = Nothing
End Sub
代码解析：
AddShape过程在工作表中添加一个矩形并设置其外观等属性。
第2行代码声明变量myShape的对象类型。
第3、4行代码删除可能存在的名称为“myShape”的图形对象。
第5行代码使用AddShape方法在工作表中添加一个矩形。当该方法应用于Shapes对象时，返回一个Shape对象，该对象代表工作表中的新自选图形，语法如下：
expression.AddShape(Type, Left, Top, Width, Height)
参数expression是必需的，返回一个Shapes对象。
参数Type是必需的，指定要创建的自选图形的类型。
参数Left和Top是必需的，以磅为单位给出自选图形边框左上角的位置。
参数Width和Height是必需的，以磅为单位给出自选图形边框的宽度和高度。
第7行代码将新建图形命名为“myShape”，向Shapes集合添加新的图形时，将对新添加的图形赋以默认的名称，若要为图形指定更有意义的名称，可指定其Name属性。
第8行到第16行代码为矩形添加文字，并设定其格式。
其中第8行代码使用TextFrame 属性和Characters方法返回该矩形的字符区域。应用于Shape对象的TextFrame 属性返回一个TextFrame对象，该对象包含指定图形对象的对齐和定位属性；Characters方法返回一个Characters对象，该对象代表某个图形的文本框中的字符区域，语法如下：
expression.Characters(Start, Length)
参数expression是必需的，返回一个指定文本框内Characters对象的表达式。
参数Start是可选的，表示将要返回的第一个字符，如果此参数设置为 1 或被忽略，则Characters方法会返回以第一个字符为起始字符的字符区域。
参数Length是可选的，表示要返回的字符个数。如果此参数被忽略，则Characters方法会返回该字符串的剩余部分（由Start参数指定的字符以后的所有字符）。
第9行代码为矩形添加文字，应用于Characters对象的Text属性返回或设置对象的文本，为可读写的String类型。
第10行到第15行代码设置矩形中文字的属性，应用于Characters对象Font属性返回一个Font对象，该对象代表指定对象的字体属性（字体名称、字体大小、字体颜色等），第11行代码设置字体名称，第12行代码设置字体样式，第13行代码设置字体大小，第14行代码颜色。
第17行到第20行代码设定矩形中文字的对齐方式。应用于TextFrame对象的HorizontalAlignment属性返回或设置指定对象的水平对齐方式，可为表格 53 1所示的XlHAlign常量之一。</code></pre>
<p>常量    值    描述<br>xlHAlignCenter    -4108    居中<br>xlHAlignCenterAcrossSelection    7    靠左<br>xlHAlignDistributed    -4117    分散对齐<br>xlHAlignFill    5    分散对齐<br>xlHAlignGeneral    1    靠左<br>xlHAlignJustify    -4130    两端对齐<br>xlHAlignLeft    -4131    靠左<br>xlHAlignRight    -4152    靠右<br>表格 53 1    HorizontalAlignment属性的XlHAlign常量<br>应用于TextFrame对象的VerticalAlignment属性返回或设置指定对象的垂直对齐方式，可为表格 53 2所示的XlHAlign常量之一。<br>常量    值    描述<br>xlVAlignCenter    -4108    居中<br>xlVAlignJustify    -4130    两端对齐<br>xlVAlignBottom    -4107    靠下<br>xlVAlignDistributed    -4117    分散对齐<br>xlVAlignTop    -4160    靠上<br>表格 53 2    VerticalAlignment属性的XlHAlign常量<br>第21行代码设置矩形大小和位置不随单元格而变，应用于Shape对象的Placement属性返回或设置对象与所在的单元格之间的附属关系，可为表格 53 3所示的XlPlacement常量之一。<br>常量    值    描述<br>xlFreeFloating    3    大小、位置均固定<br>xlMove    2    大小固定、位置随单元格而变<br>xlMoveAndSize    1    大小、位置随单元格而变<br>表格 53 3    XlPlacement常量<br>第24行到第32行代码设置矩形的边框线条格式，应用于ShapeRange集合的Line属性返回一个LineFormat 对象，该对象包含指定图形的线条格式属性。<br>其中第26行代码设置矩形线条粗细，第27行代码设置矩形线条的虚线样式，第28行代码设置矩形填充的透明度，第29行代码设置矩形为可见，第30行代码设置矩形的前景色，第31行代码设置矩形填充背景的颜色。<br>第33行到第38行代码设置矩形的内部填充格式，应用于ShapeRange集合的Fill属性返回FillFormat对象，该对象包含指定的图表或图形的填充格式属性。<br>其中第35行代码设置矩形内部的透明度，第36行代码设置矩形内部为可见，第37行代码设置矩形内部的前景色，第38行代码将矩形内部指定填充设为单色渐变，应用于 FillFormat对象的OneColorGradient方法将指定填充设为单色渐变，语法如下：<br>expression.OneColorGradient(Style, Variant, Degree)<br>其中参数Style是必需的，底纹样式，可为表格 54 1所示的MsoGradientStyle常量之一。<br>常量    值    描述<br>msoGradientDiagonalDown    4    斜下<br>msoGradientDiagonalUp    3    斜上<br>msoGradientFromCenter    7    无<br>msoGradientFromCorner    5    角部幅射<br>msoGradientFromTitle    6    中心幅射<br>msoGradientHorizontal    1    水平<br>msoGradientMixed    -2    无<br>msoGradientVertical    2    垂直<br>表格 53 4    MsoGradientStyle常量<br>参数Variant是必需的，渐变变量。取值范围为 1 到 4 之间，分别与“填充效果”对话框中“渐变”选项卡的四个渐变变量相对应。如果GradientStyle 设为 msoGradientFromCenter，则Variant参数只能设为 1 或 2。<br>参数Degree是必需的，灰度。取值范围为 0.0（表示最深）到 1.0（表示最浅）之间。<br>第42、43行代码为矩形对象添加超链接，应用于Hyperlinks对象的Add方法向指定的区域或图形添加超链接，语法如下：<br>expression.Add(Anchor, Address, SubAddress, ScreenTip, TextToDisplay)<br>参数expression是必需的，返回一个Hyperlinks对象。<br>参数Anchor是必需的，超链接的位置。可为Range对象或Shape对象。<br>参数Address是必需的，超链接的地址。<br>参数SubAddress是必需的，超链接的子地址。<br>参数ScreenTip是可选的，当鼠标指针停留在超链接上时所显示的屏幕提示。<br>参数TextToDisplay是可选的，要显示的超链接的文本。<br>运行AddShape过程结果如图 53 1所示。</p>
<p>图 53 1    在工作表中添加图形</p>
<h3 id="技巧54-导出工作表中的图片"><a href="#技巧54-导出工作表中的图片" class="headerlink" title="技巧54     导出工作表中的图片"></a>技巧54     导出工作表中的图片</h3><p>有时需要将工作表中的图形对象保存为单独的图像文件，可以使用Export方法将工作表中的图片以文件形式导出，如下面的代码所示。</p>
<pre><code class="vb">Sub ExportShp()
    Dim Shp As Shape
    Dim FileName As String
    For Each Shp In Sheet1.Shapes
        If Shp.Type = msoPicture Then
            FileName = ThisWorkbook.Path &amp; &quot;\&quot; &amp; Shp.Name &amp; &quot;.gif&quot;
            Shp.Copy
            With Sheet1.ChartObjects.Add(0, 0, Shp.Width + 28, Shp.Height + 30).Chart
                .Paste
                .Export FileName, &quot;gif&quot;
                .Parent.Delete
            End With
        End If
    Next
End Sub
代码解析：
ExportShp过程将Sheet1工作表的所有图片以文件形式导出到同一目录中。
第4行代码使用For Each...Next 语句遍历Sheet1工作表中的所有图形。
第5行代码判断图形的类型是否为图片，应用于Shape对象的Type属性返回或设置图形类型，可以为表格 54 1所示的MsoShapeType常量之一。</code></pre>
<p>常量    值    说明<br>msoShapeTypeMixed    -2    混合型图形<br>msoAutoShape    1    自选图形<br>msoCallout    2    没有边框线的标注<br>msoChart    3    图表<br>msoComment    4    批注<br>msoFreeform    5    任意多边形<br>msoGroup    6    图形组合<br>msoFormControl    8    窗体控件<br>msoLine    9    线条<br>msoLinkedOLEObject    10    链接式或内嵌OLE对象<br>msoLinkedPicture    11    剪贴画或图片<br>msoOLEControlObject    12    ActiveX 控件<br>msoPicture    13    图片<br>msoTextEffect    15    艺术字<br>msoTextBox    17    文本框<br>msoDiagram    21    组织结构图或其他图示<br>表格 54 1    MsoShapeType常量<br>第6行代码使用字符串变量FileName记录需导出图形的路径和名称。<br>第7行代码复制图形，应用于Shape对象的Copy方法将对象复制到剪贴板。<br>第8行代码使用Add方法在工作表中添加一个图表，应用于ChartObjects对象的Add 方法创建新的嵌入图表，语法如下：<br>expression.Add(Left, Top, Width, Height)<br>参数expression是必需的，返回一个ChartObjects对象。<br>参数Left、参数Top是必需的，以磅为单位给出新对象的初始坐标，该坐标是相对于工作表上单元格A1的左上角或图表的左上角的坐标。<br>参数Width、参数Height是必需的，以磅为单位给出新对象的初始大小。<br>第9行代码使用Paste方法将图形粘贴到新的嵌入图表中，应用于Chart对象的Paste方法将剪贴板中的图表数据粘贴到指定的图表中，语法如下：<br>expression.Paste(Type)<br>参数expression是必需的，返回一个Chart对象。<br>参数Type是可选的的，如果剪贴板中有图表，本参数指定要粘贴的图表信息。可为以下XlPasteType常量之一：xlFormats、xlFormulas或xlAll。默认值为xlAll，如果剪贴板中是数据不是图表，则不能使用本参数。<br>第10行代码使用Export方法将图表导出到同一目录中，应用于Chart对象的Export方法以图形格式导出图表，语法如下：<br>expression.Export(Filename, FilterName, Interactive)<br>其中参数Filename是必需的，被导出的文件的名称。<br>第10行代码删除新建的图表。因为Chart对象是不能使用Delete方法直接删除的，应先使用Parent属性返回指定对象的父对象，然后使用Delete方法删除。</p>
<h3 id="技巧55-在工作表中添加艺术字"><a href="#技巧55-在工作表中添加艺术字" class="headerlink" title="技巧55     在工作表中添加艺术字"></a>技巧55     在工作表中添加艺术字</h3><p>在工作表中插入艺术字，可以使用AddTextEffect方法，如下面的代码所示。</p>
<pre><code class="vb">Sub TextEffect()
    Dim myShape As Shape
    On Error Resume Next
    Sheet1.Shapes(&quot;myShape&quot;).Delete
    Set myShape = Sheet1.Shapes.AddTextEffect _
            (PresetTextEffect:=msoTextEffect15, _
            Text:=&quot;我爱 Excel Home&quot;, FontName:=&quot;宋体&quot;, FontSize:=36, _
            FontBold:=msoFalse, FontItalic:=msoFalse, _
            Left:=100, Top:=100)
    With myShape
        .Name = &quot;myShape&quot;
        With .Fill
            .Solid
            .ForeColor.SchemeColor = 55
            .Transparency = 0
        End With
        With .Line
            .Weight = 1.5
            .DashStyle = msoLineSolid
            .Style = msoLineSingle
            .Transparency = 0
            .ForeColor.SchemeColor = 12
            .BackColor.RGB = RGB(255, 255, 255)
        End With
    End With
    Set myShape = Nothing
End Sub
代码解析：
TextEffect过程在工作表中插入艺术字并设置其格式。
第3、4行代码删除工作表中可能存在的艺术字，以免重复添加。
第5行到第9行代码使用AddTextEffect方法在工作表中插入艺术字，AddTextEffect方法创建艺术字对象。返回一个Shape对象，该对象代表新建的艺术字对象，语法如下：
expression.AddTextEffect(PresetTextEffect, Text, FontName, FontSize, FontBold, FontItalic, Left, Top)
参数expression是必需的，返回一个Shapes对象。
参数PresetTextEffect是必需的，艺术字预置文本效果，可为MsoPresetTextEffect 常量之一，等同于在工作表中插入艺术字时的样式选项卡，如图 55 1所示。</code></pre>
<p>图 55 1    艺术字样式<br>参数Text是必需的，艺术字对象中的文字。<br>参数FontName是必需的，艺术字对象中所用的字体名称。<br>参数FontSize是必需的，以磅为单位给出艺术字对象中所用的字体大小。<br>参数FontBold是必需的，在艺术字中要加粗的字体。<br>参数FontItalic是必需的，在艺术字中要倾斜的字体。<br>参数Left和参数Top是必需的，相对于文档的左上角、顶部，以磅为单位给出艺术字对象边框左上角的位置。<br>第11行代码将艺术字对象重命名为“myShape”。<br>第12行到第16行代码设置艺术字对象的填充格式。其中第13行代码将填充格式设置为均一的颜色，应用于FillFormat 对象的Solid方法将指定的填充格式设置为均一的颜色，可用本方法将带有渐进色、纹理、图案或背景的填充格式转换为单色的填充格式。第14行代码设置填充的颜色。第15行代码设置填充的透明度。<br>第17行到第24行代码设置艺术字对象的线条格式属性。其中第18行代码设置线条粗细，第19行代码设置线条虚线样式，第20行代码设置线条区域的样式，第21行代码设置线条的透明度，第22行代码设置前景色，第23行代码设置填充背景的颜色。<br>运行TextEffect过程工作表中如图 55 2所示。</p>
<p>图 55 2    工作表中插入艺术字</p>
<h3 id="技巧56-遍历工作表中的图形"><a href="#技巧56-遍历工作表中的图形" class="headerlink" title="技巧56     遍历工作表中的图形"></a>技巧56     遍历工作表中的图形</h3><p>工作表中的多个图形，如果使用系统缺省名称，如“文本框1”、“文本框2”这样前面是固定的字符串，后面是序号的，可以使用For…Next 语句遍历图形，如下面的代码所示。</p>
<pre><code class="vb">Sub ErgShapes_1()
    Dim i As Integer
    For i = 1 To 4
       Sheet1.Shapes(&quot;文本框 &quot; &amp; i).TextFrame.Characters.Text = &quot;&quot;
    Next
End Sub
代码解析：
ErgShapes_1过程清除工作表中四个图形文本框中的文字。
第3行到第5行代码，使用Shapes属性在工作表上的三个图形文本框中循环。
Shapes属性返回Shapes对象，代表工作表或图形工作表上的所有图形，可以使用Shapes（index）返回单个的Shape对象，其中index是图形的名称或索引号。
返回单个的Shape对象后使用TextFrame 属性和Characters方法清除文本框中的字符，关于Shape对象的TextFrame 属性和Characters方法请参阅技巧53 。
如果图形的名称没有规律，可以使用For Each...Next </code></pre>
<p>语句循环遍历所有图形，根据Type属性返回的图形类型进行相应的操作，如下面的代码所示。</p>
<pre><code class="vb">Sub ErgShapes_2()
    Dim myShape As Shape
    Dim i As Integer
    i = 1
    For Each myShape In Sheet1.Shapes
        If myShape.Type = msoTextBox Then
            myShape.TextFrame.Characters.Text = &quot;这是第&quot; &amp; i &amp; &quot;个文本框&quot;
            i = i + 1
        End If
    Next
End Sub
代码解析：
ErgShapes_2过程在工作表中的所有图形文本框中写入文本。
第5行代码使用For Each...Next 语句循环遍历工作表中所有的图形对象。
第6行到第9行代码如果图形对象是文本框则在文本框中写入文本。其中第6行代码根据Type属性判断图形对象是否为文本框，应用于Shape对象的Type属性返回或设置图形类型，MsoShapeType类型，请参阅表格 54 1 。
第7行代码根据返回的Type属性值在所有的文本框内写入相应的文本，如图 56 1所示。</code></pre>
<p>图 56 1    遍历所有的文本框</p>
<h3 id="技巧57-移动、旋转图片"><a href="#技巧57-移动、旋转图片" class="headerlink" title="技巧57     移动、旋转图片"></a>技巧57     移动、旋转图片</h3><p>工作表中的图片可以移动、旋转，如下面的代码所示。</p>
<pre><code class="vb">Sub MoveShape()
    Dim i As Long
    Dim j As Long
    With Sheet1.Shapes(1)
        For i = 1 To 3000 Step 5
           .Top = Sin(i * (3.1416 / 180)) * 100 + 100
           .Left = Cos(i * (3.1416 / 180)) * 100 + 100
           .Fill.ForeColor.RGB = i * 100
            For j = 1 To 10
                .IncrementRotation -2
                DoEvents
            Next
        Next
    End With
End Sub
代码解析：
MoveShape过程移动、旋转工作表中的图片并不断改变其填充的前景色。
第6行代码设置图片的Top属性值，应用于Shape对象的Top属性设置图形的顶端到工作表顶端的距离。在循环的过程中使用Sin函数将Top属性值设置为一个圆形的弧度值。Sin函数返回指定参数的正弦值，语法如下：
Sin(number)
参数number表示一个以弧度为单位的角。
Sin函数取一角度为参数值，并返回角的对边长度除以斜边长度的比值，将角度除以180后即能角度转换为弧度。
第7行代码设置图片的Left属性值，应用于Shape对象的Left属性设置图形从左边界至 A 列左边界（在工作表中）或图表区左边界（在图表工作表中）的距离。在循环的过程中使用Cos函数将Left属性值设置为一个圆形的弧度值。Cos函数返回指定一个角的余弦值，语法如下：
Cos(number)
参数number表示一个以弧度为单位的角。
Cos函数的number参数为一个角，并返回直角三角形两边的比值，该比值为角的邻边长度除以斜边长度之商，将角度除以180后即能角度转换为弧度。
第8行代码设置图片填充的前景色随着循环的过程不断的变化。使用Fill属性返回一个FillFormat对象，FillFormat对象代表图形的填充格式，其ForeColor 属性设置对象填充的前景色。
第9行到第11行代码在图形移动的过程中使用IncrementRotation方法设置图形绕 z 轴的转角，IncrementRotation方法以指定的度数为增量，更改指定的图形绕 z 轴的转角，语法如下：
expression.IncrementRotation(Increment)
参数expression是必需的，返回一个Shape对象。
参数Increment是必需的，以度为单位指定图形在水平方向的旋转量，正值使图形按顺时针方向旋转，负值使图形按逆时针方向旋转。
其中第11行是关键的代码，使用DoEvents函数转让控制权，否则达不到预计的视觉效果。
运行MoveShape过程，工作表的图形在自身进行逆时针方向旋转的同时沿着一个圆形的弧度进行移动，并不断改变其填充的颜色。</code></pre>
<h3 id="技巧58-工作表中自动插入图片"><a href="#技巧58-工作表中自动插入图片" class="headerlink" title="技巧58     工作表中自动插入图片"></a>技巧58     工作表中自动插入图片</h3><p>在日常工作中经常需要在工作表中插入大量图片，比如在如图 58 1所示的工作表中需要根据A列的名称在C列插入保存在同一目录中的相应的图片，如果使用手工插入不仅非常繁琐且极易出错，而使用VBA代码可以很好的完成操作。</p>
<p>图 58 1    需插入图片的工作表<br>示例代码如下：</p>
<pre><code class="vb">Sub insertPic()
    Dim i As Integer
    Dim FilPath As String
    Dim rng As Range
    Dim s As String
    With Sheet1
        For i = 3 To .Range(&quot;a65536&quot;).End(xlUp).Row
            FilPath = ThisWorkbook.Path &amp; &quot;\&quot; &amp; .Cells(i, 1).Text &amp; &quot;.jpg&quot;
            If Dir(FilPath) &lt;&gt; &quot;&quot; Then
                .Pictures.Insert(FilPath).Select
                Set rng = .Cells(i, 3)
                With Selection
                    .Top = rng.Top + 1
                    .Left = rng.Left + 1
                    .Width = rng.Width - 1
                    .Height = rng.Height - 1
                End With
            Else
                s = s &amp; Chr(10) &amp; .Cells(i, 1).Text
            End If
        Next
        .Cells(3, 1).Select
    End With
    If s &lt;&gt; &quot;&quot; Then
        MsgBox s &amp; Chr(10) &amp; &quot;没有照片!&quot;
    End If
End Sub
代码解析：
insertPic过程使用Insert方法在工作表中插入图片。
第7行代码开始For...Next循环，循环的终值由工作表中A列单元格的行数所决定。
第8行代码字符串变量FilPath保存A列名称单元格所对应的图片文件的路径和文件名，本例中图片文件的文件名应和A列中的名称一致。
第9行到第11行代码使用Dir函数在同一文件夹中查找与A列单元格中的名称相对应的图片文件，如果对应的图片文件存在则使用Insert方法将图片插入到工作表中，并将C列的单元格赋给变量rng。
Dir函数返回一个String，用以表示一个文件名、目录名或文件夹名称，它必须与指定的模式或文件属性、或磁盘卷标相匹配。如果已没有合乎条件的文件，则Dir函数会返回一个零长度字符串 (&quot;&quot;)。
第12行到第17行代码，当图片片插入到工作表时其实是插入到活动单元格的，此时需设置图片的Top属性和Left属性将图片移动到C列所对应的单元格中，并设置其Width属性和Height属性使其适应所在单元格的大小。
第18、19行代码如果在同一文件夹中没有与A列单元格对应的图片文件，则使用字符串变量s保存没有图片文件的名称。
第24行到第26行代码如果字符串变量s不等于空白说明文件夹中缺少图片文件，使用消息框提示。
运行insertPic过程工作表如图 58 2所示。

图 58 2    插入图片后的工作表
如果文件夹中缺少对应的图片文件，则会进行提示，如图 58 3所示。</code></pre>
<p>图 58 3    缺少图片文件提示</p>
<h3 id="技巧59-固定工作表中图形的位置"><a href="#技巧59-固定工作表中图形的位置" class="headerlink" title="技巧59     固定工作表中图形的位置"></a>技巧59     固定工作表中图形的位置</h3><p>工作表中插入的图片，一般都是固定的尺寸和固定的单元格区域中的，但在实际使用中可能因一些人为的因素导致图片位置偏移或尺寸变化，此时可以使用VBA代码进行调整，如下面的代码所示。</p>
<pre><code class="vb">Sub ShapeAddress()
    Dim rng As Range
    Set rng = Sheet1.Range(&quot;B4:E22&quot;)
    With Sheet1.Shapes(&quot;Picture 1&quot;)
        .Rotation = 0
        .Select
        With Selection
            .Top = rng(1).Top + 1
            .Left = rng(1).Left + 1
            .Width = rng.Width - 0.5
            .Height = rng.Height - 0.5
        End With
    End With
    Range(&quot;A1&quot;).Select
End Sub
代码解析：
ShapeAddress过程调整指定图形在工作表中的位置。
第3行代码变量rng保存工作表中插入图片的单元格区域。。
第5行代码设置图片的转角，应用于Shape对象Rotation属性以度为单位返回或设置图形的转角，设置为正值向右偏转，设置为负值向左偏转，设置为零图片则保持90度垂直。
第7行到第12行代码设置图片的Top属性和Left属性将图片移动到变量rng所保存的单元格区域中，并设置其Width属性和Height属性使其适应所在单元格区域的大小。
第14行代码选择A1单元格，不然图片会处于选中状态。
经过以上设置，工作表中的图片“Picture 1”不管处于什么状态都可以一键恢复其原来的大小、位置。</code></pre>
<h3 id="技巧60-使用VBA自动生成图表"><a href="#技巧60-使用VBA自动生成图表" class="headerlink" title="技巧60     使用VBA自动生成图表"></a>技巧60     使用VBA自动生成图表</h3><p>在实际工作中我们常用图表来表现数据间的某种相对关系，一般采用手工插入的方式，而使用VBA代码可以在工作表中自动生成图表，如下面的示例代码。</p>
<pre><code class="vb">Sub ChartAdd()
    Dim myRange As Range
    Dim myChart As ChartObject
    Dim R As Integer
    With Sheet1
        .ChartObjects.Delete
        R = .Range(&quot;A65536&quot;).End(xlUp).Row
        Set myRange = .Range(&quot;A&quot; &amp; 1 &amp; &quot;:B&quot; &amp; R)
        Set myChart = .ChartObjects.Add(120, 40, 400, 250)
        With myChart.Chart
            .ChartType = xlColumnClustered
            .SetSourceData Source:=myRange, PlotBy:=xlColumns
            .ApplyDataLabels ShowValue:=True
            .HasTitle = True
            .ChartTitle.Text = &quot;图表制作示例&quot;
            With .ChartTitle.Font
                .Size = 20
                .ColorIndex = 3
                .Name = &quot;华文新魏&quot;
            End With
            With .ChartArea.Interior
                .ColorIndex = 8
                .PatternColorIndex = 1
                .Pattern = xlSolid
            End With
            With .PlotArea.Interior
                .ColorIndex = 35
                .PatternColorIndex = 1
                .Pattern = xlSolid
            End With
            .SeriesCollection(1).DataLabels.Delete
            With .SeriesCollection(2).DataLabels.Font
                .Size = 10
                .ColorIndex = 5
            End With
        End With
    End With
    Set myRange = Nothing
    Set myChart = Nothing
End Sub
代码解析：
ChartAdd过程在工作表中自动生成图表，图表类型为簇状柱形图。
第6行代码使用Delete方法删除工作表中已经存在的图表，而ChartObjects方法返回代表工作表中单个嵌入图表（ChartObject对象）或所有嵌入图表的集合（ChartObjects对象）的对象，语法如下：
expression.ChartObjects(Index)
其中参数Index是可选的，指定图表的名称或号码。该参数可以是数组，用于指定多个图表，因为示例中只有一个图表，所以无需指定其Index参数。
第8行代码指定图表的数据源。
第9行代码使用Add方法创建一个新图表，应用于ChartObjects对象的Add方法创建新的嵌入图表，语法如下：
expression.Add(Left, Top, Width, Height)
参数Left、Top是必需的，以磅为单位给出新对象的初始坐标，该坐标是相对于工作表上单元格A1的左上角或图表的左上角的坐标。
参数Width、Height是必需，以磅为单位给出新对象的初始大小。
第10行代码使用Chart属性返回新创建的图表，应用于ChartObject对象的Chart属性返回一个Chart对象，该对象代表指定对象所包含的图表。
第11行代码指定新创建图表的图表类型，应用于Chart对象的ChartType属性返回或设置图表的类型，可以为XlChartType常量之一，具体请参阅VBA帮助。本例中设置为xlColumnClustered即图表类型为簇状柱形图。
第12行代码指定图表的数据源和绘图方式，应用于Chart对象的SetSourceData方法为指定图表设置源数据区域，语法如下：
expression.SetSourceData(Source, PlotBy)
参数expression是必需的，该表达式返回一个Chart对象。
参数Source是可选的，源数据的区域。
参数PlotBy是可选的，指定数据绘制方式，可为xlColumns（系列产生在列）或xlRows（系列产生在行）。
第13行代码使用ApplyDataLabels方法使图表显示数据标签和数据点的值，应用于Chart对象的ApplyDataLabels方法将数据标签应用于图表中的某一数据点、某一数据系列或所有数据系列，语法如下：
expression.ApplyDataLabels(Type, LegendKey, AutoText, HasLeaderLines, ShowSeriesName, ShowCategoryName, ShowValue, ShowPercentage, ShowBubbleSize, Separator)
参数expression是必需的，该表达式返回一个Chart对象。
参数Type是可选的，要应用的数据标签的类型，可为表格 60 1所列的XlDataLabelsType 常量之一。</code></pre>
<p>常量    值    描述<br>xlDataLabelsShowBubbleSizes    6    无<br>xlDataLabelsShowLabelAndPercent    5    占总数的百分比及数据点所属的分类。仅用于饼图或圆环图。<br>xlDataLabelsShowPercent    3    占总数的百分比。仅用于饼图或圆环图。<br>xlDataLabelsShowLabel    4    数据点所属的分类。<br>xlDataLabelsShowNone    -4142    无数据标签。<br>xlDataLabelsShowValue    2    数据点的值，若未指定本参数，默认使用此设置。<br>表格 60 1    XlDataLabelsType 常量<br>参数LegendKey是可选的，如果该值为True，则显示数据点旁的图例项标示。默认值为False。<br>参数AutoText是可选的，如果对象根据内容自动生成正确的文字，则该值为True。<br>参数HasLeaderLines是可选的，如果数据系列具有引导线，则该值为True。<br>参数ShowSeriesName是可选的，数据标签的系列名称。<br>参数ShowCategoryName是可选的，数据标签的分类名称。<br>参数ShowValue是可选的，数据标签的值。<br>参数ShowPercentage是可选的，数据标签的百分比。<br>参数ShowBubbleSize是可选的，数据标签的气泡尺寸。<br>参数Separator是可选的，数据标签的分隔符。<br>第14、15行代码设置新创建的图表有可见的标题并设置图表标题的文字。应用于Chart对象的HasTitle属性，如果坐标轴或图表有可见标题，则该值为True，而ChartTitle属性返回一个ChartTitle对象，代表指定图表的标题。<br>第16行到第20行代码设置图表标题文字的格式。<br>第21行到第25行代码设置图表区的颜色。<br>第26行到第30行代码设置绘图区的颜色。<br>第31行代码删除图表上第一个数据系列中的数据标签。SeriesCollection方法返回图表或图表组中单个数据系列（Series对象)或所有数据系列的集合（SeriesCollection集合)的对象，语法如下：<br>expression.SeriesCollection(Index)<br>可选的Index参数指定数据系列的名称或编号。<br>而DataLabels方法则返回代表数据系列中的单个数据标签（DataLabel对象）或所有数据标签的集合（DataLabels集合）的对象，语法如下：<br>expression.DataLabels(Index)<br>可选的Index参数指定数据系列中的数据标签的编号。<br>第32行到第36行代码设置图表上第二个数据系列中的数据标签的字体格式。<br>运行ChartAdd过程，在工作表中创建簇状柱形图，如图 60 1所示。</p>
<p>图 60 1    创建簇状柱形图</p>
<h3 id="技巧61-使用独立窗口显示图表"><a href="#技巧61-使用独立窗口显示图表" class="headerlink" title="技巧61     使用独立窗口显示图表"></a>技巧61     使用独立窗口显示图表</h3><p>如果需要将工作表中嵌入的图表显示在独立的窗口中，可以使用下面的代码。</p>
<pre><code class="vb">Sub ChartShow()
    With Sheet1.ChartObjects(1)
        .Activate
        .Chart.ShowWindow = True
    End With
    With ActiveWindow
        .Top = 50
        .Left = 50
        .Width = 400
        .Height = 280
        .Caption = ThisWorkbook.Name
    End With
End Sub
代码解析：
ChartShow过程，将工作表中嵌入的图表显示在独立的窗口中。
第2行到第5行代码将工作表中指定图表的ShowWindow属性设置为True，使用独立的窗口显示该图表。
第7、8行代码指定活动窗口显示的位置。
第9、10行代码调整活动窗口的大小使之适应图表的大小。
第11行代码指定活动窗口标题栏中显示的标题。
运行ChartShow过程结果如图 61 1所示。</code></pre>
<p>图 61 1    使用独立窗口显示图表</p>
<h3 id="技巧62-导出工作表中的图表"><a href="#技巧62-导出工作表中的图表" class="headerlink" title="技巧62     导出工作表中的图表"></a>技巧62     导出工作表中的图表</h3><p>如果需要将工作表中的图表保存为单独的图像文件，可以使用Export方法以图形文件格式导出图表，示例代码如下。</p>
<pre><code class="vb">Sub ExportChart()
    Dim myChart As Chart
    Dim myFileName As String
    Set myChart = Sheet1.ChartObjects(1).Chart
    myFileName = &quot;myChart.jpg&quot;
    On Error Resume Next
    Kill ThisWorkbook.Path &amp; &quot;\&quot; &amp; myFileName
    myChart.Export Filename:=ThisWorkbook.Path _
        &amp; &quot;\&quot; &amp; myFileName, Filtername:=&quot;JPG&quot;
    MsgBox &quot;图表已保存在[&quot; &amp; ThisWorkbook.Path &amp; &quot;]文件夹中!&quot;
    Set myChart = Nothing
End Sub
代码解析：
ExportChart过程使用Export方法将工作表中的图表以图形文件的形式导出。
第4行代码指定工作表中的图表对象。
第5行代码指定图形文件保存的文件名。
第6、7行代码使用Kill语句删除文件夹中原有的图形文件。当文件夹中指定删除的文件不存在时Kill语句会出错所以需要使用On Error语句忽略错误。
第8、9行代码使用Export方法将图表导出到同一目录中，应用于Chart对象的Export方法以图形文件格式导出图表，语法如下：
expression.Export(Filename, FilterName, Interactive)
其中参数Filename是必需的，被导出的文件的名称，示例中加上了文件保存的路径。
参数FilterName是可选的，被导出的文件的图形格式，示例中文件以JPG文件格式保存。
### 技巧63     多图表制作
如果需要，我们可以为工作表中的每一个数据区域创建一张图表，在如图 63 1所示的工作表区域中，需要为每一个员工的全年数据创建一张图表。</code></pre>
<p>图 63 1    数据区域<br>示例代码如下：</p>
<pre><code class="vb">Sub ChartsAdd()
    Dim myChart As ChartObject
    Dim i As Integer
    Dim R As Integer
    Dim m As Integer
    R = Sheet1.Range(&quot;A65536&quot;).End(xlUp).Row - 1
    m = Abs(Int(-(R / 4)))
    Sheet2.ChartObjects.Delete
    For i = 1 To R
        Set myChart = Sheet2.ChartObjects.Add _
            (Left:=(((i - 1) Mod m) + 1) * 350 - 320, _
            Top:=((i - 1) \ m + 1) * 220 - 210, _
            Width:=330, Height:=210)
        With myChart.Chart
            .ChartType = xlColumnClustered
            .SetSourceData Source:=Sheet1.Range(&quot;B2:M2&quot;).Offset(i - 1), _
            PlotBy:=xlRows
            With .SeriesCollection(1)
                .XValues = Sheet1.Range(&quot;B1:M1&quot;)
                .Name = Sheet1.Range(&quot;A2&quot;).Offset(i - 1)
                .ApplyDataLabels AutoText:=True, ShowValue:=True
                .DataLabels.Font.Size = 10
            End With
            .HasLegend = False
            With .ChartTitle
                .Left = 5
                .Top = 1
                .Font.Size = 14
                .Font.Name = &quot;华文行楷&quot;
            End With
            With .PlotArea.Interior
                .ColorIndex = 2
                .PatternColorIndex = 1
                .Pattern = xlSolid
            End With
            .Axes(xlCategory).TickLabels.Font.Size = 10
            .Axes(xlValue).TickLabels.Font.Size = 10
        End With
    Next
    Sheet2.Select
    Set myChart = Nothing
End Sub
代码解析：
ChartsAdd过程根据数据工作表A列的人数在图表工作表中创建图表并分4行排列整齐。
第6行代码取得数据工作表中需要创建图表的人数。
第7行代码计算图表工作表每行需要排列的图表数目，共分4行排列。使用Int函数返回图表数目除4行后的整数部分，使用负值是为了向上取整数，最后使用Abs函数返回绝对值，将负值转化为正值。
第8行代码使用Delete方法删除图表工作表中存在的所有图表。
第9行代码开始For...Next循环，循环的终值由需要创建的图表数目决定。
第10行到第13行代码使用Add方法在图表工作表中创建嵌入的图表，关于应用于ChartObjects对象的Add方法请参阅技巧60 。其中第11、12行代码根据循环计数器的数值设置新创建图表的Left和Top属性使之依次排列。第13行代码设置图表的大小。
第15行代码设置新创建图表的类型。
第16、17行代码根据循环计数器的数值分别设置新创建图表的数据源。
第18行到第23行代码设置图表第一个数据系列的名称、数据标签和字体格式。
第24行代码删除图表中的图例。
第25行到第30行代码设置图表的标题。
第31行到第35行代码设置图表的绘图区。
第36、37行代码设置图表坐标轴的字体大小。
关于图表的设置请参阅技巧60 。
运行ChartsAdd过程图表工作表中如所示。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/13/VBA常用技巧4--Shape（图形）、Chart（图表）对象/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-VBA常用技巧3--Wordbook(工作簿)对象" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/10/VBA常用技巧3--Wordbook(工作簿)对象/">VBA常用技巧3--Wordbook(工作簿)对象</a>
    </h1>
  

        
        <a href="/2018/05/10/VBA常用技巧3--Wordbook(工作簿)对象/" class="archive-article-date">
  	<time datetime="2018-05-09T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-10</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="第3章-Wordbook（工作簿）对象"><a href="#第3章-Wordbook（工作簿）对象" class="headerlink" title="第3章     Wordbook（工作簿）对象"></a>第3章     Wordbook（工作簿）对象</h2><h3 id="技巧40-工作簿的引用方法"><a href="#技巧40-工作簿的引用方法" class="headerlink" title="技巧40     工作簿的引用方法"></a>技巧40     工作簿的引用方法</h3><p>VBA中，在不同的工作簿之间转换需要指定引用的工作簿，通常有下面几种方法。</p>
<h4 id="40-1-使用工作簿的名称"><a href="#40-1-使用工作簿的名称" class="headerlink" title="40-1    使用工作簿的名称"></a>40-1    使用工作簿的名称</h4><p>工作簿名称是指Excel文件的文件名，可以使用Workbooks集合引用方式来引用工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub WbPath ()
    MsgBox &quot;名称为：&quot; &amp; Workbooks(&quot;工作簿的引用方法.xls&quot;).Path
End Sub
代码解析：
WbPath过程显示工作簿“工作簿的引用方法”的路径。应用于Workbook对象的Path属性将完整路径返回给应用程序，语法如下：
expression.Path
参数expression是必需的，一个有效的对象。</code></pre>
<h4 id="40-2-使用工作簿的索引号"><a href="#40-2-使用工作簿的索引号" class="headerlink" title="40-2    使用工作簿的索引号"></a>40-2    使用工作簿的索引号</h4><p>工作簿索引号是指工作簿打开的顺序，Excel根据工作簿打开的顺序以1开始进行编号。下面的代码显示应用程序打开的第一个工作簿的名称。</p>
<pre><code class="vb">Sub WbName()
    MsgBox &quot;第一个打开的工作簿名字为：&quot; &amp; Workbooks(1).Name
End Sub
代码解析：
WbName过程显示应用程序打开的第一个工作簿的名称。应用于Workbook对象的Name属性返回对象的名称，语法如下：
expression.Name
参数expression是必需的，一个有效的对象。
运行WbName过程结果如图 40 2所示。</code></pre>
<p>图 40 2    返回工作簿名称<br>如果需要返回包含完整路径的工作簿名称则使用Workbook对象的FullName属性，如下面的代码所示。</p>
<pre><code class="vb">Sub WbFullName()
    MsgBox &quot;包括完整路径的工作簿名称为：&quot; &amp; Workbooks(1).FullName
End Sub
WbFullName过程显示应用程序打开的第一个工作簿的完整路径和名称。FullName属性返回对象的名称，包括其磁盘路径的字符串，此属性等价于在Path属性后加上当前文件系统的分隔符，然后加上Name属性。
运行WbFullName过程结果如图 40 3所示。</code></pre>
<h4 id="40-3-使用ThisWorkbook"><a href="#40-3-使用ThisWorkbook" class="headerlink" title="40-3    使用ThisWorkbook"></a>40-3    使用ThisWorkbook</h4><p>使用ThisWorkbook代表当前宏代码运行的工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub WbClose()
    ThisWorkbook.Close SaveChanges:=False
End Sub
代码解析：
WbThis过程使用Close方法关闭当前宏代码运行的工作簿，不保存对工作簿的任何更改。关于应用于Workbook对象的Close方法请参阅技巧45-1。
注意 本属性仅可在 Microsoft Excel内使用。不能使用此属性访问任何其他应用程序的工作簿。</code></pre>
<h4 id="40-4-使用ActiveWorkbook"><a href="#40-4-使用ActiveWorkbook" class="headerlink" title="40-4    使用ActiveWorkbook"></a>40-4    使用ActiveWorkbook</h4><p>使用ActiveWorkbook代表活动窗口（最上面的窗口）的工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub WbActive()
    MsgBox &quot;当前活动工作簿名字为：&quot; &amp; ActiveWorkbook.Name
End Sub
代码解析：
WbActive过程显示活动工作簿的名称，ActiveWorkbook属性返回一个Workbook对象，该对象代表活动窗口（最上面的窗口）的工作簿。如果没有打开任何窗口或者活动窗口为信息窗口或剪贴板窗口，则返回 Nothing。
运行WbActive过程结果如图 40 4所示。</code></pre>
<h3 id="技巧41-新建工作簿文件"><a href="#技巧41-新建工作簿文件" class="headerlink" title="技巧41     新建工作簿文件"></a>技巧41     新建工作簿文件</h3><p>在VBA中使用Add方法新建工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub AddNowbook() &#39;AddNowbook过程使用Add方法建立新的工作簿并对新建工作簿进行操作
    Dim Nowbook As Workbook &#39;声明变量类型
    Dim ShName As Variant
    Dim Arr As Variant
    Dim i As Integer
    Dim myNewWorkbook As Integer
    myNewWorkbook = Application.SheetsInNewWorkbook &#39;保存Excel自动插入到新工作簿中的工作表数目
    ShName = Array(&quot;余额&quot;, &quot;单价&quot;, &quot;数量&quot;, &quot;金额&quot;) &#39;将数组元素赋值给变量
    Arr = Array(&quot;01月&quot;, &quot;02月&quot;, &quot;03月&quot;, &quot;04月&quot;, &quot;05月&quot;, &quot;06月&quot;, &quot;07月&quot;, &quot;08月&quot;, &quot;09月&quot;, &quot;10月&quot;, &quot;11月&quot;, &quot;12月&quot;)
    Application.SheetsInNewWorkbook = 4 &#39;将Application对象的SheetsInNewWorkbook属性设置为4，在新建工作簿时插入4张工作表
    Set Nowbook = Workbooks.Add &#39;使用Add方法建立新的工作簿，应用于Workbooks对象的Add方法新建工作簿，新建的工作簿将成为活动工作簿
    With Nowbook
        For i = 1 To 4
            With .Sheets(i)
            &#39;将新建工作簿的工作表进行重命名并给单元格赋值
                .Name = ShName(i - 1)
                .Range(&quot;B1&quot;).Resize(1, UBound(Arr) + 1) = Arr
                .Range(&quot;A2&quot;) = &quot;品名&quot;
            End With
        Next
        .SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\&quot; &amp; &quot;存货明细.xls&quot; &#39;使用SaveAs方法将新建工作簿重命名为“存货明细.xls”保存在同一目录中
        .Close Savechanges:=True &#39;使用Close方法关闭工作簿
    End With
    Set Nowbook = Nothing
    Application.SheetsInNewWorkbook = myNewWorkbook &#39;恢复工作簿的默认设置
End Sub

关于SaveAs方法请参阅技巧47-2。
关于Close方法请参阅技巧45-1。
运行AddNowbook过程将在工作簿同一目录中新建“存货明细.xls”工作簿。

注意 本例中没有考虑工作簿同名因素，如果目录中已有“存货明细.xls”工作簿</code></pre>
<p>图 41 2    同名提示</p>
<h3 id="技巧42-打开指定的工作簿"><a href="#技巧42-打开指定的工作簿" class="headerlink" title="技巧42     打开指定的工作簿"></a>技巧42     打开指定的工作簿</h3><p>VBA中使用Open方法打开一个工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub Openfile()
    Dim x As Integer
    For x = 1 To Workbooks.Count
        If Workbooks(x).Name = &quot;123.xls&quot; Then
            MsgBox &quot;&quot;&quot;123&quot;&quot;工作簿已经打开!&quot;
            Exit Sub
        End If
    Next
    Workbooks.Open ThisWorkbook.Path &amp; &quot;\123.xls&quot;
End Sub
代码解析：
Openfile过程打开同一目录中的“123”工作簿。
第3行代码利用Workbook对象的Count属性取得打开工作簿的数目，使用For...Next 语句遍历所有打开的工作簿。遍历工作簿除了使用For...Next 语句外还可以使用For...Each...Next语句来遍历Workbook对象集合中的所有元素。
第4行到第8行代码遍历所有打开的工作簿，如果Workbook对象集合中存在“123”工作簿，说明“123”工作簿已打开，则显示一条如图 42 1所示的提示信息。
第9行代码如果“123”工作簿没有被打开则使用Open方法打开“123”工作簿。
Open方法应用于Workbooks 对象时打开一个工作簿，语法如下：
expression.Open(FileName, UpdateLinks, ReadOnly, Format, Password, WriteResPassword, IgnoreReadOnlyRecommended, Origin, Delimiter, Editable, Notify, Converter, AddToMru, Local, CorruptLoad)
参数expression是必需的，返回一个Workbooks对象
参数FileName是必需的，要打开的工作簿的文件名。</code></pre>
<p>参数UpdateLinks是可选的，指定文件中链接的更新方式。如果省略本参数，则提示用户选择链接的更新方式。否则，该参数的取值应为表格 42 1中的某个值。<br>值    描述<br>0    不更新任何引用<br>1    更新外部引用，但不更新远程引用<br>2    更新远程引用，但不更新外部引用<br>3    同时更新远程引用和外部引用<br>表格 42 1    UpdateLinks参数值<br>参数ReadOnly是可选的，如果该值为True，则以只读模式打开工作簿。<br>参数Format是可选的，如果Microsoft Excel正在打开一个文本文件，则该参数用于指定分隔字符，如表格 42 2所示。如果省略本参数，则使用当前的分隔符。<br>值    分隔符<br>1    制表符<br>2    逗号<br>3    空格<br>4    分号<br>5    没有分隔符<br>6    自定义字符(请参阅 Delimiter 参数)<br>表格 42 2    Format参数值<br>参数Password是可选的，该字符串指定打开一个受保护工作簿的密码。如果省略该参数并且指定工作簿已设置密码，则提示用户输入密码。<br>参数WriteResPassword是可选的，该字符串为一个写保护工作簿的写入权密码。如果省略该参数并且指定工作簿已设置密码，则提示用户输入密码。<br>参数IgnoreReadOnlyRecommended是可选的，如果该值为True，则设置Microsoft Excel不显示建议只读消息（如果该工作簿以“建议只读”选项保存）。<br>参数Origin是可选的，如果文件为文本文件，则该参数用于指示该文件来源于何种操作系统。<br>参数Delimiter是可选的，如果该文件为文本文件并且Format参数为 6，则此参数用于指定用作分隔符的字符。<br>参数Editable是可选的，如果该文件为Microsoft Excel 4.0加载宏，则该参数的值为True时可打开该加载宏以便在窗口中看到。如果该参数的值为False或者省略该参数，则该加载宏以隐藏方式打开，并且无法设为可见。<br>参数Notify是可选的，当该文件不能以可读写模式打开时，如果该参数的值为True，则可将该文件添加到文件通知列表。<br>参数Converter是可选的，打开文件时试用的第一个文件转换器的索引号。<br>参数AddToMru是可选的，如果该值为True，则将该工作簿添加到最近使用的文件列表中。默认值为False。<br>参数Local是可选的，如果该值为True，则以Microsoft Excel（包括控制面版设置）的语言保存文件。如果该值为False（默认值），则以 Visual Basic for Applications (VBA)的语言保存文件，其中Visual Basic for Applications (VBA)为典型安装的美国英语版本，除非VBA项目的Workbooks.Open来自旧的国际化的XL5/95 VBA项目。<br>参数CorruptLoad是可选的，可为以下常量之一：xlNormalLoad、xlRepairFile 和 xlExtractData。如果未指定任何值，则默认值通常为普通状态。</p>
<h3 id="技巧43-判断指定工作簿是否打开"><a href="#技巧43-判断指定工作簿是否打开" class="headerlink" title="技巧43     判断指定工作簿是否打开"></a>技巧43     判断指定工作簿是否打开</h3><h4 id="43-1-遍历Workbooks集合方法"><a href="#43-1-遍历Workbooks集合方法" class="headerlink" title="43-1    遍历Workbooks集合方法"></a>43-1    遍历Workbooks集合方法</h4><p>通过遍历当前应用程序所有已打开的工作簿文件(Workbooks集合)，判断指定名称的工作簿是否打开，如下面的代码所示。</p>
<pre><code class="vb">Sub WorkbookIsOpen_1()
    Dim Wb As Workbook
    Dim myWb As String
    myWb = &quot;Excel Home.xls&quot;
    For Each Wb In Workbooks
        If Wb.Name = myWb Then
            MsgBox &quot;工作簿&quot; &amp; myWb &amp; &quot;已经被打开!&quot;
            Exit Sub
        End If
    Next
    MsgBox &quot;工作簿&quot; &amp; myWb &amp; &quot;没有被打开!&quot;
End Sub
代码解析：
WorkbookIsOpen_1过程通过遍历当前应用程序中所有已打开的工作簿文件(Workbooks集合)，判断“Excel Home”工作簿是否打开。
第5行代码使用For...Each...Next语句来遍历Workbook对象集合中的所有元素。
第6行到第8行代码如果Workbook对象集合包含“Excel Home.xls”工作簿名称，说明文件已打开，使用Exit Sub语句结束代码的运行。
第11行代码如果运行到此行代码说明“Excel Home.xls”工作簿没有被打开。</code></pre>
<h4 id="43-2-错误处理方法"><a href="#43-2-错误处理方法" class="headerlink" title="43-2    错误处理方法"></a>43-2    错误处理方法</h4><p>使用错误处理程序判断指定名称的工作簿是否打开，如下面的代码所示。</p>
<pre><code class="vb">Sub WorkbookIsOpen_2() &#39;使用错误处理程序判断“Excel Home”工作簿是否打开
    Dim Wb As Workbook
    Dim myWb As String
    myWb = &quot;Excel Home.xls&quot;
    Err.Clear &#39;使用Clear方法清除Err对象的所有属性设置
    On Error GoTo line &#39;启动错误处理程序,代码发生错误则执行line行后面的代码
    Set Wb = Application.Workbooks(myWb)
    MsgBox &quot;工作簿&quot; &amp; myWb &amp; &quot;已经被打开!&quot;
    Set Wb = Nothing
    Exit Sub
line:
    MsgBox &quot;工作簿&quot; &amp; myWb &amp; &quot;没有被打开!&quot;
    Set Wb = Nothing
End Sub
第7行代码使用Set语句将Workbook对象引用赋给变量Wb，如果 “Excel Home.xls”工作簿没有被打开将发生下标越界错误，此时执行第12、13行代码，否则执行第8、9行代码。</code></pre>
<h3 id="技巧44-禁用宏则关闭工作簿"><a href="#技巧44-禁用宏则关闭工作簿" class="headerlink" title="技巧44     禁用宏则关闭工作簿"></a>技巧44     禁用宏则关闭工作簿</h3><p>通常情况下，当应用程序的宏安全性的安全级别设置为“中”时，打开包含Microsoft Excel 4.0版的宏的工作簿，将显示如图 44 1所示的“安全警告”对话框。</p>
<p>图 44 1    安全警告对话框<br>如果用户选择“禁用宏”按钮，则会显示如图 44 2所示的警告消息框，当用户选择“否”时，不能打开该工作簿；用户选择“是”时，打开该工作簿，但VBA宏被禁止，而Microsoft Excel 4.0版的宏未被禁止。</p>
<p>图 44 2    Microsoft Excel 4.0宏警告对话框<br>我们可以利用禁用VBA宏不能禁止Microsoft Excel 4.0版的宏这个特点，使用Microsoft Excel 4.0版的宏来实现禁用宏则关闭工作簿的功能。<br>步骤1    新建或打开需要添加此项功能的工作簿文件。<br>步骤2    按&lt;Ctrl+F11&gt;组合键为工作簿添加一个宏表，添加的宏表名称默认为“Macro1”。<br>步骤3    在宏表“Macro1”的A1至A7单元格中输入下面的内容。<br>禁用宏则关闭工作簿<br>=ERROR(FALSE)<br>=IF(ERROR.TYPE(RUN(“TestMacro”))=4)<br>=  ALERT(“因禁用了宏功能,文件将被关闭!”,3)<br>=  FILE.CLOSE(FALSE)<br>=END.IF()<br>=RETURN()<br>完成后的宏表如图 44 3所示。</p>
<p>图 44 3    完成输入后的宏表<br>代码解析：<br>Microsoft Excel 4.0宏函数以等号（=）开始，其他不是由等号开始的内容将被视作注释。通常用作定义的宏名称或者作为宏函数实现功能的注释内容设置为斜体字样以示区别，如图 44 3中单元格A1所示。<br>第2行代码关闭错误检查功能。如果关闭错误检查，那么当宏执行遇到错误时，Microsoft Excel 将不予理会而继续执行。<br>第3行到第6行代码使用If函数与End.If函数构成条件判断语句。其中，第3行中的语句通过检查宏函数RUN(“TestMacro”)的返回错误类型是否为4（禁用宏时的返回结果），判断工作簿是否禁用了宏功能。如果第3行的结果为True，则执行下面的语句。<br>在第4、5行代码，插入几个空格来表示相关代码之间的层次结构。第4行中的代码显示一个消息框。第5行中的代码关闭当前活动工作簿，设置参数值为Fasle表示关闭时工作簿时不保存对其所作的更改。<br>第7行代码终止当前代码的执行。Microsoft Excel 4.0宏要求每个宏必须使用RETURN或HALT函数结束。<br>步骤4    为每个表添加工作表级别的名称“Auto_Activate”，并将引用都指向宏表“Macro1”的A2单元格。“Auto_Activate”是一个自动宏，表被激活时自动执行。<br>添加工作表级别的名称的方法如下：选择一张工作表，假设为表“Sheet1”，单击菜单“插入”→“名称”→“定义名称”。在“定义名称”对话框中添加名称，如图 44 4所示。</p>
<p>图 44 4    定义工作表级别的名称<br>输入完成后单击“确定”按钮，完成一张工作表的“Auto_Activate”的定义。完成定义后的名称将在“定义名称”对话框中显示，如图 44 5所示。依次为每个表添加“Auto_Activate”名称。</p>
<p>图 44 5    名称对话框中的工作表级名称<br>此外，使用VBA也可以实现同样的操作，并且使用VBA的好处是能够隐藏名称，以避免名称被删除或修改。代码如下：\</p>
<pre><code class="vb">Sub AddPrivateNames()
    Dim sht As Object
    For Each sht In Sheets
        ThisWorkbook.Names.Add sht.Name &amp; &quot;!Auto_Activate&quot;, _
&quot;=Macro1!$A$2&quot;, False
    Next
End Sub
步骤5    运行下面的代码，隐藏宏表工作表：
Sub HideMacroSheet()
    ThisWorkbook.Excel4MacroSheets(1).Visible = xlSheetHidden
End Sub
步骤6    保存工作簿。
当应用程序的宏安全性的安全级设置为“中”时，如果用户打开该工作簿文件并选择“禁用宏”，将显示如图 44 2所示的警告消息框。当用户选择“是”时，活动工作表上的自动宏“Auto_Activate”将被执行，执行结果显示如图 44 6所示的消息框，当用户选择“确定”按钮后，将强制关闭该工作簿文件。</code></pre>
<p>图 44 6    警告消息框</p>
<h3 id="技巧45-关闭工作簿不显示保存对话框"><a href="#技巧45-关闭工作簿不显示保存对话框" class="headerlink" title="技巧45     关闭工作簿不显示保存对话框"></a>技巧45     关闭工作簿不显示保存对话框</h3><p>当用户更改工作簿后，没有进行保存操作而直接关闭工作簿时，将显示如图 45 1所示的消息框，提示用户是否保存对工作簿的更改，如果希望不显示该消息框而直接关闭关闭工作簿，可以在关闭时进行相应的设置。</p>
<p>图 45 1    提示保存对话框</p>
<h4 id="45-1-使用Close方法关闭工作簿"><a href="#45-1-使用Close方法关闭工作簿" class="headerlink" title="45-1    使用Close方法关闭工作簿"></a>45-1    使用Close方法关闭工作簿</h4><p>使用Close方法关闭工作簿的，可以在Close方法中指定相应的参数，如下面的代码所示。</p>
<pre><code class="vb">Sub wbClose_1()
    ThisWorkbook.Close SaveChanges:=False
End Sub
代码解析：
wbClose_1过程使用Close方法关闭工作簿，并放弃所有对工作簿的更改。
应用于Workbook对象的Close方法关闭对象，语法如下：
expression.Close(SaveChanges, Filename, RouteWorkbook)
其中SaveChanges参数是可选的，如果工作簿没有改变则忽略此参数；如果工作簿发生了改变并且在另外的窗口中也打开了该工作簿，则仍然忽略此参数；如果工作簿发生了改变并且没有在另外的窗口中打开，则此参数将指定是否在工作簿中保存所发生的更改。取值与操作如表格 45 1所示：
值    作用
True    将改变保存到工作簿。如果该工作簿尚未命名，则使用 FileName 指定的名称。如果省略 FileName 参数，则要求用户输入文件名。
False    不将改变保存到此文件。
省略    显示一个对话框，要求用户决定是否保存所做的更改。
表格 45 1    SaveChanges参数值的作用
如果希望在关闭工作簿时自动保存更改，将SaveChanges参数值设置为True即可。</code></pre>
<p>还可以在使用Close方法关闭工作簿时设置Workbook对象的Saved属性，如下面的代码所示。</p>
<pre><code class="vb">Sub wbClose_2()
    ThisWorkbook.Saved = True
    ThisWorkbook.Close 
End Sub
代码解析：
wbClose_2过程使用Close方法关闭工作簿，并放弃所有对工作簿的更改。
Workbook对象的Saved属性指示工作簿从上次保存至今是否发生过更改，如果工作簿进行了更改，则该属性值为False，否则为True。应用程序在关闭工作簿之前判断该属性的值，如果其值为False，则显示提示是否保存的消息框，询问用户是否保存对工作簿所做的更改。
第2行代码将该属性的值设置为True，使Excel认为已经保存了对工作簿所作的更改（实际上没有保存更改），从而不再显示提示是否保存的消息框。</code></pre>
<p>如果需要保存对工作簿所作的更改，那么应该在Close方法之前使用Save方法保存工作簿，代码如下：</p>
<pre><code class="vb">Sub wbClose_3()
    ThisWorkbook.Save
    ThisWorkbook.Close 
End Sub
代码解析：
wbClose_3过程使用Save方法保存工作簿所做的更改，然后使用Close方法关闭工作簿。</code></pre>
<h4 id="45-2-单击工作簿关闭按钮关闭工作簿"><a href="#45-2-单击工作簿关闭按钮关闭工作簿" class="headerlink" title="45-2    单击工作簿关闭按钮关闭工作簿"></a>45-2    单击工作簿关闭按钮关闭工作簿</h4><p>如果是通过单击工作簿的关闭按钮等操作关闭工作簿的，则使用BeforeClose事件过程来控制，如下面的代码所示。</p>
<pre><code class="vb">Private Sub Workbook_BeforeClose(Cancel As Boolean)
     Me.Saved = True
End Sub
代码解析：
工作簿的Workbook_BeforeClose事件，将工作簿的Saved属性设置为True，不保存更改而直接关闭工作簿，且不显示提示保存的消息框。
如果希望保存对工作簿的更改，则在Workbook_BeforeClose事件中使用Save方法保存工作簿，如下面的代码所示。
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Me.Save
End Sub</code></pre>
<h3 id="技巧46-禁用工作簿的关闭按钮"><a href="#技巧46-禁用工作簿的关闭按钮" class="headerlink" title="技巧46     禁用工作簿的关闭按钮"></a>技巧46     禁用工作簿的关闭按钮</h3><p>一般情况下，用户可以通过菜单“文件”→“关闭”、工作簿窗口右上角的“关闭窗口”按钮或者任务栏中图标右键菜单中的“关闭”菜单项关闭工作簿。如果希望禁用上述关闭工作簿的功能，而只能通过代码关闭工作簿，则可以在相应的工作簿事件中实现，如下面的代码所示。</p>
<pre><code class="vb">Dim BClose As Boolean
Private Sub Workbook_BeforeClose(Cancel As Boolean)
    If BClose = False Then
        Cancel = True
        MsgBox &quot;此功能已经被禁止，请使用&quot;&quot;关闭&quot;&quot;按钮关闭工作簿!&quot;, vbExclamation, &quot;提示&quot;
    End If
End Sub
Public Sub CloseWorkbook()
    BClose = True
    Me.Close
End Sub
代码解析：
第1行代码在模块顶部声明变量BClose为Boolean类型，默认初始值为False。
第2行到第7行代码工作簿的BeforeClose事件过程，通过变量BClose的当前值决定是否能够关闭工作簿，只有当BClose的值为True时，才允许关闭工作簿。如果变量BClose的值为False时将参数Cancel的值设置为True，以禁止关闭操作。
第8行到第11行代码CloseWorkbook过程，将变量BClose的当前值设置为True后使用Close方法关闭工作簿。关于Close方法请参阅技巧45-1。
在添加以上代码后，用户只能通过调用CloseWorkbook过程关闭工作簿。如果通过菜单“文件”→“关闭”或者单击工作簿窗口右上角的“关闭窗口”按钮关闭工作簿，将显示如图 46 1所示的消息框。</code></pre>
<p>图 46 1    禁用关闭按钮</p>
<h3 id="技巧47-保存工作簿的方法"><a href="#技巧47-保存工作簿的方法" class="headerlink" title="技巧47     保存工作簿的方法"></a>技巧47     保存工作簿的方法</h3><h4 id="47-1-使用Save方法"><a href="#47-1-使用Save方法" class="headerlink" title="47-1    使用Save方法"></a>47-1    使用Save方法</h4><p>使用Workbook对象的Save方法保存工作簿的更改，如下面的代码所示。</p>
<pre><code class="vb">Sub SaveWork()
    ThisWorkbook.Save
End Sub
代码解析：
SaveWork过程保存代码所在的工作簿的修改。
Save方法保存指定工作簿所做的更改，语法如下：
expression.Save
参数expression是必需的，该表达式返回一个Workbook对象。
如果是第一次保存工作簿，请使用SaveAs方法为该文件指定文件名，请参阅技巧47-2。</code></pre>
<h4 id="47-2-直接保存为另一文件名"><a href="#47-2-直接保存为另一文件名" class="headerlink" title="47-2    直接保存为另一文件名"></a>47-2    直接保存为另一文件名</h4><p>如果需要将工作簿另存为另一个文件名，可以使用Workbook对象的SaveAs方法，如下面的代码所示。</p>
<pre><code class="vb">Sub SaveAsWork()
    ThisWorkbook.SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\123.xls&quot;
End Sub
代码解析：
SaveAsWork过程将代码所在的工作簿保存为“123”工作簿文件。
Workbook对象的SaveAs方法使用另外一个不同的文件名保存对工作簿所做的更改，语法如下：
SaveAs(FileName,FileFormat,Password,WriteResPassword,ReadOnlyRecommended,CreateBackup,AccessMode,ConflictResolution,AddToMru,TextCodepage,TextVisualLayout,Local)
其中，参数Filename可选，表示要保存文件的文件名的字符串。可包含完整路径，如果不指定路径，将文件保存到当前文件夹中。
使用SaveAs方法将工作簿另存为新文件后，将关闭原工作簿文件。</code></pre>
<h4 id="47-3-保存工作簿副本"><a href="#47-3-保存工作簿副本" class="headerlink" title="47-3    保存工作簿副本"></a>47-3    保存工作簿副本</h4><p>如果用户希望工作簿在保存为另一文件名后，能继续编辑原工作簿，那么可以使用SaveCopyAs方法，如下面的代码所示。</p>
<pre><code class="vb">Sub SaveCopyWork()
    ThisWorkbook.SaveCopyAs ThisWorkbook.Path &amp; &quot;\123.xls&quot;
End Sub
代码解析：
SaveCopyWork过程使用SaveCopyAs方法保存代码所在的工作簿副本，并指定其名称。
SaveCopyAs方法将指定工作簿的副本保存到文件，但不修改内存中的打开工作簿，语法如下：
SaveCopyAs(Filename)
参数Filename是必需的，用于指定工作簿副本的文件名。</code></pre>
<h3 id="技巧48-保存指定工作表为工作簿文件"><a href="#技巧48-保存指定工作表为工作簿文件" class="headerlink" title="技巧48     保存指定工作表为工作簿文件"></a>技巧48     保存指定工作表为工作簿文件</h3><p>如果需要将工作簿中的工作表单独保存为一个工作簿文件，可以使用Worksheet对象的Copy方法，将指定的工作表复制到一个新建的工作簿，如下面的代码所示。</p>
<pre><code class="vb">Sub SheetCopy()
    On Error GoTo line
    ActiveSheet.Copy
    ActiveWorkbook.Close SaveChanges:=True, Filename:=ThisWorkbook.Path &amp; &quot;\SheetCopy.xls&quot;
    Exit Sub
line:
    ActiveWorkbook.Close False
End Sub
代码解析：
SheetCopy过程将活动工作表单独保存为一个工作簿文件。
第2行代码错误处理语句。备份过程中，如果已存在同名工作簿，会出现如所示的提示，如果选择了“否”或“取消”，此时新工作簿已经建立，在执行4行代码时发生错误，使程序中断，所以使用GoTo语句执行第7行代码，关闭新建立的工作簿并且不保存。
第3行代码使用Copy方法新建一个工作簿，新工作簿中包含复制的工作表。应用于Worksheet对象的Copy方法将指定工作表复制到工作簿的另一位置，语法如下：
Copy (Before, After)
其中，参数Before是可选的，用来指定工作表，复制的工作表将置于此工作表之前。参数After是可选的，用来指定工作表，复制的工作表将置于此工作表之后。
不能同时指定Before参数和After参数。当Copy方法省略参数时，应用程序将新建一个空工作簿（新建工作簿将成为活动窗口），并将Copy方法引用的工作表复制到该空工作簿中。
第4行代码使用Workbook对象的Close方法关闭新建的工作簿。应用于Workbooks集合和Workbook对象的Close方法请参阅技巧45-1。</code></pre>
<p>如果需要将工作簿中的几个工作表单独保存为一个工作簿文件时，可以以数组的形式指定要复制的工作表，如下面的代码所示。</p>
<pre><code class="vb">Sub ArrSheetCopy()
    On Error GoTo line
    Worksheets(Array(&quot;Sheet1&quot;, &quot;Sheet2&quot;)).Copy
    ActiveWorkbook.SaveAs Filename:=ThisWorkbook.Path &amp; &quot;\ArrSheetCopy.xls&quot;
    ActiveWorkbook.Close SaveChanges:=True
    Exit Sub
line:
    ActiveWorkbook.Close False
End Sub
代码解析：
ArrSheetCopy过程将“Sheet1”和“Sheet2”工作表单独保存为一个工作簿文件。
第4行代码使用SaveAs方法保存活动工作簿，关于SaveAs方法请参阅技巧47-2。</code></pre>
<h3 id="技巧49-打印预览时不触发事件"><a href="#技巧49-打印预览时不触发事件" class="headerlink" title="技巧49     打印预览时不触发事件"></a>技巧49     打印预览时不触发事件</h3><p>在工作表打印之前或进行打印预览时，会触发工作簿的BeforePrint事件。在某些情况下希望在打印预览时能禁止触发该事件，例如如图 49 1所示的工作表中用户在打印时使用下面的代码将流水号的数值自动加1。<br>Private Sub Workbook_BeforePrint(Cancel As Boolean)<br>    Sheet1.Range(“J1”) = Sheet1.Range(“J1”) + 1<br>End Sub</p>
<pre><code>
图 49 1    自动增加流水号
但是在打印预览时并不希望流水号的数值自动加1，此时，需要修改系统的打印预览功能，如下面的代码所示。

​```vb
Private Sub Workbook_Open()
    Dim CmdCtrls As CommandBarControls
    Dim Cmd As CommandBarControl
    Set CmdCtrls = Application.CommandBars.FindControls(ID:=109)
    For Each Cmd In CmdCtrls
        Cmd.OnAction = &quot;ThisWorkbook.MyPrint&quot;
    Next
End Sub
代码解析：
工作簿的Open事件过程，在打开工作簿时，修改系统中所有打印预览命令按钮和菜单项的动作，指定其OnAction属性为ThisWorkbook代码窗口中的公用过程MyPrint。
第4行代码使用FindControls方法将所有打印预览命令按钮和菜单项赋给变量CmdCtrls，FindControls方法返回符合指定条件的CommandBarControls集合，语法如下：
expression.FindControls(Type, Id, Tag, Visible)
其中参数expression是必需的，该表达式返回一个CommandBars集合。
参数Id是可选的，要查找控件的标识符。打印预览命令控件的标识符为109。
第5行到第7行代码遍历所有打印预览命令控件，指定其OnAction属性为ThisWorkbook代码窗口中的公用过程MyPrint。OnAction属性返回或设置一个Visual Basic 的过程名，该过程在用户单击或更改某命令栏控件的值时运行。</code></pre><p>MyPrint过程代码如下：</p>
<pre><code class="vb">Public Sub MyPrint()
    With Application
        .EnableEvents = False
        .ActiveSheet.PrintPreview EnableChanges:=False
        .EnableEvents = True
    End With
End Sub
代码解析：
MyPrint过程通过禁止对象事件，使工作表打印预览时不触发工作簿的BeforePrint事件。
第3行代码将Application对象的EnableEvents属性设置为False，禁用事件，使事件不能触发。
第4行代码使用PrintPreview方法对工作表执行打印预览。PrintPreview方法以打印效果显示指定的对象，该方法只有一个参数EnableChanges，用来指定是否可以修改页面设置，当其值为False时，禁止在打印预览时修改页面设置，默认值为True。
第5行代码将Application对象的EnableEvents属性设置为True，启用事件。</code></pre>
<p>为了在工作簿时恢复默认的打印预览设置，在ThisWorkbook代码窗口写入以下代码：</p>
<pre><code class="vb">Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim CmdCtrls As CommandBarControls
    Dim Cmd As CommandBarControl
    Set CmdCtrls = Application.CommandBars.FindControls(ID:=109)
    For Each Cmd In CmdCtrls
        Cmd.OnAction = &quot;&quot;
    Next
End Sub
代码解析：
工作簿的BeforeClose事件过程，关闭工作簿时将所有打印预览命令按钮和菜单项的OnAction属性恢复为默认的动作。
经过以上设置，工作表只有在进行打印时“流水号”数值才自动加1。</code></pre>
<h3 id="技巧50-设置工作簿文档属性信息"><a href="#技巧50-设置工作簿文档属性信息" class="headerlink" title="技巧50     设置工作簿文档属性信息"></a>技巧50     设置工作簿文档属性信息</h3><p>使用DocumentProperties集合对象的BuiltinDocumentProperties属性可以设置文档的属性信息，如下面的代码所示。</p>
<pre><code class="vb">Sub WbBuiltin()
    With ThisWorkbook
        .BuiltinDocumentProperties(&quot;Title&quot;) = &quot;Wordbook（工作簿）对象&quot;
        .BuiltinDocumentProperties(&quot;Subject&quot;) = &quot;设置工作簿的文档属性信息&quot;
        .BuiltinDocumentProperties(&quot;Author&quot;) = &quot;yuanzhuping&quot;
        .BuiltinDocumentProperties(&quot;Company&quot;) = &quot;tzzls&quot;
        .BuiltinDocumentProperties(&quot;Comments&quot;) = &quot;工作簿文档属性信息&quot;
        .BuiltinDocumentProperties(&quot;Keywords&quot;) = &quot;Excel VBA&quot;
    End With
    MsgBox &quot;工作簿文档属性信息设置完毕！&quot;
End Sub
代码解析：
WbBuiltin过程设置代码所在工作簿的属性信息，应用于Workbook对象的BuiltinDocumentProperties属性返回一个DocumentProperties集合，该集合代表指定工作簿的所有内置文档属性，本属性返回的是内置文档属性的整个集合。通过指定属性的名称或集合中的索引号返回集合中的单个成员（一个DocumentProperty对象）。
第3行代码设置标题，第4行代码设置主题，第5行代码设置作者，第6行代码设置公司，第7行代码设置备注，第8行代码设置关键字。
工作簿文档属性信息设置如图 50 1所示。</code></pre>
<p>图 50 1    工作簿文档属性信息</p>
<h3 id="技巧51-不打开工作簿取得其他工作簿数据"><a href="#技巧51-不打开工作簿取得其他工作簿数据" class="headerlink" title="技巧51     不打开工作簿取得其他工作簿数据"></a>技巧51     不打开工作簿取得其他工作簿数据</h3><p>在Excel的使用过程中，经常需要引用其他工作簿的数据，而用户往往希望能在不打开工作簿或看似不打开工作簿的情况下取得其他工作簿中的数据，有以下几种方法可以实现。</p>
<h4 id="51-1-使用公式"><a href="#51-1-使用公式" class="headerlink" title="51-1    使用公式"></a>51-1    使用公式</h4><p>如果需要引用的数据不是太多，可以使用公式取得引用工作簿中的工作表数据，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyData_1()
    Dim Temp As String
    Temp = &quot;&#39;&quot; &amp; ThisWorkbook.Path &amp; &quot;\[数据表.xls]Sheet1&#39;!&quot;
    With Sheet1.Range(&quot;A1:F22&quot;)
        .FormulaR1C1 = &quot;=&quot; &amp; Temp &amp; &quot;RC&quot;
        .Value = .Value
    End With
End Sub
代码解析：
CopyData_1过程在工作表中写入公式引用“数据表”中同一位置单元格中的数据。
第3行代码将引用工作簿的路径赋给变量Temp。
第5行代码在作表中写入公式引用数据。
第6行代码将公式转换为数值。</code></pre>
<h4 id="51-2-使用GetObject函数"><a href="#51-2-使用GetObject函数" class="headerlink" title="51-2    使用GetObject函数"></a>51-2    使用GetObject函数</h4><p>使用GetObject函数来获取对指定的Excel工作表的引用，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyData_2() &#39;CopyData_2过程使用GetObject函数来获取“数据表”工作簿中的数据
    Dim Wb As Workbook
    Dim Temp As String
    Application.ScreenUpdating = False &#39;关闭屏幕更新加快运行速度
    Temp = ThisWorkbook.Path &amp; &quot;\数据表.xls&quot; &#39;将引用工作簿的路径赋给变量Temp
    Set Wb = GetObject(Temp) &#39;使用Set语句将GetObject函数返回的对象赋给对象变量Wb
        With Wb.Sheets(1).Range(&quot;A1&quot;).CurrentRegion
            Range(&quot;A1&quot;).Resize(.Rows.Count, .Columns.Count) = .Value &#39;将“数据表”工作簿中的第1张工作表已使用区域的数据赋给本工作表的单元格
            Wb.Close False
        End With
    Set Wb = Nothing
    Application.ScreenUpdating = True
End Sub
GetObject函数返回文件中的ActiveX对象的引用，语法如下：
GetObject([pathname] [, class])
参数pathname是可选的，包含待检索对象的文件的全路径和名称。如果省略，则class参数是必需的。
参数class是可选的，代表该对象的类的字符串。
Class参数的格式为appname.objecttype，语法的各个部分如表格 51 1所示。
部分    描述
appname    必需的，提供该对象的应用程序名称。
objecttype    必需的，待创建对象的类型或类。
表格 51 1    Class参数语法的各个部分
第7行到第10行代码，当GetObject函数指定的对象被激活之后，就可以在代码中使用对象变量Wb来访问这个对象的属性和方法。
其中第7、8行代码将“数据表”工作簿中的第1张工作表已使用区域的数据赋给本工作表的单元格，第9行代码关闭“数据表”工作簿，使用GetObject函数返回对象的引用时，虽然在窗口中看不到对象的实例，但实际上是打开的，所以需用Close语句将其关闭。
第12行代码开启屏幕更新。</code></pre>
<h4 id="51-3-隐藏Application对象"><a href="#51-3-隐藏Application对象" class="headerlink" title="51-3    隐藏Application对象"></a>51-3    隐藏Application对象</h4><p>通过隐藏Application对象来模拟不打开工作簿取数，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyData_3() &#39;隐藏Application对象来模拟不打开工作簿取数
    Dim myApp As New Application &#39;使用New关键字隐式地创建一个Application对象
    Dim Sh As Worksheet
    Dim Temp As String
    Temp = ThisWorkbook.Path &amp; &quot;\数据表.xls&quot;
    myApp.Visible = False &#39;将新创建的Application对象的Visible属性设置为False，使之隐藏
    Set Sh = myApp.Workbooks.Open(Temp).Sheets(1) &#39;使用Open方法打开“数据表”工作簿
    With Sh.Range(&quot;A1&quot;).CurrentRegion
        Range(&quot;A1&quot;).Resize(.Rows.Count, .Columns.Count) = .Value
    End With
    myApp.Quit
    Set Sh = Nothing
        Set myApp = Nothing
End Sub
代码解析：
第7行代码使用Open方法打开“数据表”工作簿（关于Open方法请参阅技巧42 ，因为工作簿是使用新创建的、隐藏的Application对象打开的，所以在窗口中是不可视的。
第8行到第10行代码将“数据表”工作簿中的第1张工作表已使用区域的数据赋给本工作表的单元格。
第11行代码使用Quit方法退出新打开的Excel程序。</code></pre>
<h4 id="51-4-使用ExecuteExcel4Macro方法"><a href="#51-4-使用ExecuteExcel4Macro方法" class="headerlink" title="51-4    使用ExecuteExcel4Macro方法"></a>51-4    使用ExecuteExcel4Macro方法</h4><p>使用ExecuteExcel4Macro方法可以做到不打开工作簿的情况下获取其他工作薄中指定工作表的数据，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyData_4() &#39;使用ExecuteExcel4Macro方法获取“数据表”工作薄中指定工作表的数据
    Dim RCount As Long
    Dim CCount As Long
    Dim Temp As String
    Dim Temp1 As String
    Dim Temp2 As String
    Dim Temp3 As String
    Dim R As Long
    Dim C As Long
    Dim arr() As Variant
    Temp = &quot;&#39;&quot; &amp; ThisWorkbook.Path &amp; &quot;\[数据表.xls]Sheet1&#39;!&quot;
    Temp1 = Temp &amp; Rows(1).Address(, , xlR1C1)
    Temp1 = &quot;Counta(&quot; &amp; Temp1 &amp; &quot;)&quot;
    CCount = Application.ExecuteExcel4Macro(Temp1)
    Temp2 = Temp &amp; Columns(&quot;A&quot;).Address(, , xlR1C1)
    Temp2 = &quot;Counta(&quot; &amp; Temp2 &amp; &quot;)&quot;
    RCount = Application.ExecuteExcel4Macro(Temp2)
    ReDim arr(1 To RCount, 1 To CCount)
    For R = 1 To RCount
        For C = 1 To CCount
            Temp3 = Temp &amp; Cells(R, C).Address(, , xlR1C1)
            arr(R, C) = Application.ExecuteExcel4Macro(Temp3)
        Next
    Next
    Range(&quot;A1&quot;).Resize(RCount, CCount).Value = arr
End Sub
代码解析：
第14、16行代码使用ExecuteExcel4Macro方法执行Counta函数取得“数据表”工作薄中指定工作表的行数和列数合计。
ExecuteExcel4Macro方法执行一个Microsoft Excel 4.0宏函数，然后返回此函数的结果，语法如下：
expression.ExecuteExcel4Macro(String)
参数expression是可选的，返回一个Application对象。
参数String是必需的，一个不带等号的Microsoft Excel 4.0宏语言函数，所有引用必须是像R1C1这样的字符串。
因为Microsoft Excel 4.0 宏不在当前工作簿或工作表的环境中求值，所有的引用都是外部引用，所以无需打开引用工作簿但是需要明确指定工作簿名称。
第18行代码使用ReDim语句为动态数组arr重新分配存储空间。
第19行到第24行代码循环取值，将“数据表”工作薄中指定工作表的数据赋给动态数组arr。
第25行代码将动态数组arr的值赋给工作表的单元格。</code></pre>
<h4 id="51-5-使用SQL连接"><a href="#51-5-使用SQL连接" class="headerlink" title="51-5    使用SQL连接"></a>51-5    使用SQL连接</h4><p>使用SQL建立与工作簿的连接，查询数据记录后复制到当前工作表中，如下面的代码所示。</p>
<pre><code class="vb">Sub CopyData_5() &#39;使建立与“数据表”工作簿的连接，查询数据记录后复制到当前工作表中
    Dim Sql As String
    Dim j As Integer
    Dim R As Integer
    Dim Cnn As ADODB.Connection
    Dim rs As ADODB.Recordset
    With Sheet5
        .Cells.Clear &#39;删除当前工作表的所有数据
        Set Cnn = New ADODB.Connection
        With Cnn
            .Provider = &quot;microsoft.jet.oledb.4.0&quot;
            .ConnectionString = &quot;Extended Properties=Excel 8.0;&quot; _
                &amp; &quot;Data Source=&quot; &amp; ThisWorkbook.Path &amp; &quot;\数据表&quot;
            .Open
        End With
        Set rs = New ADODB.Recordset
        Sql = &quot;select * from [Sheet1$]&quot;
        rs.Open Sql, Cnn, adOpenKeyset, adLockOptimistic
            For j = 0 To rs.Fields.Count - 1
                .Cells(1, j + 1) = rs.Fields(j).Name
            Next
        R = .Range(&quot;A65536&quot;).End(xlUp).Row
        .Range(&quot;A&quot; &amp; R + 1).CopyFromRecordset rs
    End With
    rs.Close
    Cnn.Close
    Set rs = Nothing
    Set Cnn = Nothing
End Sub
代码解析：
第9行到第15行代码建立与“数据表”工作簿的连接。
第16行到第24行代码查询“数据表”工作簿的全部数据，并复制到工作表中。其中第20行代码将字段名称（标题行）复制到工作表中，第23行代码将查询到的数据记录复制到工作表。</code></pre>
<h3 id="技巧52-返回窗口的可视区域地址"><a href="#技巧52-返回窗口的可视区域地址" class="headerlink" title="技巧52     返回窗口的可视区域地址"></a>技巧52     返回窗口的可视区域地址</h3><p>VBA中使用VisibleRange属性返回当前窗口的可视区域，如下面的代码所示。</p>
<pre><code class="vb">Sub VbRange()
    Dim s As String
    s = ActiveWindow.VisibleRange.Address(0, 0)
    MsgBox &quot;窗口的可视区域为：&quot; &amp; s
End Sub
代码解析：
VbRange过程使用消息框显示当前窗口的可视区域的地址。
应用于当前Window对象的VisibleRange属性返回一个Range对象，代表当前窗口的可视区域。窗口的可视区域就是用户可以在窗口或窗格中看到的单元格区域，如果行或列部分可见，该行或列也包括在可视区域中。
因为VisibleRange属性返回的是一个Range对象，因此可以直接使用该对象的属性和方法。
当窗口的大小发生变化时，返回的可视区域的地址也会不同，如图 52 1、图 52 2所示。</code></pre>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color4">VBA</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の术//" class="article-tag-list-link color4">生の术</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/10/VBA常用技巧3--Wordbook(工作簿)对象/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
    <article id="post-成为一个数据科学家需要哪些技能" class="article article-type-post  article-index" itemscope itemprop="blogPost">
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/05/07/成为一个数据科学家需要哪些技能/">Data Scientist需要具备哪些技能</a>
    </h1>
  

        
        <a href="/2018/05/07/成为一个数据科学家需要哪些技能/" class="archive-article-date">
  	<time datetime="2018-05-06T16:00:00.000Z" itemprop="datePublished"><i class="icon-calendar icon"></i>2018-05-07</time>
</a>
        
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>越来越多的人追逐数据之中所隐藏的价值，风口浪尖之上热火词汇–数据科学家，想成为一个数据科学家需要哪些技能呢？</p>
<h1 id="数据科学家需要具备哪些技能"><a href="#数据科学家需要具备哪些技能" class="headerlink" title="数据科学家需要具备哪些技能"></a>数据科学家需要具备哪些技能</h1><p>本文为翻译整理Ronald van Loon的<a href="https://www.linkedin.com/pulse/what-skills-do-i-need-become-data-scientist-ronald-van-loon" target="_blank" rel="noopener">What Skills Do I Need to Become a Data Scientist?</a>.</p>
<p>大数据作为产生洞察力的引擎，推动了企业级数据科学家对对所有行业垂直领域的需求。无论是改进产品开发流程，帮助提高客户保留率，还是通过数据挖掘新的商业机会–机构越来越依赖于数据科学家的专业只是来维持、推进和超越竞争对手。</p>
<h2 id="成为数据科学家所需要的技术技能"><a href="#成为数据科学家所需要的技术技能" class="headerlink" title="成为数据科学家所需要的技术技能"></a>成为数据科学家所需要的技术技能</h2><p>最重要的技能是统计分析，即能够利用计算框架的能力来挖掘、处理和展现非结构化数据技能。意味着你需要掌握数学、编程和统计，一种主要方式是拥有相关的学术背景。数据科学家通常都拥有计算机科学、工程学的博士或硕士学位，这种学术背景为他们在数据科学实践领域提供了强有力的技术和理论支撑。</p>
<p>对于哪些不想选择这种方式的人可以需求其他选择，包括专注于在线课程(<strong>MOOC</strong>)和新手训练营等。Simplilearn的<a href="https://www.kdnuggets.com/2017/05/cartoon-mother-data.html" target="_blank" rel="noopener">大叔据和分析认证课程</a>包括一些值得探索的课程选项，这些可以加深自己对数据科学实践的理解，而且还能提供一种在教科书范围内无法找到的实用学习方法。</p>
<p><img src="https://jiangmoting-post-1256428291.cos.ap-guangzhou.myqcloud.com/img/2018-05/Skills%20to%20be%20data%20scientist.jpeg" alt></p>
<p>其他技能包括：</p>
<ol>
<li><strong>编程</strong>：需要具备Python、Perl、C/C++、SQL和JAVA等编程语言的知识，其中python是数据科学角色中最常用的编程语言。编程语言可以帮助你清洗、修正和组织非结构化数据集。</li>
<li><strong>SAS和其他分析工具</strong>的知识：数据分析工具能帮助你从数据清洗、修正和组织中提取出有价值的信息。SAS、Hadoop、Spark、Hive、Pig和R是数据科学家使用的最流行的数据分析工具</li>
<li><strong>擅长处理非结构化数据</strong>：提到处理非结构化数据，我门回特别强带哦数据科学家理解和组织来自不同渠道非结构化数据的能力。因此，如果数据科学家正在帮助营销团队进行深入研究时，也应该能很好处理社交关系。</li>
</ol>
<h2 id="成为数据科学家所需要的非技术技能"><a href="#成为数据科学家所需要的非技术技能" class="headerlink" title="成为数据科学家所需要的非技术技能"></a>成为数据科学家所需要的非技术技能</h2><p>非技术技能也是数据科学家所必须的，但是这些技能我们无法从学历、证书等方面评估。</p>
<ol>
<li><strong>强有力的商业头脑</strong>：如果数据科学家没有商业头脑和理解商业模式的元素的专有技能，那么所有这些技术技能都无法有效地被引导和使用。 也将无法辨别需要解决的问题和潜在挑战，这些往往用于保持和发展业务，也就无法真正帮助自己的组织探索新的商业机会。</li>
<li><strong>强大的沟通技巧</strong>：作为一名数据科学家，您需要具备较强的沟通技巧，来使自己的角色获得更大的成功。</li>
<li><strong>良好的数据直觉</strong>：这也许是数据科学家需要的最重要的非技术技能之一。 极好的数据直觉意味着感知表面上没有可观察到的模式，并且知道数值位于未探索的数据位堆中的位置。 这使数据科学家的工作更有效率。 这是一种技巧。想要获得这种经验，训练营是一个很好的训练场地。</li>
</ol>
<h2 id="数据科学家：独角兽"><a href="#数据科学家：独角兽" class="headerlink" title="数据科学家：独角兽"></a>数据科学家：独角兽</h2><p>Lattice公司的首席执行官Shashi Upadhyay曾经将数据科学家称为独角兽，称其为“具有多种技能的专业人员，这种技能在一个人身上不常见”，这就解释了为什么数据科学家是如此的重视，为什么成为一个数据科学家如此具有挑战性。 但是，这不是不可能的。</p>
<p>至少对于我们这些喜欢用数据争吵和喋喋不休的人来说，没有什么是不可能的！</p>

      

      
    </div>
    <div class="article-info article-info-index">
      
      
	<div class="article-tag tagcloud">
		<i class="icon-price-tags icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="javascript:void(0)" class="js-tag article-tag-list-link color5">数据科学</a>
        		</li>
      		
		</ul>
	</div>

      
	<div class="article-category tagcloud">
		<i class="icon-book icon"></i>
		<ul class="article-tag-list">
			 
        		<li class="article-tag-list-item">
        			<a href="/categories/生の道//" class="article-tag-list-link color4">生の道</a>
        		</li>
      		
		</ul>
	</div>


      
        <p class="article-more-link">
          <a class="article-more-a" href="/2018/05/07/成为一个数据科学家需要哪些技能/">展开全文 >></a>
        </p>
      

      
      <div class="clearfix"></div>
    </div>
  </div>
</article>

<aside class="wrap-side-operation">
    <div class="mod-side-operation">
        
        <div class="jump-container" id="js-jump-container" style="display:none;">
            <a href="javascript:void(0)" class="mod-side-operation__jump-to-top">
                <i class="icon-font icon-back"></i>
            </a>
            <div id="js-jump-plan-container" class="jump-plan-container" style="top: -11px;">
                <i class="icon-font icon-plane jump-plane"></i>
            </div>
        </div>
        
        
    </div>
</aside>




  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  


          </div>
        </div>
      </div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2019 绛墨铤
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    <script>
	var yiliaConfig = {
		mathjax: false,
		isHome: true,
		isPost: false,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false,
		toc_hide_index: true,
		root: "/",
		innerArchive: true,
		showTags: false
	}
</script>

<script>!function(t){function n(e){if(r[e])return r[e].exports;var i=r[e]={exports:{},id:e,loaded:!1};return t[e].call(i.exports,i,i.exports,n),i.loaded=!0,i.exports}var r={};n.m=t,n.c=r,n.p="./",n(0)}([function(t,n,r){r(195),t.exports=r(191)},function(t,n,r){var e=r(3),i=r(52),o=r(27),u=r(28),c=r(53),f="prototype",a=function(t,n,r){var s,l,h,v,p=t&a.F,d=t&a.G,y=t&a.S,g=t&a.P,b=t&a.B,m=d?e:y?e[n]||(e[n]={}):(e[n]||{})[f],x=d?i:i[n]||(i[n]={}),w=x[f]||(x[f]={});d&&(r=n);for(s in r)l=!p&&m&&void 0!==m[s],h=(l?m:r)[s],v=b&&l?c(h,e):g&&"function"==typeof h?c(Function.call,h):h,m&&u(m,s,h,t&a.U),x[s]!=h&&o(x,s,v),g&&w[s]!=h&&(w[s]=h)};e.core=i,a.F=1,a.G=2,a.S=4,a.P=8,a.B=16,a.W=32,a.U=64,a.R=128,t.exports=a},function(t,n,r){var e=r(6);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n){var r=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=r)},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n,r){var e=r(126)("wks"),i=r(76),o=r(3).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n,r){var e=r(94),i=r(33);t.exports=function(t){return e(i(t))}},function(t,n,r){t.exports=!r(4)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(2),i=r(167),o=r(50),u=Object.defineProperty;n.f=r(10)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){t.exports=!r(18)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(14),i=r(22);t.exports=r(12)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(20),i=r(58),o=r(42),u=Object.defineProperty;n.f=r(12)?Object.defineProperty:function(t,n,r){if(e(t),n=o(n,!0),e(r),i)try{return u(t,n,r)}catch(t){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(t[n]=r.value),t}},function(t,n,r){var e=r(40)("wks"),i=r(23),o=r(5).Symbol,u="function"==typeof o;(t.exports=function(t){return e[t]||(e[t]=u&&o[t]||(u?o:i)("Symbol."+t))}).store=e},function(t,n,r){var e=r(67),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){var e=r(46);t.exports=function(t){return Object(e(t))}},function(t,n){t.exports=function(t){try{return!!t()}catch(t){return!0}}},function(t,n,r){var e=r(63),i=r(34);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(21);t.exports=function(t){if(!e(t))throw TypeError(t+" is not an object!");return t}},function(t,n){t.exports=function(t){return"object"==typeof t?null!==t:"function"==typeof t}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n){var r={}.hasOwnProperty;t.exports=function(t,n){return r.call(t,n)}},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n,r){var e=r(11),i=r(66);t.exports=r(10)?function(t,n,r){return e.f(t,n,i(1,r))}:function(t,n,r){return t[n]=r,t}},function(t,n,r){var e=r(3),i=r(27),o=r(24),u=r(76)("src"),c="toString",f=Function[c],a=(""+f).split(c);r(52).inspectSource=function(t){return f.call(t)},(t.exports=function(t,n,r,c){var f="function"==typeof r;f&&(o(r,"name")||i(r,"name",n)),t[n]!==r&&(f&&(o(r,u)||i(r,u,t[n]?""+t[n]:a.join(String(n)))),t===e?t[n]=r:c?t[n]?t[n]=r:i(t,n,r):(delete t[n],i(t,n,r)))})(Function.prototype,c,function(){return"function"==typeof this&&this[u]||f.call(this)})},function(t,n,r){var e=r(1),i=r(4),o=r(46),u=function(t,n,r,e){var i=String(o(t)),u="<"+n;return""!==r&&(u+=" "+r+'="'+String(e).replace(/"/g,"&quot;")+'"'),u+">"+i+"</"+n+">"};t.exports=function(t,n){var r={};r[t]=n(u),e(e.P+e.F*i(function(){var n=""[t]('"');return n!==n.toLowerCase()||n.split('"').length>3}),"String",r)}},function(t,n,r){var e=r(115),i=r(46);t.exports=function(t){return e(i(t))}},function(t,n,r){var e=r(116),i=r(66),o=r(30),u=r(50),c=r(24),f=r(167),a=Object.getOwnPropertyDescriptor;n.f=r(10)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(24),i=r(17),o=r(145)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n){t.exports={}},function(t,n){t.exports=!0},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(14).f,i=r(8),o=r(15)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(40)("keys"),i=r(23);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(5),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n,r){var e=r(21);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(36),u=r(44),c=r(14).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){n.f=r(15)},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n){t.exports=function(t){if(void 0==t)throw TypeError("Can't call method on  "+t);return t}},function(t,n,r){var e=r(4);t.exports=function(t,n){return!!t&&e(function(){n?t.call(null,function(){},1):t.call(null)})}},function(t,n,r){var e=r(53),i=r(115),o=r(17),u=r(16),c=r(203);t.exports=function(t,n){var r=1==t,f=2==t,a=3==t,s=4==t,l=6==t,h=5==t||l,v=n||c;return function(n,c,p){for(var d,y,g=o(n),b=i(g),m=e(c,p,3),x=u(b.length),w=0,S=r?v(n,x):f?v(n,0):void 0;x>w;w++)if((h||w in b)&&(d=b[w],y=m(d,w,g),t))if(r)S[w]=y;else if(y)switch(t){case 3:return!0;case 5:return d;case 6:return w;case 2:S.push(d)}else if(s)return!1;return l?-1:a||s?s:S}}},function(t,n,r){var e=r(1),i=r(52),o=r(4);t.exports=function(t,n){var r=(i.Object||{})[t]||Object[t],u={};u[t]=n(r),e(e.S+e.F*o(function(){r(1)}),"Object",u)}},function(t,n,r){var e=r(6);t.exports=function(t,n){if(!e(t))return t;var r,i;if(n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;if("function"==typeof(r=t.valueOf)&&!e(i=r.call(t)))return i;if(!n&&"function"==typeof(r=t.toString)&&!e(i=r.call(t)))return i;throw TypeError("Can't convert object to primitive value")}},function(t,n,r){var e=r(5),i=r(25),o=r(91),u=r(13),c="prototype",f=function(t,n,r){var a,s,l,h=t&f.F,v=t&f.G,p=t&f.S,d=t&f.P,y=t&f.B,g=t&f.W,b=v?i:i[n]||(i[n]={}),m=b[c],x=v?e:p?e[n]:(e[n]||{})[c];v&&(r=n);for(a in r)(s=!h&&x&&void 0!==x[a])&&a in b||(l=s?x[a]:r[a],b[a]=v&&"function"!=typeof x[a]?r[a]:y&&s?o(l,e):g&&x[a]==l?function(t){var n=function(n,r,e){if(this instanceof t){switch(arguments.length){case 0:return new t;case 1:return new t(n);case 2:return new t(n,r)}return new t(n,r,e)}return t.apply(this,arguments)};return n[c]=t[c],n}(l):d&&"function"==typeof l?o(Function.call,l):l,d&&((b.virtual||(b.virtual={}))[a]=l,t&f.R&&m&&!m[a]&&u(m,a,l)))};f.F=1,f.G=2,f.S=4,f.P=8,f.B=16,f.W=32,f.U=64,f.R=128,t.exports=f},function(t,n){var r=t.exports={version:"2.4.0"};"number"==typeof __e&&(__e=r)},function(t,n,r){var e=r(26);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(183),i=r(1),o=r(126)("metadata"),u=o.store||(o.store=new(r(186))),c=function(t,n,r){var i=u.get(t);if(!i){if(!r)return;u.set(t,i=new e)}var o=i.get(n);if(!o){if(!r)return;i.set(n,o=new e)}return o},f=function(t,n,r){var e=c(n,r,!1);return void 0!==e&&e.has(t)},a=function(t,n,r){var e=c(n,r,!1);return void 0===e?void 0:e.get(t)},s=function(t,n,r,e){c(r,e,!0).set(t,n)},l=function(t,n){var r=c(t,n,!1),e=[];return r&&r.forEach(function(t,n){e.push(n)}),e},h=function(t){return void 0===t||"symbol"==typeof t?t:String(t)},v=function(t){i(i.S,"Reflect",t)};t.exports={store:u,map:c,has:f,get:a,set:s,keys:l,key:h,exp:v}},function(t,n,r){"use strict";if(r(10)){var e=r(69),i=r(3),o=r(4),u=r(1),c=r(127),f=r(152),a=r(53),s=r(68),l=r(66),h=r(27),v=r(73),p=r(67),d=r(16),y=r(75),g=r(50),b=r(24),m=r(180),x=r(114),w=r(6),S=r(17),_=r(137),O=r(70),E=r(32),P=r(71).f,j=r(154),F=r(76),M=r(7),A=r(48),N=r(117),T=r(146),I=r(155),k=r(80),L=r(123),R=r(74),C=r(130),D=r(160),U=r(11),W=r(31),G=U.f,B=W.f,V=i.RangeError,z=i.TypeError,q=i.Uint8Array,K="ArrayBuffer",J="Shared"+K,Y="BYTES_PER_ELEMENT",H="prototype",$=Array[H],X=f.ArrayBuffer,Q=f.DataView,Z=A(0),tt=A(2),nt=A(3),rt=A(4),et=A(5),it=A(6),ot=N(!0),ut=N(!1),ct=I.values,ft=I.keys,at=I.entries,st=$.lastIndexOf,lt=$.reduce,ht=$.reduceRight,vt=$.join,pt=$.sort,dt=$.slice,yt=$.toString,gt=$.toLocaleString,bt=M("iterator"),mt=M("toStringTag"),xt=F("typed_constructor"),wt=F("def_constructor"),St=c.CONSTR,_t=c.TYPED,Ot=c.VIEW,Et="Wrong length!",Pt=A(1,function(t,n){return Tt(T(t,t[wt]),n)}),jt=o(function(){return 1===new q(new Uint16Array([1]).buffer)[0]}),Ft=!!q&&!!q[H].set&&o(function(){new q(1).set({})}),Mt=function(t,n){if(void 0===t)throw z(Et);var r=+t,e=d(t);if(n&&!m(r,e))throw V(Et);return e},At=function(t,n){var r=p(t);if(r<0||r%n)throw V("Wrong offset!");return r},Nt=function(t){if(w(t)&&_t in t)return t;throw z(t+" is not a typed array!")},Tt=function(t,n){if(!(w(t)&&xt in t))throw z("It is not a typed array constructor!");return new t(n)},It=function(t,n){return kt(T(t,t[wt]),n)},kt=function(t,n){for(var r=0,e=n.length,i=Tt(t,e);e>r;)i[r]=n[r++];return i},Lt=function(t,n,r){G(t,n,{get:function(){return this._d[r]}})},Rt=function(t){var n,r,e,i,o,u,c=S(t),f=arguments.length,s=f>1?arguments[1]:void 0,l=void 0!==s,h=j(c);if(void 0!=h&&!_(h)){for(u=h.call(c),e=[],n=0;!(o=u.next()).done;n++)e.push(o.value);c=e}for(l&&f>2&&(s=a(s,arguments[2],2)),n=0,r=d(c.length),i=Tt(this,r);r>n;n++)i[n]=l?s(c[n],n):c[n];return i},Ct=function(){for(var t=0,n=arguments.length,r=Tt(this,n);n>t;)r[t]=arguments[t++];return r},Dt=!!q&&o(function(){gt.call(new q(1))}),Ut=function(){return gt.apply(Dt?dt.call(Nt(this)):Nt(this),arguments)},Wt={copyWithin:function(t,n){return D.call(Nt(this),t,n,arguments.length>2?arguments[2]:void 0)},every:function(t){return rt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},fill:function(t){return C.apply(Nt(this),arguments)},filter:function(t){return It(this,tt(Nt(this),t,arguments.length>1?arguments[1]:void 0))},find:function(t){return et(Nt(this),t,arguments.length>1?arguments[1]:void 0)},findIndex:function(t){return it(Nt(this),t,arguments.length>1?arguments[1]:void 0)},forEach:function(t){Z(Nt(this),t,arguments.length>1?arguments[1]:void 0)},indexOf:function(t){return ut(Nt(this),t,arguments.length>1?arguments[1]:void 0)},includes:function(t){return ot(Nt(this),t,arguments.length>1?arguments[1]:void 0)},join:function(t){return vt.apply(Nt(this),arguments)},lastIndexOf:function(t){return st.apply(Nt(this),arguments)},map:function(t){return Pt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},reduce:function(t){return lt.apply(Nt(this),arguments)},reduceRight:function(t){return ht.apply(Nt(this),arguments)},reverse:function(){for(var t,n=this,r=Nt(n).length,e=Math.floor(r/2),i=0;i<e;)t=n[i],n[i++]=n[--r],n[r]=t;return n},some:function(t){return nt(Nt(this),t,arguments.length>1?arguments[1]:void 0)},sort:function(t){return pt.call(Nt(this),t)},subarray:function(t,n){var r=Nt(this),e=r.length,i=y(t,e);return new(T(r,r[wt]))(r.buffer,r.byteOffset+i*r.BYTES_PER_ELEMENT,d((void 0===n?e:y(n,e))-i))}},Gt=function(t,n){return It(this,dt.call(Nt(this),t,n))},Bt=function(t){Nt(this);var n=At(arguments[1],1),r=this.length,e=S(t),i=d(e.length),o=0;if(i+n>r)throw V(Et);for(;o<i;)this[n+o]=e[o++]},Vt={entries:function(){return at.call(Nt(this))},keys:function(){return ft.call(Nt(this))},values:function(){return ct.call(Nt(this))}},zt=function(t,n){return w(t)&&t[_t]&&"symbol"!=typeof n&&n in t&&String(+n)==String(n)},qt=function(t,n){return zt(t,n=g(n,!0))?l(2,t[n]):B(t,n)},Kt=function(t,n,r){return!(zt(t,n=g(n,!0))&&w(r)&&b(r,"value"))||b(r,"get")||b(r,"set")||r.configurable||b(r,"writable")&&!r.writable||b(r,"enumerable")&&!r.enumerable?G(t,n,r):(t[n]=r.value,t)};St||(W.f=qt,U.f=Kt),u(u.S+u.F*!St,"Object",{getOwnPropertyDescriptor:qt,defineProperty:Kt}),o(function(){yt.call({})})&&(yt=gt=function(){return vt.call(this)});var Jt=v({},Wt);v(Jt,Vt),h(Jt,bt,Vt.values),v(Jt,{slice:Gt,set:Bt,constructor:function(){},toString:yt,toLocaleString:Ut}),Lt(Jt,"buffer","b"),Lt(Jt,"byteOffset","o"),Lt(Jt,"byteLength","l"),Lt(Jt,"length","e"),G(Jt,mt,{get:function(){return this[_t]}}),t.exports=function(t,n,r,f){f=!!f;var a=t+(f?"Clamped":"")+"Array",l="Uint8Array"!=a,v="get"+t,p="set"+t,y=i[a],g=y||{},b=y&&E(y),m=!y||!c.ABV,S={},_=y&&y[H],j=function(t,r){var e=t._d;return e.v[v](r*n+e.o,jt)},F=function(t,r,e){var i=t._d;f&&(e=(e=Math.round(e))<0?0:e>255?255:255&e),i.v[p](r*n+i.o,e,jt)},M=function(t,n){G(t,n,{get:function(){return j(this,n)},set:function(t){return F(this,n,t)},enumerable:!0})};m?(y=r(function(t,r,e,i){s(t,y,a,"_d");var o,u,c,f,l=0,v=0;if(w(r)){if(!(r instanceof X||(f=x(r))==K||f==J))return _t in r?kt(y,r):Rt.call(y,r);o=r,v=At(e,n);var p=r.byteLength;if(void 0===i){if(p%n)throw V(Et);if((u=p-v)<0)throw V(Et)}else if((u=d(i)*n)+v>p)throw V(Et);c=u/n}else c=Mt(r,!0),u=c*n,o=new X(u);for(h(t,"_d",{b:o,o:v,l:u,e:c,v:new Q(o)});l<c;)M(t,l++)}),_=y[H]=O(Jt),h(_,"constructor",y)):L(function(t){new y(null),new y(t)},!0)||(y=r(function(t,r,e,i){s(t,y,a);var o;return w(r)?r instanceof X||(o=x(r))==K||o==J?void 0!==i?new g(r,At(e,n),i):void 0!==e?new g(r,At(e,n)):new g(r):_t in r?kt(y,r):Rt.call(y,r):new g(Mt(r,l))}),Z(b!==Function.prototype?P(g).concat(P(b)):P(g),function(t){t in y||h(y,t,g[t])}),y[H]=_,e||(_.constructor=y));var A=_[bt],N=!!A&&("values"==A.name||void 0==A.name),T=Vt.values;h(y,xt,!0),h(_,_t,a),h(_,Ot,!0),h(_,wt,y),(f?new y(1)[mt]==a:mt in _)||G(_,mt,{get:function(){return a}}),S[a]=y,u(u.G+u.W+u.F*(y!=g),S),u(u.S,a,{BYTES_PER_ELEMENT:n,from:Rt,of:Ct}),Y in _||h(_,Y,n),u(u.P,a,Wt),R(a),u(u.P+u.F*Ft,a,{set:Bt}),u(u.P+u.F*!N,a,Vt),u(u.P+u.F*(_.toString!=yt),a,{toString:yt}),u(u.P+u.F*o(function(){new y(1).slice()}),a,{slice:Gt}),u(u.P+u.F*(o(function(){return[1,2].toLocaleString()!=new y([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),a,{toLocaleString:Ut}),k[a]=N?A:T,e||N||h(_,bt,T)}}else t.exports=function(){}},function(t,n){var r={}.toString;t.exports=function(t){return r.call(t).slice(8,-1)}},function(t,n,r){var e=r(21),i=r(5).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n,r){t.exports=!r(12)&&!r(18)(function(){return 7!=Object.defineProperty(r(57)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){"use strict";var e=r(36),i=r(51),o=r(64),u=r(13),c=r(8),f=r(35),a=r(96),s=r(38),l=r(103),h=r(15)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n,r){var e=r(20),i=r(100),o=r(34),u=r(39)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(57)("iframe"),e=o.length;for(n.style.display="none",r(93).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(63),i=r(34).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(8),i=r(9),o=r(90)(!1),u=r(39)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){t.exports=r(13)},function(t,n,r){var e=r(76)("meta"),i=r(6),o=r(24),u=r(11).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(4)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n){t.exports=function(t,n){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:n}}},function(t,n){var r=Math.ceil,e=Math.floor;t.exports=function(t){return isNaN(t=+t)?0:(t>0?e:r)(t)}},function(t,n){t.exports=function(t,n,r,e){if(!(t instanceof n)||void 0!==e&&e in t)throw TypeError(r+": incorrect invocation!");return t}},function(t,n){t.exports=!1},function(t,n,r){var e=r(2),i=r(173),o=r(133),u=r(145)("IE_PROTO"),c=function(){},f="prototype",a=function(){var t,n=r(132)("iframe"),e=o.length;for(n.style.display="none",r(135).appendChild(n),n.src="javascript:",t=n.contentWindow.document,t.open(),t.write("<script>document.F=Object<\/script>"),t.close(),a=t.F;e--;)delete a[f][o[e]];return a()};t.exports=Object.create||function(t,n){var r;return null!==t?(c[f]=e(t),r=new c,c[f]=null,r[u]=t):r=a(),void 0===n?r:i(r,n)}},function(t,n,r){var e=r(175),i=r(133).concat("length","prototype");n.f=Object.getOwnPropertyNames||function(t){return e(t,i)}},function(t,n,r){var e=r(175),i=r(133);t.exports=Object.keys||function(t){return e(t,i)}},function(t,n,r){var e=r(28);t.exports=function(t,n,r){for(var i in n)e(t,i,n[i],r);return t}},function(t,n,r){"use strict";var e=r(3),i=r(11),o=r(10),u=r(7)("species");t.exports=function(t){var n=e[t];o&&n&&!n[u]&&i.f(n,u,{configurable:!0,get:function(){return this}})}},function(t,n,r){var e=r(67),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n){var r=0,e=Math.random();t.exports=function(t){return"Symbol(".concat(void 0===t?"":t,")_",(++r+e).toString(36))}},function(t,n,r){var e=r(33);t.exports=function(t){return Object(e(t))}},function(t,n,r){var e=r(7)("unscopables"),i=Array.prototype;void 0==i[e]&&r(27)(i,e,{}),t.exports=function(t){i[e][t]=!0}},function(t,n,r){var e=r(53),i=r(169),o=r(137),u=r(2),c=r(16),f=r(154),a={},s={},n=t.exports=function(t,n,r,l,h){var v,p,d,y,g=h?function(){return t}:f(t),b=e(r,l,n?2:1),m=0;if("function"!=typeof g)throw TypeError(t+" is not iterable!");if(o(g)){for(v=c(t.length);v>m;m++)if((y=n?b(u(p=t[m])[0],p[1]):b(t[m]))===a||y===s)return y}else for(d=g.call(t);!(p=d.next()).done;)if((y=i(d,b,p.value,n))===a||y===s)return y};n.BREAK=a,n.RETURN=s},function(t,n){t.exports={}},function(t,n,r){var e=r(11).f,i=r(24),o=r(7)("toStringTag");t.exports=function(t,n,r){t&&!i(t=r?t:t.prototype,o)&&e(t,o,{configurable:!0,value:n})}},function(t,n,r){var e=r(1),i=r(46),o=r(4),u=r(150),c="["+u+"]",f="​",a=RegExp("^"+c+c+"*"),s=RegExp(c+c+"*$"),l=function(t,n,r){var i={},c=o(function(){return!!u[t]()||f[t]()!=f}),a=i[t]=c?n(h):u[t];r&&(i[r]=a),e(e.P+e.F*c,"String",i)},h=l.trim=function(t,n){return t=String(i(t)),1&n&&(t=t.replace(a,"")),2&n&&(t=t.replace(s,"")),t};t.exports=l},function(t,n,r){t.exports={default:r(86),__esModule:!0}},function(t,n,r){t.exports={default:r(87),__esModule:!0}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}n.__esModule=!0;var i=r(84),o=e(i),u=r(83),c=e(u),f="function"==typeof c.default&&"symbol"==typeof o.default?function(t){return typeof t}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":typeof t};n.default="function"==typeof c.default&&"symbol"===f(o.default)?function(t){return void 0===t?"undefined":f(t)}:function(t){return t&&"function"==typeof c.default&&t.constructor===c.default&&t!==c.default.prototype?"symbol":void 0===t?"undefined":f(t)}},function(t,n,r){r(110),r(108),r(111),r(112),t.exports=r(25).Symbol},function(t,n,r){r(109),r(113),t.exports=r(44).f("iterator")},function(t,n){t.exports=function(t){if("function"!=typeof t)throw TypeError(t+" is not a function!");return t}},function(t,n){t.exports=function(){}},function(t,n,r){var e=r(9),i=r(106),o=r(105);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){var e=r(88);t.exports=function(t,n,r){if(e(t),void 0===n)return t;switch(r){case 1:return function(r){return t.call(n,r)};case 2:return function(r,e){return t.call(n,r,e)};case 3:return function(r,e,i){return t.call(n,r,e,i)}}return function(){return t.apply(n,arguments)}}},function(t,n,r){var e=r(19),i=r(62),o=r(37);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){t.exports=r(5).document&&document.documentElement},function(t,n,r){var e=r(56);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n,r){var e=r(56);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(60),i=r(22),o=r(38),u={};r(13)(u,r(15)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n,r){var e=r(19),i=r(9);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){var e=r(23)("meta"),i=r(21),o=r(8),u=r(14).f,c=0,f=Object.isExtensible||function(){return!0},a=!r(18)(function(){return f(Object.preventExtensions({}))}),s=function(t){u(t,e,{value:{i:"O"+ ++c,w:{}}})},l=function(t,n){if(!i(t))return"symbol"==typeof t?t:("string"==typeof t?"S":"P")+t;if(!o(t,e)){if(!f(t))return"F";if(!n)return"E";s(t)}return t[e].i},h=function(t,n){if(!o(t,e)){if(!f(t))return!0;if(!n)return!1;s(t)}return t[e].w},v=function(t){return a&&p.NEED&&f(t)&&!o(t,e)&&s(t),t},p=t.exports={KEY:e,NEED:!1,fastKey:l,getWeak:h,onFreeze:v}},function(t,n,r){var e=r(14),i=r(20),o=r(19);t.exports=r(12)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(37),i=r(22),o=r(9),u=r(42),c=r(8),f=r(58),a=Object.getOwnPropertyDescriptor;n.f=r(12)?a:function(t,n){if(t=o(t),n=u(n,!0),f)try{return a(t,n)}catch(t){}if(c(t,n))return i(!e.f.call(t,n),t[n])}},function(t,n,r){var e=r(9),i=r(61).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(8),i=r(77),o=r(39)("IE_PROTO"),u=Object.prototype;t.exports=Object.getPrototypeOf||function(t){return t=i(t),e(t,o)?t[o]:"function"==typeof t.constructor&&t instanceof t.constructor?t.constructor.prototype:t instanceof Object?u:null}},function(t,n,r){var e=r(41),i=r(33);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(41),i=Math.max,o=Math.min;t.exports=function(t,n){return t=e(t),t<0?i(t+n,0):o(t,n)}},function(t,n,r){var e=r(41),i=Math.min;t.exports=function(t){return t>0?i(e(t),9007199254740991):0}},function(t,n,r){"use strict";var e=r(89),i=r(97),o=r(35),u=r(9);t.exports=r(59)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){},function(t,n,r){"use strict";var e=r(104)(!0);r(59)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";var e=r(5),i=r(8),o=r(12),u=r(51),c=r(64),f=r(99).KEY,a=r(18),s=r(40),l=r(38),h=r(23),v=r(15),p=r(44),d=r(43),y=r(98),g=r(92),b=r(95),m=r(20),x=r(9),w=r(42),S=r(22),_=r(60),O=r(102),E=r(101),P=r(14),j=r(19),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(61).f=O.f=Z,r(37).f=X,r(62).f=tt,o&&!r(36)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(13)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){r(43)("asyncIterator")},function(t,n,r){r(43)("observable")},function(t,n,r){r(107);for(var e=r(5),i=r(13),o=r(35),u=r(15)("toStringTag"),c=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var a=c[f],s=e[a],l=s&&s.prototype;l&&!l[u]&&i(l,u,a),o[a]=o.Array}},function(t,n,r){var e=r(45),i=r(7)("toStringTag"),o="Arguments"==e(function(){return arguments}()),u=function(t,n){try{return t[n]}catch(t){}};t.exports=function(t){var n,r,c;return void 0===t?"Undefined":null===t?"Null":"string"==typeof(r=u(n=Object(t),i))?r:o?e(n):"Object"==(c=e(n))&&"function"==typeof n.callee?"Arguments":c}},function(t,n,r){var e=r(45);t.exports=Object("z").propertyIsEnumerable(0)?Object:function(t){return"String"==e(t)?t.split(""):Object(t)}},function(t,n){n.f={}.propertyIsEnumerable},function(t,n,r){var e=r(30),i=r(16),o=r(75);t.exports=function(t){return function(n,r,u){var c,f=e(n),a=i(f.length),s=o(u,a);if(t&&r!=r){for(;a>s;)if((c=f[s++])!=c)return!0}else for(;a>s;s++)if((t||s in f)&&f[s]===r)return t||s||0;return!t&&-1}}},function(t,n,r){"use strict";var e=r(3),i=r(1),o=r(28),u=r(73),c=r(65),f=r(79),a=r(68),s=r(6),l=r(4),h=r(123),v=r(81),p=r(136);t.exports=function(t,n,r,d,y,g){var b=e[t],m=b,x=y?"set":"add",w=m&&m.prototype,S={},_=function(t){var n=w[t];o(w,t,"delete"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"has"==t?function(t){return!(g&&!s(t))&&n.call(this,0===t?0:t)}:"get"==t?function(t){return g&&!s(t)?void 0:n.call(this,0===t?0:t)}:"add"==t?function(t){return n.call(this,0===t?0:t),this}:function(t,r){return n.call(this,0===t?0:t,r),this})};if("function"==typeof m&&(g||w.forEach&&!l(function(){(new m).entries().next()}))){var O=new m,E=O[x](g?{}:-0,1)!=O,P=l(function(){O.has(1)}),j=h(function(t){new m(t)}),F=!g&&l(function(){for(var t=new m,n=5;n--;)t[x](n,n);return!t.has(-0)});j||(m=n(function(n,r){a(n,m,t);var e=p(new b,n,m);return void 0!=r&&f(r,y,e[x],e),e}),m.prototype=w,w.constructor=m),(P||F)&&(_("delete"),_("has"),y&&_("get")),(F||E)&&_(x),g&&w.clear&&delete w.clear}else m=d.getConstructor(n,t,y,x),u(m.prototype,r),c.NEED=!0;return v(m,t),S[t]=m,i(i.G+i.W+i.F*(m!=b),S),g||d.setStrong(m,t,y),m}},function(t,n,r){"use strict";var e=r(27),i=r(28),o=r(4),u=r(46),c=r(7);t.exports=function(t,n,r){var f=c(t),a=r(u,f,""[t]),s=a[0],l=a[1];o(function(){var n={};return n[f]=function(){return 7},7!=""[t](n)})&&(i(String.prototype,t,s),e(RegExp.prototype,f,2==n?function(t,n){return l.call(t,this,n)}:function(t){return l.call(t,this)}))}
},function(t,n,r){"use strict";var e=r(2);t.exports=function(){var t=e(this),n="";return t.global&&(n+="g"),t.ignoreCase&&(n+="i"),t.multiline&&(n+="m"),t.unicode&&(n+="u"),t.sticky&&(n+="y"),n}},function(t,n){t.exports=function(t,n,r){var e=void 0===r;switch(n.length){case 0:return e?t():t.call(r);case 1:return e?t(n[0]):t.call(r,n[0]);case 2:return e?t(n[0],n[1]):t.call(r,n[0],n[1]);case 3:return e?t(n[0],n[1],n[2]):t.call(r,n[0],n[1],n[2]);case 4:return e?t(n[0],n[1],n[2],n[3]):t.call(r,n[0],n[1],n[2],n[3])}return t.apply(r,n)}},function(t,n,r){var e=r(6),i=r(45),o=r(7)("match");t.exports=function(t){var n;return e(t)&&(void 0!==(n=t[o])?!!n:"RegExp"==i(t))}},function(t,n,r){var e=r(7)("iterator"),i=!1;try{var o=[7][e]();o.return=function(){i=!0},Array.from(o,function(){throw 2})}catch(t){}t.exports=function(t,n){if(!n&&!i)return!1;var r=!1;try{var o=[7],u=o[e]();u.next=function(){return{done:r=!0}},o[e]=function(){return u},t(o)}catch(t){}return r}},function(t,n,r){t.exports=r(69)||!r(4)(function(){var t=Math.random();__defineSetter__.call(null,t,function(){}),delete r(3)[t]})},function(t,n){n.f=Object.getOwnPropertySymbols},function(t,n,r){var e=r(3),i="__core-js_shared__",o=e[i]||(e[i]={});t.exports=function(t){return o[t]||(o[t]={})}},function(t,n,r){for(var e,i=r(3),o=r(27),u=r(76),c=u("typed_array"),f=u("view"),a=!(!i.ArrayBuffer||!i.DataView),s=a,l=0,h="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");l<9;)(e=i[h[l++]])?(o(e.prototype,c,!0),o(e.prototype,f,!0)):s=!1;t.exports={ABV:a,CONSTR:s,TYPED:c,VIEW:f}},function(t,n){"use strict";var r={versions:function(){var t=window.navigator.userAgent;return{trident:t.indexOf("Trident")>-1,presto:t.indexOf("Presto")>-1,webKit:t.indexOf("AppleWebKit")>-1,gecko:t.indexOf("Gecko")>-1&&-1==t.indexOf("KHTML"),mobile:!!t.match(/AppleWebKit.*Mobile.*/),ios:!!t.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),android:t.indexOf("Android")>-1||t.indexOf("Linux")>-1,iPhone:t.indexOf("iPhone")>-1||t.indexOf("Mac")>-1,iPad:t.indexOf("iPad")>-1,webApp:-1==t.indexOf("Safari"),weixin:-1==t.indexOf("MicroMessenger")}}()};t.exports=r},function(t,n,r){"use strict";var e=r(85),i=function(t){return t&&t.__esModule?t:{default:t}}(e),o=function(){function t(t,n,e){return n||e?String.fromCharCode(n||e):r[t]||t}function n(t){return e[t]}var r={"&quot;":'"',"&lt;":"<","&gt;":">","&amp;":"&","&nbsp;":" "},e={};for(var u in r)e[r[u]]=u;return r["&apos;"]="'",e["'"]="&#39;",{encode:function(t){return t?(""+t).replace(/['<> "&]/g,n).replace(/\r?\n/g,"<br/>").replace(/\s/g,"&nbsp;"):""},decode:function(n){return n?(""+n).replace(/<br\s*\/?>/gi,"\n").replace(/&quot;|&lt;|&gt;|&amp;|&nbsp;|&apos;|&#(\d+);|&#(\d+)/g,t).replace(/\u00a0/g," "):""},encodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},encodeBase16forJSON:function(t){if(!t)return t;t=t.replace(/[\u4E00-\u9FBF]/gi,function(t){return escape(t).replace("%u","\\u")});for(var n=[],r=0,e=t.length;e>r;r++)n.push(t.charCodeAt(r).toString(16).toUpperCase());return n.join("")},decodeBase16:function(t){if(!t)return t;t+="";for(var n=[],r=0,e=t.length;e>r;r+=2)n.push(String.fromCharCode("0x"+t.slice(r,r+2)));return n.join("")},encodeObject:function(t){if(t instanceof Array)for(var n=0,r=t.length;r>n;n++)t[n]=o.encodeObject(t[n]);else if("object"==(void 0===t?"undefined":(0,i.default)(t)))for(var e in t)t[e]=o.encodeObject(t[e]);else if("string"==typeof t)return o.encode(t);return t},loadScript:function(t){var n=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(n),n.setAttribute("src",t)},addLoadEvent:function(t){var n=window.onload;"function"!=typeof window.onload?window.onload=t:window.onload=function(){n(),t()}}}}();t.exports=o},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=function(t){for(var n=e(this),r=o(n.length),u=arguments.length,c=i(u>1?arguments[1]:void 0,r),f=u>2?arguments[2]:void 0,a=void 0===f?r:i(f,r);a>c;)n[c++]=t;return n}},function(t,n,r){"use strict";var e=r(11),i=r(66);t.exports=function(t,n,r){n in t?e.f(t,n,i(0,r)):t[n]=r}},function(t,n,r){var e=r(6),i=r(3).document,o=e(i)&&e(i.createElement);t.exports=function(t){return o?i.createElement(t):{}}},function(t,n){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(t,n,r){var e=r(7)("match");t.exports=function(t){var n=/./;try{"/./"[t](n)}catch(r){try{return n[e]=!1,!"/./"[t](n)}catch(t){}}return!0}},function(t,n,r){t.exports=r(3).document&&document.documentElement},function(t,n,r){var e=r(6),i=r(144).set;t.exports=function(t,n,r){var o,u=n.constructor;return u!==r&&"function"==typeof u&&(o=u.prototype)!==r.prototype&&e(o)&&i&&i(t,o),t}},function(t,n,r){var e=r(80),i=r(7)("iterator"),o=Array.prototype;t.exports=function(t){return void 0!==t&&(e.Array===t||o[i]===t)}},function(t,n,r){var e=r(45);t.exports=Array.isArray||function(t){return"Array"==e(t)}},function(t,n,r){"use strict";var e=r(70),i=r(66),o=r(81),u={};r(27)(u,r(7)("iterator"),function(){return this}),t.exports=function(t,n,r){t.prototype=e(u,{next:i(1,r)}),o(t,n+" Iterator")}},function(t,n,r){"use strict";var e=r(69),i=r(1),o=r(28),u=r(27),c=r(24),f=r(80),a=r(139),s=r(81),l=r(32),h=r(7)("iterator"),v=!([].keys&&"next"in[].keys()),p="keys",d="values",y=function(){return this};t.exports=function(t,n,r,g,b,m,x){a(r,n,g);var w,S,_,O=function(t){if(!v&&t in F)return F[t];switch(t){case p:case d:return function(){return new r(this,t)}}return function(){return new r(this,t)}},E=n+" Iterator",P=b==d,j=!1,F=t.prototype,M=F[h]||F["@@iterator"]||b&&F[b],A=M||O(b),N=b?P?O("entries"):A:void 0,T="Array"==n?F.entries||M:M;if(T&&(_=l(T.call(new t)))!==Object.prototype&&(s(_,E,!0),e||c(_,h)||u(_,h,y)),P&&M&&M.name!==d&&(j=!0,A=function(){return M.call(this)}),e&&!x||!v&&!j&&F[h]||u(F,h,A),f[n]=A,f[E]=y,b)if(w={values:P?A:O(d),keys:m?A:O(p),entries:N},x)for(S in w)S in F||o(F,S,w[S]);else i(i.P+i.F*(v||j),n,w);return w}},function(t,n){var r=Math.expm1;t.exports=!r||r(10)>22025.465794806718||r(10)<22025.465794806718||-2e-17!=r(-2e-17)?function(t){return 0==(t=+t)?t:t>-1e-6&&t<1e-6?t+t*t/2:Math.exp(t)-1}:r},function(t,n){t.exports=Math.sign||function(t){return 0==(t=+t)||t!=t?t:t<0?-1:1}},function(t,n,r){var e=r(3),i=r(151).set,o=e.MutationObserver||e.WebKitMutationObserver,u=e.process,c=e.Promise,f="process"==r(45)(u);t.exports=function(){var t,n,r,a=function(){var e,i;for(f&&(e=u.domain)&&e.exit();t;){i=t.fn,t=t.next;try{i()}catch(e){throw t?r():n=void 0,e}}n=void 0,e&&e.enter()};if(f)r=function(){u.nextTick(a)};else if(o){var s=!0,l=document.createTextNode("");new o(a).observe(l,{characterData:!0}),r=function(){l.data=s=!s}}else if(c&&c.resolve){var h=c.resolve();r=function(){h.then(a)}}else r=function(){i.call(e,a)};return function(e){var i={fn:e,next:void 0};n&&(n.next=i),t||(t=i,r()),n=i}}},function(t,n,r){var e=r(6),i=r(2),o=function(t,n){if(i(t),!e(n)&&null!==n)throw TypeError(n+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,n,e){try{e=r(53)(Function.call,r(31).f(Object.prototype,"__proto__").set,2),e(t,[]),n=!(t instanceof Array)}catch(t){n=!0}return function(t,r){return o(t,r),n?t.__proto__=r:e(t,r),t}}({},!1):void 0),check:o}},function(t,n,r){var e=r(126)("keys"),i=r(76);t.exports=function(t){return e[t]||(e[t]=i(t))}},function(t,n,r){var e=r(2),i=r(26),o=r(7)("species");t.exports=function(t,n){var r,u=e(t).constructor;return void 0===u||void 0==(r=e(u)[o])?n:i(r)}},function(t,n,r){var e=r(67),i=r(46);t.exports=function(t){return function(n,r){var o,u,c=String(i(n)),f=e(r),a=c.length;return f<0||f>=a?t?"":void 0:(o=c.charCodeAt(f),o<55296||o>56319||f+1===a||(u=c.charCodeAt(f+1))<56320||u>57343?t?c.charAt(f):o:t?c.slice(f,f+2):u-56320+(o-55296<<10)+65536)}}},function(t,n,r){var e=r(122),i=r(46);t.exports=function(t,n,r){if(e(n))throw TypeError("String#"+r+" doesn't accept regex!");return String(i(t))}},function(t,n,r){"use strict";var e=r(67),i=r(46);t.exports=function(t){var n=String(i(this)),r="",o=e(t);if(o<0||o==1/0)throw RangeError("Count can't be negative");for(;o>0;(o>>>=1)&&(n+=n))1&o&&(r+=n);return r}},function(t,n){t.exports="\t\n\v\f\r   ᠎             　\u2028\u2029\ufeff"},function(t,n,r){var e,i,o,u=r(53),c=r(121),f=r(135),a=r(132),s=r(3),l=s.process,h=s.setImmediate,v=s.clearImmediate,p=s.MessageChannel,d=0,y={},g="onreadystatechange",b=function(){var t=+this;if(y.hasOwnProperty(t)){var n=y[t];delete y[t],n()}},m=function(t){b.call(t.data)};h&&v||(h=function(t){for(var n=[],r=1;arguments.length>r;)n.push(arguments[r++]);return y[++d]=function(){c("function"==typeof t?t:Function(t),n)},e(d),d},v=function(t){delete y[t]},"process"==r(45)(l)?e=function(t){l.nextTick(u(b,t,1))}:p?(i=new p,o=i.port2,i.port1.onmessage=m,e=u(o.postMessage,o,1)):s.addEventListener&&"function"==typeof postMessage&&!s.importScripts?(e=function(t){s.postMessage(t+"","*")},s.addEventListener("message",m,!1)):e=g in a("script")?function(t){f.appendChild(a("script"))[g]=function(){f.removeChild(this),b.call(t)}}:function(t){setTimeout(u(b,t,1),0)}),t.exports={set:h,clear:v}},function(t,n,r){"use strict";var e=r(3),i=r(10),o=r(69),u=r(127),c=r(27),f=r(73),a=r(4),s=r(68),l=r(67),h=r(16),v=r(71).f,p=r(11).f,d=r(130),y=r(81),g="ArrayBuffer",b="DataView",m="prototype",x="Wrong length!",w="Wrong index!",S=e[g],_=e[b],O=e.Math,E=e.RangeError,P=e.Infinity,j=S,F=O.abs,M=O.pow,A=O.floor,N=O.log,T=O.LN2,I="buffer",k="byteLength",L="byteOffset",R=i?"_b":I,C=i?"_l":k,D=i?"_o":L,U=function(t,n,r){var e,i,o,u=Array(r),c=8*r-n-1,f=(1<<c)-1,a=f>>1,s=23===n?M(2,-24)-M(2,-77):0,l=0,h=t<0||0===t&&1/t<0?1:0;for(t=F(t),t!=t||t===P?(i=t!=t?1:0,e=f):(e=A(N(t)/T),t*(o=M(2,-e))<1&&(e--,o*=2),t+=e+a>=1?s/o:s*M(2,1-a),t*o>=2&&(e++,o/=2),e+a>=f?(i=0,e=f):e+a>=1?(i=(t*o-1)*M(2,n),e+=a):(i=t*M(2,a-1)*M(2,n),e=0));n>=8;u[l++]=255&i,i/=256,n-=8);for(e=e<<n|i,c+=n;c>0;u[l++]=255&e,e/=256,c-=8);return u[--l]|=128*h,u},W=function(t,n,r){var e,i=8*r-n-1,o=(1<<i)-1,u=o>>1,c=i-7,f=r-1,a=t[f--],s=127&a;for(a>>=7;c>0;s=256*s+t[f],f--,c-=8);for(e=s&(1<<-c)-1,s>>=-c,c+=n;c>0;e=256*e+t[f],f--,c-=8);if(0===s)s=1-u;else{if(s===o)return e?NaN:a?-P:P;e+=M(2,n),s-=u}return(a?-1:1)*e*M(2,s-n)},G=function(t){return t[3]<<24|t[2]<<16|t[1]<<8|t[0]},B=function(t){return[255&t]},V=function(t){return[255&t,t>>8&255]},z=function(t){return[255&t,t>>8&255,t>>16&255,t>>24&255]},q=function(t){return U(t,52,8)},K=function(t){return U(t,23,4)},J=function(t,n,r){p(t[m],n,{get:function(){return this[r]}})},Y=function(t,n,r,e){var i=+r,o=l(i);if(i!=o||o<0||o+n>t[C])throw E(w);var u=t[R]._b,c=o+t[D],f=u.slice(c,c+n);return e?f:f.reverse()},H=function(t,n,r,e,i,o){var u=+r,c=l(u);if(u!=c||c<0||c+n>t[C])throw E(w);for(var f=t[R]._b,a=c+t[D],s=e(+i),h=0;h<n;h++)f[a+h]=s[o?h:n-h-1]},$=function(t,n){s(t,S,g);var r=+n,e=h(r);if(r!=e)throw E(x);return e};if(u.ABV){if(!a(function(){new S})||!a(function(){new S(.5)})){S=function(t){return new j($(this,t))};for(var X,Q=S[m]=j[m],Z=v(j),tt=0;Z.length>tt;)(X=Z[tt++])in S||c(S,X,j[X]);o||(Q.constructor=S)}var nt=new _(new S(2)),rt=_[m].setInt8;nt.setInt8(0,2147483648),nt.setInt8(1,2147483649),!nt.getInt8(0)&&nt.getInt8(1)||f(_[m],{setInt8:function(t,n){rt.call(this,t,n<<24>>24)},setUint8:function(t,n){rt.call(this,t,n<<24>>24)}},!0)}else S=function(t){var n=$(this,t);this._b=d.call(Array(n),0),this[C]=n},_=function(t,n,r){s(this,_,b),s(t,S,b);var e=t[C],i=l(n);if(i<0||i>e)throw E("Wrong offset!");if(r=void 0===r?e-i:h(r),i+r>e)throw E(x);this[R]=t,this[D]=i,this[C]=r},i&&(J(S,k,"_l"),J(_,I,"_b"),J(_,k,"_l"),J(_,L,"_o")),f(_[m],{getInt8:function(t){return Y(this,1,t)[0]<<24>>24},getUint8:function(t){return Y(this,1,t)[0]},getInt16:function(t){var n=Y(this,2,t,arguments[1]);return(n[1]<<8|n[0])<<16>>16},getUint16:function(t){var n=Y(this,2,t,arguments[1]);return n[1]<<8|n[0]},getInt32:function(t){return G(Y(this,4,t,arguments[1]))},getUint32:function(t){return G(Y(this,4,t,arguments[1]))>>>0},getFloat32:function(t){return W(Y(this,4,t,arguments[1]),23,4)},getFloat64:function(t){return W(Y(this,8,t,arguments[1]),52,8)},setInt8:function(t,n){H(this,1,t,B,n)},setUint8:function(t,n){H(this,1,t,B,n)},setInt16:function(t,n){H(this,2,t,V,n,arguments[2])},setUint16:function(t,n){H(this,2,t,V,n,arguments[2])},setInt32:function(t,n){H(this,4,t,z,n,arguments[2])},setUint32:function(t,n){H(this,4,t,z,n,arguments[2])},setFloat32:function(t,n){H(this,4,t,K,n,arguments[2])},setFloat64:function(t,n){H(this,8,t,q,n,arguments[2])}});y(S,g),y(_,b),c(_[m],u.VIEW,!0),n[g]=S,n[b]=_},function(t,n,r){var e=r(3),i=r(52),o=r(69),u=r(182),c=r(11).f;t.exports=function(t){var n=i.Symbol||(i.Symbol=o?{}:e.Symbol||{});"_"==t.charAt(0)||t in n||c(n,t,{value:u.f(t)})}},function(t,n,r){var e=r(114),i=r(7)("iterator"),o=r(80);t.exports=r(52).getIteratorMethod=function(t){if(void 0!=t)return t[i]||t["@@iterator"]||o[e(t)]}},function(t,n,r){"use strict";var e=r(78),i=r(170),o=r(80),u=r(30);t.exports=r(140)(Array,"Array",function(t,n){this._t=u(t),this._i=0,this._k=n},function(){var t=this._t,n=this._k,r=this._i++;return!t||r>=t.length?(this._t=void 0,i(1)):"keys"==n?i(0,r):"values"==n?i(0,t[r]):i(0,[r,t[r]])},"values"),o.Arguments=o.Array,e("keys"),e("values"),e("entries")},function(t,n){function r(t,n){t.classList?t.classList.add(n):t.className+=" "+n}t.exports=r},function(t,n){function r(t,n){if(t.classList)t.classList.remove(n);else{var r=new RegExp("(^|\\b)"+n.split(" ").join("|")+"(\\b|$)","gi");t.className=t.className.replace(r," ")}}t.exports=r},function(t,n){function r(){throw new Error("setTimeout has not been defined")}function e(){throw new Error("clearTimeout has not been defined")}function i(t){if(s===setTimeout)return setTimeout(t,0);if((s===r||!s)&&setTimeout)return s=setTimeout,setTimeout(t,0);try{return s(t,0)}catch(n){try{return s.call(null,t,0)}catch(n){return s.call(this,t,0)}}}function o(t){if(l===clearTimeout)return clearTimeout(t);if((l===e||!l)&&clearTimeout)return l=clearTimeout,clearTimeout(t);try{return l(t)}catch(n){try{return l.call(null,t)}catch(n){return l.call(this,t)}}}function u(){d&&v&&(d=!1,v.length?p=v.concat(p):y=-1,p.length&&c())}function c(){if(!d){var t=i(u);d=!0;for(var n=p.length;n;){for(v=p,p=[];++y<n;)v&&v[y].run();y=-1,n=p.length}v=null,d=!1,o(t)}}function f(t,n){this.fun=t,this.array=n}function a(){}var s,l,h=t.exports={};!function(){try{s="function"==typeof setTimeout?setTimeout:r}catch(t){s=r}try{l="function"==typeof clearTimeout?clearTimeout:e}catch(t){l=e}}();var v,p=[],d=!1,y=-1;h.nextTick=function(t){var n=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)n[r-1]=arguments[r];p.push(new f(t,n)),1!==p.length||d||i(c)},f.prototype.run=function(){this.fun.apply(null,this.array)},h.title="browser",h.browser=!0,h.env={},h.argv=[],h.version="",h.versions={},h.on=a,h.addListener=a,h.once=a,h.off=a,h.removeListener=a,h.removeAllListeners=a,h.emit=a,h.prependListener=a,h.prependOnceListener=a,h.listeners=function(t){return[]},h.binding=function(t){throw new Error("process.binding is not supported")},h.cwd=function(){return"/"},h.chdir=function(t){throw new Error("process.chdir is not supported")},h.umask=function(){return 0}},function(t,n,r){var e=r(45);t.exports=function(t,n){if("number"!=typeof t&&"Number"!=e(t))throw TypeError(n);return+t}},function(t,n,r){"use strict";var e=r(17),i=r(75),o=r(16);t.exports=[].copyWithin||function(t,n){var r=e(this),u=o(r.length),c=i(t,u),f=i(n,u),a=arguments.length>2?arguments[2]:void 0,s=Math.min((void 0===a?u:i(a,u))-f,u-c),l=1;for(f<c&&c<f+s&&(l=-1,f+=s-1,c+=s-1);s-- >0;)f in r?r[c]=r[f]:delete r[c],c+=l,f+=l;return r}},function(t,n,r){var e=r(79);t.exports=function(t,n){var r=[];return e(t,!1,r.push,r,n),r}},function(t,n,r){var e=r(26),i=r(17),o=r(115),u=r(16);t.exports=function(t,n,r,c,f){e(n);var a=i(t),s=o(a),l=u(a.length),h=f?l-1:0,v=f?-1:1;if(r<2)for(;;){if(h in s){c=s[h],h+=v;break}if(h+=v,f?h<0:l<=h)throw TypeError("Reduce of empty array with no initial value")}for(;f?h>=0:l>h;h+=v)h in s&&(c=n(c,s[h],h,a));return c}},function(t,n,r){"use strict";var e=r(26),i=r(6),o=r(121),u=[].slice,c={},f=function(t,n,r){if(!(n in c)){for(var e=[],i=0;i<n;i++)e[i]="a["+i+"]";c[n]=Function("F,a","return new F("+e.join(",")+")")}return c[n](t,r)};t.exports=Function.bind||function(t){var n=e(this),r=u.call(arguments,1),c=function(){var e=r.concat(u.call(arguments));return this instanceof c?f(n,e.length,e):o(n,e,t)};return i(n.prototype)&&(c.prototype=n.prototype),c}},function(t,n,r){"use strict";var e=r(11).f,i=r(70),o=r(73),u=r(53),c=r(68),f=r(46),a=r(79),s=r(140),l=r(170),h=r(74),v=r(10),p=r(65).fastKey,d=v?"_s":"size",y=function(t,n){var r,e=p(n);if("F"!==e)return t._i[e];for(r=t._f;r;r=r.n)if(r.k==n)return r};t.exports={getConstructor:function(t,n,r,s){var l=t(function(t,e){c(t,l,n,"_i"),t._i=i(null),t._f=void 0,t._l=void 0,t[d]=0,void 0!=e&&a(e,r,t[s],t)});return o(l.prototype,{clear:function(){for(var t=this,n=t._i,r=t._f;r;r=r.n)r.r=!0,r.p&&(r.p=r.p.n=void 0),delete n[r.i];t._f=t._l=void 0,t[d]=0},delete:function(t){var n=this,r=y(n,t);if(r){var e=r.n,i=r.p;delete n._i[r.i],r.r=!0,i&&(i.n=e),e&&(e.p=i),n._f==r&&(n._f=e),n._l==r&&(n._l=i),n[d]--}return!!r},forEach:function(t){c(this,l,"forEach");for(var n,r=u(t,arguments.length>1?arguments[1]:void 0,3);n=n?n.n:this._f;)for(r(n.v,n.k,this);n&&n.r;)n=n.p},has:function(t){return!!y(this,t)}}),v&&e(l.prototype,"size",{get:function(){return f(this[d])}}),l},def:function(t,n,r){var e,i,o=y(t,n);return o?o.v=r:(t._l=o={i:i=p(n,!0),k:n,v:r,p:e=t._l,n:void 0,r:!1},t._f||(t._f=o),e&&(e.n=o),t[d]++,"F"!==i&&(t._i[i]=o)),t},getEntry:y,setStrong:function(t,n,r){s(t,n,function(t,n){this._t=t,this._k=n,this._l=void 0},function(){for(var t=this,n=t._k,r=t._l;r&&r.r;)r=r.p;return t._t&&(t._l=r=r?r.n:t._t._f)?"keys"==n?l(0,r.k):"values"==n?l(0,r.v):l(0,[r.k,r.v]):(t._t=void 0,l(1))},r?"entries":"values",!r,!0),h(n)}}},function(t,n,r){var e=r(114),i=r(161);t.exports=function(t){return function(){if(e(this)!=t)throw TypeError(t+"#toJSON isn't generic");return i(this)}}},function(t,n,r){"use strict";var e=r(73),i=r(65).getWeak,o=r(2),u=r(6),c=r(68),f=r(79),a=r(48),s=r(24),l=a(5),h=a(6),v=0,p=function(t){return t._l||(t._l=new d)},d=function(){this.a=[]},y=function(t,n){return l(t.a,function(t){return t[0]===n})};d.prototype={get:function(t){var n=y(this,t);if(n)return n[1]},has:function(t){return!!y(this,t)},set:function(t,n){var r=y(this,t);r?r[1]=n:this.a.push([t,n])},delete:function(t){var n=h(this.a,function(n){return n[0]===t});return~n&&this.a.splice(n,1),!!~n}},t.exports={getConstructor:function(t,n,r,o){var a=t(function(t,e){c(t,a,n,"_i"),t._i=v++,t._l=void 0,void 0!=e&&f(e,r,t[o],t)});return e(a.prototype,{delete:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).delete(t):n&&s(n,this._i)&&delete n[this._i]},has:function(t){if(!u(t))return!1;var n=i(t);return!0===n?p(this).has(t):n&&s(n,this._i)}}),a},def:function(t,n,r){var e=i(o(n),!0);return!0===e?p(t).set(n,r):e[t._i]=r,t},ufstore:p}},function(t,n,r){t.exports=!r(10)&&!r(4)(function(){return 7!=Object.defineProperty(r(132)("div"),"a",{get:function(){return 7}}).a})},function(t,n,r){var e=r(6),i=Math.floor;t.exports=function(t){return!e(t)&&isFinite(t)&&i(t)===t}},function(t,n,r){var e=r(2);t.exports=function(t,n,r,i){try{return i?n(e(r)[0],r[1]):n(r)}catch(n){var o=t.return;throw void 0!==o&&e(o.call(t)),n}}},function(t,n){t.exports=function(t,n){return{value:n,done:!!t}}},function(t,n){t.exports=Math.log1p||function(t){return(t=+t)>-1e-8&&t<1e-8?t-t*t/2:Math.log(1+t)}},function(t,n,r){"use strict";var e=r(72),i=r(125),o=r(116),u=r(17),c=r(115),f=Object.assign;t.exports=!f||r(4)(function(){var t={},n={},r=Symbol(),e="abcdefghijklmnopqrst";return t[r]=7,e.split("").forEach(function(t){n[t]=t}),7!=f({},t)[r]||Object.keys(f({},n)).join("")!=e})?function(t,n){for(var r=u(t),f=arguments.length,a=1,s=i.f,l=o.f;f>a;)for(var h,v=c(arguments[a++]),p=s?e(v).concat(s(v)):e(v),d=p.length,y=0;d>y;)l.call(v,h=p[y++])&&(r[h]=v[h]);return r}:f},function(t,n,r){var e=r(11),i=r(2),o=r(72);t.exports=r(10)?Object.defineProperties:function(t,n){i(t);for(var r,u=o(n),c=u.length,f=0;c>f;)e.f(t,r=u[f++],n[r]);return t}},function(t,n,r){var e=r(30),i=r(71).f,o={}.toString,u="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],c=function(t){try{return i(t)}catch(t){return u.slice()}};t.exports.f=function(t){return u&&"[object Window]"==o.call(t)?c(t):i(e(t))}},function(t,n,r){var e=r(24),i=r(30),o=r(117)(!1),u=r(145)("IE_PROTO");t.exports=function(t,n){var r,c=i(t),f=0,a=[];for(r in c)r!=u&&e(c,r)&&a.push(r);for(;n.length>f;)e(c,r=n[f++])&&(~o(a,r)||a.push(r));return a}},function(t,n,r){var e=r(72),i=r(30),o=r(116).f;t.exports=function(t){return function(n){for(var r,u=i(n),c=e(u),f=c.length,a=0,s=[];f>a;)o.call(u,r=c[a++])&&s.push(t?[r,u[r]]:u[r]);return s}}},function(t,n,r){var e=r(71),i=r(125),o=r(2),u=r(3).Reflect;t.exports=u&&u.ownKeys||function(t){var n=e.f(o(t)),r=i.f;return r?n.concat(r(t)):n}},function(t,n,r){var e=r(3).parseFloat,i=r(82).trim;t.exports=1/e(r(150)+"-0")!=-1/0?function(t){var n=i(String(t),3),r=e(n);return 0===r&&"-"==n.charAt(0)?-0:r}:e},function(t,n,r){var e=r(3).parseInt,i=r(82).trim,o=r(150),u=/^[\-+]?0[xX]/;t.exports=8!==e(o+"08")||22!==e(o+"0x16")?function(t,n){var r=i(String(t),3);return e(r,n>>>0||(u.test(r)?16:10))}:e},function(t,n){t.exports=Object.is||function(t,n){return t===n?0!==t||1/t==1/n:t!=t&&n!=n}},function(t,n,r){var e=r(16),i=r(149),o=r(46);t.exports=function(t,n,r,u){var c=String(o(t)),f=c.length,a=void 0===r?" ":String(r),s=e(n);if(s<=f||""==a)return c;var l=s-f,h=i.call(a,Math.ceil(l/a.length));return h.length>l&&(h=h.slice(0,l)),u?h+c:c+h}},function(t,n,r){n.f=r(7)},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Map",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{get:function(t){var n=e.getEntry(this,t);return n&&n.v},set:function(t,n){return e.def(this,0===t?0:t,n)}},e,!0)},function(t,n,r){r(10)&&"g"!=/./g.flags&&r(11).f(RegExp.prototype,"flags",{configurable:!0,get:r(120)})},function(t,n,r){"use strict";var e=r(164);t.exports=r(118)("Set",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t=0===t?0:t,t)}},e)},function(t,n,r){"use strict";var e,i=r(48)(0),o=r(28),u=r(65),c=r(172),f=r(166),a=r(6),s=u.getWeak,l=Object.isExtensible,h=f.ufstore,v={},p=function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},d={get:function(t){if(a(t)){var n=s(t);return!0===n?h(this).get(t):n?n[this._i]:void 0}},set:function(t,n){return f.def(this,t,n)}},y=t.exports=r(118)("WeakMap",p,d,f,!0,!0);7!=(new y).set((Object.freeze||Object)(v),7).get(v)&&(e=f.getConstructor(p),c(e.prototype,d),u.NEED=!0,i(["delete","has","get","set"],function(t){var n=y.prototype,r=n[t];o(n,t,function(n,i){if(a(n)&&!l(n)){this._f||(this._f=new e);var o=this._f[t](n,i);return"set"==t?this:o}return r.call(this,n,i)})}))},,,,function(t,n){"use strict";function r(){var t=document.querySelector("#page-nav");if(t&&!document.querySelector("#page-nav .extend.prev")&&(t.innerHTML='<a class="extend prev disabled" rel="prev">&laquo; Prev</a>'+t.innerHTML),t&&!document.querySelector("#page-nav .extend.next")&&(t.innerHTML=t.innerHTML+'<a class="extend next disabled" rel="next">Next &raquo;</a>'),yiliaConfig&&yiliaConfig.open_in_new){document.querySelectorAll(".article-entry a:not(.article-more-a)").forEach(function(t){var n=t.getAttribute("target");n&&""!==n||t.setAttribute("target","_blank")})}if(yiliaConfig&&yiliaConfig.toc_hide_index){document.querySelectorAll(".toc-number").forEach(function(t){t.style.display="none"})}var n=document.querySelector("#js-aboutme");n&&0!==n.length&&(n.innerHTML=n.innerText)}t.exports={init:r}},function(t,n,r){"use strict";function e(t){return t&&t.__esModule?t:{default:t}}function i(t,n){var r=/\/|index.html/g;return t.replace(r,"")===n.replace(r,"")}function o(){for(var t=document.querySelectorAll(".js-header-menu li a"),n=window.location.pathname,r=0,e=t.length;r<e;r++){var o=t[r];i(n,o.getAttribute("href"))&&(0,h.default)(o,"active")}}function u(t){for(var n=t.offsetLeft,r=t.offsetParent;null!==r;)n+=r.offsetLeft,r=r.offsetParent;return n}function c(t){for(var n=t.offsetTop,r=t.offsetParent;null!==r;)n+=r.offsetTop,r=r.offsetParent;return n}function f(t,n,r,e,i){var o=u(t),f=c(t)-n;if(f-r<=i){var a=t.$newDom;a||(a=t.cloneNode(!0),(0,d.default)(t,a),t.$newDom=a,a.style.position="fixed",a.style.top=(r||f)+"px",a.style.left=o+"px",a.style.zIndex=e||2,a.style.width="100%",a.style.color="#fff"),a.style.visibility="visible",t.style.visibility="hidden"}else{t.style.visibility="visible";var s=t.$newDom;s&&(s.style.visibility="hidden")}}function a(){var t=document.querySelector(".js-overlay"),n=document.querySelector(".js-header-menu");f(t,document.body.scrollTop,-63,2,0),f(n,document.body.scrollTop,1,3,0)}function s(){document.querySelector("#container").addEventListener("scroll",function(t){a()}),window.addEventListener("scroll",function(t){a()}),a()}var l=r(156),h=e(l),v=r(157),p=(e(v),r(382)),d=e(p),y=r(128),g=e(y),b=r(190),m=e(b),x=r(129);(function(){g.default.versions.mobile&&window.screen.width<800&&(o(),s())})(),(0,x.addLoadEvent)(function(){m.default.init()}),t.exports={}},,,,function(t,n,r){(function(t){"use strict";function n(t,n,r){t[n]||Object[e](t,n,{writable:!0,configurable:!0,value:r})}if(r(381),r(391),r(198),t._babelPolyfill)throw new Error("only one instance of babel-polyfill is allowed");t._babelPolyfill=!0;var e="defineProperty";n(String.prototype,"padLeft","".padStart),n(String.prototype,"padRight","".padEnd),"pop,reverse,shift,keys,values,entries,indexOf,every,some,forEach,map,filter,find,findIndex,includes,join,slice,concat,push,splice,unshift,sort,lastIndexOf,reduce,reduceRight,copyWithin,fill".split(",").forEach(function(t){[][t]&&n(Array,t,Function.call.bind([][t]))})}).call(n,function(){return this}())},,,function(t,n,r){r(210),t.exports=r(52).RegExp.escape},,,,function(t,n,r){var e=r(6),i=r(138),o=r(7)("species");t.exports=function(t){var n;return i(t)&&(n=t.constructor,"function"!=typeof n||n!==Array&&!i(n.prototype)||(n=void 0),e(n)&&null===(n=n[o])&&(n=void 0)),void 0===n?Array:n}},function(t,n,r){var e=r(202);t.exports=function(t,n){return new(e(t))(n)}},function(t,n,r){"use strict";var e=r(2),i=r(50),o="number";t.exports=function(t){if("string"!==t&&t!==o&&"default"!==t)throw TypeError("Incorrect hint");return i(e(this),t!=o)}},function(t,n,r){var e=r(72),i=r(125),o=r(116);t.exports=function(t){var n=e(t),r=i.f;if(r)for(var u,c=r(t),f=o.f,a=0;c.length>a;)f.call(t,u=c[a++])&&n.push(u);return n}},function(t,n,r){var e=r(72),i=r(30);t.exports=function(t,n){for(var r,o=i(t),u=e(o),c=u.length,f=0;c>f;)if(o[r=u[f++]]===n)return r}},function(t,n,r){"use strict";var e=r(208),i=r(121),o=r(26);t.exports=function(){for(var t=o(this),n=arguments.length,r=Array(n),u=0,c=e._,f=!1;n>u;)(r[u]=arguments[u++])===c&&(f=!0);return function(){var e,o=this,u=arguments.length,a=0,s=0;if(!f&&!u)return i(t,r,o);if(e=r.slice(),f)for(;n>a;a++)e[a]===c&&(e[a]=arguments[s++]);for(;u>s;)e.push(arguments[s++]);return i(t,e,o)}}},function(t,n,r){t.exports=r(3)},function(t,n){t.exports=function(t,n){var r=n===Object(n)?function(t){return n[t]}:n;return function(n){return String(n).replace(t,r)}}},function(t,n,r){var e=r(1),i=r(209)(/[\\^$*+?.()|[\]{}]/g,"\\$&");e(e.S,"RegExp",{escape:function(t){return i(t)}})},function(t,n,r){var e=r(1);e(e.P,"Array",{copyWithin:r(160)}),r(78)("copyWithin")},function(t,n,r){"use strict";var e=r(1),i=r(48)(4);e(e.P+e.F*!r(47)([].every,!0),"Array",{every:function(t){return i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.P,"Array",{fill:r(130)}),r(78)("fill")},function(t,n,r){"use strict";var e=r(1),i=r(48)(2);e(e.P+e.F*!r(47)([].filter,!0),"Array",{filter:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(6),o="findIndex",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{findIndex:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(5),o="find",u=!0;o in[]&&Array(1)[o](function(){u=!1}),e(e.P+e.F*u,"Array",{find:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)(o)},function(t,n,r){"use strict";var e=r(1),i=r(48)(0),o=r(47)([].forEach,!0);e(e.P+e.F*!o,"Array",{forEach:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(53),i=r(1),o=r(17),u=r(169),c=r(137),f=r(16),a=r(131),s=r(154);i(i.S+i.F*!r(123)(function(t){Array.from(t)}),"Array",{from:function(t){var n,r,i,l,h=o(t),v="function"==typeof this?this:Array,p=arguments.length,d=p>1?arguments[1]:void 0,y=void 0!==d,g=0,b=s(h);if(y&&(d=e(d,p>2?arguments[2]:void 0,2)),void 0==b||v==Array&&c(b))for(n=f(h.length),r=new v(n);n>g;g++)a(r,g,y?d(h[g],g):h[g]);else for(l=b.call(h),r=new v;!(i=l.next()).done;g++)a(r,g,y?u(l,d,[i.value,g],!0):i.value);return r.length=g,r}})},function(t,n,r){"use strict";var e=r(1),i=r(117)(!1),o=[].indexOf,u=!!o&&1/[1].indexOf(1,-0)<0;e(e.P+e.F*(u||!r(47)(o)),"Array",{indexOf:function(t){return u?o.apply(this,arguments)||0:i(this,t,arguments[1])}})},function(t,n,r){var e=r(1);e(e.S,"Array",{isArray:r(138)})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=[].join;e(e.P+e.F*(r(115)!=Object||!r(47)(o)),"Array",{join:function(t){return o.call(i(this),void 0===t?",":t)}})},function(t,n,r){"use strict";var e=r(1),i=r(30),o=r(67),u=r(16),c=[].lastIndexOf,f=!!c&&1/[1].lastIndexOf(1,-0)<0;e(e.P+e.F*(f||!r(47)(c)),"Array",{lastIndexOf:function(t){if(f)return c.apply(this,arguments)||0;var n=i(this),r=u(n.length),e=r-1;for(arguments.length>1&&(e=Math.min(e,o(arguments[1]))),e<0&&(e=r+e);e>=0;e--)if(e in n&&n[e]===t)return e||0;return-1}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(1);e(e.P+e.F*!r(47)([].map,!0),"Array",{map:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(131);e(e.S+e.F*r(4)(function(){function t(){}return!(Array.of.call(t)instanceof t)}),"Array",{of:function(){for(var t=0,n=arguments.length,r=new("function"==typeof this?this:Array)(n);n>t;)i(r,t,arguments[t++]);return r.length=n,r}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduceRight,!0),"Array",{reduceRight:function(t){return i(this,t,arguments.length,arguments[1],!0)}})},function(t,n,r){"use strict";var e=r(1),i=r(162);e(e.P+e.F*!r(47)([].reduce,!0),"Array",{reduce:function(t){return i(this,t,arguments.length,arguments[1],!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(135),o=r(45),u=r(75),c=r(16),f=[].slice;e(e.P+e.F*r(4)(function(){i&&f.call(i)}),"Array",{slice:function(t,n){var r=c(this.length),e=o(this);if(n=void 0===n?r:n,"Array"==e)return f.call(this,t,n);for(var i=u(t,r),a=u(n,r),s=c(a-i),l=Array(s),h=0;h<s;h++)l[h]="String"==e?this.charAt(i+h):this[i+h];return l}})},function(t,n,r){"use strict";var e=r(1),i=r(48)(3);e(e.P+e.F*!r(47)([].some,!0),"Array",{some:function(t){return i(this,t,arguments[1])}})},function(t,n,r){"use strict";var e=r(1),i=r(26),o=r(17),u=r(4),c=[].sort,f=[1,2,3];e(e.P+e.F*(u(function(){f.sort(void 0)})||!u(function(){f.sort(null)})||!r(47)(c)),"Array",{sort:function(t){return void 0===t?c.call(o(this)):c.call(o(this),i(t))}})},function(t,n,r){r(74)("Array")},function(t,n,r){var e=r(1);e(e.S,"Date",{now:function(){return(new Date).getTime()}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=Date.prototype.getTime,u=function(t){return t>9?t:"0"+t};e(e.P+e.F*(i(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!i(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){
if(!isFinite(o.call(this)))throw RangeError("Invalid time value");var t=this,n=t.getUTCFullYear(),r=t.getUTCMilliseconds(),e=n<0?"-":n>9999?"+":"";return e+("00000"+Math.abs(n)).slice(e?-6:-4)+"-"+u(t.getUTCMonth()+1)+"-"+u(t.getUTCDate())+"T"+u(t.getUTCHours())+":"+u(t.getUTCMinutes())+":"+u(t.getUTCSeconds())+"."+(r>99?r:"0"+u(r))+"Z"}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50);e(e.P+e.F*r(4)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(t){var n=i(this),r=o(n);return"number"!=typeof r||isFinite(r)?n.toISOString():null}})},function(t,n,r){var e=r(7)("toPrimitive"),i=Date.prototype;e in i||r(27)(i,e,r(204))},function(t,n,r){var e=Date.prototype,i="Invalid Date",o="toString",u=e[o],c=e.getTime;new Date(NaN)+""!=i&&r(28)(e,o,function(){var t=c.call(this);return t===t?u.call(this):i})},function(t,n,r){var e=r(1);e(e.P,"Function",{bind:r(163)})},function(t,n,r){"use strict";var e=r(6),i=r(32),o=r(7)("hasInstance"),u=Function.prototype;o in u||r(11).f(u,o,{value:function(t){if("function"!=typeof this||!e(t))return!1;if(!e(this.prototype))return t instanceof this;for(;t=i(t);)if(this.prototype===t)return!0;return!1}})},function(t,n,r){var e=r(11).f,i=r(66),o=r(24),u=Function.prototype,c="name",f=Object.isExtensible||function(){return!0};c in u||r(10)&&e(u,c,{configurable:!0,get:function(){try{var t=this,n=(""+t).match(/^\s*function ([^ (]*)/)[1];return o(t,c)||!f(t)||e(t,c,i(5,n)),n}catch(t){return""}}})},function(t,n,r){var e=r(1),i=r(171),o=Math.sqrt,u=Math.acosh;e(e.S+e.F*!(u&&710==Math.floor(u(Number.MAX_VALUE))&&u(1/0)==1/0),"Math",{acosh:function(t){return(t=+t)<1?NaN:t>94906265.62425156?Math.log(t)+Math.LN2:i(t-1+o(t-1)*o(t+1))}})},function(t,n,r){function e(t){return isFinite(t=+t)&&0!=t?t<0?-e(-t):Math.log(t+Math.sqrt(t*t+1)):t}var i=r(1),o=Math.asinh;i(i.S+i.F*!(o&&1/o(0)>0),"Math",{asinh:e})},function(t,n,r){var e=r(1),i=Math.atanh;e(e.S+e.F*!(i&&1/i(-0)<0),"Math",{atanh:function(t){return 0==(t=+t)?t:Math.log((1+t)/(1-t))/2}})},function(t,n,r){var e=r(1),i=r(142);e(e.S,"Math",{cbrt:function(t){return i(t=+t)*Math.pow(Math.abs(t),1/3)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{clz32:function(t){return(t>>>=0)?31-Math.floor(Math.log(t+.5)*Math.LOG2E):32}})},function(t,n,r){var e=r(1),i=Math.exp;e(e.S,"Math",{cosh:function(t){return(i(t=+t)+i(-t))/2}})},function(t,n,r){var e=r(1),i=r(141);e(e.S+e.F*(i!=Math.expm1),"Math",{expm1:i})},function(t,n,r){var e=r(1),i=r(142),o=Math.pow,u=o(2,-52),c=o(2,-23),f=o(2,127)*(2-c),a=o(2,-126),s=function(t){return t+1/u-1/u};e(e.S,"Math",{fround:function(t){var n,r,e=Math.abs(t),o=i(t);return e<a?o*s(e/a/c)*a*c:(n=(1+c/u)*e,r=n-(n-e),r>f||r!=r?o*(1/0):o*r)}})},function(t,n,r){var e=r(1),i=Math.abs;e(e.S,"Math",{hypot:function(t,n){for(var r,e,o=0,u=0,c=arguments.length,f=0;u<c;)r=i(arguments[u++]),f<r?(e=f/r,o=o*e*e+1,f=r):r>0?(e=r/f,o+=e*e):o+=r;return f===1/0?1/0:f*Math.sqrt(o)}})},function(t,n,r){var e=r(1),i=Math.imul;e(e.S+e.F*r(4)(function(){return-5!=i(4294967295,5)||2!=i.length}),"Math",{imul:function(t,n){var r=65535,e=+t,i=+n,o=r&e,u=r&i;return 0|o*u+((r&e>>>16)*u+o*(r&i>>>16)<<16>>>0)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log10:function(t){return Math.log(t)/Math.LN10}})},function(t,n,r){var e=r(1);e(e.S,"Math",{log1p:r(171)})},function(t,n,r){var e=r(1);e(e.S,"Math",{log2:function(t){return Math.log(t)/Math.LN2}})},function(t,n,r){var e=r(1);e(e.S,"Math",{sign:r(142)})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S+e.F*r(4)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(t){return Math.abs(t=+t)<1?(i(t)-i(-t))/2:(o(t-1)-o(-t-1))*(Math.E/2)}})},function(t,n,r){var e=r(1),i=r(141),o=Math.exp;e(e.S,"Math",{tanh:function(t){var n=i(t=+t),r=i(-t);return n==1/0?1:r==1/0?-1:(n-r)/(o(t)+o(-t))}})},function(t,n,r){var e=r(1);e(e.S,"Math",{trunc:function(t){return(t>0?Math.floor:Math.ceil)(t)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(45),u=r(136),c=r(50),f=r(4),a=r(71).f,s=r(31).f,l=r(11).f,h=r(82).trim,v="Number",p=e[v],d=p,y=p.prototype,g=o(r(70)(y))==v,b="trim"in String.prototype,m=function(t){var n=c(t,!1);if("string"==typeof n&&n.length>2){n=b?n.trim():h(n,3);var r,e,i,o=n.charCodeAt(0);if(43===o||45===o){if(88===(r=n.charCodeAt(2))||120===r)return NaN}else if(48===o){switch(n.charCodeAt(1)){case 66:case 98:e=2,i=49;break;case 79:case 111:e=8,i=55;break;default:return+n}for(var u,f=n.slice(2),a=0,s=f.length;a<s;a++)if((u=f.charCodeAt(a))<48||u>i)return NaN;return parseInt(f,e)}}return+n};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(t){var n=arguments.length<1?0:t,r=this;return r instanceof p&&(g?f(function(){y.valueOf.call(r)}):o(r)!=v)?u(new d(m(n)),r,p):m(n)};for(var x,w=r(10)?a(d):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),S=0;w.length>S;S++)i(d,x=w[S])&&!i(p,x)&&l(p,x,s(d,x));p.prototype=y,y.constructor=p,r(28)(e,v,p)}},function(t,n,r){var e=r(1);e(e.S,"Number",{EPSILON:Math.pow(2,-52)})},function(t,n,r){var e=r(1),i=r(3).isFinite;e(e.S,"Number",{isFinite:function(t){return"number"==typeof t&&i(t)}})},function(t,n,r){var e=r(1);e(e.S,"Number",{isInteger:r(168)})},function(t,n,r){var e=r(1);e(e.S,"Number",{isNaN:function(t){return t!=t}})},function(t,n,r){var e=r(1),i=r(168),o=Math.abs;e(e.S,"Number",{isSafeInteger:function(t){return i(t)&&o(t)<=9007199254740991}})},function(t,n,r){var e=r(1);e(e.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(t,n,r){var e=r(1);e(e.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(t,n,r){var e=r(1),i=r(178);e(e.S+e.F*(Number.parseFloat!=i),"Number",{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.S+e.F*(Number.parseInt!=i),"Number",{parseInt:i})},function(t,n,r){"use strict";var e=r(1),i=r(67),o=r(159),u=r(149),c=1..toFixed,f=Math.floor,a=[0,0,0,0,0,0],s="Number.toFixed: incorrect invocation!",l="0",h=function(t,n){for(var r=-1,e=n;++r<6;)e+=t*a[r],a[r]=e%1e7,e=f(e/1e7)},v=function(t){for(var n=6,r=0;--n>=0;)r+=a[n],a[n]=f(r/t),r=r%t*1e7},p=function(){for(var t=6,n="";--t>=0;)if(""!==n||0===t||0!==a[t]){var r=String(a[t]);n=""===n?r:n+u.call(l,7-r.length)+r}return n},d=function(t,n,r){return 0===n?r:n%2==1?d(t,n-1,r*t):d(t*t,n/2,r)},y=function(t){for(var n=0,r=t;r>=4096;)n+=12,r/=4096;for(;r>=2;)n+=1,r/=2;return n};e(e.P+e.F*(!!c&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!r(4)(function(){c.call({})})),"Number",{toFixed:function(t){var n,r,e,c,f=o(this,s),a=i(t),g="",b=l;if(a<0||a>20)throw RangeError(s);if(f!=f)return"NaN";if(f<=-1e21||f>=1e21)return String(f);if(f<0&&(g="-",f=-f),f>1e-21)if(n=y(f*d(2,69,1))-69,r=n<0?f*d(2,-n,1):f/d(2,n,1),r*=4503599627370496,(n=52-n)>0){for(h(0,r),e=a;e>=7;)h(1e7,0),e-=7;for(h(d(10,e,1),0),e=n-1;e>=23;)v(1<<23),e-=23;v(1<<e),h(1,1),v(2),b=p()}else h(0,r),h(1<<-n,0),b=p()+u.call(l,a);return a>0?(c=b.length,b=g+(c<=a?"0."+u.call(l,a-c)+b:b.slice(0,c-a)+"."+b.slice(c-a))):b=g+b,b}})},function(t,n,r){"use strict";var e=r(1),i=r(4),o=r(159),u=1..toPrecision;e(e.P+e.F*(i(function(){return"1"!==u.call(1,void 0)})||!i(function(){u.call({})})),"Number",{toPrecision:function(t){var n=o(this,"Number#toPrecision: incorrect invocation!");return void 0===t?u.call(n):u.call(n,t)}})},function(t,n,r){var e=r(1);e(e.S+e.F,"Object",{assign:r(172)})},function(t,n,r){var e=r(1);e(e.S,"Object",{create:r(70)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperties:r(173)})},function(t,n,r){var e=r(1);e(e.S+e.F*!r(10),"Object",{defineProperty:r(11).f})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("freeze",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(30),i=r(31).f;r(49)("getOwnPropertyDescriptor",function(){return function(t,n){return i(e(t),n)}})},function(t,n,r){r(49)("getOwnPropertyNames",function(){return r(174).f})},function(t,n,r){var e=r(17),i=r(32);r(49)("getPrototypeOf",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6);r(49)("isExtensible",function(t){return function(n){return!!e(n)&&(!t||t(n))}})},function(t,n,r){var e=r(6);r(49)("isFrozen",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(6);r(49)("isSealed",function(t){return function(n){return!e(n)||!!t&&t(n)}})},function(t,n,r){var e=r(1);e(e.S,"Object",{is:r(180)})},function(t,n,r){var e=r(17),i=r(72);r(49)("keys",function(){return function(t){return i(e(t))}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("preventExtensions",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(6),i=r(65).onFreeze;r(49)("seal",function(t){return function(n){return t&&e(n)?t(i(n)):n}})},function(t,n,r){var e=r(1);e(e.S,"Object",{setPrototypeOf:r(144).set})},function(t,n,r){"use strict";var e=r(114),i={};i[r(7)("toStringTag")]="z",i+""!="[object z]"&&r(28)(Object.prototype,"toString",function(){return"[object "+e(this)+"]"},!0)},function(t,n,r){var e=r(1),i=r(178);e(e.G+e.F*(parseFloat!=i),{parseFloat:i})},function(t,n,r){var e=r(1),i=r(179);e(e.G+e.F*(parseInt!=i),{parseInt:i})},function(t,n,r){"use strict";var e,i,o,u=r(69),c=r(3),f=r(53),a=r(114),s=r(1),l=r(6),h=r(26),v=r(68),p=r(79),d=r(146),y=r(151).set,g=r(143)(),b="Promise",m=c.TypeError,x=c.process,w=c[b],x=c.process,S="process"==a(x),_=function(){},O=!!function(){try{var t=w.resolve(1),n=(t.constructor={})[r(7)("species")]=function(t){t(_,_)};return(S||"function"==typeof PromiseRejectionEvent)&&t.then(_)instanceof n}catch(t){}}(),E=function(t,n){return t===n||t===w&&n===o},P=function(t){var n;return!(!l(t)||"function"!=typeof(n=t.then))&&n},j=function(t){return E(w,t)?new F(t):new i(t)},F=i=function(t){var n,r;this.promise=new t(function(t,e){if(void 0!==n||void 0!==r)throw m("Bad Promise constructor");n=t,r=e}),this.resolve=h(n),this.reject=h(r)},M=function(t){try{t()}catch(t){return{error:t}}},A=function(t,n){if(!t._n){t._n=!0;var r=t._c;g(function(){for(var e=t._v,i=1==t._s,o=0;r.length>o;)!function(n){var r,o,u=i?n.ok:n.fail,c=n.resolve,f=n.reject,a=n.domain;try{u?(i||(2==t._h&&I(t),t._h=1),!0===u?r=e:(a&&a.enter(),r=u(e),a&&a.exit()),r===n.promise?f(m("Promise-chain cycle")):(o=P(r))?o.call(r,c,f):c(r)):f(e)}catch(t){f(t)}}(r[o++]);t._c=[],t._n=!1,n&&!t._h&&N(t)})}},N=function(t){y.call(c,function(){var n,r,e,i=t._v;if(T(t)&&(n=M(function(){S?x.emit("unhandledRejection",i,t):(r=c.onunhandledrejection)?r({promise:t,reason:i}):(e=c.console)&&e.error&&e.error("Unhandled promise rejection",i)}),t._h=S||T(t)?2:1),t._a=void 0,n)throw n.error})},T=function(t){if(1==t._h)return!1;for(var n,r=t._a||t._c,e=0;r.length>e;)if(n=r[e++],n.fail||!T(n.promise))return!1;return!0},I=function(t){y.call(c,function(){var n;S?x.emit("rejectionHandled",t):(n=c.onrejectionhandled)&&n({promise:t,reason:t._v})})},k=function(t){var n=this;n._d||(n._d=!0,n=n._w||n,n._v=t,n._s=2,n._a||(n._a=n._c.slice()),A(n,!0))},L=function(t){var n,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===t)throw m("Promise can't be resolved itself");(n=P(t))?g(function(){var e={_w:r,_d:!1};try{n.call(t,f(L,e,1),f(k,e,1))}catch(t){k.call(e,t)}}):(r._v=t,r._s=1,A(r,!1))}catch(t){k.call({_w:r,_d:!1},t)}}};O||(w=function(t){v(this,w,b,"_h"),h(t),e.call(this);try{t(f(L,this,1),f(k,this,1))}catch(t){k.call(this,t)}},e=function(t){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1},e.prototype=r(73)(w.prototype,{then:function(t,n){var r=j(d(this,w));return r.ok="function"!=typeof t||t,r.fail="function"==typeof n&&n,r.domain=S?x.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&A(this,!1),r.promise},catch:function(t){return this.then(void 0,t)}}),F=function(){var t=new e;this.promise=t,this.resolve=f(L,t,1),this.reject=f(k,t,1)}),s(s.G+s.W+s.F*!O,{Promise:w}),r(81)(w,b),r(74)(b),o=r(52)[b],s(s.S+s.F*!O,b,{reject:function(t){var n=j(this);return(0,n.reject)(t),n.promise}}),s(s.S+s.F*(u||!O),b,{resolve:function(t){if(t instanceof w&&E(t.constructor,this))return t;var n=j(this);return(0,n.resolve)(t),n.promise}}),s(s.S+s.F*!(O&&r(123)(function(t){w.all(t).catch(_)})),b,{all:function(t){var n=this,r=j(n),e=r.resolve,i=r.reject,o=M(function(){var r=[],o=0,u=1;p(t,!1,function(t){var c=o++,f=!1;r.push(void 0),u++,n.resolve(t).then(function(t){f||(f=!0,r[c]=t,--u||e(r))},i)}),--u||e(r)});return o&&i(o.error),r.promise},race:function(t){var n=this,r=j(n),e=r.reject,i=M(function(){p(t,!1,function(t){n.resolve(t).then(r.resolve,e)})});return i&&e(i.error),r.promise}})},function(t,n,r){var e=r(1),i=r(26),o=r(2),u=(r(3).Reflect||{}).apply,c=Function.apply;e(e.S+e.F*!r(4)(function(){u(function(){})}),"Reflect",{apply:function(t,n,r){var e=i(t),f=o(r);return u?u(e,n,f):c.call(e,n,f)}})},function(t,n,r){var e=r(1),i=r(70),o=r(26),u=r(2),c=r(6),f=r(4),a=r(163),s=(r(3).Reflect||{}).construct,l=f(function(){function t(){}return!(s(function(){},[],t)instanceof t)}),h=!f(function(){s(function(){})});e(e.S+e.F*(l||h),"Reflect",{construct:function(t,n){o(t),u(n);var r=arguments.length<3?t:o(arguments[2]);if(h&&!l)return s(t,n,r);if(t==r){switch(n.length){case 0:return new t;case 1:return new t(n[0]);case 2:return new t(n[0],n[1]);case 3:return new t(n[0],n[1],n[2]);case 4:return new t(n[0],n[1],n[2],n[3])}var e=[null];return e.push.apply(e,n),new(a.apply(t,e))}var f=r.prototype,v=i(c(f)?f:Object.prototype),p=Function.apply.call(t,v,n);return c(p)?p:v}})},function(t,n,r){var e=r(11),i=r(1),o=r(2),u=r(50);i(i.S+i.F*r(4)(function(){Reflect.defineProperty(e.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(t,n,r){o(t),n=u(n,!0),o(r);try{return e.f(t,n,r),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(31).f,o=r(2);e(e.S,"Reflect",{deleteProperty:function(t,n){var r=i(o(t),n);return!(r&&!r.configurable)&&delete t[n]}})},function(t,n,r){"use strict";var e=r(1),i=r(2),o=function(t){this._t=i(t),this._i=0;var n,r=this._k=[];for(n in t)r.push(n)};r(139)(o,"Object",function(){var t,n=this,r=n._k;do{if(n._i>=r.length)return{value:void 0,done:!0}}while(!((t=r[n._i++])in n._t));return{value:t,done:!1}}),e(e.S,"Reflect",{enumerate:function(t){return new o(t)}})},function(t,n,r){var e=r(31),i=r(1),o=r(2);i(i.S,"Reflect",{getOwnPropertyDescriptor:function(t,n){return e.f(o(t),n)}})},function(t,n,r){var e=r(1),i=r(32),o=r(2);e(e.S,"Reflect",{getPrototypeOf:function(t){return i(o(t))}})},function(t,n,r){function e(t,n){var r,c,s=arguments.length<3?t:arguments[2];return a(t)===s?t[n]:(r=i.f(t,n))?u(r,"value")?r.value:void 0!==r.get?r.get.call(s):void 0:f(c=o(t))?e(c,n,s):void 0}var i=r(31),o=r(32),u=r(24),c=r(1),f=r(6),a=r(2);c(c.S,"Reflect",{get:e})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{has:function(t,n){return n in t}})},function(t,n,r){var e=r(1),i=r(2),o=Object.isExtensible;e(e.S,"Reflect",{isExtensible:function(t){return i(t),!o||o(t)}})},function(t,n,r){var e=r(1);e(e.S,"Reflect",{ownKeys:r(177)})},function(t,n,r){var e=r(1),i=r(2),o=Object.preventExtensions;e(e.S,"Reflect",{preventExtensions:function(t){i(t);try{return o&&o(t),!0}catch(t){return!1}}})},function(t,n,r){var e=r(1),i=r(144);i&&e(e.S,"Reflect",{setPrototypeOf:function(t,n){i.check(t,n);try{return i.set(t,n),!0}catch(t){return!1}}})},function(t,n,r){function e(t,n,r){var f,h,v=arguments.length<4?t:arguments[3],p=o.f(s(t),n);if(!p){if(l(h=u(t)))return e(h,n,r,v);p=a(0)}return c(p,"value")?!(!1===p.writable||!l(v)||(f=o.f(v,n)||a(0),f.value=r,i.f(v,n,f),0)):void 0!==p.set&&(p.set.call(v,r),!0)}var i=r(11),o=r(31),u=r(32),c=r(24),f=r(1),a=r(66),s=r(2),l=r(6);f(f.S,"Reflect",{set:e})},function(t,n,r){var e=r(3),i=r(136),o=r(11).f,u=r(71).f,c=r(122),f=r(120),a=e.RegExp,s=a,l=a.prototype,h=/a/g,v=/a/g,p=new a(h)!==h;if(r(10)&&(!p||r(4)(function(){return v[r(7)("match")]=!1,a(h)!=h||a(v)==v||"/a/i"!=a(h,"i")}))){a=function(t,n){var r=this instanceof a,e=c(t),o=void 0===n;return!r&&e&&t.constructor===a&&o?t:i(p?new s(e&&!o?t.source:t,n):s((e=t instanceof a)?t.source:t,e&&o?f.call(t):n),r?this:l,a)};for(var d=u(s),y=0;d.length>y;)!function(t){t in a||o(a,t,{configurable:!0,get:function(){return s[t]},set:function(n){s[t]=n}})}(d[y++]);l.constructor=a,a.prototype=l,r(28)(e,"RegExp",a)}r(74)("RegExp")},function(t,n,r){r(119)("match",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("replace",2,function(t,n,r){return[function(e,i){"use strict";var o=t(this),u=void 0==e?void 0:e[n];return void 0!==u?u.call(e,o,i):r.call(String(o),e,i)},r]})},function(t,n,r){r(119)("search",1,function(t,n,r){return[function(r){"use strict";var e=t(this),i=void 0==r?void 0:r[n];return void 0!==i?i.call(r,e):new RegExp(r)[n](String(e))},r]})},function(t,n,r){r(119)("split",2,function(t,n,e){"use strict";var i=r(122),o=e,u=[].push,c="split",f="length",a="lastIndex";if("c"=="abbc"[c](/(b)*/)[1]||4!="test"[c](/(?:)/,-1)[f]||2!="ab"[c](/(?:ab)*/)[f]||4!="."[c](/(.?)(.?)/)[f]||"."[c](/()()/)[f]>1||""[c](/.?/)[f]){var s=void 0===/()??/.exec("")[1];e=function(t,n){var r=String(this);if(void 0===t&&0===n)return[];if(!i(t))return o.call(r,t,n);var e,c,l,h,v,p=[],d=(t.ignoreCase?"i":"")+(t.multiline?"m":"")+(t.unicode?"u":"")+(t.sticky?"y":""),y=0,g=void 0===n?4294967295:n>>>0,b=new RegExp(t.source,d+"g");for(s||(e=new RegExp("^"+b.source+"$(?!\\s)",d));(c=b.exec(r))&&!((l=c.index+c[0][f])>y&&(p.push(r.slice(y,c.index)),!s&&c[f]>1&&c[0].replace(e,function(){for(v=1;v<arguments[f]-2;v++)void 0===arguments[v]&&(c[v]=void 0)}),c[f]>1&&c.index<r[f]&&u.apply(p,c.slice(1)),h=c[0][f],y=l,p[f]>=g));)b[a]===c.index&&b[a]++;return y===r[f]?!h&&b.test("")||p.push(""):p.push(r.slice(y)),p[f]>g?p.slice(0,g):p}}else"0"[c](void 0,0)[f]&&(e=function(t,n){return void 0===t&&0===n?[]:o.call(this,t,n)});return[function(r,i){var o=t(this),u=void 0==r?void 0:r[n];return void 0!==u?u.call(r,o,i):e.call(String(o),r,i)},e]})},function(t,n,r){"use strict";r(184);var e=r(2),i=r(120),o=r(10),u="toString",c=/./[u],f=function(t){r(28)(RegExp.prototype,u,t,!0)};r(4)(function(){return"/a/b"!=c.call({source:"a",flags:"b"})})?f(function(){var t=e(this);return"/".concat(t.source,"/","flags"in t?t.flags:!o&&t instanceof RegExp?i.call(t):void 0)}):c.name!=u&&f(function(){return c.call(this)})},function(t,n,r){"use strict";r(29)("anchor",function(t){return function(n){return t(this,"a","name",n)}})},function(t,n,r){"use strict";r(29)("big",function(t){return function(){return t(this,"big","","")}})},function(t,n,r){"use strict";r(29)("blink",function(t){return function(){return t(this,"blink","","")}})},function(t,n,r){"use strict";r(29)("bold",function(t){return function(){return t(this,"b","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!1);e(e.P,"String",{codePointAt:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="endsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{endsWith:function(t){var n=o(this,t,u),r=arguments.length>1?arguments[1]:void 0,e=i(n.length),f=void 0===r?e:Math.min(i(r),e),a=String(t);return c?c.call(n,a,f):n.slice(f-a.length,f)===a}})},function(t,n,r){"use strict";r(29)("fixed",function(t){return function(){return t(this,"tt","","")}})},function(t,n,r){"use strict";r(29)("fontcolor",function(t){return function(n){return t(this,"font","color",n)}})},function(t,n,r){"use strict";r(29)("fontsize",function(t){return function(n){return t(this,"font","size",n)}})},function(t,n,r){var e=r(1),i=r(75),o=String.fromCharCode,u=String.fromCodePoint;e(e.S+e.F*(!!u&&1!=u.length),"String",{fromCodePoint:function(t){for(var n,r=[],e=arguments.length,u=0;e>u;){if(n=+arguments[u++],i(n,1114111)!==n)throw RangeError(n+" is not a valid code point");r.push(n<65536?o(n):o(55296+((n-=65536)>>10),n%1024+56320))}return r.join("")}})},function(t,n,r){"use strict";var e=r(1),i=r(148),o="includes";e(e.P+e.F*r(134)(o),"String",{includes:function(t){return!!~i(this,t,o).indexOf(t,arguments.length>1?arguments[1]:void 0)}})},function(t,n,r){"use strict";r(29)("italics",function(t){return function(){return t(this,"i","","")}})},function(t,n,r){"use strict";var e=r(147)(!0);r(140)(String,"String",function(t){this._t=String(t),this._i=0},function(){var t,n=this._t,r=this._i;return r>=n.length?{value:void 0,done:!0}:(t=e(n,r),this._i+=t.length,{value:t,done:!1})})},function(t,n,r){"use strict";r(29)("link",function(t){return function(n){return t(this,"a","href",n)}})},function(t,n,r){var e=r(1),i=r(30),o=r(16);e(e.S,"String",{raw:function(t){for(var n=i(t.raw),r=o(n.length),e=arguments.length,u=[],c=0;r>c;)u.push(String(n[c++])),c<e&&u.push(String(arguments[c]));return u.join("")}})},function(t,n,r){var e=r(1);e(e.P,"String",{repeat:r(149)})},function(t,n,r){"use strict";r(29)("small",function(t){return function(){return t(this,"small","","")}})},function(t,n,r){"use strict";var e=r(1),i=r(16),o=r(148),u="startsWith",c=""[u];e(e.P+e.F*r(134)(u),"String",{startsWith:function(t){var n=o(this,t,u),r=i(Math.min(arguments.length>1?arguments[1]:void 0,n.length)),e=String(t);return c?c.call(n,e,r):n.slice(r,r+e.length)===e}})},function(t,n,r){"use strict";r(29)("strike",function(t){return function(){return t(this,"strike","","")}})},function(t,n,r){"use strict";r(29)("sub",function(t){return function(){return t(this,"sub","","")}})},function(t,n,r){"use strict";r(29)("sup",function(t){return function(){return t(this,"sup","","")}})},function(t,n,r){"use strict";r(82)("trim",function(t){return function(){return t(this,3)}})},function(t,n,r){"use strict";var e=r(3),i=r(24),o=r(10),u=r(1),c=r(28),f=r(65).KEY,a=r(4),s=r(126),l=r(81),h=r(76),v=r(7),p=r(182),d=r(153),y=r(206),g=r(205),b=r(138),m=r(2),x=r(30),w=r(50),S=r(66),_=r(70),O=r(174),E=r(31),P=r(11),j=r(72),F=E.f,M=P.f,A=O.f,N=e.Symbol,T=e.JSON,I=T&&T.stringify,k="prototype",L=v("_hidden"),R=v("toPrimitive"),C={}.propertyIsEnumerable,D=s("symbol-registry"),U=s("symbols"),W=s("op-symbols"),G=Object[k],B="function"==typeof N,V=e.QObject,z=!V||!V[k]||!V[k].findChild,q=o&&a(function(){return 7!=_(M({},"a",{get:function(){return M(this,"a",{value:7}).a}})).a})?function(t,n,r){var e=F(G,n);e&&delete G[n],M(t,n,r),e&&t!==G&&M(G,n,e)}:M,K=function(t){var n=U[t]=_(N[k]);return n._k=t,n},J=B&&"symbol"==typeof N.iterator?function(t){return"symbol"==typeof t}:function(t){return t instanceof N},Y=function(t,n,r){return t===G&&Y(W,n,r),m(t),n=w(n,!0),m(r),i(U,n)?(r.enumerable?(i(t,L)&&t[L][n]&&(t[L][n]=!1),r=_(r,{enumerable:S(0,!1)})):(i(t,L)||M(t,L,S(1,{})),t[L][n]=!0),q(t,n,r)):M(t,n,r)},H=function(t,n){m(t);for(var r,e=g(n=x(n)),i=0,o=e.length;o>i;)Y(t,r=e[i++],n[r]);return t},$=function(t,n){return void 0===n?_(t):H(_(t),n)},X=function(t){var n=C.call(this,t=w(t,!0));return!(this===G&&i(U,t)&&!i(W,t))&&(!(n||!i(this,t)||!i(U,t)||i(this,L)&&this[L][t])||n)},Q=function(t,n){if(t=x(t),n=w(n,!0),t!==G||!i(U,n)||i(W,n)){var r=F(t,n);return!r||!i(U,n)||i(t,L)&&t[L][n]||(r.enumerable=!0),r}},Z=function(t){for(var n,r=A(x(t)),e=[],o=0;r.length>o;)i(U,n=r[o++])||n==L||n==f||e.push(n);return e},tt=function(t){for(var n,r=t===G,e=A(r?W:x(t)),o=[],u=0;e.length>u;)!i(U,n=e[u++])||r&&!i(G,n)||o.push(U[n]);return o};B||(N=function(){if(this instanceof N)throw TypeError("Symbol is not a constructor!");var t=h(arguments.length>0?arguments[0]:void 0),n=function(r){this===G&&n.call(W,r),i(this,L)&&i(this[L],t)&&(this[L][t]=!1),q(this,t,S(1,r))};return o&&z&&q(G,t,{configurable:!0,set:n}),K(t)},c(N[k],"toString",function(){return this._k}),E.f=Q,P.f=Y,r(71).f=O.f=Z,r(116).f=X,r(125).f=tt,o&&!r(69)&&c(G,"propertyIsEnumerable",X,!0),p.f=function(t){return K(v(t))}),u(u.G+u.W+u.F*!B,{Symbol:N});for(var nt="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),rt=0;nt.length>rt;)v(nt[rt++]);for(var nt=j(v.store),rt=0;nt.length>rt;)d(nt[rt++]);u(u.S+u.F*!B,"Symbol",{for:function(t){return i(D,t+="")?D[t]:D[t]=N(t)},keyFor:function(t){if(J(t))return y(D,t);throw TypeError(t+" is not a symbol!")},useSetter:function(){z=!0},useSimple:function(){z=!1}}),u(u.S+u.F*!B,"Object",{create:$,defineProperty:Y,defineProperties:H,getOwnPropertyDescriptor:Q,getOwnPropertyNames:Z,getOwnPropertySymbols:tt}),T&&u(u.S+u.F*(!B||a(function(){var t=N();return"[null]"!=I([t])||"{}"!=I({a:t})||"{}"!=I(Object(t))})),"JSON",{stringify:function(t){if(void 0!==t&&!J(t)){for(var n,r,e=[t],i=1;arguments.length>i;)e.push(arguments[i++]);return n=e[1],"function"==typeof n&&(r=n),!r&&b(n)||(n=function(t,n){if(r&&(n=r.call(this,t,n)),!J(n))return n}),e[1]=n,I.apply(T,e)}}}),N[k][R]||r(27)(N[k],R,N[k].valueOf),l(N,"Symbol"),l(Math,"Math",!0),l(e.JSON,"JSON",!0)},function(t,n,r){"use strict";var e=r(1),i=r(127),o=r(152),u=r(2),c=r(75),f=r(16),a=r(6),s=r(3).ArrayBuffer,l=r(146),h=o.ArrayBuffer,v=o.DataView,p=i.ABV&&s.isView,d=h.prototype.slice,y=i.VIEW,g="ArrayBuffer";e(e.G+e.W+e.F*(s!==h),{ArrayBuffer:h}),e(e.S+e.F*!i.CONSTR,g,{isView:function(t){return p&&p(t)||a(t)&&y in t}}),e(e.P+e.U+e.F*r(4)(function(){return!new h(2).slice(1,void 0).byteLength}),g,{slice:function(t,n){if(void 0!==d&&void 0===n)return d.call(u(this),t);for(var r=u(this).byteLength,e=c(t,r),i=c(void 0===n?r:n,r),o=new(l(this,h))(f(i-e)),a=new v(this),s=new v(o),p=0;e<i;)s.setUint8(p++,a.getUint8(e++));return o}}),r(74)(g)},function(t,n,r){var e=r(1);e(e.G+e.W+e.F*!r(127).ABV,{DataView:r(152).DataView})},function(t,n,r){r(55)("Float32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Float64",8,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Int8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint16",2,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint32",4,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}})},function(t,n,r){r(55)("Uint8",1,function(t){return function(n,r,e){return t(this,n,r,e)}},!0)},function(t,n,r){"use strict";var e=r(166);r(118)("WeakSet",function(t){return function(){return t(this,arguments.length>0?arguments[0]:void 0)}},{add:function(t){return e.def(this,t,!0)}},e,!1,!0)},function(t,n,r){"use strict";var e=r(1),i=r(117)(!0);e(e.P,"Array",{includes:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0)}}),r(78)("includes")},function(t,n,r){var e=r(1),i=r(143)(),o=r(3).process,u="process"==r(45)(o);e(e.G,{asap:function(t){var n=u&&o.domain;i(n?n.bind(t):t)}})},function(t,n,r){var e=r(1),i=r(45);e(e.S,"Error",{isError:function(t){return"Error"===i(t)}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Map",{toJSON:r(165)("Map")})},function(t,n,r){var e=r(1);e(e.S,"Math",{iaddh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o+(e>>>0)+((i&u|(i|u)&~(i+u>>>0))>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{imulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>16,f=i>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>16)+((o*f>>>0)+(a&r)>>16)}})},function(t,n,r){var e=r(1);e(e.S,"Math",{isubh:function(t,n,r,e){var i=t>>>0,o=n>>>0,u=r>>>0;return o-(e>>>0)-((~i&u|~(i^u)&i-u>>>0)>>>31)|0}})},function(t,n,r){var e=r(1);e(e.S,"Math",{umulh:function(t,n){var r=65535,e=+t,i=+n,o=e&r,u=i&r,c=e>>>16,f=i>>>16,a=(c*u>>>0)+(o*u>>>16);return c*f+(a>>>16)+((o*f>>>0)+(a&r)>>>16)}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineGetter__:function(t,n){u.f(i(this),t,{get:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(26),u=r(11);r(10)&&e(e.P+r(124),"Object",{__defineSetter__:function(t,n){u.f(i(this),t,{set:o(n),enumerable:!0,configurable:!0})}})},function(t,n,r){var e=r(1),i=r(176)(!0);e(e.S,"Object",{entries:function(t){return i(t)}})},function(t,n,r){var e=r(1),i=r(177),o=r(30),u=r(31),c=r(131);e(e.S,"Object",{getOwnPropertyDescriptors:function(t){for(var n,r=o(t),e=u.f,f=i(r),a={},s=0;f.length>s;)c(a,n=f[s++],e(r,n));return a}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupGetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.get}while(r=u(r))}})},function(t,n,r){"use strict";var e=r(1),i=r(17),o=r(50),u=r(32),c=r(31).f;r(10)&&e(e.P+r(124),"Object",{__lookupSetter__:function(t){var n,r=i(this),e=o(t,!0);do{if(n=c(r,e))return n.set}while(r=u(r))}})},function(t,n,r){var e=r(1),i=r(176)(!1);e(e.S,"Object",{values:function(t){return i(t)}})},function(t,n,r){"use strict";var e=r(1),i=r(3),o=r(52),u=r(143)(),c=r(7)("observable"),f=r(26),a=r(2),s=r(68),l=r(73),h=r(27),v=r(79),p=v.RETURN,d=function(t){return null==t?void 0:f(t)},y=function(t){var n=t._c;n&&(t._c=void 0,n())},g=function(t){return void 0===t._o},b=function(t){g(t)||(t._o=void 0,y(t))},m=function(t,n){a(t),this._c=void 0,this._o=t,t=new x(this);try{var r=n(t),e=r;null!=r&&("function"==typeof r.unsubscribe?r=function(){e.unsubscribe()}:f(r),this._c=r)}catch(n){return void t.error(n)}g(this)&&y(this)};m.prototype=l({},{unsubscribe:function(){b(this)}});var x=function(t){this._s=t};x.prototype=l({},{next:function(t){var n=this._s;if(!g(n)){var r=n._o;try{var e=d(r.next);if(e)return e.call(r,t)}catch(t){try{b(n)}finally{throw t}}}},error:function(t){var n=this._s;if(g(n))throw t;var r=n._o;n._o=void 0;try{var e=d(r.error);if(!e)throw t;t=e.call(r,t)}catch(t){try{y(n)}finally{throw t}}return y(n),t},complete:function(t){var n=this._s;if(!g(n)){var r=n._o;n._o=void 0;try{var e=d(r.complete);t=e?e.call(r,t):void 0}catch(t){try{y(n)}finally{throw t}}return y(n),t}}});var w=function(t){s(this,w,"Observable","_f")._f=f(t)};l(w.prototype,{subscribe:function(t){return new m(t,this._f)},forEach:function(t){var n=this;return new(o.Promise||i.Promise)(function(r,e){f(t);var i=n.subscribe({next:function(n){try{return t(n)}catch(t){e(t),i.unsubscribe()}},error:e,complete:r})})}}),l(w,{from:function(t){var n="function"==typeof this?this:w,r=d(a(t)[c]);if(r){var e=a(r.call(t));return e.constructor===n?e:new n(function(t){return e.subscribe(t)})}return new n(function(n){var r=!1;return u(function(){if(!r){try{if(v(t,!1,function(t){if(n.next(t),r)return p})===p)return}catch(t){if(r)throw t;return void n.error(t)}n.complete()}}),function(){r=!0}})},of:function(){for(var t=0,n=arguments.length,r=Array(n);t<n;)r[t]=arguments[t++];return new("function"==typeof this?this:w)(function(t){var n=!1;return u(function(){if(!n){for(var e=0;e<r.length;++e)if(t.next(r[e]),n)return;t.complete()}}),function(){n=!0}})}}),h(w.prototype,c,function(){return this}),e(e.G,{Observable:w}),r(74)("Observable")},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.set;e.exp({defineMetadata:function(t,n,r,e){u(t,n,i(r),o(e))}})},function(t,n,r){var e=r(54),i=r(2),o=e.key,u=e.map,c=e.store;e.exp({deleteMetadata:function(t,n){var r=arguments.length<3?void 0:o(arguments[2]),e=u(i(n),r,!1);if(void 0===e||!e.delete(t))return!1;if(e.size)return!0;var f=c.get(n);return f.delete(r),!!f.size||c.delete(n)}})},function(t,n,r){var e=r(185),i=r(161),o=r(54),u=r(2),c=r(32),f=o.keys,a=o.key,s=function(t,n){var r=f(t,n),o=c(t);if(null===o)return r;var u=s(o,n);return u.length?r.length?i(new e(r.concat(u))):u:r};o.exp({getMetadataKeys:function(t){return s(u(t),arguments.length<2?void 0:a(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.get,f=e.key,a=function(t,n,r){if(u(t,n,r))return c(t,n,r);var e=o(n);return null!==e?a(t,e,r):void 0};e.exp({getMetadata:function(t,n){return a(t,i(n),arguments.length<3?void 0:f(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.keys,u=e.key;e.exp({getOwnMetadataKeys:function(t){
return o(i(t),arguments.length<2?void 0:u(arguments[1]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.get,u=e.key;e.exp({getOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(32),u=e.has,c=e.key,f=function(t,n,r){if(u(t,n,r))return!0;var e=o(n);return null!==e&&f(t,e,r)};e.exp({hasMetadata:function(t,n){return f(t,i(n),arguments.length<3?void 0:c(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=e.has,u=e.key;e.exp({hasOwnMetadata:function(t,n){return o(t,i(n),arguments.length<3?void 0:u(arguments[2]))}})},function(t,n,r){var e=r(54),i=r(2),o=r(26),u=e.key,c=e.set;e.exp({metadata:function(t,n){return function(r,e){c(t,n,(void 0!==e?i:o)(r),u(e))}}})},function(t,n,r){var e=r(1);e(e.P+e.R,"Set",{toJSON:r(165)("Set")})},function(t,n,r){"use strict";var e=r(1),i=r(147)(!0);e(e.P,"String",{at:function(t){return i(this,t)}})},function(t,n,r){"use strict";var e=r(1),i=r(46),o=r(16),u=r(122),c=r(120),f=RegExp.prototype,a=function(t,n){this._r=t,this._s=n};r(139)(a,"RegExp String",function(){var t=this._r.exec(this._s);return{value:t,done:null===t}}),e(e.P,"String",{matchAll:function(t){if(i(this),!u(t))throw TypeError(t+" is not a regexp!");var n=String(this),r="flags"in f?String(t.flags):c.call(t),e=new RegExp(t.source,~r.indexOf("g")?r:"g"+r);return e.lastIndex=o(t.lastIndex),new a(e,n)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padEnd:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!1)}})},function(t,n,r){"use strict";var e=r(1),i=r(181);e(e.P,"String",{padStart:function(t){return i(this,t,arguments.length>1?arguments[1]:void 0,!0)}})},function(t,n,r){"use strict";r(82)("trimLeft",function(t){return function(){return t(this,1)}},"trimStart")},function(t,n,r){"use strict";r(82)("trimRight",function(t){return function(){return t(this,2)}},"trimEnd")},function(t,n,r){r(153)("asyncIterator")},function(t,n,r){r(153)("observable")},function(t,n,r){var e=r(1);e(e.S,"System",{global:r(3)})},function(t,n,r){for(var e=r(155),i=r(28),o=r(3),u=r(27),c=r(80),f=r(7),a=f("iterator"),s=f("toStringTag"),l=c.Array,h=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],v=0;v<5;v++){var p,d=h[v],y=o[d],g=y&&y.prototype;if(g){g[a]||u(g,a,l),g[s]||u(g,s,d),c[d]=l;for(p in e)g[p]||i(g,p,e[p],!0)}}},function(t,n,r){var e=r(1),i=r(151);e(e.G+e.B,{setImmediate:i.set,clearImmediate:i.clear})},function(t,n,r){var e=r(3),i=r(1),o=r(121),u=r(207),c=e.navigator,f=!!c&&/MSIE .\./.test(c.userAgent),a=function(t){return f?function(n,r){return t(o(u,[].slice.call(arguments,2),"function"==typeof n?n:Function(n)),r)}:t};i(i.G+i.B+i.F*f,{setTimeout:a(e.setTimeout),setInterval:a(e.setInterval)})},function(t,n,r){r(330),r(269),r(271),r(270),r(273),r(275),r(280),r(274),r(272),r(282),r(281),r(277),r(278),r(276),r(268),r(279),r(283),r(284),r(236),r(238),r(237),r(286),r(285),r(256),r(266),r(267),r(257),r(258),r(259),r(260),r(261),r(262),r(263),r(264),r(265),r(239),r(240),r(241),r(242),r(243),r(244),r(245),r(246),r(247),r(248),r(249),r(250),r(251),r(252),r(253),r(254),r(255),r(317),r(322),r(329),r(320),r(312),r(313),r(318),r(323),r(325),r(308),r(309),r(310),r(311),r(314),r(315),r(316),r(319),r(321),r(324),r(326),r(327),r(328),r(231),r(233),r(232),r(235),r(234),r(220),r(218),r(224),r(221),r(227),r(229),r(217),r(223),r(214),r(228),r(212),r(226),r(225),r(219),r(222),r(211),r(213),r(216),r(215),r(230),r(155),r(302),r(307),r(184),r(303),r(304),r(305),r(306),r(287),r(183),r(185),r(186),r(342),r(331),r(332),r(337),r(340),r(341),r(335),r(338),r(336),r(339),r(333),r(334),r(288),r(289),r(290),r(291),r(292),r(295),r(293),r(294),r(296),r(297),r(298),r(299),r(301),r(300),r(343),r(369),r(372),r(371),r(373),r(374),r(370),r(375),r(376),r(354),r(357),r(353),r(351),r(352),r(355),r(356),r(346),r(368),r(377),r(345),r(347),r(349),r(348),r(350),r(359),r(360),r(362),r(361),r(364),r(363),r(365),r(366),r(367),r(344),r(358),r(380),r(379),r(378),t.exports=r(52)},function(t,n){function r(t,n){if("string"==typeof n)return t.insertAdjacentHTML("afterend",n);var r=t.nextSibling;return r?t.parentNode.insertBefore(n,r):t.parentNode.appendChild(n)}t.exports=r},,,,,,,,,function(t,n,r){(function(n,r){!function(n){"use strict";function e(t,n,r,e){var i=n&&n.prototype instanceof o?n:o,u=Object.create(i.prototype),c=new p(e||[]);return u._invoke=s(t,r,c),u}function i(t,n,r){try{return{type:"normal",arg:t.call(n,r)}}catch(t){return{type:"throw",arg:t}}}function o(){}function u(){}function c(){}function f(t){["next","throw","return"].forEach(function(n){t[n]=function(t){return this._invoke(n,t)}})}function a(t){function n(r,e,o,u){var c=i(t[r],t,e);if("throw"!==c.type){var f=c.arg,a=f.value;return a&&"object"==typeof a&&m.call(a,"__await")?Promise.resolve(a.__await).then(function(t){n("next",t,o,u)},function(t){n("throw",t,o,u)}):Promise.resolve(a).then(function(t){f.value=t,o(f)},u)}u(c.arg)}function e(t,r){function e(){return new Promise(function(e,i){n(t,r,e,i)})}return o=o?o.then(e,e):e()}"object"==typeof r&&r.domain&&(n=r.domain.bind(n));var o;this._invoke=e}function s(t,n,r){var e=P;return function(o,u){if(e===F)throw new Error("Generator is already running");if(e===M){if("throw"===o)throw u;return y()}for(r.method=o,r.arg=u;;){var c=r.delegate;if(c){var f=l(c,r);if(f){if(f===A)continue;return f}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(e===P)throw e=M,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);e=F;var a=i(t,n,r);if("normal"===a.type){if(e=r.done?M:j,a.arg===A)continue;return{value:a.arg,done:r.done}}"throw"===a.type&&(e=M,r.method="throw",r.arg=a.arg)}}}function l(t,n){var r=t.iterator[n.method];if(r===g){if(n.delegate=null,"throw"===n.method){if(t.iterator.return&&(n.method="return",n.arg=g,l(t,n),"throw"===n.method))return A;n.method="throw",n.arg=new TypeError("The iterator does not provide a 'throw' method")}return A}var e=i(r,t.iterator,n.arg);if("throw"===e.type)return n.method="throw",n.arg=e.arg,n.delegate=null,A;var o=e.arg;return o?o.done?(n[t.resultName]=o.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=g),n.delegate=null,A):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,A)}function h(t){var n={tryLoc:t[0]};1 in t&&(n.catchLoc=t[1]),2 in t&&(n.finallyLoc=t[2],n.afterLoc=t[3]),this.tryEntries.push(n)}function v(t){var n=t.completion||{};n.type="normal",delete n.arg,t.completion=n}function p(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(h,this),this.reset(!0)}function d(t){if(t){var n=t[w];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var r=-1,e=function n(){for(;++r<t.length;)if(m.call(t,r))return n.value=t[r],n.done=!1,n;return n.value=g,n.done=!0,n};return e.next=e}}return{next:y}}function y(){return{value:g,done:!0}}var g,b=Object.prototype,m=b.hasOwnProperty,x="function"==typeof Symbol?Symbol:{},w=x.iterator||"@@iterator",S=x.asyncIterator||"@@asyncIterator",_=x.toStringTag||"@@toStringTag",O="object"==typeof t,E=n.regeneratorRuntime;if(E)return void(O&&(t.exports=E));E=n.regeneratorRuntime=O?t.exports:{},E.wrap=e;var P="suspendedStart",j="suspendedYield",F="executing",M="completed",A={},N={};N[w]=function(){return this};var T=Object.getPrototypeOf,I=T&&T(T(d([])));I&&I!==b&&m.call(I,w)&&(N=I);var k=c.prototype=o.prototype=Object.create(N);u.prototype=k.constructor=c,c.constructor=u,c[_]=u.displayName="GeneratorFunction",E.isGeneratorFunction=function(t){var n="function"==typeof t&&t.constructor;return!!n&&(n===u||"GeneratorFunction"===(n.displayName||n.name))},E.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_ in t||(t[_]="GeneratorFunction")),t.prototype=Object.create(k),t},E.awrap=function(t){return{__await:t}},f(a.prototype),a.prototype[S]=function(){return this},E.AsyncIterator=a,E.async=function(t,n,r,i){var o=new a(e(t,n,r,i));return E.isGeneratorFunction(n)?o:o.next().then(function(t){return t.done?t.value:o.next()})},f(k),k[_]="Generator",k.toString=function(){return"[object Generator]"},E.keys=function(t){var n=[];for(var r in t)n.push(r);return n.reverse(),function r(){for(;n.length;){var e=n.pop();if(e in t)return r.value=e,r.done=!1,r}return r.done=!0,r}},E.values=d,p.prototype={constructor:p,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=g,this.done=!1,this.delegate=null,this.method="next",this.arg=g,this.tryEntries.forEach(v),!t)for(var n in this)"t"===n.charAt(0)&&m.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=g)},stop:function(){this.done=!0;var t=this.tryEntries[0],n=t.completion;if("throw"===n.type)throw n.arg;return this.rval},dispatchException:function(t){function n(n,e){return o.type="throw",o.arg=t,r.next=n,e&&(r.method="next",r.arg=g),!!e}if(this.done)throw t;for(var r=this,e=this.tryEntries.length-1;e>=0;--e){var i=this.tryEntries[e],o=i.completion;if("root"===i.tryLoc)return n("end");if(i.tryLoc<=this.prev){var u=m.call(i,"catchLoc"),c=m.call(i,"finallyLoc");if(u&&c){if(this.prev<i.catchLoc)return n(i.catchLoc,!0);if(this.prev<i.finallyLoc)return n(i.finallyLoc)}else if(u){if(this.prev<i.catchLoc)return n(i.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return n(i.finallyLoc)}}}},abrupt:function(t,n){for(var r=this.tryEntries.length-1;r>=0;--r){var e=this.tryEntries[r];if(e.tryLoc<=this.prev&&m.call(e,"finallyLoc")&&this.prev<e.finallyLoc){var i=e;break}}i&&("break"===t||"continue"===t)&&i.tryLoc<=n&&n<=i.finallyLoc&&(i=null);var o=i?i.completion:{};return o.type=t,o.arg=n,i?(this.method="next",this.next=i.finallyLoc,A):this.complete(o)},complete:function(t,n){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&n&&(this.next=n),A},finish:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.finallyLoc===t)return this.complete(r.completion,r.afterLoc),v(r),A}},catch:function(t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc===t){var e=r.completion;if("throw"===e.type){var i=e.arg;v(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:d(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=g),A}}}("object"==typeof n?n:"object"==typeof window?window:"object"==typeof self?self:this)}).call(n,function(){return this}(),r(158))}])</script><script src="/./main.0cf68a.js"></script><script>!function(){!function(e){var t=document.createElement("script");document.getElementsByTagName("body")[0].appendChild(t),t.setAttribute("src",e)}("/slider.e37972.js")}()</script>


    
<div class="tools-col" q-class="show:isShow,hide:isShow|isFalse" q-on="click:stop(e)">
  <div class="tools-nav header-menu">
    
    
      
      
      
    
      
      
      
    
      
      
      
    
    

    <ul style="width: 70%">
    
    
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'innerArchive')"><a href="javascript:void(0)" q-class="active:innerArchive">所有文章</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'friends')"><a href="javascript:void(0)" q-class="active:friends">友链</a></li>
      
        
      
      <li style="width: 33.333333333333336%" q-on="click: openSlider(e, 'aboutme')"><a href="javascript:void(0)" q-class="active:aboutme">关于我</a></li>
      
        
    </ul>
  </div>
  <div class="tools-wrap">
    
    	<section class="tools-section tools-section-all" q-show="innerArchive">
        <div class="search-wrap">
          <input class="search-ipt" q-model="search" type="text" placeholder="find something…">
          <i class="icon-search icon" q-show="search|isEmptyStr"></i>
          <i class="icon-close icon" q-show="search|isNotEmptyStr" q-on="click:clearChose(e)"></i>
        </div>
        <div class="widget tagcloud search-tag">
          <p class="search-tag-wording">tag:</p>
          <label class="search-switch">
            <input type="checkbox" q-on="click:toggleTag(e)" q-attr="checked:showTags">
          </label>
          <ul class="article-tag-list" q-show="showTags">
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color5">数据科学</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">自言语</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">Markdown</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color4">VBA</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color3">爬虫</a>
              </li>
             
              <li class="article-tag-list-item">
                <a href="javascript:void(0)" class="js-tag color2">Oracle</a>
              </li>
            
            <div class="clearfix"></div>
          </ul>
        </div>
        <ul class="search-ul">
          <p q-show="jsonFail" style="padding: 20px; font-size: 12px;">
            缺失模块。<br>1、请确保node版本大于6.2<br>2、在博客根目录（注意不是yilia根目录）执行以下命令：<br> npm i hexo-generator-json-content --save<br><br>
            3、在根目录_config.yml里添加配置：
<pre style="font-size: 12px;" q-show="jsonFail">
  jsonContent:
    meta: false
    pages: false
    posts:
      title: true
      date: true
      path: true
      text: false
      raw: false
      content: false
      slug: false
      updated: false
      comments: false
      link: false
      permalink: false
      excerpt: false
      categories: false
      tags: true
</pre>
          </p>
          <li class="search-li" q-repeat="items" q-show="isShow">
            <a q-attr="href:path|urlformat" class="search-title"><i class="icon-quo-left icon"></i><span q-text="title"></span></a>
            <p class="search-time">
              <i class="icon-calendar icon"></i>
              <span q-text="date|dateformat"></span>
            </p>
            <p class="search-tag">
              <i class="icon-price-tags icon"></i>
              <span q-repeat="tags" q-on="click:choseTag(e, name)" q-text="name|tagformat"></span>
            </p>
          </li>
        </ul>
    	</section>
    

    
    	<section class="tools-section tools-section-friends" q-show="friends">
  		
        <ul class="search-ul">
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接1</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接2</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接3</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接4</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接5</a>
            </li>
          
            <li class="search-li">
              <a href="http://localhost:4000/" target="_blank" class="search-title"><i class="icon-quo-left icon"></i>友情链接6</a>
            </li>
          
        </ul>
  		
    	</section>
    

    
    	<section class="tools-section tools-section-me" q-show="aboutme">
  	  	
  	  		<div class="aboutme-wrap" id="js-aboutme">很惭愧&lt;br&gt;&lt;br&gt;只做了一点微小的工作&lt;br&gt;谢谢大家</div>
  	  	
    	</section>
    
  </div>
  
</div>
    <!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" style="display:none" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>
  </div>
</body>
</html>